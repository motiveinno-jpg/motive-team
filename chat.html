<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, interactive-widget=resizes-content">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="하준 PM">
<meta name="theme-color" content="#0a0a0a">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23c8ff00' width='100' height='100' rx='20'/><text x='50' y='68' text-anchor='middle' font-size='50' font-weight='900' fill='%230a0a0a'>M</text></svg>">
<title>하준 PM — MOTIVE</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#0a0a0a;--bg2:#141414;--bg3:#1a1a1a;--bd:#222;--tx:#e8e8e8;--tx2:#888;--tx3:#555;--ac:#c8ff00;--r:12px}
*{margin:0;padding:0;box-sizing:border-box}
body{height:100dvh;font-family:'Noto Sans KR',sans-serif;background:var(--bg);color:var(--tx);display:flex;flex-direction:column;padding-top:env(safe-area-inset-top);padding-bottom:env(safe-area-inset-bottom)}

/* 헤더 */
.hd{display:flex;align-items:center;gap:12px;padding:12px 16px;background:var(--bg2);border-bottom:1px solid var(--bd);flex-shrink:0}
.hd-av{width:36px;height:36px;border-radius:50%;background:var(--ac);display:flex;align-items:center;justify-content:center;font-weight:900;font-size:14px;color:#0a0a0a}
.hd-name{font-size:15px;font-weight:600}
.hd-status{font-size:11px;color:var(--ac);display:flex;align-items:center;gap:4px}
.hd-dot{width:6px;height:6px;border-radius:50%;background:var(--ac);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.hd-right{margin-left:auto;display:flex;gap:8px}
.hd-btn{background:none;border:1px solid var(--bd);color:var(--tx2);font-size:11px;padding:4px 10px;border-radius:6px;cursor:pointer;font-family:inherit}
.hd-btn:hover{border-color:var(--ac);color:var(--ac)}

/* 메시지 영역 */
.msgs{flex:1;overflow-y:auto;padding:12px 16px;display:flex;flex-direction:column;gap:8px}
.msg{display:flex;gap:8px;max-width:85%;animation:fadeIn .2s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
.msg.me{align-self:flex-end;flex-direction:row-reverse}
.msg-av{width:32px;height:32px;border-radius:50%;background:var(--ac);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:11px;color:#0a0a0a;flex-shrink:0;margin-top:2px}
.msg.me .msg-av{background:#2a3a00}
.msg-body{display:flex;flex-direction:column;gap:2px}
.msg-text{padding:10px 14px;border-radius:16px;font-size:14px;line-height:1.6;word-break:break-word}
.msg:not(.me) .msg-text{background:var(--bg2);border:1px solid var(--bd);border-bottom-left-radius:4px}
.msg.me .msg-text{background:#1a2400;border:1px solid #2a3a00;border-bottom-right-radius:4px}
.msg-time{font-size:9px;color:var(--tx3);padding:0 4px}
.msg.me .msg-time{text-align:right}
.msg-text pre{background:var(--bg);padding:8px;border-radius:6px;font-size:12px;overflow-x:auto;margin:6px 0;white-space:pre-wrap}
.msg-text code{background:var(--bg);padding:1px 4px;border-radius:3px;font-size:12px}
.msg-text strong{color:var(--ac)}
.msg-text ul,.msg-text ol{padding-left:18px;margin:4px 0}
.msg-text li{margin:2px 0}

/* 타이핑 표시 */
.typing{display:none;align-items:center;gap:8px;padding:4px 16px;font-size:12px;color:var(--tx2)}
.typing.show{display:flex}
.typing-dots{display:flex;gap:3px}
.typing-dots span{width:4px;height:4px;background:var(--tx2);border-radius:50%;animation:dot 1.4s infinite}
.typing-dots span:nth-child(2){animation-delay:.2s}
.typing-dots span:nth-child(3){animation-delay:.4s}
@keyframes dot{0%,60%,100%{opacity:.3}30%{opacity:1}}

/* 입력창 */
.inp-area{padding:8px 12px;padding-bottom:calc(8px + env(safe-area-inset-bottom));border-top:1px solid var(--bd);background:var(--bg2);flex-shrink:0}
.inp-box{display:flex;align-items:flex-end;gap:8px;background:var(--bg3);border:1px solid var(--bd);border-radius:20px;padding:8px 14px;transition:border-color .2s}
.inp-box:focus-within{border-color:var(--ac)}
.inp{flex:1;background:none;border:none;outline:none;color:var(--tx);font-family:inherit;font-size:16px;resize:none;max-height:120px;line-height:1.5}
.inp::placeholder{color:var(--tx3)}
.send-btn{width:36px;height:36px;border-radius:50%;border:none;background:var(--ac);color:#0a0a0a;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;transition:opacity .2s}
.send-btn:disabled{opacity:.3}
.send-btn svg{width:16px;height:16px}

/* 설정 모달 */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:100;align-items:center;justify-content:center}
.modal.show{display:flex}
.modal-box{background:var(--bg2);border:1px solid var(--bd);border-radius:var(--r);width:90%;max-width:400px;padding:20px}
.modal-title{font-size:15px;font-weight:600;margin-bottom:14px}
.modal-label{font-size:12px;color:var(--tx2);margin-bottom:6px}
.modal-input{width:100%;padding:10px;background:var(--bg);border:1px solid var(--bd);border-radius:8px;color:var(--tx);font-size:14px;font-family:inherit;margin-bottom:12px}
.modal-input:focus{outline:none;border-color:var(--ac)}
.modal-btns{display:flex;gap:8px;justify-content:flex-end}
.modal-btn{padding:8px 16px;border-radius:8px;border:none;font-family:inherit;font-size:13px;cursor:pointer}
.modal-save{background:var(--ac);color:#0a0a0a;font-weight:600}
.modal-cancel{background:var(--bg3);color:var(--tx2)}

/* 웰컴 */
.welcome{text-align:center;margin:auto;padding:20px}
.welcome-icon{width:64px;height:64px;border-radius:50%;background:var(--ac);display:flex;align-items:center;justify-content:center;font-weight:900;font-size:24px;color:#0a0a0a;margin:0 auto 16px}
.welcome h2{font-size:18px;margin-bottom:6px}
.welcome p{font-size:13px;color:var(--tx2);line-height:1.6}
.quick-btns{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin-top:16px}
.quick-btn{padding:8px 14px;border-radius:16px;border:1px solid var(--bd);background:var(--bg2);color:var(--tx);font-size:12px;cursor:pointer;font-family:inherit;transition:all .2s}
.quick-btn:hover{border-color:var(--ac);color:var(--ac)}
</style>
</head>
<body>

<div class="hd">
  <div class="hd-av">PM</div>
  <div>
    <div class="hd-name">하준 PM</div>
    <div class="hd-status"><span class="hd-dot"></span>온라인</div>
  </div>
  <div class="hd-right">
    <button class="hd-btn" onclick="clearChat()">초기화</button>
    <button class="hd-btn" onclick="openSettings()">설정</button>
  </div>
</div>

<div class="msgs" id="msgs"></div>

<div class="typing" id="typing">
  <div class="typing-dots"><span></span><span></span><span></span></div>
  하준이 입력 중...
</div>

<div class="inp-area">
  <div class="inp-box">
    <textarea class="inp" id="inp" rows="1" placeholder="메시지를 입력하세요..." oninput="autoResize(this)" onkeydown="onKey(event)"></textarea>
    <button class="send-btn" id="sendBtn" onclick="send()" disabled>
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
    </button>
  </div>
</div>

<div class="modal" id="settingsModal">
  <div class="modal-box">
    <div class="modal-title">릴레이 서버 설정</div>
    <div class="modal-label">릴레이 URL</div>
    <input class="modal-input" id="relayInput" placeholder="https://xxxx.ngrok-free.dev">
    <div style="font-size:11px;color:var(--tx3);margin-bottom:14px">아이맥 릴레이 서버 URL을 입력하세요. MOTIVE 웹과 동일한 URL입니다.</div>
    <div class="modal-btns">
      <button class="modal-btn modal-cancel" onclick="closeSettings()">취소</button>
      <button class="modal-btn modal-save" onclick="saveSettings()">저장</button>
    </div>
  </div>
</div>

<script>
const CHANNEL = 'ceo-direct';
let relayUrl = localStorage.getItem('pm-relay') || '';
let messages = [];
let sending = false;
let syncTimer = null;
let lastSyncCount = 0;

function now(){const d=new Date();return d.getHours()+':'+String(d.getMinutes()).padStart(2,'0')}

function fmt(text){
  return text
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
    .replace(/`([^`]+)`/g,'<code>$1</code>')
    .replace(/```([\s\S]*?)```/g,'<pre>$1</pre>')
    .replace(/\n/g,'<br>');
}

function render(){
  const box=document.getElementById('msgs');
  if(!messages.length){
    box.innerHTML=`<div class="welcome">
      <div class="welcome-icon">PM</div>
      <h2>하준 PM</h2>
      <p>채희웅 대표님, 안녕하세요!<br>무엇이든 편하게 말씀해주세요.</p>
      <div class="quick-btns">
        <button class="quick-btn" onclick="quickSend('오늘 할 일 정리해줘')">오늘 할 일</button>
        <button class="quick-btn" onclick="quickSend('진행 상황 알려줘')">진행 상황</button>
        <button class="quick-btn" onclick="quickSend('새 프로젝트 아이디어 논의하자')">새 프로젝트</button>
      </div>
    </div>`;
    return;
  }
  box.innerHTML=messages.map(m=>{
    const isMe=m.role==='user';
    return`<div class="msg ${isMe?'me':''}">
      <div class="msg-av">${isMe?'채':'PM'}</div>
      <div class="msg-body">
        <div class="msg-text">${fmt(m.content)}</div>
        <div class="msg-time">${m.time||''}</div>
      </div>
    </div>`;
  }).join('');
  box.scrollTop=box.scrollHeight;
}

function autoResize(el){
  el.style.height='auto';
  el.style.height=Math.min(el.scrollHeight,120)+'px';
  document.getElementById('sendBtn').disabled=!el.value.trim();
}

function onKey(e){
  if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send()}
}

function quickSend(text){
  document.getElementById('inp').value=text;
  send();
}

async function send(){
  const inp=document.getElementById('inp');
  const text=inp.value.trim();
  if(!text||sending)return;

  if(!relayUrl){openSettings();return}

  messages.push({role:'user',content:text,time:now()});
  render();
  inp.value='';inp.style.height='auto';
  document.getElementById('sendBtn').disabled=true;

  sending=true;
  document.getElementById('typing').classList.add('show');

  try{
    const r=await fetch(relayUrl.replace(/\/$/,'')+'/api/chat',{
      method:'POST',
      headers:{'Content-Type':'application/json','Bypass-Tunnel-Reminder':'true','ngrok-skip-browser-warning':'true'},
      body:JSON.stringify({
        system:'너는 하준 PM이다. 채희웅 대표님의 첫 번째 AI 파트너. 항상 한글로, 친근하고 유능하게 대화한다. 대표님이 묻는 것에 직접적으로 답하고, 필요하면 팀원을 언급한다. 짧고 핵심적으로 답한다.',
        message:text,
        channelId:CHANNEL
      })
    });
    const d=await r.json();
    if(d.ok&&d.text){
      messages.push({role:'assistant',content:d.text,time:now()});
    }else{
      messages.push({role:'assistant',content:'연결 오류: '+(d.error||'응답 없음'),time:now()});
    }
  }catch(e){
    messages.push({role:'assistant',content:'서버 연결 실패. 설정에서 릴레이 URL을 확인해주세요.',time:now()});
  }

  sending=false;
  document.getElementById('typing').classList.remove('show');
  render();
  // 서버와 다시 동기화
  setTimeout(syncFromServer,500);
}

function clearChat(){
  if(!confirm('대화 내용을 초기화할까요?'))return;
  messages=[];lastSyncCount=0;
  render();
  if(relayUrl){fetch(relayUrl.replace(/\/$/,'')+'/api/history/'+CHANNEL,{method:'DELETE',headers:{'Bypass-Tunnel-Reminder':'true'}}).catch(()=>{});}
}

function openSettings(){document.getElementById('settingsModal').classList.add('show');document.getElementById('relayInput').value=relayUrl}
function closeSettings(){document.getElementById('settingsModal').classList.remove('show')}
function saveSettings(){
  relayUrl=document.getElementById('relayInput').value.trim();
  localStorage.setItem('pm-relay',relayUrl);
  closeSettings();
  startSync();
}

// 서버에서 히스토리 동기화
async function syncFromServer(){
  if(!relayUrl||sending)return;
  try{
    const r=await fetch(relayUrl.replace(/\/$/,'')+'/api/history/'+CHANNEL,{
      headers:{'Bypass-Tunnel-Reminder':'true','ngrok-skip-browser-warning':'true'}
    });
    const d=await r.json();
    if(d.ok&&d.history){
      const serverCount=d.history.length;
      if(serverCount!==lastSyncCount){
        lastSyncCount=serverCount;
        // 서버 히스토리를 로컬 시간 포맷으로 변환
        messages=d.history.map(m=>{
          let t='';
          if(m.time){try{const dt=new Date(m.time);t=dt.getHours()+':'+String(dt.getMinutes()).padStart(2,'0')}catch(e){}}
          return{role:m.role,content:m.content,time:t||m.time||''};
        });
        render();
      }
    }
  }catch(e){}
}

function startSync(){
  if(syncTimer)clearInterval(syncTimer);
  syncFromServer();
  syncTimer=setInterval(syncFromServer,3000);
}

// iOS 키보드 대응
if(window.visualViewport){
  window.visualViewport.addEventListener('resize',()=>{
    document.body.style.height=window.visualViewport.height+'px';
  });
}
document.getElementById('inp').addEventListener('focus',()=>{
  setTimeout(()=>document.getElementById('inp').scrollIntoView({block:'end',behavior:'smooth'}),300);
});

// 초기화
render();
if(!relayUrl){setTimeout(openSettings,500)}else{startSync()}
</script>
</body>
</html>
