<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Whistle AI â€” ìˆ˜ì¶œ í”Œë«í¼</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&family=Noto+Sans+KR:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root{--bg:#060B18;--bg2:#0A1020;--card:#0D1424;--card2:#111B2E;--sf:#111B2E;--pri:#00D4FF;--pri-g:linear-gradient(135deg,#00D4FF,#0088FF);--pri-d:#0088FF;--pri-glow:0 0 30px rgba(0,212,255,.12);--acc:#FFB800;--acc-g:linear-gradient(135deg,#FFB800,#FF8C00);--ok:#00E676;--err:#FF5252;--warn:#FFA726;--purple:#A855F7;--w:#fff;--w90:rgba(255,255,255,.9);--w70:rgba(255,255,255,.7);--w60:rgba(255,255,255,.6);--w40:rgba(255,255,255,.4);--w20:rgba(255,255,255,.2);--w12:rgba(255,255,255,.1);--w08:rgba(255,255,255,.06);--bd:rgba(255,255,255,.08);--bd-l:rgba(255,255,255,.15);--r:14px;--r-s:10px;--r-xs:6px;--shadow:0 4px 24px rgba(0,0,0,.4);--shadow-lg:0 12px 48px rgba(0,0,0,.6)}
*{box-sizing:border-box;margin:0;padding:0}html{scroll-behavior:smooth}
body{background:var(--bg);font-family:'Sora','Noto Sans KR',-apple-system,sans-serif;color:var(--w);line-height:1.5;overflow:hidden;height:100vh}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:var(--bg2)}::-webkit-scrollbar-thumb{background:var(--w12);border-radius:3px}::selection{background:rgba(0,212,255,.3)}
input:focus,textarea:focus,select:focus{outline:none;border-color:var(--pri)!important;box-shadow:0 0 0 3px rgba(0,212,255,.1)}
select option{background:var(--card);color:var(--w90)}textarea{resize:vertical;min-height:60px}a{color:var(--pri);text-decoration:none}
.app-layout{display:flex;height:100vh;overflow:hidden}
.sidebar{width:240px;background:var(--bg2);border-right:1px solid var(--bd);display:flex;flex-direction:column;flex-shrink:0;overflow-y:auto}
.sidebar-header{padding:16px;border-bottom:1px solid var(--bd);display:flex;align-items:center;gap:10px}
.sidebar-logo{width:32px;height:32px;border-radius:9px;background:var(--pri-g);display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:900;color:var(--bg);flex-shrink:0}
.sidebar-title{font-size:15px;font-weight:800;letter-spacing:-.5px}
.sidebar-sub{font-size:10px;color:var(--w40);font-family:'JetBrains Mono'}
.sidebar-nav{flex:1;padding:8px;overflow-y:auto}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:var(--r-s);font-size:13px;font-weight:500;color:var(--w60);cursor:pointer;transition:all .15s;border:1px solid transparent;margin-bottom:2px}
.nav-item:hover{background:var(--w08);color:var(--w90)}
.nav-item.active{background:rgba(0,212,255,.08);color:var(--pri);border-color:rgba(0,212,255,.15);font-weight:600}
.nav-item .icon{font-size:16px;width:20px;text-align:center}
.nav-item .badge-count{margin-left:auto;font-size:10px;background:var(--err);color:var(--w);padding:1px 6px;border-radius:10px;font-weight:700}
.nav-section{height:1px;background:var(--bd);margin:8px 12px}
.sidebar-footer{padding:12px;border-top:1px solid var(--bd)}
.main-area{flex:1;display:flex;flex-direction:column;overflow:hidden}
.topbar{height:52px;background:rgba(6,11,24,.9);-webkit-backdrop-filter:blur(12px);backdrop-filter:blur(12px);border-bottom:1px solid var(--bd);display:flex;align-items:center;justify-content:space-between;padding:0 24px;flex-shrink:0}
.topbar-title{font-size:15px;font-weight:700}
.page-content{flex:1;overflow-y:auto;padding:24px}
.card{background:var(--card);border-radius:var(--r);border:1px solid var(--bd);overflow:hidden}
.card-h{padding:14px 18px;border-bottom:1px solid var(--bd);display:flex;align-items:center;justify-content:space-between;font-weight:700;font-size:14px}
.card-b{padding:18px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:9px 18px;border-radius:var(--r-s);font-size:13px;font-weight:600;font-family:inherit;cursor:pointer;border:none;transition:all .15s;white-space:nowrap}
.btn:hover{filter:brightness(1.1);transform:translateY(-1px)}.btn:active{transform:translateY(0)}.btn:disabled{opacity:.5;cursor:not-allowed}
.btn-pri{background:var(--pri-g);color:var(--bg);box-shadow:var(--pri-glow)}.btn-acc{background:var(--acc-g);color:var(--bg)}
.btn-ok{background:var(--ok);color:var(--bg)}.btn-ghost{background:transparent;color:var(--w);border:1.5px solid var(--bd-l)}
.btn-ghost:hover{border-color:var(--w40)}.btn-danger{background:rgba(255,82,82,.15);color:var(--err);border:1px solid rgba(255,82,82,.2)}
.btn-sm{padding:5px 12px;font-size:12px;border-radius:var(--r-xs)}.btn-lg{padding:12px 24px;font-size:14px}.btn-block{width:100%}
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:var(--r-xs);font-size:11px;font-weight:600;font-family:'JetBrains Mono',monospace}
.badge-pri{background:rgba(0,212,255,.1);color:var(--pri);border:1px solid rgba(0,212,255,.2)}
.badge-acc{background:rgba(255,184,0,.1);color:var(--acc);border:1px solid rgba(255,184,0,.2)}
.badge-ok{background:rgba(0,230,118,.1);color:var(--ok);border:1px solid rgba(0,230,118,.2)}
.badge-err{background:rgba(255,82,82,.1);color:var(--err);border:1px solid rgba(255,82,82,.2)}
.badge-purple{background:rgba(168,85,247,.1);color:var(--purple);border:1px solid rgba(168,85,247,.2)}
.badge-ghost{background:var(--w08);color:var(--w40);border:1px solid var(--bd)}
.form-group{margin-bottom:14px}
.form-label{display:block;font-size:12px;font-weight:600;color:var(--w40);margin-bottom:6px}
.form-input,.form-select,.form-textarea{width:100%;padding:11px 14px;border-radius:var(--r-s);border:1.5px solid var(--bd);background:var(--sf);color:var(--w90);font-size:14px;font-family:inherit}
.form-input::placeholder{color:var(--w20)}
.tbl{width:100%;border-collapse:collapse}
.tbl th{text-align:left;padding:10px 14px;font-size:11px;font-weight:600;color:var(--w40);text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--bd-l);background:var(--w08)}
.tbl td{padding:11px 14px;font-size:13px;border-bottom:1px solid var(--w08);color:var(--w90)}
.tbl tr:hover td{background:var(--w08)}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
.grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.modal-overlay{position:fixed;top:0;right:0;bottom:0;left:0;background:rgba(0,0,0,.7);-webkit-backdrop-filter:blur(12px);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;visibility:hidden;transition:all .2s}
.modal-overlay.show{opacity:1;visibility:visible}
.modal{background:var(--card);border:1px solid var(--bd-l);border-radius:var(--r);width:90%;max-width:520px;max-height:85vh;overflow-y:auto;box-shadow:var(--shadow-lg)}
.modal-h{padding:16px 20px;border-bottom:1px solid var(--bd);display:flex;align-items:center;justify-content:space-between}
.modal-h h3{font-size:16px;font-weight:700}
.modal-close{width:28px;height:28px;border-radius:8px;background:var(--w08);border:none;color:var(--w40);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.modal-close:hover{background:var(--w12);color:var(--w)}
.modal-b{padding:20px}.modal-f{padding:14px 20px;border-top:1px solid var(--bd);display:flex;justify-content:flex-end;gap:8px}
.toast-container{position:fixed;top:16px;right:16px;z-index:2000;display:flex;flex-direction:column;gap:8px}
.toast{padding:12px 18px;border-radius:var(--r-s);font-size:13px;font-weight:500;display:flex;align-items:center;gap:8px;box-shadow:var(--shadow);animation:slideInR .3s ease;min-width:280px}
.toast-ok{background:#0a2a1a;border:1px solid rgba(0,230,118,.25);color:var(--ok)}
.toast-err{background:#2a0a0a;border:1px solid rgba(255,82,82,.25);color:var(--err)}
.toast-warn{background:#2a1a0a;border:1px solid rgba(255,167,38,.25);color:var(--warn)}
.toast-info{background:#0a1a2a;border:1px solid rgba(0,212,255,.25);color:var(--pri)}
.stat-card{background:var(--card);border:1px solid var(--bd);border-radius:var(--r);padding:18px}
.stat-label{font-size:11px;color:var(--w40);font-weight:500;margin-bottom:6px}
.stat-value{font-family:'Sora';font-weight:800;font-size:26px;letter-spacing:-1px}
.stat-sub{font-size:11px;color:var(--w20);margin-top:4px}
.spinner{width:24px;height:24px;border:3px solid var(--w08);border-top-color:var(--pri);border-radius:50%;animation:spin .8s linear infinite}
.auth-wrap{display:flex;align-items:center;justify-content:center;height:100vh;background:var(--bg);padding:20px}
.auth-card{width:100%;max-width:420px;background:var(--card);border:1px solid var(--bd);border-radius:20px;padding:36px;box-shadow:var(--shadow-lg)}
.auth-logo{display:flex;align-items:center;gap:10px;margin-bottom:28px}
.auth-logo-icon{width:38px;height:38px;border-radius:10px;background:var(--pri-g);display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:900;color:var(--bg)}
.auth-title{font-size:22px;font-weight:800;letter-spacing:-.5px}
.auth-sub{font-size:12px;color:var(--w40)}
.auth-tabs{display:flex;gap:4px;margin-bottom:20px}
.auth-tab{flex:1;padding:10px;text-align:center;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;border:1px solid transparent;color:var(--w40);transition:all .15s}
.auth-tab.active{background:rgba(0,212,255,.08);color:var(--pri);border-color:rgba(0,212,255,.2)}
.auth-tab:hover:not(.active){background:var(--w08)}
.auth-error{padding:10px 14px;border-radius:8px;background:rgba(255,82,82,.1);border:1px solid rgba(255,82,82,.2);color:var(--err);font-size:12px;margin-bottom:12px}
.dash-hero{background:linear-gradient(135deg,rgba(0,212,255,.06),rgba(168,85,247,.06));border:1px solid rgba(0,212,255,.1);border-radius:16px;padding:28px;margin-bottom:20px}
.dash-welcome{font-size:22px;font-weight:800;letter-spacing:-.5px;margin-bottom:4px}
.dash-company{font-size:13px;color:var(--w40)}
.quick-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-top:16px}
.quick-card{padding:14px;border-radius:12px;background:var(--card);border:1px solid var(--bd);cursor:pointer;transition:all .15s;text-align:center}
.quick-card:hover{border-color:var(--pri);transform:translateY(-2px)}
.quick-icon{font-size:24px;margin-bottom:6px}.quick-label{font-size:12px;font-weight:600;color:var(--w70)}
.svc-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}
.svc-card{padding:20px;border-radius:14px;background:var(--card);border:1px solid var(--bd);cursor:pointer;transition:all .2s}
.svc-card:hover{border-color:var(--pri);background:var(--card2)}
.svc-icon{font-size:28px;margin-bottom:8px}.svc-name{font-size:15px;font-weight:700;margin-bottom:4px}
.svc-desc{font-size:12px;color:var(--w40);line-height:1.6}.svc-price{font-size:12px;color:var(--acc);font-weight:700;font-family:'JetBrains Mono';margin-top:8px}
.prod-card{background:var(--card);border:1px solid var(--bd);border-radius:14px;overflow:hidden;transition:all .15s;cursor:pointer}
.prod-card:hover{border-color:var(--pri)}
.prod-img{height:140px;background:var(--sf);display:flex;align-items:center;justify-content:center;font-size:40px;color:var(--w20)}
.prod-body{padding:14px}.prod-name{font-size:14px;font-weight:700;margin-bottom:4px}.prod-meta{font-size:11px;color:var(--w40)}
.plan-card{border-radius:16px;border:2px solid var(--bd);padding:24px;text-align:center;transition:all .2s}
.plan-card:hover{transform:translateY(-4px)}
.plan-card.current{border-color:var(--pri);background:rgba(0,212,255,.04)}
.plan-card.recommended{border-color:var(--acc);background:rgba(255,184,0,.04)}
.plan-name{font-size:20px;font-weight:800;margin:8px 0 4px}
.plan-price{font-size:28px;font-weight:900;letter-spacing:-1px}
.plan-period{font-size:11px;color:var(--w40)}
.plan-features{text-align:left;margin-top:14px;font-size:12px;line-height:2.2;color:var(--w70)}
.empty-state{text-align:center;padding:48px 24px;color:var(--w40)}
.empty-state .ei{font-size:48px;margin-bottom:12px;opacity:.4}
.empty-state .et{font-size:16px;font-weight:700;margin-bottom:4px;color:var(--w60)}
.empty-state .ed{font-size:13px}
@keyframes slideInR{from{transform:translateX(100px);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes spin{to{transform:rotate(360deg)}}
@media(max-width:768px){.sidebar{display:none}.sidebar.mobile-open{display:flex;position:fixed;top:0;right:0;bottom:0;left:0;z-index:900;width:280px;box-shadow:var(--shadow-lg)}.sidebar.mobile-open~.mob-overlay{display:block}.mob-overlay{display:none;position:fixed;top:0;right:0;bottom:0;left:0;background:rgba(0,0,0,.6);z-index:899}.grid-2,.grid-3,.grid-4{grid-template-columns:1fr}.page-content{padding:16px}.topbar{padding:0 16px}.mob-toggle{display:flex!important}}
.mob-toggle{display:none;width:36px;height:36px;border-radius:8px;background:var(--w08);border:none;color:var(--w60);font-size:16px;cursor:pointer;align-items:center;justify-content:center;transition:all .15s}
.mob-toggle:hover{background:var(--w12);color:var(--w)}
.notif-dot{width:7px;height:7px;border-radius:50%;background:var(--err);position:absolute;top:-1px;right:-1px;animation:pulse 2s infinite}
</style>
</head>
<body>
<div id="app"></div>
<script>
(function(){
"use strict";
var sb=window.supabase.createClient('https://lylktgxngrlxmsldxdqj.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx5bGt0Z3huZ3JseG1zbGR4ZHFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4MTQ2OTAsImV4cCI6MjA4NzM5MDY5MH0.8kgcDCMBT_STf43MVkeUUiq-K6r-Ytp3nUQ6d-nL2D0');
var RELAY_URL=(location.hostname==='localhost'||location.hostname==='127.0.0.1')?'http://localhost:3456':'https://uncommanded-brooke-truculent.ngrok-free.dev';

/* === UTILS === */
var U={
  fd:function(d,s){if(!d)return'\u2014';var dt=new Date(d);if(isNaN(dt))return'\u2014';if(s==='rel'){var m=Math.floor((Date.now()-dt)/6e4);if(m<1)return'\uBC29\uAE08';if(m<60)return m+'\uBD84 \uC804';var h=Math.floor(m/60);if(h<24)return h+'\uC2DC\uAC04 \uC804';var dd=Math.floor(h/24);return dd+'\uC77C \uC804';}return dt.toLocaleDateString('ko-KR',{year:'numeric',month:'short',day:'numeric'});},
  usd:function(n){if(n==null)return'\u2014';return'$'+Number(n).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});},
  krw:function(n){if(n==null)return'\u2014';n=Number(n);if(n>=1e8)return'\u20A9'+(n/1e8).toFixed(1)+'\uC5B5';if(n>=1e4)return'\u20A9'+(n/1e4).toFixed(0)+'\uB9CC';return'\u20A9'+n.toLocaleString('ko-KR');},
  tr:function(s,l){l=l||50;return s&&s.length>l?s.slice(0,l)+'\u2026':s||'';},
  esc:function(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');},
  sl:function(t){return{premium_analysis:'\uD504\uB9AC\uBBF8\uC5C4 \uBD84\uC11D',matching:'\uBC14\uC774\uC5B4 \uB9E4\uCE6D',document:'\uC11C\uB958 \uB300\uD589',certification:'\uC778\uC99D \uB300\uD589',logistics:'\uBB3C\uB958/\uD1B5\uAD00',email_support:'\uC774\uBA54\uC77C \uC9C0\uC6D0'}[t]||t;},
  si:function(t){return{premium_analysis:'\uD83D\uDD2C',matching:'\uD83E\uDD1D',document:'\uD83D\uDCC4',certification:'\uD83C\uDFC5',logistics:'\uD83D\uDEA2',email_support:'\u2709\uFE0F'}[t]||'\uD83D\uDCCB';},
  cl:function(c){return{US:'\uD83C\uDDFA\uD83C\uDDF8 \uBBF8\uAD6D',JP:'\uD83C\uDDEF\uD83C\uDDF5 \uC77C\uBCF8',CN:'\uD83C\uDDE8\uD83C\uDDF3 \uC911\uAD6D',EU:'\uD83C\uDDEA\uD83C\uDDFA EU',SEA:'\uD83C\uDF0F \uB3D9\uB0A8\uC544'}[c]||c||'\u2014';},
  CAT:['K-Beauty','K-Food','K-Health','K-Fashion','K-Electronics','K-Living','Other'],
  fmtPrice:function(krw){if(krw==null)return'\u2014';var n=Number(krw);if(!n&&n!==0)return'\u2014';if(S.currency==='USD'){var usd=n/(S.exchangeRate||1400);return'$'+usd.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});}if(n>=1e8)return(n/1e8).toFixed(1)+'\uC5B5\uC6D0';if(n>=1e4)return(n/1e4).toFixed(0)+'\uB9CC\uC6D0';return n.toLocaleString('ko-KR')+'\uC6D0';},
  fmtUSD:function(usd){if(usd==null)return'\u2014';var n=Number(usd);if(S.currency==='KRW'){var krw=n*(S.exchangeRate||1400);return Math.round(krw).toLocaleString('ko-KR')+'\uC6D0';}return'$'+n.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});},
  toUSD:function(krw){return Number(krw)/(S.exchangeRate||1400);},
  toKRW:function(usd){return Number(usd)*(S.exchangeRate||1400);},
  n:function(v){if(v==null)return'0';return Number(v).toLocaleString();}
};

/* === UI === */
var tc=null;
var UI={
  toast:function(msg,type,dur){type=type||'info';dur=dur||3000;if(!tc){tc=document.createElement('div');tc.className='toast-container';document.body.appendChild(tc);}var icons={ok:'\u2713',err:'\u2715',warn:'\u26A0',info:'\u2139'};var el=document.createElement('div');el.className='toast toast-'+type;el.innerHTML='<span>'+((icons[type])||'\u2139')+'</span><span>'+msg+'</span>';tc.appendChild(el);setTimeout(function(){el.style.opacity='0';el.style.transform='translateX(100px)';el.style.transition='all .3s';setTimeout(function(){el.remove();},300);},dur);},
  showModal:function(id){var e=document.getElementById(id);if(e)e.classList.add('show');},
  hideModal:function(id){var e=document.getElementById(id);if(e)e.classList.remove('show');},
  modal:function(o){return'<div class="modal-overlay" id="'+o.id+'" onclick="if(event.target===this)App.closeModal(\''+o.id+'\')"><div class="modal" style="max-width:'+(o.width||'520px')+'"><div class="modal-h"><h3>'+o.title+'</h3><button class="modal-close" onclick="App.closeModal(\''+o.id+'\')">&#10005;</button></div><div class="modal-b">'+o.body+'</div>'+(o.footer?'<div class="modal-f">'+o.footer+'</div>':'')+'</div></div>';},
  badge:function(t,type){return'<span class="badge badge-'+(type||'pri')+'">'+t+'</span>';},
  sb:function(s){var m={pending:['ëŒ€ê¸°ì¤‘','acc'],processing:['ì²˜ë¦¬ì¤‘','pri'],completed:['ì™„ë£Œ','ok'],cancelled:['ì·¨ì†Œ','ghost'],failed:['ì‹¤íŒ¨','err'],draft:['ì´ˆì•ˆ','ghost'],active:['í™œì„±','ok'],paused:['ì¤‘ì§€','acc'],analyzing:['ë¶„ì„ì¤‘','pri'],review:['ê²€ìˆ˜ì¤‘','purple'],approved:['ìŠ¹ì¸','ok'],accepted:['ì ‘ìˆ˜','pri']};var r=m[s]||[s,'ghost'];return this.badge(r[0],r[1]);},
  empty:function(icon,title,desc){return'<div class="empty-state"><div class="ei">'+icon+'</div><div class="et">'+title+'</div><div class="ed">'+(desc||'')+'</div></div>';},
  stat:function(label,value,sub,color){return'<div class="stat-card"><div class="stat-label">'+label+'</div><div class="stat-value" style="color:'+(color||'var(--pri)')+'">'+value+'</div>'+(sub?'<div class="stat-sub">'+sub+'</div>':'')+'</div>';},
  inp:function(name,label,o){o=o||{};return'<div class="form-group"><label class="form-label">'+label+(o.required?' <span style="color:var(--err)">*</span>':'')+'</label><input class="form-input" name="'+name+'" type="'+(o.type||'text')+'" value="'+(o.value||'')+'" placeholder="'+(o.placeholder||'')+'" '+(o.required?'required':'')+'></div>';},
  sel:function(name,label,opts,sel){var os=opts.map(function(o){var v=typeof o==='object'?o.value:o;var t=typeof o==='object'?o.label:o;return'<option value="'+v+'" '+(v===sel?'selected':'')+'>'+t+'</option>';}).join('');return'<div class="form-group"><label class="form-label">'+label+'</label><select class="form-select" name="'+name+'">'+os+'</select></div>';},
  ta:function(name,label,o){o=o||{};return'<div class="form-group"><label class="form-label">'+label+'</label><textarea class="form-textarea" name="'+name+'" rows="'+(o.rows||3)+'" placeholder="'+(o.placeholder||'')+'">'+(o.value||'')+'</textarea></div>';},
  fd:function(sel){var el=typeof sel==='string'?document.querySelector(sel):sel;if(!el)return{};var d={};el.querySelectorAll('input,select,textarea').forEach(function(i){if(i.name){d[i.name]=i.type==='number'&&i.value?Number(i.value):i.value;}});return d;},
  pb:function(p){var m={free:['FREE','var(--w40)'],starter:['STARTER','var(--pri)'],basic:['BASIC','var(--pri)'],pro:['PRO','var(--acc)'],alibaba:['ALIBABA','var(--err)']};var r=m[p]||m.free;return'<span class="badge" style="background:'+r[1]+'15;color:'+r[1]+';border:1px solid '+r[1]+'25">'+r[0]+'</span>';}
};

/* === PLAN LIMITS === */
var PLAN_LIMITS={
  free:{analyses:3,products:5,projects:1,docs:0,emails:0,matching:0},
  starter:{analyses:10,products:20,projects:5,docs:-1,emails:50,matching:0},
  pro:{analyses:-1,products:-1,projects:-1,docs:-1,emails:-1,matching:1},
  alibaba:{analyses:-1,products:-1,projects:-1,docs:-1,emails:-1,matching:3}
};

/* === PLAN GATE === */
function _planGate(feature){
  var cur=S.user&&S.user.plan||'free';
  var lim=PLAN_LIMITS[cur]||PLAN_LIMITS.free;
  var used=0,max=0,label='';
  if(feature==='analysis'){used=S.analyses.filter(function(a){var d=new Date(a.created_at),n=new Date();return d.getMonth()===n.getMonth()&&d.getFullYear()===n.getFullYear();}).length;max=lim.analyses;label='AI ë¶„ì„';}
  else if(feature==='product'){used=S.products.length;max=lim.products;label='ì œí’ˆ ë“±ë¡';}
  else if(feature==='project'){used=S.projects.length;max=lim.projects;label='í”„ë¡œì íŠ¸';}
  else if(feature==='docgen'){max=lim.docs;label='ì„œë¥˜ ìë™ìƒì„±';}
  else if(feature==='emailhub'){max=lim.emails;label='ì´ë©”ì¼ í—ˆë¸Œ';}
  else if(feature==='matching'){max=lim.matching;label='ë°”ì´ì–´ ë§¤ì¹­';}
  if(max===0)return{blocked:true,label:label,plan:cur,minPlan:feature==='matching'?'pro':'starter'};
  if(max===-1)return{blocked:false};
  if(used>=max)return{blocked:true,label:label,used:used,max:max,plan:cur,minPlan:_nextPlan(cur)};
  return{blocked:false,used:used,max:max};
}
function _nextPlan(cur){return cur==='free'?'starter':cur==='starter'?'pro':'alibaba';}
function _lockOverlay(gate){
  return '<div style="position:relative"><div style="filter:blur(3px);pointer-events:none;opacity:.5;user-select:none">';
}
function _lockOverlayEnd(gate){
  var mp=gate.minPlan||'starter';
  var voucherMsg=mp==='starter'||mp==='pro'?'<div style="margin-top:8px;padding:6px 12px;border-radius:8px;background:rgba(255,184,0,.1);border:1px solid rgba(255,184,0,.2)"><span style="font-size:12px;color:var(--acc);font-weight:700">ìˆ˜ì¶œë°”ìš°ì²˜ ì ìš©ì‹œ ìë¶€ë‹´ 0ì›</span></div>':'';
  return '</div><div style="position:absolute;top:0;right:0;bottom:0;left:0;display:flex;align-items:center;justify-content:center;z-index:5"><div style="text-align:center;padding:32px;border-radius:16px;background:rgba(6,11,24,.92);border:1px solid var(--bd-l);max-width:400px;-webkit-backdrop-filter:blur(12px);backdrop-filter:blur(12px)"><div style="font-size:32px;margin-bottom:12px">ğŸ”’</div><div style="font-size:14px;color:var(--w70);margin-bottom:12px;line-height:1.6">'+
    (gate.max===0?gate.label+' ê¸°ëŠ¥ì€ <b style="color:var(--pri)">'+(mp==='starter'?'STARTER':'PRO')+'</b> í”Œëœë¶€í„° ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.':gate.label+' í•œë„ ì´ˆê³¼ (<b>'+gate.used+'/'+gate.max+'</b>)<br><b style="color:var(--pri)">'+(mp==='starter'?'STARTER':'PRO')+'</b>ë¡œ ì—…ê·¸ë ˆì´ë“œí•˜ì„¸ìš”.')+
    '</div>'+voucherMsg+'<button class="btn btn-pri" style="margin-top:14px" onclick="App.openCheckout(\''+mp+'\')">ì—…ê·¸ë ˆì´ë“œ</button></div></div></div>';
}

/* === DISCLAIMER === */
var DISCLAIMER={ko:'ë³¸ ì„œë¥˜ëŠ” AIê°€ ìë™ ìƒì„±í•œ ì°¸ê³ ìš© ë¬¸ì„œì…ë‹ˆë‹¤. ë²•ì  íš¨ë ¥ì„ ë³´ì¥í•˜ì§€ ì•Šìœ¼ë©°, ì‹¤ì œ ìˆ˜ì¶œ ì‹œ ë°˜ë“œì‹œ ê´€ì„¸ì‚¬/ë¬´ì—­ì „ë¬¸ê°€ì˜ ê²€í† ë¥¼ ë°›ìœ¼ì‹œê¸° ë°”ëë‹ˆë‹¤.',en:'This document is AI-generated for reference only. Please consult a licensed customs broker before actual export use.'};
function _disclaimerBanner(docId){
  var isPro=(S.user&&S.user.plan||'free')==='pro'||(S.user&&S.user.plan||'free')==='alibaba';
  return '<div style="padding:12px;border-radius:10px;background:rgba(255,167,38,.06);border:1px solid rgba(255,167,38,.15);margin-bottom:14px"><div style="display:flex;align-items:start;gap:10px"><span style="font-size:18px;flex-shrink:0">âš–ï¸</span><div style="flex:1"><div style="font-size:12px;font-weight:700;color:#FFA726;margin-bottom:4px">AI ìë™ìƒì„± ë¬¸ì„œ ì•ˆë‚´</div><div style="font-size:11px;color:var(--w60);line-height:1.6">'+DISCLAIMER.ko+'</div></div>'+
    (isPro?'<button class="btn btn-acc btn-sm" onclick="App.reqExpertReview(\''+(docId||'')+'\')" style="flex-shrink:0;white-space:nowrap">ê´€ì„¸ì‚¬ ê²€í†  ìš”ì²­</button>':'<button class="btn btn-ghost btn-sm" onclick="App.openCheckout(\'pro\')" style="flex-shrink:0;white-space:nowrap">PRO ê²€í†  ë²ˆë“¤</button>')+
    '</div></div>';
}
function reqExpertReview(docId){
  if(!docId){UI.toast('ì„œë¥˜ë¥¼ ë¨¼ì € ìƒì„±í•˜ì„¸ìš”','warn');return;}
  sb.from('documents').update({expert_review_requested:true,expert_review_status:'requested'}).eq('id',docId).then(function(){
    sb.from('service_requests').insert({user_id:S.user.id,service_type:'document_review',description:'ì„œë¥˜ ê´€ì„¸ì‚¬ ê²€í†  ìš”ì²­ ('+docId+')',status:'pending'}).then(function(){
      UI.toast('ê´€ì„¸ì‚¬ ê²€í†  ìš”ì²­ ì™„ë£Œ! ì˜ì—…ì¼ ê¸°ì¤€ 24ì‹œê°„ ë‚´ íšŒì‹ ë“œë¦½ë‹ˆë‹¤.','ok');
    });
  });
}

/* === STATE === */
var S={user:null,company:null,page:'dashboard',authMode:'login',authError:'',loading:true,analyses:[],products:[],projects:[],serviceRequests:[],buyers:[],emailLogs:[],shippingRates:[],tariffRates:[],orders:[],notifications:[],meetings:[],samples:[],shipments:[],paymentMilestones:[],alibabaStores:[],alibabaInquiries:[],notifOpen:false,currentAnalysis:null,analysisStep:0,analysisData:null,currentProject:null,docType:null,docItems:[],docData:null,currency:'KRW',exchangeRate:1400};
window._exRate=1400;

function set(u){for(var k in u)S[k]=u[k];render();}

/* === EXCHANGE RATE === */
function loadExchangeRate(){
  fetch(RELAY_URL+'/api/exchange-rate').then(function(r){return r.json();}).then(function(d){
    if(d&&d.ok&&d.rate){S.exchangeRate=d.rate;window._exRate=d.rate;}
  }).catch(function(){});
}
function toggleCurrency(){
  S.currency=S.currency==='KRW'?'USD':'KRW';
  if(S.user){sb.from('users').update({preferred_currency:S.currency}).eq('id',S.user.id);}
  render();
}

/* === DATA === */
function loadUser(){
  sb.auth.getSession().then(function(res){
    var session=res.data.session;
    if(!session)return set({loading:false});
    sb.from('users').select('*').eq('id',session.user.id).single().then(function(r){
      if(r.error||!r.data||(r.data.role!=='client'&&r.data.role!=='buyer')){sb.auth.signOut();return set({loading:false});}
      S.user=r.data;
      if(r.data.preferred_currency)S.currency=r.data.preferred_currency;
      if(r.data.role==='buyer'&&!r.data.preferred_currency)S.currency='USD';
      loadExchangeRate();
      sb.from('companies').select('*').eq('user_id',r.data.id).maybeSingle().then(function(cr){
        S.company=cr.data||null;S.loading=false;
        /* Promise.allSettled polyfill for older browsers (iOS 12, Samsung Internet 11) */
        var _settled=typeof Promise.allSettled==='function'?Promise.allSettled.bind(Promise):function(ps){return Promise.all(ps.map(function(p){return Promise.resolve(p).then(function(v){return{status:'fulfilled',value:v};},function(e){return{status:'rejected',reason:e};});}));};
        _settled([loadA(),loadP(),loadPr(),loadSR(),loadB(),loadEmailLogs(),loadShippingRates(),loadTariffRates(),loadOrders(),loadNotifications(),loadMeetings(),loadSamples(),loadShipments(),loadMilestones(),loadAlibabaStores(),loadAlibabaInquiries()]).then(function(){render();});
      });
    });
  });
}
function loadA(){return sb.from('analyses').select('*').eq('user_id',S.user.id).order('created_at',{ascending:false}).limit(50).then(function(r){S.analyses=r.data||[];});}
function loadP(){return sb.from('products').select('*').eq('user_id',S.user.id).order('created_at',{ascending:false}).then(function(r){S.products=r.data||[];});}
function loadPr(){return sb.from('projects').select('*').eq('user_id',S.user.id).order('created_at',{ascending:false}).then(function(r){S.projects=r.data||[];});}
function loadSR(){return sb.from('service_requests').select('*').eq('user_id',S.user.id).order('created_at',{ascending:false}).then(function(r){S.serviceRequests=r.data||[];});}
function loadB(){return sb.from('buyers').select('*').eq('registered_by',S.user.id).order('created_at',{ascending:false}).then(function(r){S.buyers=r.data||[];});}

/* === AUTH === */
function doLogin(e){e.preventDefault();var f=e.target;S.authError='';
  sb.auth.signInWithPassword({email:f.email.value,password:f.password.value}).then(function(r){
    if(r.error)return set({authError:r.error.message==='Invalid login credentials'?'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.':r.error.message});
    loadUser();
  });
}
function doSignup(e){e.preventDefault();var f=e.target;
  if(f.password.value.length<6)return set({authError:'ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒ'});
  S.authError='';
  sb.auth.signUp({email:f.email.value,password:f.password.value,options:{data:{role:'client',company_name:f.company_name.value}}}).then(function(r){
    if(r.error)return set({authError:r.error.message.includes('already registered')?'ì´ë¯¸ ë“±ë¡ëœ ì´ë©”ì¼':r.error.message});
    UI.toast('ê°€ì… ì™„ë£Œ! ì´ë©”ì¼ í™•ì¸ í›„ ë¡œê·¸ì¸í•˜ì„¸ìš”','ok');set({authMode:'login'});
  });
}
function doLogout(){if(confirm('ë¡œê·¸ì•„ì›ƒ?')){sb.auth.signOut().then(function(){S.user=null;S.company=null;render();});}}

/* === PAGES === */
function pgAuth(){
  var isL=S.authMode==='login';
  return '<div class="auth-wrap"><div class="auth-card"><div class="auth-logo"><div class="auth-logo-icon">W</div><div><div class="auth-title">Whistle AI</div><div class="auth-sub">ìˆ˜ì¶œ ì„±ê³µì˜ ì‹œì‘</div></div></div><div class="auth-tabs"><div class="auth-tab '+(isL?'active':'')+'" onclick="App.set({authMode:\'login\',authError:\'\'})">ë¡œê·¸ì¸</div><div class="auth-tab '+(!isL?'active':'')+'" onclick="App.set({authMode:\'signup\',authError:\'\'})">íšŒì›ê°€ì…</div></div>'+(S.authError?'<div class="auth-error">'+S.authError+'</div>':'')+(isL?'<form onsubmit="App.doLogin(event)">'+UI.inp('email','ì´ë©”ì¼',{type:'email',placeholder:'email@company.com',required:true})+UI.inp('password','ë¹„ë°€ë²ˆí˜¸',{type:'password',placeholder:'ë¹„ë°€ë²ˆí˜¸',required:true})+'<button class="btn btn-pri btn-block btn-lg" type="submit" style="margin-top:8px">ë¡œê·¸ì¸</button></form>':'<form onsubmit="App.doSignup(event)">'+UI.inp('company_name','íšŒì‚¬ëª…',{placeholder:'(ì£¼)ëª¨í‹°ë¸Œì´ë…¸ë² ì´ì…˜',required:true})+UI.inp('email','ì´ë©”ì¼',{type:'email',placeholder:'email@company.com',required:true})+UI.inp('password','ë¹„ë°€ë²ˆí˜¸',{type:'password',placeholder:'6ì ì´ìƒ',required:true})+'<button class="btn btn-pri btn-block btn-lg" type="submit" style="margin-top:8px">ë¬´ë£Œ ì‹œì‘í•˜ê¸°</button></form>')+'<div style="text-align:center;margin-top:16px;font-size:11px;color:var(--w20)">ê°€ì… ì¦‰ì‹œ AI ìˆ˜ì¶œ ë¶„ì„ 1íšŒ ë¬´ë£Œ</div></div></div>';
}

function pgDash(){
  var u=S.user,ac=S.analyses.length,pc=S.products.length;
  var ap=S.projects.filter(function(p){return p.status!=='completed'&&p.status!=='paused';}).length;
  var ps=S.serviceRequests.filter(function(s){return s.status==='pending'||s.status==='processing';}).length;
  var oc=S.orders.filter(function(o){return o.status!=='completed'&&o.status!=='cancelled';}).length;
  var bc=S.buyers.length;
  var ec=S.emailLogs.length;
  var ga=_planGate('analysis'),gp=_planGate('product'),gj=_planGate('project');
  var cur=u.plan||'free';
  /* 7ì¼ ì´ë‚´ í™œë™ ìˆ˜ */
  var w7=Date.now()-7*86400000;
  var weekEmails=S.emailLogs.filter(function(e){return new Date(e.created_at).getTime()>w7;}).length;
  var weekOrders=S.orders.filter(function(o){return new Date(o.created_at).getTime()>w7;}).length;
  /* ìˆ˜ì¶œ ì—¬ì • ì§„í–‰ë¥  */
  var journeyPct=0,journeyStage='ì‹œì‘ ì „';
  if(S.projects.length>0){
    var jp=S.projects[0];
    var jStages=['planning','certification','buyer_search','negotiation','production','shipping','completed'];
    var jLabels=['ê³„íšìˆ˜ë¦½','ì¸ì¦/ê·œì œ','ë°”ì´ì–´ ë°œêµ´','í˜‘ìƒ','ìƒì‚°','ì„ ì ','ì™„ë£Œ'];
    var jIdx=jStages.indexOf(jp.status);
    journeyPct=jIdx>=0?Math.round((jIdx/(jStages.length-1))*100):0;
    journeyStage=jLabels[jIdx>=0?jIdx:0];
  }
  /* quota */
  var quotaHtml='<div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">';
  if(ga.max&&ga.max!==-1)quotaHtml+='<span style="font-size:11px;padding:4px 10px;border-radius:6px;background:var(--w08);color:'+(ga.blocked?'var(--err)':'var(--w60)')+'">ë¶„ì„ '+(ga.used||0)+'/'+ga.max+'</span>';
  if(gp.max&&gp.max!==-1)quotaHtml+='<span style="font-size:11px;padding:4px 10px;border-radius:6px;background:var(--w08);color:'+(gp.blocked?'var(--err)':'var(--w60)')+'">ì œí’ˆ '+(gp.used||0)+'/'+gp.max+'</span>';
  if(gj.max&&gj.max!==-1)quotaHtml+='<span style="font-size:11px;padding:4px 10px;border-radius:6px;background:var(--w08);color:'+(gj.blocked?'var(--err)':'var(--w60)')+'">í”„ë¡œì íŠ¸ '+(gj.used||0)+'/'+gj.max+'</span>';
  quotaHtml+='</div>';
  /* hero */
  var h='<div class="dash-hero"><div class="dash-welcome">ì•ˆë…•í•˜ì„¸ìš”, '+(u.company_name||u.display_name||'ì‚¬ì¥ë‹˜')+' ğŸ‘‹</div><div class="dash-company" style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">'+(S.company?S.company.name_ko:'íšŒì‚¬ ì •ë³´ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”')+' '+UI.pb(cur)+'</div>'+quotaHtml;
  h+='<div class="quick-grid"><div class="quick-card" onclick="App.nav(\'analysis\')"><div class="quick-icon">ğŸ”¬</div><div class="quick-label">AI ë¶„ì„</div></div><div class="quick-card" onclick="App.nav(\'products\')"><div class="quick-icon">ğŸ“¦</div><div class="quick-label">ì œí’ˆ ë“±ë¡</div></div><div class="quick-card" onclick="App.nav(\'buyers\')"><div class="quick-icon">ğŸ¤</div><div class="quick-label">ë°”ì´ì–´ ì°¾ê¸°</div></div><div class="quick-card" onclick="App.nav(\'orders\')"><div class="quick-icon">ğŸ“‹</div><div class="quick-label">ì£¼ë¬¸ ê´€ë¦¬</div></div></div></div>';
  /* ì£¼ìš” ì§€í‘œ 8ì¹¸ */
  h+='<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px">';
  h+=UI.stat('AI ë¶„ì„',ac,ac?'ìµœê·¼: '+U.fd(S.analyses[0]&&S.analyses[0].created_at,'rel'):'ì‹œì‘í•˜ì„¸ìš”','var(--pri)');
  h+=UI.stat('ë“±ë¡ ì œí’ˆ',pc,pc?'í™œì„± ì¹´ë“œ':'ë“±ë¡í•˜ì„¸ìš”','var(--acc)');
  h+=UI.stat('ë°”ì´ì–´',bc,bc?bc+'ê°œì‚¬ ê´€ë¦¬ ì¤‘':'ë°œêµ´í•˜ì„¸ìš”','#3b82f6');
  h+=UI.stat('ì§„í–‰ ì£¼ë¬¸',oc,oc?'ì²˜ë¦¬ ì¤‘':'ì—†ìŒ','var(--ok)');
  h+='</div>';
  h+='<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px">';
  h+=UI.stat('í”„ë¡œì íŠ¸',ap,ap?'ìˆ˜ì¶œ ì§„í–‰':'ì—†ìŒ','var(--purple)');
  h+=UI.stat('ì´ë©”ì¼',ec,'ì´ë²ˆ ì£¼ '+weekEmails+'ê±´','#f59e0b');
  h+=UI.stat('ì„œë¹„ìŠ¤',ps,ps?'ëŒ€ê¸°ì¤‘':'ì™„ë£Œ','#ec4899');
  h+=UI.stat('ì£¼ê°„ ì£¼ë¬¸',weekOrders,weekOrders?weekOrders+'ê±´ ì‹ ê·œ':'ì´ë²ˆ ì£¼ ì—†ìŒ','#10b981');
  h+='</div>';
  /* íšŒì‚¬ ì •ë³´ ë¯¸ì…ë ¥ ê²½ê³  */
  if(!S.company)h+='<div class="card" style="border-color:rgba(255,184,0,.25);margin-bottom:16px"><div class="card-b" style="display:flex;align-items:center;gap:14px"><span style="font-size:28px">âš ï¸</span><div style="flex:1"><div style="font-weight:700">ì…€ëŸ¬ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</div><div style="font-size:12px;color:var(--w40)">PI/CI ì„œë¥˜ ìë™ ìƒì„±ì— í•„ìš”</div></div><button class="btn btn-acc btn-sm" onclick="App.nav(\'settings\')">ì„¤ì • â†’</button></div></div>';
  /* ìˆ˜ì¶œ ì—¬ì • ì‹œê°í™” */
  if(S.projects.length>0){
    var jp=S.projects[0];
    var jStages=['planning','certification','buyer_search','negotiation','production','shipping','completed'];
    var jLabels=['ğŸ“‹ ê³„íš','ğŸ“œ ì¸ì¦','ğŸ¤ ë°”ì´ì–´','ğŸ’¬ í˜‘ìƒ','ğŸ­ ìƒì‚°','ğŸš¢ ì„ ì ','âœ… ì™„ë£Œ'];
    var jIdx=jStages.indexOf(jp.status);if(jIdx<0)jIdx=0;
    h+='<div class="card" style="margin-bottom:16px;border-color:rgba(0,212,255,.15)"><div class="card-h"><span>ğŸ—ºï¸ ìˆ˜ì¶œ ì—¬ì • â€” '+U.tr(jp.name,30)+'</span><span class="badge badge-pri" style="font-size:12px">'+journeyPct+'%</span></div><div class="card-b">';
    h+='<div style="display:flex;align-items:center;gap:0;margin-bottom:12px">';
    jLabels.forEach(function(lb,i){
      var done=i<jIdx,cur2=i===jIdx,future=i>jIdx;
      var bg=done?'var(--ok)':cur2?'var(--pri)':'var(--w08)';
      var col=done?'var(--bg)':cur2?'var(--bg)':'var(--w40)';
      var fw=cur2?'700':'400';
      var bdr=cur2?'0 0 0 3px rgba(0,212,255,.2)':'none';
      h+='<div style="flex:1;text-align:center"><div style="width:28px;height:28px;border-radius:14px;background:'+bg+';color:'+col+';display:inline-flex;align-items:center;justify-content:center;font-size:12px;font-weight:800;box-shadow:'+bdr+'">'+(done?'âœ“':(i+1))+'</div><div style="font-size:10px;margin-top:4px;font-weight:'+fw+';color:'+(cur2?'var(--pri)':done?'var(--ok)':'var(--w40)')+'">'+lb+'</div></div>';
      if(i<jLabels.length-1)h+='<div style="flex:0.5;height:2px;background:'+(i<jIdx?'var(--ok)':'var(--w08)')+';margin-top:-10px"></div>';
    });
    h+='</div>';
    /* ë‹¤ìŒ ë‹¨ê³„ ì•ˆë‚´ */
    var nextTips={planning:'ì œí’ˆ ë¶„ì„ê³¼ íƒ€ê²Ÿ ì‹œì¥ì„ ì„ ì •í•˜ì„¸ìš”',certification:'í•„ìš” ì¸ì¦(FDA ë“±)ì„ í™•ì¸í•˜ê³  ì‹ ì²­í•˜ì„¸ìš”',buyer_search:'AI ë°”ì´ì–´ ë°œêµ´ë¡œ ì ì¬ ê³ ê°ì„ ì°¾ìœ¼ì„¸ìš”',negotiation:'ìƒ˜í”Œ ë°œì†¡ í›„ ê°€ê²©/ì¡°ê±´ì„ í˜‘ìƒí•˜ì„¸ìš”',production:'ì£¼ë¬¸ í™•ì • í›„ ìƒì‚°ì„ ì‹œì‘í•˜ì„¸ìš”',shipping:'ì„ ì  ì„œë¥˜ë¥¼ ì¤€ë¹„í•˜ê³  í¬ì›Œë”ì— ì˜ë¢°í•˜ì„¸ìš”',completed:'ì¶•í•˜í•©ë‹ˆë‹¤! ìˆ˜ì¶œì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤ ğŸ‰'};
    h+='<div style="padding:10px 14px;border-radius:8px;background:var(--w08);display:flex;align-items:center;gap:10px"><span style="font-size:16px">'+(jp.status==='completed'?'ğŸ‰':'ğŸ’¡')+'</span><div><div style="font-size:12px;font-weight:600;color:var(--pri)">í˜„ì¬: '+journeyStage+'</div><div style="font-size:11px;color:var(--w40)">'+nextTips[jp.status]+'</div></div><button class="btn btn-ghost btn-sm" onclick="App.viewPj(\''+jp.id+'\')" style="margin-left:auto;font-size:11px">ìƒì„¸ â†’</button></div>';
    h+='</div></div>';
  }
  /* í™œë™ íƒ€ì„ë¼ì¸ + ìµœê·¼ ë¶„ì„/ì„œë¹„ìŠ¤ */
  h+='<div class="grid-2" style="margin-bottom:16px">';
  /* í™œë™ íƒ€ì„ë¼ì¸ */
  h+='<div class="card"><div class="card-h">ğŸ• ìµœê·¼ í™œë™</div><div class="card-b" style="max-height:300px;overflow-y:auto">';
  var timeline=[];
  S.analyses.slice(0,3).forEach(function(a){timeline.push({t:a.created_at,icon:'ğŸ”¬',text:'AI ë¶„ì„: '+U.tr(a.product_name,25),pg:'analysis'});});
  S.emailLogs.slice(0,3).forEach(function(e){timeline.push({t:e.created_at,icon:'âœ‰ï¸',text:'ì´ë©”ì¼: '+(e.subject||'').substring(0,25),pg:'emailhub'});});
  S.orders.slice(0,3).forEach(function(o){timeline.push({t:o.created_at,icon:'ğŸ“‹',text:'ì£¼ë¬¸: '+o.order_number,pg:'orders'});});
  S.notifications.filter(function(n){return n.type==='buyer'||n.type==='cert';}).slice(0,3).forEach(function(n){timeline.push({t:n.created_at,icon:n.type==='buyer'?'ğŸ¤':'ğŸ“œ',text:n.title,pg:n.link_page||'dashboard'});});
  timeline.sort(function(a,b){return new Date(b.t)-new Date(a.t);});
  if(timeline.length===0){h+=UI.empty('ğŸ•','í™œë™ ì—†ìŒ','ë¶„ì„, ì´ë©”ì¼, ì£¼ë¬¸ ë“± í™œë™ì´ ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤');}
  else{timeline.slice(0,8).forEach(function(ev){
    h+='<div style="display:flex;gap:10px;padding:7px 0;border-bottom:1px solid var(--w08);cursor:pointer" onclick="App.nav(\''+ev.pg+'\')">';
    h+='<span style="font-size:16px">'+ev.icon+'</span><div style="flex:1"><div style="font-size:12px;color:var(--w90)">'+ev.text+'</div><div style="font-size:10px;color:var(--w20)">'+_timeAgo(ev.t)+'</div></div></div>';
  });}
  h+='</div></div>';
  /* ìµœê·¼ ë¶„ì„ */
  h+='<div class="card"><div class="card-h">ìµœê·¼ AI ë¶„ì„</div><div class="card-b">';
  if(S.analyses.length===0){h+=UI.empty('ğŸ”¬','ë¶„ì„ ì—†ìŒ','ì²« ë¶„ì„ì„ ì‹œì‘í•˜ì„¸ìš”');}
  else{S.analyses.slice(0,5).forEach(function(a){
    h+='<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--w08);cursor:pointer" onclick="App.viewA(\''+a.id+'\')"><span style="font-size:20px">ğŸ“Š</span><div style="flex:1"><div style="font-size:13px;font-weight:600">'+U.tr(a.product_name,30)+'</div><div style="font-size:11px;color:var(--w40)">'+U.fd(a.created_at,'rel')+'</div></div>'+UI.sb(a.status)+'</div>';
  });}
  h+='</div></div></div>';
  /* ì£¼ë¬¸ í˜„í™© + ì„œë¹„ìŠ¤ */
  /* ë¯¸íŒ… ì¼ì • ìœ„ì ¯ */
  h+='<div class="grid-2">';
  /* ë¯¸íŒ… */
  h+='<div class="card"><div class="card-h"><span>ğŸ“… ë‹¤ê°€ì˜¤ëŠ” ë¯¸íŒ…</span><button class="btn btn-ghost btn-sm" onclick="App.nav(\'meetings\')" style="font-size:11px">ì „ì²´ë³´ê¸°</button></div><div class="card-b">';
  var now=new Date();var upMeetings=S.meetings.filter(function(m){return new Date(m.scheduled_at)>=now&&m.status!=='cancelled';}).sort(function(a,b){return new Date(a.scheduled_at)-new Date(b.scheduled_at);}).slice(0,4);
  if(upMeetings.length===0){h+=UI.empty('ğŸ“…','ì˜ˆì •ëœ ë¯¸íŒ… ì—†ìŒ','ë°”ì´ì–´ì™€ ë¯¸íŒ…ì„ ì¡ì•„ë³´ì„¸ìš”');}
  else{upMeetings.forEach(function(m){
    var mt=new Date(m.scheduled_at);var buyer=S.buyers.find(function(b){return b.id===m.buyer_id;});
    var isToday=mt.toDateString()===now.toDateString();
    var dtStr=isToday?'ì˜¤ëŠ˜ '+mt.toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'}):U.fd(m.scheduled_at,'short');
    var typeIcon={video_call:'ğŸ“¹',phone:'ğŸ“',in_person:'ğŸ¤',trade_show:'ğŸ¢',online_demo:'ğŸ’»'}[m.type]||'ğŸ“…';
    h+='<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--w08);cursor:pointer" onclick="App.viewMeeting(\''+m.id+'\')"><span style="font-size:16px">'+typeIcon+'</span><div style="flex:1"><div style="font-size:13px;font-weight:600">'+U.tr(m.title,25)+'</div><div style="font-size:11px;color:var(--w40)">'+(buyer?buyer.company_name:'â€”')+' Â· '+dtStr+'</div></div>'+(isToday?'<span class="badge badge-acc" style="font-size:10px">ì˜¤ëŠ˜</span>':'')+'</div>';
  });}
  h+='</div></div></div>';
  /* ì£¼ë¬¸+ì„œë¹„ìŠ¤ í–‰ */
  h+='<div class="grid-2">';
  h+='<div class="card"><div class="card-h">ğŸ“‹ ì£¼ë¬¸ í˜„í™©</div><div class="card-b">';
  var activeOrders2=S.orders.filter(function(o){return o.status!=='completed'&&o.status!=='cancelled';});
  if(activeOrders2.length===0){h+=UI.empty('ğŸ“‹','ì§„í–‰ ì¤‘ì¸ ì£¼ë¬¸ ì—†ìŒ','');}
  else{var stLabel2={confirmed:'í™•ì •',production:'ìƒì‚°',inspection:'ê²€ìˆ˜',shipping:'ì„ ì ',delivered:'ë°°ì†¡'};
    activeOrders2.slice(0,4).forEach(function(o){
      var stCol2={confirmed:'var(--pri)',production:'var(--acc)',shipping:'#3b82f6',delivered:'var(--ok)'}[o.status]||'var(--w40)';
      h+='<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--w08);cursor:pointer" onclick="App.viewOrder(\''+o.id+'\')"><div style="width:8px;height:8px;border-radius:4px;background:'+stCol2+'"></div><div style="flex:1"><div style="font-size:13px;font-weight:600">'+o.order_number+'</div><div style="font-size:11px;color:var(--w40)">$'+(o.total_amount||0).toLocaleString()+' Â· '+(stLabel2[o.status]||o.status)+'</div></div></div>';
    });}
  h+='</div></div>';
  h+='<div class="card"><div class="card-h">ğŸ’¼ ì„œë¹„ìŠ¤ í˜„í™©</div><div class="card-b">';
  if(S.serviceRequests.length===0){h+=UI.empty('ğŸ’¼','ì„œë¹„ìŠ¤ ì—†ìŒ','');}
  else{S.serviceRequests.slice(0,5).forEach(function(sr){
    h+='<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--w08)"><span style="font-size:18px">'+U.si(sr.service_type)+'</span><div style="flex:1"><div style="font-size:13px;font-weight:600">'+U.sl(sr.service_type)+'</div><div style="font-size:11px;color:var(--w40)">'+U.fd(sr.created_at,'rel')+'</div></div>'+UI.sb(sr.status)+'</div>';
  });}
  h+='</div></div></div>';
  return h;
}

/* â”€â”€ Analysis: page router â”€â”€ */
function pgAnalysis(){
  if(S.currentAnalysis)return pgAReport();
  if(S.analysisStep)return pgAForm();
  return pgAList();
}

/* â”€â”€ Analysis: list view â”€â”€ */
function pgAList(){
  return '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px"><div><h2 style="font-size:18px;font-weight:800">ğŸ”¬ AI ìˆ˜ì¶œ ìƒí’ˆ ë¶„ì„</h2><p style="font-size:13px;color:var(--w40);margin-top:4px">ì œí’ˆ ì •ë³´ë¥¼ ì…ë ¥í•˜ë©´ AIê°€ ìˆ˜ì¶œ ì í•©ë„ë¥¼ ì‹¬ì¸µ ë¶„ì„í•©ë‹ˆë‹¤</p></div><button class="btn btn-pri" onclick="App.startAForm()">+ ìƒˆ ë¶„ì„ ì‹œì‘</button></div>'+
  (S.analyses.length===0?'<div class="card"><div class="card-b">'+UI.empty('ğŸ”¬','ì•„ì§ ë¶„ì„ì´ ì—†ìŠµë‹ˆë‹¤','ì œí’ˆ ì •ë³´, URL, íŒŒì¼ì„ ì…ë ¥í•˜ë©´ AIê°€ ì‹¬ì¸µ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤')+'<div style="text-align:center;margin-top:16px"><button class="btn btn-pri btn-lg" onclick="App.startAForm()">ğŸ”¬ ì²« ë¶„ì„ ì‹œì‘í•˜ê¸°</button></div></div></div>'
  :'<div style="display:flex;flex-direction:column;gap:12px">'+S.analyses.map(function(a){
    var r=a.ai_result||{};var sc=r.overall_score;var col=sc>=80?'var(--ok)':sc>=60?'var(--acc)':'var(--err)';
    return '<div class="card" style="cursor:pointer" onclick="App.viewA(\''+a.id+'\')"><div class="card-b" style="display:flex;align-items:center;gap:16px">'+
      '<div style="width:56px;height:56px;border-radius:12px;background:'+(sc?col+'15':'var(--w08)')+';display:flex;align-items:center;justify-content:center;flex-shrink:0"><span style="font-size:'+(sc?'22px':'28px')+';font-weight:900;color:'+(sc?col:'var(--w20)')+'">'+( sc||'?')+'</span></div>'+
      '<div style="flex:1;min-width:0"><div style="display:flex;align-items:center;gap:8px;margin-bottom:2px"><span style="font-size:14px;font-weight:700">'+a.product_name+'</span>'+UI.badge(a.analysis_type==='premium'?'â­ í”„ë¦¬ë¯¸ì—„':'ë¬´ë£Œ',a.analysis_type==='premium'?'acc':'ghost')+UI.sb(a.status)+'</div>'+
      '<div style="font-size:12px;color:var(--w40)">'+(r.summary?U.tr(r.summary,80):'ë¶„ì„ ëŒ€ê¸° ì¤‘...')+'</div>'+
      '<div style="display:flex;gap:8px;margin-top:6px">'+(r.recommended_markets?(r.recommended_markets||[]).map(function(m){return '<span style="font-size:10px;padding:2px 6px;border-radius:4px;background:var(--w08);color:var(--w60)">'+U.cl(m)+'</span>';}).join(''):'')+'</div></div>'+
      '<div style="text-align:right;flex-shrink:0"><div style="font-size:11px;color:var(--w20)">'+U.fd(a.created_at,'rel')+'</div>'+(r.estimated_fob?'<div style="font-size:12px;color:var(--acc);font-weight:600;margin-top:2px">'+r.estimated_fob+'</div>':'')+'<button class="btn btn-danger btn-sm" onclick="event.stopPropagation();App.delA(\''+a.id+'\')" style="margin-top:6px;font-size:10px;padding:3px 8px">ì‚­ì œ</button></div></div></div>';
  }).join('')+'</div>');
}

/* â”€â”€ Analysis: multi-step input form â”€â”€ */
function startAForm(){S.analysisStep=1;S.analysisData={urls:[''],files:[],selling_points:[],target_markets:['US'],existing_certs:[],price_krw:''};render();}

function pgAForm(){
  var step=S.analysisStep;var d=S.analysisData;
  var steps=['í•„ìˆ˜ ì •ë³´','ì¶”ê°€ ì •ë³´ (ì„ íƒ)'];
  var bar='<div style="display:flex;gap:4px;margin-bottom:24px">'+steps.map(function(s,i){var n=i+1;return '<div style="flex:1"><div style="height:4px;border-radius:2px;background:'+(n<step?'var(--ok)':n===step?'var(--pri)':'var(--w08)')+';margin-bottom:6px"></div><div style="font-size:10px;color:'+(n===step?'var(--pri)':'var(--w40)')+';font-weight:'+(n===step?'700':'400')+'">'+n+'. '+s+'</div></div>';}).join('')+'</div>';
  var hdr='<div style="display:flex;align-items:center;gap:12px;margin-bottom:20px"><button class="btn btn-ghost btn-sm" onclick="App.cancelA()">â† ì·¨ì†Œ</button><h2 style="font-size:18px;font-weight:800">ìƒˆ ë¶„ì„</h2></div>';
  var body='';

  if(step===1){
    var usdShow=d.price_krw?'â‰ˆ $'+(Number(d.price_krw)/(S.exchangeRate||1400)).toFixed(2)+' USD':'';
    body='<div class="card" style="margin-bottom:14px"><div class="card-h">ğŸ“¦ ì œí’ˆ ì •ë³´</div><div class="card-b"><form id="af1">'+
      UI.inp('product_name','ì œí’ˆëª… *',{placeholder:'ì˜ˆ: ë‹¥í„°ì§€ ë ˆë“œ ë¸”ë ˆë¯¸ì‰¬ ìˆ˜ë”©í¬ë¦¼',value:d.product_name||'',required:true})+
      '<div class="grid-2">'+
        UI.sel('category','ì¹´í…Œê³ ë¦¬',['','K-Beauty','K-Food','K-Health','K-Fashion','K-Electronics','K-Living','Other'],d.category||'')+
        UI.sel('analysis_type','ë¶„ì„ ìœ í˜•',[{value:'free',label:'ğŸ†“ ë¬´ë£Œ ê¸°ë³¸ ë¶„ì„'},{value:'premium',label:'â­ í”„ë¦¬ë¯¸ì—„ (â‚©300~500K)'}],d.analysis_type||'free')+
      '</div>'+
      '<div class="form-group"><label class="form-label">ë‹¨ê°€ (ì›í™” ì…ë ¥ â†’ ìë™ ë‹¬ëŸ¬ í™˜ì‚°)</label><div style="display:flex;gap:10px;align-items:center"><div style="flex:1;position:relative"><span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--w40);font-size:13px">â‚©</span><input class="form-input" name="price_krw" type="number" value="'+(d.price_krw||'')+'" placeholder="5,000" style="padding-left:28px" oninput="App.updateUSD(this.value)"></div><div style="font-size:14px;color:var(--pri);font-weight:700;font-family:JetBrains Mono;min-width:120px;text-align:right" id="usdCalc">'+usdShow+'</div></div><div style="font-size:10px;color:var(--w20);margin-top:4px">ê¸°ì¤€ í™˜ìœ¨: â‚©'+(S.exchangeRate||1400).toLocaleString()+'/USD</div></div>'+
    '</form></div></div>'+
    '<div class="card" style="margin-bottom:14px"><div class="card-h">ğŸ”— ìƒí’ˆ URL Â· ğŸ“ íŒŒì¼</div><div class="card-b">'+
      '<div style="font-size:12px;color:var(--w40);margin-bottom:10px">ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´, ì¿ íŒ¡, ì•Œë¦¬ë°”ë°” ë“± URL ë˜ëŠ” íšŒì‚¬ì†Œê°œì„œ/ì¹´íƒˆë¡œê·¸ë¥¼ ì²¨ë¶€í•˜ë©´ AIê°€ ì •ë³´ë¥¼ ìë™ ìˆ˜ì§‘í•©ë‹ˆë‹¤</div>'+
      d.urls.map(function(u,i){return '<div style="display:flex;gap:8px;margin-bottom:8px"><input class="form-input aurl" value="'+(u||'')+'" placeholder="https://smartstore.naver.com/..." style="flex:1">'+(d.urls.length>1?'<button class="btn btn-danger btn-sm" onclick="App.rmUrl('+i+')">âœ•</button>':'')+'</div>';}).join('')+
      '<button class="btn btn-ghost btn-sm" onclick="App.addUrl()" style="margin-bottom:14px">+ URL ì¶”ê°€</button>'+
      '<div style="border:2px dashed var(--bd-l);border-radius:12px;padding:20px;text-align:center;cursor:pointer;transition:all .15s" onclick="document.getElementById(\'fileUp\').click()" onmouseover="this.style.borderColor=\'var(--pri)\'" onmouseout="this.style.borderColor=\'var(--bd-l)\'">'+
        '<div style="font-size:24px;margin-bottom:4px">ğŸ“„</div>'+
        '<div style="font-size:12px;color:var(--w40)">í´ë¦­í•˜ì—¬ íŒŒì¼ ì²¨ë¶€ (PDF, ì´ë¯¸ì§€, Excel, CSV, í…ìŠ¤íŠ¸, HWP)</div>'+
        '<input type="file" id="fileUp" multiple accept=".pdf,.jpg,.jpeg,.png,.gif,.webp,.xlsx,.xls,.csv,.txt,.hwp,.doc,.docx" style="display:none" onchange="App.addFiles(this.files)">'+
      '</div>'+
      (d.files.length?'<div style="margin-top:10px">'+d.files.map(function(f,i){var icons={pdf:'ğŸ“•',jpg:'ğŸ–¼ï¸',jpeg:'ğŸ–¼ï¸',png:'ğŸ–¼ï¸',gif:'ğŸ–¼ï¸',webp:'ğŸ–¼ï¸',xlsx:'ğŸ“Š',xls:'ğŸ“Š',csv:'ğŸ“Š',txt:'ğŸ“„',docx:'ğŸ“',doc:'ğŸ“',hwp:'ğŸ“„'};var ext=(f.name||'').split('.').pop().toLowerCase();return '<div style="display:flex;align-items:center;gap:10px;padding:6px 10px;border-radius:8px;background:var(--w08);margin-bottom:4px"><span>'+(icons[ext]||'ğŸ“')+'</span><span style="flex:1;font-size:12px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+f.name+'</span><span style="font-size:11px;color:var(--w20)">'+(f.size/1024).toFixed(0)+'KB</span><button class="btn btn-danger btn-sm" onclick="App.rmFile('+i+')" style="padding:2px 6px">âœ•</button></div>';}).join('')+'</div>':'')+
    '</div></div>'+
    '<div style="display:flex;justify-content:space-between;margin-top:20px"><div></div><div style="display:flex;gap:8px"><button class="btn btn-ghost" onclick="App.aStep(2)">ì¶”ê°€ ì •ë³´ ì…ë ¥ â†’</button><button class="btn btn-pri btn-lg" onclick="App.submitA()">ğŸ”¬ ë°”ë¡œ ë¶„ì„ ì‹œì‘</button></div></div>';
  }else{
    var mkts=[{v:'US',l:'ğŸ‡ºğŸ‡¸ ë¯¸êµ­'},{v:'JP',l:'ğŸ‡¯ğŸ‡µ ì¼ë³¸'},{v:'CN',l:'ğŸ‡¨ğŸ‡³ ì¤‘êµ­'},{v:'EU',l:'ğŸ‡ªğŸ‡º ìœ ëŸ½'},{v:'SEA',l:'ğŸŒ ë™ë‚¨ì•„'},{v:'ME',l:'ğŸ•Œ ì¤‘ë™'},{v:'LATAM',l:'ğŸŒ ë‚¨ë¯¸'},{v:'AU',l:'ğŸ‡¦ğŸ‡º í˜¸ì£¼'}];
    var certs=['FDA','CE','CPNP','NMPA','Halal','Kosher','ISO 22716','GMP','KFDA','JAS','Ecocert','USDA Organic'];
    body='<div class="card" style="margin-bottom:14px"><div class="card-h">ğŸŒ íƒ€ê²Ÿ ì‹œì¥ <span style="font-size:11px;color:var(--w20);font-weight:400">(ì„ íƒ)</span></div><div class="card-b">'+
      '<div style="display:flex;flex-wrap:wrap;gap:8px">'+mkts.map(function(m){var sel=d.target_markets&&d.target_markets.indexOf(m.v)>=0;return '<div onclick="App.toggleMkt(\''+m.v+'\')" style="padding:8px 14px;border-radius:10px;border:1.5px solid '+(sel?'var(--pri)':'var(--bd)')+';background:'+(sel?'rgba(0,212,255,.08)':'transparent')+';cursor:pointer;font-size:13px;font-weight:'+(sel?'600':'400')+';color:'+(sel?'var(--pri)':'var(--w60)')+';transition:all .15s">'+m.l+'</div>';}).join('')+'</div></div></div>'+
    '<div class="card" style="margin-bottom:14px"><div class="card-h">ğŸ… ë³´ìœ  ì¸ì¦ <span style="font-size:11px;color:var(--w20);font-weight:400">(ì„ íƒ)</span></div><div class="card-b">'+
      '<div style="display:flex;flex-wrap:wrap;gap:6px">'+certs.map(function(c){var sel=d.existing_certs&&d.existing_certs.indexOf(c)>=0;return '<div onclick="App.toggleCert(\''+c+'\')" style="padding:5px 12px;border-radius:8px;border:1.5px solid '+(sel?'var(--ok)':'var(--bd)')+';background:'+(sel?'rgba(0,230,118,.08)':'transparent')+';cursor:pointer;font-size:12px;font-weight:'+(sel?'600':'400')+';color:'+(sel?'var(--ok)':'var(--w60)')+';transition:all .15s">'+c+'</div>';}).join('')+'</div></div></div>'+
    '<div class="card" style="margin-bottom:14px"><div class="card-h">ğŸ’¡ ì…€ë§ í¬ì¸íŠ¸ <span style="font-size:11px;color:var(--w20);font-weight:400">(ì„ íƒ)</span></div><div class="card-b">'+
      (d.selling_points.length?d.selling_points.map(function(s,i){return '<div style="display:flex;gap:8px;margin-bottom:8px"><input class="form-input asp" value="'+(s||'')+'" placeholder="ì˜ˆ: í”¼ë¶€ê³¼ ì „ë¬¸ì˜ í…ŒìŠ¤íŠ¸ ì™„ë£Œ" style="flex:1"><button class="btn btn-danger btn-sm" onclick="App.rmSP('+i+')">âœ•</button></div>';}).join(''):'')+
      '<button class="btn btn-ghost btn-sm" onclick="App.addSP()">+ ì…€ë§ í¬ì¸íŠ¸ ì¶”ê°€</button>'+
    '</div></div>'+
    '<div class="card" style="margin-bottom:14px"><div class="card-h">ğŸ“‹ ê¸°íƒ€ <span style="font-size:11px;color:var(--w20);font-weight:400">(ì„ íƒ)</span></div><div class="card-b">'+
      '<div class="grid-2">'+
        UI.inp('product_name_en','ì˜ë¬¸ëª…',{placeholder:'Dr.G Red Blemish Cream',value:d.product_name_en||''})+
        UI.inp('brand_name','ë¸Œëœë“œ',{placeholder:'Dr.G',value:d.brand_name||''})+
      '</div>'+
      UI.ta('special_requirements','ìš”ì²­ì‚¬í•­',{placeholder:'ì˜ˆ: ì•„ë§ˆì¡´ FBA ì…ì  í¬ë§',value:d.special_requirements||'',rows:2})+
    '</div></div>'+
    '<div style="display:flex;justify-content:space-between;margin-top:20px"><button class="btn btn-ghost" onclick="App.aStep(1)">â† ì´ì „</button><button class="btn btn-pri btn-lg" onclick="App.submitA()">ğŸ”¬ ë¶„ì„ ì‹œì‘</button></div>';
  }
  return hdr+bar+body;
}

function updateUSD(v){var el=document.getElementById('usdCalc');if(el)el.textContent=v?'â‰ˆ $'+(Number(v)/(S.exchangeRate||1400)).toFixed(2)+' USD':'';S.analysisData.price_krw=v;}

function aStep(n){
  var d=S.analysisData;
  if(S.analysisStep===1){
    var f=document.querySelector('#af1');if(f){var fd=UI.fd(f);Object.assign(d,fd);}
    d.urls=Array.from(document.querySelectorAll('.aurl')).map(function(e){return e.value;});
    if(n>1&&!d.product_name){UI.toast('ì œí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”','warn');return;}
    if(d.price_krw)d.fob_price=(Number(d.price_krw)/(S.exchangeRate||1400)).toFixed(2);
  }
  if(S.analysisStep===2){
    d.selling_points=Array.from(document.querySelectorAll('.asp')).map(function(e){return e.value;});
    var els=document.querySelectorAll('.card-b input[name],.card-b textarea[name]');els.forEach(function(el){if(el.name)d[el.name]=el.value;});
  }
  S.analysisStep=n;render();
}
function cancelA(){S.analysisStep=0;S.analysisData=null;render();}
function addUrl(){S.analysisData.urls.push('');render();}
function rmUrl(i){S.analysisData.urls.splice(i,1);render();}
function addSP(){S.analysisData.selling_points.push('');render();}
function rmSP(i){S.analysisData.selling_points.splice(i,1);render();}
function addFiles(fl){
  for(var i=0;i<fl.length;i++){
    var f=fl[i];
    if(f.size>10485760){UI.toast('íŒŒì¼ í¬ê¸° ì´ˆê³¼ (ìµœëŒ€ 10MB): '+f.name,'err');continue;}
    // base64 ë³€í™˜í•˜ì—¬ ì €ì¥
    (function(file){
      var reader=new FileReader();
      reader.onload=function(e){
        S.analysisData.files.push({name:file.name,size:file.size,type:file.type,data:e.target.result});
        render();
      };
      reader.readAsDataURL(file);
    })(f);
  }
}
function rmFile(i){S.analysisData.files.splice(i,1);render();}
function toggleMkt(m){var d=S.analysisData;if(!d.target_markets)d.target_markets=[];var i=d.target_markets.indexOf(m);if(i>=0)d.target_markets.splice(i,1);else d.target_markets.push(m);render();}
function toggleCert(c){var d=S.analysisData;if(!d.existing_certs)d.existing_certs=[];var i=d.existing_certs.indexOf(c);if(i>=0)d.existing_certs.splice(i,1);else d.existing_certs.push(c);render();}

/* â”€â”€ Analysis: submit â”€â”€ */
function submitA(){
  if(S._submitting){return;}S._submitting=true;
  /* Plan limit check */
  var g=_planGate('analysis');
  if(g.blocked){S._submitting=false;UI.toast(g.label+' í•œë„ ì´ˆê³¼! ì—…ê·¸ë ˆì´ë“œê°€ í•„ìš”í•©ë‹ˆë‹¤.','warn');nav('subscription');return;}
  var d=S.analysisData;
  /* collect current step data */
  if(S.analysisStep===1){
    var f=document.querySelector('#af1');if(f){var fd=UI.fd(f);Object.assign(d,fd);}
    d.urls=Array.from(document.querySelectorAll('.aurl')).map(function(e){return e.value;});
    if(d.price_krw)d.fob_price=(Number(d.price_krw)/(S.exchangeRate||1400)).toFixed(2);
  }
  if(S.analysisStep===2){
    d.selling_points=Array.from(document.querySelectorAll('.asp')).map(function(e){return e.value;});
    var els=document.querySelectorAll('.card-b input[name],.card-b textarea[name]');els.forEach(function(el){if(el.name)d[el.name]=el.value;});
  }
  if(!d||!d.product_name){S._submitting=false;UI.toast('ì œí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”','warn');return;}
  var urls=d.urls.filter(function(u){return u;});
  urls=urls.filter(function(u){try{new URL(u);return true;}catch(e){return false;}});
  var sp=d.selling_points.filter(function(s){return s;});
  sb.from('analyses').insert({user_id:S.user.id,product_name:d.product_name,product_url:urls[0]||null,analysis_type:d.analysis_type||'free',status:'analyzing',ai_result:{input_data:{product_name_en:d.product_name_en,category:d.category,fob_price:d.fob_price,moq:d.moq,description:d.description,urls:urls,files:(d.files||[]).map(function(f){return f.name||'file';}),selling_points:sp,target_markets:d.target_markets,existing_certs:d.existing_certs,brand_name:d.brand_name,manufacturer:d.manufacturer,export_experience:d.export_experience,annual_capacity:d.annual_capacity,special_requirements:d.special_requirements}}}).select().single().then(function(r){
    if(r.error){S._submitting=false;UI.toast('ì‹¤íŒ¨: '+r.error.message,'err');return;}
    S.analyses.unshift(r.data);S.analysisStep=0;S.analysisData=null;
    set({currentAnalysis:r.data});UI.toast('AIê°€ ì‹¤ì œ ìˆ˜ì¶œ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... (30ì´ˆ~1ë¶„ ì†Œìš”)','info');
    /* AI ë¶„ì„ API í˜¸ì¶œ */
    /* íŒŒì¼ base64 ë°ì´í„° ì¤€ë¹„ */
    var fileData=(d.files||[]).map(function(f){return f.data||f;}).filter(function(f){return typeof f==='string'&&f.startsWith('data:');});
    fetch(RELAY_URL+'/api/whistle/analyze',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({product_name:d.product_name,product_name_en:d.product_name_en,category:d.category,fob_price:d.fob_price,moq:d.moq,description:d.description,urls:(d.urls||[]).filter(function(u){return u;}),files:fileData,selling_points:(d.selling_points||[]).filter(function(s){return s;}),target_markets:d.target_markets,existing_certs:d.existing_certs,brand_name:d.brand_name,manufacturer:d.manufacturer,export_experience:d.export_experience,annual_capacity:d.annual_capacity,special_requirements:d.special_requirements})}).then(function(resp){return resp.json();}).then(function(data){
      if(!data.ok)throw new Error(data.error||'ë¶„ì„ ì‹¤íŒ¨');
      var res=data.result;
      res.input_data={product_name_en:d.product_name_en,category:d.category,fob_price:d.fob_price,moq:d.moq,description:d.description,urls:(d.urls||[]).filter(function(u){return u;}),files:(d.files||[]).map(function(f){return f.name||f;}),selling_points:(d.selling_points||[]).filter(function(s){return s;}),target_markets:d.target_markets,existing_certs:d.existing_certs,brand_name:d.brand_name,manufacturer:d.manufacturer};
      sb.from('analyses').update({status:'completed',ai_result:res}).eq('id',r.data.id).then(function(){
        S._submitting=false;
        autoCreateProduct(r.data.id,res,d.product_name);
        loadA().then(function(){var ua=S.analyses.find(function(x){return x.id===r.data.id;});set({currentAnalysis:ua||Object.assign({},r.data,{status:'completed',ai_result:res})});UI.toast('AI ë¶„ì„ ì™„ë£Œ!','ok');});
        pushNotif('analysis','AI ë¶„ì„ ì™„ë£Œ: '+d.product_name,(res.export_score||'')+'ì  â€” ìƒì„¸ ë¦¬í¬íŠ¸ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤','analysis',null,true);
      });
    }).catch(function(err){
      S._submitting=false;
      console.warn('AI API ì‹¤íŒ¨, í´ë°± ëª¨ë“œ:',err);UI.toast('AI ì„œë²„ ì—°ê²° ì‹¤íŒ¨, ê¸°ë³¸ ë¶„ì„ ì‚¬ìš©','warn');
      var res=genReport(d);
      sb.from('analyses').update({status:'completed',ai_result:res}).eq('id',r.data.id).then(function(){
        autoCreateProduct(r.data.id,res,d.product_name);
        loadA().then(function(){var ua=S.analyses.find(function(x){return x.id===r.data.id;});set({currentAnalysis:ua||Object.assign({},r.data,{status:'completed',ai_result:res})});UI.toast('ë¶„ì„ ì™„ë£Œ (ê¸°ë³¸ ëª¨ë“œ)','ok');});
      });
    });
  });
}

/* â”€â”€ Auto-create product from analysis â”€â”€ */
function autoCreateProduct(analysisId,res,productName){
  var inp=res.input_data||{};
  var prod={user_id:S.user.id,analysis_id:analysisId,name_ko:productName||inp.product_name_en||'',name_en:inp.product_name_en||'',category:inp.category||null,hs_code:res.hs_code||null,fob_price:inp.fob_price||null,moq:inp.moq||null,certifications:res.existing_certs||[],status:'draft'};
  sb.from('products').insert(prod).select().single().then(function(r2){
    if(r2.error){console.warn('ìë™ ì œí’ˆë“±ë¡ ì‹¤íŒ¨:',r2.error.message);return;}
    loadP().then(function(){UI.toast('ì œí’ˆ ìë™ ë“±ë¡: '+prod.name_ko,'ok');});
  });
}

/* â”€â”€ AI ì˜ë¬¸ ì¹´íƒˆë¡œê·¸ ìƒì„± â”€â”€ */
function genCatalogEN(productId){
  var p=S.products.find(function(x){return x.id===productId;});if(!p){UI.toast('ì œí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤','err');return;}
  UI.toast('AI ì˜ë¬¸ ì¹´íƒˆë¡œê·¸ ìƒì„± ì¤‘...','info');
  fetch(RELAY_URL+'/api/whistle/catalog-en',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name_ko:p.name_ko,name_en:p.name_en,category:p.category,fob_price:p.fob_price,moq:p.moq,description_ko:p.description_ko,certifications:p.certifications,specifications:p.specifications})}).then(function(r){return r.json();}).then(function(data){
    if(!data.ok)throw new Error(data.error||'ìƒì„± ì‹¤íŒ¨');
    var res=data.result;
    sb.from('products').update({description_en:res.description_en,specifications:Object.assign(p.specifications||{},{ai_catalog:res})}).eq('id',productId).then(function(r2){
      if(r2.error){UI.toast('ì €ì¥ ì‹¤íŒ¨','err');return;}
      loadP().then(function(){UI.toast('ì˜ë¬¸ ì¹´íƒˆë¡œê·¸ ìƒì„± ì™„ë£Œ!','ok');closeModal('pm');render();});
    });
  }).catch(function(err){UI.toast('ì¹´íƒˆë¡œê·¸ ìƒì„± ì‹¤íŒ¨: '+err.message,'err');});
}

/* â”€â”€ Analysis: fallback report generator (AI ì„œë²„ ë¯¸ì—°ê²° ì‹œ ì‚¬ìš©) â”€â”€ */
function genReport(d){
  var cat=d.category||'K-Beauty';var price=d.fob_price||5;var mkts=d.target_markets||['US','JP','SEA'];
  var sc={overall:70+Math.floor(Math.random()*25),market_fit:72+Math.floor(Math.random()*23),competition:55+Math.floor(Math.random()*30),regulatory:60+Math.floor(Math.random()*30),price_comp:65+Math.floor(Math.random()*28),brand_power:50+Math.floor(Math.random()*35),logistics:68+Math.floor(Math.random()*25)};
  var catData={
    'K-Beauty':{hs:'3304.99',certs:['FDA (OTC/Cosmetic)','CPNP (EU)','NMPA (ì¤‘êµ­)'],trend:'ê¸€ë¡œë²Œ K-ë·°í‹° ì‹œì¥ $12.5B ê·œëª¨, ì—° 9.4% ì„±ì¥. ì‹œì¹´/ìŠ¤ë„¤ì¼ ì„±ë¶„ íŠ¸ë Œë“œ ì§€ì†.',channels:['ì•„ë§ˆì¡´ FBA','Qoo10 Japan','Shopee SEA','TikTok Shop']},
    'K-Food':{hs:'1902.30',certs:['FDA (ì‹í’ˆ)','Halal','JAS (ì¼ë³¸)'],trend:'K-Food ìˆ˜ì¶œ $10B ëŒíŒŒ. ë¼ë©´/ì†ŒìŠ¤ë¥˜ SNS ë°”ì´ëŸ´ íš¨ê³¼ ê·¹ëŒ€.',channels:['ì½”ìŠ¤íŠ¸ì½”','H-Mart','ì•„ë§ˆì¡´ Pantry','ì´ì˜¨ëª°']},
    'K-Health':{hs:'2106.90',certs:['FDA (Dietary Supplement)','Health Canada','TGA (í˜¸ì£¼)'],trend:'ê¸€ë¡œë²Œ ê±´ê¸°ì‹ ì‹œì¥ $180B. í™ì‚¼/í”„ë¡œë°”ì´ì˜¤í‹±ìŠ¤ í•œêµ­ ì›ë£Œ ì‹ ë¢°ë„ ìƒìŠ¹.',channels:['iHerb','ì•„ë§ˆì¡´','ë“œëŸ­ìŠ¤í† ì–´ ì²´ì¸','ê±´ê°•ì‹í’ˆ ì „ë¬¸ì ']},
    'K-Fashion':{hs:'6204.33',certs:['CE (ì„¬ìœ )','OEKO-TEX'],trend:'K-íŒ¨ì…˜ í•œë¥˜ íš¨ê³¼. ìŠ¤íŠ¸ë¦¬íŠ¸ì›¨ì–´/ë·°í‹°íŒ¨ì…˜ ìœµí•© íŠ¸ë Œë“œ.',channels:['ASOS','Farfetch','ìì‚¬ëª° D2C','íŒì—…ìŠ¤í† ì–´']},
    'K-Electronics':{hs:'8471.30',certs:['FCC','CE','KC'],trend:'ì†Œí˜• ê°€ì „ ë° IoT ë””ë°”ì´ìŠ¤ ìˆ˜ì¶œ ì„±ì¥. í˜ì‹  ë””ìì¸ í‰ê°€.',channels:['ì•„ë§ˆì¡´','ë² ìŠ¤íŠ¸ë°”ì´','ì•Œë¦¬ìµìŠ¤í”„ë ˆìŠ¤','í‚¥ìŠ¤íƒ€í„°']},
    'K-Living':{hs:'3924.90',certs:['FDA (ì‹ê¸°ë¥˜)','CE'],trend:'ë¯¸ë‹ˆë©€ ë””ìì¸ í•œêµ­ ë¦¬ë¹™ ì œí’ˆ ì¸ê¸°. ì¹œí™˜ê²½ ì†Œì¬ í”„ë¦¬ë¯¸ì—„.',channels:['ì•„ë§ˆì¡´','ì´ì¼€ì•„ ë§ˆì¼“í”Œë ˆì´ìŠ¤','Wayfair','í¬ë ˆì´íŠ¸ì•¤ë°°ëŸ´']}
  };
  var cd=catData[cat]||catData['K-Beauty'];
  var mktAnalysis=mkts.map(function(m){
    var data={US:{name:'ë¯¸êµ­',size:'$580B',grow:'+4.2%',entry:'ì¤‘ê°„',note:'FDA ë“±ë¡ í•„ìˆ˜. ì•„ë§ˆì¡´ FBA ìµœì . í•œì¸ë§ˆíŠ¸ ì±„ë„ë„ ìœ íš¨.'},JP:{name:'ì¼ë³¸',size:'$330B',grow:'+2.1%',entry:'ë†’ìŒ',note:'í’ˆì§ˆ ê¸°ì¤€ ê¹Œë‹¤ë¡œì›€. Qoo10/ë¼ì¿ í… ì±„ë„. PMDA í†µë³´ í•„ìš”.'},CN:{name:'ì¤‘êµ­',size:'$820B',grow:'+6.8%',entry:'ë§¤ìš° ë†’ìŒ',note:'NMPA ë“±ë¡ í•„ìˆ˜. ë™ë¬¼ì‹¤í—˜ ì´ìŠˆ. ë”°ì´ê³µ/ì™•í™ ë§ˆì¼€íŒ… ì¤‘ìš”.'},EU:{name:'ìœ ëŸ½',size:'$450B',grow:'+3.5%',entry:'ë†’ìŒ',note:'CPNP ë“±ë¡. ì„±ë¶„ ê·œì œ ì—„ê²©. ë…ì¼/í”„ë‘ìŠ¤ê°€ ìµœëŒ€ ì‹œì¥.'},SEA:{name:'ë™ë‚¨ì•„',size:'$120B',grow:'+8.5%',entry:'ë‚®ìŒ',note:'Shopee/Lazada ì¤‘ì‹¬. í• ë„ ì¸ì¦ ì‹œ ì‹œì¥ 2ë°°. ê°€ê²© ë¯¼ê°.'},ME:{name:'ì¤‘ë™',size:'$45B',grow:'+7.2%',entry:'ì¤‘ê°„',note:'í• ë„ ì¸ì¦ í•„ìˆ˜. ë‘ë°”ì´ í—ˆë¸Œ í™œìš©. í”„ë¦¬ë¯¸ì—„ ì„ í˜¸.'},AU:{name:'í˜¸ì£¼',size:'$28B',grow:'+3.8%',entry:'ì¤‘ê°„',note:'TGA ë“±ë¡. í´ë¦°ë·°í‹° íŠ¸ë Œë“œ. í•œì¸ ì»¤ë®¤ë‹ˆí‹° í…ŒìŠ¤íŠ¸ ì‹œì¥.'},LATAM:{name:'ë‚¨ë¯¸',size:'$65B',grow:'+5.5%',entry:'ì¤‘ê°„',note:'ë¸Œë¼ì§ˆ/ë©•ì‹œì½” ì¤‘ì‹¬. ANVISA ë“±ë¡. í•œë¥˜ ì˜í–¥ë ¥ ì„±ì¥ ì¤‘.'}};
    return data[m]||{name:m,size:'â€”',grow:'â€”',entry:'â€”',note:'â€”'};
  });
  var existCerts=(d.existing_certs||[]);var needCerts=cd.certs.filter(function(c){var base=c.split(' ')[0];return existCerts.indexOf(base)<0&&existCerts.indexOf(c)<0;});
  return {
    overall_score:sc.overall,market_fit:sc.market_fit,competition:sc.competition,regulatory:sc.regulatory,price_competitiveness:sc.price_comp,brand_power:sc.brand_power,logistics_score:sc.logistics,
    estimated_fob:price?'$'+price.toFixed(1)+'~$'+(price*1.4).toFixed(1):'$3.0~$8.0',hs_code:cd.hs,
    required_certs:needCerts,existing_certs:existCerts,
    recommended_markets:mkts,market_analysis:mktAnalysis,
    industry_trend:cd.trend,recommended_channels:cd.channels,
    summary:d.product_name+'ì˜ ìˆ˜ì¶œ ì í•©ë„ ì¢…í•© ì ìˆ˜ '+sc.overall+'ì . '+(sc.overall>=80?'ë§¤ìš° ìœ ë§í•œ ìˆ˜ì¶œ ìƒí’ˆì…ë‹ˆë‹¤. ':sc.overall>=65?'ìˆ˜ì¶œ ê°€ëŠ¥ì„±ì´ ë†’ìœ¼ë‚˜ ì¼ë¶€ ë³´ì™„ì´ í•„ìš”í•©ë‹ˆë‹¤. ':'ìˆ˜ì¶œ ì „ ì¶”ê°€ ì¤€ë¹„ê°€ í•„ìš”í•©ë‹ˆë‹¤. ')+cd.trend,
    executive_summary:(d.product_name||'ë³¸ ì œí’ˆ')+'ì€(ëŠ”) '+cat+' ì¹´í…Œê³ ë¦¬ì—ì„œ '+(sc.market_fit>=80?'ë†’ì€ ì‹œì¥ ì í•©ë„':'ë³´í†µ ìˆ˜ì¤€ì˜ ì‹œì¥ ì í•©ë„')+'ë¥¼ ë³´ì´ë©°, '+(mkts.length?mkts.slice(0,2).map(function(m){return U.cl(m);}).join(', '):'ë¯¸êµ­')+'ì„ 1ì°¨ íƒ€ê²Ÿ ì‹œì¥ìœ¼ë¡œ ì¶”ì²œí•©ë‹ˆë‹¤. '+(price?'FOB $'+price+' ê¸°ì¤€ ':'')+(sc.price_comp>=75?'ê°€ê²© ê²½ìŸë ¥ì´ ìš°ìˆ˜í•˜ë©°, ':'ê°€ê²© ì¡°ì •ì´ í•„ìš”í•  ìˆ˜ ìˆìœ¼ë©°, ')+(needCerts.length?needCerts.length+'ê°œ ì¶”ê°€ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.':'ì¸ì¦ ì¤€ë¹„ê°€ ì–‘í˜¸í•©ë‹ˆë‹¤.')+' '+(d.selling_points&&d.selling_points.filter(function(s){return s;}).length?'ì£¼ìš” ì…€ë§í¬ì¸íŠ¸('+d.selling_points.filter(function(s){return s;}).slice(0,2).join(', ')+')ë¥¼ í™œìš©í•œ ë§ˆì¼€íŒ… ì „ëµì´ ìœ íš¨í•©ë‹ˆë‹¤.':''),
    opportunities:[(sc.market_fit>=75?cat+' ê¸€ë¡œë²Œ ìˆ˜ìš” ì¦ê°€ íŠ¸ë Œë“œ':'ê¸€ë¡œë²Œ ì‹œì¥ ì§„ì¶œ ê¸°íšŒ'),(d.selling_points&&d.selling_points[0]?d.selling_points[0]+' ì°¨ë³„í™” í¬ì¸íŠ¸ í™œìš©':'ë…ìì  ì œí’ˆë ¥ í™œìš© ê°€ëŠ¥'),'K-ì½˜í…ì¸  í•œë¥˜ ì‹œë„ˆì§€ ë§ˆì¼€íŒ…',cd.channels[0]+' ì±„ë„ ì…ì  ê¸°íšŒ',(existCerts.length?'ê¸° ë³´ìœ  ì¸ì¦('+existCerts.join(',')+') í™œìš© ê°€ëŠ¥':'ì¸ì¦ ì·¨ë“ ì‹œ ì‹œì¥ í™•ëŒ€ ê°€ëŠ¥')],
    risks:[needCerts.length?needCerts[0]+' ë“± '+needCerts.length+'ê°œ ì¸ì¦ ë¯¸ë³´ìœ ':'ì¸ì¦ ìœ ì§€ ê´€ë¦¬ í•„ìš”',(sc.competition<70?'ê²½ìŸ ì œí’ˆ ëŒ€ë¹„ ì°¨ë³„í™” í•„ìš”':'ê²½ìŸ ì‹¬í™” ì¶”ì„¸ ëª¨ë‹ˆí„°ë§'),'í™˜ìœ¨ ë³€ë™ ë¦¬ìŠ¤í¬ (ì›/ë‹¬ëŸ¬)','í•´ì™¸ ìœ í†µ ì±„ë„ í™•ë³´ ë‚œì´ë„',(sc.regulatory<70?'ê·œì œ ëŒ€ì‘ ì¤€ë¹„ í•„ìš”':'ìˆ˜ì¶œêµ­ë³„ ê·œì œ ë³€í™” ëª¨ë‹ˆí„°ë§')],
    action_plan:[{phase:'1ë‹¨ê³„ (1~2ê°œì›”)',title:'ì¤€ë¹„',items:['ìˆ˜ì¶œ ì¸ì¦ ì¤€ë¹„: '+(needCerts.slice(0,2).join(', ')||'ê¸°ì¡´ ì¸ì¦ ì ê²€'),'ì˜ë¬¸ ì œí’ˆì¹´ë“œ/ì¹´íƒˆë¡œê·¸ ì œì‘','FOB ê°€ê²© í™•ì • ë° ê²¬ì ì„œ ì¤€ë¹„']},{phase:'2ë‹¨ê³„ (2~4ê°œì›”)',title:'ì¸ì¦ & ë°”ì´ì–´ ë°œêµ´',items:[(needCerts[0]||'ì¶”ê°€ ì¸ì¦')+' ë“±ë¡ ì§„í–‰','ë°”ì´ì–´ ë¦¬ìŠ¤íŠ¸ í™•ë³´ ë° ì»¨íƒ','ìƒ˜í”Œ ì¤€ë¹„ ë° ë°œì†¡']},{phase:'3ë‹¨ê³„ (4~6ê°œì›”)',title:'ìˆ˜ì¶œ ê°œì‹œ',items:['ì²« ì˜¤ë” í˜‘ìƒ ë° ê³„ì•½','PI/CI/PL ì„œë¥˜ ì‘ì„±','ë¬¼ë¥˜/í†µê´€ ì§„í–‰ ë° ì„ ì ']}],
    input_data:{product_name_en:d.product_name_en,category:cat,fob_price:d.fob_price,moq:d.moq,description:d.description,urls:(d.urls||[]).filter(function(u){return u;}),files:(d.files||[]).map(function(f){return f.name;}),selling_points:(d.selling_points||[]).filter(function(s){return s;}),target_markets:mkts,existing_certs:existCerts,brand_name:d.brand_name,manufacturer:d.manufacturer}
  };
}

/* â”€â”€ Analysis: report view â”€â”€ */
function pgAReport(){
  var a=S.currentAnalysis,r=a.ai_result||{};
  if(a.status==='analyzing')return '<div style="text-align:center;padding:60px"><div class="spinner" style="width:48px;height:48px;border-width:4px;margin:0 auto 20px"></div><div style="font-size:18px;font-weight:700">AIê°€ ì‹¬ì¸µ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</div><div style="font-size:13px;color:var(--w40);margin-top:8px">'+a.product_name+'</div><div style="font-size:12px;color:var(--w20);margin-top:16px">URL í¬ë¡¤ë§ â†’ íŒŒì¼ ë¶„ì„ â†’ ì‹œì¥ ë°ì´í„° ìˆ˜ì§‘ â†’ ë¦¬í¬íŠ¸ ìƒì„±</div><div style="display:flex;justify-content:center;gap:6px;margin-top:20px"><div style="width:8px;height:8px;border-radius:50%;background:var(--pri);animation:spin .8s linear infinite"></div><div style="width:8px;height:8px;border-radius:50%;background:var(--acc);animation:spin .8s linear infinite .2s"></div><div style="width:8px;height:8px;border-radius:50%;background:var(--ok);animation:spin .8s linear infinite .4s"></div></div></div>';
  var sc=function(s){return s>=80?'var(--ok)':s>=60?'var(--acc)':'var(--err)';};
  var bar=function(label,val,max){max=max||100;var pct=Math.min(val/max*100,100);var col=sc(val);return '<div style="margin-bottom:10px"><div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="font-size:12px;color:var(--w60)">'+label+'</span><span style="font-size:12px;font-weight:700;color:'+col+'">'+val+'/'+max+'</span></div><div style="height:6px;border-radius:3px;background:var(--w08)"><div style="height:100%;border-radius:3px;background:'+col+';width:'+pct+'%;transition:width .5s ease"></div></div></div>';};
  var hdr='<div style="display:flex;align-items:center;gap:12px;margin-bottom:20px"><button class="btn btn-ghost btn-sm" onclick="App.set({currentAnalysis:null})">â† ëª©ë¡</button><h2 style="font-size:18px;font-weight:800;flex:1">'+a.product_name+'</h2>'+UI.badge(a.analysis_type==='premium'?'â­ í”„ë¦¬ë¯¸ì—„':'ğŸ†“ ë¬´ë£Œ',a.analysis_type==='premium'?'acc':'ghost')+'<span style="font-size:12px;color:var(--w20)">'+U.fd(a.created_at)+'</span></div>';
  var scoreCard='<div style="display:flex;gap:16px;margin-bottom:16px"><div style="width:140px;height:140px;border-radius:50%;border:6px solid '+sc(r.overall_score)+';display:flex;flex-direction:column;align-items:center;justify-content:center;flex-shrink:0"><div style="font-size:36px;font-weight:900;color:'+sc(r.overall_score)+'">'+( r.overall_score||'â€”')+'</div><div style="font-size:10px;color:var(--w40)">ì¢…í•© ì ìˆ˜</div></div><div style="flex:1">'+bar('ì‹œì¥ ì í•©ë„',r.market_fit||0)+bar('ê°€ê²© ê²½ìŸë ¥',r.price_competitiveness||0)+bar('ë¸Œëœë“œ íŒŒì›Œ',r.brand_power||0)+bar('ê²½ìŸ í™˜ê²½',r.competition||0)+bar('ê·œì œ ëŒ€ì‘',r.regulatory||0)+bar('ë¬¼ë¥˜ ì í•©ì„±',r.logistics_score||0)+'</div></div>';
  var execSummary='<div class="card" style="margin-bottom:14px;border-color:rgba(0,212,255,.15)"><div class="card-b"><div style="font-size:15px;font-weight:700;margin-bottom:10px">ğŸ“‹ Executive Summary</div><p style="font-size:13px;color:var(--w70);line-height:1.9">'+(r.executive_summary||r.summary||'â€”')+'</p></div></div>';
  var pdSection='';if(r.product_detail){var pd=r.product_detail;pdSection='<div class="card" style="margin-bottom:14px;border-color:rgba(168,85,247,.15)"><div class="card-h">ğŸ” í¬ë¡¤ë§ ê¸°ë°˜ ì œí’ˆ ìƒì„¸</div><div class="card-b"><div style="display:grid;grid-template-columns:auto 1fr;gap:8px 16px;font-size:13px;line-height:2">'+(pd.actual_name?'<span style="color:var(--w40);font-weight:600">í™•ì¸ëœ ì œí’ˆëª…</span><span style="color:var(--w90)">'+pd.actual_name+'</span>':'')+(pd.ingredients_or_specs?'<span style="color:var(--w40);font-weight:600">ì„±ë¶„/ê·œê²©</span><span style="color:var(--w90)">'+pd.ingredients_or_specs+'</span>':'')+(pd.retail_price?'<span style="color:var(--w40);font-weight:600">íŒë§¤ê°€</span><span style="color:var(--pri);font-weight:700">'+pd.retail_price+'</span>':'')+(pd.target_consumer?'<span style="color:var(--w40);font-weight:600">íƒ€ê²Ÿ ì†Œë¹„ì</span><span style="color:var(--w90)">'+pd.target_consumer+'</span>':'')+'</div>'+(pd.unique_features?'<div style="margin-top:12px"><div style="font-size:12px;color:var(--w40);margin-bottom:6px;font-weight:600">ì°¨ë³„í™” í¬ì¸íŠ¸</div><p style="font-size:13px;color:var(--w70);line-height:1.8">'+pd.unique_features+'</p></div>':'')+'</div></div>';}
  var compSection='';if(r.competitor_analysis){compSection='<div class="card" style="margin-bottom:14px"><div class="card-h">âš”ï¸ ê²½ìŸ ë¶„ì„</div><div class="card-b"><p style="font-size:13px;color:var(--w70);line-height:1.8">'+r.competitor_analysis+'</p></div></div>';}
  var priceStrategy='';if(r.pricing_strategy){priceStrategy='<div class="card" style="margin-bottom:14px"><div class="card-h">ğŸ’¡ ê°€ê²© ì „ëµ</div><div class="card-b"><p style="font-size:13px;color:var(--w70);line-height:1.8">'+r.pricing_strategy+'</p></div></div>';}
  var mktSection='';if(r.market_analysis&&r.market_analysis.length){mktSection='<div class="card" style="margin-bottom:14px"><div class="card-h">ğŸŒ ì‹œì¥ë³„ ë¶„ì„</div><div class="card-b" style="padding:0"><table class="tbl"><thead><tr><th>ì‹œì¥</th><th>ê·œëª¨</th><th>ì„±ì¥ë¥ </th><th>ì§„ì…ì¥ë²½</th><th>ë¶„ì„</th></tr></thead><tbody>'+r.market_analysis.map(function(m){var ecol=m.entry==='ë‚®ìŒ'?'var(--ok)':m.entry==='ì¤‘ê°„'?'var(--acc)':'var(--err)';return '<tr><td style="font-weight:700">'+m.name+'</td><td style="font-family:JetBrains Mono;font-size:12px">'+m.size+'</td><td style="color:var(--ok)">'+m.grow+'</td><td><span style="color:'+ecol+'">'+m.entry+'</span></td><td style="font-size:12px;color:var(--w60)">'+m.note+'</td></tr>';}).join('')+'</tbody></table></div></div>';}
  var certSection='<div class="card" style="margin-bottom:14px"><div class="card-h">ğŸ… ì¸ì¦ í˜„í™©</div><div class="card-b">'+((r.existing_certs||[]).length?'<div style="margin-bottom:12px"><div style="font-size:12px;color:var(--w40);margin-bottom:6px">ë³´ìœ  ì¸ì¦</div><div style="display:flex;flex-wrap:wrap;gap:6px">'+(r.existing_certs||[]).map(function(c){return '<span class="badge badge-ok">âœ“ '+c+'</span>';}).join('')+'</div></div>':'')+((r.required_certs||[]).length?'<div><div style="font-size:12px;color:var(--w40);margin-bottom:6px">ì¶”ê°€ í•„ìš” ì¸ì¦</div><div style="display:flex;flex-wrap:wrap;gap:6px">'+(r.required_certs||[]).map(function(c){return '<span class="badge badge-err">âš  '+c+'</span>';}).join('')+'</div></div>':'<div style="color:var(--ok);font-size:13px">âœ“ ì¸ì¦ ì¤€ë¹„ ì–‘í˜¸</div>')+'</div></div>';
  var trendSection='<div class="card" style="margin-bottom:14px"><div class="card-h">ğŸ“ˆ ì‚°ì—… íŠ¸ë Œë“œ</div><div class="card-b"><p style="font-size:13px;color:var(--w70);line-height:1.8">'+(r.industry_trend||'â€”')+'</p>'+((r.recommended_channels||[]).length?'<div style="margin-top:12px"><div style="font-size:12px;color:var(--w40);margin-bottom:6px">ì¶”ì²œ ìœ í†µ ì±„ë„</div><div style="display:flex;flex-wrap:wrap;gap:6px">'+r.recommended_channels.map(function(c){return '<span class="badge badge-pri">'+c+'</span>';}).join('')+'</div></div>':'')+'</div></div>';
  var oppRisk='<div class="grid-2" style="margin-bottom:14px"><div class="card"><div class="card-b"><div style="font-weight:700;color:var(--ok);margin-bottom:10px">âœ… ê¸°íšŒ ìš”ì¸</div>'+(r.opportunities||[]).map(function(o,i){return '<div style="display:flex;gap:8px;padding:6px 0;border-bottom:1px solid var(--w08)"><span style="color:var(--ok);font-weight:700;font-size:12px">'+(i+1)+'</span><span style="font-size:13px;color:var(--w70)">'+o+'</span></div>';}).join('')+'</div></div><div class="card"><div class="card-b"><div style="font-weight:700;color:var(--err);margin-bottom:10px">âš ï¸ ë¦¬ìŠ¤í¬ ìš”ì¸</div>'+(r.risks||[]).map(function(o,i){return '<div style="display:flex;gap:8px;padding:6px 0;border-bottom:1px solid var(--w08)"><span style="color:var(--err);font-weight:700;font-size:12px">'+(i+1)+'</span><span style="font-size:13px;color:var(--w70)">'+o+'</span></div>';}).join('')+'</div></div></div>';
  var actionPlan='';if(r.action_plan&&r.action_plan.length){actionPlan='<div class="card" style="margin-bottom:14px"><div class="card-h">ğŸ—ºï¸ ìˆ˜ì¶œ ì‹¤í–‰ ë¡œë“œë§µ</div><div class="card-b"><div style="display:flex;flex-wrap:wrap;gap:12px">'+r.action_plan.map(function(p,i){var cols=['var(--pri)','var(--acc)','var(--ok)'];return '<div style="flex:1;padding:14px;border-radius:12px;border:1.5px solid '+cols[i]+'25;background:'+cols[i]+'08"><div style="font-size:11px;color:'+cols[i]+';font-weight:700;margin-bottom:2px">'+p.phase+'</div><div style="font-size:14px;font-weight:700;margin-bottom:8px">'+p.title+'</div>'+p.items.map(function(item){return '<div style="font-size:12px;color:var(--w60);padding:3px 0;display:flex;gap:6px"><span style="color:'+cols[i]+'">â†’</span>'+item+'</div>';}).join('')+'</div>';}).join('')+'</div></div></div>';}
  var priceInfo='<div class="card" style="margin-bottom:14px"><div class="card-h">ğŸ’° ê°€ê²© & ë¬¼ë¥˜</div><div class="card-b"><div class="grid-3">'+UI.stat('ì˜ˆìƒ FOB',r.estimated_fob||'â€”','','')+UI.stat('HS Code',r.hs_code||'â€”','','')+UI.stat('ì¸ì¦ í•„ìš”',(r.required_certs||[]).length+'ê°œ','','')+'</div></div></div>';
  var linkedProd=S.products.filter(function(p){return p.analysis_id===a.id;});
  var prodCard='';if(linkedProd.length){prodCard='<div class="card" style="margin-bottom:14px;border-color:rgba(0,230,118,.15)"><div class="card-h"><span>ğŸ“¦ ìë™ ë“±ë¡ëœ ì œí’ˆ</span>'+UI.badge(linkedProd.length+'ê±´','ok')+'</div><div class="card-b"><div class="grid-3">'+linkedProd.map(function(p){return '<div style="padding:14px;border-radius:10px;border:1px solid var(--bd);background:var(--w08);cursor:pointer" onclick="App.editP(\''+p.id+'\')"><div style="font-size:13px;font-weight:700">'+U.tr(p.name_ko,20)+'</div><div style="font-size:11px;color:var(--w40);margin-top:4px">'+(p.category||'')+' Â· FOB '+(p.fob_price?U.fmtUSD(p.fob_price):'â€”')+'</div><div style="margin-top:6px">'+UI.sb(p.status)+'</div>'+(p.description_en?'<div style="font-size:10px;color:var(--ok);margin-top:4px">EN</div>':'<button class="btn btn-acc btn-sm" style="margin-top:6px" onclick="event.stopPropagation();App.genCatalogEN(\''+p.id+'\')">AI ì˜ë¬¸ ìƒì„±</button>')+'</div>';}).join('')+'</div></div></div>';}
  var nc=(r.required_certs||[]);var actions='<div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--bd)"><div style="font-size:14px;font-weight:700;margin-bottom:12px">âš¡ ë‹¤ìŒ ë‹¨ê³„</div><div style="display:flex;flex-wrap:wrap;gap:8px"><button class="btn btn-pri" onclick="App.createPj(\''+a.id+'\')">ğŸš€ í”„ë¡œì íŠ¸ ìƒì„±</button>'+(nc.length?'<button class="btn btn-acc" onclick="App.reqSvc(\'certification\',\''+a.id+'\')">ğŸ… ì¸ì¦ ('+nc.length+'ê±´)</button>':'')+'<button class="btn btn-ghost" onclick="App.reqSvc(\'matching\',\''+a.id+'\')">ğŸ¤ ë§¤ì¹­</button><button class="btn btn-ghost" onclick="App.reqSvc(\'premium_analysis\',\''+a.id+'\')">ğŸ”¬ í”„ë¦¬ë¯¸ì—„</button><button class="btn btn-ghost" onclick="window.print()">ğŸ–¨ï¸ ì¶œë ¥</button></div></div>';
  return hdr+scoreCard+execSummary+pdSection+priceInfo+compSection+priceStrategy+mktSection+certSection+trendSection+oppRisk+actionPlan+prodCard+actions;
}

function viewA(id){var a=S.analyses.find(function(x){return x.id===id;});if(a)set({currentAnalysis:a,page:'analysis'});}

var STAGE_DEFAULTS={
  planning:[{text:'ìˆ˜ì¶œ ëŒ€ìƒ ì œí’ˆ í™•ì •',done:false},{text:'íƒ€ê²Ÿ ì‹œì¥ ì„ ì •',done:false},{text:'FOB ê°€ê²© í™•ì •',done:false},{text:'ìˆ˜ì¶œ ì¼ì • ìˆ˜ë¦½',done:false}],
  certification:[{text:'í•„ìš” ì¸ì¦ ëª©ë¡ í™•ì¸',done:false},{text:'ì¸ì¦ ê¸°ê´€ ì„ ì •',done:false},{text:'ì„œë¥˜ ì¤€ë¹„ ë° ì œì¶œ',done:false},{text:'ì¸ì¦ ì·¨ë“ ì™„ë£Œ',done:false}],
  buyer_search:[{text:'ë°”ì´ì–´ ë¦¬ìŠ¤íŠ¸ í™•ë³´',done:false},{text:'ì½œë“œ ì´ë©”ì¼ ë°œì†¡',done:false},{text:'ìƒ˜í”Œ ìš”ì²­ ëŒ€ì‘',done:false},{text:'ë°”ì´ì–´ ë¯¸íŒ… ì§„í–‰',done:false}],
  negotiation:[{text:'ê°€ê²© í˜‘ìƒ',done:false},{text:'ê²°ì œ ì¡°ê±´ í˜‘ì˜',done:false},{text:'ê³„ì•½ì„œ ê²€í† ',done:false},{text:'PI ë°œí–‰',done:false}],
  production:[{text:'ìƒì‚° ì¼ì • í™•ì •',done:false},{text:'ìƒì‚° ì‹œì‘',done:false},{text:'ì¤‘ê°„ ê²€ìˆ˜ (QC)',done:false},{text:'í¬ì¥ ë° ë¼ë²¨ë§',done:false},{text:'ìµœì¢… ê²€ìˆ˜ ë° ì¶œí•˜ ì¤€ë¹„',done:false}],
  shipping:[{text:'CI/PL ì‘ì„±',done:false},{text:'í†µê´€ ì„œë¥˜ ì¤€ë¹„',done:false},{text:'í¬ì›Œë” ì„ ì •',done:false},{text:'ì„ ì  ì™„ë£Œ',done:false},{text:'B/L ìˆ˜ë ¹',done:false}],
  completed:[{text:'ëŒ€ê¸ˆ ìˆ˜ë ¹ í™•ì¸',done:false},{text:'ì‚¬í›„ ê´€ë¦¬ ê³„íš',done:false},{text:'ì¬ì£¼ë¬¸ í˜‘ì˜',done:false}]
};

/* â”€â”€ Category Ã— Market ìˆ˜ì¶œ ë¡œë“œë§µ â”€â”€ */
var CATEGORY_ROADMAPS={
  'K-Food':{
    US:{
      certs:['FDA ì‹œì„¤ë“±ë¡(FFR)','FDA ì˜ì–‘ì„±ë¶„ ë¼ë²¨ë§','HACCP ì¸ì¦','ì˜ì–‘ì„±ë¶„ ë¶„ì„','FSVP ë¯¸êµ­ ëŒ€ë¦¬ì¸'],
      planning:{items:['ìˆ˜ì¶œ ëŒ€ìƒ ì‹í’ˆ í™•ì •','FDA ê·œì • ì‚¬ì „ ê²€í† ','FOB ê°€ê²© í™•ì • (ê´€ì„¸ í¬í•¨)','íƒ€ê²Ÿ ìœ í†µì±„ë„ ì„ ì • (ì•„ë§ˆì¡´/í•œì¸ë§ˆíŠ¸/ë©”ì¸ìŠ¤íŠ¸ë¦¼)','ìˆ˜ì¶œ ì¼ì • ìˆ˜ë¦½'],tip:'ë¯¸êµ­ ì‹í’ˆì€ FDA ì‹œì„¤ë“±ë¡ì´ í•„ìˆ˜. ë¼ë²¨ë§ Nutrition Facts ì–‘ì‹ í™•ì¸ ë¨¼ì €!',time:'2-4ì£¼',cost:'$200-500'},
      certification:{items:['FDA ì‹œì„¤ë“±ë¡(FFR) ì‹ ì²­','FDA Nutrition Facts ë¼ë²¨ ì œì‘','HACCP ì¸ì¦ ì¤€ë¹„/ì·¨ë“','ì˜ì–‘ì„±ë¶„ ë¶„ì„ ì˜ë¢° (ê³µì¸ê¸°ê´€)','FSVP ë¯¸êµ­ í˜„ì§€ ëŒ€ë¦¬ì¸ ì„ ì •','ìˆ˜ì…ì‹í’ˆì•ˆì „ê²€ì‚¬ ëŒ€ë¹„'],tip:'FDA ì‹œì„¤ë“±ë¡ 2ì£¼, ë¼ë²¨ë§ì€ ì˜ì–‘ì„±ë¶„ ë¶„ì„ ì™„ë£Œ í›„. FSVP ëŒ€ë¦¬ì¸ì€ ë¯¸êµ­ í˜„ì§€ í•„ìˆ˜!',time:'4-8ì£¼',cost:'$1,500-3,000'},
      buyer_search:{items:['ì•Œë¦¬ë°”ë°” RFQ ê²Œì‹œ','ì•„ë§ˆì¡´ ì…€ëŸ¬/ë²¤ë” ì…ì  ê²€í† ','í•œì¸ë§ˆíŠ¸ ì²´ì¸ ì»¨íƒ (H Mart ë“±)','ì‹í’ˆ ì „ì‹œíšŒ ì°¸ê°€ ê²€í†  (FHA, SIAL)','ì½œë“œì´ë©”ì¼ ìº í˜ì¸ (50+ ë°”ì´ì–´)','ìƒ˜í”Œ ë°œì†¡ ì¤€ë¹„'],tip:'í•œì¸ë§ˆíŠ¸ë¶€í„° ì‹œì‘ â†’ ì•„ë§ˆì¡´ FBA â†’ ë©”ì¸ìŠ¤íŠ¸ë¦¼ ìœ í†µ. ì „ì‹œíšŒëŠ” ë°”ì´ì–´ í™•ë³´ ìµœê³  ì±„ë„!',time:'4-8ì£¼',cost:'$500-2,000'},
      negotiation:{items:['ê°€ê²©í‘œ(Price List) ì‘ì„±','ê²°ì œ ì¡°ê±´ í˜‘ì˜ (T/T, L/C)','ìµœì†Œì£¼ë¬¸ëŸ‰(MOQ) ì¡°ì •','ìƒ˜í”Œ ì˜¤ë” ì§„í–‰','ì •ì‹ ê³„ì•½ì„œ ê²€í† ','PI(Proforma Invoice) ë°œí–‰'],tip:'ì²« ê±°ë˜ëŠ” T/T ì„ ê²°ì œ 30-50% ê¶Œì¥. MOQëŠ” ìœ ì—°í•˜ê²Œ!',time:'2-4ì£¼',cost:'$200-500'},
      production:{items:['ìƒì‚° ì¼ì • í™•ì • (ë°”ì´ì–´ ë‚©ê¸° ê¸°ì¤€)','ìˆ˜ì¶œìš© ì›ë¶€ìì¬ í™•ë³´','ìƒì‚° ì°©ìˆ˜','ì¤‘ê°„ QC (í’ˆì§ˆ ì²´í¬)','ìˆ˜ì¶œêµ­ ê·œê²© í¬ì¥ ë° ë¼ë²¨ ë¶€ì°©','ìµœì¢… ê²€ìˆ˜ ë° ì¶œí•˜ ì¤€ë¹„'],tip:'ë°”ì´ì–´ê°€ ì œ3ì ê²€ìˆ˜(SGS, Bureau Veritas)ë¥¼ ìš”ì²­í•˜ë©´ ë°˜ë“œì‹œ ìˆ˜ìš©í•˜ì„¸ìš”.',time:'2-4ì£¼',cost:'ìƒì‚°ë¹„ ë³„ë„'},
      shipping:{items:['CI(Commercial Invoice) ì‘ì„±','PL(Packing List) ì‘ì„±','ì›ì‚°ì§€ì¦ëª…ì„œ(C/O) ë°œê¸‰','ì‹í’ˆ ê²€ì—­ ì„œë¥˜ ì¤€ë¹„','í¬ì›Œë” ì„ ì • ë° ê²¬ì ','ëƒ‰ì¥/ëƒ‰ë™ ì»¨í…Œì´ë„ˆ í™•ì¸','ì„ ì  ë° B/L ìˆ˜ë ¹','ë¯¸êµ­ í†µê´€ ëª¨ë‹ˆí„°ë§'],tip:'ì‹í’ˆì€ ëƒ‰ì¥/ëƒ‰ë™ ì—¬ë¶€ í™•ì¸! í¬ì›Œë”ì—ê²Œ FDA Prior Notice ëŒ€í–‰ ìš”ì²­.',time:'3-6ì£¼',cost:'$2,000-5,000'},
      completed:{items:['ëŒ€ê¸ˆ ìˆ˜ë ¹ í™•ì¸','ë°”ì´ì–´ í”¼ë“œë°± ìˆ˜ì§‘','ì¬ì£¼ë¬¸ í˜‘ì˜','ë¦¬ë·°/í›„ê¸° ê´€ë¦¬','ë‹¤ìŒ ì‹œì¥ í™•ì¥ ê²€í† '],tip:'ì²« ê±°ë˜ ì„±ê³µ í›„ ì¬ì£¼ë¬¸ë¥ ì´ í•µì‹¬. ë°”ì´ì–´ ê´€ê³„ ìœ ì§€!',time:'-',cost:'-'}
    },
    JP:{
      certs:['ì‹í’ˆìœ„ìƒë²• ê²€ì‚¬','JAS ì¸ì¦','ì˜ì–‘í‘œì‹œ (ì¼ë³¸ ì–‘ì‹)','ìˆ˜ì…ì‹í’ˆì‹ ê³ ','ì•Œë ˆë¥´ê¸° í‘œì‹œ'],
      planning:{items:['ìˆ˜ì¶œ ëŒ€ìƒ ì‹í’ˆ í™•ì •','ì¼ë³¸ ì‹í’ˆìœ„ìƒë²• ì‚¬ì „ ê²€í† ','FOB ê°€ê²© í™•ì •','íƒ€ê²Ÿ ìœ í†µì±„ë„ ì„ ì • (í¸ì˜ì /ë§ˆíŠ¸/ì˜¨ë¼ì¸)','ìˆ˜ì¶œ ì¼ì • ìˆ˜ë¦½'],tip:'ì¼ë³¸ì€ ì‹í’ˆìœ„ìƒë²•ì´ ë§¤ìš° ì—„ê²©. ì²¨ê°€ë¬¼ ê¸°ì¤€ì´ í•œêµ­ê³¼ ë‹¤ë¥´ë‹ˆ ì‚¬ì „ í™•ì¸ í•„ìˆ˜!',time:'2-4ì£¼',cost:'$200-400'},
      certification:{items:['ì‹í’ˆìœ„ìƒë²• ì í•© ê²€ì‚¬','ì¼ë³¸ì–´ ì˜ì–‘í‘œì‹œ ë¼ë²¨ ì œì‘','ì•Œë ˆë¥´ê¸° í‘œì‹œ í™•ì¸ (28í’ˆëª©)','ìˆ˜ì…ì‹í’ˆì‹ ê³  ì„œë¥˜ ì¤€ë¹„','JAS ì¸ì¦ ê²€í†  (í•´ë‹¹ì‹œ)'],tip:'ì¼ë³¸ ì²¨ê°€ë¬¼ ì–‘ì„±ëª©ë¡ì œ(Positive List) í™•ì¸! í•œêµ­ í—ˆìš© ì²¨ê°€ë¬¼ì´ ì¼ë³¸ì—ì„  ê¸ˆì§€ì¼ ìˆ˜ ìˆìŒ.',time:'4-6ì£¼',cost:'$1,000-2,500'},
      buyer_search:{items:['ì¼ë³¸ ì¢…í•©ìƒì‚¬/ì „ë¬¸ìƒì‚¬ ì»¨íƒ','ëˆí‚¤í˜¸í…Œ/ì´ì˜¨ ë“± ìœ í†µì‚¬ ì ‘ê·¼','K-Food ì „ë¬¸ ìˆ˜ì…ì‚¬ ë¦¬ìŠ¤íŠ¸','FOODEX JAPAN ì „ì‹œíšŒ ì°¸ê°€','í•œë¥˜ ì»¤ë®¤ë‹ˆí‹° ë§ˆì¼€íŒ…'],tip:'ì¼ë³¸ì€ ìƒì‚¬(å•†ç¤¾)ë¥¼ í†µí•œ ê°„ì ‘ìˆ˜ì¶œì´ ì¼ë°˜ì . ì§ì ‘ ìœ í†µì‚¬ ì ‘ê·¼ë„ ê°€ëŠ¥.',time:'4-8ì£¼',cost:'$500-2,000'},
      negotiation:{items:['ê°€ê²©í‘œ ì‘ì„± (ì—”í™”)','ê²°ì œ ì¡°ê±´ í˜‘ì˜','MOQ ì¡°ì • (ì†ŒëŸ‰ ë‹¤í’ˆì¢…)','ìƒ˜í”Œ ì˜¤ë” ì§„í–‰','ê³„ì•½ì„œ ê²€í† ','PI ë°œí–‰'],tip:'ì¼ë³¸ ë°”ì´ì–´ëŠ” ì†ŒëŸ‰ ë‹¤ë¹ˆë„ ì£¼ë¬¸ì´ ë§ìŒ. MOQë¥¼ ë‚®ì¶”ë©´ ì§„ì… ì‰¬ì›€.',time:'2-4ì£¼',cost:'$200-400'},
      production:{items:['ìƒì‚° ì¼ì • í™•ì •','ì¼ë³¸ ê·œê²© ì›ë¶€ìì¬ í™•ë³´','ìƒì‚° ì°©ìˆ˜','ì¤‘ê°„ QC','ì¼ë³¸ ê·œê²© í¬ì¥/ë¼ë²¨ ë¶€ì°©','ìµœì¢… ê²€ìˆ˜'],tip:'ì¼ë³¸ì€ í¬ì¥ í’ˆì§ˆì— ë§¤ìš° ë¯¼ê°. ë°•ìŠ¤ ëª¨ì„œë¦¬ ì°Œê·¸ëŸ¬ì§ë„ ë¶ˆëŸ‰ ì²˜ë¦¬!',time:'2-3ì£¼',cost:'ìƒì‚°ë¹„ ë³„ë„'},
      shipping:{items:['CI/PL ì‘ì„±','ì›ì‚°ì§€ì¦ëª…ì„œ ë°œê¸‰','ì‹í’ˆê²€ì—­ ì„œë¥˜','í¬ì›Œë” ì„ ì •','ì„ ì  ë° B/L ìˆ˜ë ¹','ì¼ë³¸ í†µê´€ ëª¨ë‹ˆí„°ë§'],tip:'ì¼ë³¸ê¹Œì§€ í•´ìƒ 3-5ì¼. ì‹ ì„ ì‹í’ˆì€ í•­ê³µ ê¶Œì¥.',time:'2-4ì£¼',cost:'$1,000-3,000'},
      completed:{items:['ëŒ€ê¸ˆ ìˆ˜ë ¹ í™•ì¸','ë°”ì´ì–´ í”¼ë“œë°± ìˆ˜ì§‘','ì¬ì£¼ë¬¸ í˜‘ì˜','ì¼ë³¸ í˜„ì§€ ë°˜ì‘ ëª¨ë‹ˆí„°ë§'],tip:'ì¼ë³¸ ë°”ì´ì–´ëŠ” ì‹ ë¢° êµ¬ì¶•ì´ ì˜¤ë˜ ê±¸ë¦¬ì§€ë§Œ, í•œë²ˆ ê±°ë˜í•˜ë©´ ì¥ê¸° ê´€ê³„!',time:'-',cost:'-'}
    },
    EU:{
      certs:['EU ì‹í’ˆì•ˆì „ê·œì •(EC 178/2002)','HACCP','ì˜ì–‘í‘œì‹œ(EU ì–‘ì‹)','ì•Œë ˆë¥´ê¸° í‘œì‹œ(14ì¢…)','ìœ ê¸°ë† ì¸ì¦(í•´ë‹¹ì‹œ)'],
      planning:{items:['ìˆ˜ì¶œ ëŒ€ìƒ ì‹í’ˆ í™•ì •','EU ì‹í’ˆì•ˆì „ê·œì • ì‚¬ì „ ê²€í† ','FOB ê°€ê²© í™•ì •','íƒ€ê²Ÿ êµ­ê°€/ìœ í†µì±„ë„ ì„ ì •','ìˆ˜ì¶œ ì¼ì • ìˆ˜ë¦½'],tip:'EUëŠ” íšŒì›êµ­ë§ˆë‹¤ ë¯¸ì„¸í•œ ì°¨ì´ ìˆìŒ. ë…ì¼/í”„ë‘ìŠ¤/ë„¤ëœë€ë“œ ìš°ì„  ì¶”ì²œ.',time:'2-4ì£¼',cost:'$300-600'},
      certification:{items:['EU ì‹í’ˆì•ˆì „ê·œì • ì í•©ì„± í™•ì¸','HACCP ì¸ì¦','EU ì˜ì–‘í‘œì‹œ ë¼ë²¨ ì œì‘ (í˜„ì§€ì–´)','ì•Œë ˆë¥´ê¸° í‘œì‹œ (14ì¢… ì˜ë¬´)','ì”ë¥˜ë†ì•½/ì¤‘ê¸ˆì† ê²€ì‚¬','ìœ ê¸°ë† ì¸ì¦ (í•´ë‹¹ì‹œ)'],tip:'EUëŠ” ì•Œë ˆë¥´ê¸° 14ì¢… ì˜ë¬´í‘œì‹œ! í˜„ì§€ ì–¸ì–´ ë¼ë²¨ í•„ìˆ˜.',time:'6-10ì£¼',cost:'$2,000-4,000'},
      buyer_search:{items:['ìœ ëŸ½ ì‹í’ˆ ìˆ˜ì…ì‚¬ ë¦¬ìŠ¤íŠ¸','SIAL Paris/Anuga ì „ì‹œíšŒ ì°¸ê°€','ì•„ë§ˆì¡´ EU ì…ì  ê²€í† ','í•œë¥˜ ì‹í’ˆ ì „ë¬¸ ìœ í†µì‚¬ ì ‘ê·¼','ì½œë“œì´ë©”ì¼ ìº í˜ì¸'],tip:'Anuga(ë…ì¼)ì™€ SIAL(í”„ë‘ìŠ¤)ì´ ìœ ëŸ½ ìµœëŒ€ ì‹í’ˆ ì „ì‹œíšŒ.',time:'6-10ì£¼',cost:'$1,000-3,000'},
      negotiation:{items:['ê°€ê²©í‘œ ì‘ì„± (ìœ ë¡œ)','ê²°ì œ ì¡°ê±´ í˜‘ì˜','MOQ ì¡°ì •','ìƒ˜í”Œ ì˜¤ë” ì§„í–‰','ê³„ì•½ì„œ ê²€í† ','PI ë°œí–‰'],tip:'EU ë°”ì´ì–´ëŠ” í’ˆì§ˆ ì¸ì¦ê³¼ ì§€ì†ê°€ëŠ¥ì„± ì¤‘ì‹œ.',time:'3-5ì£¼',cost:'$300-600'},
      production:{items:['ìƒì‚° ì¼ì • í™•ì •','EU ê·œê²© ì›ë¶€ìì¬/í¬ì¥ì¬ í™•ë³´','ìƒì‚° ì°©ìˆ˜','ì¤‘ê°„ QC','EU í˜„ì§€ì–´ ë¼ë²¨ ë¶€ì°©','ìµœì¢… ê²€ìˆ˜'],tip:'EUëŠ” í¬ì¥ì¬ ì¬í™œìš© ê·œì •ë„ ìˆìŒ. ì‚¬ì „ í™•ì¸!',time:'2-4ì£¼',cost:'ìƒì‚°ë¹„ ë³„ë„'},
      shipping:{items:['CI/PL ì‘ì„±','ì›ì‚°ì§€ì¦ëª…ì„œ ë°œê¸‰','EUR.1 ë˜ëŠ” FTA ì›ì‚°ì§€ ì„œë¥˜','ì‹í’ˆê²€ì—­ ì„œë¥˜','í¬ì›Œë” ì„ ì •','ì„ ì  ë° B/L ìˆ˜ë ¹','EU í†µê´€ ëª¨ë‹ˆí„°ë§'],tip:'í•œ-EU FTAë¡œ ê´€ì„¸ í˜œíƒ! EUR.1 ì›ì‚°ì§€ì¦ëª…ì„œ ì±™ê¸°ì„¸ìš”.',time:'4-6ì£¼',cost:'$2,500-6,000'},
      completed:{items:['ëŒ€ê¸ˆ ìˆ˜ë ¹ í™•ì¸','ë°”ì´ì–´ í”¼ë“œë°± ìˆ˜ì§‘','ì¬ì£¼ë¬¸ í˜‘ì˜','ìœ ëŸ½ í˜„ì§€ ë°˜ì‘ ë¶„ì„'],tip:'í•œ-EU FTA ë•ì— ëŒ€ë¶€ë¶„ ì‹í’ˆ ê´€ì„¸ 0%. ì ê·¹ í™œìš©!',time:'-',cost:'-'}
    },
    SG:{
      certs:['SFA ì‹í’ˆìˆ˜ì…í—ˆê°€','ì˜ì–‘í‘œì‹œ(ì˜ë¬¸)','ìœ„ìƒì¦ëª…ì„œ','í• ë„ì¸ì¦(í•´ë‹¹ì‹œ)'],
      planning:{items:['ìˆ˜ì¶œ ëŒ€ìƒ ì‹í’ˆ í™•ì •','SFA(ì‹±ê°€í¬ë¥´ ì‹í’ˆì²­) ê·œì • í™•ì¸','FOB ê°€ê²© í™•ì •','íƒ€ê²Ÿ ìœ í†µì±„ë„ ì„ ì • (NTUC FairPrice/ëˆëˆëˆí‚¤/ë ˆë“œë§ˆíŠ¸)','ìˆ˜ì¶œ ì¼ì • ìˆ˜ë¦½'],tip:'ì‹±ê°€í¬ë¥´ëŠ” ì˜ë¬¸ ë¼ë²¨ë§Œìœ¼ë¡œ OK! SFA ìˆ˜ì…í—ˆê°€ê°€ í•µì‹¬.',time:'2-3ì£¼',cost:'$200-400'},
      certification:{items:['SFA ì‹í’ˆìˆ˜ì…í—ˆê°€ ì‹ ì²­ (í˜„ì§€ ìˆ˜ì…ì‚¬ í†µí•´)','ìœ„ìƒì¦ëª…ì„œ(Health Certificate) ë°œê¸‰','ì˜ì–‘í‘œì‹œ ë¼ë²¨ ì œì‘ (ì˜ë¬¸)','ì„±ë¶„/ì•Œë ˆë¥´ê¸° í‘œì‹œ','í• ë„ ì¸ì¦ ê²€í†  (ë¬´ìŠ¬ë¦¼ ì‹œì¥)'],tip:'SFAëŠ” ìˆ˜ì…ì‚¬ê°€ ë¼ì´ì„ ìŠ¤ ë³´ìœ í•´ì•¼ í•¨. í˜„ì§€ íŒŒíŠ¸ë„ˆ í•„ìˆ˜!',time:'2-4ì£¼',cost:'$500-1,500'},
      buyer_search:{items:['ì‹±ê°€í¬ë¥´ ì‹í’ˆ ìˆ˜ì…ì‚¬ ì»¨íƒ','NTUC FairPrice ë²¤ë” ë“±ë¡','FHA (Food & Hotel Asia) ì „ì‹œíšŒ','ë ˆë“œë§ˆíŠ¸/ì‡¼í”¼ ì˜¨ë¼ì¸ ì…ì ','K-Food ì „ë¬¸ ìˆ˜ì…ì‚¬ ì ‘ê·¼'],tip:'FHA Singaporeê°€ ë™ë‚¨ì•„ ìµœëŒ€ ì‹í’ˆ ì „ì‹œíšŒ! ì—° 1íšŒ.',time:'4-6ì£¼',cost:'$500-2,000'},
      negotiation:{items:['ê°€ê²©í‘œ ì‘ì„± (SGD/USD)','ê²°ì œ ì¡°ê±´ í˜‘ì˜','MOQ ì¡°ì • (ì‹±ê°€í¬ë¥´ëŠ” ì†ŒëŸ‰)','ìƒ˜í”Œ ì˜¤ë” ì§„í–‰','ê³„ì•½ì„œ ê²€í† ','PI ë°œí–‰'],tip:'ì‹±ê°€í¬ë¥´ëŠ” ì¸êµ¬ 580ë§Œ ì†Œì‹œì¥ì´ì§€ë§Œ, ë™ë‚¨ì•„ í—ˆë¸Œë¡œ í™•ì¥ ê°€ëŠ¥!',time:'2-3ì£¼',cost:'$200-400'},
      production:{items:['ìƒì‚° ì¼ì • í™•ì •','ì˜ë¬¸ ë¼ë²¨ ì›ë¶€ìì¬ í™•ë³´','ìƒì‚° ì°©ìˆ˜','ì¤‘ê°„ QC','ì˜ë¬¸ ë¼ë²¨ ë¶€ì°©','ìµœì¢… ê²€ìˆ˜'],tip:'ì‹±ê°€í¬ë¥´ëŠ” ì˜ì–´ê¶Œ! ë¼ë²¨ ë²ˆì—­ ë¶ˆí•„ìš”.',time:'2-3ì£¼',cost:'ìƒì‚°ë¹„ ë³„ë„'},
      shipping:{items:['CI/PL ì‘ì„±','ì›ì‚°ì§€ì¦ëª…ì„œ ë°œê¸‰','ìœ„ìƒì¦ëª…ì„œ','SFA ìˆ˜ì…ì‹ ê³ ','í¬ì›Œë” ì„ ì •','ì„ ì  ë° B/L ìˆ˜ë ¹'],tip:'ë¶€ì‚°â†’ì‹±ê°€í¬ë¥´ í•´ìƒ 7-10ì¼. RCEP/í•œ-ASEAN FTAë¡œ ê´€ì„¸ í˜œíƒ!',time:'2-4ì£¼',cost:'$800-2,000'},
      completed:{items:['ëŒ€ê¸ˆ ìˆ˜ë ¹ í™•ì¸','ë°”ì´ì–´ í”¼ë“œë°±','ì‹±ê°€í¬ë¥´ â†’ ë§ë ˆì´ì‹œì•„/ì¸ë„ë„¤ì‹œì•„ í™•ì¥ ê²€í† '],tip:'ì‹±ê°€í¬ë¥´ëŠ” ë™ë‚¨ì•„ ì§„ì¶œ êµë‘ë³´! ì„±ê³µ í›„ ì£¼ë³€êµ­ í™•ì¥.',time:'-',cost:'-'}
    }
  },
  'K-Beauty':{
    US:{
      certs:['FDA OTC ë“±ë¡(í•´ë‹¹ì‹œ)','FDA ì‹œì„¤ë“±ë¡','VCRP ìë°œë“±ë¡','ì„±ë¶„ ê²€í† (Prohibited List)','ë¼ë²¨ë§(INCI í‘œê¸°)'],
      planning:{items:['ìˆ˜ì¶œ ëŒ€ìƒ í™”ì¥í’ˆ í™•ì •','FDA ê·œì • ë¶„ë¥˜ (ì¼ë°˜ vs OTC)','FOB ê°€ê²© í™•ì •','íƒ€ê²Ÿ ìœ í†µì±„ë„ ì„ ì • (ì„¸í¬ë¼/ìš¸íƒ€/ì•„ë§ˆì¡´)','ìˆ˜ì¶œ ì¼ì • ìˆ˜ë¦½'],tip:'ì„ í¬ë¦¼/ì—¬ë“œë¦„ ì œí’ˆì€ FDA OTC ë¶„ë¥˜! ì¼ë°˜ í™”ì¥í’ˆê³¼ ê·œì •ì´ ë‹¤ë¦„.',time:'2-4ì£¼',cost:'$200-500'},
      certification:{items:['FDA í™”ì¥í’ˆ ë¶„ë¥˜ í™•ì •','FDA ì‹œì„¤ë“±ë¡','VCRP ìë°œë“±ë¡ (ê¶Œì¥)','ì„±ë¶„ ì•ˆì „ì„± ê²€í†  (Prohibited/Restricted)','INCI ì˜ë¬¸ ì„±ë¶„í‘œ ì‘ì„±','ë¯¸êµ­ ë¼ë²¨ë§ ê·œì • ì í•© í™•ì¸','ì•ˆì „ì„± í…ŒìŠ¤íŠ¸ (í•„ìš”ì‹œ)'],tip:'ë¯¸êµ­ì€ í™”ì¥í’ˆ ì‚¬ì „ ìŠ¹ì¸ ë¶ˆìš”. í•˜ì§€ë§Œ MoCRA(2023) ì´í›„ ì‹œì„¤ë“±ë¡/ì„±ë¶„ëª©ë¡ ì˜ë¬´í™”!',time:'4-6ì£¼',cost:'$1,000-2,500'},
      buyer_search:{items:['ì„¸í¬ë¼/ìš¸íƒ€ ë²¤ë” ì§€ì›','ì•„ë§ˆì¡´ ë·°í‹° ì¹´í…Œê³ ë¦¬ ì…ì ','K-Beauty ì „ë¬¸ ìˆ˜ì…ì‚¬ ì»¨íƒ','Cosmoprof ì „ì‹œíšŒ ì°¸ê°€','ì¸í”Œë£¨ì–¸ì„œ ë§ˆì¼€íŒ… ê²€í† ','ìƒ˜í”Œ ë°œì†¡ ì¤€ë¹„'],tip:'K-BeautyëŠ” ë¯¸êµ­ì—ì„œ ì¸ì§€ë„ ë†’ìŒ! ì•„ë§ˆì¡´ FBA + ì¸í”Œë£¨ì–¸ì„œê°€ ë¹ ë¥¸ ì§„ì… ì „ëµ.',time:'4-8ì£¼',cost:'$1,000-3,000'},
      negotiation:{items:['ê°€ê²©í‘œ ì‘ì„±','ê²°ì œ ì¡°ê±´ í˜‘ì˜','MOQ ì¡°ì •','ìƒ˜í”Œ ì˜¤ë” ì§„í–‰','ê³„ì•½ì„œ ê²€í† ','PI ë°œí–‰'],tip:'ë¯¸êµ­ ë°”ì´ì–´ëŠ” ë§ˆì§„ìœ¨ 50%+ ê¸°ëŒ€. FOB ê°€ê²© ì„¤ì • ì£¼ì˜!',time:'2-4ì£¼',cost:'$200-500'},
      production:{items:['ìƒì‚° ì¼ì • í™•ì •','ë¯¸êµ­ ê·œê²© ìš©ê¸°/ë¼ë²¨ í™•ë³´','ìƒì‚° ì°©ìˆ˜','ì¤‘ê°„ QC (ì„±ë¶„ ì•ˆì •ì„±)','INCI ë¼ë²¨ ë¶€ì°©','ìµœì¢… ê²€ìˆ˜'],tip:'ë¯¸êµ­ ë¼ë²¨ ê·œì •(MoCRA 2023) ì¤€ìˆ˜ í™•ì¸!',time:'2-4ì£¼',cost:'ìƒì‚°ë¹„ ë³„ë„'},
      shipping:{items:['CI/PL ì‘ì„±','ì›ì‚°ì§€ì¦ëª…ì„œ ë°œê¸‰','í™”ì¥í’ˆ MSDS ì¤€ë¹„','í¬ì›Œë” ì„ ì •','ì„ ì  ë° B/L ìˆ˜ë ¹','ë¯¸êµ­ í†µê´€ ëª¨ë‹ˆí„°ë§'],tip:'í™”ì¥í’ˆì€ ìœ„í—˜ë¬¼ ë¶„ë¥˜ ì•„ë‹˜(ì¼ë°˜ì ). í•­ê³µ/í•´ìƒ ëª¨ë‘ ê°€ëŠ¥.',time:'3-5ì£¼',cost:'$1,500-4,000'},
      completed:{items:['ëŒ€ê¸ˆ ìˆ˜ë ¹ í™•ì¸','ë°”ì´ì–´ í”¼ë“œë°±/ë¦¬ë·° ìˆ˜ì§‘','ì¬ì£¼ë¬¸ í˜‘ì˜','í˜„ì§€ ë§ˆì¼€íŒ… ì„±ê³¼ ë¶„ì„'],tip:'ë¦¬ë·°ì™€ SNS ë°˜ì‘ì´ ì¬ì£¼ë¬¸ì˜ í•µì‹¬!',time:'-',cost:'-'}
    },
    JP:{
      certs:['í™”ì¥í’ˆ ì œì¡°íŒë§¤ì—… í—ˆê°€(í˜„ì§€ íŒŒíŠ¸ë„ˆ)','ì„±ë¶„ ê²€í† (ì¼ë³¸ ê¸ˆì§€ì„±ë¶„)','ì „ì„±ë¶„ í‘œì‹œ(ì¼ë³¸ì–´)','ì•½ê¸°ë²• ì í•©ì„±','ë°©ë¶€ì œ/ìì™¸ì„ ì°¨ë‹¨ ê¸°ì¤€'],
      planning:{items:['ìˆ˜ì¶œ ëŒ€ìƒ í™”ì¥í’ˆ í™•ì •','ì¼ë³¸ ì•½ê¸°ë²•(PMDA) ì‚¬ì „ ê²€í† ','FOB ê°€ê²© í™•ì •','íƒ€ê²Ÿ ìœ í†µì±„ë„ ì„ ì • (@cosme/ëˆí‚¤í˜¸í…Œ/íí…)','ìˆ˜ì¶œ ì¼ì • ìˆ˜ë¦½'],tip:'ì¼ë³¸ì€ í™”ì¥í’ˆ ìˆ˜ì…ì‹œ í˜„ì§€ "ì œì¡°íŒë§¤ì—…ì" í•„ìˆ˜. íŒŒíŠ¸ë„ˆì‚¬ ë¨¼ì € í™•ë³´!',time:'2-4ì£¼',cost:'$300-500'},
      certification:{items:['ì¼ë³¸ ì œì¡°íŒë§¤ì—…ì íŒŒíŠ¸ë„ˆ ì„ ì •','ì„±ë¶„ ì í•©ì„± ê²€í†  (ì¼ë³¸ ê¸°ì¤€)','ì „ì„±ë¶„ ì¼ë³¸ì–´ í‘œì‹œ ì‘ì„±','ì•½ê¸°ë²• ë¶„ë¥˜ í™•ì¸ (í™”ì¥í’ˆ vs ì˜ì•½ë¶€ì™¸í’ˆ)','í•„ìš”ì‹œ ì„±ë¶„ ë¦¬í¬ë®¬ë ˆì´ì…˜','ìˆ˜ì…ì‹ ê³  ì„œë¥˜ ì¤€ë¹„'],tip:'í•œêµ­ í—ˆìš© ì„±ë¶„ì´ ì¼ë³¸ì—ì„œ ê¸ˆì§€ì¼ ìˆ˜ ìˆìŒ! ì‚¬ì „ ì„±ë¶„ ê²€í† ê°€ í•µì‹¬.',time:'6-10ì£¼',cost:'$2,000-4,000'},
      buyer_search:{items:['ì¼ë³¸ í™”ì¥í’ˆ ìˆ˜ì…ì‚¬ ì»¨íƒ','@cosme ì…ì  ê²€í† ','íí…ì¬íŒ¬/ë¼ì¿ í… ì˜¨ë¼ì¸ ì…ì ','COSME TOKYO ì „ì‹œíšŒ ì°¸ê°€','í•œë¥˜ ë·°í‹° ì „ë¬¸ì  ì ‘ê·¼'],tip:'@cosme ë­í‚¹ì´ ì¼ë³¸ í™”ì¥í’ˆ ì‹œì¥ì˜ ë°”ë¡œë¯¸í„°. ì…ì  + ë¦¬ë·° í™•ë³´ê°€ ê´€ê±´.',time:'4-8ì£¼',cost:'$1,000-3,000'},
      negotiation:{items:['ê°€ê²©í‘œ ì‘ì„± (ì—”í™”)','ê²°ì œ ì¡°ê±´ í˜‘ì˜','MOQ ì¡°ì • (ì†ŒëŸ‰ ë‹¤í’ˆì¢…)','ìƒ˜í”Œ ì˜¤ë” ì§„í–‰','ê³„ì•½ì„œ ê²€í† ','PI ë°œí–‰'],tip:'ì¼ë³¸ ë°”ì´ì–´ëŠ” í’ˆì§ˆ ì¼ê´€ì„±ê³¼ ë‚©ê¸° ì—„ìˆ˜ë¥¼ ë§¤ìš° ì¤‘ì‹œ!',time:'2-4ì£¼',cost:'$200-400'},
      production:{items:['ìƒì‚° ì¼ì • í™•ì •','ì¼ë³¸ ê·œê²© ìš©ê¸°/ë¼ë²¨ í™•ë³´','ìƒì‚° ì°©ìˆ˜','ì¤‘ê°„ QC','ì¼ë³¸ì–´ ì „ì„±ë¶„ ë¼ë²¨ ë¶€ì°©','ìµœì¢… ê²€ìˆ˜'],tip:'ì¼ë³¸ì€ ë¡¯íŠ¸(Lot) ê´€ë¦¬ ì—„ê²©. ì¶”ì  ê°€ëŠ¥í•˜ê²Œ ê´€ë¦¬!',time:'2-3ì£¼',cost:'ìƒì‚°ë¹„ ë³„ë„'},
      shipping:{items:['CI/PL ì‘ì„±','ì›ì‚°ì§€ì¦ëª…ì„œ ë°œê¸‰','í™”ì¥í’ˆ ì„±ë¶„ ì„œë¥˜','í¬ì›Œë” ì„ ì •','ì„ ì  ë° B/L ìˆ˜ë ¹'],tip:'ì¼ë³¸ê¹Œì§€ í•´ìƒ 3-5ì¼. í™”ì¥í’ˆì€ ì¼ë°˜í™”ë¬¼ë¡œ ìš´ì†¡ ê°€ëŠ¥.',time:'2-4ì£¼',cost:'$800-2,000'},
      completed:{items:['ëŒ€ê¸ˆ ìˆ˜ë ¹ í™•ì¸','ë°”ì´ì–´/ì†Œë¹„ì í”¼ë“œë°± ìˆ˜ì§‘','ì¬ì£¼ë¬¸ í˜‘ì˜','@cosme ë¦¬ë·° ëª¨ë‹ˆí„°ë§'],tip:'ì¼ë³¸ ì†Œë¹„ì ë¦¬ë·°ê°€ ë§¤ìš° ì¤‘ìš”. ê¾¸ì¤€í•œ í’ˆì§ˆ ìœ ì§€!',time:'-',cost:'-'}
    },
    EU:{
      certs:['CPNP ë“±ë¡','EU ì•ˆì „ì„±í‰ê°€(CPSR)','GMP(ISO 22716)','REACH ì¤€ìˆ˜','ì±…ì„ì(Responsible Person) ì„ ì„'],
      planning:{items:['ìˆ˜ì¶œ ëŒ€ìƒ í™”ì¥í’ˆ í™•ì •','EU í™”ì¥í’ˆê·œì •(EC 1223/2009) ê²€í† ','FOB ê°€ê²© í™•ì •','íƒ€ê²Ÿ êµ­ê°€ ì„ ì • (ë…ì¼/í”„ë‘ìŠ¤/ì˜êµ­)','ìˆ˜ì¶œ ì¼ì • ìˆ˜ë¦½'],tip:'EUëŠ” ì„¸ê³„ì—ì„œ ê°€ì¥ ì—„ê²©í•œ í™”ì¥í’ˆ ê·œì •! CPNP ë“±ë¡ + ì•ˆì „ì„±í‰ê°€ê°€ í•„ìˆ˜.',time:'2-4ì£¼',cost:'$300-600'},
      certification:{items:['EU ì±…ì„ì(RP) ì„ ì„ (í˜„ì§€ íŒŒíŠ¸ë„ˆ)','CPNP í¬í„¸ ë“±ë¡','ì•ˆì „ì„±í‰ê°€(CPSR) ì˜ë¢°','GMP(ISO 22716) ì¸ì¦','REACH ì¤€ìˆ˜ í™•ì¸','ì„±ë¶„ ê²€í†  (EU ê¸ˆì§€/ì œí•œ ì„±ë¶„)','í˜„ì§€ì–´ ë¼ë²¨ (INCI + í˜„ì§€ ë²ˆì—­)'],tip:'CPSR ë¹„ìš© ë†’ì§€ë§Œ í•„ìˆ˜. RP(Responsible Person)ê°€ EU ë‚´ ê±°ì£¼ìì—¬ì•¼ í•¨!',time:'8-12ì£¼',cost:'$3,000-6,000'},
      buyer_search:{items:['ìœ ëŸ½ í™”ì¥í’ˆ ìˆ˜ì…ì‚¬/ìœ í†µì‚¬ ì»¨íƒ','Cosmoprof Bologna ì „ì‹œíšŒ','ì•„ë§ˆì¡´ EU ì…ì ','K-Beauty ì „ë¬¸ ë¦¬í…Œì¼ëŸ¬ ì ‘ê·¼','ìœ ëŸ½ ë·°í‹° ì¸í”Œë£¨ì–¸ì„œ ë§ˆì¼€íŒ…'],tip:'Cosmoprof Bolognaê°€ ìœ ëŸ½ ìµœëŒ€ ë·°í‹° ì „ì‹œíšŒ. RP í™•ë³´ í›„ ì§„í–‰!',time:'6-10ì£¼',cost:'$1,500-4,000'},
      negotiation:{items:['ê°€ê²©í‘œ ì‘ì„± (ìœ ë¡œ)','ê²°ì œ ì¡°ê±´ í˜‘ì˜','MOQ ì¡°ì •','ìƒ˜í”Œ ì˜¤ë” ì§„í–‰','ê³„ì•½ì„œ ê²€í† ','PI ë°œí–‰'],tip:'EU ë°”ì´ì–´ëŠ” ì§€ì†ê°€ëŠ¥ì„±/ë¹„ê±´/í¬ë£¨ì—˜í‹°í”„ë¦¬ ì¤‘ì‹œ!',time:'3-5ì£¼',cost:'$300-600'},
      production:{items:['ìƒì‚° ì¼ì • í™•ì •','EU ê·œê²© ìš©ê¸°/í¬ì¥ì¬ í™•ë³´','ìƒì‚° ì°©ìˆ˜','ì¤‘ê°„ QC','EU í˜„ì§€ì–´ ë¼ë²¨ ë¶€ì°© (INCI)','ìµœì¢… ê²€ìˆ˜'],tip:'EUëŠ” ë™ë¬¼ì‹¤í—˜ ê¸ˆì§€. í¬ë£¨ì—˜í‹°í”„ë¦¬ ì¸ì¦ ë³„ë„ ì·¨ë“ ê²€í† !',time:'2-4ì£¼',cost:'ìƒì‚°ë¹„ ë³„ë„'},
      shipping:{items:['CI/PL ì‘ì„±','ì›ì‚°ì§€ì¦ëª…ì„œ ë°œê¸‰','CPNP ë“±ë¡ í™•ì¸ì„œ','í¬ì›Œë” ì„ ì •','ì„ ì  ë° B/L ìˆ˜ë ¹','EU í†µê´€ ëª¨ë‹ˆí„°ë§'],tip:'í•œ-EU FTA í™œìš©! í™”ì¥í’ˆ ê´€ì„¸ ëŒ€ë¶€ë¶„ 0%.',time:'4-6ì£¼',cost:'$2,000-5,000'},
      completed:{items:['ëŒ€ê¸ˆ ìˆ˜ë ¹ í™•ì¸','ë°”ì´ì–´ í”¼ë“œë°± ìˆ˜ì§‘','ì¬ì£¼ë¬¸ í˜‘ì˜','EU ì‹œì¥ ë°˜ì‘ ë¶„ì„'],tip:'EU ì§„ì¶œì€ ì‹œê°„ê³¼ ë¹„ìš©ì´ í¬ì§€ë§Œ, í•œë²ˆ ì§„ì…í•˜ë©´ ì•ˆì •ì !',time:'-',cost:'-'}
    },
    CN:{
      certs:['NMPA ìœ„ìƒí—ˆê°€(íŠ¹ìˆ˜ìš©ë„)','NMPA ë¹„íŠ¹ìˆ˜ ë¹„ì•ˆ(ì¼ë°˜í™”ì¥í’ˆ)','ì¤‘ë¬¸ ë¼ë²¨','ë™ë¬¼ì‹œí—˜ ë©´ì œ(í•´ë‹¹ì‹œ)'],
      planning:{items:['ìˆ˜ì¶œ ëŒ€ìƒ í™”ì¥í’ˆ í™•ì •','NMPA ë¶„ë¥˜ í™•ì¸ (ì¼ë°˜ vs íŠ¹ìˆ˜ìš©ë„)','FOB ê°€ê²© í™•ì •','íƒ€ê²Ÿ ìœ í†µì±„ë„ ì„ ì • (í‹°ëª°/ì§•ë™/ì™“ìŠ¨ìŠ¤/ì†Œì…œì»¤ë¨¸ìŠ¤)','ì¤‘êµ­ ëŒ€ë¦¬ì¸(RA) ì„ ì •'],tip:'2021ë…„ë¶€í„° ì¼ë°˜í™”ì¥í’ˆì€ ë¹„ì•ˆ(å‚™æ¡ˆ)ìœ¼ë¡œ ê°„ì†Œí™”! íŠ¹ìˆ˜ìš©ë„(ë¯¸ë°±/ì„ í¬ë¦¼ ë“±)ëŠ” ì—¬ì „íˆ í—ˆê°€ í•„ìš”.',time:'2-4ì£¼',cost:'$300-600'},
      certification:{items:['NMPA ë¶„ë¥˜ í™•ì •','ì¤‘êµ­ ëŒ€ë¦¬ì¸(RA) ê³„ì•½','ì¼ë°˜í™”ì¥í’ˆ: ë¹„ì•ˆ(å‚™æ¡ˆ) ì‹ ì²­','íŠ¹ìˆ˜ìš©ë„: NMPA í—ˆê°€ ì‹ ì²­','ì•ˆì „ì„± ì‹œí—˜ (ì¤‘êµ­ ì¸ì • ì‹œí—˜ì†Œ)','ë™ë¬¼ì‹œí—˜ ë©´ì œ ì ˆì°¨ (í•´ë‹¹ì‹œ)','ì¤‘ë¬¸ ë¼ë²¨ ì œì‘','CIQ ê²€ì—­ ì„œë¥˜ ì¤€ë¹„'],tip:'ë¹„ì•ˆì€ 3-6ê°œì›”, í—ˆê°€ëŠ” 6-18ê°œì›”. ë™ë¬¼ì‹œí—˜ ë©´ì œëŠ” ISO 22716 GMP í•„ìš”!',time:'3-18ê°œì›”',cost:'$3,000-15,000'},
      buyer_search:{items:['ì¤‘êµ­ í™”ì¥í’ˆ ìˆ˜ì…ì‚¬/ëŒ€ë¦¬ìƒ ì»¨íƒ','í‹°ëª° ê¸€ë¡œë²Œ/ì§•ë™ êµ­ì œ ì…ì  (CBEC)','ì™“ìŠ¨ìŠ¤/ì„¸í¬ë¼ ì¤‘êµ­ ì ‘ê·¼','CBE (China Beauty Expo) ì „ì‹œíšŒ','ìƒ¤ì˜¤í™ìŠˆ/ë„ìš°ì¸ ë§ˆì¼€íŒ… ê²€í† '],tip:'CBEC(Cross-Border E-Commerce)ë¡œ NMPA ì—†ì´ë„ ì§„ì¶œ ê°€ëŠ¥! í•˜ì§€ë§Œ ì¼ë°˜ ìˆ˜ì…ì´ ì¥ê¸° ì „ëµ.',time:'4-10ì£¼',cost:'$1,000-5,000'},
      negotiation:{items:['ê°€ê²©í‘œ ì‘ì„± (ìœ„ì•ˆ/USD)','ê²°ì œ ì¡°ê±´ í˜‘ì˜','MOQ ì¡°ì •','ìƒ˜í”Œ ì˜¤ë”','ê³„ì•½ì„œ ê²€í†  (ì¤‘êµ­ë²• ê³ ë ¤)','PI ë°œí–‰'],tip:'ì¤‘êµ­ ë°”ì´ì–´ëŠ” ê°€ê²© í˜‘ìƒì´ ì¹˜ì—´! ë§ˆì§„ ì—¬ìœ ë¥¼ ë‘ê³  ì‹œì‘.',time:'2-4ì£¼',cost:'$200-500'},
      production:{items:['ìƒì‚° ì¼ì • í™•ì •','ì¤‘êµ­ ê·œê²© ìš©ê¸°/í¬ì¥ í™•ë³´','ìƒì‚° ì°©ìˆ˜','ì¤‘ê°„ QC','ì¤‘ë¬¸ ë¼ë²¨ ë¶€ì°©','CIQ ê²€ì—­ ëŒ€ë¹„ ì„œë¥˜ ì¤€ë¹„'],tip:'ì¤‘êµ­ ë¼ë²¨ì—ëŠ” ë°˜ë“œì‹œ NMPA ë¹„ì•ˆë²ˆí˜¸/í—ˆê°€ë²ˆí˜¸ í‘œê¸°!',time:'2-4ì£¼',cost:'ìƒì‚°ë¹„ ë³„ë„'},
      shipping:{items:['CI/PL ì‘ì„±','ì›ì‚°ì§€ì¦ëª…ì„œ ë°œê¸‰','NMPA ë¹„ì•ˆ/í—ˆê°€ ì„œë¥˜','CIQ ê²€ì—­ ì„œë¥˜','í¬ì›Œë” ì„ ì •','ì„ ì  ë° B/L ìˆ˜ë ¹','ì¤‘êµ­ í†µê´€ (í•´ê´€)'],tip:'ì¤‘êµ­ í†µê´€ì€ CIQ ê²€ì—­ì´ í•µì‹¬! ì„œë¥˜ ë¶ˆë¹„í•˜ë©´ ë°˜ì†¡.',time:'3-6ì£¼',cost:'$1,500-4,000'},
      completed:{items:['ëŒ€ê¸ˆ ìˆ˜ë ¹ í™•ì¸','ë°”ì´ì–´/ì†Œë¹„ì í”¼ë“œë°±','ìƒ¤ì˜¤í™ìŠˆ ë¦¬ë·° ëª¨ë‹ˆí„°ë§','ì¬ì£¼ë¬¸ í˜‘ì˜'],tip:'ì¤‘êµ­ì€ SNS ì…ì†Œë¬¸ì´ ë§¤ì¶œì˜ 80%! ìƒ¤ì˜¤í™ìŠˆ/ë„ìš°ì¸ ê´€ë¦¬ í•„ìˆ˜.',time:'-',cost:'-'}
    }
  },
  'K-Health':{
    US:{
      certs:['FDA Dietary Supplement ë“±ë¡','cGMP ì¸ì¦','NDI ì‹ ê³ (í•´ë‹¹ì‹œ)','Supplement Facts ë¼ë²¨','FSVP ëŒ€ë¦¬ì¸'],
      planning:{items:['ìˆ˜ì¶œ ëŒ€ìƒ ê±´ê°•ì‹í’ˆ í™•ì •','FDA ë¶„ë¥˜ í™•ì¸ (Dietary Supplement vs Drug)','FOB ê°€ê²© í™•ì •','íƒ€ê²Ÿ ìœ í†µì±„ë„ ì„ ì •','ìˆ˜ì¶œ ì¼ì • ìˆ˜ë¦½'],tip:'ê±´ê°•ê¸°ëŠ¥ì‹í’ˆì€ FDAì—ì„œ Dietary Supplementë¡œ ë¶„ë¥˜. Drugìœ¼ë¡œ ì˜¤ë¶„ë¥˜ë˜ë©´ ìˆ˜ì¶œ ë¶ˆê°€!',time:'2-4ì£¼',cost:'$300-600'},
      certification:{items:['FDA Dietary Supplement ì í•© í™•ì¸','ì‹œì„¤ë“±ë¡','cGMP ì¸ì¦','Supplement Facts ë¼ë²¨ ì œì‘','NDI ì‹ ê³  (ì‹ ê·œ ì„±ë¶„ í•´ë‹¹ì‹œ)','ì„±ë¶„ ì•ˆì „ì„± ê²€í† ','FSVP ëŒ€ë¦¬ì¸ ì„ ì •'],tip:'ë¯¸êµ­ì€ ê±´ê°•ê¸°ëŠ¥ì‹í’ˆ ì‚¬ì „ìŠ¹ì¸ ë¶ˆìš”. í•˜ì§€ë§Œ cGMPì™€ ë¼ë²¨ë§ ê·œì • ì—„ê²©!',time:'6-10ì£¼',cost:'$2,000-4,000'},
      buyer_search:{items:['ë¯¸êµ­ ê±´ê°•ì‹í’ˆ ìˆ˜ì…ì‚¬ ë¦¬ìŠ¤íŠ¸','ì•„ë§ˆì¡´ Health & Wellness ì…ì ','iHerb/Vitacost ë“± ì „ë¬¸ëª°','Natural Products Expo ì „ì‹œíšŒ','ì½œë“œì´ë©”ì¼ ìº í˜ì¸'],tip:'iHerb ì…ì ì´ í•œêµ­ ê±´ê°•ì‹í’ˆ ë¯¸êµ­ ì§„ì¶œì˜ ê°€ì¥ ë¹ ë¥¸ ì±„ë„!',time:'4-8ì£¼',cost:'$800-2,500'},
      negotiation:{items:['ê°€ê²©í‘œ ì‘ì„±','ê²°ì œ ì¡°ê±´ í˜‘ì˜','MOQ ì¡°ì •','ìƒ˜í”Œ ì˜¤ë”','ê³„ì•½ì„œ ê²€í† ','PI ë°œí–‰'],tip:'ê±´ê°•ì‹í’ˆì€ ìœ í†µê¸°í•œ ì£¼ì˜! ì”ì—¬ ìœ í†µê¸°í•œ 70% ì´ìƒ ê¶Œì¥.',time:'2-4ì£¼',cost:'$200-500'},
      production:{items:['ìƒì‚° ì¼ì • í™•ì •','cGMP ê¸°ì¤€ ìƒì‚° í™˜ê²½ í™•ì¸','ìƒì‚° ì°©ìˆ˜','ì¤‘ê°„ QC (ì„±ë¶„ í•¨ëŸ‰ ê²€ì‚¬)','Supplement Facts ë¼ë²¨ ë¶€ì°©','ìµœì¢… ê²€ìˆ˜'],tip:'cGMP ê¸°ì¤€ ìƒì‚° ê¸°ë¡ ë³´ê´€ í•„ìˆ˜! FDA ì‹¤ì‚¬ ëŒ€ë¹„.',time:'2-4ì£¼',cost:'ìƒì‚°ë¹„ ë³„ë„'},
      shipping:{items:['CI/PL ì‘ì„±','ì›ì‚°ì§€ì¦ëª…ì„œ ë°œê¸‰','ì„±ë¶„ ë¶„ì„ ì„œë¥˜','í¬ì›Œë” ì„ ì •','ì„ ì  ë° B/L ìˆ˜ë ¹','FDA ì‚¬ì „í†µë³´'],tip:'ê±´ê°•ì‹í’ˆì€ FDA Prior Notice í•„ìˆ˜! í¬ì›Œë”ì—ê²Œ ëŒ€í–‰ ìš”ì²­.',time:'3-6ì£¼',cost:'$1,500-4,000'},
      completed:{items:['ëŒ€ê¸ˆ ìˆ˜ë ¹ í™•ì¸','ë°”ì´ì–´ í”¼ë“œë°± ìˆ˜ì§‘','ì¬ì£¼ë¬¸ í˜‘ì˜','ë¦¬ë·° ê´€ë¦¬'],tip:'ë¯¸êµ­ ê±´ê°•ì‹í’ˆ ì‹œì¥ ì—° $60B+. í•œêµ­ ì›ë£Œ ì¸ì§€ë„ ìƒìŠ¹ ì¤‘!',time:'-',cost:'-'}
    }
  },
  'K-Fashion':{
    US:{
      certs:['CPSIA ì†Œë¹„ìì•ˆì „ë²•','FTC ì„¬ìœ í‘œì‹œê·œì •','ASTM ì¼€ì–´ë¼ë²¨'],
      planning:{items:['ìˆ˜ì¶œ ëŒ€ìƒ ì˜ë¥˜/íŒ¨ì…˜ ì•„ì´í…œ í™•ì •','ë¯¸êµ­ ì„¬ìœ  ë¼ë²¨ë§ ê·œì •(FTC) ê²€í† ','FOB ê°€ê²© í™•ì •','íƒ€ê²Ÿ ìœ í†µì±„ë„ ì„ ì • (ì•„ë§ˆì¡´/Nordstrom/ë¶€í‹°í¬)','ì‹œì¦Œë³„ ìˆ˜ì¶œ ì¼ì • ìˆ˜ë¦½'],tip:'ë¯¸êµ­ì€ ì„¬ìœ  ì„±ë¶„, ì›ì‚°ì§€, ì¼€ì–´ë¼ë²¨ 3ê°€ì§€ ì˜ë¬´ í‘œì‹œ! FTC Textile Act í™•ì¸.',time:'2-4ì£¼',cost:'$200-500'},
      certification:{items:['FTC ì„¬ìœ ì œí’ˆ í‘œì‹œ ê·œì • í™•ì¸','CPSIA ì í•© (ì•„ë™ë³µì€ ë‚©/í”„íƒˆë ˆì´íŠ¸ ì‹œí—˜)','ì„¬ìœ  ì„±ë¶„(Fiber Content) ì‹œí—˜','ì˜ë¬¸ ì¼€ì–´ë¼ë²¨(ASTM D5489) ì œì‘','ì›ì‚°ì§€/ì œì¡°ì‚¬ í‘œì‹œ ë¼ë²¨','ì¶”ì  ë¼ë²¨(Tracking Label)'],tip:'ì•„ë™ë³µì€ CPSIA í•„ìˆ˜! ì„±ì¸ë³µì€ FTC í‘œì‹œë§Œìœ¼ë¡œ ì¶©ë¶„.',time:'2-4ì£¼',cost:'$500-2,000'},
      buyer_search:{items:['ì•„ë§ˆì¡´ Fashion ì¹´í…Œê³ ë¦¬ ì…ì ','í•œêµ­íŒ¨ì…˜ ì „ë¬¸ ìˆ˜ì…ì‚¬ ì»¨íƒ','MAGIC LAS VEGAS ì „ì‹œíšŒ','ì¸í”Œë£¨ì–¸ì„œ ë§ˆì¼€íŒ… ê²€í† ','ì‡¼ë£¸/ì—ì´ì „íŠ¸ ì ‘ê·¼','ìƒ˜í”Œ ë°œì†¡ ì¤€ë¹„'],tip:'K-Fashionì€ SNS ë§ˆì¼€íŒ…ì´ í•µì‹¬! ì¸í”Œë£¨ì–¸ì„œ ì½œë¼ë³´ë¡œ ì¸ì§€ë„ í™•ë³´.',time:'4-8ì£¼',cost:'$1,000-3,000'},
      negotiation:{items:['ê°€ê²©í‘œ ì‘ì„± (ìŠ¤íƒ€ì¼/ì‚¬ì´ì¦ˆë³„)','ê²°ì œ ì¡°ê±´ í˜‘ì˜','MOQ ì¡°ì • (ìŠ¤íƒ€ì¼ë³„ ì†ŒëŸ‰)','ìƒ˜í”Œ ì˜¤ë” ì§„í–‰','ê³„ì•½ì„œ ê²€í† ','PI ë°œí–‰'],tip:'íŒ¨ì…˜ì€ ì‹œì¦Œ ë‚©ê¸°ê°€ ìƒëª…! ë¦¬ë“œíƒ€ì„ ëª…í™•íˆ.',time:'2-4ì£¼',cost:'$200-500'},
      production:{items:['ìƒì‚° ì¼ì • í™•ì • (ì‹œì¦Œ ê¸°ì¤€)','ì›ë¶€ìì¬ í™•ë³´','ìƒì‚° ì°©ìˆ˜','ì¤‘ê°„ QC (ì‚¬ì´ì¦ˆ/ë´‰ì œ)','ë¯¸êµ­ ê·œê²© ë¼ë²¨ ë¶€ì°©','ìµœì¢… ê²€ìˆ˜ ë° íŒ¨í‚¹'],tip:'ì‚¬ì´ì¦ˆ ì°¨ì´ ì£¼ì˜! ë¯¸êµ­ ì‚¬ì´ì¦ˆ ì°¨íŠ¸ ë³„ë„ í™•ì¸.',time:'3-6ì£¼',cost:'ìƒì‚°ë¹„ ë³„ë„'},
      shipping:{items:['CI/PL ì‘ì„±','ì›ì‚°ì§€ì¦ëª…ì„œ ë°œê¸‰','ì„¬ìœ  ì„±ë¶„ í‘œì‹œ ì„œë¥˜','í¬ì›Œë” ì„ ì •','ì„ ì  ë° B/L ìˆ˜ë ¹','ë¯¸êµ­ í†µê´€ (CBP ì„¬ìœ  ê²€ì‚¬)'],tip:'ì˜ë¥˜ëŠ” CBP ì„¬ìœ ì¿¼í„° í™•ì¸! í•œ-ë¯¸ FTAë¡œ ê´€ì„¸ ëŒ€ë¶€ë¶„ ë©´ì œ.',time:'3-5ì£¼',cost:'$1,500-4,000'},
      completed:{items:['ëŒ€ê¸ˆ ìˆ˜ë ¹ í™•ì¸','ë°”ì´ì–´/ì†Œë¹„ì í”¼ë“œë°±','ì‹œì¦Œ ì¬ì£¼ë¬¸ í˜‘ì˜','ë°˜í’ˆ/êµí™˜ ì •ì±… ìˆ˜ë¦½'],tip:'íŒ¨ì…˜ì€ ë°˜í’ˆë¥  ê´€ë¦¬ê°€ ì¤‘ìš”. ì‚¬ì´ì¦ˆê°€ì´ë“œ ì •í™•í•˜ê²Œ!',time:'-',cost:'-'}
    },
    JP:{
      certs:['ê°€ì •ìš©í’ˆí’ˆì§ˆí‘œì‹œë²•','ì„¬ìœ ì œí’ˆ í‘œì‹œ(ì¼ë³¸ì–´)','ì•„ì¡°ì—¼ë£Œ ê·œì œ(íŠ¹ì • ë°©í–¥ì¡± ì•„ë¯¼)'],
      planning:{items:['ìˆ˜ì¶œ ëŒ€ìƒ íŒ¨ì…˜ ì•„ì´í…œ í™•ì •','ì¼ë³¸ ì„¬ìœ  í‘œì‹œë²• ê²€í† ','FOB ê°€ê²© í™•ì •','íƒ€ê²Ÿ ìœ í†µì±„ë„ ì„ ì • (ZOZOTOWN/ë¼ì¿ í…/ë°±í™”ì )','ì‹œì¦Œ ì¼ì • ìˆ˜ë¦½'],tip:'ì¼ë³¸ì€ ê°€ì •ìš©í’ˆí’ˆì§ˆí‘œì‹œë²•ìœ¼ë¡œ ì„¬ìœ  í‘œì‹œ ê·œì œ. ì¼ë³¸ì–´ ë¼ë²¨ í•„ìˆ˜!',time:'2-4ì£¼',cost:'$200-400'},
      certification:{items:['ê°€ì •ìš©í’ˆí’ˆì§ˆí‘œì‹œë²• ì í•©','ì¼ë³¸ì–´ ì„¬ìœ  ì„±ë¶„ í‘œì‹œ ë¼ë²¨','ì·¨ê¸‰ ì£¼ì˜ í‘œì‹œ(JIS L 0001)','ì•„ì¡°ì—¼ë£Œ ì‹œí—˜(í•´ë‹¹ì‹œ)','ì‚¬ì´ì¦ˆ í‘œì‹œ(JIS)'],tip:'ì¼ë³¸ì€ ì„¸íƒ í‘œì‹œê°€ JIS ê¸°ì¤€! êµ­ì œí‘œì‹œì™€ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ.',time:'2-4ì£¼',cost:'$300-1,000'},
      buyer_search:{items:['ì¼ë³¸ ì…€ë ‰íŠ¸ìˆ/í¸ì§‘ìˆ ì ‘ê·¼','ZOZOTOWN ì…ì  ê²€í† ','IFF MAGIC JAPAN ì „ì‹œíšŒ','K-Fashion ì „ë¬¸ ìˆ˜ì…ì‚¬ ì»¨íƒ','SNS ë§ˆì¼€íŒ… (ì¸ìŠ¤íƒ€ê·¸ë¨)'],tip:'ì¼ë³¸ì€ ì…€ë ‰íŠ¸ìˆ ë¬¸í™” ê°•í•¨. í¸ì§‘ìˆ ë°”ì´ì–´ ì ‘ê·¼ì´ íš¨ê³¼ì .',time:'4-8ì£¼',cost:'$800-2,500'},
      negotiation:{items:['ê°€ê²©í‘œ ì‘ì„± (ì—”í™”)','ê²°ì œ ì¡°ê±´ í˜‘ì˜','MOQ ì¡°ì •','ìƒ˜í”Œ ì˜¤ë”','ê³„ì•½ì„œ ê²€í† ','PI ë°œí–‰'],tip:'ì¼ë³¸ ë°”ì´ì–´ëŠ” í’ˆì§ˆ ì¼ê´€ì„±ê³¼ ë‚©ê¸° ì—„ìˆ˜ë¥¼ ë§¤ìš° ì¤‘ì‹œ!',time:'2-4ì£¼',cost:'$200-400'},
      production:{items:['ìƒì‚° ì¼ì • í™•ì •','ì¼ë³¸ ê·œê²© ì›ë¶€ìì¬ í™•ë³´','ìƒì‚° ì°©ìˆ˜','ì¤‘ê°„ QC','ì¼ë³¸ì–´ ë¼ë²¨ ë¶€ì°©','ìµœì¢… ê²€ìˆ˜'],tip:'ì¼ë³¸ì€ ë´‰ì œ í’ˆì§ˆì— ë§¤ìš° ë¯¼ê°. ì‹¤ë°¥ í•˜ë‚˜ë„ ë¶ˆëŸ‰!',time:'2-4ì£¼',cost:'ìƒì‚°ë¹„ ë³„ë„'},
      shipping:{items:['CI/PL ì‘ì„±','ì›ì‚°ì§€ì¦ëª…ì„œ ë°œê¸‰','ì„¬ìœ  í‘œì‹œ ì„œë¥˜','í¬ì›Œë” ì„ ì •','ì„ ì  ë° B/L ìˆ˜ë ¹'],tip:'ì¼ë³¸ê¹Œì§€ í•´ìƒ 3-5ì¼. í•œ-ì¼ RCEPìœ¼ë¡œ ê´€ì„¸ í˜œíƒ.',time:'2-4ì£¼',cost:'$800-2,000'},
      completed:{items:['ëŒ€ê¸ˆ ìˆ˜ë ¹ í™•ì¸','ë°”ì´ì–´ í”¼ë“œë°± ìˆ˜ì§‘','ì‹œì¦Œ ì¬ì£¼ë¬¸ í˜‘ì˜'],tip:'ì¼ë³¸ íŒ¨ì…˜ ì‹œì¥ì€ ì¶©ì„±ë„ ë†’ìŒ. í’ˆì§ˆ ìœ ì§€ê°€ í•µì‹¬!',time:'-',cost:'-'}
    }
  },
  'K-Electronics':{
    US:{
      certs:['FCC ì¸ì¦','UL ì•ˆì „ì¸ì¦(í•´ë‹¹ì‹œ)','ì—ë„ˆì§€ìŠ¤íƒ€(í•´ë‹¹ì‹œ)','ìº˜ë¦¬í¬ë‹ˆì•„ Prop 65'],
      planning:{items:['ìˆ˜ì¶œ ëŒ€ìƒ ì „ìì œí’ˆ í™•ì •','FCC ì¸ì¦ ìš”ê±´ í™•ì¸','UL/ETL ì•ˆì „ì¸ì¦ í•„ìš” ì—¬ë¶€','FOB ê°€ê²© í™•ì •','íƒ€ê²Ÿ ìœ í†µì±„ë„ ì„ ì • (ì•„ë§ˆì¡´/Best Buy)','ìˆ˜ì¶œ ì¼ì • ìˆ˜ë¦½'],tip:'ë¬´ì„  ê¸°ëŠ¥ ìˆìœ¼ë©´ FCC ID í•„ìˆ˜! ìœ ì„ ë§Œì´ë©´ FCC DoC(ìê¸°ì í•©ì„ ì–¸)ë¡œ ê°„ì†Œí™”.',time:'2-4ì£¼',cost:'$300-600'},
      certification:{items:['FCC ì¸ì¦ (ë¬´ì„ : FCC ID / ìœ ì„ : DoC)','EMC ì‹œí—˜ (ì „ìíŒŒ ì í•©ì„±)','UL/ETL ì•ˆì „ì¸ì¦ (í•´ë‹¹ì‹œ)','SAR ì‹œí—˜ (ì¸ì²´ ê·¼ì ‘ ì œí’ˆ)','ì—ë„ˆì§€ìŠ¤íƒ€ (ì—ë„ˆì§€ íš¨ìœ¨ ì œí’ˆ)','CA Prop 65 ê²½ê³ ë¬¸','ì˜ë¬¸ ì‚¬ìš©ì„¤ëª…ì„œ'],tip:'FCC ì‹œí—˜ì€ ì¸ì¦ ì‹œí—˜ì†Œ(TCB) ì´ìš©. EMC ë¶€ì í•©ì´ë©´ ì¬ì„¤ê³„ í•„ìš”í•  ìˆ˜ë„.',time:'2-6ê°œì›”',cost:'$5,000-20,000'},
      buyer_search:{items:['ì•„ë§ˆì¡´ Electronics ì¹´í…Œê³ ë¦¬ ì…ì ','CES ì „ì‹œíšŒ ì°¸ê°€/ë°©ë¬¸','ì „ìì œí’ˆ ì „ë¬¸ ìœ í†µì‚¬ ì»¨íƒ','í¬ë¼ìš°ë“œí€ë”© (í‚¥ìŠ¤íƒ€í„°/ì¸ë””ê³ ê³ )','í…Œí¬ ë¯¸ë””ì–´ ë¦¬ë·° í™•ë³´'],tip:'CESê°€ ìµœê³ ì˜ ì „ìì œí’ˆ ë°”ì´ì–´ ë°œêµ´ ì±„ë„! í‚¥ìŠ¤íƒ€í„°ë¡œ ì‹œì¥ ê²€ì¦ë„ ì¢‹ì€ ì „ëµ.',time:'4-10ì£¼',cost:'$2,000-5,000'},
      negotiation:{items:['ê°€ê²©í‘œ ì‘ì„±','ê²°ì œ ì¡°ê±´ í˜‘ì˜','MOQ ì¡°ì •','ìƒ˜í”Œ/í”„ë¡œí† íƒ€ì… ì œê³µ','A/S ì¡°ê±´ í˜‘ì˜','ê³„ì•½ì„œ ê²€í† ','PI ë°œí–‰'],tip:'ì „ìì œí’ˆì€ A/S ì •ì±…ì´ ì¤‘ìš”í•œ í˜‘ìƒ í¬ì¸íŠ¸!',time:'2-4ì£¼',cost:'$300-600'},
      production:{items:['ìƒì‚° ì¼ì • í™•ì •','ë¶€í’ˆ/PCB ì¡°ë‹¬','SMT/ì¡°ë¦½ ìƒì‚°','ê¸°ëŠ¥ ì‹œí—˜ (100% ì „ìˆ˜ê²€ì‚¬)','FCC/UL ë§ˆí¬ ë¶€ì°©','í¬ì¥ ë° ì‚¬ìš©ì„¤ëª…ì„œ ë™ë´‰'],tip:'ì „ìì œí’ˆì€ ë¶ˆëŸ‰ë¥  ê´€ë¦¬ í•µì‹¬. ì „ìˆ˜ê²€ì‚¬ ê¶Œì¥!',time:'4-8ì£¼',cost:'ìƒì‚°ë¹„ ë³„ë„'},
      shipping:{items:['CI/PL ì‘ì„±','ì›ì‚°ì§€ì¦ëª…ì„œ ë°œê¸‰','FCC/UL ì¸ì¦ì„œ ì‚¬ë³¸','ë°°í„°ë¦¬ í¬í•¨ ì‹œ MSDS/UN38.3','í¬ì›Œë” ì„ ì •','ì„ ì  ë° B/L ìˆ˜ë ¹'],tip:'ë¦¬íŠ¬ë°°í„°ë¦¬ í¬í•¨ ì œí’ˆì€ í•­ê³µ ìœ„í—˜ë¬¼ ê·œì • í™•ì¸! UN38.3 ì‹œí—˜ í•„ìˆ˜.',time:'3-5ì£¼',cost:'$2,000-5,000'},
      completed:{items:['ëŒ€ê¸ˆ ìˆ˜ë ¹ í™•ì¸','A/S ì²´ê³„ ê°€ë™','ë°”ì´ì–´/ì‚¬ìš©ì í”¼ë“œë°±','íŒì›¨ì–´ ì—…ë°ì´íŠ¸ ì§€ì›','ì¬ì£¼ë¬¸ í˜‘ì˜'],tip:'ì „ìì œí’ˆì€ ì¶œì‹œ í›„ A/Sì™€ íŒì›¨ì–´ ì—…ë°ì´íŠ¸ê°€ ì¬ì£¼ë¬¸ì˜ í•µì‹¬!',time:'-',cost:'-'}
    },
    EU:{
      certs:['CE ë§ˆí‚¹(EMC/LVD/RED)','RoHS','WEEE','REACH'],
      planning:{items:['ìˆ˜ì¶œ ëŒ€ìƒ ì „ìì œí’ˆ í™•ì •','CE ë§ˆí‚¹ ìš”ê±´ í™•ì¸ (EMC, LVD, RED)','RoHS/REACH ì í•© í™•ì¸','FOB ê°€ê²© í™•ì •','íƒ€ê²Ÿ êµ­ê°€ ì„ ì •','ìˆ˜ì¶œ ì¼ì • ìˆ˜ë¦½'],tip:'EUëŠ” CE ë§ˆí‚¹ì´ í•„ìˆ˜! ë¬´ì„ ê¸°ê¸°ëŠ” RED(Radio Equipment Directive) ì¶”ê°€.',time:'2-4ì£¼',cost:'$300-600'},
      certification:{items:['CE ë§ˆí‚¹ (EMC Directive 2014/30/EU)','LVD (Low Voltage Directive) ì‹œí—˜','RED ì¸ì¦ (ë¬´ì„ ê¸°ê¸° í•´ë‹¹ì‹œ)','RoHS ì í•© (ìœ í•´ë¬¼ì§ˆ ì œí•œ)','WEEE ë“±ë¡ (ì „ìíê¸°ë¬¼ ì¬í™œìš©)','REACH ì í•©','ê¸°ìˆ ë¬¸ì„œ(TCF) ì‘ì„±','ì í•©ì„±ì„ ì–¸ì„œ(DoC)'],tip:'CEëŠ” ìê¸°ì¸ì¦ì´ì§€ë§Œ, NB(ê³µì¸ê¸°ê´€) ì‹œí—˜ ë³´ê³ ì„œ ê°•ë ¥ ê¶Œì¥!',time:'3-6ê°œì›”',cost:'$5,000-25,000'},
      buyer_search:{items:['ìœ ëŸ½ ì „ìì œí’ˆ ìœ í†µì‚¬ ì»¨íƒ','ì•„ë§ˆì¡´ EU ì…ì ','IFA Berlin ì „ì‹œíšŒ','MWC Barcelona (ëª¨ë°”ì¼ ê¸°ê¸°)','í…Œí¬ ë¯¸ë””ì–´ ì ‘ê·¼'],tip:'IFA(ë…ì¼)ì™€ MWC(ìŠ¤í˜ì¸)ê°€ ìœ ëŸ½ ì–‘ëŒ€ ì „ì ì „ì‹œíšŒ.',time:'4-10ì£¼',cost:'$2,000-5,000'},
      negotiation:{items:['ê°€ê²©í‘œ ì‘ì„± (ìœ ë¡œ)','ê²°ì œ ì¡°ê±´ í˜‘ì˜','MOQ ì¡°ì •','A/S ì¡°ê±´ í˜‘ì˜ (EU 2ë…„ ë³´ì¦)','ê³„ì•½ì„œ ê²€í† ','PI ë°œí–‰'],tip:'EUëŠ” ì†Œë¹„ì 2ë…„ ë³´ì¦ ì˜ë¬´! A/S ì²´ê³„ ì‚¬ì „ êµ¬ì¶•.',time:'3-5ì£¼',cost:'$300-600'},
      production:{items:['ìƒì‚° ì¼ì • í™•ì •','RoHS ì í•© ë¶€í’ˆ ì¡°ë‹¬','ìƒì‚° ì°©ìˆ˜','ê¸°ëŠ¥/ì•ˆì „ ì‹œí—˜','CE ë§ˆí¬ ë¶€ì°©','EU ê·œê²© í¬ì¥/ì„¤ëª…ì„œ'],tip:'RoHS ë¶€ì í•© ë¶€í’ˆ í˜¼ì… ì£¼ì˜! ê³µê¸‰ì—…ì²´ RoHS ì¸ì¦ì„œ í™•ë³´.',time:'4-8ì£¼',cost:'ìƒì‚°ë¹„ ë³„ë„'},
      shipping:{items:['CI/PL ì‘ì„±','ì›ì‚°ì§€ì¦ëª…ì„œ ë°œê¸‰','CE/RoHS ì í•© ì„œë¥˜','ë°°í„°ë¦¬ MSDS (í•´ë‹¹ì‹œ)','í¬ì›Œë” ì„ ì •','ì„ ì  ë° B/L ìˆ˜ë ¹','EU í†µê´€'],tip:'í•œ-EU FTA í™œìš©! ì „ìì œí’ˆ ê´€ì„¸ ëŒ€ë¶€ë¶„ 0%.',time:'4-6ì£¼',cost:'$2,500-6,000'},
      completed:{items:['ëŒ€ê¸ˆ ìˆ˜ë ¹ í™•ì¸','WEEE ë“±ë¡ ìœ ì§€','A/S ì²´ê³„ ìš´ì˜','ì¬ì£¼ë¬¸ í˜‘ì˜'],tip:'WEEE ë“±ë¡ì€ ë§¤ë…„ ê°±ì‹ ! ìŠì§€ ë§ˆì„¸ìš”.',time:'-',cost:'-'}
    },
    AE:{
      certs:['ECAS ì í•©ì„± ì¸ì¦','EmiratesQM','TRA ë¬´ì„ ê¸°ê¸° ë“±ë¡'],
      planning:{items:['ìˆ˜ì¶œ ëŒ€ìƒ ì „ìì œí’ˆ í™•ì •','UAE ECAS ì¸ì¦ ìš”ê±´ í™•ì¸','TRA ë“±ë¡ (ë¬´ì„ ê¸°ê¸°)','FOB ê°€ê²© í™•ì •','íƒ€ê²Ÿ ìœ í†µì±„ë„ ì„ ì • (ë‘ë°”ì´ ì „ììƒê°€/ì˜¨ë¼ì¸)','ìˆ˜ì¶œ ì¼ì • ìˆ˜ë¦½'],tip:'UAEëŠ” ECAS ì¸ì¦ í•„ìˆ˜! ë¬´ì„ ê¸°ê¸°ëŠ” TRA ì¶”ê°€ ë“±ë¡.',time:'2-4ì£¼',cost:'$300-600'},
      certification:{items:['ECAS ì¸ì¦ ì‹ ì²­','IEC/EN ì‹œí—˜ ë³´ê³ ì„œ ì¤€ë¹„','TRA ë¬´ì„ ê¸°ê¸° ë“±ë¡ (í•´ë‹¹ì‹œ)','ì•„ëì–´ ë¼ë²¨/ì„¤ëª…ì„œ','ì í•©ì„± ì¸ì¦ì„œ ì·¨ë“'],tip:'ECASëŠ” CB ì¸ì¦ì„œ ê¸°ë°˜ìœ¼ë¡œ ë¹ ë¥´ê²Œ ì·¨ë“ ê°€ëŠ¥.',time:'2-4ê°œì›”',cost:'$2,000-8,000'},
      buyer_search:{items:['ë‘ë°”ì´ ì „ìì œí’ˆ ìœ í†µì‚¬ ì»¨íƒ','GITEX ì „ì‹œíšŒ ì°¸ê°€','ì¤‘ë™ ì˜¨ë¼ì¸ëª° (noon.com)','ì¬ìˆ˜ì¶œ(Re-export) ì—ì´ì „íŠ¸'],tip:'ë‘ë°”ì´ëŠ” ì¤‘ë™/ì•„í”„ë¦¬ì¹´ ì¬ìˆ˜ì¶œ í—ˆë¸Œ! í•œ ê³³ ì§„ì…ìœ¼ë¡œ ë„“ì€ ì‹œì¥ ì»¤ë²„.',time:'4-8ì£¼',cost:'$1,000-3,000'},
      negotiation:{items:['ê°€ê²©í‘œ ì‘ì„± (USD/AED)','ê²°ì œ ì¡°ê±´ í˜‘ì˜','MOQ ì¡°ì •','A/S ì¡°ê±´','ê³„ì•½ì„œ ê²€í† ','PI ë°œí–‰'],tip:'ì¤‘ë™ ë°”ì´ì–´ëŠ” ì‹ ë¢° ê´€ê³„ ì¤‘ì‹œ. ëŒ€ë©´ ë¯¸íŒ… íš¨ê³¼ì .',time:'2-4ì£¼',cost:'$300-600'},
      production:{items:['ìƒì‚° ì¼ì • í™•ì •','ìƒì‚° ì°©ìˆ˜','ê¸°ëŠ¥ ì‹œí—˜','ECAS ë§ˆí¬ ë¶€ì°©','ì•„ëì–´ í¬ì¥/ì„¤ëª…ì„œ','ìµœì¢… ê²€ìˆ˜'],tip:'ì•„ëì–´ í‘œê¸°ì™€ ì „ì•• í˜¸í™˜ì„±(220V/50Hz) í™•ì¸!',time:'4-8ì£¼',cost:'ìƒì‚°ë¹„ ë³„ë„'},
      shipping:{items:['CI/PL ì‘ì„±','ì›ì‚°ì§€ì¦ëª…ì„œ ë°œê¸‰','ECAS ì¸ì¦ì„œ','í¬ì›Œë” ì„ ì •','ì„ ì  ë° B/L ìˆ˜ë ¹','ë‘ë°”ì´ í†µê´€'],tip:'ë‘ë°”ì´ê¹Œì§€ í•´ìƒ ì•½ 20ì¼. í•­ê³µì€ 1-2ì¼.',time:'3-5ì£¼',cost:'$1,500-4,000'},
      completed:{items:['ëŒ€ê¸ˆ ìˆ˜ë ¹ í™•ì¸','A/S ì„¼í„° ìš´ì˜','ì¬ì£¼ë¬¸ í˜‘ì˜','ì¤‘ë™ íƒ€ êµ­ê°€ í™•ì¥'],tip:'ë‘ë°”ì´ ì„±ê³µ ì‹œ GCC 6ê°œêµ­ + ì•„í”„ë¦¬ì¹´ í™•ì¥ ìš©ì´!',time:'-',cost:'-'}
    }
  },
  'K-Living':{
    US:{
      certs:['CPSC ì•ˆì „ê¸°ì¤€','CPSIA (ì•„ë™ìš©)','CA Prop 65','ASTM ê¸°ì¤€(í•´ë‹¹ì‹œ)'],
      planning:{items:['ìˆ˜ì¶œ ëŒ€ìƒ ìƒí™œìš©í’ˆ í™•ì •','CPSC ì•ˆì „ê¸°ì¤€ í™•ì¸','FDA ê·œì • í™•ì¸ (ì‹ê¸°ë¥˜)','FOB ê°€ê²© í™•ì •','íƒ€ê²Ÿ ìœ í†µì±„ë„ ì„ ì • (ì•„ë§ˆì¡´/Target/TJ Maxx)','ìˆ˜ì¶œ ì¼ì • ìˆ˜ë¦½'],tip:'ì‹ê¸°ë¥˜ëŠ” FDA ì‹í’ˆì ‘ì´‰ë¬¼ì§ˆ ê·œì • ì ìš©! ì¼ë°˜ ìƒí™œìš©í’ˆì€ CPSC.',time:'2-4ì£¼',cost:'$200-500'},
      certification:{items:['CPSC ì•ˆì „ê¸°ì¤€ ì í•©','FDA ì‹í’ˆì ‘ì´‰ë¬¼ì§ˆ ì‹œí—˜ (ì‹ê¸°ë¥˜)','CPSIA ì‹œí—˜ (ì•„ë™ìš© ì œí’ˆ)','CA Prop 65 ê²½ê³ ë¬¸','ASTM ì‹œí—˜ (í•´ë‹¹ ì œí’ˆêµ°)','ì˜ë¬¸ ì‚¬ìš©ì„¤ëª…ì„œ/ê²½ê³ ë¬¸'],tip:'ì‹ê¸°ëŠ” FDA ì¤‘ê¸ˆì† ìš©ì¶œ ì‹œí—˜! ì£¼ë°©ìš©í’ˆì€ ì¬ì§ˆë³„ ê¸°ì¤€ ë‹¤ë¦„.',time:'2-6ì£¼',cost:'$500-3,000'},
      buyer_search:{items:['ì•„ë§ˆì¡´ Home & Kitchen ì…ì ','NY NOW / Atlanta Market ì „ì‹œíšŒ','í™ˆë¦¬ë¹™ ì „ë¬¸ ë°”ì´ì–´ ì ‘ê·¼','í¬ë˜í”„íŠ¸/ë””ìì¸ í¸ì§‘ìˆ ì»¨íƒ','ì¸ìŠ¤íƒ€ê·¸ë¨ ì¸í…Œë¦¬ì–´ ì¸í”Œë£¨ì–¸ì„œ'],tip:'í•œêµ­ í™ˆë¦¬ë¹™ì€ ë””ìì¸ì´ ê°•ì ! ë¹„ì£¼ì–¼ ì¤‘ì‹¬ ë§ˆì¼€íŒ… íš¨ê³¼ì .',time:'4-8ì£¼',cost:'$800-2,500'},
      negotiation:{items:['ê°€ê²©í‘œ ì‘ì„±','ê²°ì œ ì¡°ê±´ í˜‘ì˜','MOQ ì¡°ì •','ìƒ˜í”Œ ì˜¤ë”','ê³„ì•½ì„œ ê²€í† ','PI ë°œí–‰'],tip:'í™ˆë¦¬ë¹™ì€ ê³„ì ˆ/íŠ¸ë Œë“œ ë³€ë™ì´ í¬ë¯€ë¡œ ì†ŒëŸ‰ ì²« ì˜¤ë” ê¶Œì¥.',time:'2-4ì£¼',cost:'$200-500'},
      production:{items:['ìƒì‚° ì¼ì • í™•ì •','ë¯¸êµ­ ì•ˆì „ê¸°ì¤€ ì í•© ì›ìì¬ í™•ë³´','ìƒì‚° ì°©ìˆ˜','ì¤‘ê°„ QC','ë¼ë²¨/ê²½ê³ ë¬¸ ë¶€ì°©','í¬ì¥ ë° ì¶œí•˜'],tip:'ê¹¨ì§€ê¸° ì‰¬ìš´ ì œí’ˆì€ í¬ì¥ ê°•í™”! ìš´ì†¡ ì¤‘ íŒŒì† ë°©ì§€.',time:'2-4ì£¼',cost:'ìƒì‚°ë¹„ ë³„ë„'},
      shipping:{items:['CI/PL ì‘ì„±','ì›ì‚°ì§€ì¦ëª…ì„œ ë°œê¸‰','ì•ˆì „ì„± ì‹œí—˜ ì„œë¥˜','í¬ì›Œë” ì„ ì •','ì„ ì  ë° B/L ìˆ˜ë ¹','ë¯¸êµ­ í†µê´€'],tip:'í•œ-ë¯¸ FTAë¡œ ìƒí™œìš©í’ˆ ëŒ€ë¶€ë¶„ ê´€ì„¸ ë©´ì œ!',time:'3-5ì£¼',cost:'$1,500-4,000'},
      completed:{items:['ëŒ€ê¸ˆ ìˆ˜ë ¹ í™•ì¸','ë°”ì´ì–´/ì†Œë¹„ì í”¼ë“œë°±','ë¦¬ë·° ê´€ë¦¬','ì¬ì£¼ë¬¸ í˜‘ì˜'],tip:'ì•„ë§ˆì¡´ ë¦¬ë·°ê°€ ë§¤ì¶œ ì§ê²°! ì´ˆê¸° ë¦¬ë·° í™•ë³´ ì „ëµ ì¤‘ìš”.',time:'-',cost:'-'}
    },
    AU:{
      certs:['ACCC ì œí’ˆì•ˆì „ê¸°ì¤€','í˜¸ì£¼ ì‹í’ˆì ‘ì´‰ë¬¼ì§ˆ ê¸°ì¤€(ì‹ê¸°)','ë¼ë²¨ë§ ê·œì •(ì˜ë¬¸)'],
      planning:{items:['ìˆ˜ì¶œ ëŒ€ìƒ ìƒí™œìš©í’ˆ í™•ì •','ACCC ì•ˆì „ê¸°ì¤€ í™•ì¸','í˜¸ì£¼ ê·œê²©(AS/NZS) í™•ì¸','FOB ê°€ê²© í™•ì •','íƒ€ê²Ÿ ìœ í†µì±„ë„ ì„ ì •','ìˆ˜ì¶œ ì¼ì • ìˆ˜ë¦½'],tip:'í˜¸ì£¼ëŠ” AS/NZS í‘œì¤€ ì ìš©. ë‰´ì§ˆëœë“œì™€ ê³µë™ ê·œê²©!',time:'2-4ì£¼',cost:'$200-500'},
      certification:{items:['ACCC ì œí’ˆì•ˆì „ê¸°ì¤€ ì í•©','AS/NZS ê´€ë ¨ ì‹œí—˜','ì‹í’ˆì ‘ì´‰ ì‹œí—˜ (ì‹ê¸°ë¥˜)','ì˜ë¬¸ ë¼ë²¨/ê²½ê³ ë¬¸','ì›ì‚°ì§€ í‘œì‹œ'],tip:'í˜¸ì£¼ëŠ” í•œ-í˜¸ì£¼ FTA(KAFTA)ë¡œ ê´€ì„¸ í˜œíƒ!',time:'2-4ì£¼',cost:'$500-2,000'},
      buyer_search:{items:['í˜¸ì£¼ í™ˆë¦¬ë¹™ ìˆ˜ì…ì‚¬ ì»¨íƒ','Reed Gift Fairs ì „ì‹œíšŒ','ì•„ë§ˆì¡´ í˜¸ì£¼ ì…ì ','í•œêµ­ ìƒí™œìš©í’ˆ ì „ë¬¸ ìœ í†µì‚¬'],tip:'í˜¸ì£¼ ì‹œì¥ì€ í•œêµ­ ë””ìì¸ ìˆ˜ìš” ì¦ê°€! K-Living íŠ¸ë Œë“œ.',time:'4-8ì£¼',cost:'$800-2,500'},
      negotiation:{items:['ê°€ê²©í‘œ ì‘ì„± (AUD)','ê²°ì œ ì¡°ê±´ í˜‘ì˜','MOQ ì¡°ì •','ìƒ˜í”Œ ì˜¤ë”','ê³„ì•½ì„œ ê²€í† ','PI ë°œí–‰'],tip:'í˜¸ì£¼ ë°”ì´ì–´ëŠ” ì§€ì†ê°€ëŠ¥ì„± ì¤‘ì‹œ. ì¹œí™˜ê²½ í¬ì¥ ê¶Œì¥.',time:'2-4ì£¼',cost:'$200-400'},
      production:{items:['ìƒì‚° ì¼ì • í™•ì •','í˜¸ì£¼ ê·œê²© ì í•© ì›ìì¬','ìƒì‚° ì°©ìˆ˜','ì¤‘ê°„ QC','ì˜ë¬¸ ë¼ë²¨ ë¶€ì°©','ìµœì¢… ê²€ìˆ˜'],tip:'í˜¸ì£¼ëŠ” ê²€ì—­ì´ ë§¤ìš° ì—„ê²©! ëª©ì¬/ì‹ë¬¼ ì†Œì¬ëŠ” í›ˆì¦ í•„ìš”.',time:'2-4ì£¼',cost:'ìƒì‚°ë¹„ ë³„ë„'},
      shipping:{items:['CI/PL ì‘ì„±','ì›ì‚°ì§€ì¦ëª…ì„œ ë°œê¸‰','KAFTA FTA ì„œë¥˜','ê²€ì—­ ì„œë¥˜ (ëª©ì¬/ì‹ë¬¼ ì†Œì¬)','í¬ì›Œë” ì„ ì •','ì„ ì  ë° B/L ìˆ˜ë ¹'],tip:'í˜¸ì£¼ê¹Œì§€ í•´ìƒ 15-20ì¼. ê²€ì—­ ì„œë¥˜ ì² ì €íˆ!',time:'4-6ì£¼',cost:'$2,000-5,000'},
      completed:{items:['ëŒ€ê¸ˆ ìˆ˜ë ¹ í™•ì¸','ë°”ì´ì–´ í”¼ë“œë°±','ì¬ì£¼ë¬¸ í˜‘ì˜','ë‰´ì§ˆëœë“œ í™•ì¥ ê²€í† '],tip:'í˜¸ì£¼ ì„±ê³µ â†’ ë‰´ì§ˆëœë“œ ë™ì‹œ ì§„ì¶œ ìš©ì´(ê°™ì€ ê·œê²©)!',time:'-',cost:'-'}
    }
  },
  _default:{
    _default:{
      certs:['ìˆ˜ì¶œ ëŒ€ìƒêµ­ ì¸ì¦ í™•ì¸'],
      planning:{items:['ìˆ˜ì¶œ ëŒ€ìƒ ì œí’ˆ í™•ì •','íƒ€ê²Ÿ ì‹œì¥ ì„ ì •','FOB ê°€ê²© í™•ì •','ìˆ˜ì¶œ ì¼ì • ìˆ˜ë¦½'],tip:'ì œí’ˆ ì¹´í…Œê³ ë¦¬ì™€ íƒ€ê²Ÿ ì‹œì¥ì— ë”°ë¼ í•„ìš”í•œ ì¸ì¦ì´ ë‹¬ë¼ì§‘ë‹ˆë‹¤.',time:'2-4ì£¼',cost:'$200-500'},
      certification:{items:['í•„ìš” ì¸ì¦ ëª©ë¡ í™•ì¸','ì¸ì¦ ê¸°ê´€ ì„ ì •','ì„œë¥˜ ì¤€ë¹„ ë° ì œì¶œ','ì¸ì¦ ì·¨ë“ ì™„ë£Œ'],tip:'ìˆ˜ì¶œ ì „ ë°˜ë“œì‹œ íƒ€ê²Ÿ êµ­ê°€ì˜ í•„ìˆ˜ ì¸ì¦ì„ í™•ì¸í•˜ì„¸ìš”.',time:'4-8ì£¼',cost:'$1,000-5,000'},
      buyer_search:{items:['ë°”ì´ì–´ ë¦¬ìŠ¤íŠ¸ í™•ë³´','ì½œë“œì´ë©”ì¼ ë°œì†¡','ìƒ˜í”Œ ìš”ì²­ ëŒ€ì‘','ë°”ì´ì–´ ë¯¸íŒ… ì§„í–‰'],tip:'ì•Œë¦¬ë°”ë°” RFQ + ì „ì‹œíšŒê°€ ê°€ì¥ íš¨ê³¼ì ì¸ ë°”ì´ì–´ ë°œêµ´ ì±„ë„.',time:'4-8ì£¼',cost:'$500-2,000'},
      negotiation:{items:['ê°€ê²© í˜‘ìƒ','ê²°ì œ ì¡°ê±´ í˜‘ì˜','ê³„ì•½ì„œ ê²€í† ','PI ë°œí–‰'],tip:'ì²« ê±°ë˜ëŠ” T/T ì„ ê²°ì œ ê¶Œì¥.',time:'2-4ì£¼',cost:'$200-500'},
      production:{items:['ìƒì‚° ì¼ì • í™•ì •','ìƒì‚° ì°©ìˆ˜','ì¤‘ê°„ ê²€ìˆ˜ (QC)','í¬ì¥ ë° ë¼ë²¨ë§','ìµœì¢… ê²€ìˆ˜ ë° ì¶œí•˜ ì¤€ë¹„'],tip:'ë°”ì´ì–´ê°€ ì œ3ì ê²€ìˆ˜ë¥¼ ìš”ì²­í•˜ë©´ ë°˜ë“œì‹œ ìˆ˜ìš©í•˜ì„¸ìš”.',time:'2-4ì£¼',cost:'ìƒì‚°ë¹„ ë³„ë„'},
      shipping:{items:['CI/PL ì‘ì„±','í†µê´€ ì„œë¥˜ ì¤€ë¹„','í¬ì›Œë” ì„ ì •','ì„ ì  ì™„ë£Œ','B/L ìˆ˜ë ¹'],tip:'FTA ì›ì‚°ì§€ì¦ëª…ì„œë¥¼ ê¼­ ì±™ê¸°ì„¸ìš”! ê´€ì„¸ ì ˆê° ê°€ëŠ¥.',time:'3-6ì£¼',cost:'$1,500-5,000'},
      completed:{items:['ëŒ€ê¸ˆ ìˆ˜ë ¹ í™•ì¸','ì‚¬í›„ ê´€ë¦¬ ê³„íš','ì¬ì£¼ë¬¸ í˜‘ì˜'],tip:'ì²« ê±°ë˜ ì„±ê³µì´ ê°€ì¥ ì¤‘ìš”. ì¬ì£¼ë¬¸ë¥ ì„ ë†’ì´ì„¸ìš”!',time:'-',cost:'-'}
    }
  }
};

function getRoadmap(category,market){
  var cat=CATEGORY_ROADMAPS[category]||CATEGORY_ROADMAPS._default;
  return cat[market]||cat._default||CATEGORY_ROADMAPS._default._default;
}

function buildStageProgress(category,market,existingCerts){
  var rm=getRoadmap(category,market);
  var stages=['planning','certification','buyer_search','negotiation','production','shipping','completed'];
  var sp={};
  stages.forEach(function(stage){
    var stageRM=rm[stage]||STAGE_DEFAULTS[stage];
    sp[stage]=(stageRM.items||stageRM).map(function(item){
      var text=typeof item==='string'?item:item.text;
      return{text:text,done:false};
    });
  });
  var certs=(existingCerts||rm.certs||[]).map(function(c){
    var name=typeof c==='string'?c:c.name;
    return{name:name,status:'pending'};
  });
  sp.certs=certs;
  sp._roadmap={category:category,market:market};
  return sp;
}

function createPj(aid){
  var g=_planGate('project');if(g.blocked){UI.toast(g.label+' í•œë„ ì´ˆê³¼! ì—…ê·¸ë ˆì´ë“œê°€ í•„ìš”í•©ë‹ˆë‹¤.','warn');nav('subscription');return;}
  var a=S.analyses.find(function(x){return x.id===aid;});if(!a)return;
  var linkedProd=S.products.find(function(p){return p.analysis_id===aid;});
  var category=(a.ai_result&&a.ai_result.category)||(linkedProd&&linkedProd.category)||'Other';
  var markets=a.ai_result&&a.ai_result.recommended_markets||['US'];
  var primaryMarket=markets[0]||'US';
  var aiCerts=a.ai_result&&a.ai_result.required_certs||[];
  var initProgress=buildStageProgress(category,primaryMarket,aiCerts.length?aiCerts:null);
  sb.from('projects').insert({user_id:S.user.id,analysis_id:aid,product_id:linkedProd?linkedProd.id:null,name:a.product_name+' ìˆ˜ì¶œ í”„ë¡œì íŠ¸',target_countries:markets,status:'planning',stage_progress:initProgress}).then(function(r){
    if(r.error){UI.toast('ì‹¤íŒ¨','err');return;}loadPr().then(function(){set({page:'projects',currentAnalysis:null});UI.toast('í”„ë¡œì íŠ¸ ìƒì„±! ì¹´í…Œê³ ë¦¬ë³„ ë¡œë“œë§µì´ ìë™ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤','ok');});
  });
}

function pgProducts(){
  return '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px"><div><h2 style="font-size:18px;font-weight:800">ğŸ“¦ ì œí’ˆ ì¹´ë“œ</h2></div><button class="btn btn-pri" onclick="App.showPF()">+ ë“±ë¡</button></div>'+(S.products.length===0?'<div class="card"><div class="card-b">'+UI.empty('ğŸ“¦','ë“±ë¡ ì œí’ˆ ì—†ìŒ','ì œí’ˆì„ ë“±ë¡í•˜ë©´ ë°”ì´ì–´ì—ê²Œ ë…¸ì¶œë©ë‹ˆë‹¤')+'<div style="text-align:center;margin-top:12px"><button class="btn btn-pri" onclick="App.showPF()">ì²« ì œí’ˆ ë“±ë¡</button></div></div></div>':'<div class="grid-3">'+S.products.map(function(p){return '<div class="prod-card"><div class="prod-img" onclick="App.editP(\''+p.id+'\')" style="position:relative">'+(p.images&&p.images[0]?'<img src="'+p.images[0]+'" style="width:100%;height:100%;object-fit:cover">':'ğŸ“¦')+'</div><div class="prod-body"><div style="display:flex;justify-content:space-between;align-items:start"><div onclick="App.editP(\''+p.id+'\')" style="cursor:pointer;flex:1"><div class="prod-name">'+U.tr(p.name_ko,25)+'</div><div class="prod-meta">'+(p.category||'ë¯¸ì„¤ì •')+' Â· FOB '+(p.fob_price?U.fmtUSD(p.fob_price):'ë¯¸ì„¤ì •')+'</div><div class="prod-meta" style="margin-top:4px">MOQ: '+(p.moq||'â€”')+'</div></div><div style="display:flex;flex-direction:column;gap:4px;align-items:flex-end">'+UI.sb(p.status)+'<button class="btn btn-danger btn-sm" onclick="App.delP(\''+p.id+'\')" style="font-size:10px;padding:2px 6px;margin-top:4px">ì‚­ì œ</button></div></div></div></div>';}).join('')+'<div class="prod-card" onclick="App.showPF()" style="display:flex;align-items:center;justify-content:center;min-height:200px;border-style:dashed"><div style="text-align:center;color:var(--w20)"><div style="font-size:32px">+</div><div style="font-size:13px">ì¶”ê°€</div></div></div></div>');
}

function showPF(p){
  if(!p){var g=_planGate('product');if(g.blocked){UI.toast(g.label+' í•œë„ ì´ˆê³¼! ì—…ê·¸ë ˆì´ë“œê°€ í•„ìš”í•©ë‹ˆë‹¤.','warn');nav('subscription');return;}}
  p=p||{};var body='<form id="pf">'+
    '<div style="margin-bottom:14px"><label class="form-label">ëŒ€í‘œ ì´ë¯¸ì§€</label><div style="display:flex;gap:12px;align-items:start"><div style="width:100px;height:100px;border-radius:10px;border:2px dashed var(--bd-l);display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden;flex-shrink:0;background:var(--sf)" onclick="document.getElementById(\'prodImg\').click()" id="prodImgBox">'+(p.images&&p.images[0]?'<img src="'+p.images[0]+'" style="width:100%;height:100%;object-fit:cover">':'<div style="text-align:center;color:var(--w20)"><div style="font-size:24px">ğŸ“·</div><div style="font-size:10px">í´ë¦­</div></div>')+'</div><div style="flex:1"><input class="form-input" name="image_url" placeholder="ì´ë¯¸ì§€ URL ì§ì ‘ ì…ë ¥" value="'+(p.images&&p.images[0]||'')+'" oninput="App.prevImg(this.value)"><div style="font-size:10px;color:var(--w20);margin-top:4px">ì´ë¯¸ì§€ íŒŒì¼ ì„ íƒ ë˜ëŠ” URL ì…ë ¥</div><input type="file" id="prodImg" accept="image/*" style="display:none" onchange="App.prodImgFile(this.files[0])"></div></div></div>'+
    '<div class="grid-2">'+UI.inp('name_ko','ì œí’ˆëª…(í•œê¸€)*',{value:p.name_ko||'',required:true})+UI.inp('name_en','ì œí’ˆëª…(ì˜ë¬¸)',{value:p.name_en||''})+'</div>'+UI.ta('description_en','ì„¤ëª…(ì˜ë¬¸)',{value:p.description_en||''})+(p.id?'<div style="margin:-8px 0 14px"><button class="btn btn-acc btn-sm" onclick="App.genCatalogEN(\''+p.id+'\')">AI ì˜ë¬¸ ì¹´íƒˆë¡œê·¸ ìƒì„±</button></div>':'')+'<div class="grid-2">'+UI.sel('category','ì¹´í…Œê³ ë¦¬',U.CAT,p.category||'')+UI.inp('hs_code','HS Code',{value:p.hs_code||''})+'</div>'+
    '<div class="form-group"><label class="form-label">ë‹¨ê°€ (â‚© ì›í™” â†’ USD ìë™ í™˜ì‚°)</label><div style="display:flex;gap:10px;align-items:center"><div style="flex:1;position:relative"><span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--w40);font-size:13px">â‚©</span><input class="form-input" name="price_krw" type="number" value="'+(p.fob_price?Math.round(p.fob_price*(S.exchangeRate||1400)):'')+'" placeholder="7,000" style="padding-left:28px" oninput="var u=document.querySelector(\'[name=fob_price]\');if(u)u.value=(this.value/(window._exRate||1400)).toFixed(2);var s=document.getElementById(\'pusd\');if(s)s.textContent=this.value?\'â‰ˆ $\'+(this.value/(window._exRate||1400)).toFixed(2):\'\';"></div><span style="font-size:13px;color:var(--pri);font-weight:600;font-family:JetBrains Mono;min-width:80px" id="pusd">'+(p.fob_price?'â‰ˆ $'+p.fob_price:'')+'</span><input type="hidden" name="fob_price" value="'+(p.fob_price||'')+'"></div></div>'+
    '<div class="grid-2">'+UI.inp('moq','MOQ',{type:'number',value:p.moq||''})+UI.inp('lead_time','ë¦¬ë“œíƒ€ì„',{value:p.lead_time||''})+'</div></form>';
  document.body.insertAdjacentHTML('beforeend',UI.modal({id:'pm',title:p.id?'ì œí’ˆ ìˆ˜ì •':'ì œí’ˆ ë“±ë¡',body:body,footer:'<button class="btn btn-ghost" onclick="App.closeModal(\'pm\')">ì·¨ì†Œ</button><button class="btn btn-pri" onclick="App.saveP(\''+(p.id||'')+'\')">ì €ì¥</button>',width:'640px'}));UI.showModal('pm');
}

function prevImg(url){var box=document.getElementById('prodImgBox');if(box)box.innerHTML=url?'<img src="'+url+'" style="width:100%;height:100%;object-fit:cover">':'<div style="text-align:center;color:var(--w20)"><div style="font-size:24px">ğŸ“·</div><div style="font-size:10px">í´ë¦­</div></div>';}
function prodImgFile(f){if(!f)return;var r=new FileReader();r.onload=function(e){var url=e.target.result;prevImg(url);var inp=document.querySelector('[name=image_url]');if(inp)inp.value=url;};r.readAsDataURL(f);}

function saveP(id){
  var d=UI.fd('#pf');if(!d.name_ko){UI.toast('ì œí’ˆëª… ì…ë ¥','warn');return;}
  delete d.price_krw;if(d.image_url){d.images=[d.image_url];delete d.image_url;}
  var q=id?sb.from('products').update(d).eq('id',id):sb.from('products').insert(Object.assign(d,{user_id:S.user.id,status:'draft'}));
  q.then(function(r){if(r.error){UI.toast('ì‹¤íŒ¨','err');return;}closeModal('pm');loadP().then(function(){render();UI.toast(id?'ìˆ˜ì •!':'ë“±ë¡!','ok');});});
}

function editP(id){var p=S.products.find(function(x){return x.id===id;});if(p)showPF(p);}

function delP(id){if(!confirm('ì´ ì œí’ˆì„ ì‚­ì œí• ê¹Œìš”?'))return;sb.from('products').delete().eq('id',id).eq('user_id',S.user.id).then(function(r){if(r.error){UI.toast('ì‚­ì œ ì‹¤íŒ¨','err');return;}loadP().then(function(){render();UI.toast('ì‚­ì œ ì™„ë£Œ','ok');});});}

function delA(id){if(!confirm('ì´ ë¶„ì„ì„ ì‚­ì œí• ê¹Œìš”?'))return;sb.from('analyses').delete().eq('id',id).eq('user_id',S.user.id).then(function(r){if(r.error){UI.toast('ì‚­ì œ ì‹¤íŒ¨','err');return;}loadA().then(function(){render();UI.toast('ì‚­ì œ ì™„ë£Œ','ok');});});}

function pgServices(){
  var svcs=[{type:'premium_analysis',name:'í”„ë¦¬ë¯¸ì—„ AI ë¶„ì„',icon:'ğŸ”¬',desc:'ì „ë¬¸ê°€ ê²€ìˆ˜ ì‹¬ì¸µ ë¦¬í¬íŠ¸',price:'â‚©300~500K'},{type:'matching',name:'ë°”ì´ì–´ ë§¤ì¹­',icon:'ğŸ¤',desc:'ê²€ì¦ëœ í•´ì™¸ ë°”ì´ì–´ ë°œêµ´',price:'â‚©1~3M+2~5%'},{type:'document',name:'ì„œë¥˜ ëŒ€í–‰',icon:'ğŸ“„',desc:'PI, CI, PL, CO ì‘ì„±',price:'â‚©200~500K'},{type:'certification',name:'ì¸ì¦ ëŒ€í–‰',icon:'ğŸ…',desc:'FDA, CE, CPNP ì·¨ë“',price:'â‚©2~10M'},{type:'logistics',name:'ë¬¼ë¥˜/í†µê´€',icon:'ğŸš¢',desc:'ìš´ì†¡, í†µê´€, ë³´í—˜ ì¼ê´„',price:'â‚©500K~2M'},{type:'email_support',name:'ì´ë©”ì¼ ì§€ì›',icon:'âœ‰ï¸',desc:'ë°”ì´ì–´ ì†Œí†µ ë²ˆì—­ëŒ€í–‰',price:'â‚©200~500K/ì›”'}];
  return '<div style="margin-bottom:20px"><h2 style="font-size:18px;font-weight:800">ğŸ’¼ ì„œë¹„ìŠ¤ ì‹ ì²­</h2><p style="font-size:13px;color:var(--w40);margin-top:4px">ë°”ìš°ì²˜ ì ìš© ê°€ëŠ¥</p></div><div class="svc-grid" style="margin-bottom:24px">'+svcs.map(function(s){return '<div class="svc-card" onclick="App.reqSvc(\''+s.type+'\')"><div class="svc-icon">'+s.icon+'</div><div class="svc-name">'+s.name+'</div><div class="svc-desc">'+s.desc+'</div><div class="svc-price">'+s.price+'</div></div>';}).join('')+'</div>'+(S.serviceRequests.length?'<div class="card"><div class="card-h"><span>ì‹ ì²­ ì´ë ¥</span>'+UI.badge(S.serviceRequests.length+'ê±´','pri')+'</div><div class="card-b" style="padding:0"><table class="tbl"><thead><tr><th>ì„œë¹„ìŠ¤</th><th>ìƒíƒœ</th><th>ê¸ˆì•¡</th><th>ë‚ ì§œ</th></tr></thead><tbody>'+S.serviceRequests.map(function(sr){return '<tr><td>'+U.si(sr.service_type)+' '+U.sl(sr.service_type)+'</td><td>'+UI.sb(sr.status)+'</td><td style="font-family:JetBrains Mono;font-size:12px">'+(sr.price?U.krw(sr.price):'ê²¬ì ëŒ€ê¸°')+'</td><td style="font-size:12px;color:var(--w40)">'+U.fd(sr.created_at)+'</td></tr>';}).join('')+'</tbody></table></div></div>':'');
}

function reqSvc(type,anlId,prefill){
  var ctx=prefill?'[í•­ëª© ëŒ€í–‰ ìš”ì²­] '+prefill+'\n':'';var aid=anlId||'';
  if(S.currentAnalysis){aid=S.currentAnalysis.id;var r=S.currentAnalysis.ai_result||{};ctx+='[ë¶„ì„: '+S.currentAnalysis.product_name+']\nì ìˆ˜: '+(r.overall_score||'-')+'\n';if(type==='certification')ctx+='í•„ìš”ì¸ì¦: '+(r.required_certs||[]).join(', ')+'\n';if(type==='matching')ctx+='ì¶”ì²œì±„ë„: '+(r.recommended_channels||[]).join(', ')+'\n';}
  var pjOpts=S.projects.length?UI.sel('project_id','í”„ë¡œì íŠ¸ ì—°ê²°',[{value:'',label:'â€” ë¯¸ì—°ê²° â€”'}].concat(S.projects.map(function(p){return{value:p.id,label:p.name}}))):'';
  var body='<form id="sf"><input type="hidden" name="service_type" value="'+type+'"><input type="hidden" name="analysis_id" value="'+aid+'">'+pjOpts+UI.ta('details_text','ìš”ì²­ ìƒì„¸',{placeholder:'ìƒì„¸ ë‚´ìš©',rows:5,value:ctx})+UI.sel('priority','ê¸´ê¸‰ë„',[{value:'normal',label:'ì¼ë°˜'},{value:'high',label:'ê¸‰í•¨'},{value:'urgent',label:'ë§¤ìš°ê¸‰í•¨'}])+'</form>';
  document.body.insertAdjacentHTML('beforeend',UI.modal({id:'sm',title:U.si(type)+' '+U.sl(type)+' ì‹ ì²­',body:body,footer:'<button class="btn btn-ghost" onclick="App.closeModal(\'sm\')">ì·¨ì†Œ</button><button class="btn btn-pri" onclick="App.subSvc()">ì‹ ì²­</button>'}));UI.showModal('sm');
}
function subSvc(){
  var d=UI.fd('#sf');
  sb.from('service_requests').insert({user_id:S.user.id,service_type:d.service_type,priority:d.priority,title:U.sl(d.service_type),details:{text:d.details_text,analysis_id:d.analysis_id||null},project_id:d.project_id||null}).then(function(r){
    if(r.error){UI.toast('ì‹¤íŒ¨','err');return;}closeModal('sm');loadSR().then(function(){render();UI.toast('ì„œë¹„ìŠ¤ ì‹ ì²­ ì™„ë£Œ','ok');});
    pushNotif('service','ì„œë¹„ìŠ¤ ì‹ ì²­: '+U.sl(d.service_type),d.details_text?d.details_text.substring(0,50):'','services',null,true);
  });
}

function pgProjects(){
  if(S.currentProject)return pgPjDetail();
  var stages=['planning','certification','buyer_search','negotiation','production','shipping','completed'];
  var stL={planning:'ê¸°íš',certification:'ì¸ì¦',buyer_search:'ë°”ì´ì–´',negotiation:'í˜‘ìƒ',production:'ìˆ˜ì¶œìš© ìƒì‚°/ê²€ìˆ˜',shipping:'ì„ ì ',completed:'ì™„ë£Œ'};
  return '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px"><h2 style="font-size:18px;font-weight:800">ğŸš€ í”„ë¡œì íŠ¸</h2></div>'+(S.projects.length===0?'<div class="card"><div class="card-b">'+UI.empty('ğŸš€','í”„ë¡œì íŠ¸ ì—†ìŒ','AI ë¶„ì„ í›„ í”„ë¡œì íŠ¸ë¥¼ ìƒì„±í•˜ì„¸ìš”')+'<div style="text-align:center;margin-top:12px"><button class="btn btn-pri" onclick="App.nav(\'analysis\')">AI ë¶„ì„ ì‹œì‘</button></div></div></div>':S.projects.map(function(p){var ci=stages.indexOf(p.status);var linked=S.serviceRequests.filter(function(sr){return sr.project_id===p.id;});var a=S.analyses.find(function(x){return x.id===p.analysis_id;});var sp=p.stage_progress||{};var rmInfo=sp._roadmap||{};var totalItems=0,totalDone=0;stages.forEach(function(s){var items=sp[s]||[];totalItems+=items.length;totalDone+=items.filter(function(it){return it.done;}).length;});var totalPct=totalItems?Math.round(totalDone/totalItems*100):0;return '<div class="card" style="margin-bottom:12px;cursor:pointer" onclick="App.viewPj(\''+p.id+'\')"><div class="card-h"><div style="display:flex;align-items:center;gap:8px"><span>ğŸš€</span><span style="font-weight:700">'+p.name+'</span>'+(rmInfo.category?'<span class="badge badge-ghost" style="font-size:10px">'+rmInfo.category+'</span>':'')+'</div><div style="display:flex;gap:8px;align-items:center"><span style="font-size:13px;font-weight:700;color:var(--pri);font-family:JetBrains Mono">'+totalPct+'%</span>'+UI.sb(p.status)+'</div></div><div class="card-b"><div style="display:flex;align-items:center;gap:10px;margin-bottom:10px"><div style="flex:1;height:8px;border-radius:4px;background:var(--w08)"><div style="height:100%;border-radius:4px;background:'+(totalPct===100?'var(--ok)':'var(--pri-g)')+';width:'+totalPct+'%;transition:width .3s"></div></div></div><div style="display:flex;gap:4px;margin-bottom:10px">'+stages.map(function(s,i){return '<div style="flex:1;text-align:center"><div style="height:5px;border-radius:3px;background:'+(i<ci?'var(--ok)':i===ci?'var(--pri)':'var(--w08)')+';margin-bottom:4px"></div><div style="font-size:9px;color:'+(i<=ci?'var(--w60)':'var(--w20)')+'">'+stL[s]+'</div></div>';}).join('')+'</div><div style="display:flex;gap:12px;font-size:12px;color:var(--w40)"><span>ğŸŒ '+(p.target_countries||[]).map(function(c){return U.cl(c);}).join(', ')+'</span>'+(a&&a.ai_result?'<span>ğŸ“Š '+a.ai_result.overall_score+'ì </span>':'')+(linked.length?'<span>ğŸ’¼ '+linked.length+'ê±´</span>':'')+'</div></div></div>';}).join(''));
}

function pgPjDetail(){
  var p=S.currentProject;if(!p)return'';
  var stages=['planning','certification','buyer_search','negotiation','production','shipping','completed'];
  var stL={planning:'ê¸°íš',certification:'ì¸ì¦',buyer_search:'ë°”ì´ì–´ ë°œêµ´',negotiation:'í˜‘ìƒ/ê³„ì•½',production:'ìˆ˜ì¶œìš© ìƒì‚°/ê²€ìˆ˜',shipping:'ì„ ì /í†µê´€',completed:'ì‚¬í›„ê´€ë¦¬'};
  var stIcon={planning:'ğŸ“‹',certification:'ğŸ…',buyer_search:'ğŸ”',negotiation:'ğŸ¤',production:'ğŸ­',shipping:'ğŸš¢',completed:'âœ…'};
  var ci=stages.indexOf(p.status);
  var sp=p.stage_progress||{};
  /* ê¸°ì¡´ í”„ë¡œì íŠ¸ í˜¸í™˜: productionì´ ì—†ìœ¼ë©´ ìë™ ìƒì„± */
  if(!sp.production){
    var _rmI=sp._roadmap||{};var _rm=getRoadmap(_rmI.category||'Other',_rmI.market||'US');
    var _pItems=(_rm.production&&_rm.production.items)||STAGE_DEFAULTS.production.map(function(i){return i.text;});
    sp.production=_pItems.map(function(item){var t=typeof item==='string'?item:item.text;return{text:t,done:false};});
  }
  var rmInfo=sp._roadmap||{};
  var rm=getRoadmap(rmInfo.category||'Other',rmInfo.market||'US');
  var a=S.analyses.find(function(x){return x.id===p.analysis_id;});
  var linked=S.serviceRequests.filter(function(sr){return sr.project_id===p.id;});
  var notes=p.notes||[];

  /* ì „ì²´ ì§„í–‰ë¥  ê³„ì‚° */
  var totalItems=0,totalDone=0;
  stages.forEach(function(s,i){
    var items=sp[s]||[];
    totalItems+=items.length;
    totalDone+=items.filter(function(it){return it.done;}).length;
  });
  var totalPct=totalItems?Math.round(totalDone/totalItems*100):0;

  /* ì´ ì˜ˆìƒ ë¹„ìš© ê³„ì‚° */
  var costMin=0,costMax=0;
  stages.forEach(function(s){
    var stRM=rm[s];if(!stRM||!stRM.cost||stRM.cost==='-')return;
    var m=stRM.cost.match(/\$([\d,]+).*?([\d,]+)/);
    if(m){costMin+=parseInt(m[1].replace(/,/g,''));costMax+=parseInt(m[2].replace(/,/g,''));}
  });

  /* Header */
  var hdr='<div style="display:flex;align-items:center;gap:12px;margin-bottom:16px"><button class="btn btn-ghost btn-sm" onclick="App.set({currentProject:null})">â† ëª©ë¡</button><div style="flex:1"><h2 style="font-size:18px;font-weight:800;margin-bottom:2px">'+p.name+'</h2><div style="font-size:12px;color:var(--w40)">'+(rmInfo.category||'')+(rmInfo.market?' â†’ '+U.cl(rmInfo.market):'')+'</div></div>'+UI.sb(p.status)+'</div>';

  /* ìš”ì•½ ì¹´ë“œ */
  var summaryCard='<div class="card" style="margin-bottom:16px;border-color:rgba(0,212,255,.15)"><div class="card-b" style="padding:16px"><div style="display:flex;align-items:center;gap:16px;margin-bottom:14px"><div style="flex:1"><div style="font-size:11px;color:var(--w40);margin-bottom:4px">ì „ì²´ ì§„í–‰ë¥ </div><div style="display:flex;align-items:center;gap:10px"><div style="flex:1;height:10px;border-radius:5px;background:var(--w08)"><div style="height:100%;border-radius:5px;background:'+(totalPct===100?'var(--ok)':'var(--pri-g)')+';width:'+totalPct+'%;transition:width .5s ease"></div></div><span style="font-size:16px;font-weight:800;color:'+(totalPct===100?'var(--ok)':'var(--pri)')+';font-family:JetBrains Mono;min-width:45px">'+totalPct+'%</span></div></div></div><div style="display:flex;gap:12px;flex-wrap:wrap"><div style="padding:10px 14px;border-radius:10px;background:var(--w08);flex:1;min-width:120px"><div style="font-size:10px;color:var(--w40)">í˜„ì¬ ë‹¨ê³„</div><div style="font-size:14px;font-weight:700;color:var(--pri)">'+stIcon[stages[ci]]+(ci+1)+'/'+stages.length+' '+stL[stages[ci]]+'</div></div><div style="padding:10px 14px;border-radius:10px;background:var(--w08);flex:1;min-width:120px"><div style="font-size:10px;color:var(--w40)">íƒ€ê²Ÿ ì‹œì¥</div><div style="font-size:14px;font-weight:700">'+(p.target_countries||[]).map(function(c){return U.cl(c);}).join(', ')+'</div></div>'+(costMin?'<div style="padding:10px 14px;border-radius:10px;background:var(--w08);flex:1;min-width:120px"><div style="font-size:10px;color:var(--w40)">ì˜ˆìƒ ì´ë¹„ìš©</div><div style="font-size:14px;font-weight:700;color:var(--acc);font-family:JetBrains Mono">'+U.fmtUSD(costMin)+'~'+U.fmtUSD(costMax)+'</div></div>':'')+(a&&a.ai_result?'<div style="padding:10px 14px;border-radius:10px;background:var(--w08);flex:1;min-width:120px;cursor:pointer" onclick="App.viewA(\''+a.id+'\')"><div style="font-size:10px;color:var(--w40)">AI ë¶„ì„</div><div style="font-size:14px;font-weight:700;color:var(--pri)">'+a.ai_result.overall_score+'ì  â†’</div></div>':'')+'</div></div></div>';

  /* ë¦¬ìŠ¤í¬ ê²½ê³  */
  var riskBanner='';
  if(a&&a.ai_result&&a.ai_result.risks&&a.ai_result.risks.length){
    var risks=a.ai_result.risks;
    var highRisks=risks.filter(function(r){return r.severity==='high';});
    riskBanner='<div class="card" style="margin-bottom:16px;border-color:rgba(255,82,82,.3);background:rgba(255,82,82,.04)"><div class="card-b" style="padding:14px"><div style="display:flex;align-items:center;gap:8px;margin-bottom:10px"><span style="font-size:18px">âš ï¸</span><span style="font-size:13px;font-weight:700;color:var(--err)">ì£¼ì˜ì‚¬í•­ '+risks.length+'ê±´'+(highRisks.length?' (ê¸´ê¸‰ '+highRisks.length+'ê±´)':'')+'</span></div>'+
    risks.map(function(r){
      var col=r.severity==='high'?'var(--err)':r.severity==='medium'?'var(--warn)':'var(--w40)';
      var txt=(typeof r==='string')?r:(r.text||r.description||JSON.stringify(r));
      return '<div style="display:flex;align-items:start;gap:8px;padding:6px 0;border-bottom:1px solid var(--w08)"><span style="width:8px;height:8px;border-radius:50%;background:'+col+';margin-top:4px;flex-shrink:0"></span><div style="flex:1;font-size:12px;color:var(--w60)">'+txt+'</div><button class="btn btn-ghost btn-sm" style="font-size:10px;padding:2px 8px;flex-shrink:0" onclick="App.reqSvc(\'certification\')">ì „ë¬¸ê°€ ìƒë‹´</button></div>';
    }).join('')+'</div></div>';
  }

  /* ìˆ˜ì§í˜• ì—¬ì • ë§µ */
  var journey='<div style="position:relative;padding-left:40px">';
  /* ìˆ˜ì§ ë¼ì¸ */
  var _stLen=stages.length-1;
  journey+='<div style="position:absolute;left:17px;top:0;bottom:0;width:2px;background:linear-gradient(to bottom,var(--ok) '+(ci>0?Math.round(ci/_stLen*100):0)+'%,var(--pri) '+(ci>0?Math.round(ci/_stLen*100):0)+'%,var(--pri) '+(Math.round((ci+1)/(stages.length)*100))+'%,var(--w08) '+(Math.round((ci+1)/(stages.length)*100))+'%)"></div>';

  stages.forEach(function(s,i){
    var cur=i===ci;var done=i<ci;var locked=i>ci;
    var items=sp[s]||[];
    var doneCount=items.filter(function(it){return it.done;}).length;
    var pct=items.length?Math.round(doneCount/items.length*100):0;
    var stRM=rm[s]||{};
    var svcMap={planning:'premium_analysis',certification:'certification',buyer_search:'matching',negotiation:'document',production:'sourcing',shipping:'logistics',completed:'email_support'};

    /* ë…¸ë“œ ì›í˜• */
    var nodeColor=done?'var(--ok)':cur?'var(--pri)':'var(--w20)';
    var nodeBg=done?'var(--ok)':cur?'var(--pri)':'transparent';
    var nodeInner=done?'<span style="color:var(--bg);font-size:12px;font-weight:900">âœ“</span>':(cur?'<span style="color:var(--bg);font-size:12px;font-weight:900">'+(i+1)+'</span>':'<span style="color:var(--w20);font-size:12px;font-weight:700">'+(i+1)+'</span>');

    journey+='<div style="position:relative;margin-bottom:'+(i<stages.length-1?'12px':'0')+'">';
    /* ì›í˜• ë…¸ë“œ */
    journey+='<div style="position:absolute;left:-40px;top:14px;width:36px;height:36px;border-radius:50%;border:3px solid '+nodeColor+';background:'+nodeBg+';display:flex;align-items:center;justify-content:center;z-index:1">'+nodeInner+'</div>';

    if(done){
      /* ì™„ë£Œ ë‹¨ê³„: ì¶•ì•½í˜• */
      journey+='<div style="padding:12px 16px;border-radius:12px;background:rgba(0,230,118,.04);border:1px solid rgba(0,230,118,.12);cursor:pointer" onclick="App.toggleJourneyStage(\''+s+'\')">';
      journey+='<div style="display:flex;align-items:center;gap:10px"><span style="font-size:16px">'+stIcon[s]+'</span><span style="font-size:14px;font-weight:700;color:var(--ok)">'+stL[s]+'</span><span style="font-size:11px;color:var(--ok);font-family:JetBrains Mono">ì™„ë£Œ âœ“</span><span style="margin-left:auto;font-size:12px;color:var(--w40)">'+(stRM.time||'')+'</span></div>';
      /* í™•ì¥ì‹œ ì²´í¬ë¦¬ìŠ¤íŠ¸ í‘œì‹œ */
      journey+='<div id="stage-expand-'+s+'" style="display:none;margin-top:12px">'+renderJourneyChecklist(p,s,false)+'</div>';
      journey+='</div>';
    }else if(cur){
      /* í˜„ì¬ ë‹¨ê³„: í’€ í™•ì¥ */
      journey+='<div style="padding:16px 18px;border-radius:14px;background:rgba(0,212,255,.04);border:2px solid rgba(0,212,255,.2)">';
      journey+='<div style="display:flex;align-items:center;gap:10px;margin-bottom:12px"><span style="font-size:18px">'+stIcon[s]+'</span><span style="font-size:15px;font-weight:800;color:var(--pri)">'+stL[s]+'</span><span style="font-size:12px;padding:3px 10px;border-radius:20px;background:rgba(0,212,255,.1);color:var(--pri);font-weight:700">ì§„í–‰ì¤‘</span>';
      if(stRM.time)journey+='<span style="margin-left:auto;font-size:11px;color:var(--w40)">ì˜ˆìƒ '+stRM.time+'</span>';
      journey+='</div>';

      /* ì§„í–‰ë¥  ë°” */
      journey+='<div style="display:flex;align-items:center;gap:10px;margin-bottom:14px"><div style="flex:1;height:8px;border-radius:4px;background:var(--w08)"><div style="height:100%;border-radius:4px;background:'+(pct===100?'var(--ok)':'var(--pri)')+';width:'+pct+'%;transition:width .3s"></div></div><span style="font-size:12px;font-weight:700;color:'+(pct===100?'var(--ok)':'var(--pri)')+'">'+doneCount+'/'+items.length+'</span></div>';

      /* ì¸ì¦ ë‹¨ê³„ íŠ¹ë³„ ì²˜ë¦¬ */
      if(s==='certification'){
        var certs=sp.certs||[];
        if(certs.length){
          var certDone=certs.filter(function(c){return c.status==='approved';}).length;
          journey+='<div style="padding:12px;border-radius:10px;background:var(--w08);margin-bottom:12px"><div style="display:flex;align-items:center;gap:8px;margin-bottom:10px"><span style="font-size:13px;font-weight:700">ì¸ì¦ í˜„í™©</span>'+UI.badge(certDone+'/'+certs.length+' ì·¨ë“','acc')+'<button class="btn btn-ghost btn-sm" style="margin-left:auto" onclick="App.addCertItem(\''+p.id+'\')">+ ì¶”ê°€</button></div>';
          certs.forEach(function(c,idx){
            var stCol={pending:'var(--w40)',in_progress:'var(--acc)',submitted:'var(--pri)',approved:'var(--ok)',rejected:'var(--err)'};
            var stDot=c.status==='approved'?'ğŸŸ¢':c.status==='in_progress'?'ğŸŸ¡':c.status==='submitted'?'ğŸ”µ':c.status==='rejected'?'ğŸ”´':'âšª';
            journey+='<div style="display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;margin-bottom:4px"><span style="font-size:14px">'+stDot+'</span><span style="font-size:13px;font-weight:600;flex:1;color:'+(stCol[c.status]||'var(--w70)')+'">'+c.name+'</span><select class="form-select" style="width:100px;padding:4px 8px;font-size:11px" onchange="App.setCertStatus(\''+p.id+'\','+idx+',this.value)"><option value="pending"'+(c.status==='pending'?' selected':'')+'>ëŒ€ê¸°</option><option value="in_progress"'+(c.status==='in_progress'?' selected':'')+'>ì§„í–‰ì¤‘</option><option value="submitted"'+(c.status==='submitted'?' selected':'')+'>ì œì¶œë¨</option><option value="approved"'+(c.status==='approved'?' selected':'')+'>ì·¨ë“</option><option value="rejected"'+(c.status==='rejected'?' selected':'')+'>ë°˜ë ¤</option></select></div>';
          });
          journey+='</div>';
        }
      }

      /* ì²´í¬ë¦¬ìŠ¤íŠ¸ */
      journey+=renderJourneyChecklist(p,s,true);

      /* íŒ */
      if(stRM.tip){
        journey+='<div style="padding:12px;border-radius:10px;background:rgba(255,184,0,.06);border:1px solid rgba(255,184,0,.12);margin-top:12px"><div style="font-size:11px;font-weight:700;color:var(--acc);margin-bottom:4px">ğŸ’¡ TIP</div><div style="font-size:12px;color:var(--w70);line-height:1.6">'+stRM.tip+'</div></div>';
      }

      /* ë¹„ìš© */
      if(stRM.cost&&stRM.cost!=='-'){
        journey+='<div style="display:flex;gap:12px;margin-top:12px;font-size:12px;color:var(--w40)"><span>ğŸ’° ì˜ˆìƒ ë¹„ìš©: <strong style="color:var(--acc)">'+stRM.cost+'</strong></span>';
        if(stRM.time)journey+='<span>â± ì˜ˆìƒ ì†Œìš”: <strong style="color:var(--pri)">'+stRM.time+'</strong></span>';
        journey+='</div>';
      }

      /* ì•¡ì…˜ ë²„íŠ¼ */
      journey+='<div style="display:flex;gap:8px;margin-top:14px;flex-wrap:wrap">';
      journey+='<button class="btn btn-pri btn-sm" onclick="App.reqSvc(\''+svcMap[s]+'\')">ğŸ¤– ëŒ€í–‰ ìš”ì²­</button>';
      if(s==='buyer_search')journey+='<button class="btn btn-acc btn-sm" onclick="App.nav(\'emailhub\')">âœ‰ï¸ ì´ë©”ì¼ ë°œì†¡</button>';
      if(s==='negotiation'||s==='shipping')journey+='<button class="btn btn-acc btn-sm" onclick="App.nav(\'docgen\')">ğŸ“„ ì„œë¥˜ ìƒì„±</button>';
      if(pct===100){var nextStage=stages[i+1];if(nextStage)journey+='<button class="btn btn-ok btn-sm" onclick="App.setPjStage(\''+nextStage+'\')">ë‹¤ìŒ ë‹¨ê³„ â†’</button>';}
      journey+='</div>';

      journey+='</div>';
    }else{
      /* ì ê¸ˆ ë‹¨ê³„: ë¯¸ë¦¬ë³´ê¸° */
      journey+='<div style="padding:12px 16px;border-radius:12px;background:var(--w08);border:1px solid var(--bd);opacity:.6">';
      journey+='<div style="display:flex;align-items:center;gap:10px"><span style="font-size:16px;filter:grayscale(1)">'+stIcon[s]+'</span><span style="font-size:14px;font-weight:600;color:var(--w40)">'+stL[s]+'</span><span style="font-size:10px;color:var(--w20);margin-left:auto">ğŸ”’</span></div>';
      if(stRM.items||stRM.tip){
        journey+='<div style="margin-top:8px;font-size:11px;color:var(--w20);line-height:1.6">';
        var previewItems=(stRM.items||[]).slice(0,3).map(function(t){return typeof t==='string'?t:t.text;});
        journey+=previewItems.join(' Â· ');
        if((stRM.items||[]).length>3)journey+=' ...';
        journey+='</div>';
      }
      if(stRM.time&&stRM.time!=='-')journey+='<div style="margin-top:4px;font-size:10px;color:var(--w20)">ì˜ˆìƒ '+stRM.time+' Â· '+stRM.cost+'</div>';
      journey+='</div>';
    }

    journey+='</div>';
  });
  journey+='</div>';

  /* í•˜ë‹¨: ì„œë¹„ìŠ¤ + ë©”ëª¨ + ì•¡ì…˜ */
  var svc='<div class="card" style="margin-top:16px;margin-bottom:14px"><div class="card-h"><span>ğŸ’¼ ì—°ê²° ì„œë¹„ìŠ¤</span>'+UI.badge(linked.length+'ê±´','pri')+'<button class="btn btn-pri btn-sm" style="margin-left:auto" onclick="App.reqSvcForPj(\''+p.id+'\')">+ ì‹ ì²­</button></div>'+(linked.length?'<div class="card-b" style="padding:10px">'+linked.map(function(sr){return '<div style="display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;background:var(--w08);margin-bottom:4px"><span>'+U.si(sr.service_type)+'</span><div style="flex:1"><span style="font-size:13px;font-weight:600">'+U.sl(sr.service_type)+'</span><span style="font-size:11px;color:var(--w40);margin-left:8px">'+U.fd(sr.created_at,'rel')+'</span></div>'+UI.sb(sr.status)+'</div>';}).join('')+'</div>':'')+'</div>';

  var noteS='<div class="card" style="margin-bottom:14px"><div class="card-h"><span>ğŸ“ ë©”ëª¨</span><button class="btn btn-ghost btn-sm" style="margin-left:auto" onclick="App.addPjNote()">+ ì¶”ê°€</button></div><div class="card-b">'+(notes.length?notes.map(function(n,i){return '<div style="padding:8px;border-radius:8px;background:var(--w08);margin-bottom:6px"><div style="display:flex;justify-content:space-between;margin-bottom:3px"><span style="font-size:10px;color:var(--w40)">'+U.fd(n.date,'rel')+'</span><button class="btn btn-danger btn-sm" onclick="App.rmPjNote('+i+')" style="font-size:10px;padding:2px 6px">âœ•</button></div><div style="font-size:13px;color:var(--w70);white-space:pre-wrap">'+n.text+'</div></div>';}).join(''):'<div style="text-align:center;padding:12px;color:var(--w40);font-size:12px">ë©”ëª¨ë¥¼ ë‚¨ê²¨ ì§„í–‰ì„ ê¸°ë¡í•˜ì„¸ìš”</div>')+'</div></div>';

  var acts='<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:20px"><button class="btn btn-pri" onclick="App.reqSvcForPj(\''+p.id+'\')">ğŸ’¼ ì„œë¹„ìŠ¤</button><button class="btn btn-acc" onclick="App.nav(\'docgen\')">ğŸ“„ ì„œë¥˜</button><button class="btn btn-ghost" onclick="App.nav(\'emailhub\')">âœ‰ï¸ ì´ë©”ì¼</button><button class="btn btn-ghost" onclick="App.nav(\'cost\')">ğŸ§® ë¹„ìš© ê³„ì‚°</button><button class="btn btn-danger" onclick="App.delPj(\''+p.id+'\')">ğŸ—‘ï¸ ì‚­ì œ</button></div>';
  return hdr+summaryCard+riskBanner+journey+svc+noteS+acts;
}

/* ì—¬ì • ì²´í¬ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ (ì¸ë¼ì¸) */
function renderJourneyChecklist(p,stage,interactive){
  var items=getStageItems(p,stage);
  /* ì„œë¹„ìŠ¤ íƒ€ì… ë§¤í•‘ */
  var svcForStage={planning:'consultation',certification:'certification',buyer_search:'matching',negotiation:'consultation',production:'consultation',shipping:'logistics',completed:'consultation'};
  var html='';
  items.forEach(function(it,idx){
    var text=typeof it==='string'?it:(it.text||'');
    var done=typeof it==='object'?!!it.done:false;
    if(interactive){
      html+='<div style="display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:8px;background:'+(done?'rgba(0,230,118,.04)':'var(--w08)')+';margin-bottom:4px">';
      html+='<div style="width:22px;height:22px;border-radius:6px;border:2px solid '+(done?'var(--ok)':'var(--bd-l)')+';background:'+(done?'var(--ok)':'transparent')+';display:flex;align-items:center;justify-content:center;flex-shrink:0;cursor:pointer" onclick="App.toggleStageItem(\''+p.id+'\',\''+stage+'\','+idx+')">'+(done?'<span style="color:var(--bg);font-size:12px;font-weight:900">âœ“</span>':'')+'</div>';
      html+='<span style="font-size:13px;color:'+(done?'var(--w40)':'var(--w90)')+';'+(done?'text-decoration:line-through':'')+';flex:1">'+text+'</span>';
      if(!done)html+='<button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();App.reqSvc(\''+(svcForStage[stage]||'consultation')+'\',null,\''+text.replace(/'/g,'\\\'')+'\')" style="font-size:10px;padding:2px 8px;flex-shrink:0;color:var(--acc)">ëŒ€í–‰</button>';
      html+='</div>';
    }else{
      html+='<div style="display:flex;align-items:center;gap:8px;padding:6px"><span style="font-size:11px;color:var(--ok)">âœ“</span><span style="font-size:12px;color:var(--w40);text-decoration:line-through">'+text+'</span></div>';
    }
  });
  return html;
}

/* ì—¬ì • ë‹¨ê³„ ì ‘ê¸°/í¼ì¹˜ê¸° */
function toggleJourneyStage(stage){
  var el=document.getElementById('stage-expand-'+stage);
  if(el)el.style.display=el.style.display==='none'?'block':'none';
}

function viewPj(id){var p=S.projects.find(function(x){return x.id===id;});if(p){S.currentProject=p;S.page='projects';render();}}

function setPjStage(stage){
  var p=S.currentProject;if(!p)return;
  sb.from('projects').update({status:stage,updated_at:new Date().toISOString()}).eq('id',p.id).then(function(r){
    if(r.error){UI.toast('ì‹¤íŒ¨','err');return;}p.status=stage;render();UI.toast('ë‹¨ê³„ ë³€ê²½','ok');
  });
}

function addPjNote(){
  var t=prompt('ë©”ëª¨:');if(!t)return;var p=S.currentProject;if(!p)return;
  var n=p.notes||[];n.push({text:t,date:new Date().toISOString()});
  sb.from('projects').update({notes:n}).eq('id',p.id).then(function(r){
    if(r.error){UI.toast('ì‹¤íŒ¨','err');return;}p.notes=n;render();UI.toast('ì¶”ê°€','ok');
  });
}

function rmPjNote(i){var p=S.currentProject;if(!p)return;var n=p.notes||[];n.splice(i,1);sb.from('projects').update({notes:n}).eq('id',p.id).then(function(r){if(!r.error){p.notes=n;render();}});}

function delPj(id){if(!confirm('ì‚­ì œ?'))return;sb.from('projects').delete().eq('id',id).eq('user_id',S.user.id).then(function(r){if(r.error){UI.toast('ì‹¤íŒ¨','err');return;}S.currentProject=null;loadPr().then(function(){render();UI.toast('ì‚­ì œ','ok');});});}

/* â”€â”€ Stage checklist functions â”€â”€ */
function getStageItems(p,stage){
  var sp=p.stage_progress||{};
  if(sp[stage]&&sp[stage].length)return sp[stage];
  return JSON.parse(JSON.stringify(STAGE_DEFAULTS[stage]||[]));
}

function renderStageChecklist(p,stage){
  var stNames={planning:'ê¸°íš',certification:'ì¸ì¦',buyer_search:'ë°”ì´ì–´ ë°œêµ´',negotiation:'í˜‘ìƒ',production:'ìˆ˜ì¶œìš© ìƒì‚°/ê²€ìˆ˜',shipping:'ì„ ì ',completed:'ì™„ë£Œ'};
  var items=getStageItems(p,stage);var done=items.filter(function(it){return it.done;}).length;var pct=items.length?Math.round(done/items.length*100):0;
  var bar='<div style="display:flex;align-items:center;gap:10px;margin-bottom:14px"><div style="flex:1;height:8px;border-radius:4px;background:var(--w08)"><div style="height:100%;border-radius:4px;background:'+(pct===100?'var(--ok)':'var(--pri)')+';width:'+pct+'%;transition:width .3s"></div></div><span style="font-size:12px;font-weight:700;color:'+(pct===100?'var(--ok)':'var(--pri)')+'">'+pct+'%</span></div>';
  var list=items.map(function(it,idx){return '<div style="display:flex;align-items:center;gap:10px;padding:10px;border-radius:8px;background:var(--w08);margin-bottom:6px;cursor:pointer" onclick="App.toggleStageItem(\''+p.id+'\',\''+stage+'\','+idx+')"><div style="width:22px;height:22px;border-radius:6px;border:2px solid '+(it.done?'var(--ok)':'var(--bd-l)')+';background:'+(it.done?'var(--ok)':'transparent')+';display:flex;align-items:center;justify-content:center;flex-shrink:0">'+(it.done?'<span style="color:var(--bg);font-size:12px;font-weight:900">âœ“</span>':'')+'</div><span style="font-size:13px;color:'+(it.done?'var(--w40)':'var(--w90)')+';'+(it.done?'text-decoration:line-through':'')+'">'+it.text+'</span></div>';}).join('');
  var stages=['planning','certification','buyer_search','negotiation','production','shipping','completed'];var ci=stages.indexOf(p.status);var nextStage=stages[ci+1]||null;
  var nextBtn=nextStage&&pct===100?'<button class="btn btn-pri" style="margin-top:10px" onclick="App.setPjStage(\''+nextStage+'\')">ë‹¤ìŒ ë‹¨ê³„ â†’</button>':'';
  return '<div class="card" style="margin-bottom:14px"><div class="card-h"><span>ğŸ“‹ '+stNames[stage]+' ì²´í¬ë¦¬ìŠ¤íŠ¸</span>'+UI.badge(done+'/'+items.length,'pri')+'</div><div class="card-b">'+bar+list+nextBtn+'</div></div>';
}

function toggleStageItem(pjId,stage,idx){
  var p=S.currentProject;if(!p||p.id!==pjId)p=S.projects.find(function(x){return x.id===pjId;});if(!p)return;
  var sp=p.stage_progress||{};if(!sp[stage])sp[stage]=JSON.parse(JSON.stringify(STAGE_DEFAULTS[stage]||[]));
  sp[stage][idx].done=!sp[stage][idx].done;
  sb.from('projects').update({stage_progress:sp,updated_at:new Date().toISOString()}).eq('id',pjId).then(function(r){
    if(r.error){UI.toast('ì €ì¥ ì‹¤íŒ¨','err');return;}p.stage_progress=sp;render();
  });
}

var CERT_DB={
  'FDA':{full:'FDA Cosmetic Registration (MoCRA)',cc:'US',url:'https://www.fda.gov/cosmetics/cosmetic-product-listing',costMin:0,costMax:500,timeline:'1-3ê°œì›”',docs:['ì‹œì„¤ ë“±ë¡(Facility Registration)','ì œí’ˆ ë¦¬ìŠ¤íŒ…(Product Listing)','INCI ì„±ë¶„ ëª©ë¡','ì œí’ˆ ë¼ë²¨(ì˜ë¬¸)']},
  'CPNP':{full:'EU Cosmetic Products Notification Portal',cc:'EU',url:'https://ec.europa.eu/growth/tools-databases/cosing/',costMin:2000,costMax:8000,timeline:'2-4ê°œì›”',docs:['í™”ì¥í’ˆ ì•ˆì „ì„± ë³´ê³ ì„œ(CPSR)','GMP ì¸ì¦ì„œ(ISO 22716)','ì œí’ˆ ì •ë³´ íŒŒì¼(PIF)','ì„±ë¶„ ëª©ë¡(INCI)','ë¼ë²¨ë§(EU ê³µì‹ì–¸ì–´)']},
  'PMDA':{full:'ì¼ë³¸ ì˜ì•½í’ˆì˜ë£Œê¸°ê¸°ì¢…í•©ê¸°êµ¬ í™”ì¥í’ˆ ì‹ ê³ ',cc:'JP',url:'https://www.pmda.go.jp/',costMin:300,costMax:1500,timeline:'1-2ê°œì›”',docs:['í™”ì¥í’ˆ ìˆ˜ì… ì‹ ê³ ì„œ','ì„±ë¶„ ëª©ë¡(ì¼ë³¸ì–´)','ì œì¡°íŒë§¤ì—… í—ˆê°€ì¦(í˜„ì§€ íŒŒíŠ¸ë„ˆ)','ì œí’ˆ ë¼ë²¨(ì¼ë³¸ì–´)']},
  'NMPA':{full:'ì¤‘êµ­ êµ­ê°€ì•½í’ˆê°ë…ê´€ë¦¬êµ­',cc:'CN',url:'https://www.nmpa.gov.cn/',costMin:5000,costMax:20000,timeline:'6-12ê°œì›”',docs:['ìœ„ìƒí—ˆê°€ ì‹ ì²­ì„œ','ì•ˆì „ì„± ì‹œí—˜ ë³´ê³ ì„œ','ì œí’ˆ ê¸°ìˆ  ë¬¸ì„œ','ì¤‘ë¬¸ ë¼ë²¨','GMP ì¸ì¦ì„œ']},
  'CE':{full:'CE Marking (EU)',cc:'EU',url:'https://ec.europa.eu/growth/single-market/ce-marking_en',costMin:1000,costMax:5000,timeline:'2-6ê°œì›”',docs:['ì í•©ì„± ì„ ì–¸ì„œ(DoC)','ê¸°ìˆ  ë¬¸ì„œ(TD)','ì‹œí—˜ ë³´ê³ ì„œ','ì‚¬ìš©ì„¤ëª…ì„œ(EU ê³µì‹ì–¸ì–´)']},
  'KFDA':{full:'í•œêµ­ ì‹ì•½ì²˜ ìˆ˜ì¶œìš© ììœ íŒë§¤ì¦ëª…ì„œ',cc:'KR',url:'https://nedrug.mfds.go.kr',costMin:0,costMax:50,timeline:'1-2ì£¼',docs:['ììœ íŒë§¤ì¦ëª…ì„œ ì‹ ì²­ì„œ','ì œì¡°ì—… ë“±ë¡ì¦','ì œí’ˆ í’ˆëª©ë³´ê³  í™•ì¸ì„œ']},
  'HSA':{full:'ì‹±ê°€í¬ë¥´ ë³´ê±´ê³¼í•™ì²­',cc:'SG',url:'https://www.hsa.gov.sg/cosmetic-products',costMin:200,costMax:800,timeline:'1-2ê°œì›”',docs:['ASEAN Cosmetic Notification','ì•ˆì „ì„± ë°ì´í„°','ì œí’ˆ ë¼ë²¨(ì˜ë¬¸)']},
  'TGA':{full:'í˜¸ì£¼ ì¹˜ë£Œìš©í’ˆì²­',cc:'AU',url:'https://www.tga.gov.au/cosmetics',costMin:300,costMax:1500,timeline:'1-3ê°œì›”',docs:['AICIS ë“±ë¡','ì œí’ˆ ë¼ë²¨(ì˜ë¬¸)','ì•ˆì „ì„± ë°ì´í„°','ì„±ë¶„ ëª©ë¡']},
  'GCC':{full:'ê±¸í”„ í‘œì¤€í™”ê¸°êµ¬',cc:'AE',url:'https://www.gso.org.sa/',costMin:500,costMax:2000,timeline:'2-4ê°œì›”',docs:['ì í•©ì„± ì¸ì¦ì„œ','ì•„ëì–´ ë¼ë²¨','í• ë„ ì¸ì¦(í•´ë‹¹ì‹œ)','ì‹œí—˜ ë³´ê³ ì„œ']},
  'MOH_VN':{full:'ë² íŠ¸ë‚¨ ë³´ê±´ë¶€ í™”ì¥í’ˆ ë“±ë¡',cc:'VN',url:'https://dichvucong.moh.gov.vn/',costMin:300,costMax:1200,timeline:'1-3ê°œì›”',docs:['í™”ì¥í’ˆ ì‹ ê³ ì„œ','ììœ íŒë§¤ì¦ëª…ì„œ','ì„±ë¶„ ë¶„ì„ì„œ','ë² íŠ¸ë‚¨ì–´ ë¼ë²¨']},
  'FCC':{full:'ë¯¸êµ­ ì—°ë°©í†µì‹ ìœ„ì›íšŒ ì „ìê¸°ê¸° ì¸ì¦',cc:'US',url:'https://www.fcc.gov/engineering-technology/laboratory-division/general/equipment-authorization',costMin:3000,costMax:15000,timeline:'2-4ê°œì›”',docs:['FCC ID ì‹ ì²­ì„œ','EMC ì‹œí—˜ ë³´ê³ ì„œ','SAR ì‹œí—˜ ë³´ê³ ì„œ(í•´ë‹¹ì‹œ)','íšŒë¡œë„/ë¸”ë¡ë‹¤ì´ì–´ê·¸ë¨','ì‚¬ìš©ì„¤ëª…ì„œ(ì˜ë¬¸)']},
  'UL':{full:'UL ì•ˆì „ì¸ì¦ (ë¯¸êµ­)',cc:'US',url:'https://www.ul.com/',costMin:5000,costMax:25000,timeline:'3-6ê°œì›”',docs:['ì œí’ˆ ì‚¬ì–‘ì„œ','ì•ˆì „ì„± ì‹œí—˜ ë³´ê³ ì„œ','ê³µì¥ ì‹¬ì‚¬ ë³´ê³ ì„œ','ë¼ë²¨ë§ ê³„íšì„œ']},
  'CPSIA':{full:'ë¯¸êµ­ ì†Œë¹„ìì œí’ˆì•ˆì „ê°œì„ ë²• (ì„¬ìœ /ì˜ë¥˜/ì•„ë™)',cc:'US',url:'https://www.cpsc.gov/Regulations-Laws--Standards/Statutes/The-Consumer-Product-Safety-Improvement-Act',costMin:500,costMax:3000,timeline:'1-3ê°œì›”',docs:['ì„¬ìœ  ì„±ë¶„ í‘œì‹œ(Fiber Content)','ì›ì‚°ì§€ í‘œì‹œ','ì¼€ì–´ ë¼ë²¨(ASTM D5489)','ë‚©/í”„íƒˆë ˆì´íŠ¸ ì‹œí—˜(ì•„ë™ìš©)','ì¶”ì  ë¼ë²¨(Tracking Label)']},
  'FTC_TEXTILE':{full:'ë¯¸êµ­ FTC ì„¬ìœ ì œí’ˆ í‘œì‹œê·œì •',cc:'US',url:'https://www.ftc.gov/legal-library/browse/rules/textile-fiber-products-identification-act',costMin:100,costMax:500,timeline:'2-4ì£¼',docs:['ì„¬ìœ  ì„±ë¶„ ë¼ë²¨(ì˜ë¬¸)','ì›ì‚°ì§€ í‘œì‹œ','ê´€ë¦¬ë²• í‘œì‹œ(Care Label)','ì œì¡°ì‚¬/ìˆ˜ì…ì í‘œì‹œ']},
  'ACCC':{full:'í˜¸ì£¼ ì†Œë¹„ìê²½ìŸìœ„ì›íšŒ ì œí’ˆì•ˆì „',cc:'AU',url:'https://www.productsafety.gov.au/',costMin:500,costMax:3000,timeline:'1-3ê°œì›”',docs:['ì•ˆì „ì„± ì‹œí—˜ ë³´ê³ ì„œ','ì˜ë¬¸ ë¼ë²¨','ì í•©ì„± ì„ ì–¸ì„œ','ì œí’ˆ ì‚¬ì–‘ì„œ']},
  'SFA':{full:'ì‹±ê°€í¬ë¥´ ì‹í’ˆì²­',cc:'SG',url:'https://www.sfa.gov.sg/food-import-export',costMin:200,costMax:1000,timeline:'2-4ì£¼',docs:['ì‹í’ˆ ìˆ˜ì…í—ˆê°€ ì‹ ì²­ì„œ','ìœ„ìƒì¦ëª…ì„œ(Health Certificate)','ì„±ë¶„í‘œ','ì˜ì–‘í‘œì‹œ(ì˜ë¬¸)','ìœ í†µê¸°í•œ í‘œì‹œ']},
  'MHLW':{full:'ì¼ë³¸ í›„ìƒë…¸ë™ì„± ì‹í’ˆìœ„ìƒë²•',cc:'JP',url:'https://www.mhlw.go.jp/stf/seisakunitsuite/bunya/kenkou_iryou/shokuhin/',costMin:300,costMax:2000,timeline:'2-6ì£¼',docs:['ì‹í’ˆë“± ìˆ˜ì…ì‹ ê³ ì„œ','ìœ„ìƒì¦ëª…ì„œ','ì„±ë¶„í‘œ(ì¼ë³¸ì–´)','ì˜ì–‘í‘œì‹œ(ì¼ë³¸ ì–‘ì‹)','ì•Œë ˆë¥´ê¸° í‘œì‹œ(28í’ˆëª©)']},
  'ECAS':{full:'UAE ì í•©ì„±í‰ê°€ì²´ê³„ (Emirates Conformity Assessment Scheme)',cc:'AE',url:'https://www.moiat.gov.ae/en/services/ecas',costMin:1000,costMax:5000,timeline:'2-4ê°œì›”',docs:['ì í•©ì„± ì¸ì¦ì„œ','ì‹œí—˜ ë³´ê³ ì„œ','ê¸°ìˆ  ë¬¸ì„œ','ì•„ëì–´ ë¼ë²¨','í• ë„ ì¸ì¦(ì‹í’ˆ)']}
};

function pgCertTracker(p){
  var sp=p.stage_progress||{};var certs=sp.certs||[];
  var stCol={pending:'var(--w40)',in_progress:'var(--acc)',submitted:'var(--pri)',approved:'var(--ok)',rejected:'var(--err)'};
  var stLabel={pending:'ëŒ€ê¸°',in_progress:'ì§„í–‰ì¤‘',submitted:'ì œì¶œë¨',approved:'ì·¨ë“',rejected:'ë°˜ë ¤'};
  var done=certs.filter(function(c){return c.status==='approved';}).length;var pct=certs.length?Math.round(done/certs.length*100):0;
  var bar='<div style="display:flex;align-items:center;gap:10px;margin-bottom:14px"><div style="flex:1;height:8px;border-radius:4px;background:var(--w08)"><div style="height:100%;border-radius:4px;background:'+(pct===100?'var(--ok)':'var(--acc)')+';width:'+pct+'%;transition:width .3s"></div></div><span style="font-size:12px;font-weight:700;color:'+(pct===100?'var(--ok)':'var(--acc)')+'">'+done+'/'+certs.length+'</span></div>';

  var list=certs.map(function(c,idx){
    var db=CERT_DB[c.name]||{};
    /* ë§ˆê°ì¼ ê³„ì‚° */
    var deadlineHtml='';
    if(c.deadline){
      var daysLeft=Math.ceil((new Date(c.deadline)-new Date())/(1000*60*60*24));
      var dlColor=daysLeft<=0?'var(--err)':daysLeft<=7?'var(--err)':daysLeft<=30?'var(--acc)':'var(--w40)';
      deadlineHtml='<div style="font-size:11px;color:'+dlColor+';font-weight:600">'+(daysLeft<=0?'â° ê¸°í•œ ì´ˆê³¼ '+Math.abs(daysLeft)+'ì¼':daysLeft<=7?'ğŸ”´ D-'+daysLeft:daysLeft<=30?'ğŸŸ¡ D-'+daysLeft:'D-'+daysLeft)+'</div>';
    }
    /* ë¹„ìš© */
    var costHtml='';
    if(c.cost_min||c.cost_max||db.costMin){
      var cMin=c.cost_min||db.costMin||0;var cMax=c.cost_max||db.costMax||0;
      costHtml='<span style="font-size:10px;color:var(--w40)">$'+cMin+'~$'+cMax+'</span>';
    }
    /* ê³µì‹ ë§í¬ */
    var linkHtml=db.url?'<a href="'+db.url+'" target="_blank" style="font-size:10px;color:var(--pri);text-decoration:none" title="ê³µì‹ ì‚¬ì´íŠ¸">ğŸ”— ì‹ ì²­</a>':'';

    return '<div style="padding:12px;border-radius:10px;background:var(--w08);margin-bottom:8px;border-left:3px solid '+stCol[c.status||'pending']+'">'+
      '<div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">'+
      '<span style="font-size:13px;font-weight:700;flex:1;min-width:100px">'+c.name+(db.full?' <span style="font-size:10px;color:var(--w40);font-weight:400">'+db.full+'</span>':'')+'</span>'+
      deadlineHtml+costHtml+linkHtml+
      '<select class="form-select" style="width:110px;padding:4px 8px;font-size:11px" onchange="App.setCertStatus(\''+p.id+'\','+idx+',this.value)">'+
      '<option value="pending"'+(c.status==='pending'?' selected':'')+'>ëŒ€ê¸°</option>'+
      '<option value="in_progress"'+(c.status==='in_progress'?' selected':'')+'>ì§„í–‰ì¤‘</option>'+
      '<option value="submitted"'+(c.status==='submitted'?' selected':'')+'>ì œì¶œë¨</option>'+
      '<option value="approved"'+(c.status==='approved'?' selected':'')+'>ì·¨ë“</option>'+
      '<option value="rejected"'+(c.status==='rejected'?' selected':'')+'>ë°˜ë ¤</option></select>'+
      '</div>'+
      /* ì„œë¥˜ ì²´í¬ë¦¬ìŠ¤íŠ¸ */
      (db.docs?'<div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:4px">'+db.docs.map(function(doc){
        var uploaded=(c.docs_done||[]).indexOf(doc)>=0;
        return '<span style="font-size:10px;padding:2px 8px;border-radius:10px;background:'+(uploaded?'rgba(0,200,83,.1)':'var(--w08)')+';color:'+(uploaded?'var(--ok)':'var(--w40)')+';cursor:pointer" onclick="App.toggleCertDoc(\''+p.id+'\','+idx+',\''+doc.replace(/'/g,"\\'")+'\')">'+
        (uploaded?'âœ…':'â¬œ')+' '+doc+'</span>';
      }).join('')+'</div>':'')+
      /* ë§ˆê°ì¼ ì„¤ì • + AI ê°€ì´ë“œ ë²„íŠ¼ */
      '<div style="margin-top:6px;display:flex;gap:6px;align-items:center">'+
      '<input type="date" value="'+(c.deadline||'')+'" style="font-size:11px;padding:3px 6px;border:1px solid var(--bd);border-radius:6px;background:var(--bg);color:var(--fg)" onchange="App.setCertDeadline(\''+p.id+'\','+idx+',this.value)" title="ë§ˆê°ì¼ ì„¤ì •">'+
      '<button class="btn btn-ghost" style="font-size:10px;padding:3px 8px" onclick="App.getCertGuide(\''+p.id+'\','+idx+')">ğŸ¤– AI ê°€ì´ë“œ</button>'+
      '<button class="btn btn-ghost" style="font-size:10px;padding:3px 8px;color:var(--err)" onclick="App.rmCertItem(\''+p.id+'\','+idx+')">ì‚­ì œ</button>'+
      '</div>'+
      /* AI ê°€ì´ë“œ í‘œì‹œ */
      (c.ai_guide?'<div style="margin-top:8px;padding:10px;border-radius:8px;background:rgba(0,212,255,.04);border:1px solid rgba(0,212,255,.1);font-size:12px;line-height:1.6;white-space:pre-wrap;max-height:300px;overflow-y:auto">'+c.ai_guide+'</div>':'')+
    '</div>';
  }).join('');

  var addBtn='<div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">'+
    '<button class="btn btn-ghost btn-sm" onclick="App.addCertItem(\''+p.id+'\')">+ ì§ì ‘ ì¶”ê°€</button>'+
    Object.keys(CERT_DB).slice(0,6).map(function(k){
      var exists=certs.some(function(c){return c.name===k;});
      return exists?'':'<button class="btn btn-ghost btn-sm" style="font-size:10px;opacity:.7" onclick="App.addCertPreset(\''+p.id+'\',\''+k+'\')">+ '+k+'</button>';
    }).join('')+'</div>';

  var checklist=renderStageChecklist(p,'certification');
  return '<div class="card" style="margin-bottom:14px"><div class="card-h"><span>ğŸ… ì¸ì¦ ì¶”ì </span>'+UI.badge(done+'/'+certs.length+' ì·¨ë“','acc')+'</div><div class="card-b">'+(certs.length?bar+list:'<div style="text-align:center;padding:16px;color:var(--w40)">ë“±ë¡ëœ ì¸ì¦ ì—†ìŒ. ì•„ë˜ ë²„íŠ¼ìœ¼ë¡œ ì¶”ê°€í•˜ì„¸ìš”.</div>')+addBtn+'</div></div>'+checklist;
}

function setCertStatus(pjId,idx,status){
  var p=S.currentProject;if(!p||p.id!==pjId)p=S.projects.find(function(x){return x.id===pjId;});if(!p)return;
  var sp=p.stage_progress||{};if(!sp.certs)sp.certs=[];
  sp.certs[idx].status=status;
  sb.from('projects').update({stage_progress:sp,updated_at:new Date().toISOString()}).eq('id',pjId).then(function(r){
    if(r.error){UI.toast('ì €ì¥ ì‹¤íŒ¨','err');return;}p.stage_progress=sp;render();
  });
}
function setCertDeadline(pjId,idx,date){
  var p=S.currentProject;if(!p||p.id!==pjId)p=S.projects.find(function(x){return x.id===pjId;});if(!p)return;
  var sp=p.stage_progress||{};if(!sp.certs)sp.certs=[];
  sp.certs[idx].deadline=date;
  sb.from('projects').update({stage_progress:sp,updated_at:new Date().toISOString()}).eq('id',pjId).then(function(r){
    if(r.error){UI.toast('ì €ì¥ ì‹¤íŒ¨','err');return;}p.stage_progress=sp;render();
  });
}
function toggleCertDoc(pjId,idx,docName){
  var p=S.currentProject;if(!p||p.id!==pjId)p=S.projects.find(function(x){return x.id===pjId;});if(!p)return;
  var sp=p.stage_progress||{};if(!sp.certs)sp.certs=[];
  var c=sp.certs[idx];if(!c.docs_done)c.docs_done=[];
  var i=c.docs_done.indexOf(docName);
  if(i>=0)c.docs_done.splice(i,1);else c.docs_done.push(docName);
  sb.from('projects').update({stage_progress:sp,updated_at:new Date().toISOString()}).eq('id',pjId).then(function(r){
    if(r.error){UI.toast('ì €ì¥ ì‹¤íŒ¨','err');return;}p.stage_progress=sp;render();
  });
}

function addCertItem(pjId){
  var name=prompt('ì¸ì¦ëª… (ì˜ˆ: FDA, CE, CPNP, PMDA, NMPA, HSA, TGA, GCC):');if(!name)return;
  var p=S.currentProject;if(!p||p.id!==pjId)p=S.projects.find(function(x){return x.id===pjId;});if(!p)return;
  var sp=p.stage_progress||{};if(!sp.certs)sp.certs=[];
  var db=CERT_DB[name.toUpperCase()]||{};
  sp.certs.push({name:name.toUpperCase(),status:'pending',deadline:'',cost_min:db.costMin||0,cost_max:db.costMax||0,docs_done:[],ai_guide:null});
  sb.from('projects').update({stage_progress:sp,updated_at:new Date().toISOString()}).eq('id',pjId).then(function(r){
    if(r.error){UI.toast('ì €ì¥ ì‹¤íŒ¨','err');return;}p.stage_progress=sp;render();UI.toast(name+' ì¸ì¦ ì¶”ê°€','ok');
  });
}
function addCertPreset(pjId,certKey){
  var p=S.currentProject;if(!p||p.id!==pjId)p=S.projects.find(function(x){return x.id===pjId;});if(!p)return;
  var sp=p.stage_progress||{};if(!sp.certs)sp.certs=[];
  var db=CERT_DB[certKey]||{};
  sp.certs.push({name:certKey,status:'pending',deadline:'',cost_min:db.costMin||0,cost_max:db.costMax||0,docs_done:[],ai_guide:null});
  sb.from('projects').update({stage_progress:sp,updated_at:new Date().toISOString()}).eq('id',pjId).then(function(r){
    if(r.error){UI.toast('ì €ì¥ ì‹¤íŒ¨','err');return;}p.stage_progress=sp;render();UI.toast(certKey+' ì¶”ê°€','ok');
  });
}
function rmCertItem(pjId,idx){
  if(!confirm('ì´ ì¸ì¦ì„ ì‚­ì œí• ê¹Œìš”?'))return;
  var p=S.currentProject;if(!p||p.id!==pjId)p=S.projects.find(function(x){return x.id===pjId;});if(!p)return;
  var sp=p.stage_progress||{};if(!sp.certs)sp.certs=[];
  sp.certs.splice(idx,1);
  sb.from('projects').update({stage_progress:sp,updated_at:new Date().toISOString()}).eq('id',pjId).then(function(r){
    if(r.error){UI.toast('ì €ì¥ ì‹¤íŒ¨','err');return;}p.stage_progress=sp;render();UI.toast('ì‚­ì œë¨','ok');
  });
}
function getCertGuide(pjId,idx){
  var p=S.currentProject;if(!p||p.id!==pjId)p=S.projects.find(function(x){return x.id===pjId;});if(!p)return;
  var sp=p.stage_progress||{};var cert=sp.certs[idx];if(!cert)return;
  var tc=(p.target_countries||[])[0]||p.target_market||'US';
  var prod=S.products.find(function(pr){return pr.id===p.product_id;});
  var cat=prod?prod.category:'K-Beauty í™”ì¥í’ˆ';
  UI.toast('AI ê°€ì´ë“œ ìƒì„± ì¤‘...','info');
  fetch(RELAY_URL+'/api/whistle/cert-guide',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({certName:cert.name,productCategory:cat,targetCountry:tc})})
  .then(function(r){return r.json();}).then(function(data){
    if(data.ok&&data.guide){
      cert.ai_guide=data.guide;
      sb.from('projects').update({stage_progress:sp,updated_at:new Date().toISOString()}).eq('id',pjId).then(function(r){
        if(!r.error){p.stage_progress=sp;render();}
      });
      UI.toast('AI ê°€ì´ë“œ ìƒì„± ì™„ë£Œ','ok');
    }else{UI.toast('ê°€ì´ë“œ ìƒì„± ì‹¤íŒ¨: '+(data.error||''),'err');}
  }).catch(function(e){UI.toast('ì„œë²„ ì—°ê²° ì‹¤íŒ¨','err');});
}

function reqSvcForPj(pjId){
  var svcs=[{value:'premium_analysis',label:'ğŸ”¬ í”„ë¦¬ë¯¸ì—„ ë¶„ì„'},{value:'matching',label:'ğŸ¤ ë°”ì´ì–´ ë§¤ì¹­'},{value:'document',label:'ğŸ“„ ì„œë¥˜ ëŒ€í–‰'},{value:'certification',label:'ğŸ… ì¸ì¦ ëŒ€í–‰'},{value:'logistics',label:'ğŸš¢ ë¬¼ë¥˜/í†µê´€'},{value:'email_support',label:'âœ‰ï¸ ì´ë©”ì¼ ì§€ì›'}];
  var body='<form id="sf"><input type="hidden" name="project_id" value="'+pjId+'">'+UI.sel('service_type','ì„œë¹„ìŠ¤',svcs)+UI.ta('details_text','ìš”ì²­ ìƒì„¸',{placeholder:'ìƒì„¸ ë‚´ìš©',rows:4})+UI.sel('priority','ê¸´ê¸‰ë„',[{value:'normal',label:'ì¼ë°˜'},{value:'high',label:'ê¸‰í•¨'},{value:'urgent',label:'ë§¤ìš°ê¸‰í•¨'}])+'</form>';
  document.body.insertAdjacentHTML('beforeend',UI.modal({id:'sm',title:'ğŸ’¼ í”„ë¡œì íŠ¸ ì„œë¹„ìŠ¤ ì‹ ì²­',body:body,footer:'<button class="btn btn-ghost" onclick="App.closeModal(\'sm\')">ì·¨ì†Œ</button><button class="btn btn-pri" onclick="App.subSvcPj()">ì‹ ì²­</button>'}));UI.showModal('sm');
}

function subSvcPj(){
  var d=UI.fd('#sf');
  sb.from('service_requests').insert({user_id:S.user.id,project_id:d.project_id||null,service_type:d.service_type,priority:d.priority,title:U.sl(d.service_type),details:{text:d.details_text}}).then(function(r){
    if(r.error){UI.toast('ì‹¤íŒ¨','err');return;}closeModal('sm');loadSR().then(function(){render();UI.toast('ì‹ ì²­ ì™„ë£Œ','ok');});
  });
}

function pgDocgen(){
  if(S.docType)return pgDocForm();
  var gate=_planGate('docgen');
  var warn=!S.company?'<div class="card" style="border-color:rgba(255,184,0,.25);margin-bottom:16px"><div class="card-b" style="display:flex;align-items:center;gap:14px"><span style="font-size:28px">âš ï¸</span><div style="flex:1"><div style="font-weight:700">ì…€ëŸ¬ ì •ë³´ë¥¼ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”</div></div><button class="btn btn-acc btn-sm" onclick="App.nav(\'settings\')">ì„¤ì •â†’</button></div></div>':'';
  var docs=[{t:'pi',i:'ğŸ“‹',n:'Proforma Invoice',d:'ê²¬ì  ì†¡ì¥',c:'var(--pri)'},{t:'ci',i:'ğŸ“„',n:'Commercial Invoice',d:'í†µê´€ ì†¡ì¥',c:'var(--acc)'},{t:'pl',i:'ğŸ“¦',n:'Packing List',d:'í¬ì¥ ëª…ì„¸',c:'var(--ok)'},{t:'co',i:'ğŸ›ï¸',n:'Certificate of Origin',d:'ì›ì‚°ì§€ ì¦ëª…ì„œ',c:'var(--purple)'},{t:'bl',i:'ğŸš¢',n:'Bill of Lading',d:'ì„ í•˜ì¦ê¶Œ(B/L)',c:'#3b82f6'},{t:'sc',i:'ğŸ“',n:'Sales Contract',d:'ìˆ˜ì¶œ ê³„ì•½ì„œ',c:'var(--err)'}];
  var content='<div style="margin-bottom:20px"><h2 style="font-size:18px;font-weight:800">ğŸ“„ ì„œë¥˜ ìë™ìƒì„±</h2><p style="font-size:13px;color:var(--w40);margin-top:4px">íšŒì‚¬ ì •ë³´ ê¸°ë°˜ ìˆ˜ì¶œ ì„œë¥˜ ìƒì„±</p></div>'+_disclaimerBanner()+warn+'<div class="svc-grid">'+docs.map(function(d){return '<div class="svc-card" onclick="App.startDoc(\''+d.t+'\')"><div class="svc-icon">'+d.i+'</div><div class="svc-name" style="color:'+d.c+'">'+d.n+'</div><div class="svc-desc">'+d.d+'</div><div style="margin-top:12px"><button class="btn btn-ghost btn-sm" style="border-color:'+d.c+';color:'+d.c+'">ìƒì„± â†’</button></div></div>';}).join('')+'</div>';
  if(gate.blocked)return _lockOverlay(gate)+content+_lockOverlayEnd(gate);
  return content;
}
function startDoc(type){S.docType=type;S.docItems=[{name:'',qty:1,unit_price:0,desc:'',unit:'PCS'}];render();}

function pgDocForm(){
  var type=S.docType;var c=S.company||{};var isPL=type==='pl';var isCO=type==='co';var isSC=type==='sc';var isBL=type==='bl';
  var tN={pi:'Proforma Invoice',ci:'Commercial Invoice',pl:'Packing List',co:'Certificate of Origin',bl:'Bill of Lading',sc:'Sales Contract'};
  var hdr='<div style="display:flex;align-items:center;gap:12px;margin-bottom:20px"><button class="btn btn-ghost btn-sm" onclick="App.set({docType:null})">â† ë’¤ë¡œ</button><h2 style="font-size:18px;font-weight:800">'+tN[type]+'</h2></div>';
  var buyerSec='<div class="card" style="margin-bottom:14px"><div class="card-h">ğŸ‘¤ Buyer</div><div class="card-b"><form id="docB">'+(S.buyers.length?'<div class="form-group"><label class="form-label">ë“±ë¡ ë°”ì´ì–´</label><select class="form-select" name="buyer_from" onchange="App.fillBuyerDoc()"><option value="">â€” ì§ì ‘ ì…ë ¥ â€”</option>'+S.buyers.map(function(b){return '<option value="'+b.id+'">'+b.company_name+'</option>';}).join('')+'</select></div>':'')+'<div class="grid-2">'+UI.inp('buyer_company','íšŒì‚¬ëª… *',{required:true})+UI.inp('buyer_contact','ë‹´ë‹¹ì')+'</div>'+UI.inp('buyer_address','ì£¼ì†Œ',{placeholder:'Address in English'})+'<input type="hidden" name="buyer_country" value="">'+'</form></div></div>';
  var refFields='';
  if(isPL){refFields='<div class="grid-2">'+UI.inp('marks','Marks',{value:'N/M'})+UI.inp('vessel','Vessel')+'</div>';}
  else if(isCO){refFields='<div class="grid-3">'+UI.sel('terms','ì¡°ê±´',[{value:'FOB',label:'FOB'},{value:'CIF',label:'CIF'},{value:'EXW',label:'EXW'}])+UI.inp('port','ì„ ì í•­',{value:'Busan, Korea'})+UI.inp('dest_port','ë„ì°©í•­',{value:''})+'</div><div class="grid-2">'+UI.inp('origin_criteria','ì›ì‚°ì§€ ê¸°ì¤€',{value:'WO (Wholly Obtained) / KORUS FTA'})+UI.inp('transport','ìš´ì†¡ìˆ˜ë‹¨',{value:'Ocean Freight'})+'</div>';}
  else if(isBL){refFields='<div class="grid-2">'+UI.inp('vessel','ì„ ë°•ëª…',{placeholder:'Vessel Name'})+UI.inp('voyage','í•­ì°¨',{placeholder:'Voyage No.'})+'</div><div class="grid-2">'+UI.inp('port','ì„ ì í•­',{value:'Busan, Korea'})+UI.inp('dest_port','ì–‘ë¥™í•­',{placeholder:'Port of Discharge'})+'</div><div class="grid-2">'+UI.inp('notify','í†µì§€ì²˜',{placeholder:'Notify Party'})+UI.sel('bl_type','B/L ìœ í˜•',[{value:'Original',label:'Original'},{value:'Surrendered',label:'Surrendered'},{value:'Sea Waybill',label:'Sea Waybill'}])+'</div>';}
  else if(isSC){refFields='<div class="grid-3">'+UI.sel('payment','ê²°ì œì¡°ê±´',[{value:'T/T 30% deposit, 70% before shipment',label:'T/T 30/70'},{value:'T/T 50% deposit, 50% before shipment',label:'T/T 50/50'},{value:'T/T 100% in advance',label:'T/T 100% ì„ ë¶ˆ'},{value:'L/C at sight',label:'L/C at sight'},{value:'L/C 30 days',label:'L/C 30ì¼'},{value:'D/P at sight',label:'D/P'},{value:'D/A 30 days',label:'D/A 30ì¼'}])+UI.sel('terms','ì¸ì½”í…€ì¦ˆ',[{value:'FOB',label:'FOB'},{value:'CIF',label:'CIF'},{value:'CFR',label:'CFR'},{value:'EXW',label:'EXW'},{value:'DDP',label:'DDP'}])+UI.inp('port','ì„ ì í•­',{value:'Busan, Korea'})+'</div><div class="grid-3">'+UI.inp('delivery_date','ë‚©ê¸°',{type:'date'})+UI.inp('warranty','í’ˆì§ˆë³´ì¦ê¸°ê°„',{value:'12 months from B/L date'})+UI.sel('dispute','ë¶„ìŸí•´ê²°',[{value:'ICC Arbitration, Seoul',label:'ICC ì¤‘ì¬ (ì„œìš¸)'},{value:'ICC Arbitration, Singapore',label:'ICC ì¤‘ì¬ (ì‹±ê°€í¬ë¥´)'},{value:'KCAB, Seoul',label:'ëŒ€í•œìƒì‚¬ì¤‘ì¬ì›'},{value:'Court, Seoul',label:'ì„œìš¸ì¤‘ì•™ì§€ë°©ë²•ì›'}])+'</div><div class="grid-2">'+UI.inp('deposit_pct','ê³„ì•½ê¸ˆ(%)',{type:'number',value:'30'})+UI.inp('penalty_rate','ì§€ì²´ìƒê¸ˆ(%/ì¼)',{type:'number',value:'0.1',step:'0.01'})+'</div>';}
  else{refFields='<div class="grid-3">'+UI.sel('payment','ê²°ì œ',[{value:'T/T',label:'T/T'},{value:'L/C',label:'L/C'},{value:'D/P',label:'D/P'}])+UI.sel('terms','ì¡°ê±´',[{value:'FOB',label:'FOB'},{value:'CIF',label:'CIF'},{value:'EXW',label:'EXW'},{value:'DDP',label:'DDP'}])+UI.inp('port','ì„ ì í•­',{value:'Busan, Korea'})+'</div>';}
  var refSec='<div class="card" style="margin-bottom:14px"><div class="card-h">ğŸ“‹ ì„œë¥˜ ì •ë³´</div><div class="card-b"><form id="docR"><div class="grid-3">'+UI.inp('doc_no','ë²ˆí˜¸',{value:'W-'+new Date().getFullYear()+'-'+String(Math.floor(Math.random()*9000)+1000)})+UI.inp('doc_date','ë‚ ì§œ',{type:'date',value:new Date().toISOString().split('T')[0]})+UI.inp('validity','ìœ íš¨',{value:isSC?'Until contract completion':'30 days'})+'</div>'+refFields+'</form></div></div>';
  var items=S.docItems||[];
  var itemSec='<div class="card" style="margin-bottom:14px"><div class="card-h"><span>ğŸ“¦ í’ˆëª©</span><button class="btn btn-ghost btn-sm" onclick="App.addDocItem()">+ ì¶”ê°€</button></div><div class="card-b">'+items.map(function(it,idx){return '<div style="padding:12px;border-radius:10px;background:var(--w08);margin-bottom:8px" id="di'+idx+'"><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-size:12px;font-weight:700;color:var(--pri)">#'+(idx+1)+'</span>'+(items.length>1?'<button class="btn btn-danger btn-sm" onclick="App.rmDocItem('+idx+')" style="font-size:10px;padding:2px 6px">âœ•</button>':'')+'</div>'+(S.products.length?'<div class="form-group"><label class="form-label">ì œí’ˆ ì„ íƒ</label><select class="form-select" onchange="App.fillDocProd('+idx+',this.value)"><option value="">ì§ì ‘ ì…ë ¥</option>'+S.products.map(function(p){return '<option value="'+p.id+'">'+p.name_ko+(p.fob_price?' ($'+p.fob_price+')':'')+'</option>';}).join('')+'</select></div>':'')+'<div class="grid-2">'+UI.inp('itn_'+idx,'í’ˆëª…')+UI.inp('itd_'+idx,'ê·œê²©')+'</div><div class="grid-'+((isPL||isBL)?'4':'3')+'">'+UI.inp('itq_'+idx,'ìˆ˜ëŸ‰',{type:'number',value:'1'})+UI.inp('itu_'+idx,'ë‹¨ìœ„',{value:'PCS'})+((isPL||isBL)?UI.inp('itnw_'+idx,'ìˆœì¤‘ëŸ‰kg',{type:'number'})+UI.inp('itgw_'+idx,'ì´ì¤‘ëŸ‰kg',{type:'number'}):UI.inp('itp_'+idx,'ë‹¨ê°€USD',{type:'number'}))+'</div>'+((isPL||isBL)?'<div class="grid-3">'+UI.inp('itc_'+idx,'ì¹´í†¤',{type:'number',value:'1'})+UI.inp('itcbm_'+idx,'CBM',{type:'number'})+UI.inp('itdm_'+idx,'ì¹˜ìˆ˜cm',{placeholder:'40x30x20'})+'</div>':'')+'</div>';}).join('')+'</div></div>';
  return hdr+buyerSec+refSec+itemSec+'<div style="display:flex;gap:8px"><button class="btn btn-pri btn-lg" onclick="App.genDoc()">ğŸ“„ ì„œë¥˜ ìƒì„±</button><button class="btn btn-ghost" onclick="App.set({docType:null})">ì·¨ì†Œ</button></div>';
}
function addDocItem(){S.docItems.push({name:'',qty:1,unit_price:0,desc:'',unit:'PCS'});render();}
function rmDocItem(i){S.docItems.splice(i,1);render();}
function fillDocProd(idx,pid){if(!pid)return;var p=S.products.find(function(x){return x.id===pid;});if(!p)return;var el=document.getElementById('di'+idx);if(!el)return;var ni=el.querySelector('[name=itn_'+idx+']');if(ni)ni.value=p.name_en||p.name_ko||'';var di=el.querySelector('[name=itd_'+idx+']');if(di)di.value=p.description_en||'';var pi=el.querySelector('[name=itp_'+idx+']');if(pi&&p.fob_price)pi.value=p.fob_price;}
function fillBuyerDoc(){var sel=document.querySelector('[name=buyer_from]');if(!sel||!sel.value)return;var b=S.buyers.find(function(x){return x.id===sel.value;});if(!b)return;var ci=document.querySelector('[name=buyer_company]');if(ci)ci.value=b.company_name||'';var cn=document.querySelector('[name=buyer_contact]');if(cn)cn.value=b.contact_name||'';var ca=document.querySelector('[name=buyer_address]');if(ca)ca.value=b.address||'';var cc=document.querySelector('[name=buyer_country]');if(cc)cc.value=b.country||'';}

var _lastDoc=null;
function genDoc(){
  var bd=UI.fd('#docB');var rd=UI.fd('#docR');if(!bd.buyer_company){UI.toast('ë°”ì´ì–´ íšŒì‚¬ëª…','warn');return;}
  var items=[];var isPL=S.docType==='pl';var isCO=S.docType==='co';var isSC=S.docType==='sc';var isBL=S.docType==='bl';
  for(var i=0;i<S.docItems.length;i++){
    var _q=function(n){var el=document.querySelector('[name='+n+']');return el?el.value:'';};
    var it={name:_q('itn_'+i)||'',desc:_q('itd_'+i)||'',qty:Number(_q('itq_'+i))||1,unit:_q('itu_'+i)||'PCS',price:Number(_q('itp_'+i))||0};
    if(isPL||isBL){it.nw=Number(_q('itnw_'+i))||0;it.gw=Number(_q('itgw_'+i))||0;it.ctn=Number(_q('itc_'+i))||1;it.cbm=Number(_q('itcbm_'+i))||0;it.dims=_q('itdm_'+i)||'';}
    items.push(it);
  }
  if(!items[0]||!items[0].name){UI.toast('í’ˆëª©ëª… ì…ë ¥','warn');return;}
  var c=S.company||{};var tN={pi:'PROFORMA INVOICE',ci:'COMMERCIAL INVOICE',pl:'PACKING LIST',co:'CERTIFICATE OF ORIGIN',bl:'BILL OF LADING',sc:'SALES CONTRACT'};
  var tA=0,tQ=0,tNW=0,tGW=0,tCBM=0,tC=0;
  items.forEach(function(x){tA+=x.qty*x.price;tQ+=x.qty;if(isPL){tNW+=x.nw;tGW+=x.gw;tCBM+=x.cbm;tC+=x.ctn;}});

  _lastDoc={type:S.docType,buyer:bd,ref:rd,items:items,company:c,total:tA,totalQty:tQ,totalNW:tNW,totalGW:tGW,totalCBM:tCBM,totalC:tC,typeName:tN[S.docType]};

  var rows=items.map(function(x,i){var a=x.qty*x.price;return (isPL||isBL)?'<tr><td>'+(i+1)+'</td><td><b>'+x.name+'</b><br><small>'+x.desc+'</small></td><td style="text-align:center">'+x.qty+' '+x.unit+'</td><td style="text-align:center">'+x.ctn+'</td><td style="text-align:right">'+x.nw.toFixed(1)+'</td><td style="text-align:right">'+x.gw.toFixed(1)+'</td><td>'+x.cbm.toFixed(3)+'</td><td>'+x.dims+'</td></tr>':'<tr><td>'+(i+1)+'</td><td><b>'+x.name+'</b><br><small>'+x.desc+'</small></td><td style="text-align:center">'+x.qty+' '+x.unit+'</td><td style="text-align:right">$'+x.price.toFixed(2)+'</td><td style="text-align:right;font-weight:bold">$'+a.toFixed(2)+'</td></tr>';}).join('');
  var h='<html><head><meta charset="UTF-8"><title>'+tN[S.docType]+'</title><style>body{font-family:Arial,sans-serif;max-width:800px;margin:20px auto;color:#222;font-size:13px}table{width:100%;border-collapse:collapse;margin:16px 0}th,td{border:1px solid #bbb;padding:8px;font-size:12px}th{background:#eee}small{color:#888}.ttl{font-size:22px;font-weight:bold;text-align:center;margin:20px 0;padding:12px;background:#003366;color:white}.sig{text-align:center;width:45%;border-top:1px solid #333;padding-top:10px;margin-top:60px;font-size:12px}.toolbar{position:fixed;top:0;left:0;right:0;background:#003366;padding:8px 16px;display:flex;gap:8px;z-index:100}.toolbar button{padding:6px 14px;border:none;border-radius:4px;cursor:pointer;font-size:12px;font-weight:600}.toolbar .btn-pdf{background:#FF5252;color:white}.toolbar .btn-print{background:white;color:#003366}@media print{.toolbar{display:none}body{margin:0}}</style></head><body>';
  h+='<div class="toolbar"><button class="btn-pdf" onclick="window.opener.App.genDocPDF()">ğŸ“¥ PDF ë‹¤ìš´ë¡œë“œ</button><button class="btn-print" onclick="window.print()">ğŸ–¨ï¸ ì¸ì‡„</button>'+(S.docType==='pi'?'<button style="background:#00E676;color:#000" onclick="window.opener.App.convertPItoOrder(window._lastDocId)">ğŸ“‹ ì£¼ë¬¸ ì „í™˜</button>':'')+'</div><div style="margin-top:50px">';
  h+='<div style="padding:10px 16px;background:#FFF8E1;border:1px solid #FFE082;margin-bottom:12px;font-size:11px;color:#6D4C00;line-height:1.6">\u2696\uFE0F '+DISCLAIMER.en+'</div>';
  h+='<div class="ttl">'+tN[S.docType]+'</div>';
  h+='<table><tr><td style="border:none"><b style="font-size:15px">'+(c.name_en||c.name_ko||'COMPANY')+'</b><br>'+(c.address_en||'')+'<br>Tel: '+(c.phone||'')+'</td><td style="border:none;text-align:right"><b>No:</b> '+rd.doc_no+'<br><b>Date:</b> '+rd.doc_date+'</td></tr></table>';
  h+='<table><tr><td style="width:50%"><b>TO:</b> '+bd.buyer_company+'<br>'+(bd.buyer_contact?'Attn: '+bd.buyer_contact+'<br>':'')+(bd.buyer_address||'')+'</td><td>';
  if(isBL)h+='<b>Vessel:</b> '+(rd.vessel||'TBD')+'<br><b>Voyage:</b> '+(rd.voyage||'TBD')+'<br><b>Port of Loading:</b> '+(rd.port||'Busan, Korea')+'<br><b>Port of Discharge:</b> '+(rd.dest_port||'TBD')+'<br><b>B/L Type:</b> '+(rd.bl_type||'Original')+(rd.notify?'<br><b>Notify:</b> '+rd.notify:'');
  else if(isPL)h+='<b>Marks:</b> '+(rd.marks||'N/M')+'<br><b>Vessel:</b> '+(rd.vessel||'TBD');
  else if(isCO)h+='<b>Origin:</b> Republic of Korea<br><b>Criteria:</b> '+(rd.origin_criteria||'WO')+'<br><b>Transport:</b> '+(rd.transport||'Ocean');
  else if(isSC)h+='<b>Payment:</b> '+(rd.payment||'T/T')+'<br><b>Terms:</b> '+(rd.terms||'FOB')+' '+(rd.port||'Busan')+'<br><b>Delivery:</b> '+(rd.delivery_date||'TBD')+'<br><b>Warranty:</b> '+(rd.warranty||'12 months')+'<br><b>Dispute:</b> '+(rd.dispute||'ICC Arbitration, Seoul')+'<br><b>Deposit:</b> '+(rd.deposit_pct||30)+'%  |  <b>Late Penalty:</b> '+(rd.penalty_rate||0.1)+'%/day';
  else h+='<b>Payment:</b> '+(rd.payment||'T/T')+'<br><b>Terms:</b> '+(rd.terms||'FOB')+' '+(rd.port||'Busan');
  h+='</td></tr></table>';
  if(isPL||isBL){h+='<table><thead><tr><th>No</th><th>Description</th><th>Qty</th><th>Ctns</th><th>N.W.</th><th>G.W.</th><th>CBM</th><th>Dims</th></tr></thead><tbody>'+rows+'<tr style="font-weight:bold;background:#f5f5f5"><td colspan="2" style="text-align:right">TOTAL</td><td>'+tQ+'</td><td>'+tC+'</td><td>'+tNW.toFixed(1)+'</td><td>'+tGW.toFixed(1)+'</td><td>'+tCBM.toFixed(3)+'</td><td></td></tr></tbody></table>';}
  else if(isSC){h+='<table><thead><tr><th>No</th><th>Description</th><th>Qty</th><th>Unit Price</th><th>Amount</th></tr></thead><tbody>'+rows+'<tr style="font-weight:bold;background:#f5f5f5"><td colspan="4" style="text-align:right">TOTAL CONTRACT VALUE</td><td style="font-size:14px">$'+tA.toFixed(2)+'</td></tr></tbody></table>';
    h+='<div style="margin-top:20px;font-size:12px;line-height:2"><b>TERMS AND CONDITIONS</b><ol><li><b>Quality:</b> Products shall conform to the specifications described above.</li><li><b>Payment:</b> '+(rd.payment||'T/T')+'. 30% deposit upon contract signing, balance before shipment.</li><li><b>Delivery:</b> '+(rd.terms||'FOB')+' '+(rd.port||'Busan, Korea')+'. Delivery by '+(rd.delivery_date||'TBD')+'.</li><li><b>Inspection:</b> Buyer may inspect goods before shipment at Seller\'s facility.</li><li><b>Warranty:</b> '+(rd.warranty||'12 months from delivery')+'. Defective goods to be replaced.</li><li><b>Force Majeure:</b> Neither party liable for delays due to force majeure events.</li><li><b>Arbitration:</b> Disputes resolved under ICC Rules, Seoul, Korea.</li><li><b>Governing Law:</b> This contract is governed by the laws of Republic of Korea.</li></ol></div>';}
  else{h+='<table><thead><tr><th>No</th><th>Description</th><th>Qty</th><th>Unit Price</th><th>Amount</th></tr></thead><tbody>'+rows+'<tr style="font-weight:bold;background:#f5f5f5"><td colspan="4" style="text-align:right">TOTAL</td><td style="font-size:14px">$'+tA.toFixed(2)+'</td></tr></tbody></table>';}
  if(isCO){h+='<div style="margin-top:16px;padding:12px;border:1px solid #003366;font-size:12px;line-height:1.8"><b>DECLARATION BY THE EXPORTER</b><br>The undersigned hereby declares that the above details and statements are correct, that all the goods were produced in <b>Republic of Korea</b> and that they comply with the origin requirements specified for those goods in the KORUS FTA / RCEP for the goods exported to <b>'+(rd.dest_port||'destination')+'</b>.<br><br><b>Place and Date:</b> Seoul, Korea / '+rd.doc_date+'</div>';}
  h+='<div style="display:flex;justify-content:space-between;margin-top:40px"><div class="sig">'+(c.name_en||'SELLER')+'<br>'+(c.ceo_name_en||'')+'</div><div class="sig">'+bd.buyer_company+'<br>'+(bd.buyer_contact||'')+'</div></div>';
  if(!isPL&&!isCO&&c.bank_name){h+='<div style="margin-top:30px;padding:12px;border:1px solid #ccc;font-size:12px;line-height:1.8"><b>BANK:</b> '+c.bank_name+' / A/C: '+(c.bank_account||'')+' / SWIFT: '+(c.swift_code||'')+'</div>';}
  h+='</div></body></html>';
  var w=window.open('','_blank','width=850,height=700');w.document.write(h);w.document.close();
  sb.from('documents').insert({user_id:S.user.id,doc_type:S.docType,doc_number:rd.doc_no,buyer_name:bd.buyer_company,data:{buyer:bd,ref:rd,items:items,total:tA},status:'draft',disclaimer_shown:true}).select().then(function(r){UI.toast('ì„œë¥˜ ìƒì„±!','ok');if(r.data&&r.data[0]){_lastDoc.id=r.data[0].id;w._lastDocId=r.data[0].id;}});
}

function genDocPDF(){
  if(!_lastDoc){UI.toast('ì„œë¥˜ ë°ì´í„° ì—†ìŒ','warn');return;}
  var d=_lastDoc;var jsPDF=window.jspdf.jsPDF;var doc=new jsPDF('p','mm','a4');
  var w=210,m=15,cw=w-2*m;var y=20;
  /* header */
  doc.setFillColor(0,51,102);doc.rect(0,0,w,28,  'F');
  doc.setTextColor(255,255,255);doc.setFontSize(18);doc.setFont('helvetica','bold');
  doc.text(d.typeName,w/2,16,{align:'center'});
  doc.setFontSize(9);doc.text('No: '+d.ref.doc_no+'  |  Date: '+d.ref.doc_date,w/2,24,{align:'center'});
  y=36;
  /* seller & buyer */
  doc.setTextColor(0,0,0);doc.setFontSize(11);doc.setFont('helvetica','bold');
  doc.text(d.company.name_en||d.company.name_ko||'COMPANY',m,y);
  doc.setFontSize(9);doc.setFont('helvetica','normal');y+=5;
  doc.text(d.company.address_en||'',m,y);y+=4;
  doc.text('Tel: '+(d.company.phone||''),m,y);y+=8;
  doc.setDrawColor(200);doc.line(m,y,w-m,y);y+=6;
  doc.setFont('helvetica','bold');doc.setFontSize(10);
  doc.text('TO: '+d.buyer.buyer_company,m,y);y+=5;
  doc.setFont('helvetica','normal');doc.setFontSize(9);
  if(d.buyer.buyer_contact)doc.text('Attn: '+d.buyer.buyer_contact,m,y);y+=4;
  if(d.buyer.buyer_address)doc.text(d.buyer.buyer_address,m,y);y+=4;
  /* terms */
  var terms='';
  if(d.type==='pl')terms='Marks: '+(d.ref.marks||'N/M')+'  |  Vessel: '+(d.ref.vessel||'TBD');
  else if(d.type==='co')terms='Origin: Republic of Korea  |  Criteria: '+(d.ref.origin_criteria||'WO')+'  |  Transport: '+(d.ref.transport||'Ocean');
  else if(d.type==='sc')terms='Payment: '+(d.ref.payment||'T/T')+'  |  Terms: '+(d.ref.terms||'FOB')+' '+(d.ref.port||'Busan')+'  |  Delivery: '+(d.ref.delivery_date||'TBD');
  else terms='Payment: '+(d.ref.payment||'T/T')+'  |  Terms: '+(d.ref.terms||'FOB')+' '+(d.ref.port||'Busan');
  doc.text(terms,m,y);y+=8;
  /* items table */
  var head,body,foot;
  if(d.type==='pl'){
    head=[['No','Description','Qty','Ctns','N.W.','G.W.','CBM']];
    body=d.items.map(function(x,i){return [i+1,x.name+(x.desc?'\n'+x.desc:''),x.qty+' '+x.unit,x.ctn||'',x.nw?x.nw.toFixed(1):'',x.gw?x.gw.toFixed(1):'',x.cbm?x.cbm.toFixed(3):''];});
    foot=[['','TOTAL',d.totalQty,''+d.totalC,d.totalNW.toFixed(1),d.totalGW.toFixed(1),d.totalCBM.toFixed(3)]];
  }else{
    head=[['No','Description','Qty','Unit Price','Amount']];
    body=d.items.map(function(x,i){return [i+1,x.name+(x.desc?'\n'+x.desc:''),x.qty+' '+x.unit,'$'+x.price.toFixed(2),'$'+(x.qty*x.price).toFixed(2)];});
    foot=[['','','','TOTAL','$'+d.total.toFixed(2)]];
  }
  doc.autoTable({head:head,body:body,foot:foot,startY:y,margin:{left:m,right:m},styles:{fontSize:9,cellPadding:3},headStyles:{fillColor:[0,51,102],textColor:255},footStyles:{fillColor:[245,245,245],textColor:[0,0,0],fontStyle:'bold'},columnStyles:{0:{cellWidth:12}}});
  y=doc.lastAutoTable.finalY+10;
  /* SC contract terms */
  if(d.type==='sc'){
    doc.setFontSize(10);doc.setFont('helvetica','bold');doc.text('TERMS AND CONDITIONS',m,y);y+=6;
    doc.setFontSize(8);doc.setFont('helvetica','normal');
    var dep=d.ref.deposit_pct||30;var pen=d.ref.penalty_rate||0.1;
    var clauses=[
      '1. QUALITY STANDARDS',
      '   Products shall strictly conform to the specifications, quality and',
      '   standards described herein. Seller warrants that all products are',
      '   free from defects in material and workmanship.',
      '',
      '2. PAYMENT TERMS',
      '   '+( d.ref.payment||'T/T 30% deposit, 70% before shipment'),
      '   Deposit ('+dep+'%) due within 5 business days of contract signing.',
      '   Balance due before/upon shipment as agreed.',
      '',
      '3. DELIVERY & SHIPPING',
      '   Terms: '+(d.ref.terms||'FOB')+' '+(d.ref.port||'Busan, Korea'),
      '   Delivery Date: '+(d.ref.delivery_date||'TBD'),
      '   Partial shipment: Allowed / Transshipment: Allowed',
      '',
      '4. INSPECTION',
      '   Buyer may inspect goods prior to shipment at Seller\'s premises.',
      '   Inspection must be requested at least 7 days before shipment.',
      '   Final inspection at destination within 14 days of arrival.',
      '',
      '5. WARRANTY & CLAIMS',
      '   Warranty Period: '+(d.ref.warranty||'12 months from B/L date'),
      '   Claims must be filed within 30 days of discovery.',
      '   Defective goods to be replaced or credited at Seller\'s option.',
      '',
      '6. INTELLECTUAL PROPERTY',
      '   Seller retains all IP rights. Buyer shall not reverse-engineer,',
      '   copy, or modify products without written consent.',
      '',
      '7. LATE DELIVERY PENALTY',
      '   Penalty rate: '+pen+'% of contract value per calendar day of delay.',
      '   Maximum penalty: 10% of total contract value.',
      '   Delay > 30 days: Buyer may cancel without penalty.',
      '',
      '8. FORCE MAJEURE',
      '   Neither party liable for delays due to force majeure events.',
      '   Affected party must notify within 7 days. If > 60 days,',
      '   either party may terminate without liability.',
      '',
      '9. CONFIDENTIALITY',
      '   Both parties shall keep confidential all business information',
      '   disclosed during this agreement for a period of 2 years.',
      '',
      '10. DISPUTE RESOLUTION',
      '    '+(d.ref.dispute||'ICC International Court of Arbitration, Seoul, Korea'),
      '    Governing Law: Laws of the Republic of Korea',
      '',
      '11. GENERAL PROVISIONS',
      '    This contract constitutes the entire agreement. Amendments',
      '    must be in writing and signed by both parties.',
      '    This contract is executed in duplicate in English.'
    ];
    clauses.forEach(function(cl){if(y>270){doc.addPage();y=20;}doc.text(cl,m,y);y+=3.5;});y+=6;
  }
  /* CO declaration */
  if(d.type==='co'){
    doc.setFontSize(9);doc.setFont('helvetica','bold');doc.text('DECLARATION BY THE EXPORTER',m,y);y+=5;
    doc.setFont('helvetica','normal');doc.setFontSize(8);
    var _ftaMap={US:'KORUS FTA',JP:'RCEP / Korea-Japan EPA',EU:'Korea-EU FTA',DE:'Korea-EU FTA',FR:'Korea-EU FTA',NL:'Korea-EU FTA',GB:'Korea-UK FTA',AU:'KAFTA (Korea-Australia FTA)',CN:'RCEP / Korea-China FTA',SG:'RCEP / Korea-ASEAN FTA',VN:'RCEP / Korea-ASEAN FTA',TH:'RCEP / Korea-ASEAN FTA',ID:'RCEP / Korea-ASEAN FTA',AE:'Korea-GCC FTA (pending)',CA:'CKFTA (Canada-Korea FTA)',IN:'Korea-India CEPA',NZ:'Korea-New Zealand FTA'};
    var _buyerCC=(d.buyer.buyer_country||'').toUpperCase().substring(0,2);var _ftaName=_ftaMap[_buyerCC]||'applicable FTA';
    var decl='The undersigned declares that the above goods were produced in Republic of Korea and comply with the origin requirements specified in '+_ftaName+'.';
    var lines=doc.splitTextToSize(decl,cw);doc.text(lines,m,y);y+=lines.length*4+4;
    doc.text('Place and Date: Seoul, Korea / '+d.ref.doc_date,m,y);y+=8;
  }
  /* signatures */
  if(y>250){doc.addPage();y=20;}
  doc.setDrawColor(0);doc.line(m,y+15,m+60,y+15);doc.line(w-m-60,y+15,w-m,y+15);
  doc.setFontSize(9);doc.setFont('helvetica','bold');
  doc.text(d.company.name_en||'SELLER',m,y+20);
  doc.text(d.buyer.buyer_company,w-m-60,y+20);y+=28;
  /* bank info */
  if(d.type!=='pl'&&d.type!=='co'&&d.company.bank_name){
    doc.setDrawColor(200);doc.rect(m,y,cw,16);
    doc.setFontSize(8);doc.setFont('helvetica','normal');
    doc.text('BANK: '+d.company.bank_name+' / A/C: '+(d.company.bank_account||'')+' / SWIFT: '+(d.company.swift_code||''),m+4,y+6);y+=20;
  }
  /* disclaimer */
  doc.setFillColor(255,248,225);doc.rect(m,y,cw,10,'F');doc.setFontSize(7);doc.setTextColor(109,76,0);
  doc.text(DISCLAIMER.en.substring(0,120)+'...',m+2,y+5);
  /* save */
  var fn=d.ref.doc_no+'_'+d.type.toUpperCase()+'.pdf';
  doc.save(fn);
  UI.toast('PDF ë‹¤ìš´ë¡œë“œ: '+fn,'ok');
}

function pgEmail(){
  var gate=_planGate('emailhub');
  var ts=[{t:'intro',n:'ğŸ¤ ì œí’ˆ ì†Œê°œ',d:'ì²« ì œí’ˆ ì†Œê°œ ë©”ì¼'},{t:'quote',n:'ğŸ’° ê²¬ì  íšŒì‹ ',d:'ê°€ê²©/ì¡°ê±´ íšŒì‹ '},{t:'sample',n:'ğŸ“¦ ìƒ˜í”Œ ë°œì†¡',d:'ìƒ˜í”Œ ì•ˆë‚´/ì¶”ì ë²ˆí˜¸'},{t:'followup',n:'ğŸ”„ íŒ”ë¡œì—…',d:'í›„ì† ì—°ë½'},{t:'shipping',n:'ğŸš¢ ì„ ì  í†µë³´',d:'B/L ë° ë„ì°©ì¼'},{t:'thankyou',n:'ğŸ™ ê°ì‚¬/ë¦¬ì˜¤ë”',d:'ê±°ë˜ ê°ì‚¬'}];
  var logs=S.emailLogs||[];
  var logSection=logs.length?'<div class="card" style="margin-top:16px"><div class="card-h"><span>ğŸ“¬ ë°œì†¡ ì´ë ¥</span>'+UI.badge(logs.length+'ê±´','pri')+'</div><div class="card-b" style="padding:0"><table class="tbl"><thead><tr><th>ìˆ˜ì‹ </th><th>ì œëª©</th><th>ìƒíƒœ</th><th>ë‚ ì§œ</th></tr></thead><tbody>'+logs.slice(0,20).map(function(l){var sc={sent:'ë°œì†¡',delivered:'ìˆ˜ì‹ ',opened:'ì—´ëŒ',failed:'ì‹¤íŒ¨',bounced:'ë°˜ì†¡'};var tc={sent:'pri',delivered:'ok',opened:'ok',failed:'err',bounced:'err'};return '<tr><td style="font-size:12px">'+l.to_email+'</td><td style="font-size:12px">'+U.tr(l.subject,40)+'</td><td>'+UI.badge(sc[l.status]||l.status,tc[l.status]||'ghost')+'</td><td style="font-size:11px;color:var(--w40)">'+U.fd(l.created_at,'rel')+'</td></tr>';}).join('')+'</tbody></table></div></div>':'';
  var content='<div style="margin-bottom:20px"><h2 style="font-size:18px;font-weight:800">âœ‰ï¸ ì´ë©”ì¼ í—ˆë¸Œ</h2><p style="font-size:13px;color:var(--w40);margin-top:4px">ìƒí™©ë³„ ì˜ë¬¸ ì´ë©”ì¼ ìë™ ìƒì„± + ë°œì†¡</p></div><div class="grid-3" style="margin-bottom:20px">'+ts.map(function(t){return '<div class="svc-card" style="padding:16px" onclick="App.composeE(\''+t.t+'\')"><div style="font-size:14px;font-weight:700;margin-bottom:4px">'+t.n+'</div><div style="font-size:12px;color:var(--w40)">'+t.d+'</div></div>';}).join('')+'</div>'+(S.buyers.length?'<div class="card"><div class="card-h">ğŸ“‡ ë°”ì´ì–´ ì„ íƒ ë°œì†¡</div><div class="card-b"><div style="display:flex;flex-wrap:wrap;gap:8px">'+S.buyers.slice(0,10).map(function(b){return '<div style="padding:8px 14px;border-radius:10px;background:var(--w08);cursor:pointer;font-size:12px" onclick="App.composeE(\'intro\',\''+b.id+'\')"><b>'+b.company_name+'</b> '+U.cl(b.country)+'</div>';}).join('')+'</div></div></div>':'')+logSection;
  if(gate.blocked)return _lockOverlay(gate)+content+_lockOverlayEnd(gate);
  return content;
}

function emailTpl(type,bn,prod){
  var c=S.company||{};var s=c.name_en||c.name_ko||'Our Company';var p=prod||'our products';var b=bn||'Sir/Madam';var sig=(c.ceo_name_en||'[Your Name]')+'\n'+s;
  var t={
    intro:{subj:'Introduction - '+p+' from '+s,body:'Dear '+b+',\n\nI am writing to introduce '+s+', a Korean manufacturer of '+p+'.\n\nKey Highlights:\n- Premium Korean quality\n- Competitive FOB pricing\n- Certifications available\n- Flexible MOQ\n\nI would be happy to provide our catalog and pricing.\n\nBest regards,\n'+sig},
    quote:{subj:'RE: Quotation for '+p,body:'Dear '+b+',\n\nThank you for your interest.\n\nProduct: '+p+'\nFOB Price: USD $ [PRICE] / unit\nMOQ: [MOQ] units\nPayment: T/T 30% deposit, 70% before shipment\nDelivery: 2-3 weeks\nPort: Busan, Korea\n\nValid for 30 days. Sample available.\n\nBest regards,\n'+sig},
    sample:{subj:'Sample Shipment - '+p,body:'Dear '+b+',\n\nSample has been shipped.\n\nCourier: [DHL/FedEx]\nTracking: [NUMBER]\nETA: [DATE]\n\nPlease confirm upon receipt.\n\nBest regards,\n'+sig},
    followup:{subj:'Following Up - '+s,body:'Dear '+b+',\n\nI wanted to follow up regarding '+p+'.\n\nWe can:\n- Adjust pricing/terms\n- Provide additional info\n- Arrange a call\n\nLooking forward to your reply.\n\nBest regards,\n'+sig},
    shipping:{subj:'Shipment Notification',body:'Dear '+b+',\n\nYour order has been shipped.\n\nB/L: [NUMBER]\nVessel: [NAME]\nETD: [DATE] Busan\nETA: [DATE]\n\nDocuments will follow.\n\nBest regards,\n'+sig},
    thankyou:{subj:'Thank You',body:'Dear '+b+',\n\nThank you for your order.\n\nWe offer returning partners:\n- Priority scheduling\n- Volume discounts\n- New samples\n\nLooking forward to continued partnership.\n\nBest regards,\n'+sig}
  };
  return t[type]||t.intro;
}

function composeE(type,buyerId){
  var buyer=buyerId?S.buyers.find(function(b){return b.id===buyerId;}):null;
  var bName=buyer?buyer.contact_name||buyer.company_name:'';
  var bEmail=buyer?buyer.email||'':'';
  var prod=S.products.length?S.products[0].name_en||S.products[0].name_ko:'our products';
  var tpl=emailTpl(type,bName,prod);
  var body='<form id="ef">'+UI.inp('to','ë°›ëŠ” ì‚¬ëŒ',{placeholder:'buyer@company.com',value:bEmail})+(S.buyers.length?'<div class="form-group"><label class="form-label">ë°”ì´ì–´</label><select class="form-select" name="bsel" onchange="App.selEB(this.value,\''+type+'\')"><option value="">ì§ì ‘ ì…ë ¥</option>'+S.buyers.map(function(b){return '<option value="'+b.id+'" '+(b.id===buyerId?'selected':'')+'>'+b.company_name+' ('+(b.email||'-')+')</option>';}).join('')+'</select></div>':'')+'<hr style="border:none;border-top:1px solid var(--bd);margin:8px 0">'+UI.inp('subject','ì œëª©',{value:tpl.subj})+UI.ta('body','ë‚´ìš©',{rows:14,value:tpl.body})+(S.products.length>1?'<div class="form-group"><label class="form-label">ì œí’ˆ ë³€ê²½</label><select class="form-select" onchange="App.chgEP(\''+type+'\',this.value)">'+S.products.map(function(p){return '<option value="'+(p.name_en||p.name_ko)+'">'+p.name_ko+'</option>';}).join('')+'</select></div>':'')+'</form>';
  document.body.insertAdjacentHTML('beforeend',UI.modal({id:'em',title:'âœ‰ï¸ ì´ë©”ì¼ ì‘ì„±',body:body,footer:'<button class="btn btn-ghost" onclick="App.closeModal(\'em\')">ì·¨ì†Œ</button><button class="btn btn-ghost" onclick="App.cpEmail()">ğŸ“‹ ë³µì‚¬</button><button class="btn btn-pri" onclick="App.sendE()">ğŸ“§ ë°œì†¡</button>',width:'640px'}));UI.showModal('em');
}

function selEB(bid,type){if(!bid)return;var b=S.buyers.find(function(x){return x.id===bid;});if(!b)return;var to=document.querySelector('#ef [name=to]');if(to)to.value=b.email||'';var prod=S.products.length?S.products[0].name_en||S.products[0].name_ko:'our products';var tpl=emailTpl(type,b.contact_name||b.company_name,prod);var sj=document.querySelector('#ef [name=subject]');if(sj)sj.value=tpl.subj;var bd=document.querySelector('#ef [name=body]');if(bd)bd.value=tpl.body;}
function chgEP(type,prod){var bs=document.querySelector('#ef [name=bsel]');var buyer=bs&&bs.value?S.buyers.find(function(x){return x.id===bs.value;}):null;var tpl=emailTpl(type,buyer?buyer.contact_name:'',prod);var sj=document.querySelector('#ef [name=subject]');if(sj)sj.value=tpl.subj;var bd=document.querySelector('#ef [name=body]');if(bd)bd.value=tpl.body;}
function cpEmail(){var d=UI.fd('#ef');navigator.clipboard.writeText('To: '+(d.to||'')+'\nSubject: '+(d.subject||'')+'\n\n'+(d.body||'')).then(function(){UI.toast('ë³µì‚¬ë¨','ok');});}
function sendE(){
  var d=UI.fd('#ef');if(!d.to){UI.toast('ë°›ëŠ” ì‚¬ëŒ ì…ë ¥','warn');return;}
  var btn=document.querySelector('#em .btn-pri');if(btn){btn.disabled=true;btn.textContent='ë°œì†¡ ì¤‘...';}
  var bs=document.querySelector('#ef [name=bsel]');var buyerId=bs?bs.value:'';
  fetch(RELAY_URL+'/api/whistle/send-email',{method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({to:d.to,subject:d.subject||'',bodyText:d.body||'',userId:S.user.id,buyerId:buyerId||null})
  }).then(function(r){return r.json();}).then(function(data){
    if(data.ok){
      UI.toast(data.method==='resend'?'ì´ë©”ì¼ ë°œì†¡ ì™„ë£Œ!':'ì´ë©”ì¼ ê¸°ë¡ ì €ì¥ (APIí‚¤ ë¯¸ì„¤ì • â†’ ë©”ì¼ì•±ìœ¼ë¡œ ë°œì†¡)','ok');
      if(data.method==='logged_only')window.open('mailto:'+d.to+'?subject='+encodeURIComponent(d.subject||'')+'&body='+encodeURIComponent(d.body||''));
      loadEmailLogs();
      pushNotif('email','ì´ë©”ì¼ ë°œì†¡: '+(d.subject||'(ì œëª©ì—†ìŒ)').substring(0,30),'ìˆ˜ì‹ : '+d.to,'emailhub');
    }else{UI.toast('ë°œì†¡ ì‹¤íŒ¨: '+(data.error||''),'err');window.open('mailto:'+d.to+'?subject='+encodeURIComponent(d.subject||'')+'&body='+encodeURIComponent(d.body||''));}
    closeModal('em');
  }).catch(function(){
    window.open('mailto:'+d.to+'?subject='+encodeURIComponent(d.subject||'')+'&body='+encodeURIComponent(d.body||''));
    closeModal('em');
  });
}
function loadEmailLogs(){
  return sb.from('email_logs').select('*').eq('user_id',S.user.id).order('created_at',{ascending:false}).limit(50).then(function(r){S.emailLogs=r.data||[];});
}
function loadShippingRates(){
  return sb.from('shipping_rates').select('*').then(function(r){S.shippingRates=r.data||[];});
}
function loadTariffRates(){
  return sb.from('tariff_rates').select('*').then(function(r){S.tariffRates=r.data||[];});
}
function loadOrders(){
  return sb.from('orders').select('*').eq('user_id',S.user.id).order('created_at',{ascending:false}).then(function(r){S.orders=r.data||[];});
}
function loadNotifications(){
  return sb.from('notifications').select('*').eq('user_id',S.user.id).order('created_at',{ascending:false}).limit(30).then(function(r){S.notifications=r.data||[];});
}
function loadMeetings(){return sb.from('meetings').select('*').eq('user_id',S.user.id).order('scheduled_at',{ascending:false}).then(function(r){S.meetings=r.data||[];});}
function loadSamples(){return sb.from('samples').select('*').eq('user_id',S.user.id).order('created_at',{ascending:false}).then(function(r){S.samples=r.data||[];});}
function loadShipments(){return sb.from('shipments').select('*').eq('user_id',S.user.id).order('created_at',{ascending:false}).then(function(r){S.shipments=r.data||[];});}
function loadMilestones(){return sb.from('payment_milestones').select('*').eq('user_id',S.user.id).order('created_at',{ascending:true}).then(function(r){S.paymentMilestones=r.data||[];});}
function loadAlibabaStores(){return sb.from('alibaba_stores').select('*').eq('user_id',S.user.id).then(function(r){S.alibabaStores=r.data||[];});}
function loadAlibabaInquiries(){return sb.from('alibaba_inquiries').select('*').eq('user_id',S.user.id).order('created_at',{ascending:false}).then(function(r){S.alibabaInquiries=r.data||[];});}


function pgCost(){
  var DESTS=[
    {value:'US_LA',label:'ğŸ‡ºğŸ‡¸ LA (ë¯¸ì„œë¶€)',cc:'US'},{value:'US_NY',label:'ğŸ‡ºğŸ‡¸ ë‰´ìš• (ë¯¸ë™ë¶€)',cc:'US'},
    {value:'JP_TYO',label:'ğŸ‡¯ğŸ‡µ ë„ì¿„',cc:'JP'},{value:'JP_OSA',label:'ğŸ‡¯ğŸ‡µ ì˜¤ì‚¬ì¹´',cc:'JP'},
    {value:'DE_HAM',label:'ğŸ‡©ğŸ‡ª í•¨ë¶€ë¥´í¬ (EU)',cc:'DE'},{value:'CN_SHA',label:'ğŸ‡¨ğŸ‡³ ìƒí•´',cc:'CN'},
    {value:'SG',label:'ğŸ‡¸ğŸ‡¬ ì‹±ê°€í¬ë¥´',cc:'SG'},{value:'VN_HCM',label:'ğŸ‡»ğŸ‡³ í˜¸ì¹˜ë¯¼',cc:'VN'},
    {value:'AE_DXB',label:'ğŸ‡¦ğŸ‡ª ë‘ë°”ì´',cc:'AE'},{value:'AU_SYD',label:'ğŸ‡¦ğŸ‡º ì‹œë“œë‹ˆ',cc:'AU'}
  ];
  var SHIPS=[
    {value:'lcl',label:'ğŸš¢ í•´ìƒ LCL (ì†ŒëŸ‰)'},{value:'fcl_20',label:'ğŸš¢ í•´ìƒ FCL 20ft'},
    {value:'fcl_40',label:'ğŸš¢ í•´ìƒ FCL 40ft'},{value:'air',label:'âœˆï¸ í•­ê³µ'},
    {value:'express',label:'ğŸ“¦ íŠ¹ì†¡ (DHL/FedEx)'}
  ];
  var HS_PRESETS=[
    {value:'',label:'-- ì§ì ‘ ì…ë ¥ --'},
    {value:'3304.99',label:'3304.99 ìŠ¤í‚¨ì¼€ì–´'},{value:'3304.10',label:'3304.10 ë¦½ ë©”ì´í¬ì—…'},
    {value:'3304.20',label:'3304.20 ì•„ì´ ë©”ì´í¬ì—…'},{value:'3304.91',label:'3304.91 íŒŒìš°ë”'},
    {value:'3305.10',label:'3305.10 ìƒ´í‘¸'},{value:'3305.90',label:'3305.90 ê¸°íƒ€ í—¤ì–´ì¼€ì–´'},
    {value:'3307.10',label:'3307.10 í–¥ìˆ˜'},{value:'3307.90',label:'3307.90 ë°©í–¥ì œ/ë””í“¨ì €'},
    {value:'3401.11',label:'3401.11 ë¹„ëˆ„/í´ë Œì§•'},
    {value:'2106.90',label:'2106.90 ê±´ê°•ê¸°ëŠ¥ì‹í’ˆ'},{value:'2202.99',label:'2202.99 ìŒë£Œ'},
    {value:'2103.90',label:'2103.90 ì†ŒìŠ¤/ì–‘ë…ë¥˜'},{value:'2103.10',label:'2103.10 ê°„ì¥'},
    {value:'2005.99',label:'2005.99 ê¹€ì¹˜/ì ˆì„ì‹í’ˆ'},{value:'1902.30',label:'1902.30 ë¼ë©´/ì¦‰ì„ë©´'},
    {value:'6307.90',label:'6307.90 ë§ˆìŠ¤í¬íŒ©'},{value:'8509.80',label:'8509.80 ë·°í‹°ë””ë°”ì´ìŠ¤'},
    {value:'6110.30',label:'6110.30 ë‹ˆíŠ¸/ìŠ¤ì›¨í„°(í™”ì„¬)'},{value:'6104.62',label:'6104.62 ë°”ì§€(ë©´)'},
    {value:'6109.10',label:'6109.10 í‹°ì…”ì¸ (ë©´)'},{value:'6204.62',label:'6204.62 ì—¬ì„± ë°”ì§€(ë©´)'},
    {value:'8543.70',label:'8543.70 ì „ìê¸°ê¸° ê¸°íƒ€'},{value:'8526.91',label:'8526.91 IoT/ë¬´ì„ ê¸°ê¸°'},
    {value:'8528.72',label:'8528.72 ëª¨ë‹ˆí„°/ë””ìŠ¤í”Œë ˆì´'},{value:'8471.30',label:'8471.30 ë…¸íŠ¸ë¶/íƒœë¸”ë¦¿'},
    {value:'4419.19',label:'4419.19 ëª©ì¬ ì‹ê¸°/ì£¼ë°©ìš©í’ˆ'},{value:'3924.10',label:'3924.10 í”Œë¼ìŠ¤í‹± ì‹ê¸°'},
    {value:'6911.10',label:'6911.10 ë„ìê¸° ì‹ê¸°'},{value:'7323.93',label:'7323.93 ìŠ¤í…Œì¸ë¦¬ìŠ¤ ì£¼ë°©ìš©í’ˆ'},
    {value:'2309.90',label:'2309.90 ë°˜ë ¤ë™ë¬¼ ì‚¬ë£Œ'},{value:'8708.99',label:'8708.99 ìë™ì°¨ë¶€í’ˆ'}
  ];
  return '<div style="margin-bottom:20px"><h2 style="font-size:18px;font-weight:800">ğŸ§® Landed Cost ê³„ì‚°ê¸°</h2><p style="font-size:12px;color:var(--w40);margin-top:4px">FOB â†’ CIF â†’ ê´€ì„¸ â†’ ë¶€ê°€ì„¸ â†’ í†µê´€ë¹„ â†’ ë‚´ë¥™ìš´ì†¡ = ìµœì¢… Landed Cost</p></div>'+
  '<div class="card"><div class="card-h">ì œí’ˆ + ë¬¼ë¥˜ ì •ë³´</div><div class="card-b"><form id="cf" onsubmit="event.preventDefault();App.calcC()">'+
  '<div class="grid-3">'+UI.inp('fob_price','FOB ë‹¨ê°€(USD)',{type:'number',step:'0.01',placeholder:'4.50'})+UI.inp('quantity','ìˆ˜ëŸ‰(pcs)',{type:'number',placeholder:'5000'})+UI.inp('weight_kg','ì´ ì¤‘ëŸ‰(kg)',{type:'number',placeholder:'150'})+'</div>'+
  '<div class="grid-3">'+UI.inp('cbm','ìš©ì (CBM)',{type:'number',step:'0.01',placeholder:'1.5'})+
  UI.sel('hs_preset','HSì½”ë“œ ì„ íƒ',HS_PRESETS,{onchange:'document.getElementById("hs_code").value=this.value'})+
  UI.inp('hs_code','HSì½”ë“œ ì§ì ‘ì…ë ¥',{placeholder:'3304.99'})+'</div>'+
  '<div class="grid-2">'+UI.sel('dest','ë„ì°©ì§€',DESTS)+UI.sel('ship','ìš´ì†¡ ë°©ì‹',SHIPS)+'</div>'+
  '<div style="display:flex;gap:10px;margin-top:12px"><button class="btn btn-pri" type="submit" style="flex:1">Landed Cost ê³„ì‚°</button><button class="btn btn-ghost" type="button" onclick="App.calcCCompare()" style="flex:1">ì „ì²´ ë…¸ì„  ë¹„êµ</button></div>'+
  '</form><div id="cr"></div></div></div>';
}

var _COST_DESTS={US_LA:{n:'LA',cc:'US'},US_NY:{n:'ë‰´ìš•',cc:'US'},JP_TYO:{n:'ë„ì¿„',cc:'JP'},JP_OSA:{n:'ì˜¤ì‚¬ì¹´',cc:'JP'},DE_HAM:{n:'í•¨ë¶€ë¥´í¬',cc:'DE'},CN_SHA:{n:'ìƒí•´',cc:'CN'},SG:{n:'ì‹±ê°€í¬ë¥´',cc:'SG'},VN_HCM:{n:'í˜¸ì¹˜ë¯¼',cc:'VN'},AE_DXB:{n:'ë‘ë°”ì´',cc:'AE'},AU_SYD:{n:'ì‹œë“œë‹ˆ',cc:'AU'}};

function calcC(){
  var d=UI.fd('#cf');if(!d.fob_price||!d.quantity){UI.toast('FOB ë‹¨ê°€ì™€ ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”','warn');return;}
  var dest=d.dest||'US_LA';var ship=d.ship||'lcl';var hs=d.hs_code||d.hs_preset||'3304.99';
  var qty=parseFloat(d.quantity);var fobUnit=parseFloat(d.fob_price);var wt=parseFloat(d.weight_kg)||100;var cbm=parseFloat(d.cbm)||Math.max(wt/500,0.5);
  var fobTotal=fobUnit*qty;
  var di=_COST_DESTS[dest]||{n:dest,cc:'US'};

  /* DBì—ì„œ ìš´ì„ ì¡°íšŒ */
  var sr=S.shippingRates||[];var tr=S.tariffRates||[];
  var rate=sr.find(function(r){return r.destination===dest&&r.shipping_type===ship;});
  var tariff=tr.find(function(t){return t.destination_country===di.cc&&hs.indexOf(t.hs_code)===0;});
  if(!tariff)tariff=tr.find(function(t){return t.destination_country===di.cc&&hs.substring(0,4)===t.hs_code.substring(0,4);});

  /* ìš´ì„ ê³„ì‚° */
  var freight=0;var transitMin=0;var transitMax=0;
  if(rate){
    transitMin=rate.transit_days_min||0;transitMax=rate.transit_days_max||0;
    if(rate.unit==='kg')freight=Math.max(rate.rate*wt,rate.min_charge||0);
    else if(rate.unit==='cbm')freight=Math.max(rate.rate*cbm,rate.min_charge||0);
    else freight=rate.rate;
  }else{
    freight=ship==='air'?wt*5:ship==='express'?wt*8.5:Math.max(cbm*55,180);
  }

  /* ë³´í—˜ë£Œ (CIFì˜ 0.3%) */
  var insurance=fobTotal*0.003;
  var cifTotal=fobTotal+freight+insurance;

  /* ê´€ì„¸ ê³„ì‚° */
  var dutyRate=0;var ftaRate=null;var ftaName='';var vatRate=0;var notes='';
  if(tariff){
    dutyRate=parseFloat(tariff.duty_rate)||0;
    if(tariff.fta_applicable){ftaRate=parseFloat(tariff.fta_rate);ftaName=tariff.fta_name||'';}
    vatRate=parseFloat(tariff.vat_rate)||0;
    notes=tariff.notes||'';
  }
  var effectiveDuty=(ftaRate!==null&&ftaRate<dutyRate)?ftaRate:dutyRate;
  var dutyAmt=cifTotal*(effectiveDuty/100);
  var vatAmt=(cifTotal+dutyAmt)*(vatRate/100);
  var ftaSaving=(ftaRate!==null&&ftaRate<dutyRate)?cifTotal*((dutyRate-ftaRate)/100):0;

  /* í†µê´€ + ë‚´ë¥™ìš´ì†¡ (ê³ ì • ì¶”ì •) */
  var brokerage=ship==='express'?50:150;
  var inland=ship==='express'?0:(di.cc==='JP'?80:di.cc==='CN'?60:di.cc==='SG'||di.cc==='VN'?70:di.cc==='AE'?100:di.cc==='AU'?120:150);

  var landed=cifTotal+dutyAmt+vatAmt+brokerage+inland;
  var landedUnit=landed/qty;
  var margin30=landedUnit*1.3;var margin50=landedUnit*1.5;

  /* ê²°ê³¼ ë Œë” */
  var h='<div style="margin-top:16px">';
  /* í—¤ë” */
  h+='<div style="padding:16px;border-radius:12px 12px 0 0;background:linear-gradient(135deg,#0a1628,#1a2a4a);color:#fff"><div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px"><div><div style="font-size:11px;opacity:.7">ë¶€ì‚° â†’ '+di.n+'</div><div style="font-size:20px;font-weight:800">Landed Cost: '+U.fmtUSD(landed)+'</div></div><div style="text-align:right"><div style="font-size:11px;opacity:.7">ë‹¨ê°€</div><div style="font-size:16px;font-weight:700;color:#00d4ff">'+U.fmtUSD(landedUnit)+'/pc</div></div></div></div>';

  /* ìƒì„¸ ë‚´ì—­ */
  h+='<div style="padding:16px;border-radius:0 0 12px 12px;background:var(--sf);border:1px solid var(--bd);border-top:0">';
  var rows=[
    ['FOB ì´ì•¡ ('+U.fmtUSD(fobUnit)+' Ã— '+U.n(qty)+')',fobTotal,''],
    ['ìš´ì„ ('+(rate?rate.notes:ship)+')'+((transitMin||transitMax)?' Â· '+transitMin+'-'+transitMax+'ì¼':''),freight,''],
    ['ì í•˜ë³´í—˜ (0.3%)',insurance,''],
    ['<b>CIF ì´ì•¡</b>',cifTotal,'pri'],
  ];
  if(effectiveDuty>0)rows.push(['ê´€ì„¸ ('+effectiveDuty+'%'+(ftaName?' Â· '+ftaName:'')+')'+((ftaSaving>0)?' <span style="color:var(--ok)">FTA ì ˆê° '+U.fmtUSD(ftaSaving)+'</span>':''),dutyAmt,'']);
  else rows.push(['ê´€ì„¸','0 (FTA 0%)','ok']);
  if(vatRate>0)rows.push(['ë¶€ê°€ì„¸/GST ('+vatRate+'%)',vatAmt,'']);
  rows.push(['í†µê´€ ìˆ˜ìˆ˜ë£Œ',brokerage,'']);
  rows.push(['ë‚´ë¥™ìš´ì†¡ (ì¶”ì •)',inland,'']);
  rows.push(['<b>LANDED COST</b>',landed,'acc']);

  h+='<div style="display:grid;grid-template-columns:1fr auto;gap:6px 12px;font-size:13px">';
  rows.forEach(function(r){
    var cls=r[2]==='acc'?'border-top:2px solid var(--acc);padding-top:10px;margin-top:6px;font-weight:800;color:var(--acc);font-size:15px':r[2]==='pri'?'border-top:1px solid var(--bd);padding-top:8px;font-weight:700;color:var(--pri)':r[2]==='ok'?'color:var(--ok);font-weight:600':'color:var(--w60)';
    h+='<div style="'+cls+'">'+r[0]+'</div><div style="text-align:right;'+cls+'">'+(typeof r[1]==='number'?U.fmtUSD(r[1]):r[1])+'</div>';
  });
  h+='</div>';

  /* íŒë§¤ê°€ ê°€ì´ë“œ */
  h+='<div style="margin-top:14px;padding:12px;border-radius:10px;background:var(--w08)"><div style="font-size:12px;font-weight:700;margin-bottom:6px">ğŸ’¡ ê¶Œì¥ ì†Œë¹„ìê°€ (ë§ˆì§„ í¬í•¨)</div><div style="display:flex;gap:16px;font-size:13px"><div>ë§ˆì§„ 30%: <b style="color:var(--pri)">'+U.fmtUSD(margin30)+'</b>/pc</div><div>ë§ˆì§„ 50%: <b style="color:var(--acc)">'+U.fmtUSD(margin50)+'</b>/pc</div></div></div>';

  /* ê·œì œ ë…¸íŠ¸ */
  if(notes)h+='<div style="margin-top:10px;padding:10px;border-radius:8px;background:rgba(255,184,0,.08);border:1px solid rgba(255,184,0,.15);font-size:12px;color:var(--acc)">âš ï¸ '+notes+'</div>';

  /* í¬ì›Œë” RFQ ë²„íŠ¼ */
  h+='<div style="margin-top:12px;display:flex;gap:8px"><button class="btn btn-pri btn-sm" onclick="App.genForwarderRFQ()">ğŸš¢ í¬ì›Œë” ê²¬ì  ìš”ì²­ì„œ ìƒì„±</button><button class="btn btn-ghost btn-sm" onclick="App.reqSvc(\'logistics\')">ğŸ’¼ ë¬¼ë¥˜ ëŒ€í–‰ ì‹ ì²­</button></div>';
  h+='<div id="rfq-result"></div>';

  h+='<div style="margin-top:10px;font-size:10px;color:var(--w20)">* ìš´ì„ì€ 2026.02 ê¸°ì¤€ í‰ê·  ì‹œì„¸. ì‹¤ì œ ìš´ì„ì€ í¬ì›Œë” ê²¬ì  í•„ìš”. ê´€ì„¸ìœ¨ì€ FTA ì›ì‚°ì§€ ì¦ëª…ì„œ ì œì¶œ ê¸°ì¤€.</div>';
  h+='</div></div>';
  document.getElementById('cr').innerHTML=h;
  /* ê³„ì‚° ë°ì´í„° ì„ì‹œ ì €ì¥ (RFQìš©) */
  window._lastCalc={dest:dest,destName:di.n,ship:ship,fobTotal:fobTotal,qty:qty,wt:wt,cbm:cbm,hs:hs,cifTotal:cifTotal,freight:freight,transitMin:transitMin,transitMax:transitMax};
}

function calcCCompare(){
  var d=UI.fd('#cf');if(!d.fob_price||!d.quantity){UI.toast('FOB ë‹¨ê°€ì™€ ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”','warn');return;}
  var hs=d.hs_code||d.hs_preset||'3304.99';var qty=parseFloat(d.quantity);var fobUnit=parseFloat(d.fob_price);var wt=parseFloat(d.weight_kg)||100;var cbm=parseFloat(d.cbm)||Math.max(wt/500,0.5);
  var fobTotal=fobUnit*qty;var sr=S.shippingRates||[];var tr=S.tariffRates||[];
  var results=[];
  Object.keys(_COST_DESTS).forEach(function(dest){
    var di=_COST_DESTS[dest];
    ['lcl','air'].forEach(function(ship){
      var rate=sr.find(function(r){return r.destination===dest&&r.shipping_type===ship;});
      if(!rate)return;
      var freight=rate.unit==='kg'?Math.max(rate.rate*wt,rate.min_charge||0):rate.unit==='cbm'?Math.max(rate.rate*cbm,rate.min_charge||0):rate.rate;
      var ins=fobTotal*0.003;var cif=fobTotal+freight+ins;
      var tariff=tr.find(function(t){return t.destination_country===di.cc&&hs.indexOf(t.hs_code)===0;});
      var eff=0;var fta='';
      if(tariff){eff=(tariff.fta_applicable&&parseFloat(tariff.fta_rate)<parseFloat(tariff.duty_rate))?parseFloat(tariff.fta_rate):parseFloat(tariff.duty_rate);fta=tariff.fta_name||'';}
      var duty=cif*(eff/100);var vat=(tariff?(cif+duty)*(parseFloat(tariff.vat_rate)||0)/100:0);
      var brok=ship==='express'?50:150;var inl=ship==='express'?0:(di.cc==='JP'?80:di.cc==='CN'?60:150);
      var landed=cif+duty+vat+brok+inl;
      results.push({dest:dest,name:di.n,ship:ship,freight:freight,cif:cif,duty:eff,fta:fta,landed:landed,unit:landed/qty,transit:(rate.transit_days_min||0)+'-'+(rate.transit_days_max||0)+'ì¼'});
    });
  });
  results.sort(function(a,b){return a.landed-b.landed;});
  var h='<div style="margin-top:16px"><div style="font-weight:700;margin-bottom:10px;font-size:14px">ğŸ“Š ì „ì²´ ë…¸ì„  ë¹„êµ ('+hs+', '+U.n(qty)+'pcs)</div>';
  h+='<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:12px"><thead><tr style="background:var(--w08);text-align:left"><th style="padding:8px">ë„ì°©ì§€</th><th>ìš´ì†¡</th><th>ìš´ì„</th><th>ê´€ì„¸</th><th>FTA</th><th>ì†Œìš”</th><th style="text-align:right">Landed</th><th style="text-align:right">ë‹¨ê°€</th></tr></thead><tbody>';
  results.forEach(function(r,i){
    var bg=i===0?'background:rgba(0,212,255,.06)':'';
    h+='<tr style="border-bottom:1px solid var(--bd);'+bg+'"><td style="padding:6px 8px;font-weight:'+(i===0?'700':'400')+'">'+r.name+'</td><td>'+(r.ship==='lcl'?'ğŸš¢':'âœˆï¸')+'</td><td>'+U.fmtUSD(r.freight)+'</td><td>'+r.duty+'%</td><td style="font-size:10px;color:var(--ok)">'+r.fta+'</td><td>'+r.transit+'</td><td style="text-align:right;font-weight:600">'+U.fmtUSD(r.landed)+'</td><td style="text-align:right;font-weight:700;color:var(--pri)">'+U.fmtUSD(r.unit)+'</td></tr>';
  });
  h+='</tbody></table></div>';
  h+='<div style="margin-top:8px;font-size:10px;color:var(--w20)">* í•´ìƒ LCL + í•­ê³µë§Œ ë¹„êµ. ì‹¤ì œ ê²¬ì ì€ í¬ì›Œë” ë¬¸ì˜ í•„ìš”.</div></div>';
  document.getElementById('cr').innerHTML=h;
}

function genForwarderRFQ(){
  var c=window._lastCalc;if(!c){UI.toast('ë¨¼ì € ì›ê°€ ê³„ì‚°ì„ ì‹¤í–‰í•˜ì„¸ìš”','warn');return;}
  var comp=S.company||{};var prod=S.products[0]||{};
  var shipTypeLabel={lcl:'LCL (Less than Container Load)',fcl_20:'FCL 20ft',fcl_40:'FCL 40ft',air:'Air Freight',express:'Express (Courier)'};
  var today=new Date().toISOString().slice(0,10);

  var rfq='REQUEST FOR QUOTATION â€” FREIGHT FORWARDING\n'+
    'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n'+
    'Date: '+today+'\n'+
    'RFQ No: RFQ-'+today.replace(/-/g,'')+'-'+String(Math.floor(Math.random()*900)+100)+'\n\n'+
    '1. SHIPPER INFORMATION\n'+
    '   Company: '+(comp.name_en||comp.name_ko||'[íšŒì‚¬ëª…]')+'\n'+
    '   Contact: '+(comp.ceo_name_en||comp.ceo_name_ko||'[ë‹´ë‹¹ì]')+'\n'+
    '   Tel: '+(comp.phone||'[ì „í™”ë²ˆí˜¸]')+'\n'+
    '   Email: '+(comp.email||S.user.email||'[ì´ë©”ì¼]')+'\n\n'+
    '2. CARGO DETAILS\n'+
    '   Product: '+(prod.name_en||prod.name_ko||'[ì œí’ˆëª…]')+'\n'+
    '   HS Code: '+(c.hs||'[HSì½”ë“œ]')+'\n'+
    '   Quantity: '+U.n(c.qty)+' pcs\n'+
    '   Gross Weight: '+c.wt+' kg\n'+
    '   Volume: '+c.cbm+' CBM\n'+
    '   FOB Value: '+U.fmtUSD(c.fobTotal)+'\n'+
    '   Dangerous Goods: No\n'+
    '   Temperature Sensitive: '+(prod.category==='food'||prod.category==='Health Supplement'?'Yes (Cool storage preferred)':'No')+'\n\n'+
    '3. ROUTING\n'+
    '   Origin: Busan (KRPUS) / Incheon (KRICN)\n'+
    '   Destination: '+c.destName+'\n'+
    '   Preferred Mode: '+(shipTypeLabel[c.ship]||c.ship)+'\n'+
    '   Required Delivery: [í¬ë§ ë„ì°©ì¼]\n\n'+
    '4. SERVICES REQUIRED\n'+
    '   [ ] Customs Clearance (Export)\n'+
    '   [ ] Customs Clearance (Import)\n'+
    '   [ ] Cargo Insurance\n'+
    '   [ ] Door-to-Port / Door-to-Door\n'+
    '   [ ] Fumigation Certificate\n\n'+
    '5. ADDITIONAL NOTES\n'+
    '   - Incoterms: FOB Busan\n'+
    '   - Please quote all-in rate including THC, BAF, CAF\n'+
    '   - Please advise transit time and vessel schedule\n\n'+
    'Please reply with your best quotation by [íšŒì‹  ê¸°í•œ].\n'+
    'Thank you.\n';

  /* RFQ í‘œì‹œ + ì´ë©”ì¼ ì „ì†¡ ë²„íŠ¼ */
  var h='<div style="margin-top:14px;padding:14px;border-radius:12px;background:var(--w08);border:1px solid var(--bd)">'+
    '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><span style="font-weight:700;font-size:13px">ğŸš¢ Freight RFQ</span>'+
    '<div style="display:flex;gap:6px"><button class="btn btn-pri btn-sm" onclick="App.sendRFQEmail()">ğŸ“§ ì´ë©”ì¼ ë°œì†¡</button><button class="btn btn-ghost btn-sm" onclick="navigator.clipboard.writeText(document.getElementById(\'rfq-text\').textContent);UI.toast(\'ë³µì‚¬ë¨\',\'ok\')">ğŸ“‹ ë³µì‚¬</button></div></div>'+
    '<pre id="rfq-text" style="font-size:11px;line-height:1.5;color:var(--w60);white-space:pre-wrap;max-height:300px;overflow-y:auto;background:var(--bg);padding:12px;border-radius:8px;border:1px solid var(--bd)">'+rfq+'</pre></div>';
  document.getElementById('rfq-result').innerHTML=h;
  window._lastRFQ=rfq;
}

function sendRFQEmail(){
  if(!window._lastRFQ){UI.toast('RFQë¥¼ ë¨¼ì € ìƒì„±í•˜ì„¸ìš”','warn');return;}
  var email=prompt('í¬ì›Œë” ì´ë©”ì¼ ì£¼ì†Œ:');if(!email)return;
  fetch(RELAY_URL+'/api/whistle/send-email',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
    to:email,subject:'[RFQ] Freight Quotation Request â€” '+(S.company&&S.company.name_en||'Korean Manufacturer'),
    bodyText:window._lastRFQ,userId:S.user.id
  })}).then(function(r){return r.json();}).then(function(data){
    if(data.ok)UI.toast('í¬ì›Œë”ì— ê²¬ì  ìš”ì²­ ë°œì†¡!','ok');
    else{window.open('mailto:'+email+'?subject=[RFQ] Freight Quote&body='+encodeURIComponent(window._lastRFQ));UI.toast('mailtoë¡œ ì „í™˜','info');}
  }).catch(function(){window.open('mailto:'+email+'?subject=[RFQ]&body='+encodeURIComponent(window._lastRFQ));});
}

function pgSub(){
  var cur=S.user&&S.user.plan||'free';
  var plans=[
    {id:'free',n:'FREE',pr:0,pe:'',f:['AI ë¶„ì„ 3íšŒ/ì›”','ì œí’ˆ ë“±ë¡ 5ê°œ','í”„ë¡œì íŠ¸ 1ê±´','ì›ê°€ ê³„ì‚°ê¸°','ìˆ˜ì¶œ ë¡œë“œë§µ ê°€ì´ë“œ'],c:'var(--w40)',desc:'ìˆ˜ì¶œ ê°€ëŠ¥ì„±ì„ ë¨¼ì € í™•ì¸í•´ë³´ì„¸ìš”'},
    {id:'starter',n:'STARTER',pr:99000,pe:'/ì›”',f:['AI ë¶„ì„ 10íšŒ/ì›”','ì œí’ˆ ë“±ë¡ 20ê°œ','í”„ë¡œì íŠ¸ 5ê±´','ì„œë¥˜ ìë™ìƒì„± ë¬´ì œí•œ','ì´ë©”ì¼ í—ˆë¸Œ 50ê±´/ì›”'],c:'var(--pri)',desc:'ë³¸ê²©ì ì¸ ìˆ˜ì¶œ ì¤€ë¹„ë¥¼ ì‹œì‘í•˜ì„¸ìš”',voucher:29700},
    {id:'pro',n:'PRO',pr:299000,pe:'/ì›”',f:['AI ë¶„ì„ ë¬´ì œí•œ','ì œí’ˆ/í”„ë¡œì íŠ¸ ë¬´ì œí•œ','ë°”ì´ì–´ ë§¤ì¹­ 1ê±´/ì›”','ì „ìš© ìˆ˜ì¶œ ë§¤ë‹ˆì €','ìš°ì„  ì„œë¹„ìŠ¤ ì²˜ë¦¬','ëª¨ë“  ê¸°ëŠ¥ ë¬´ì œí•œ'],c:'var(--acc)',rec:true,desc:'ì „ë¬¸ ë§¤ë‹ˆì €ì™€ í•¨ê»˜ ìˆ˜ì¶œì„ ì‹¤í–‰í•˜ì„¸ìš”',voucher:89700},
    {id:'alibaba',n:'ALIBABA',pr:0,pe:'',f:['PRO ì „ë¶€ í¬í•¨','ì•Œë¦¬ë°”ë°”ë‹·ì»´ ëŒ€í–‰','ì›”ê°„ ì „ëµ ë¯¸íŒ…','ë°”ì´ì–´ ë§¤ì¹­ 3ê±´/ì›”','ì•Œë¦¬ë°”ë°” ê´‘ê³  ê´€ë¦¬','ì‹¤ì‹œê°„ ì¸ì½°ì´ì–´ë¦¬ ê´€ë¦¬'],c:'var(--err)',desc:'ì•Œë¦¬ë°”ë°” ì „ë¬¸ ìš´ì˜ì„ ë§¡ê¸°ì„¸ìš”',contact:true}
  ];

  /* Usage stats */
  var aUsed=S.analyses.filter(function(a){var d=new Date(a.created_at);var n=new Date();return d.getMonth()===n.getMonth()&&d.getFullYear()===n.getFullYear();}).length;
  var lim=PLAN_LIMITS[cur]||PLAN_LIMITS.free;
  var aMax=lim.analyses===-1?999:lim.analyses;
  var pUsed=S.products.length;
  var pjUsed=S.projects.length;

  return '<div style="margin-bottom:20px"><h2 style="font-size:18px;font-weight:800">ğŸ’ êµ¬ë… ê´€ë¦¬</h2></div>'+

  /* Current plan summary */
  '<div class="card" style="margin-bottom:20px;border-color:rgba(0,212,255,.15)"><div class="card-b"><div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap"><div style="flex:1;min-width:200px"><div style="display:flex;align-items:center;gap:8px;margin-bottom:4px"><span style="font-size:13px;font-weight:700">í˜„ì¬ í”Œëœ</span>'+UI.pb(cur)+'</div><div style="font-size:12px;color:var(--w40)">'+plans.find(function(p){return p.id===cur;}).desc+'</div></div><div style="display:flex;gap:16px;flex-wrap:wrap"><div style="text-align:center;padding:10px 16px;border-radius:10px;background:var(--w08)"><div style="font-size:11px;color:var(--w40);margin-bottom:2px">AI ë¶„ì„</div><div style="font-size:16px;font-weight:800;color:var(--pri)">'+aUsed+'<span style="font-size:11px;color:var(--w40);font-weight:400">/'+aMax+'</span></div><div style="height:4px;border-radius:2px;background:var(--w08);margin-top:4px;width:60px"><div style="height:100%;border-radius:2px;background:var(--pri);width:'+Math.min(aUsed/aMax*100,100)+'%"></div></div></div><div style="text-align:center;padding:10px 16px;border-radius:10px;background:var(--w08)"><div style="font-size:11px;color:var(--w40);margin-bottom:2px">ì œí’ˆ</div><div style="font-size:16px;font-weight:800;color:var(--acc)">'+pUsed+'</div></div><div style="text-align:center;padding:10px 16px;border-radius:10px;background:var(--w08)"><div style="font-size:11px;color:var(--w40);margin-bottom:2px">í”„ë¡œì íŠ¸</div><div style="font-size:16px;font-weight:800;color:var(--ok)">'+pjUsed+'</div></div></div></div></div></div>'+

  /* Plan cards */
  '<div class="grid-4" style="margin-bottom:20px">'+plans.map(function(p){
    var isCur=cur===p.id;
    var isUp=plans.findIndex(function(x){return x.id===p.id;})>plans.findIndex(function(x){return x.id===cur;});
    return '<div class="plan-card '+(isCur?'current':'')+' '+(p.rec?'recommended':'')+'" style="position:relative">'+
      (p.rec&&!isCur?'<div style="position:absolute;top:-10px;left:50%;transform:translateX(-50%);padding:3px 14px;border-radius:20px;background:var(--acc-g);font-size:10px;font-weight:800;color:var(--bg);white-space:nowrap">â­ ì¶”ì²œ</div>':'')+
      (isCur?'<div style="font-size:10px;font-weight:800;color:var(--pri);margin-bottom:4px;display:flex;align-items:center;gap:4px"><span style="width:6px;height:6px;border-radius:50%;background:var(--pri)"></span> í˜„ì¬ í”Œëœ</div>':'')+
      '<div class="plan-name" style="color:'+p.c+'">'+p.n+'</div>'+
      '<div class="plan-price">'+(p.contact?'ë³„ë„ ê²¬ì ':p.pr===0?U.fmtPrice(0):U.fmtPrice(p.pr))+'<span class="plan-period">'+p.pe+'</span></div>'+
      '<div class="plan-features">'+p.f.map(function(f){return '<div>âœ“ '+f+'</div>';}).join('')+'</div>'+
      (!isCur?'<button class="btn '+(isUp?'btn-pri':'btn-ghost')+' btn-block" style="margin-top:14px;'+(isUp?'':'border-color:'+p.c+';color:'+p.c)+'" onclick="App.openCheckout(\''+p.id+'\')">'+(isUp?'ì—…ê·¸ë ˆì´ë“œ':'ë‹¤ìš´ê·¸ë ˆì´ë“œ')+'</button>':
      '<div style="margin-top:14px;text-align:center;font-size:12px;color:var(--w20)">í˜„ì¬ ì´ìš© ì¤‘</div>')+
    '</div>';
  }).join('')+'</div>'+

  /* Voucher notice */
  '<div class="card" style="border-color:rgba(255,184,0,.2)"><div class="card-b" style="display:flex;align-items:center;gap:14px;flex-wrap:wrap"><span style="font-size:28px">ğŸ›ï¸</span><div style="flex:1;min-width:200px"><div style="font-weight:700;color:var(--acc)">ì •ë¶€ ë°”ìš°ì²˜ë¡œ ê²°ì œ ê°€ëŠ¥</div><div style="font-size:12px;color:var(--w40);margin-top:2px">ìˆ˜ì¶œë°”ìš°ì²˜Â·í˜ì‹ ë°”ìš°ì²˜ ìµœëŒ€ 85% ì§€ì›. ëª¨ë“  ìœ ë£Œ í”Œëœ ì ìš© ê°€ëŠ¥.</div></div><button class="btn btn-acc btn-sm" onclick="App.reqSvc(\'certification\')">ë°”ìš°ì²˜ ìƒë‹´</button></div></div>';
}

function openCheckout(planId){
  var plans={starter:{n:'STARTER',pr:99000,c:'var(--pri)',v:29700},pro:{n:'PRO',pr:299000,c:'var(--acc)',v:89700},alibaba:{n:'ALIBABA',pr:0,c:'var(--err)',contact:true},free:{n:'FREE',pr:0,c:'var(--w40)'}};
  var p=plans[planId];if(!p)return;
  var cur=S.user&&S.user.plan||'free';
  var order=['free','starter','pro','alibaba'];
  var isDown=order.indexOf(planId)<order.indexOf(cur);

  if(planId==='free'){
    if(!confirm('FREEë¡œ ë‹¤ìš´ê·¸ë ˆì´ë“œí•˜ë©´ ìœ ë£Œ ê¸°ëŠ¥ì´ ì œí•œë©ë‹ˆë‹¤. ê³„ì†í• ê¹Œìš”?'))return;
    chgPlan('free');return;
  }

  /* ì•Œë¦¬ë°”ë°”ëŠ” ë³„ë„ ìƒë‹´ */
  if(p.contact){
    var abody='<div style="text-align:center;padding:20px"><div style="font-size:28px;font-weight:900;color:var(--err);margin-bottom:12px">ALIBABA</div><div style="font-size:14px;color:var(--w60);margin-bottom:20px;line-height:1.7">ì•Œë¦¬ë°”ë°” í”Œëœì€ ê¸°ì—… ë§ì¶¤ ê²¬ì ìœ¼ë¡œ ìš´ì˜ë©ë‹ˆë‹¤.<br>ì•„ë˜ ë²„íŠ¼ìœ¼ë¡œ ìƒë‹´ì„ ì‹ ì²­í•´ì£¼ì„¸ìš”.</div>'+
      '<div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">'+
      '<a href="https://open.kakao.com/o/sMotiveInno" target="_blank" class="btn btn-acc" style="text-decoration:none">ì¹´ì¹´ì˜¤í†¡ ìƒë‹´</a>'+
      '<button class="btn btn-pri" onclick="App.reqSvc(\'alibaba\');App.closeModal(\'ckm\')">ìƒë‹´ ì‹ ì²­</button></div></div>';
    document.body.insertAdjacentHTML('beforeend',UI.modal({id:'ckm',title:'ğŸ’ ì•Œë¦¬ë°”ë°” í”Œëœ',body:abody,footer:'<button class="btn btn-ghost" onclick="App.closeModal(\'ckm\')">ë‹«ê¸°</button>',width:'460px'}));UI.showModal('ckm');return;
  }

  var body='<div style="text-align:center;margin-bottom:20px"><div style="font-size:14px;color:var(--w40);margin-bottom:4px">'+(isDown?'ë‹¤ìš´ê·¸ë ˆì´ë“œ':'ì—…ê·¸ë ˆì´ë“œ')+'</div><div style="font-size:28px;font-weight:900;color:'+p.c+'">'+p.n+'</div><div style="font-size:24px;font-weight:800;margin-top:4px">'+U.fmtPrice(p.pr)+'<span style="font-size:12px;color:var(--w40);font-weight:400">/ì›”</span></div></div>'+

    /* ê²°ì œ ë°©ì‹ 3íƒ­ */
    '<div style="padding:16px;border-radius:12px;background:var(--w08);margin-bottom:16px"><div style="font-size:12px;font-weight:700;color:var(--w60);margin-bottom:8px">ê²°ì œ ë°©ì‹ ì„ íƒ</div>'+
    '<div id="ck-tabs" style="display:flex;gap:8px;margin-bottom:14px">'+
    '<div class="ck-tab active" onclick="App.ckTab(0)" style="flex:1;padding:12px 8px;border-radius:10px;border:2px solid var(--pri);background:rgba(0,212,255,.06);text-align:center;cursor:pointer;font-size:12px;font-weight:700;color:var(--pri)">ğŸ¦ ê³„ì¢Œì´ì²´</div>'+
    '<div class="ck-tab" onclick="App.ckTab(1)" style="flex:1;padding:12px 8px;border-radius:10px;border:2px solid var(--bd);text-align:center;cursor:pointer;font-size:12px;color:var(--w40)">ğŸ’¬ ì¹´ì¹´ì˜¤ ìƒë‹´</div>'+
    '<div class="ck-tab" onclick="App.ckTab(2)" style="flex:1;padding:12px 8px;border-radius:10px;border:2px solid var(--bd);text-align:center;cursor:pointer;font-size:12px;color:var(--w40)">ğŸ›ï¸ ë°”ìš°ì²˜</div></div>'+

    /* íƒ­ ë‚´ìš© ì˜ì—­ */
    '<div id="ck-body">'+_ckTransfer(p)+'</div></div>'+

    /* ê¸ˆì•¡ ìš”ì•½ */
    '<div style="padding:14px;border-radius:10px;border:1px solid var(--bd);margin-bottom:14px"><div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:6px"><span style="color:var(--w40)">'+p.n+' ì›”ê°„ êµ¬ë…</span><span style="font-weight:700">'+U.fmtPrice(p.pr)+'</span></div><div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:6px"><span style="color:var(--w40)">ë¶€ê°€ì„¸ (10%)</span><span style="font-weight:700">'+U.fmtPrice(Math.round(p.pr*0.1))+'</span></div><div style="border-top:1px solid var(--bd);padding-top:8px;margin-top:8px;display:flex;justify-content:space-between;font-size:15px;font-weight:800"><span>ì´ ê²°ì œê¸ˆì•¡</span><span style="color:'+p.c+'">'+U.fmtPrice(Math.round(p.pr*1.1))+'</span></div>'+
    (p.v?'<div style="margin-top:8px;padding:8px 12px;border-radius:8px;background:rgba(255,184,0,.08);border:1px solid rgba(255,184,0,.15)"><div style="font-size:11px;color:var(--acc)">ë°”ìš°ì²˜ ì ìš©ì‹œ (70% ì§€ì›): <b>'+U.fmtPrice(Math.round(p.v*1.1))+'</b>/ì›”</div></div>':'')+'</div>';

  document.body.insertAdjacentHTML('beforeend',UI.modal({id:'ckm',title:'ğŸ’ í”Œëœ ë³€ê²½',body:body,footer:'<button class="btn btn-ghost" onclick="App.closeModal(\'ckm\')">ì·¨ì†Œ</button><button class="btn btn-pri" id="ck-submit" onclick="App.confirmCheckout(\''+planId+'\')">ì…ê¸ˆ ì™„ë£Œ ì•Œë¦¼</button>',width:'460px'}));UI.showModal('ckm');
}

/* ì²´í¬ì•„ì›ƒ íƒ­ ë‚´ìš© */
function _ckTransfer(p){
  return '<div style="padding:14px;border-radius:10px;background:var(--card);border:1px solid var(--bd)">'+
    '<div style="font-size:13px;font-weight:700;margin-bottom:10px;color:var(--pri)">ê³„ì¢Œì´ì²´ ì•ˆë‚´</div>'+
    '<div style="font-size:12px;color:var(--w60);line-height:1.8">'+
    '<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--w08)"><span>ì€í–‰</span><b style="color:var(--w90)">ê¸°ì—…ì€í–‰</b></div>'+
    '<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--w08)"><span>ê³„ì¢Œë²ˆí˜¸</span><b style="color:var(--w90)">301-098765-04-011</b></div>'+
    '<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--w08)"><span>ì˜ˆê¸ˆì£¼</span><b style="color:var(--w90)">(ì£¼)ëª¨í‹°ë¸Œì´ë…¸ë² ì´ì…˜</b></div>'+
    '<div style="display:flex;justify-content:space-between;padding:4px 0"><span>ì…ê¸ˆì•¡</span><b style="color:var(--acc)">'+U.fmtPrice(Math.round(p.pr*1.1))+'</b></div>'+
    '</div><div style="margin-top:10px;font-size:11px;color:var(--w40)">ì…ê¸ˆ í›„ "ì…ê¸ˆ ì™„ë£Œ ì•Œë¦¼" ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”. ì˜ì—…ì¼ ê¸°ì¤€ 1ì‹œê°„ ë‚´ í”Œëœì´ í™œì„±í™”ë©ë‹ˆë‹¤.</div></div>';
}
function _ckKakao(){
  return '<div style="padding:14px;border-radius:10px;background:var(--card);border:1px solid var(--bd);text-align:center">'+
    '<div style="font-size:13px;font-weight:700;margin-bottom:10px;color:#FEE500">ì¹´ì¹´ì˜¤í†¡ ìƒë‹´</div>'+
    '<div style="font-size:12px;color:var(--w60);margin-bottom:14px;line-height:1.7">ì¹´ì¹´ì˜¤í†¡ìœ¼ë¡œ ìƒë‹´ í›„ ë§ì¶¤ ê²°ì œë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.<br>í”Œëœ ìƒë‹´, ë°”ìš°ì²˜ ë¬¸ì˜ ëª¨ë‘ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>'+
    '<a href="https://open.kakao.com/o/sMotiveInno" target="_blank" style="display:inline-block;padding:12px 24px;border-radius:10px;background:#FEE500;color:#191919;font-weight:700;font-size:13px;text-decoration:none">ì¹´ì¹´ì˜¤í†¡ ìƒë‹´í•˜ê¸°</a></div>';
}
function _ckVoucher(){
  return '<div style="padding:14px;border-radius:10px;background:var(--card);border:1px solid var(--bd)">'+
    '<div style="font-size:13px;font-weight:700;margin-bottom:10px;color:var(--acc)">ë°”ìš°ì²˜ ê²°ì œ</div>'+
    '<div style="font-size:12px;color:var(--w60);margin-bottom:12px">ìˆ˜ì¶œë°”ìš°ì²˜ / ì œì¡°í˜ì‹ ë°”ìš°ì²˜ë¡œ ìµœëŒ€ 70~85% ì§€ì›ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>'+
    '<div style="display:flex;flex-direction:column;gap:8px">'+
    '<select name="voucher_type" style="padding:10px;border-radius:8px;background:var(--sf);border:1px solid var(--bd);color:var(--w90);font-size:12px"><option value="">ë°”ìš°ì²˜ ìœ í˜• ì„ íƒ</option><option value="export">ìˆ˜ì¶œë°”ìš°ì²˜</option><option value="innovation">ì œì¡°í˜ì‹ ë°”ìš°ì²˜</option><option value="other">ê¸°íƒ€ ë°”ìš°ì²˜</option></select>'+
    '<input name="biz_no" placeholder="ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸" style="padding:10px;border-radius:8px;background:var(--sf);border:1px solid var(--bd);color:var(--w90);font-size:12px">'+
    '<input name="voucher_no" placeholder="ë°”ìš°ì²˜ ë²ˆí˜¸ (ì„ íƒ)" style="padding:10px;border-radius:8px;background:var(--sf);border:1px solid var(--bd);color:var(--w90);font-size:12px">'+
    '</div><div style="margin-top:10px;font-size:11px;color:var(--w40)">ë°”ìš°ì²˜ í™•ì¸ í›„ ì˜ì—…ì¼ ê¸°ì¤€ 1ì¼ ë‚´ í”Œëœì´ í™œì„±í™”ë©ë‹ˆë‹¤.</div></div>';
}
function ckTab(idx){
  var tabs=document.querySelectorAll('.ck-tab');
  tabs.forEach(function(t,i){
    if(i===idx){t.style.borderColor='var(--pri)';t.style.background='rgba(0,212,255,.06)';t.style.color='var(--pri)';t.style.fontWeight='700';}
    else{t.style.borderColor='var(--bd)';t.style.background='transparent';t.style.color='var(--w40)';t.style.fontWeight='400';}
  });
  var bd=document.getElementById('ck-body');
  var btn=document.getElementById('ck-submit');
  var _m=btn?btn.getAttribute('onclick').match(/'(\w+)'/):null;var planId=_m?_m[1]:'';
  var plans={starter:{pr:99000},pro:{pr:299000}};
  var p=plans[planId]||{pr:0};
  if(idx===0){bd.innerHTML=_ckTransfer(p);if(btn)btn.textContent='ì…ê¸ˆ ì™„ë£Œ ì•Œë¦¼';}
  else if(idx===1){bd.innerHTML=_ckKakao();if(btn)btn.textContent='ìƒë‹´ ì™„ë£Œ';}
  else{bd.innerHTML=_ckVoucher();if(btn)btn.textContent='ë°”ìš°ì²˜ ì‹ ì²­';}
}

function confirmCheckout(planId){
  var ckBody=document.getElementById('ck-body');
  var method='transfer';
  if(ckBody){
    var sel=ckBody.querySelector('select[name=voucher_type]');
    if(sel)method='voucher';
    else if(ckBody.querySelector('a[href*="kakao"]'))method='kakao';
  }

  if(method==='kakao'){
    UI.toast('ì¹´ì¹´ì˜¤í†¡ ìƒë‹´ì„ í†µí•´ ê²°ì œë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”','info');
    closeModal('ckm');return;
  }

  /* í…”ë ˆê·¸ë¨ ì•Œë¦¼ ë°œì†¡ */
  var msg='[ê²°ì œ ì•Œë¦¼]\ní”Œëœ: '+planId.toUpperCase()+'\në°©ì‹: '+(method==='voucher'?'ë°”ìš°ì²˜':'ê³„ì¢Œì´ì²´')+'\nì‚¬ìš©ì: '+(S.user.name||S.user.email||S.user.id);
  if(method==='voucher'){
    var vt=ckBody.querySelector('select[name=voucher_type]');
    var bn=ckBody.querySelector('input[name=biz_no]');
    var vn=ckBody.querySelector('input[name=voucher_no]');
    msg+='\në°”ìš°ì²˜ìœ í˜•: '+(vt?vt.value:'')+'\nì‚¬ì—…ìë²ˆí˜¸: '+(bn?bn.value:'')+'\në°”ìš°ì²˜ë²ˆí˜¸: '+(vn?vn.value:'');
  }

  UI.toast('ì‹ ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤. í™•ì¸ í›„ í”Œëœì´ í™œì„±í™”ë©ë‹ˆë‹¤.','ok');

  /* relay-serverì˜ /api/chat í†µí•´ í…”ë ˆê·¸ë¨ ì•Œë¦¼ (best effort) */
  fetch(RELAY_URL+'/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:'PAYMENT_NOTIFY: '+msg,userId:'system'})}).catch(function(){});

  /* ì„œë¹„ìŠ¤ ìš”ì²­ìœ¼ë¡œë„ ê¸°ë¡ */
  sb.from('service_requests').insert({user_id:S.user.id,service_type:'payment',description:msg,status:'pending'}).then(function(){loadSR();});
  closeModal('ckm');
}

function chgPlan(id){
  /* ë³´ì•ˆ: í´ë¼ì´ì–¸íŠ¸ì—ì„œëŠ” ë¬´ë£Œ ë‹¤ìš´ê·¸ë ˆì´ë“œë§Œ í—ˆìš©. ìœ ë£Œ ì—…ê·¸ë ˆì´ë“œëŠ” ê²°ì œ í”„ë¡œì„¸ìŠ¤ í•„ìˆ˜ */
  var order=['free','starter','pro','alibaba'];
  var curIdx=order.indexOf(S.user&&S.user.plan||'free');
  var newIdx=order.indexOf(id);
  if(newIdx>curIdx){UI.toast('ê²°ì œë¥¼ í†µí•´ ì—…ê·¸ë ˆì´ë“œí•´ì£¼ì„¸ìš”.','warn');return;}
  sb.from('users').update({plan:id}).eq('id',S.user.id).then(function(){S.user.plan=id;render();UI.toast(id.toUpperCase()+' í”Œëœìœ¼ë¡œ ë³€ê²½ ì™„ë£Œ!','ok');});
}

function pgSettings(){
  var c=S.company||{};
  return '<div style="margin-bottom:20px"><h2 style="font-size:18px;font-weight:800">âš™ï¸ ì„¤ì •</h2></div><form id="stf" onsubmit="event.preventDefault();App.saveSt()"><div class="card" style="margin-bottom:14px"><div class="card-h">ğŸ¢ íšŒì‚¬ ì •ë³´</div><div class="card-b"><div class="grid-2">'+UI.inp('name_ko','íšŒì‚¬ëª…(í•œê¸€)',{value:c.name_ko||''})+UI.inp('name_en','íšŒì‚¬ëª…(ì˜ë¬¸)',{value:c.name_en||''})+'</div><div class="grid-2">'+UI.inp('address_ko','ì£¼ì†Œ(í•œê¸€)',{value:c.address_ko||''})+UI.inp('address_en','ì£¼ì†Œ(ì˜ë¬¸)',{value:c.address_en||''})+'</div><div class="grid-2">'+UI.inp('ceo_name_ko','ëŒ€í‘œì(í•œê¸€)',{value:c.ceo_name_ko||''})+UI.inp('ceo_name_en','ëŒ€í‘œì(ì˜ë¬¸)',{value:c.ceo_name_en||''})+'</div><div class="grid-3">'+UI.inp('phone','ì „í™”',{value:c.phone||''})+UI.inp('fax','íŒ©ìŠ¤',{value:c.fax||''})+UI.inp('biz_number','ì‚¬ì—…ìë²ˆí˜¸',{value:c.biz_number||''})+'</div></div></div><div class="card" style="margin-bottom:14px"><div class="card-h">ğŸ¦ ì€í–‰</div><div class="card-b"><div class="grid-3">'+UI.inp('bank_name','ì€í–‰(ì˜ë¬¸)',{value:c.bank_name||''})+UI.inp('bank_account','ê³„ì¢Œ',{value:c.bank_account||''})+UI.inp('swift_code','SWIFT',{value:c.swift_code||''})+'</div></div></div><button class="btn btn-pri btn-lg" type="submit">ğŸ’¾ ì €ì¥</button></form>';
}

function saveSt(){
  var d=UI.fd('#stf');
  var q=S.company&&S.company.id?sb.from('companies').update(d).eq('id',S.company.id):sb.from('companies').insert(Object.assign(d,{user_id:S.user.id}));
  q.then(function(r){
    if(r.error){UI.toast('ì‹¤íŒ¨: '+r.error.message,'err');return;}
    if(d.name_ko)sb.from('users').update({company_name:d.name_ko}).eq('id',S.user.id).then(function(){S.user.company_name=d.name_ko;});
    sb.from('companies').select('*').eq('user_id',S.user.id).maybeSingle().then(function(cr){S.company=cr.data;render();UI.toast('ì €ì¥!','ok');});
  });
}

/* === ORDER MANAGEMENT === */
function pgOrders(){
  var stLabel={confirmed:'í™•ì •',production:'ìƒì‚°ì¤‘',inspection:'ê²€ìˆ˜',shipping:'ì„ ì ',delivered:'ë°°ì†¡ì¤‘',completed:'ì™„ë£Œ',cancelled:'ì·¨ì†Œ'};
  var stColor={confirmed:'var(--pri)',production:'var(--acc)',inspection:'var(--purple,#a855f7)',shipping:'#3b82f6',delivered:'var(--ok)',completed:'var(--ok)',cancelled:'var(--err)'};
  var stIcon={confirmed:'ğŸ“‹',production:'ğŸ­',inspection:'ğŸ”',shipping:'ğŸš¢',delivered:'ğŸ“¦',completed:'âœ…',cancelled:'âŒ'};
  var payLabel={unpaid:'ë¯¸ê²°ì œ',deposit_received:'ê³„ì•½ê¸ˆ',partial:'ë¶€ë¶„ê²°ì œ',paid:'ì™„ë‚©',overdue:'ì—°ì²´'};
  var payColor={unpaid:'var(--w40)',deposit_received:'var(--acc)',partial:'var(--pri)',paid:'var(--ok)',overdue:'var(--err)'};

  /* íŒŒì´í”„ë¼ì¸ */
  var stages=['confirmed','production','inspection','shipping','delivered','completed'];
  var pipeline='<div style="display:flex;gap:4px;margin-bottom:20px;overflow-x:auto;padding-bottom:4px">'+stages.map(function(st){
    var cnt=S.orders.filter(function(o){return o.status===st;}).length;
    return '<div style="flex:1;min-width:90px;padding:10px;border-radius:10px;background:var(--w08);text-align:center;border-bottom:3px solid '+(cnt?stColor[st]:'transparent')+'">'+
      '<div style="font-size:18px">'+stIcon[st]+'</div>'+
      '<div style="font-size:10px;color:var(--w40)">'+stLabel[st]+'</div>'+
      '<div style="font-size:18px;font-weight:800;color:'+(cnt?stColor[st]:'var(--w20)')+'">'+cnt+'</div></div>';
  }).join('')+'</div>';

  /* ì£¼ë¬¸ ëª©ë¡ */
  var list='';
  if(S.orders.length){
    list=S.orders.map(function(o){
      var buyer=S.buyers.find(function(b){return b.id===o.buyer_id;});
      var bName=buyer?buyer.company_name:'â€”';
      var itemCnt=0;try{itemCnt=(JSON.parse(JSON.stringify(o.items))||[]).length;}catch(e){}
      var daysAgo=Math.floor((new Date()-new Date(o.created_at))/(1000*60*60*24));
      return '<div style="padding:14px;border-radius:12px;background:var(--w08);margin-bottom:8px;border-left:4px solid '+stColor[o.status]+';cursor:pointer" onclick="App.viewOrder(\''+o.id+'\')">'+
        '<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:6px">'+
        '<div><div style="font-weight:700;font-size:14px">'+o.order_number+'</div><div style="font-size:12px;color:var(--w40)">'+bName+' Â· '+U.fmtUSD(o.total_amount)+' Â· '+(o.incoterms||'FOB')+'</div></div>'+
        '<div style="display:flex;gap:6px;align-items:center">'+
        '<span style="font-size:10px;padding:3px 8px;border-radius:8px;background:rgba(0,0,0,.1);color:'+payColor[o.payment_status]+'">'+payLabel[o.payment_status]+'</span>'+
        '<span style="font-size:10px;padding:3px 8px;border-radius:8px;background:rgba(0,0,0,.1);color:'+stColor[o.status]+'">'+stIcon[o.status]+' '+stLabel[o.status]+'</span>'+
        '</div></div></div>';
    }).join('');
  }else{
    list='<div style="padding:30px;text-align:center;color:var(--w40)"><div style="font-size:32px;margin-bottom:8px">ğŸ“‹</div><div>ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤</div><div style="font-size:12px;margin-top:4px">PI ì„œë¥˜ì—ì„œ "ì£¼ë¬¸ ì „í™˜"í•˜ê±°ë‚˜ ì§ì ‘ ìƒì„±í•˜ì„¸ìš”</div></div>';
  }

  /* í†µê³„ */
  var totalAmt=S.orders.reduce(function(s,o){return s+(parseFloat(o.total_amount)||0);},0);
  var paidAmt=S.orders.filter(function(o){return o.payment_status==='paid';}).reduce(function(s,o){return s+(parseFloat(o.total_amount)||0);},0);
  var activeOrd=S.orders.filter(function(o){return o.status!=='completed'&&o.status!=='cancelled';}).length;

  return '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:8px"><div><h2 style="font-size:18px;font-weight:800">ğŸ“‹ ì£¼ë¬¸ ê´€ë¦¬</h2></div><button class="btn btn-pri" onclick="App.showOrderForm()">+ ìƒˆ ì£¼ë¬¸</button></div>'+
  '<div class="grid-3" style="margin-bottom:16px">'+
  UI.stat('ì´ ì£¼ë¬¸',S.orders.length+'ê±´','ëˆ„ì ','var(--pri)')+
  UI.stat('ì§„í–‰ì¤‘',activeOrd+'ê±´','í˜„ì¬','var(--acc)')+
  UI.stat('ì´ ê¸ˆì•¡',U.fmtUSD(totalAmt),'ëˆ„ì ','var(--ok)')+
  '</div>'+pipeline+
  '<div class="card"><div class="card-h">ì£¼ë¬¸ ë‚´ì—­</div><div class="card-b" style="padding:'+(S.orders.length?'8px':'0')+'">'+list+'</div></div>';
}

function showOrderForm(){
  var buyerOpts=S.buyers.map(function(b){return {value:b.id,label:b.company_name};});
  buyerOpts.unshift({value:'',label:'-- ë°”ì´ì–´ ì„ íƒ --'});
  var pjOpts=S.projects.map(function(p){return {value:p.id,label:p.name};});
  pjOpts.unshift({value:'',label:'-- í”„ë¡œì íŠ¸ ì„ íƒ --'});
  var orderNum='WO-'+new Date().getFullYear()+'-'+String(Date.now()).slice(-6);
  var body='<form id="of">'+
    UI.inp('order_number','ì£¼ë¬¸ë²ˆí˜¸',{value:orderNum})+
    '<div class="grid-2">'+UI.sel('buyer_id','ë°”ì´ì–´',buyerOpts)+UI.sel('project_id','í”„ë¡œì íŠ¸',pjOpts)+'</div>'+
    '<div class="grid-3">'+UI.inp('total_amount','ì´ ê¸ˆì•¡(USD)',{type:'number',step:'0.01'})+
    UI.sel('payment_terms','ê²°ì œì¡°ê±´',[{value:'T/T 30% deposit',label:'T/T 30% ì„ ê¸ˆ'},{value:'T/T 50% deposit',label:'T/T 50% ì„ ê¸ˆ'},{value:'T/T 100% advance',label:'T/T 100% ì„ ë¶ˆ'},{value:'L/C at sight',label:'L/C at sight'},{value:'D/P',label:'D/P'},{value:'D/A 30 days',label:'D/A 30ì¼'}])+
    UI.sel('incoterms','ì¸ì½”í…€ì¦ˆ',[{value:'FOB',label:'FOB'},{value:'CIF',label:'CIF'},{value:'CFR',label:'CFR'},{value:'EXW',label:'EXW'},{value:'DDP',label:'DDP'}])+'</div>'+
    UI.ta('notes_text','ë©”ëª¨',{placeholder:'íŠ¹ì´ì‚¬í•­',rows:2})+
  '</form>';
  document.body.insertAdjacentHTML('beforeend',UI.modal({id:'om',title:'ğŸ“‹ ìƒˆ ì£¼ë¬¸ ë“±ë¡',body:body,footer:'<button class="btn btn-ghost" onclick="App.closeModal(\'om\')">ì·¨ì†Œ</button><button class="btn btn-pri" onclick="App.saveOrder()">ë“±ë¡</button>',width:'520px'}));UI.showModal('om');
}

function saveOrder(){
  var d=UI.fd('#of');if(!d.order_number){UI.toast('ì£¼ë¬¸ë²ˆí˜¸ í•„ìˆ˜','warn');return;}
  var data={user_id:S.user.id,buyer_id:d.buyer_id||null,project_id:d.project_id||null,
    order_number:d.order_number,total_amount:parseFloat(d.total_amount)||0,
    payment_terms:d.payment_terms||'',incoterms:d.incoterms||'FOB',
    notes:d.notes_text?[{text:d.notes_text,date:new Date().toISOString()}]:[]};
  sb.from('orders').insert(data).select().then(function(r){
    if(r.error){UI.toast('ì €ì¥ ì‹¤íŒ¨: '+r.error.message,'err');return;}
    var newOrder=r.data&&r.data[0];
    if(newOrder&&data.payment_terms){
      var milestones=[];var total=parseFloat(data.total_amount)||0;
      if(data.payment_terms.indexOf('30%')!==-1){milestones.push({order_id:newOrder.id,user_id:S.user.id,name:'deposit',percentage:30,amount:Math.round(total*0.3*100)/100,currency:'USD',status:'pending'});milestones.push({order_id:newOrder.id,user_id:S.user.id,name:'pre_shipment',percentage:70,amount:Math.round(total*0.7*100)/100,currency:'USD',status:'pending'});}
      else if(data.payment_terms.indexOf('50%')!==-1){milestones.push({order_id:newOrder.id,user_id:S.user.id,name:'deposit',percentage:50,amount:Math.round(total*0.5*100)/100,currency:'USD',status:'pending'});milestones.push({order_id:newOrder.id,user_id:S.user.id,name:'pre_shipment',percentage:50,amount:Math.round(total*0.5*100)/100,currency:'USD',status:'pending'});}
      else if(data.payment_terms.indexOf('100%')!==-1){milestones.push({order_id:newOrder.id,user_id:S.user.id,name:'deposit',percentage:100,amount:total,currency:'USD',status:'pending'});}
      else if(data.payment_terms.toLowerCase().indexOf('l/c')!==-1){milestones.push({order_id:newOrder.id,user_id:S.user.id,name:'lc_opening',percentage:100,amount:total,currency:'USD',status:'pending'});}
      if(milestones.length>0)sb.from('payment_milestones').insert(milestones).then(function(){loadMilestones();});
    }
    closeModal('om');loadOrders().then(function(){render();UI.toast('ì£¼ë¬¸ ë“±ë¡!','ok');});
    pushNotif('order','ìƒˆ ì£¼ë¬¸ ë“±ë¡: '+d.order_number,'ì´ì•¡ $'+(parseFloat(d.total_amount)||0).toLocaleString(),'orders',null,true);
  });
}

function viewOrder(orderId){
  var o=S.orders.find(function(x){return x.id===orderId;});if(!o)return;
  var buyer=S.buyers.find(function(b){return b.id===o.buyer_id;});
  var stLabel={confirmed:'í™•ì •',production:'ìƒì‚°ì¤‘',inspection:'ê²€ìˆ˜',shipping:'ì„ ì ',delivered:'ë°°ì†¡ì¤‘',completed:'ì™„ë£Œ',cancelled:'ì·¨ì†Œ'};
  var stColor={confirmed:'var(--pri)',production:'var(--acc)',inspection:'var(--purple,#a855f7)',shipping:'#3b82f6',delivered:'var(--ok)',completed:'var(--ok)',cancelled:'var(--err)'};
  var payLabel={unpaid:'ë¯¸ê²°ì œ',deposit_received:'ê³„ì•½ê¸ˆ',partial:'ë¶€ë¶„ê²°ì œ',paid:'ì™„ë‚©',overdue:'ì—°ì²´'};
  var stages=['confirmed','production','inspection','shipping','delivered','completed'];
  var curIdx=stages.indexOf(o.status);

  /* íŒŒì´í”„ë¼ì¸ ì‹œê°í™” */
  var pipe='<div style="display:flex;gap:2px;margin-bottom:16px">'+stages.map(function(st,i){
    var active=i<=curIdx;
    return '<div style="flex:1;height:6px;border-radius:3px;background:'+(active?stColor[o.status]:'var(--w08)')+'"></div>';
  }).join('')+'</div>';

  /* ìƒíƒœ ë³€ê²½ ë²„íŠ¼ */
  var nextSt=curIdx<stages.length-1?stages[curIdx+1]:null;
  var stBtns='<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px">';
  stages.forEach(function(st){
    stBtns+='<button class="btn btn-sm '+(o.status===st?'btn-pri':'btn-ghost')+'" style="font-size:11px" onclick="App.setOrderStatus(\''+orderId+'\',\''+st+'\')">'+stLabel[st]+'</button>';
  });
  stBtns+='</div>';

  /* ê²°ì œ ìƒíƒœ */
  var payBtns='<div style="margin-bottom:12px"><div style="font-size:12px;font-weight:700;margin-bottom:6px">ê²°ì œ ìƒíƒœ</div><div style="display:flex;gap:6px;flex-wrap:wrap">';
  ['unpaid','deposit_received','partial','paid'].forEach(function(ps){
    payBtns+='<button class="btn btn-sm '+(o.payment_status===ps?'btn-pri':'btn-ghost')+'" style="font-size:11px" onclick="App.setOrderPay(\''+orderId+'\',\''+ps+'\')">'+payLabel[ps]+'</button>';
  });
  payBtns+='</div></div>';

  /* ê²°ì œ ë§ˆì¼ìŠ¤í†¤ */
  var orderMs=S.paymentMilestones.filter(function(pm){return pm.order_id===orderId;});
  var msHtml='';
  if(orderMs.length>0){
    var msLabels={deposit:'ê³„ì•½ê¸ˆ',production_balance:'ìƒì‚°ì”ê¸ˆ',pre_shipment:'ì„ ì ì „',post_shipment:'ì„ ì í›„',final:'ìµœì¢…',lc_opening:'L/C ê°œì„¤',lc_negotiation:'L/C ë„¤ê³ '};
    var msColors={pending:'var(--w40)',invoiced:'var(--acc)',paid:'var(--ok)',overdue:'var(--err)',waived:'var(--purple)'};
    var msSt={pending:'ëŒ€ê¸°',invoiced:'ì²­êµ¬',paid:'ì™„ë‚©',overdue:'ì—°ì²´',waived:'ë©´ì œ'};
    msHtml='<div style="padding:12px;border-radius:10px;background:var(--w08);margin-bottom:12px"><div style="font-size:12px;font-weight:700;margin-bottom:8px">ğŸ’° ê²°ì œ ë§ˆì¼ìŠ¤í†¤</div>';
    orderMs.forEach(function(pm){
      msHtml+='<div style="display:flex;align-items:center;gap:8px;padding:5px 0;border-bottom:1px solid var(--w08)">';
      msHtml+='<div style="width:8px;height:8px;border-radius:4px;background:'+(msColors[pm.status]||'var(--w40)')+'"></div>';
      msHtml+='<div style="flex:1;font-size:12px"><b>'+(msLabels[pm.name]||pm.name)+'</b> ('+(pm.percentage||0)+'%)</div>';
      msHtml+='<div style="font-size:12px;font-weight:700">$'+(pm.amount||0).toLocaleString()+'</div>';
      msHtml+='<span style="font-size:10px;padding:2px 6px;border-radius:6px;color:'+(msColors[pm.status]||'var(--w40)')+';background:rgba(0,0,0,.1)">'+(msSt[pm.status]||pm.status)+'</span>';
      if(pm.status==='pending'||pm.status==='invoiced')msHtml+='<button class="btn btn-ok btn-sm" style="font-size:10px;padding:2px 6px" onclick="App.setMilestonePaid(\''+pm.id+'\')">ì™„ë‚©</button>';
      msHtml+='</div>';
    });
    msHtml+='</div>';
  }

  /* ì„ ì  ì •ë³´ */
  var orderSh=S.shipments.filter(function(sh){return sh.order_id===orderId;});
  var shipInfo='<div style="padding:12px;border-radius:10px;background:var(--w08);margin-bottom:12px"><div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px"><div style="font-size:12px;font-weight:700">ğŸš¢ ì„ ì  ì •ë³´</div><button class="btn btn-ghost btn-sm" style="font-size:10px" onclick="App.showShipmentForm(\''+orderId+'\')">+ ì„ ì </button></div>';
  if(orderSh.length>0){
    var shStLabel={booked:'ë¶€í‚¹',loaded:'ì„ ì ',departed:'ì¶œí•­',in_transit:'ìš´ì†¡ì¤‘',arrived:'ë„ì°©',customs_clearance:'í†µê´€',delivered:'ë°°ë‹¬',exception:'ì´ìŠˆ'};
    var shStColor={booked:'var(--w40)',loaded:'var(--acc)',departed:'var(--pri)',in_transit:'#3b82f6',arrived:'var(--purple)',customs_clearance:'var(--acc)',delivered:'var(--ok)',exception:'var(--err)'};
    orderSh.forEach(function(sh){
      shipInfo+='<div style="padding:8px;border-radius:8px;background:rgba(0,0,0,.1);margin-bottom:4px">';
      shipInfo+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px"><span style="font-size:10px;padding:2px 6px;border-radius:6px;background:rgba(0,0,0,.1);color:'+(shStColor[sh.status]||'var(--w40)')+'">'+(shStLabel[sh.status]||sh.status)+'</span>';
      shipInfo+='<span style="font-size:12px;font-weight:700">'+(sh.type==='ocean'?'ğŸš¢':sh.type==='air'?'âœˆï¸':'ğŸ“¦')+' '+(sh.bl_number||sh.awb_number||'TBD')+'</span></div>';
      shipInfo+='<div style="font-size:11px;color:var(--w40)">'+(sh.port_of_loading||'â€”')+' â†’ '+(sh.port_of_discharge||'â€”');
      if(sh.etd)shipInfo+=' Â· ETD: '+sh.etd;if(sh.eta)shipInfo+=' Â· ETA: '+sh.eta;
      if(sh.forwarder_name)shipInfo+=' Â· '+sh.forwarder_name;
      shipInfo+='</div></div>';
    });
  }else{
    shipInfo+='<div class="grid-2">'+
    UI.inp('o_tracking','ìš´ì†¡ì¥ë²ˆí˜¸',{value:o.tracking_number||'',onchange:'App.updateOrderField(\"'+orderId+'\",\"tracking_number\",this.value)'})+
    UI.inp('o_ship_date','ì„ ì ì¼',{type:'date',value:o.actual_ship_date||o.estimated_ship_date||'',onchange:'App.updateOrderField(\"'+orderId+'\",\"estimated_ship_date\",this.value)'})+
    '</div>';
  }
  shipInfo+='</div>';

  var notes=(o.notes||[]).map(function(n){return '<div style="font-size:11px;color:var(--w60);padding:4px 0;border-bottom:1px solid var(--w08)">'+
    '<span style="color:var(--w20);font-size:10px">'+U.fd(n.date,'rel')+'</span> '+n.text+'</div>';}).join('');

  var body=pipe+stBtns+
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;font-size:13px">'+
    '<div><span style="color:var(--w40)">ë°”ì´ì–´:</span> <b>'+(buyer?buyer.company_name:'â€”')+'</b></div>'+
    '<div><span style="color:var(--w40)">ê¸ˆì•¡:</span> <b style="color:var(--acc)">'+U.fmtUSD(o.total_amount)+'</b></div>'+
    '<div><span style="color:var(--w40)">ê²°ì œì¡°ê±´:</span> '+(o.payment_terms||'â€”')+'</div>'+
    '<div><span style="color:var(--w40)">ì¸ì½”í…€ì¦ˆ:</span> '+(o.incoterms||'FOB')+'</div></div>'+
    payBtns+msHtml+shipInfo+
    (notes?'<div style="margin-bottom:12px"><div style="font-size:12px;font-weight:700;margin-bottom:4px">ë©”ëª¨</div>'+notes+'</div>':'')+
    '<div style="display:flex;gap:8px;flex-wrap:wrap"><button class="btn btn-ghost btn-sm" onclick="App.addOrderNote(\''+orderId+'\')">+ ë©”ëª¨</button>'+
    '<button class="btn btn-ghost btn-sm" onclick="App.startDoc(\'pi\');App.closeModal(\'od\')">ğŸ“„ ì„œë¥˜</button>'+
    (buyer?'<button class="btn btn-ghost btn-sm" onclick="App.showMeetingForm({buyer_id:\''+buyer.id+'\',title:\'ì£¼ë¬¸ '+o.order_number+' ë¯¸íŒ…\'});App.closeModal(\'od\')">ğŸ“… ë¯¸íŒ…</button>':'')+
    '</div>';

  document.body.insertAdjacentHTML('beforeend',UI.modal({id:'od',title:'ğŸ“‹ '+o.order_number,body:body,footer:'<button class="btn btn-ghost" onclick="App.closeModal(\'od\')">ë‹«ê¸°</button>',width:'600px'}));UI.showModal('od');
}

function setOrderStatus(orderId,status){
  sb.from('orders').update({status:status,updated_at:new Date().toISOString()}).eq('id',orderId).then(function(r){
    if(r.error){UI.toast('ì‹¤íŒ¨','err');return;}
    var o=S.orders.find(function(x){return x.id===orderId;});if(o)o.status=status;
    closeModal('od');render();UI.toast('ìƒíƒœ: '+status,'ok');
    var stL={confirmed:'í™•ì •',production:'ìƒì‚°ì¤‘',inspection:'ê²€ìˆ˜',shipping:'ì„ ì ',delivered:'ë°°ì†¡ì¤‘',completed:'ì™„ë£Œ'};
    pushNotif('order','ì£¼ë¬¸ ìƒíƒœ ë³€ê²½: '+(o?o.order_number:''),stL[status]||status,'orders',null,status==='shipping'||status==='completed');
  });
}

function setOrderPay(orderId,ps){
  var upd={payment_status:ps,updated_at:new Date().toISOString()};
  if(ps==='deposit_received')upd.deposit_received_at=new Date().toISOString();
  if(ps==='paid')upd.balance_received_at=new Date().toISOString();
  sb.from('orders').update(upd).eq('id',orderId).then(function(r){
    if(r.error){UI.toast('ì‹¤íŒ¨','err');return;}
    var o=S.orders.find(function(x){return x.id===orderId;});if(o){o.payment_status=ps;}
    closeModal('od');render();UI.toast('ê²°ì œ: '+ps,'ok');
  });
}

function updateOrderField(orderId,field,value){
  var upd={updated_at:new Date().toISOString()};upd[field]=value;
  sb.from('orders').update(upd).eq('id',orderId).then(function(r){
    if(!r.error){var o=S.orders.find(function(x){return x.id===orderId;});if(o)o[field]=value;}
  });
}

function addOrderNote(orderId){
  var text=prompt('ë©”ëª¨:');if(!text)return;
  var o=S.orders.find(function(x){return x.id===orderId;});if(!o)return;
  var notes=o.notes||[];notes.push({text:text,date:new Date().toISOString()});
  sb.from('orders').update({notes:notes,updated_at:new Date().toISOString()}).eq('id',orderId).then(function(r){
    if(r.error){UI.toast('ì‹¤íŒ¨','err');return;}o.notes=notes;closeModal('od');viewOrder(orderId);
  });
}

function pgBuyers(){
  var typeLabel={distributor:'ìœ í†µ',retailer:'ì†Œë§¤',online:'ì˜¨ë¼ì¸',wholesaler:'ë„ë§¤',chain:'ì²´ì¸',other:'ê¸°íƒ€'};
  var srcLabel={manual:'ì§ì ‘ë“±ë¡',platform:'í”Œë«í¼',ai_generated:'AI ì¶”ì²œ',linkedin:'LinkedIn',alibaba:'ì•Œë¦¬ë°”ë°”',exhibition:'ì „ì‹œíšŒ',referral:'ì†Œê°œ'};
  var srcColor={ai_generated:'var(--pri)',alibaba:'var(--acc)',exhibition:'var(--ok)',linkedin:'var(--pri)'};

  /* ê¸°ì¡´ ë°”ì´ì–´ ëª©ë¡ */
  var list='';
  if(S.buyers.length){
    list='<table class="tbl"><thead><tr><th>íšŒì‚¬</th><th>ë‹´ë‹¹ì</th><th>êµ­ê°€</th><th>ì¶œì²˜</th><th>ì‹ ë¢°ë„</th><th>ì•¡ì…˜</th></tr></thead><tbody>'+
    S.buyers.map(function(b){
      var sc=b.trust_score||0;var scCol=sc>=70?'var(--ok)':sc>=40?'var(--acc)':'var(--w40)';
      var bSamples=S.samples.filter(function(s){return s.buyer_id===b.id;});
      var bMeetings=S.meetings.filter(function(m){return m.buyer_id===b.id;});
      return '<tr><td style="font-weight:600">'+b.company_name+'</td><td>'+(b.contact_name||'\u2014')+'</td><td>'+U.cl(b.country)+'</td>'+
      '<td><span style="font-size:10px;padding:2px 6px;border-radius:8px;background:var(--w08);color:'+(srcColor[b.source]||'var(--w40)')+'">'+
      (srcLabel[b.source]||b.source||'ì§ì ‘')+'</span></td>'+
      '<td style="color:'+scCol+';font-weight:600;font-size:12px">'+sc+'</td>'+
      '<td style="white-space:nowrap"><div style="display:flex;gap:3px">'+
      (b.email?'<button class="btn btn-ghost btn-sm" style="font-size:10px;padding:2px 6px" onclick="event.stopPropagation();App.composeE(\'intro\',\''+b.id+'\')" title="ì´ë©”ì¼">âœ‰ï¸</button>':'')+
      '<button class="btn btn-ghost btn-sm" style="font-size:10px;padding:2px 6px" onclick="event.stopPropagation();App.showMeetingForm({buyer_id:\''+b.id+'\',title:\''+b.company_name.replace(/'/g,"")+' ë¯¸íŒ…\'})" title="ë¯¸íŒ…">ğŸ“…</button>'+
      '<button class="btn btn-ghost btn-sm" style="font-size:10px;padding:2px 6px" onclick="event.stopPropagation();App.showSampleForm(\''+b.id+'\')" title="ìƒ˜í”Œ">ğŸ“¦'+(bSamples.length?'<sup>'+bSamples.length+'</sup>':'')+'</button>'+
      '</div></td></tr>';
    }).join('')+'</tbody></table>';
  }else{
    list='<div style="padding:18px">'+UI.empty('ğŸ¤','ì—†ìŒ','ë°”ì´ì–´ë¥¼ ë“±ë¡í•˜ê±°ë‚˜ AIë¡œ ì°¾ì•„ë³´ì„¸ìš”')+'</div>';
  }

  /* AI ë°œêµ´ í¼ */
  var aiForm='<div class="card" style="margin-bottom:16px;border-color:rgba(0,212,255,.15)"><div class="card-h">ğŸ¤– AI ë°”ì´ì–´ ë°œêµ´</div><div class="card-b">'+
    '<form id="abf" onsubmit="event.preventDefault();App.findBuyersAI()"><div class="grid-3">'+
    UI.sel('target_market','ëª©í‘œ ì‹œì¥',[
      {value:'US',label:'ğŸ‡ºğŸ‡¸ ë¯¸êµ­'},{value:'JP',label:'ğŸ‡¯ğŸ‡µ ì¼ë³¸'},{value:'DE',label:'ğŸ‡©ğŸ‡ª ë…ì¼/EU'},
      {value:'CN',label:'ğŸ‡¨ğŸ‡³ ì¤‘êµ­'},{value:'SG',label:'ğŸ‡¸ğŸ‡¬ ì‹±ê°€í¬ë¥´'},{value:'VN',label:'ğŸ‡»ğŸ‡³ ë² íŠ¸ë‚¨'},
      {value:'AE',label:'ğŸ‡¦ğŸ‡ª ë‘ë°”ì´/ì¤‘ë™'},{value:'AU',label:'ğŸ‡¦ğŸ‡º í˜¸ì£¼'},{value:'TH',label:'ğŸ‡¹ğŸ‡­ íƒœêµ­'},{value:'ID',label:'ğŸ‡®ğŸ‡© ì¸ë„ë„¤ì‹œì•„'}
    ])+
    UI.sel('product_cat','ì œí’ˆ ì¹´í…Œê³ ë¦¬',[
      {value:'Skincare',label:'ìŠ¤í‚¨ì¼€ì–´'},{value:'Makeup',label:'ë©”ì´í¬ì—…'},{value:'Haircare',label:'í—¤ì–´ì¼€ì–´'},
      {value:'Bodycare',label:'ë°”ë””ì¼€ì–´'},{value:'Fragrance',label:'í–¥ìˆ˜/ë°©í–¥'},{value:'Beauty Device',label:'ë·°í‹°ë””ë°”ì´ìŠ¤'},
      {value:'Health Supplement',label:'ê±´ê°•ê¸°ëŠ¥ì‹í’ˆ'},{value:'Food & Beverage',label:'ì‹í’ˆ/ìŒë£Œ'},
      {value:'Fashion & Apparel',label:'íŒ¨ì…˜/ì˜ë¥˜'},{value:'Electronics & IoT',label:'ì „ìì œí’ˆ/IoT'},
      {value:'Home & Living',label:'ìƒí™œìš©í’ˆ/í™ˆë¦¬ë¹™'},{value:'Sauce & Seasoning',label:'ì†ŒìŠ¤/ì–‘ë…'},
      {value:'Pet Products',label:'ë°˜ë ¤ë™ë¬¼ìš©í’ˆ'},{value:'Auto Parts',label:'ìë™ì°¨ë¶€í’ˆ'}
    ])+
    UI.inp('fob_hint','FOB ë‹¨ê°€(USD)',{type:'number',step:'0.01',placeholder:'4.50'})+'</div>'+
    '<button class="btn btn-pri btn-block" type="submit" style="margin-top:10px">ğŸ” AI ë°”ì´ì–´ í›„ë³´ ì°¾ê¸°</button>'+
    '</form><div id="ai-buyers-result"></div></div></div>';

  return '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:8px"><div><h2 style="font-size:18px;font-weight:800">ğŸ¤ ë°”ì´ì–´ ê´€ë¦¬</h2><p style="font-size:12px;color:var(--w40);margin-top:2px">ë“±ë¡ '+S.buyers.length+'ê±´'+((S.buyers.filter(function(b){return b.source==='ai_generated';}).length)?' Â· AI ì¶”ì²œ '+S.buyers.filter(function(b){return b.source==='ai_generated';}).length+'ê±´':'')+'</p></div><button class="btn btn-pri" onclick="App.showBF()">+ ì§ì ‘ ë“±ë¡</button></div>'+
  aiForm+
  '<div class="card"><div class="card-h">ğŸ“‹ ë°”ì´ì–´ ëª©ë¡</div><div class="card-b" style="padding:0">'+list+'</div></div>';
}

function findBuyersAI(){
  var d=UI.fd('#abf');if(!d.target_market){UI.toast('ëª©í‘œ ì‹œì¥ì„ ì„ íƒí•˜ì„¸ìš”','warn');return;}
  var prod=S.products[0];var certs=[];
  if(prod&&S.projects.length){var sp=S.projects[0].stage_progress||{};certs=(sp.certs||[]).filter(function(c){return c.status==='approved';}).map(function(c){return c.name;});}
  document.getElementById('ai-buyers-result').innerHTML='<div style="padding:20px;text-align:center"><div class="spinner" style="margin:0 auto 10px"></div><div style="font-size:13px;color:var(--w40)">AIê°€ '+d.target_market+' ì‹œì¥ ë°”ì´ì–´ë¥¼ ë¶„ì„ì¤‘...</div></div>';
  fetch(RELAY_URL+'/api/whistle/find-buyers',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
    targetMarket:d.target_market,productCategory:d.product_cat||'Skincare',fobPrice:d.fob_hint||'',
    productName:prod?prod.name_en||prod.name_ko:'',hsCode:prod?prod.hs_code:'3304.99',
    certifications:certs.join(', ')||'ì—†ìŒ'
  })}).then(function(r){return r.json();}).then(function(data){
    if(!data.ok||!data.buyers||!data.buyers.length){
      document.getElementById('ai-buyers-result').innerHTML='<div style="padding:16px;color:var(--err)">ë°”ì´ì–´ ì°¾ê¸° ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</div>';return;
    }
    var h='<div style="margin-top:16px"><div style="display:flex;align-items:center;gap:8px;margin-bottom:12px"><span style="font-weight:700;font-size:14px">AI ì¶”ì²œ ë°”ì´ì–´ '+data.buyers.length+'ê±´</span><button class="btn btn-ghost btn-sm" onclick="App.saveAllAIBuyers()">ì „ì²´ ì €ì¥</button></div>';
    h+='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:10px">';
    window._aiBuyers=data.buyers;
    data.buyers.forEach(function(b,i){
      var scCol=b.match_score>=80?'var(--ok)':b.match_score>=60?'var(--acc)':'var(--w40)';
      h+='<div style="padding:14px;border-radius:12px;background:var(--w08);border:1px solid var(--bd)" id="ai-b-'+i+'">'+
        '<div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:6px"><div style="font-weight:700;font-size:13px">'+b.company_name+'</div><div style="font-size:20px;font-weight:800;color:'+scCol+'">'+b.match_score+'</div></div>'+
        '<div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:6px">'+
        '<span style="font-size:10px;padding:2px 6px;border-radius:8px;background:var(--w08);color:var(--pri)">'+U.cl(b.country)+' '+(b.city||'')+'</span>'+
        '<span style="font-size:10px;padding:2px 6px;border-radius:8px;background:var(--w08);color:var(--acc)">'+(b.type||'')+'</span>'+
        '<span style="font-size:10px;padding:2px 6px;border-radius:8px;background:var(--w08);color:var(--w40)">'+(b.scale||'')+'</span>'+
        '</div>'+
        '<div style="font-size:11px;color:var(--w60);margin-bottom:4px">'+(b.match_reason||'')+'</div>'+
        '<div style="font-size:11px;color:var(--w40);margin-bottom:8px">MOQ: '+(b.estimated_moq||'ë¯¸ì •')+'</div>'+
        '<details style="margin-bottom:8px"><summary style="font-size:11px;color:var(--pri);cursor:pointer">ì ‘ê·¼ ì „ëµ</summary><div style="font-size:11px;color:var(--w60);margin-top:4px;line-height:1.5">'+(b.approach_strategy||'')+'<br><span style="color:var(--w40)">ì—°ë½: '+(b.contact_hint||'')+'</span></div></details>'+
        '<div style="display:flex;gap:6px"><button class="btn btn-pri btn-sm" style="flex:1;font-size:11px" onclick="App.saveAIBuyer('+i+')">ğŸ’¾ ì €ì¥</button>'+
        (b.website?'<a href="'+b.website+'" target="_blank" class="btn btn-ghost btn-sm" style="font-size:11px">ğŸ”—</a>':'')+
        '</div></div>';
    });
    h+='</div></div>';
    document.getElementById('ai-buyers-result').innerHTML=h;
    pushNotif('buyer','AI ë°”ì´ì–´ '+data.buyers.length+'ê±´ ë°œêµ´ ì™„ë£Œ',d.target_market+' ì‹œì¥ ë§¤ì¹­ ë°”ì´ì–´ë¥¼ í™•ì¸í•˜ì„¸ìš”','buyers');
  }).catch(function(e){
    document.getElementById('ai-buyers-result').innerHTML='<div style="padding:16px;color:var(--err)">ì„œë²„ ì—°ê²° ì‹¤íŒ¨</div>';
  });
}

function saveAIBuyer(idx){
  var b=window._aiBuyers&&window._aiBuyers[idx];if(!b)return;
  var data={
    registered_by:S.user.id,source:'ai_generated',company_name:b.company_name,
    country:b.country||'',city:b.city||'',website:b.website||'',
    categories:b.categories||[],moq_range:b.estimated_moq||'',
    trust_score:b.match_score||0,
    notes:'[AI] '+b.approach_strategy+'\nì—°ë½: '+(b.contact_hint||''),
    tags:[b.type||'',b.scale||''].filter(Boolean)
  };
  sb.from('buyers').insert(data).then(function(r){
    if(r.error){UI.toast('ì €ì¥ ì‹¤íŒ¨','err');return;}
    var el=document.getElementById('ai-b-'+idx);
    if(el)el.style.opacity='0.5';
    loadB().then(function(){UI.toast(b.company_name+' ì €ì¥!','ok');});
  });
}

function saveAllAIBuyers(){
  if(!window._aiBuyers||!window._aiBuyers.length)return;
  var rows=window._aiBuyers.map(function(b){
    return {registered_by:S.user.id,source:'ai_generated',company_name:b.company_name,
      country:b.country||'',city:b.city||'',website:b.website||'',
      categories:b.categories||[],moq_range:b.estimated_moq||'',
      trust_score:b.match_score||0,notes:'[AI] '+b.approach_strategy+'\nì—°ë½: '+(b.contact_hint||''),
      tags:[b.type||'',b.scale||''].filter(Boolean)};
  });
  sb.from('buyers').insert(rows).then(function(r){
    if(r.error){UI.toast('ì €ì¥ ì‹¤íŒ¨: '+r.error.message,'err');return;}
    loadB().then(function(){render();UI.toast(rows.length+'ê±´ ë°”ì´ì–´ ì €ì¥!','ok');});
  });
}

function showBF(){
  var body='<form id="bf">'+UI.inp('company_name','íšŒì‚¬ëª… *',{required:true})+'<div class="grid-2">'+UI.inp('contact_name','ë‹´ë‹¹ì')+UI.inp('email','ì´ë©”ì¼')+'</div><div class="grid-2">'+UI.inp('country','êµ­ê°€ì½”ë“œ',{placeholder:'US, JP...'})+UI.inp('phone','ì „í™”')+'</div>'+UI.ta('notes','ë©”ëª¨')+'</form>';
  document.body.insertAdjacentHTML('beforeend',UI.modal({id:'bm',title:'ë°”ì´ì–´ ë“±ë¡',body:body,footer:'<button class="btn btn-ghost" onclick="App.closeModal(\'bm\')">ì·¨ì†Œ</button><button class="btn btn-pri" onclick="App.saveBuyer()">ì €ì¥</button>'}));UI.showModal('bm');
}

function saveBuyer(){
  var d=UI.fd('#bf');if(!d.company_name){UI.toast('íšŒì‚¬ëª…','warn');return;}d.registered_by=S.user.id;
  sb.from('buyers').insert(d).then(function(r){if(r.error){UI.toast('ì‹¤íŒ¨','err');return;}closeModal('bm');loadB().then(function(){render();UI.toast('ë“±ë¡!','ok');});});
}

/* === MEETINGS === */
function pgMeetings(){
  var typeIcon={video_call:'ğŸ“¹',phone:'ğŸ“',in_person:'ğŸ¤',trade_show:'ğŸ¢',online_demo:'ğŸ’»'};
  var typeLabel={video_call:'í™”ìƒë¯¸íŒ…',phone:'ì „í™”',in_person:'ëŒ€ë©´',trade_show:'ì „ì‹œíšŒ',online_demo:'ì˜¨ë¼ì¸ ë°ëª¨'};
  var stLabel={scheduled:'ì˜ˆì •',confirmed:'í™•ì •',completed:'ì™„ë£Œ',cancelled:'ì·¨ì†Œ',no_show:'ë¶ˆì°¸',rescheduled:'ë³€ê²½'};
  var stColor={scheduled:'var(--pri)',confirmed:'var(--acc)',completed:'var(--ok)',cancelled:'var(--err)',no_show:'var(--err)',rescheduled:'var(--purple)'};
  var now=new Date();
  var upcoming=S.meetings.filter(function(m){return new Date(m.scheduled_at)>=now&&m.status!=='cancelled';}).sort(function(a,b){return new Date(a.scheduled_at)-new Date(b.scheduled_at);});
  var past=S.meetings.filter(function(m){return new Date(m.scheduled_at)<now||m.status==='completed'||m.status==='cancelled';}).sort(function(a,b){return new Date(b.scheduled_at)-new Date(a.scheduled_at);});
  var todayMeetings=upcoming.filter(function(m){return new Date(m.scheduled_at).toDateString()===now.toDateString();});
  var weekMs=upcoming.filter(function(m){var d=new Date(m.scheduled_at);return d-now<7*86400000;});
  /* stats */
  var h='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:8px"><div><h2 style="font-size:18px;font-weight:800">ğŸ“… ì¼ì • ê´€ë¦¬</h2><p style="font-size:13px;color:var(--w40);margin-top:2px">ë°”ì´ì–´ ë¯¸íŒ…, í™”ìƒíšŒì˜, ì „ì‹œíšŒ ì¼ì •ì„ ê´€ë¦¬í•©ë‹ˆë‹¤</p></div><button class="btn btn-pri" onclick="App.showMeetingForm()">+ ìƒˆ ë¯¸íŒ…</button></div>';
  h+='<div class="grid-4" style="margin-bottom:16px">'+UI.stat('ì˜¤ëŠ˜',todayMeetings.length+'ê±´','ë¯¸íŒ…','var(--acc)')+UI.stat('ì´ë²ˆ ì£¼',weekMs.length+'ê±´','ì˜ˆì •','var(--pri)')+UI.stat('ì´ ë¯¸íŒ…',S.meetings.length+'ê±´','ëˆ„ì ','#3b82f6')+UI.stat('ì™„ë£Œ',S.meetings.filter(function(m){return m.status==='completed';}).length+'ê±´','','var(--ok)')+'</div>';
  /* ì˜¤ëŠ˜ ë¯¸íŒ… í•˜ì´ë¼ì´íŠ¸ */
  if(todayMeetings.length>0){
    h+='<div class="card" style="margin-bottom:16px;border-color:rgba(255,184,0,.25)"><div class="card-h"><span>ğŸ”¥ ì˜¤ëŠ˜ ë¯¸íŒ…</span><span class="badge badge-acc">'+todayMeetings.length+'ê±´</span></div><div class="card-b">';
    todayMeetings.forEach(function(m){
      var buyer=S.buyers.find(function(b){return b.id===m.buyer_id;});
      var mt=new Date(m.scheduled_at);
      h+='<div style="display:flex;align-items:center;gap:12px;padding:10px;border-radius:10px;background:var(--w08);margin-bottom:6px;cursor:pointer" onclick="App.viewMeeting(\''+m.id+'\')">';
      h+='<div style="text-align:center;min-width:50px"><div style="font-size:20px;font-weight:800;color:var(--acc)">'+mt.toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'})+'</div><div style="font-size:10px;color:var(--w40)">'+m.duration_min+'ë¶„</div></div>';
      h+='<div style="flex:1"><div style="font-weight:700;font-size:14px">'+typeIcon[m.type]+' '+m.title+'</div><div style="font-size:12px;color:var(--w40)">'+(buyer?buyer.company_name:'â€”')+' Â· '+(typeLabel[m.type]||m.type)+(m.platform?' Â· '+m.platform:'')+'</div></div>';
      if(m.meeting_url)h+='<a href="'+m.meeting_url+'" target="_blank" class="btn btn-pri btn-sm" onclick="event.stopPropagation()">ì…ì¥</a>';
      h+='</div>';
    });
    h+='</div></div>';
  }
  /* ì˜ˆì • ë¯¸íŒ… ëª©ë¡ */
  h+='<div class="card" style="margin-bottom:16px"><div class="card-h"><span>ğŸ“… ì˜ˆì • ë¯¸íŒ…</span></div><div class="card-b" style="padding:'+(upcoming.length?'8px':'0')+'">';
  if(upcoming.length===0){h+=UI.empty('ğŸ“…','ì˜ˆì •ëœ ë¯¸íŒ…ì´ ì—†ìŠµë‹ˆë‹¤','ë°”ì´ì–´ì™€ ë¯¸íŒ…ì„ ì¡ì•„ë³´ì„¸ìš”');}
  else{upcoming.slice(0,15).forEach(function(m){
    var buyer=S.buyers.find(function(b){return b.id===m.buyer_id;});
    var mt=new Date(m.scheduled_at);var isToday=mt.toDateString()===now.toDateString();
    var diffDays=Math.ceil((mt-now)/(1000*60*60*24));
    var dtStr=isToday?'ì˜¤ëŠ˜ '+mt.toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'}):diffDays<=7?diffDays+'ì¼ í›„ '+mt.toLocaleDateString('ko-KR',{month:'short',day:'numeric'}):U.fd(m.scheduled_at,'short');
    h+='<div style="padding:10px;border-radius:10px;background:var(--w08);margin-bottom:6px;border-left:4px solid '+stColor[m.status]+';cursor:pointer" onclick="App.viewMeeting(\''+m.id+'\')">';
    h+='<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:6px">';
    h+='<div><div style="font-weight:700;font-size:13px">'+typeIcon[m.type]+' '+m.title+'</div><div style="font-size:11px;color:var(--w40)">'+(buyer?buyer.company_name:'â€”')+' Â· '+dtStr+' Â· '+m.duration_min+'ë¶„'+(m.platform?' Â· '+m.platform:'')+'</div></div>';
    h+='<span style="font-size:10px;padding:3px 8px;border-radius:8px;background:rgba(0,0,0,.1);color:'+stColor[m.status]+'">'+stLabel[m.status]+'</span>';
    h+='</div></div>';
  });}
  h+='</div></div>';
  /* ì™„ë£Œëœ ë¯¸íŒ… */
  if(past.length>0){
    h+='<div class="card"><div class="card-h"><span>âœ… ì§€ë‚œ ë¯¸íŒ…</span><span style="font-size:12px;color:var(--w40)">'+past.length+'ê±´</span></div><div class="card-b" style="padding:8px">';
    past.slice(0,10).forEach(function(m){
      var buyer=S.buyers.find(function(b){return b.id===m.buyer_id;});
      h+='<div style="padding:8px;border-radius:8px;margin-bottom:4px;opacity:.7;cursor:pointer" onclick="App.viewMeeting(\''+m.id+'\')">';
      h+='<div style="display:flex;justify-content:space-between;align-items:center">';
      h+='<div><div style="font-size:13px;font-weight:600">'+typeIcon[m.type]+' '+m.title+'</div><div style="font-size:11px;color:var(--w40)">'+(buyer?buyer.company_name:'â€”')+' Â· '+U.fd(m.scheduled_at,'short')+'</div></div>';
      h+='<span style="font-size:10px;padding:3px 8px;border-radius:8px;background:rgba(0,0,0,.1);color:'+stColor[m.status||'completed']+'">'+stLabel[m.status||'completed']+'</span>';
      h+='</div></div>';
    });
    h+='</div></div>';
  }
  return h;
}

function showMeetingForm(prefill){
  var pf=prefill||{};
  var buyerOpts=S.buyers.map(function(b){return {value:b.id,label:b.company_name+' ('+(b.country||'')+')'};});
  buyerOpts.unshift({value:'',label:'-- ë°”ì´ì–´ ì„ íƒ --'});
  var pjOpts=S.projects.map(function(p){return {value:p.id,label:p.name};});
  pjOpts.unshift({value:'',label:'-- í”„ë¡œì íŠ¸ --'});
  var defDate=new Date();defDate.setDate(defDate.getDate()+1);defDate.setHours(10,0,0,0);
  var dtVal=pf.scheduled_at||defDate.toISOString().slice(0,16);
  var body='<form id="mtf">'+
    UI.inp('title','ë¯¸íŒ… ì œëª©',{value:pf.title||'',placeholder:'ì˜ˆ: ì²« í™”ìƒë¯¸íŒ…, ê°€ê²© í˜‘ìƒ ë“±'})+
    '<div class="grid-2">'+UI.sel('buyer_id','ë°”ì´ì–´',buyerOpts,pf.buyer_id)+UI.sel('project_id','í”„ë¡œì íŠ¸',pjOpts,pf.project_id)+'</div>'+
    '<div class="grid-3">'+UI.sel('type','ìœ í˜•',[{value:'video_call',label:'ğŸ“¹ í™”ìƒë¯¸íŒ…'},{value:'phone',label:'ğŸ“ ì „í™”'},{value:'in_person',label:'ğŸ¤ ëŒ€ë©´'},{value:'trade_show',label:'ğŸ¢ ì „ì‹œíšŒ'},{value:'online_demo',label:'ğŸ’» ì˜¨ë¼ì¸ ë°ëª¨'}],pf.type)+
    UI.sel('platform','í”Œë«í¼',[{value:'',label:'-- ì„ íƒ --'},{value:'zoom',label:'Zoom'},{value:'google_meet',label:'Google Meet'},{value:'teams',label:'MS Teams'},{value:'skype',label:'Skype'},{value:'kakao',label:'ì¹´ì¹´ì˜¤í†¡'},{value:'other',label:'ê¸°íƒ€'}],pf.platform)+
    UI.inp('duration_min','ì†Œìš”ì‹œê°„(ë¶„)',{type:'number',value:pf.duration_min||60})+'</div>'+
    '<div class="grid-2">'+UI.inp('scheduled_at','ì¼ì‹œ',{type:'datetime-local',value:dtVal})+UI.inp('meeting_url','ë¯¸íŒ… ë§í¬',{placeholder:'https://zoom.us/j/...',value:pf.meeting_url||''})+'</div>'+
    UI.inp('location','ì¥ì†Œ',{placeholder:'ì˜¨ë¼ì¸ ë˜ëŠ” ì¥ì†Œëª…',value:pf.location||''})+
    UI.ta('agenda_text','ì•ˆê±´',{placeholder:'ë…¼ì˜í•  ë‚´ìš© (ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„)',rows:3,value:pf.agenda_text||''})+
  '</form>';
  document.body.insertAdjacentHTML('beforeend',UI.modal({id:'mm',title:'ğŸ“… '+(pf.id?'ë¯¸íŒ… ìˆ˜ì •':'ìƒˆ ë¯¸íŒ… ë“±ë¡'),body:body,footer:'<button class="btn btn-ghost" onclick="App.closeModal(\'mm\')">ì·¨ì†Œ</button>'+(pf.id?'<button class="btn btn-acc" onclick="App.getMeetingPrep(\''+pf.id+'\')">ğŸ¤– AI ë¸Œë¦¬í•‘</button>':'')+'<button class="btn btn-pri" onclick="App.saveMeeting('+(pf.id?'\''+pf.id+'\'':'')+')">ì €ì¥</button>',width:'600px'}));UI.showModal('mm');
}

function saveMeeting(editId){
  var d=UI.fd('#mtf');if(!d.title){UI.toast('ì œëª© í•„ìˆ˜','warn');return;}if(!d.scheduled_at){UI.toast('ì¼ì‹œ í•„ìˆ˜','warn');return;}
  var agendaArr=d.agenda_text?d.agenda_text.split('\n').filter(function(x){return x.trim();}).map(function(x){return {text:x.trim(),done:false};}):[];
  var data={user_id:S.user.id,buyer_id:d.buyer_id||null,project_id:d.project_id||null,
    title:d.title,type:d.type||'video_call',scheduled_at:new Date(d.scheduled_at).toISOString(),
    duration_min:parseInt(d.duration_min)||60,platform:d.platform||null,
    meeting_url:d.meeting_url||null,location:d.location||null,agenda:agendaArr};
  var q=editId?sb.from('meetings').update(data).eq('id',editId):sb.from('meetings').insert(data);
  q.then(function(r){
    if(r.error){UI.toast('ì €ì¥ ì‹¤íŒ¨: '+r.error.message,'err');return;}
    closeModal('mm');loadMeetings().then(function(){render();UI.toast(editId?'ìˆ˜ì • ì™„ë£Œ!':'ë¯¸íŒ… ë“±ë¡!','ok');});
    if(!editId)pushNotif('meeting','ë¯¸íŒ… ë“±ë¡: '+d.title,U.fd(d.scheduled_at,'short'),'meetings',null,true);
  });
}

function viewMeeting(mid){
  var m=S.meetings.find(function(x){return x.id===mid;});if(!m)return;
  var buyer=S.buyers.find(function(b){return b.id===m.buyer_id;});
  var pj=S.projects.find(function(p){return p.id===m.project_id;});
  var typeIcon={video_call:'ğŸ“¹',phone:'ğŸ“',in_person:'ğŸ¤',trade_show:'ğŸ¢',online_demo:'ğŸ’»'};
  var typeLabel={video_call:'í™”ìƒë¯¸íŒ…',phone:'ì „í™”',in_person:'ëŒ€ë©´',trade_show:'ì „ì‹œíšŒ',online_demo:'ì˜¨ë¼ì¸ ë°ëª¨'};
  var stLabel={scheduled:'ì˜ˆì •',confirmed:'í™•ì •',completed:'ì™„ë£Œ',cancelled:'ì·¨ì†Œ',no_show:'ë¶ˆì°¸',rescheduled:'ë³€ê²½'};
  var stColor={scheduled:'var(--pri)',confirmed:'var(--acc)',completed:'var(--ok)',cancelled:'var(--err)',no_show:'var(--err)',rescheduled:'var(--purple)'};
  var mt=new Date(m.scheduled_at);var isPast=mt<new Date();
  var agenda=m.agenda||[];var actions=m.action_items||[];
  var h='<div style="margin-bottom:16px">';
  h+='<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px"><span class="badge" style="background:rgba(0,0,0,.1);color:'+stColor[m.status]+'">'+stLabel[m.status]+'</span><span class="badge badge-pri">'+(typeLabel[m.type]||m.type)+'</span>'+(m.platform?'<span class="badge badge-purple">'+m.platform+'</span>':'')+'</div>';
  h+='<div style="font-size:16px;font-weight:800;margin-bottom:4px">'+typeIcon[m.type]+' '+m.title+'</div>';
  h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:13px;color:var(--w60)">';
  h+='<div>ğŸ“… '+mt.toLocaleDateString('ko-KR',{year:'numeric',month:'long',day:'numeric',weekday:'short'})+' '+mt.toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'})+'</div>';
  h+='<div>â±ï¸ '+m.duration_min+'ë¶„</div>';
  if(buyer)h+='<div>ğŸ¤ '+buyer.company_name+'</div>';
  if(pj)h+='<div>ğŸš€ '+pj.name+'</div>';
  if(m.location)h+='<div>ğŸ“ '+m.location+'</div>';
  h+='</div>';
  if(m.meeting_url)h+='<div style="margin-top:8px"><a href="'+m.meeting_url+'" target="_blank" class="btn btn-pri btn-sm">ğŸ”— ë¯¸íŒ… ì…ì¥</a></div>';
  h+='</div>';
  /* AI ë¸Œë¦¬í•‘ */
  if(m.ai_briefing)h+='<div style="margin-bottom:12px;padding:12px;border-radius:10px;background:rgba(0,212,255,.05);border:1px solid rgba(0,212,255,.15)"><div style="font-size:12px;font-weight:700;color:var(--pri);margin-bottom:6px">ğŸ¤– AI ë¯¸íŒ… ë¸Œë¦¬í•‘</div><div style="font-size:12px;color:var(--w70);white-space:pre-wrap">'+m.ai_briefing+'</div></div>';
  /* ì•ˆê±´ */
  if(agenda.length>0){h+='<div style="margin-bottom:12px"><div style="font-size:13px;font-weight:700;margin-bottom:6px">ğŸ“‹ ì•ˆê±´</div>';
    agenda.forEach(function(a,i){h+='<div style="display:flex;gap:8px;align-items:center;padding:4px 0"><span style="color:var(--w40);font-size:12px">'+(i+1)+'.</span><span style="font-size:13px">'+a.text+'</span></div>';});
    h+='</div>';
  }
  /* ë¯¸íŒ… ë…¸íŠ¸ */
  h+='<div style="margin-bottom:12px"><div style="font-size:13px;font-weight:700;margin-bottom:6px">ğŸ“ ë¯¸íŒ… ë…¸íŠ¸</div>';
  h+='<textarea id="mt_notes" rows="4" style="width:100%;background:var(--w08);border:1px solid var(--bd);border-radius:8px;padding:10px;color:var(--w90);font-size:13px;font-family:inherit">'+(m.notes||'')+'</textarea></div>';
  /* ì•¡ì…˜ ì•„ì´í…œ */
  h+='<div style="margin-bottom:12px"><div style="font-size:13px;font-weight:700;margin-bottom:6px">âœ… ì•¡ì…˜ ì•„ì´í…œ</div>';
  if(actions.length>0){actions.forEach(function(a,i){h+='<div style="display:flex;gap:8px;align-items:center;padding:4px 0"><input type="checkbox" '+(a.done?'checked':'')+' onchange="App.toggleMeetingAction(\''+mid+'\','+i+')" style="cursor:pointer"><span style="font-size:13px;'+(a.done?'text-decoration:line-through;color:var(--w40)':'')+'">'+a.text+'</span></div>';});}
  h+='<div style="display:flex;gap:6px;margin-top:6px"><input id="mt_new_action" placeholder="ìƒˆ ì•¡ì…˜ ì•„ì´í…œ..." style="flex:1;background:var(--w08);border:1px solid var(--bd);border-radius:6px;padding:6px 10px;color:var(--w90);font-size:12px"><button class="btn btn-ghost btn-sm" onclick="App.addMeetingAction(\''+mid+'\')">ì¶”ê°€</button></div></div>';
  /* ë²„íŠ¼ë“¤ */
  var footer='<div style="display:flex;gap:6px;flex-wrap:wrap">';
  footer+='<button class="btn btn-ghost" onclick="App.closeModal(\'mv\')">ë‹«ê¸°</button>';
  footer+='<button class="btn btn-acc btn-sm" onclick="App.getMeetingPrep(\''+mid+'\')">ğŸ¤– AI ë¸Œë¦¬í•‘</button>';
  footer+='<button class="btn btn-pri btn-sm" onclick="App.saveMeetingNotes(\''+mid+'\')">ğŸ’¾ ë…¸íŠ¸ ì €ì¥</button>';
  if(!isPast&&m.status!=='completed')footer+='<button class="btn btn-ok btn-sm" onclick="App.completeMeeting(\''+mid+'\')">âœ… ì™„ë£Œ</button>';
  footer+='<button class="btn btn-ghost btn-sm" onclick="App.closeModal(\'mv\');App.showMeetingForm({id:\''+mid+'\',title:\''+m.title.replace(/'/g,"\\'")+'\',buyer_id:\''+(m.buyer_id||'')+'\',project_id:\''+(m.project_id||'')+'\',type:\''+m.type+'\',platform:\''+(m.platform||'')+'\',duration_min:'+m.duration_min+',scheduled_at:\''+new Date(m.scheduled_at).toISOString().slice(0,16)+'\',meeting_url:\''+(m.meeting_url||'').replace(/'/g,"\\'")+'\',location:\''+(m.location||'').replace(/'/g,"\\'")+'\'})">âœï¸ ìˆ˜ì •</button>';
  if(m.status!=='cancelled')footer+='<button class="btn btn-danger btn-sm" onclick="App.setMeetingStatus(\''+mid+'\',\'cancelled\')">ì·¨ì†Œ</button>';
  footer+='</div>';
  document.body.insertAdjacentHTML('beforeend',UI.modal({id:'mv',title:'ğŸ“… ë¯¸íŒ… ìƒì„¸',body:h,footer:footer,width:'600px'}));UI.showModal('mv');
}

function saveMeetingNotes(mid){
  var notes=document.getElementById('mt_notes');if(!notes)return;
  sb.from('meetings').update({notes:notes.value,updated_at:new Date().toISOString()}).eq('id',mid).then(function(r){
    if(r.error){UI.toast('ì €ì¥ ì‹¤íŒ¨','err');return;}
    var m=S.meetings.find(function(x){return x.id===mid;});if(m)m.notes=notes.value;
    UI.toast('ë…¸íŠ¸ ì €ì¥!','ok');
  });
}

function addMeetingAction(mid){
  var inp=document.getElementById('mt_new_action');if(!inp||!inp.value.trim())return;
  var m=S.meetings.find(function(x){return x.id===mid;});if(!m)return;
  var actions=(m.action_items||[]).concat([{text:inp.value.trim(),done:false}]);
  sb.from('meetings').update({action_items:actions}).eq('id',mid).then(function(r){
    if(r.error){UI.toast('ì‹¤íŒ¨','err');return;}
    m.action_items=actions;closeModal('mv');viewMeeting(mid);
  });
}

function toggleMeetingAction(mid,idx){
  var m=S.meetings.find(function(x){return x.id===mid;});if(!m)return;
  var actions=JSON.parse(JSON.stringify(m.action_items||[]));
  if(actions[idx])actions[idx].done=!actions[idx].done;
  sb.from('meetings').update({action_items:actions}).eq('id',mid).then(function(r){
    if(!r.error)m.action_items=actions;
  });
}

function setMeetingStatus(mid,status){
  sb.from('meetings').update({status:status,updated_at:new Date().toISOString()}).eq('id',mid).then(function(r){
    if(r.error){UI.toast('ì‹¤íŒ¨','err');return;}
    closeModal('mv');loadMeetings().then(function(){render();UI.toast('ìƒíƒœ ë³€ê²½!','ok');});
  });
}

function completeMeeting(mid){
  var notes=document.getElementById('mt_notes');
  var upd={status:'completed',updated_at:new Date().toISOString()};
  if(notes)upd.notes=notes.value;
  sb.from('meetings').update(upd).eq('id',mid).then(function(r){
    if(r.error){UI.toast('ì‹¤íŒ¨','err');return;}
    closeModal('mv');loadMeetings().then(function(){render();UI.toast('ë¯¸íŒ… ì™„ë£Œ!','ok');});
    pushNotif('meeting','ë¯¸íŒ… ì™„ë£Œ','','meetings',null,true);
  });
}

function getMeetingPrep(mid){
  var m=S.meetings.find(function(x){return x.id===mid;});if(!m){UI.toast('ë¯¸íŒ… ì—†ìŒ','warn');return;}
  var buyer=m.buyer_id?S.buyers.find(function(b){return b.id===m.buyer_id;}):null;
  var product=S.products.length?S.products[0]:null;
  UI.toast('AI ë¸Œë¦¬í•‘ ìƒì„± ì¤‘...','info');
  fetch(RELAY_URL+'/api/whistle/meeting-prep',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
    meeting:m,buyer:buyer,product:product,company:S.company
  })}).then(function(r){return r.json();}).then(function(j){
    if(j.error){UI.toast('ì‹¤íŒ¨: '+j.error,'err');return;}
    sb.from('meetings').update({ai_briefing:j.briefing}).eq('id',mid).then(function(){
      var mm=S.meetings.find(function(x){return x.id===mid;});if(mm)mm.ai_briefing=j.briefing;
      closeModal('mv');closeModal('mm');viewMeeting(mid);
      UI.toast('AI ë¸Œë¦¬í•‘ ì™„ë£Œ!','ok');
    });
  }).catch(function(e){UI.toast('ì„œë²„ ì˜¤ë¥˜','err');});
}

/* === ALIBABA === */
function pgAlibaba(){
  if(S.user&&S.user.plan!=='alibaba'){return '<div class="card"><div class="card-b" style="text-align:center;padding:40px"><div style="font-size:48px;margin-bottom:12px">ğŸª</div><h3>ì•Œë¦¬ë°”ë°” ëª°ëŒ€í–‰ ì„œë¹„ìŠ¤</h3><p style="color:var(--w40);margin:8px 0 16px">ì•Œë¦¬ë°”ë°” í”Œëœ êµ¬ë… ì‹œ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤</p><button class="btn btn-pri" onclick="App.nav(\'settings\')">í”Œëœ ë³€ê²½ â†’</button></div></div>';}
  var stores=S.alibabaStores;var inqs=S.alibabaInquiries;
  var newInqs=inqs.filter(function(i){return i.status==='new';}).length;
  var repliedInqs=inqs.filter(function(i){return i.status==='replied';}).length;
  var convertedInqs=inqs.filter(function(i){return i.status==='converted';}).length;
  var h='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:8px"><div><h2 style="font-size:18px;font-weight:800">ğŸª ì•Œë¦¬ë°”ë°” ëª°ëŒ€í–‰</h2><p style="font-size:13px;color:var(--w40);margin-top:2px">ì•Œë¦¬ë°”ë°” ìŠ¤í† ì–´ ê´€ë¦¬, ë¬¸ì˜ ì‘ëŒ€, ë°”ì´ì–´ ì „í™˜</p></div><button class="btn btn-pri" onclick="App.showAlibabaStoreForm()">+ ìŠ¤í† ì–´ ë“±ë¡</button></div>';
  h+='<div class="grid-4" style="margin-bottom:16px">'+UI.stat('ìŠ¤í† ì–´',stores.length+'ê°œ','ë“±ë¡','var(--pri)')+UI.stat('ìƒˆ ë¬¸ì˜',newInqs+'ê±´','ì‘ëŒ€ í•„ìš”','var(--err)')+UI.stat('ì‘ë‹µ ì™„ë£Œ',repliedInqs+'ê±´','','var(--acc)')+UI.stat('ë°”ì´ì–´ ì „í™˜',convertedInqs+'ê±´','','var(--ok)')+'</div>';
  /* ìŠ¤í† ì–´ ëª©ë¡ */
  if(stores.length>0){
    h+='<div class="card" style="margin-bottom:16px"><div class="card-h">ğŸª ë‚´ ìŠ¤í† ì–´</div><div class="card-b" style="padding:8px">';
    stores.forEach(function(st){
      var stColor2={setup:'var(--w40)',active:'var(--ok)',paused:'var(--acc)',suspended:'var(--err)'}[st.status]||'var(--w40)';
      h+='<div style="padding:12px;border-radius:10px;background:var(--w08);margin-bottom:6px;display:flex;align-items:center;gap:12px">';
      h+='<div style="width:8px;height:8px;border-radius:4px;background:'+stColor2+'"></div>';
      h+='<div style="flex:1"><div style="font-weight:700;font-size:14px">'+(st.store_name||'ë¯¸ì„¤ì •')+'</div><div style="font-size:11px;color:var(--w40)">ìƒí’ˆ '+(st.products_listed||0)+'ê°œ Â· ì›” ì¡°íšŒ '+(st.monthly_views||0)+'íšŒ Â· ë¬¸ì˜ '+(st.monthly_inquiries||0)+'ê±´</div></div>';
      if(st.store_url)h+='<a href="'+st.store_url+'" target="_blank" class="btn btn-ghost btn-sm">ë°©ë¬¸</a>';
      h+='</div>';
    });
    h+='</div></div>';
  }
  /* ë¬¸ì˜ ê´€ë¦¬ */
  h+='<div class="card" style="margin-bottom:16px"><div class="card-h"><span>ğŸ’¬ ë¬¸ì˜ ê´€ë¦¬</span><button class="btn btn-ghost btn-sm" onclick="App.showAlibabaInquiryForm()">+ ë¬¸ì˜ ë“±ë¡</button></div><div class="card-b" style="padding:'+(inqs.length?'8px':'0')+'">';
  if(inqs.length===0){h+=UI.empty('ğŸ’¬','ë¬¸ì˜ê°€ ì—†ìŠµë‹ˆë‹¤','ì•Œë¦¬ë°”ë°”ì—ì„œ ë°›ì€ ë¬¸ì˜ë¥¼ ë“±ë¡í•˜ì„¸ìš”');}
  else{
    var inqStLabel={new:'ğŸ”´ ì‹ ê·œ',replied:'ğŸŸ¡ ì‘ë‹µ',qualified:'ğŸŸ¢ ìœ ë§',sample_sent:'ğŸ“¦ ìƒ˜í”Œ',negotiating:'ğŸ’¬ í˜‘ìƒ',converted:'âœ… ì „í™˜',lost:'â›” ì‹¤íŒ¨',spam:'ğŸš« ìŠ¤íŒ¸'};
    var inqStColor={new:'var(--err)',replied:'var(--acc)',qualified:'var(--ok)',sample_sent:'var(--pri)',negotiating:'var(--purple)',converted:'var(--ok)',lost:'var(--w40)',spam:'var(--w40)'};
    inqs.slice(0,20).forEach(function(iq){
      h+='<div style="padding:10px;border-radius:10px;background:var(--w08);margin-bottom:6px;border-left:4px solid '+inqStColor[iq.status]+';cursor:pointer" onclick="App.viewAlibabaInquiry(\''+iq.id+'\')">';
      h+='<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:6px">';
      h+='<div><div style="font-weight:700;font-size:13px">'+(iq.buyer_company||iq.buyer_name||'Unknown')+'</div><div style="font-size:11px;color:var(--w40)">'+(iq.buyer_country||'')+' Â· '+(iq.product_interest?U.tr(iq.product_interest,30):'')+' Â· '+U.fd(iq.created_at,'rel')+'</div></div>';
      h+='<span style="font-size:10px;padding:3px 8px;border-radius:8px;background:rgba(0,0,0,.1);color:'+inqStColor[iq.status]+'">'+(inqStLabel[iq.status]||iq.status)+'</span>';
      h+='</div></div>';
    });
  }
  h+='</div></div>';
  /* í”Œë¡œìš° ì•ˆë‚´ */
  h+='<div class="card"><div class="card-h">ğŸ”„ ì•Œë¦¬ë°”ë°” â†’ ìˆ˜ì¶œ í”Œë¡œìš°</div><div class="card-b">';
  var steps=['ë¬¸ì˜ ìˆ˜ì‹ ','AI ì‘ë‹µ','ìœ ë§ ì„ ë³„','ë°”ì´ì–´ ì „í™˜','ë¯¸íŒ… ì œì•ˆ','PI ë°œí–‰','ì£¼ë¬¸ í™•ì •','ì„ ì /ë°°ì†¡'];
  h+='<div style="display:flex;gap:0;flex-wrap:wrap">';
  steps.forEach(function(st,i){
    h+='<div style="text-align:center;padding:8px 4px;flex:1;min-width:70px"><div style="width:24px;height:24px;border-radius:12px;background:var(--pri-g);color:var(--bg);display:inline-flex;align-items:center;justify-content:center;font-size:11px;font-weight:800">'+(i+1)+'</div><div style="font-size:10px;margin-top:4px;color:var(--w60)">'+st+'</div></div>';
    if(i<steps.length-1)h+='<div style="display:flex;align-items:center;margin-top:-6px"><span style="color:var(--w20)">â†’</span></div>';
  });
  h+='</div></div></div>';
  return h;
}

function showAlibabaStoreForm(){
  var body='<form id="asf">'+
    UI.inp('store_name','ìŠ¤í† ì–´ëª…',{placeholder:'ì•Œë¦¬ë°”ë°” ìŠ¤í† ì–´ ì´ë¦„'})+
    UI.inp('store_url','ìŠ¤í† ì–´ URL',{placeholder:'https://korean-store.en.alibaba.com'})+
    UI.inp('store_id','ìŠ¤í† ì–´ ID',{placeholder:'ì•Œë¦¬ë°”ë°” ìŠ¤í† ì–´ ID (ì„ íƒ)'})+
    '<div class="grid-2">'+UI.inp('products_listed','ë“±ë¡ ìƒí’ˆ ìˆ˜',{type:'number',value:'0'})+UI.inp('monthly_views','ì›”ê°„ ì¡°íšŒìˆ˜',{type:'number',value:'0'})+'</div>'+
  '</form>';
  document.body.insertAdjacentHTML('beforeend',UI.modal({id:'asm',title:'ğŸª ì•Œë¦¬ë°”ë°” ìŠ¤í† ì–´ ë“±ë¡',body:body,footer:'<button class="btn btn-ghost" onclick="App.closeModal(\'asm\')">ì·¨ì†Œ</button><button class="btn btn-pri" onclick="App.saveAlibabaStore()">ë“±ë¡</button>',width:'480px'}));UI.showModal('asm');
}

function saveAlibabaStore(){
  var d=UI.fd('#asf');if(!d.store_name){UI.toast('ìŠ¤í† ì–´ëª… í•„ìˆ˜','warn');return;}
  var data={user_id:S.user.id,store_name:d.store_name,store_url:d.store_url||null,store_id:d.store_id||null,
    products_listed:parseInt(d.products_listed)||0,monthly_views:parseInt(d.monthly_views)||0,status:'active'};
  sb.from('alibaba_stores').insert(data).then(function(r){
    if(r.error){UI.toast('ì‹¤íŒ¨: '+r.error.message,'err');return;}
    closeModal('asm');loadAlibabaStores().then(function(){render();UI.toast('ìŠ¤í† ì–´ ë“±ë¡!','ok');});
  });
}

function showAlibabaInquiryForm(){
  var storeOpts=S.alibabaStores.map(function(s){return {value:s.id,label:s.store_name};});
  storeOpts.unshift({value:'',label:'-- ìŠ¤í† ì–´ ì„ íƒ --'});
  var body='<form id="aif">'+
    UI.sel('store_id','ìŠ¤í† ì–´',storeOpts)+
    '<div class="grid-2">'+UI.inp('buyer_name','ë°”ì´ì–´ëª…',{placeholder:'ë‹´ë‹¹ì'})+UI.inp('buyer_company','íšŒì‚¬ëª…',{placeholder:'íšŒì‚¬'})+'</div>'+
    '<div class="grid-3">'+UI.inp('buyer_country','êµ­ê°€',{placeholder:'US, JP, AE...'})+UI.inp('buyer_email','ì´ë©”ì¼',{placeholder:'ì´ë©”ì¼'})+UI.inp('quantity_requested','ìˆ˜ëŸ‰',{placeholder:'MOQ/ìˆ˜ëŸ‰'})+'</div>'+
    UI.inp('product_interest','ê´€ì‹¬ ì œí’ˆ',{placeholder:'ì–´ë–¤ ì œí’ˆì— ê´€ì‹¬?'})+
    UI.ta('message','ë¬¸ì˜ ë‚´ìš©',{rows:3,placeholder:'ë°”ì´ì–´ ë©”ì‹œì§€ ì›ë¬¸'})+
  '</form>';
  document.body.insertAdjacentHTML('beforeend',UI.modal({id:'aim',title:'ğŸ’¬ ì•Œë¦¬ë°”ë°” ë¬¸ì˜ ë“±ë¡',body:body,footer:'<button class="btn btn-ghost" onclick="App.closeModal(\'aim\')">ì·¨ì†Œ</button><button class="btn btn-pri" onclick="App.saveAlibabaInquiry()">ë“±ë¡</button>',width:'560px'}));UI.showModal('aim');
}

function saveAlibabaInquiry(){
  var d=UI.fd('#aif');if(!d.buyer_company&&!d.buyer_name){UI.toast('ë°”ì´ì–´ ì •ë³´ í•„ìˆ˜','warn');return;}
  var data={user_id:S.user.id,store_id:d.store_id||null,buyer_name:d.buyer_name||null,buyer_company:d.buyer_company||null,
    buyer_country:d.buyer_country||null,buyer_email:d.buyer_email||null,quantity_requested:d.quantity_requested||null,
    product_interest:d.product_interest||null,message:d.message||null};
  sb.from('alibaba_inquiries').insert(data).then(function(r){
    if(r.error){UI.toast('ì‹¤íŒ¨','err');return;}
    closeModal('aim');loadAlibabaInquiries().then(function(){render();UI.toast('ë¬¸ì˜ ë“±ë¡!','ok');});
    pushNotif('alibaba','ìƒˆ ì•Œë¦¬ë°”ë°” ë¬¸ì˜: '+(d.buyer_company||d.buyer_name),(d.product_interest||'').substring(0,40),'alibaba',null,true);
  });
}

function viewAlibabaInquiry(iqId){
  var iq=S.alibabaInquiries.find(function(x){return x.id===iqId;});if(!iq)return;
  var inqStLabel={new:'ì‹ ê·œ',replied:'ì‘ë‹µì™„ë£Œ',qualified:'ìœ ë§',sample_sent:'ìƒ˜í”Œë°œì†¡',negotiating:'í˜‘ìƒì¤‘',converted:'ì „í™˜',lost:'ì‹¤íŒ¨',spam:'ìŠ¤íŒ¸'};
  var h='<div style="margin-bottom:12px">';
  h+='<div style="font-size:16px;font-weight:800;margin-bottom:4px">'+(iq.buyer_company||iq.buyer_name||'Unknown')+'</div>';
  h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:13px;color:var(--w60)">';
  if(iq.buyer_name)h+='<div>ğŸ‘¤ '+iq.buyer_name+'</div>';
  if(iq.buyer_country)h+='<div>ğŸŒ '+iq.buyer_country+'</div>';
  if(iq.buyer_email)h+='<div>âœ‰ï¸ '+iq.buyer_email+'</div>';
  if(iq.quantity_requested)h+='<div>ğŸ“¦ '+iq.quantity_requested+'</div>';
  h+='</div></div>';
  if(iq.product_interest)h+='<div style="margin-bottom:10px"><div style="font-size:12px;font-weight:700;margin-bottom:4px">ê´€ì‹¬ ì œí’ˆ</div><div style="font-size:13px;color:var(--w70)">'+iq.product_interest+'</div></div>';
  if(iq.message)h+='<div style="margin-bottom:10px;padding:10px;border-radius:8px;background:var(--w08)"><div style="font-size:12px;font-weight:700;margin-bottom:4px">ì›ë¬¸ ë©”ì‹œì§€</div><div style="font-size:13px;color:var(--w70);white-space:pre-wrap">'+iq.message+'</div></div>';
  /* AI ì‘ë‹µ ì´ˆì•ˆ */
  if(iq.reply_draft)h+='<div style="margin-bottom:10px;padding:10px;border-radius:8px;background:rgba(0,212,255,.05);border:1px solid rgba(0,212,255,.15)"><div style="font-size:12px;font-weight:700;color:var(--pri);margin-bottom:4px">ğŸ¤– AI ì‘ë‹µ ì´ˆì•ˆ</div><div style="font-size:13px;color:var(--w70);white-space:pre-wrap">'+iq.reply_draft+'</div></div>';
  /* ìƒíƒœ ë³€ê²½ */
  h+='<div style="margin-bottom:10px"><div style="font-size:12px;font-weight:700;margin-bottom:6px">ìƒíƒœ</div><div style="display:flex;gap:4px;flex-wrap:wrap">';
  ['new','replied','qualified','sample_sent','negotiating','converted','lost','spam'].forEach(function(st){
    h+='<button class="btn btn-sm '+(iq.status===st?'btn-pri':'btn-ghost')+'" style="font-size:11px" onclick="App.setAlibabaInquiryStatus(\''+iqId+'\',\''+st+'\')">'+inqStLabel[st]+'</button>';
  });
  h+='</div></div>';
  var footer='<div style="display:flex;gap:6px;flex-wrap:wrap">';
  footer+='<button class="btn btn-ghost" onclick="App.closeModal(\'aiv\')">ë‹«ê¸°</button>';
  footer+='<button class="btn btn-acc btn-sm" onclick="App.getAlibabaReply(\''+iqId+'\')">ğŸ¤– AI ì‘ë‹µ ìƒì„±</button>';
  if(iq.status!=='converted'&&iq.status!=='lost'&&iq.status!=='spam')footer+='<button class="btn btn-ok btn-sm" onclick="App.convertInquiryToBuyer(\''+iqId+'\')">ğŸ¤ ë°”ì´ì–´ ì „í™˜</button>';
  footer+='</div>';
  document.body.insertAdjacentHTML('beforeend',UI.modal({id:'aiv',title:'ğŸ’¬ ë¬¸ì˜ ìƒì„¸',body:h,footer:footer,width:'560px'}));UI.showModal('aiv');
}

function setAlibabaInquiryStatus(iqId,status){
  sb.from('alibaba_inquiries').update({status:status,updated_at:new Date().toISOString()}).eq('id',iqId).then(function(r){
    if(r.error){UI.toast('ì‹¤íŒ¨','err');return;}
    var iq=S.alibabaInquiries.find(function(x){return x.id===iqId;});if(iq)iq.status=status;
    closeModal('aiv');viewAlibabaInquiry(iqId);UI.toast('ìƒíƒœ ë³€ê²½!','ok');
  });
}

function getAlibabaReply(iqId){
  var iq=S.alibabaInquiries.find(function(x){return x.id===iqId;});if(!iq)return;
  var product=S.products.length?S.products[0]:null;
  UI.toast('AI ì‘ë‹µ ìƒì„± ì¤‘...','info');
  fetch(RELAY_URL+'/api/whistle/alibaba-reply',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
    inquiry:iq,product:product,company:S.company
  })}).then(function(r){return r.json();}).then(function(j){
    if(j.error){UI.toast('ì‹¤íŒ¨: '+j.error,'err');return;}
    sb.from('alibaba_inquiries').update({reply_draft:j.reply,status:iq.status==='new'?'replied':iq.status}).eq('id',iqId).then(function(){
      var i2=S.alibabaInquiries.find(function(x){return x.id===iqId;});if(i2){i2.reply_draft=j.reply;if(i2.status==='new')i2.status='replied';}
      closeModal('aiv');viewAlibabaInquiry(iqId);UI.toast('AI ì‘ë‹µ ìƒì„± ì™„ë£Œ!','ok');
    });
  }).catch(function(e){UI.toast('ì„œë²„ ì˜¤ë¥˜','err');});
}

function convertInquiryToBuyer(iqId){
  var iq=S.alibabaInquiries.find(function(x){return x.id===iqId;});if(!iq)return;
  if(!confirm((iq.buyer_company||iq.buyer_name)+'ë¥¼ ë°”ì´ì–´ë¡œ ì „í™˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
  var buyerData={registered_by:S.user.id,source:'alibaba',company_name:iq.buyer_company||iq.buyer_name||'Alibaba Buyer',
    contact_name:iq.buyer_name||null,email:iq.buyer_email||null,country:iq.buyer_country||null,
    categories:S.products.length?[S.products[0].category]:[],notes:'ì•Œë¦¬ë°”ë°” ë¬¸ì˜ì—ì„œ ì „í™˜. ê´€ì‹¬ì œí’ˆ: '+(iq.product_interest||'N/A')};
  sb.from('buyers').insert(buyerData).select().then(function(r){
    if(r.error){UI.toast('ë°”ì´ì–´ ë“±ë¡ ì‹¤íŒ¨: '+r.error.message,'err');return;}
    var newBuyer=r.data&&r.data[0];
    var upd={status:'converted',converted_to_buyer_id:newBuyer?newBuyer.id:null,updated_at:new Date().toISOString()};
    sb.from('alibaba_inquiries').update(upd).eq('id',iqId).then(function(){
      var i2=S.alibabaInquiries.find(function(x){return x.id===iqId;});if(i2){i2.status='converted';i2.converted_to_buyer_id=newBuyer?newBuyer.id:null;}
      closeModal('aiv');
      Promise.all([loadB(),loadAlibabaInquiries()]).then(function(){render();
        UI.toast('ë°”ì´ì–´ ì „í™˜ ì™„ë£Œ!','ok');
        pushNotif('alibaba','ì•Œë¦¬ë°”ë°” â†’ ë°”ì´ì–´ ì „í™˜: '+(iq.buyer_company||iq.buyer_name),'ë°”ì´ì–´ ê´€ë¦¬ì—ì„œ í™•ì¸í•˜ì„¸ìš”','buyers',null,true);
      });
    });
  });
}

/* === SAMPLES (in buyers page) === */
function showSampleForm(buyerId){
  var buyer=S.buyers.find(function(b){return b.id===buyerId;});if(!buyer)return;
  var prodOpts=S.products.map(function(p){return {value:p.id,label:p.name_ko||p.name_en};});
  prodOpts.unshift({value:'',label:'-- ì œí’ˆ ì„ íƒ --'});
  var pjOpts=S.projects.map(function(p){return {value:p.id,label:p.name};});
  pjOpts.unshift({value:'',label:'-- í”„ë¡œì íŠ¸ --'});
  var body='<form id="sf"><div style="margin-bottom:10px;padding:10px;border-radius:8px;background:var(--w08)"><strong>ë°”ì´ì–´:</strong> '+buyer.company_name+' ('+(buyer.country||'')+')</div>'+
    '<div class="grid-2">'+UI.sel('product_id','ì œí’ˆ',prodOpts)+UI.sel('project_id','í”„ë¡œì íŠ¸',pjOpts)+'</div>'+
    '<div class="grid-3">'+UI.inp('quantity','ìˆ˜ëŸ‰',{type:'number',value:'1'})+UI.sel('shipping_method','ë°°ì†¡ë°©ë²•',[{value:'ems',label:'EMS'},{value:'dhl',label:'DHL'},{value:'fedex',label:'FedEx'},{value:'ups',label:'UPS'},{value:'k_packet',label:'K-Packet'},{value:'other',label:'ê¸°íƒ€'}])+UI.inp('shipping_cost','ë°°ì†¡ë¹„(USD)',{type:'number',step:'0.01',value:'0'})+'</div>'+
    UI.inp('sample_cost','ìƒ˜í”Œ ì›ê°€(USD)',{type:'number',step:'0.01',value:'0'})+
    UI.ta('notes','ë©”ëª¨',{rows:2,placeholder:'ìƒ˜í”Œ êµ¬ì„±, íŠ¹ì´ì‚¬í•­ ë“±'})+
  '</form>';
  document.body.insertAdjacentHTML('beforeend',UI.modal({id:'spm',title:'ğŸ“¦ ìƒ˜í”Œ ë°œì†¡ â€” '+buyer.company_name,body:body,footer:'<button class="btn btn-ghost" onclick="App.closeModal(\'spm\')">ì·¨ì†Œ</button><button class="btn btn-pri" onclick="App.saveSample(\''+buyerId+'\')">ë“±ë¡</button>',width:'500px'}));UI.showModal('spm');
}

function saveSample(buyerId){
  var d=UI.fd('#sf');
  var data={user_id:S.user.id,buyer_id:buyerId,product_id:d.product_id||null,project_id:d.project_id||null,
    quantity:parseInt(d.quantity)||1,shipping_method:d.shipping_method||null,
    shipping_cost:parseFloat(d.shipping_cost)||0,sample_cost:parseFloat(d.sample_cost)||0,notes:d.notes||null};
  sb.from('samples').insert(data).then(function(r){
    if(r.error){UI.toast('ì‹¤íŒ¨','err');return;}
    closeModal('spm');loadSamples().then(function(){render();UI.toast('ìƒ˜í”Œ ë“±ë¡!','ok');});
    pushNotif('sample','ìƒ˜í”Œ ë°œì†¡ ë“±ë¡',(S.buyers.find(function(b){return b.id===buyerId;})||{}).company_name||'','buyers',null,true);
  });
}

function updateSampleStatus(sampleId,status){
  var upd={status:status,updated_at:new Date().toISOString()};
  if(status==='shipped')upd.shipped_at=new Date().toISOString();
  if(status==='delivered')upd.delivered_at=new Date().toISOString();
  sb.from('samples').update(upd).eq('id',sampleId).then(function(r){
    if(r.error){UI.toast('ì‹¤íŒ¨','err');return;}
    loadSamples().then(function(){render();UI.toast('ìƒíƒœ ë³€ê²½!','ok');});
  });
}

function updateSampleTracking(sampleId){
  var val=prompt('ìš´ì†¡ì¥ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');if(!val)return;
  sb.from('samples').update({tracking_number:val,status:'shipped',shipped_at:new Date().toISOString()}).eq('id',sampleId).then(function(r){
    if(r.error){UI.toast('ì‹¤íŒ¨','err');return;}
    loadSamples().then(function(){render();UI.toast('ìš´ì†¡ì¥ ë“±ë¡!','ok');});
  });
}

/* === SHIPMENT FORM === */
function showShipmentForm(orderId){
  var o=S.orders.find(function(x){return x.id===orderId;});if(!o)return;
  var body='<form id="shf">'+
    '<div class="grid-2">'+UI.sel('type','ìš´ì†¡ë°©ì‹',[{value:'ocean',label:'ğŸš¢ í•´ìƒ'},{value:'air',label:'âœˆï¸ í•­ê³µ'},{value:'express',label:'ğŸ“¦ íŠ¹ê¸‰'},{value:'rail',label:'ğŸš‚ ì² ë„'}])+
    UI.inp('bl_number','B/L ë˜ëŠ” AWB',{placeholder:'ìš´ì†¡ì¥ ë²ˆí˜¸'})+'</div>'+
    '<div class="grid-2">'+UI.inp('vessel_name','ì„ ë°•/í•­ê³µí¸ëª…',{placeholder:'ì„ íƒ'})+UI.inp('container_number','ì»¨í…Œì´ë„ˆë²ˆí˜¸',{placeholder:'ì„ íƒ'})+'</div>'+
    '<div class="grid-2">'+UI.inp('port_of_loading','ì¶œë°œí•­',{value:'Busan, KR'})+UI.inp('port_of_discharge','ë„ì°©í•­',{placeholder:'Los Angeles, US'})+'</div>'+
    '<div class="grid-2">'+UI.inp('etd','ì¶œë°œì˜ˆì •(ETD)',{type:'date'})+UI.inp('eta','ë„ì°©ì˜ˆì •(ETA)',{type:'date'})+'</div>'+
    '<div class="grid-2">'+UI.inp('forwarder_name','í¬ì›Œë”ëª…',{placeholder:'í¬ì›Œë” íšŒì‚¬ëª…'})+UI.inp('forwarder_contact','í¬ì›Œë” ì—°ë½ì²˜',{placeholder:'ì „í™”/ì´ë©”ì¼'})+'</div>'+
    UI.inp('freight_cost','ìš´ì„(USD)',{type:'number',step:'0.01'})+
  '</form>';
  document.body.insertAdjacentHTML('beforeend',UI.modal({id:'shm',title:'ğŸš¢ ì„ ì  ë“±ë¡ â€” '+o.order_number,body:body,footer:'<button class="btn btn-ghost" onclick="App.closeModal(\'shm\')">ì·¨ì†Œ</button><button class="btn btn-pri" onclick="App.saveShipment(\''+orderId+'\')">ë“±ë¡</button>',width:'520px'}));UI.showModal('shm');
}

function saveShipment(orderId){
  var d=UI.fd('#shf');
  var data={order_id:orderId,user_id:S.user.id,type:d.type||'ocean',bl_number:d.bl_number||null,
    vessel_name:d.vessel_name||null,container_number:d.container_number||null,
    port_of_loading:d.port_of_loading||'Busan, KR',port_of_discharge:d.port_of_discharge||null,
    etd:d.etd||null,eta:d.eta||null,forwarder_name:d.forwarder_name||null,
    forwarder_contact:d.forwarder_contact||null,freight_cost:parseFloat(d.freight_cost)||null};
  sb.from('shipments').insert(data).then(function(r){
    if(r.error){UI.toast('ì‹¤íŒ¨: '+r.error.message,'err');return;}
    closeModal('shm');closeModal('od');loadShipments().then(function(){viewOrder(orderId);UI.toast('ì„ ì  ë“±ë¡!','ok');});
    pushNotif('shipment','ì„ ì  ë“±ë¡',(d.port_of_loading||'')+' â†’ '+(d.port_of_discharge||''),'orders',null,true);
  });
}

function setMilestonePaid(msId){
  sb.from('payment_milestones').update({status:'paid',paid_at:new Date().toISOString()}).eq('id',msId).then(function(r){
    if(r.error){UI.toast('ì‹¤íŒ¨','err');return;}
    loadMilestones().then(function(){render();UI.toast('ê²°ì œ ì™„ë£Œ!','ok');});
    pushNotif('payment','ê²°ì œ ë§ˆì¼ìŠ¤í†¤ ì™„ë‚©','','orders',null,true);
  });
}

/* === PI â†’ ORDER CONVERSION === */
function convertPItoOrder(docId){
  var doc=null;
  sb.from('documents').select('*').eq('id',docId).single().then(function(r){
    if(r.error||!r.data){UI.toast('ì„œë¥˜ ì—†ìŒ','err');return;}
    doc=r.data;if(doc.doc_type&&doc.doc_type!=='pi'){UI.toast('PI ì„œë¥˜ë§Œ ì£¼ë¬¸ìœ¼ë¡œ ì „í™˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤','warn');return;}
    var c=doc.data||doc.content||{};
    if(!confirm('ì´ PIë¥¼ ì£¼ë¬¸ìœ¼ë¡œ ì „í™˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n'+c.doc_number+' / $'+(c.total||0).toLocaleString()))return;
    var orderNum='WO-'+new Date().getFullYear()+'-'+String(Date.now()).slice(-6);
    var items=c.items||[];
    var data={user_id:S.user.id,buyer_id:doc.buyer_id||null,project_id:doc.project_id||null,
      order_number:orderNum,items:items,total_amount:parseFloat(c.total)||0,
      payment_terms:c.payment_terms||'T/T 30% deposit',incoterms:c.incoterms||'FOB',
      notes:[{text:'PI #'+c.doc_number+'ì—ì„œ ì „í™˜',date:new Date().toISOString()}]};
    sb.from('orders').insert(data).select().then(function(or){
      if(or.error){UI.toast('ì£¼ë¬¸ ìƒì„± ì‹¤íŒ¨: '+or.error.message,'err');return;}
      var newOrder=or.data&&or.data[0];
      /* ê²°ì œ ë§ˆì¼ìŠ¤í†¤ ìë™ ìƒì„± */
      if(newOrder&&data.payment_terms){
        var milestones=[];var total=parseFloat(data.total_amount)||0;
        if(data.payment_terms.indexOf('30%')!==-1){
          milestones.push({order_id:newOrder.id,user_id:S.user.id,name:'deposit',percentage:30,amount:Math.round(total*0.3*100)/100,currency:'USD',status:'pending'});
          milestones.push({order_id:newOrder.id,user_id:S.user.id,name:'pre_shipment',percentage:70,amount:Math.round(total*0.7*100)/100,currency:'USD',status:'pending'});
        }else if(data.payment_terms.indexOf('50%')!==-1){
          milestones.push({order_id:newOrder.id,user_id:S.user.id,name:'deposit',percentage:50,amount:Math.round(total*0.5*100)/100,currency:'USD',status:'pending'});
          milestones.push({order_id:newOrder.id,user_id:S.user.id,name:'pre_shipment',percentage:50,amount:Math.round(total*0.5*100)/100,currency:'USD',status:'pending'});
        }else if(data.payment_terms.indexOf('100%')!==-1){
          milestones.push({order_id:newOrder.id,user_id:S.user.id,name:'deposit',percentage:100,amount:total,currency:'USD',status:'pending'});
        }else if(data.payment_terms.toLowerCase().indexOf('l/c')!==-1){
          milestones.push({order_id:newOrder.id,user_id:S.user.id,name:'lc_opening',percentage:100,amount:total,currency:'USD',status:'pending'});
        }
        if(milestones.length>0)sb.from('payment_milestones').insert(milestones).then(function(){loadMilestones();});
      }
      loadOrders().then(function(){render();UI.toast('PI â†’ ì£¼ë¬¸ ì „í™˜ ì™„ë£Œ!','ok');nav('orders');});
      pushNotif('order','PIâ†’ì£¼ë¬¸ ì „í™˜: '+orderNum,'$'+total.toLocaleString(),'orders',null,true);
    });
  });
}

/* === VOUCHER REPORT === */
function pgVoucherReport(){
  var now=new Date();var mm=now.getMonth(),yy=now.getFullYear();
  var mAna=S.analyses.filter(function(a){var d=new Date(a.created_at);return d.getMonth()===mm&&d.getFullYear()===yy;}).length;
  var mProd=S.products.length;
  var mPj=S.projects.length;
  var mSR=S.serviceRequests.filter(function(s){var d=new Date(s.created_at);return d.getMonth()===mm&&d.getFullYear()===yy;}).length;
  var pjPct=0;if(S.projects.length){var total=0;S.projects.forEach(function(p){var stages=['planning','certification','buyer_search','negotiation','production','shipping','completed'];var idx=stages.indexOf(p.status||'planning');total+=Math.round((idx+1)/stages.length*100);});pjPct=Math.round(total/S.projects.length);}

  return '<div style="margin-bottom:20px"><h2 style="font-size:18px;font-weight:800">ğŸ›ï¸ ë°”ìš°ì²˜ ì„±ê³¼ë³´ê³ ì„œ</h2><p style="font-size:13px;color:var(--w40);margin-top:4px">ìˆ˜ì¶œë°”ìš°ì²˜ Â· ì œì¡°í˜ì‹ ë°”ìš°ì²˜ ì„±ê³¼ ì‚°ì¶œë¬¼ ìë™ ìƒì„±</p></div>'+
  '<div class="card" style="margin-bottom:16px"><div class="card-h">ğŸ“Š ì´ë²ˆ ë‹¬ ì‹¤ì  ìš”ì•½</div><div class="card-b"><div class="grid-4">'+
    UI.stat('AI ë¶„ì„',mAna+'ê±´','ì´ë²ˆ ë‹¬','var(--pri)')+
    UI.stat('ì œí’ˆ ë“±ë¡',mProd+'ê±´','ëˆ„ì ','var(--acc)')+
    UI.stat('ì„œë¹„ìŠ¤ ìš”ì²­',mSR+'ê±´','ì´ë²ˆ ë‹¬','var(--ok)')+
    UI.stat('í”„ë¡œì íŠ¸ ì§„í–‰ë¥ ',pjPct+'%','í‰ê· ','var(--purple)')+
  '</div></div></div>'+
  '<div class="card" style="margin-bottom:16px"><div class="card-h">ğŸ“‹ ì‚°ì¶œë¬¼ ëª©ë¡</div><div class="card-b">'+
    '<div style="display:flex;flex-direction:column;gap:8px">'+
    '<div style="display:flex;justify-content:space-between;padding:10px 14px;border-radius:10px;background:var(--w08)"><span style="font-size:13px">AI ìˆ˜ì¶œë¶„ì„ ë³´ê³ ì„œ ë‚©í’ˆ</span><span style="font-size:13px;font-weight:700;color:var(--pri)">'+mAna+'ê±´</span></div>'+
    '<div style="display:flex;justify-content:space-between;padding:10px 14px;border-radius:10px;background:var(--w08)"><span style="font-size:13px">ì œí’ˆ ë“±ë¡ ë° ê´€ë¦¬</span><span style="font-size:13px;font-weight:700;color:var(--acc)">'+mProd+'ê±´</span></div>'+
    '<div style="display:flex;justify-content:space-between;padding:10px 14px;border-radius:10px;background:var(--w08)"><span style="font-size:13px">ìˆ˜ì¶œ í”„ë¡œì„¸ìŠ¤ ëŒ€í–‰ ìš”ì²­</span><span style="font-size:13px;font-weight:700;color:var(--ok)">'+mSR+'ê±´</span></div>'+
    '<div style="display:flex;justify-content:space-between;padding:10px 14px;border-radius:10px;background:var(--w08)"><span style="font-size:13px">ìˆ˜ì¶œ í”„ë¡œì íŠ¸ ì§„í–‰ë¥ </span><span style="font-size:13px;font-weight:700;color:var(--purple)">'+pjPct+'%</span></div>'+
  '</div></div></div>'+
  '<div style="display:flex;gap:8px"><button class="btn btn-pri" onclick="App.genVoucherReport()">ğŸ“„ ë³´ê³ ì„œ ìƒì„± (ì¸ì‡„ìš©)</button><button class="btn btn-ghost" onclick="App.saveVoucherReport()">ğŸ’¾ DB ì €ì¥</button></div>';
}

function genVoucherReport(){
  var now=new Date();var mm=now.getMonth(),yy=now.getFullYear();
  var period=yy+'ë…„ '+(mm+1)+'ì›”';
  var c=S.company||{};
  var mAna=S.analyses.filter(function(a){var d=new Date(a.created_at);return d.getMonth()===mm&&d.getFullYear()===yy;}).length;
  var mSR=S.serviceRequests.filter(function(a){var d=new Date(a.created_at);return d.getMonth()===mm&&d.getFullYear()===yy;}).length;
  var pjPct=0;if(S.projects.length){var total=0;S.projects.forEach(function(p){var stages=['planning','certification','buyer_search','negotiation','production','shipping','completed'];var idx=stages.indexOf(p.status||'planning');total+=Math.round((idx+1)/stages.length*100);});pjPct=Math.round(total/S.projects.length);}
  var h='<html><head><meta charset="UTF-8"><title>ë°”ìš°ì²˜ ì„±ê³¼ë³´ê³ ì„œ â€” '+period+'</title><style>body{font-family:"Noto Sans KR",sans-serif;max-width:800px;margin:20px auto;color:#222;font-size:13px}table{width:100%;border-collapse:collapse;margin:16px 0}th,td{border:1px solid #bbb;padding:10px;font-size:13px}th{background:#f5f5f5;font-weight:700}.ttl{font-size:22px;font-weight:bold;text-align:center;margin:20px 0;padding:14px;background:#003366;color:white;border-radius:8px}.subtitle{font-size:16px;font-weight:700;color:#003366;margin:24px 0 10px;border-bottom:2px solid #003366;padding-bottom:6px}@media print{body{margin:0}}</style></head><body>';
  h+='<div class="ttl">ìˆ˜ì¶œë°”ìš°ì²˜ ì„±ê³¼ë³´ê³ ì„œ</div>';
  h+='<table><tr><td><b>ìˆ˜í–‰ê¸°ê´€:</b> (ì£¼)ëª¨í‹°ë¸Œì´ë…¸ë² ì´ì…˜</td><td><b>ë³´ê³  ê¸°ê°„:</b> '+period+'</td></tr><tr><td><b>ìˆ˜í˜œê¸°ì—…:</b> '+(c.name_ko||S.user.company_name||'')+'</td><td><b>ì‘ì„±ì¼:</b> '+now.toISOString().split('T')[0]+'</td></tr></table>';
  h+='<div class="subtitle">1. ì„œë¹„ìŠ¤ ìˆ˜í–‰ ì‹¤ì </div>';
  h+='<table><thead><tr><th>êµ¬ë¶„</th><th>ì‚°ì¶œë¬¼</th><th>ìˆ˜ëŸ‰</th><th>ë¹„ê³ </th></tr></thead><tbody>';
  h+='<tr><td>AI ìˆ˜ì¶œë¶„ì„</td><td>ìˆ˜ì¶œ ì í•©ë„ ë¶„ì„ ë³´ê³ ì„œ</td><td style="text-align:center;font-weight:700">'+mAna+'ê±´</td><td>AI ê¸°ë°˜ 13ê°œ ì„¹ì…˜ ë¶„ì„</td></tr>';
  h+='<tr><td>ì œí’ˆ ê´€ë¦¬</td><td>ìˆ˜ì¶œìš© ì œí’ˆ ë“±ë¡ ë° ì˜ë¬¸í™”</td><td style="text-align:center;font-weight:700">'+S.products.length+'ê±´</td><td>ì˜ë¬¸ ì¹´íƒˆë¡œê·¸ í¬í•¨</td></tr>';
  h+='<tr><td>ìˆ˜ì¶œ ëŒ€í–‰</td><td>ìˆ˜ì¶œ í”„ë¡œì„¸ìŠ¤ ëŒ€í–‰ ì„œë¹„ìŠ¤</td><td style="text-align:center;font-weight:700">'+mSR+'ê±´</td><td>ì¸ì¦/ë§¤ì¹­/ì„œë¥˜/ë¬¼ë¥˜</td></tr>';
  h+='<tr><td>í”„ë¡œì íŠ¸</td><td>ìˆ˜ì¶œ í”„ë¡œì íŠ¸ ì§„í–‰</td><td style="text-align:center;font-weight:700">'+S.projects.length+'ê±´</td><td>í‰ê·  ì§„í–‰ë¥  '+pjPct+'%</td></tr>';
  h+='</tbody></table>';
  h+='<div class="subtitle">2. ìˆ˜ì¶œ í”„ë¡œì íŠ¸ í˜„í™©</div>';
  if(S.projects.length){
    h+='<table><thead><tr><th>í”„ë¡œì íŠ¸ëª…</th><th>í˜„ì¬ ë‹¨ê³„</th><th>íƒ€ê²Ÿ ì‹œì¥</th><th>ì§„í–‰ë¥ </th></tr></thead><tbody>';
    var stL2={planning:'ê¸°íš',certification:'ì¸ì¦',buyer_search:'ë°”ì´ì–´ ë°œêµ´',negotiation:'í˜‘ìƒ',production:'ìˆ˜ì¶œìš© ìƒì‚°/ê²€ìˆ˜',shipping:'ì„ ì /í†µê´€',completed:'ì™„ë£Œ'};
    S.projects.forEach(function(p){
      var stages=['planning','certification','buyer_search','negotiation','production','shipping','completed'];
      var pp=Math.round((stages.indexOf(p.status||'planning')+1)/stages.length*100);
      h+='<tr><td>'+p.name+'</td><td>'+(stL2[p.status]||p.status)+'</td><td>'+(p.target_countries||[]).join(', ')+'</td><td style="text-align:center;font-weight:700">'+pp+'%</td></tr>';
    });
    h+='</tbody></table>';
  }else{h+='<p>ì§„í–‰ ì¤‘ì¸ í”„ë¡œì íŠ¸ ì—†ìŒ</p>';}
  h+='<div class="subtitle">3. í–¥í›„ ê³„íš</div><p>ë‹¤ìŒ ë‹¬ ì˜ˆì • ì‚¬í•­:</p><ul><li>ìˆ˜ì¶œ ë¶„ì„ ë° ì œí’ˆ ì˜ë¬¸í™” ì§€ì†</li><li>ë°”ì´ì–´ ë§¤ì¹­ ë° ê±°ë˜ í˜‘ìƒ ì§„í–‰</li><li>ì¸ì¦ ì·¨ë“ ë° ì„œë¥˜ ìë™ìƒì„± í™œìš©</li></ul>';
  h+='<div style="margin-top:60px;display:flex;justify-content:space-between"><div style="text-align:center;width:45%;border-top:1px solid #333;padding-top:10px;font-size:12px">ìˆ˜í–‰ê¸°ê´€: (ì£¼)ëª¨í‹°ë¸Œì´ë…¸ë² ì´ì…˜</div><div style="text-align:center;width:45%;border-top:1px solid #333;padding-top:10px;font-size:12px">ìˆ˜í˜œê¸°ì—…: '+(c.name_ko||'')+'</div></div>';
  h+='</body></html>';
  var w=window.open('','_blank','width=850,height=700');w.document.write(h);w.document.close();
}

function saveVoucherReport(){
  var now=new Date();var mm=now.getMonth(),yy=now.getFullYear();
  var start=new Date(yy,mm,1).toISOString().split('T')[0];
  var end=new Date(yy,mm+1,0).toISOString().split('T')[0];
  var mAna=S.analyses.filter(function(a){var d=new Date(a.created_at);return d.getMonth()===mm&&d.getFullYear()===yy;}).length;
  var mSR=S.serviceRequests.filter(function(a){var d=new Date(a.created_at);return d.getMonth()===mm&&d.getFullYear()===yy;}).length;
  sb.from('voucher_reports').insert({user_id:S.user.id,report_period_start:start,report_period_end:end,report_data:{analyses:mAna,products:S.products.length,service_requests:mSR,projects:S.projects.length},status:'draft'}).then(function(r){
    if(r.error){UI.toast('ì €ì¥ ì‹¤íŒ¨','err');return;}
    UI.toast('ë³´ê³ ì„œ ì €ì¥ ì™„ë£Œ','ok');
  });
}

/* === NAV & RENDER === */
function nav(p){S.page=p;S.currentAnalysis=null;S.currentProject=null;S.analysisStep=0;S.analysisData=null;S.docType=null;render();var pc=document.querySelector('.page-content');if(pc)pc.scrollTop=0;}
function closeModal(id){UI.hideModal(id);setTimeout(function(){var e=document.getElementById(id);if(e)e.remove();},300);}

var PL={dashboard:'ğŸ“Š ëŒ€ì‹œë³´ë“œ',analysis:'ğŸ”¬ AI ë¶„ì„',products:'ğŸ“¦ ì œí’ˆ ì¹´ë“œ',projects:'ğŸš€ í”„ë¡œì íŠ¸',orders:'ğŸ“‹ ì£¼ë¬¸ê´€ë¦¬',services:'ğŸ’¼ ì„œë¹„ìŠ¤',docgen:'ğŸ“„ ì„œë¥˜',emailhub:'âœ‰ï¸ ì´ë©”ì¼',costsim:'ğŸ§® ì›ê°€',subscription:'ğŸ’ êµ¬ë…',voucherreport:'ğŸ›ï¸ ë°”ìš°ì²˜',settings:'âš™ï¸ ì„¤ì •',buyers:'ğŸ¤ ë°”ì´ì–´',meetings:'ğŸ“… ì¼ì •ê´€ë¦¬',alibaba:'ğŸª ì•Œë¦¬ë°”ë°”'};

/* === ONBOARDING WIZARD === */
function pgOnboarding(){
  var step=S.user.onboarding_step||0;
  var steps=['íšŒì‚¬ ì •ë³´','ì²« ì œí’ˆ ë“±ë¡','AI ë¶„ì„ ì‹œì‘'];
  var bar='<div style="display:flex;gap:4px;margin-bottom:24px">'+steps.map(function(s,i){return '<div style="flex:1"><div style="height:4px;border-radius:2px;background:'+(i<step?'var(--ok)':i===step?'var(--pri)':'var(--w08)')+';margin-bottom:6px"></div><div style="font-size:10px;color:'+(i===step?'var(--pri)':'var(--w40)')+';font-weight:'+(i===step?'700':'400')+'">'+(i+1)+'. '+s+'</div></div>';}).join('')+'</div>';
  var hdr='<div style="max-width:640px;margin:0 auto"><div style="text-align:center;margin-bottom:24px"><div style="font-size:32px;margin-bottom:8px">ğŸ‘‹</div><div style="font-size:20px;font-weight:800">Whistle AIì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!</div><div style="font-size:13px;color:var(--w40);margin-top:6px">3ë‹¨ê³„ë§Œ ì™„ë£Œí•˜ë©´ ë°”ë¡œ ìˆ˜ì¶œ ë¶„ì„ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</div></div>'+bar;
  var body='';
  if(step===0){
    body='<div class="card"><div class="card-h">ğŸ¢ íšŒì‚¬ ì •ë³´</div><div class="card-b"><form id="obf0">'+
      UI.inp('name_ko','íšŒì‚¬ëª… *',{placeholder:'(ì£¼)ëª¨í‹°ë¸Œì´ë…¸ë² ì´ì…˜',required:true,value:(S.company&&S.company.name_ko)||''})+
      '<div class="grid-2">'+UI.inp('ceo_name','ëŒ€í‘œìëª…',{placeholder:'í™ê¸¸ë™',value:(S.company&&S.company.ceo_name)||''})+UI.inp('phone','ì „í™”ë²ˆí˜¸',{placeholder:'02-1234-5678',value:(S.company&&S.company.phone)||''})+'</div>'+
      UI.inp('address_ko','ì£¼ì†Œ (ì„ íƒ)',{placeholder:'ì„œìš¸ì‹œ ê°•ë‚¨êµ¬...',value:(S.company&&S.company.address_ko)||''})+
    '</form></div></div>';
  }else if(step===1){
    body='<div class="card"><div class="card-h">ğŸ“¦ ì²« ì œí’ˆ ë“±ë¡</div><div class="card-b"><form id="obf1">'+
      UI.inp('product_name','ì œí’ˆëª… *',{placeholder:'ë‹¥í„°ì§€ ë ˆë“œ ë¸”ë ˆë¯¸ì‰¬ ìˆ˜ë”©í¬ë¦¼',required:true})+
      '<div class="grid-2">'+UI.sel('category','ì¹´í…Œê³ ë¦¬',U.CAT)+UI.inp('product_url','ìƒí’ˆ URL (ì„ íƒ)',{placeholder:'https://smartstore.naver.com/...'})+'</div>'+
    '</form><div style="margin-top:8px;font-size:11px;color:var(--w40)">ì œí’ˆì€ ë‚˜ì¤‘ì— ë” ì¶”ê°€/ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</div></div></div>';
  }else{
    body='<div class="card"><div class="card-h">ğŸ”¬ AI ìˆ˜ì¶œ ë¶„ì„</div><div class="card-b" style="text-align:center;padding:32px 16px">'+
      '<div style="font-size:48px;margin-bottom:12px">ğŸš€</div>'+
      '<div style="font-size:16px;font-weight:700;margin-bottom:8px">ì¤€ë¹„ ì™„ë£Œ!</div>'+
      '<div style="font-size:13px;color:var(--w40);line-height:1.7;margin-bottom:20px">ë“±ë¡í•œ ì œí’ˆì˜ AI ìˆ˜ì¶œ ë¶„ì„ì„ ë°”ë¡œ ì‹œì‘í•˜ì„¸ìš”.<br>30ì´ˆ ì´ë‚´ì— ìˆ˜ì¶œ ì í•©ë„, íƒ€ê²Ÿ ì‹œì¥, í•„ìš” ì¸ì¦ ë“±ì„ ë¶„ì„í•©ë‹ˆë‹¤.</div>'+
      '<button class="btn btn-pri btn-lg" onclick="App.completeOnboarding(true)" style="font-size:15px;padding:14px 32px">ğŸ”¬ AI ë¶„ì„ ì‹œì‘í•˜ê¸°</button>'+
    '</div></div>';
  }
  var footer='<div style="display:flex;justify-content:space-between;margin-top:16px"><button class="btn btn-ghost btn-sm" onclick="App.skipOnboarding()">ê±´ë„ˆë›°ê¸°</button>'+(step<2?'<button class="btn btn-pri" onclick="App.nextOb('+step+')">ë‹¤ìŒ â†’</button>':'')+'</div>';
  return hdr+body+footer+'</div>';
}

function nextOb(step){
  if(step===0){
    var d=UI.fd('#obf0');if(!d.name_ko){UI.toast('íšŒì‚¬ëª…ì„ ì…ë ¥í•˜ì„¸ìš”','warn');return;}
    var companyData={user_id:S.user.id,name_ko:d.name_ko,ceo_name:d.ceo_name||null,phone:d.phone||null,address_ko:d.address_ko||null};
    if(S.company&&S.company.id){
      sb.from('companies').update(companyData).eq('id',S.company.id).then(function(){
        S.company=Object.assign(S.company||{},companyData);
        sb.from('users').update({onboarding_step:1}).eq('id',S.user.id);
        S.user.onboarding_step=1;render();
      });
    }else{
      sb.from('companies').insert(companyData).select().single().then(function(r){
        if(r.data)S.company=r.data;
        sb.from('users').update({onboarding_step:1}).eq('id',S.user.id);
        S.user.onboarding_step=1;render();
      });
    }
  }else if(step===1){
    var d=UI.fd('#obf1');if(!d.product_name){UI.toast('ì œí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”','warn');return;}
    var prod={user_id:S.user.id,name_ko:d.product_name,category:d.category||null,status:'draft'};
    sb.from('products').insert(prod).select().single().then(function(r){
      if(r.data)S.products.push(r.data);
      S._obProductUrl=d.product_url||'';
      sb.from('users').update({onboarding_step:2}).eq('id',S.user.id);
      S.user.onboarding_step=2;render();
    });
  }
}

function skipOnboarding(){
  sb.from('users').update({onboarding_completed:true}).eq('id',S.user.id);
  S.user.onboarding_completed=true;render();
}

function completeOnboarding(startAnalysis){
  sb.from('users').update({onboarding_completed:true}).eq('id',S.user.id);
  S.user.onboarding_completed=true;
  if(startAnalysis){
    var p=S.products[S.products.length-1];
    S.analysisStep=1;
    S.analysisData={urls:[S._obProductUrl||''],files:[],selling_points:[],target_markets:['US'],existing_certs:[],price_krw:'',product_name:p?p.name_ko:'',category:p?p.category:''};
    S.page='analysis';
  }
  render();
}

function renderPage(){
  if(S.user&&!S.user.onboarding_completed&&!S.company&&S.page==='dashboard')return pgOnboarding();
  switch(S.page){case'dashboard':return pgDash();case'analysis':return pgAnalysis();case'products':return pgProducts();case'projects':return pgProjects();case'services':return pgServices();case'docgen':return pgDocgen();case'emailhub':return pgEmail();case'costsim':return pgCost();case'orders':return pgOrders();case'subscription':return pgSub();case'voucherreport':return pgVoucherReport();case'settings':return pgSettings();case'buyers':return pgBuyers();case'meetings':return pgMeetings();case'alibaba':return pgAlibaba();default:return pgDash();}
}

function renderSidebar(){
  var isAlibaba=S.user&&S.user.plan==='alibaba';
  var menu=[{id:'dashboard',icon:'ğŸ“Š',label:'ëŒ€ì‹œë³´ë“œ'},{id:'analysis',icon:'ğŸ”¬',label:'AI ìˆ˜ì¶œ ë¶„ì„'},{id:'projects',icon:'ğŸš€',label:'í”„ë¡œì íŠ¸'},{id:'div'},{id:'products',icon:'ğŸ“¦',label:'ì œí’ˆ ì¹´ë“œ'},{id:'buyers',icon:'ğŸ¤',label:'ë°”ì´ì–´'},{id:'meetings',icon:'ğŸ“…',label:'ì¼ì •ê´€ë¦¬'},{id:'orders',icon:'ğŸ“‹',label:'ì£¼ë¬¸ê´€ë¦¬'},{id:'div'},{id:'docgen',icon:'ğŸ“„',label:'ì„œë¥˜ ìƒì„±'},{id:'emailhub',icon:'âœ‰ï¸',label:'ì´ë©”ì¼ í—ˆë¸Œ'},{id:'costsim',icon:'ğŸ§®',label:'ì›ê°€ ê³„ì‚°'},{id:'div'}].concat(isAlibaba?[{id:'alibaba',icon:'ğŸª',label:'ì•Œë¦¬ë°”ë°”'},{id:'div'}]:[]).concat([{id:'services',icon:'ğŸ’¼',label:'ì„œë¹„ìŠ¤ ì‹ ì²­'},{id:'subscription',icon:'ğŸ’',label:'êµ¬ë…'},{id:'voucherreport',icon:'ğŸ›ï¸',label:'ë°”ìš°ì²˜ ë³´ê³ ì„œ'},{id:'div'},{id:'settings',icon:'âš™ï¸',label:'ì„¤ì •'}]);
  return '<div class="sidebar"><div class="sidebar-header"><div class="sidebar-logo">W</div><div><div class="sidebar-title">Whistle AI</div><div class="sidebar-sub">'+UI.pb(S.user&&S.user.plan||'free')+'</div></div></div><div class="sidebar-nav">'+menu.map(function(m){if(m.id==='div')return '<div class="nav-section"></div>';return '<div class="nav-item '+(S.page===m.id?'active':'')+'" onclick="App.nav(\''+m.id+'\')"><span class="icon">'+m.icon+'</span><span>'+m.label+'</span></div>';}).join('')+'</div><div class="sidebar-footer"><div class="nav-item" onclick="App.doLogout()" style="color:var(--w40)"><span class="icon">ğŸšª</span><span>ë¡œê·¸ì•„ì›ƒ</span></div></div></div>';
}

function render(){
  var app=document.getElementById('app');
  if(S.loading){app.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100vh"><div style="text-align:center"><div class="spinner" style="width:40px;height:40px;border-width:4px;margin:0 auto 16px"></div><div style="font-size:14px;color:var(--w40)">ë¡œë”© ì¤‘...</div></div></div>';return;}
  if(!S.user){app.innerHTML=pgAuth();return;}
  var unreadN=S.notifications.filter(function(n){return !n.is_read;}).length;
  app.innerHTML='<div class="app-layout">'+renderSidebar()+'<div class="mob-overlay" onclick="App.closeMob()"></div><div class="main-area"><div class="topbar"><div style="display:flex;align-items:center;gap:10px"><button class="mob-toggle" onclick="App.toggleMob()">â˜°</button><div class="topbar-title">'+(PL[S.page]||'')+'</div></div><div style="display:flex;align-items:center;gap:12px"><button class="btn btn-ghost btn-sm" onclick="App.toggleCurrency()" style="font-family:JetBrains Mono;font-size:11px;padding:4px 10px;border-radius:6px">'+(S.currency==='KRW'?'\u20A9 KRW':'\u0024 USD')+' \u21C4</button><div style="position:relative;cursor:pointer" onclick="App.toggleNotif(event)" title="ì•Œë¦¼"><span style="font-size:16px">ğŸ””</span>'+(unreadN>0?'<span class="notif-dot"></span><span style="position:absolute;top:-6px;right:-8px;font-size:9px;background:var(--err);color:#fff;border-radius:8px;padding:0 4px;font-weight:700;min-width:14px;text-align:center">'+unreadN+'</span>':'')+'</div><span style="font-size:13px;color:var(--w40)">'+S.user.email+'</span><div style="width:30px;height:30px;border-radius:8px;background:var(--pri-g);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:800;color:var(--bg)">'+(S.user.company_name||S.user.email||'U').charAt(0).toUpperCase()+'</div></div></div>'+(S.notifOpen?renderNotifPanel():'')+'<div class="page-content">'+renderPage()+'</div></div></div>';
}

function renderNotifPanel(){
  var ICONS={order:'ğŸ“‹',email:'âœ‰ï¸',buyer:'ğŸ¤',service:'ğŸ’¼',cert:'ğŸ“œ',analysis:'ğŸ”¬',system:'ğŸ””',meeting:'ğŸ“…',alibaba:'ğŸª',sample:'ğŸ“¦',shipment:'ğŸš¢',payment:'ğŸ’°'};
  var list=S.notifications.slice(0,20);
  var unread=list.filter(function(n){return !n.is_read;}).length;
  var h='<div style="position:absolute;top:52px;right:16px;z-index:500;width:380px;max-height:480px;background:var(--card);border:1px solid var(--bd-l);border-radius:var(--r);box-shadow:var(--shadow-lg);display:flex;flex-direction:column;overflow:hidden">';
  h+='<div style="padding:12px 16px;border-bottom:1px solid var(--bd);display:flex;align-items:center;justify-content:space-between"><span style="font-size:14px;font-weight:700">ì•Œë¦¼</span><div style="display:flex;gap:8px">';
  if(unread>0)h+='<button class="btn btn-ghost btn-sm" onclick="App.markAllRead()" style="font-size:11px;padding:3px 8px">ëª¨ë‘ ì½ìŒ</button>';
  h+='<button class="btn btn-ghost btn-sm" onclick="App.toggleNotif()" style="font-size:11px;padding:3px 8px">âœ•</button></div></div>';
  h+='<div style="flex:1;overflow-y:auto;max-height:400px">';
  if(list.length===0){
    h+='<div style="padding:40px 16px;text-align:center;color:var(--w40)"><div style="font-size:28px;margin-bottom:8px">ğŸ””</div><div style="font-size:13px">ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤</div></div>';
  }else{
    list.forEach(function(n){
      var ago=_timeAgo(n.created_at);
      var bg=n.is_read?'transparent':'rgba(0,212,255,.04)';
      var dot=n.is_read?'':'<div style="width:6px;height:6px;border-radius:3px;background:var(--pri);flex-shrink:0;margin-top:6px"></div>';
      h+='<div onclick="App.clickNotif(\''+n.id+'\',\''+(n.link_page||'')+'\')" style="padding:10px 16px;border-bottom:1px solid var(--w08);background:'+bg+';cursor:pointer;display:flex;gap:10px;align-items:flex-start;transition:background .15s" onmouseover="this.style.background=\'var(--w08)\'" onmouseout="this.style.background=\''+bg+'\'">';
      h+='<span style="font-size:18px;flex-shrink:0;margin-top:1px">'+(ICONS[n.type]||'ğŸ””')+'</span>';
      h+='<div style="flex:1;min-width:0"><div style="font-size:13px;font-weight:'+(n.is_read?'400':'600')+';color:'+(n.is_read?'var(--w70)':'var(--w90)')+';white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+n.title+'</div>';
      if(n.body)h+='<div style="font-size:11px;color:var(--w40);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+n.body+'</div>';
      h+='<div style="font-size:10px;color:var(--w20);margin-top:3px">'+ago+'</div></div>'+dot+'</div>';
    });
  }
  h+='</div></div>';
  return h;
}

function _timeAgo(d){
  var s=Math.floor((Date.now()-new Date(d).getTime())/1000);
  if(s<60)return 'ë°©ê¸ˆ ì „';if(s<3600)return Math.floor(s/60)+'ë¶„ ì „';
  if(s<86400)return Math.floor(s/3600)+'ì‹œê°„ ì „';if(s<604800)return Math.floor(s/86400)+'ì¼ ì „';
  return new Date(d).toLocaleDateString('ko-KR');
}

function toggleNotif(e){
  if(e)e.stopPropagation();
  S.notifOpen=!S.notifOpen;render();
  if(S.notifOpen){
    var fn=function(ev){if(!ev.target.closest||!ev.target.closest('[style*="z-index:500"]')){S.notifOpen=false;render();document.removeEventListener('click',fn);}};
    setTimeout(function(){document.addEventListener('click',fn);},100);
  }
}

function clickNotif(id,page){
  sb.from('notifications').update({is_read:true}).eq('id',id).then(function(){
    var n=S.notifications.find(function(x){return x.id===id;});if(n)n.is_read=true;
  });
  S.notifOpen=false;
  if(page)S.page=page;
  render();
}

function markAllRead(){
  var ids=S.notifications.filter(function(n){return !n.is_read;}).map(function(n){return n.id;});
  if(ids.length===0)return;
  sb.from('notifications').update({is_read:true}).in('id',ids).then(function(){
    S.notifications.forEach(function(n){n.is_read=true;});render();
  });
}

function pushNotif(type,title,body,linkPage,linkId,telegram){
  if(!S.user)return;
  var n={id:'temp-'+Date.now(),user_id:S.user.id,type:type,title:title,body:body||null,link_page:linkPage||null,link_id:linkId||null,is_read:false,created_at:new Date().toISOString()};
  S.notifications.unshift(n);
  if(S.notifications.length>30)S.notifications.pop();
  render();
  fetch(RELAY_URL+'/api/whistle/notify',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:S.user.id,type:type,title:title,body:body||'',linkPage:linkPage||'',linkId:linkId||'',telegram:!!telegram})}).then(function(r){return r.json();}).then(function(d){if(d.ok&&d.id)n.id=d.id;}).catch(function(){});
}

function toggleMob(){var sb=document.querySelector('.sidebar');if(sb)sb.classList.toggle('mobile-open');}
function closeMob(){var sb=document.querySelector('.sidebar');if(sb)sb.classList.remove('mobile-open');}

window.App={set:set,nav:nav,render:render,doLogin:doLogin,doSignup:doSignup,doLogout:doLogout,startAForm:startAForm,aStep:aStep,cancelA:cancelA,submitA:submitA,addUrl:addUrl,rmUrl:rmUrl,addSP:addSP,rmSP:rmSP,addFiles:addFiles,rmFile:rmFile,toggleMkt:toggleMkt,toggleCert:toggleCert,updateUSD:updateUSD,viewA:viewA,delA:delA,createPj:createPj,showPF:showPF,saveP:saveP,editP:editP,delP:delP,prevImg:prevImg,prodImgFile:prodImgFile,reqSvc:reqSvc,subSvc:subSvc,composeE:composeE,selEB:selEB,chgEP:chgEP,cpEmail:cpEmail,sendE:sendE,calcC:calcC,calcCCompare:calcCCompare,genForwarderRFQ:genForwarderRFQ,sendRFQEmail:sendRFQEmail,showOrderForm:showOrderForm,saveOrder:saveOrder,viewOrder:viewOrder,setOrderStatus:setOrderStatus,setOrderPay:setOrderPay,updateOrderField:updateOrderField,addOrderNote:addOrderNote,openCheckout:openCheckout,confirmCheckout:confirmCheckout,chgPlan:chgPlan,saveSt:saveSt,showBF:showBF,saveBuyer:saveBuyer,findBuyersAI:findBuyersAI,saveAIBuyer:saveAIBuyer,saveAllAIBuyers:saveAllAIBuyers,closeModal:closeModal,viewPj:viewPj,setPjStage:setPjStage,addPjNote:addPjNote,rmPjNote:rmPjNote,delPj:delPj,reqSvcForPj:reqSvcForPj,subSvcPj:subSvcPj,startDoc:startDoc,addDocItem:addDocItem,rmDocItem:rmDocItem,fillDocProd:fillDocProd,fillBuyerDoc:fillBuyerDoc,genDoc:genDoc,genDocPDF:genDocPDF,loadEmailLogs:loadEmailLogs,toggleMob:toggleMob,closeMob:closeMob,autoCreateProduct:autoCreateProduct,genCatalogEN:genCatalogEN,toggleStageItem:toggleStageItem,setCertStatus:setCertStatus,setCertDeadline:setCertDeadline,toggleCertDoc:toggleCertDoc,addCertItem:addCertItem,addCertPreset:addCertPreset,rmCertItem:rmCertItem,getCertGuide:getCertGuide,toggleJourneyStage:toggleJourneyStage,ckTab:ckTab,reqExpertReview:reqExpertReview,toggleCurrency:toggleCurrency,nextOb:nextOb,skipOnboarding:skipOnboarding,completeOnboarding:completeOnboarding,genVoucherReport:genVoucherReport,saveVoucherReport:saveVoucherReport,toggleNotif:toggleNotif,clickNotif:clickNotif,markAllRead:markAllRead,pushNotif:pushNotif,showMeetingForm:showMeetingForm,saveMeeting:saveMeeting,viewMeeting:viewMeeting,saveMeetingNotes:saveMeetingNotes,addMeetingAction:addMeetingAction,toggleMeetingAction:toggleMeetingAction,setMeetingStatus:setMeetingStatus,completeMeeting:completeMeeting,getMeetingPrep:getMeetingPrep,showAlibabaStoreForm:showAlibabaStoreForm,saveAlibabaStore:saveAlibabaStore,showAlibabaInquiryForm:showAlibabaInquiryForm,saveAlibabaInquiry:saveAlibabaInquiry,viewAlibabaInquiry:viewAlibabaInquiry,setAlibabaInquiryStatus:setAlibabaInquiryStatus,getAlibabaReply:getAlibabaReply,convertInquiryToBuyer:convertInquiryToBuyer,showSampleForm:showSampleForm,saveSample:saveSample,updateSampleStatus:updateSampleStatus,updateSampleTracking:updateSampleTracking,convertPItoOrder:convertPItoOrder,showShipmentForm:showShipmentForm,saveShipment:saveShipment,setMilestonePaid:setMilestonePaid};
loadUser();
})();
</script>
<!-- ì‹¤ì‹œê°„ ë¬¸ì˜ ì±„íŒ… ìœ„ì ¯ -->
<script>
(function(){
  var RELAY=(location.hostname==='localhost'||location.hostname==='127.0.0.1')?'http://localhost:3456':'https://uncommanded-brooke-truculent.ngrok-free.dev';
  var PAGE='client';
  var open=false,step=0,msgs=[],info={name:'',email:'',phone:''};
  var el=document.createElement('div');el.id='wc-root';document.body.appendChild(el);
  function r(){
    var html='';
    html+='<div onclick="WC.toggle()" style="position:fixed;bottom:24px;right:24px;z-index:9999;width:56px;height:56px;border-radius:28px;background:linear-gradient(135deg,#00D4FF,#0088FF);display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 20px rgba(0,212,255,.4);transition:transform .2s">';
    html+=open?'<svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M18 6L6 18M6 6l12 12" stroke="#060B18" stroke-width="2.5" stroke-linecap="round"/></svg>':'<svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z" fill="#060B18"/></svg>';
    html+='</div>';
    if(!open){el.innerHTML=html;return;}
    html+='<div style="position:fixed;bottom:90px;right:24px;z-index:9998;width:360px;max-height:520px;background:#0D1424;border-radius:16px;border:1px solid rgba(255,255,255,.1);box-shadow:0 16px 60px rgba(0,0,0,.6);display:flex;flex-direction:column;overflow:hidden;font-family:Sora,Noto Sans KR,sans-serif">';
    html+='<div style="padding:14px 18px;background:linear-gradient(135deg,#00D4FF20,#0088FF10);border-bottom:1px solid rgba(255,255,255,.08);display:flex;align-items:center;gap:10px">';
    html+='<div style="width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#00D4FF,#0088FF);display:flex;align-items:center;justify-content:center"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" fill="#060B18"/></svg></div>';
    html+='<div><div style="font-size:14px;font-weight:700;color:#fff">Whistle AI</div><div style="font-size:11px;color:rgba(255,255,255,.4)">ìˆ˜ì¶œ ì „ë¬¸ ìƒë‹´</div></div>';
    html+='<div style="margin-left:auto;display:flex;align-items:center;gap:4px"><div style="width:6px;height:6px;border-radius:3px;background:#00E676"></div><span style="font-size:10px;color:#00E676">ì˜¨ë¼ì¸</span></div></div>';
    html+='<div id="wc-msgs" style="flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:8px;min-height:200px;max-height:320px">';
    if(msgs.length===0&&step===0){html+=bbl('bot','ì•ˆë…•í•˜ì„¸ìš”! Whistle AI ìˆ˜ì¶œ ìƒë‹´ì…ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?');html+=qb(['ë¬´ë£Œ ë¶„ì„ì´ ê¶ê¸ˆí•´ìš”','ë°”ìš°ì²˜ ë¬¸ì˜','ì•Œë¦¬ë°”ë°” ì…ì ','ê¸°íƒ€ ë¬¸ì˜']);}
    for(var i=0;i<msgs.length;i++)html+=bbl(msgs[i].from,msgs[i].text);
    if(step===1){html+=bbl('bot','ìƒë‹´ì„ ìœ„í•´ ê°„ë‹¨í•œ ì •ë³´ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.');html+='<div style="display:flex;flex-direction:column;gap:6px;width:100%"><input id="wc-name" placeholder="ì´ë¦„/íšŒì‚¬ëª…" value="'+esc(info.name)+'" style="padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,.1);background:#111B2E;color:rgba(255,255,255,.9);font-size:13px;outline:none"><input id="wc-email" placeholder="ì´ë©”ì¼ (ì„ íƒ)" value="'+esc(info.email)+'" style="padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,.1);background:#111B2E;color:rgba(255,255,255,.9);font-size:13px;outline:none"><input id="wc-phone" placeholder="ì—°ë½ì²˜ (ì„ íƒ)" value="'+esc(info.phone)+'" style="padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,.1);background:#111B2E;color:rgba(255,255,255,.9);font-size:13px;outline:none"><button onclick="WC.submitInfo()" style="padding:10px;border-radius:8px;border:none;background:linear-gradient(135deg,#00D4FF,#0088FF);color:#060B18;font-weight:700;font-size:13px;cursor:pointer">ìƒë‹´ ì‹œì‘</button></div>';}
    html+='</div>';
    if(step>=2){html+='<div style="padding:10px 14px;border-top:1px solid rgba(255,255,255,.08);display:flex;gap:8px"><input id="wc-input" onkeydown="if(event.key===\'Enter\')WC.send()" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." style="flex:1;padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,.1);background:#111B2E;color:rgba(255,255,255,.9);font-size:13px;outline:none"><button onclick="WC.send()" style="width:40px;height:40px;border-radius:10px;border:none;background:linear-gradient(135deg,#00D4FF,#0088FF);cursor:pointer;display:flex;align-items:center;justify-content:center"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M2 21l21-9L2 3v7l15 2-15 2v7z" fill="#060B18"/></svg></button></div>';}
    html+='</div>';
    el.innerHTML=html;var mc=document.getElementById('wc-msgs');if(mc)mc.scrollTop=mc.scrollHeight;
  }
  function bbl(f,t){return f==='bot'?'<div style="align-self:flex-start;max-width:85%;padding:10px 14px;border-radius:12px 12px 12px 4px;background:#111B2E;border:1px solid rgba(255,255,255,.06)"><div style="font-size:13px;color:rgba(255,255,255,.75);line-height:1.5">'+t+'</div></div>':'<div style="align-self:flex-end;max-width:85%;padding:10px 14px;border-radius:12px 12px 4px 12px;background:linear-gradient(135deg,#00D4FF20,#0088FF15);border:1px solid #00D4FF30"><div style="font-size:13px;color:rgba(255,255,255,.9);line-height:1.5">'+t+'</div></div>';}
  function qb(a){var h='<div style="display:flex;flex-wrap:wrap;gap:6px">';for(var i=0;i<a.length;i++)h+='<div onclick="WC.pick(\''+esc(a[i])+'\')" style="padding:6px 12px;border-radius:8px;border:1px solid rgba(0,212,255,.3);background:rgba(0,212,255,.06);color:#00D4FF;font-size:12px;font-weight:600;cursor:pointer">'+a[i]+'</div>';return h+'</div>';}
  function esc(s){return String(s||'').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;');}
  var ar={'ë¬´ë£Œ ë¶„ì„ì´ ê¶ê¸ˆí•´ìš”':'ìƒë‹¨ ë©”ë‰´ì—ì„œ AI ìˆ˜ì¶œë¶„ì„ì„ ì‹œì‘í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤. URLì´ë‚˜ ì´ë¯¸ì§€ë¥¼ ì˜¬ë¦¬ë©´ 13ê°œ ì„¹ì…˜ì˜ ì¢…í•© ë¦¬í¬íŠ¸ê°€ ìƒì„±ë©ë‹ˆë‹¤!','ë°”ìš°ì²˜ ë¬¸ì˜':'Whistle AIëŠ” ìˆ˜ì¶œë°”ìš°ì²˜Â·ì œì¡°í˜ì‹ ë°”ìš°ì²˜ ê³µì‹ ìˆ˜í–‰ê¸°ê´€ì…ë‹ˆë‹¤. ì •ë¶€ê°€ ë¹„ìš©ì˜ 50~85%ë¥¼ ë¶€ë‹´í•©ë‹ˆë‹¤.','ì•Œë¦¬ë°”ë°” ì…ì ':'ì´íŒ ìš´ì˜(ì…‹ì—…ë¹„ 200ë§Œì›)ê³¼ ë…ë¦½ ìš´ì˜(ì…‹ì—…ë¹„ 500ë§Œì›) ë‘ ê°€ì§€ ëª¨ë¸ì´ ìˆìŠµë‹ˆë‹¤. ë°”ìš°ì²˜ ì ìš© ì‹œ ìµœëŒ€ 85% ì ˆê° ê°€ëŠ¥í•©ë‹ˆë‹¤.','ê¸°íƒ€ ë¬¸ì˜':'ê¶ê¸ˆí•œ ë‚´ìš©ì„ ììœ ë¡­ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”. ë‹´ë‹¹ìê°€ ë¹ ë¥´ê²Œ ë‹µë³€ë“œë¦¬ê² ìŠµë‹ˆë‹¤.'};
  window.WC={
    toggle:function(){open=!open;r();},
    pick:function(t){msgs.push({from:'user',text:t});if(ar[t]){msgs.push({from:'bot',text:ar[t]});msgs.push({from:'bot',text:'ë” ìì„¸í•œ ìƒë‹´ì„ ì›í•˜ì‹œë©´ ì•„ë˜ ì •ë³´ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”.'});step=1;}r();},
    submitInfo:function(){var n=document.getElementById('wc-name'),e=document.getElementById('wc-email'),p=document.getElementById('wc-phone');info.name=n?n.value:'';info.email=e?e.value:'';info.phone=p?p.value:'';if(!info.name){alert('ì´ë¦„/íšŒì‚¬ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');return;}msgs.push({from:'bot',text:info.name+'ë‹˜, ë°˜ê°‘ìŠµë‹ˆë‹¤! ê¶ê¸ˆí•œ ì ì„ ììœ ë¡­ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.'});step=2;r();},
    send:function(){var inp=document.getElementById('wc-input');if(!inp||!inp.value.trim())return;var msg=inp.value.trim();msgs.push({from:'user',text:msg});r();fetch(RELAY+'/api/whistle/chat-inquiry',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:info.name,email:info.email,phone:info.phone,message:msg,page:PAGE})}).then(function(r){return r.json();}).then(function(d){if(d.ok){msgs.push({from:'bot',text:d.reply||'ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.'});r();}}).catch(function(){msgs.push({from:'bot',text:'ì „ì†¡ ì‹¤íŒ¨. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'});r();});}
  };r();
})();
</script>
</body>
</html>
