<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Whistle AI â€” ìˆ˜ì¶œ í”Œë«í¼</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&family=Noto+Sans+KR:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root{--bg:#060B18;--bg2:#0A1020;--card:#0D1424;--card2:#111B2E;--sf:#111B2E;--pri:#00D4FF;--pri-g:linear-gradient(135deg,#00D4FF,#0088FF);--pri-d:#0088FF;--pri-glow:0 0 30px rgba(0,212,255,.12);--acc:#FFB800;--acc-g:linear-gradient(135deg,#FFB800,#FF8C00);--ok:#00E676;--err:#FF5252;--warn:#FFA726;--purple:#A855F7;--w:#fff;--w90:rgba(255,255,255,.9);--w70:rgba(255,255,255,.7);--w60:rgba(255,255,255,.6);--w40:rgba(255,255,255,.4);--w20:rgba(255,255,255,.2);--w12:rgba(255,255,255,.1);--w08:rgba(255,255,255,.06);--bd:rgba(255,255,255,.08);--bd-l:rgba(255,255,255,.15);--r:14px;--r-s:10px;--r-xs:6px;--shadow:0 4px 24px rgba(0,0,0,.4);--shadow-lg:0 12px 48px rgba(0,0,0,.6)}
*{box-sizing:border-box;margin:0;padding:0}html{scroll-behavior:smooth}
body{background:var(--bg);font-family:'Sora','Noto Sans KR',-apple-system,sans-serif;color:var(--w);line-height:1.5;overflow:hidden;height:100vh}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:var(--bg2)}::-webkit-scrollbar-thumb{background:var(--w12);border-radius:3px}::selection{background:rgba(0,212,255,.3)}
input:focus,textarea:focus,select:focus{outline:none;border-color:var(--pri)!important;box-shadow:0 0 0 3px rgba(0,212,255,.1)}
select option{background:var(--card);color:var(--w90)}textarea{resize:vertical;min-height:60px}a{color:var(--pri);text-decoration:none}
.app-layout{display:flex;height:100vh;overflow:hidden}
.sidebar{width:240px;background:var(--bg2);border-right:1px solid var(--bd);display:flex;flex-direction:column;flex-shrink:0;overflow-y:auto}
.sidebar-header{padding:16px;border-bottom:1px solid var(--bd);display:flex;align-items:center;gap:10px}
.sidebar-logo{width:32px;height:32px;border-radius:9px;background:var(--pri-g);display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:900;color:var(--bg);flex-shrink:0}
.sidebar-title{font-size:15px;font-weight:800;letter-spacing:-.5px}
.sidebar-sub{font-size:10px;color:var(--w40);font-family:'JetBrains Mono'}
.sidebar-nav{flex:1;padding:8px;overflow-y:auto}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:var(--r-s);font-size:13px;font-weight:500;color:var(--w60);cursor:pointer;transition:all .15s;border:1px solid transparent;margin-bottom:2px}
.nav-item:hover{background:var(--w08);color:var(--w90)}
.nav-item.active{background:rgba(0,212,255,.08);color:var(--pri);border-color:rgba(0,212,255,.15);font-weight:600}
.nav-item .icon{font-size:16px;width:20px;text-align:center}
.nav-item .badge-count{margin-left:auto;font-size:10px;background:var(--err);color:var(--w);padding:1px 6px;border-radius:10px;font-weight:700}
.nav-section{height:1px;background:var(--bd);margin:8px 12px}
.sidebar-footer{padding:12px;border-top:1px solid var(--bd)}
.main-area{flex:1;display:flex;flex-direction:column;overflow:hidden}
.topbar{height:52px;background:rgba(6,11,24,.9);backdrop-filter:blur(12px);border-bottom:1px solid var(--bd);display:flex;align-items:center;justify-content:space-between;padding:0 24px;flex-shrink:0}
.topbar-title{font-size:15px;font-weight:700}
.page-content{flex:1;overflow-y:auto;padding:24px}
.card{background:var(--card);border-radius:var(--r);border:1px solid var(--bd);overflow:hidden}
.card-h{padding:14px 18px;border-bottom:1px solid var(--bd);display:flex;align-items:center;justify-content:space-between;font-weight:700;font-size:14px}
.card-b{padding:18px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:9px 18px;border-radius:var(--r-s);font-size:13px;font-weight:600;font-family:inherit;cursor:pointer;border:none;transition:all .15s;white-space:nowrap}
.btn:hover{filter:brightness(1.1);transform:translateY(-1px)}.btn:active{transform:translateY(0)}.btn:disabled{opacity:.5;cursor:not-allowed}
.btn-pri{background:var(--pri-g);color:var(--bg);box-shadow:var(--pri-glow)}.btn-acc{background:var(--acc-g);color:var(--bg)}
.btn-ok{background:var(--ok);color:var(--bg)}.btn-ghost{background:transparent;color:var(--w);border:1.5px solid var(--bd-l)}
.btn-ghost:hover{border-color:var(--w40)}.btn-danger{background:rgba(255,82,82,.15);color:var(--err);border:1px solid rgba(255,82,82,.2)}
.btn-sm{padding:5px 12px;font-size:12px;border-radius:var(--r-xs)}.btn-lg{padding:12px 24px;font-size:14px}.btn-block{width:100%}
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:var(--r-xs);font-size:11px;font-weight:600;font-family:'JetBrains Mono',monospace}
.badge-pri{background:rgba(0,212,255,.1);color:var(--pri);border:1px solid rgba(0,212,255,.2)}
.badge-acc{background:rgba(255,184,0,.1);color:var(--acc);border:1px solid rgba(255,184,0,.2)}
.badge-ok{background:rgba(0,230,118,.1);color:var(--ok);border:1px solid rgba(0,230,118,.2)}
.badge-err{background:rgba(255,82,82,.1);color:var(--err);border:1px solid rgba(255,82,82,.2)}
.badge-purple{background:rgba(168,85,247,.1);color:var(--purple);border:1px solid rgba(168,85,247,.2)}
.badge-ghost{background:var(--w08);color:var(--w40);border:1px solid var(--bd)}
.form-group{margin-bottom:14px}
.form-label{display:block;font-size:12px;font-weight:600;color:var(--w40);margin-bottom:6px}
.form-input,.form-select,.form-textarea{width:100%;padding:11px 14px;border-radius:var(--r-s);border:1.5px solid var(--bd);background:var(--sf);color:var(--w90);font-size:14px;font-family:inherit}
.form-input::placeholder{color:var(--w20)}
.tbl{width:100%;border-collapse:collapse}
.tbl th{text-align:left;padding:10px 14px;font-size:11px;font-weight:600;color:var(--w40);text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--bd-l);background:var(--w08)}
.tbl td{padding:11px 14px;font-size:13px;border-bottom:1px solid var(--w08);color:var(--w90)}
.tbl tr:hover td{background:var(--w08)}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
.grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;visibility:hidden;transition:all .2s}
.modal-overlay.show{opacity:1;visibility:visible}
.modal{background:var(--card);border:1px solid var(--bd-l);border-radius:var(--r);width:90%;max-width:520px;max-height:85vh;overflow-y:auto;box-shadow:var(--shadow-lg)}
.modal-h{padding:16px 20px;border-bottom:1px solid var(--bd);display:flex;align-items:center;justify-content:space-between}
.modal-h h3{font-size:16px;font-weight:700}
.modal-close{width:28px;height:28px;border-radius:8px;background:var(--w08);border:none;color:var(--w40);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.modal-close:hover{background:var(--w12);color:var(--w)}
.modal-b{padding:20px}.modal-f{padding:14px 20px;border-top:1px solid var(--bd);display:flex;justify-content:flex-end;gap:8px}
.toast-container{position:fixed;top:16px;right:16px;z-index:2000;display:flex;flex-direction:column;gap:8px}
.toast{padding:12px 18px;border-radius:var(--r-s);font-size:13px;font-weight:500;display:flex;align-items:center;gap:8px;box-shadow:var(--shadow);animation:slideInR .3s ease;min-width:280px}
.toast-ok{background:#0a2a1a;border:1px solid rgba(0,230,118,.25);color:var(--ok)}
.toast-err{background:#2a0a0a;border:1px solid rgba(255,82,82,.25);color:var(--err)}
.toast-warn{background:#2a1a0a;border:1px solid rgba(255,167,38,.25);color:var(--warn)}
.toast-info{background:#0a1a2a;border:1px solid rgba(0,212,255,.25);color:var(--pri)}
.stat-card{background:var(--card);border:1px solid var(--bd);border-radius:var(--r);padding:18px}
.stat-label{font-size:11px;color:var(--w40);font-weight:500;margin-bottom:6px}
.stat-value{font-family:'Sora';font-weight:800;font-size:26px;letter-spacing:-1px}
.stat-sub{font-size:11px;color:var(--w20);margin-top:4px}
.spinner{width:24px;height:24px;border:3px solid var(--w08);border-top-color:var(--pri);border-radius:50%;animation:spin .8s linear infinite}
.auth-wrap{display:flex;align-items:center;justify-content:center;height:100vh;background:var(--bg);padding:20px}
.auth-card{width:100%;max-width:420px;background:var(--card);border:1px solid var(--bd);border-radius:20px;padding:36px;box-shadow:var(--shadow-lg)}
.auth-logo{display:flex;align-items:center;gap:10px;margin-bottom:28px}
.auth-logo-icon{width:38px;height:38px;border-radius:10px;background:var(--pri-g);display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:900;color:var(--bg)}
.auth-title{font-size:22px;font-weight:800;letter-spacing:-.5px}
.auth-sub{font-size:12px;color:var(--w40)}
.auth-tabs{display:flex;gap:4px;margin-bottom:20px}
.auth-tab{flex:1;padding:10px;text-align:center;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;border:1px solid transparent;color:var(--w40);transition:all .15s}
.auth-tab.active{background:rgba(0,212,255,.08);color:var(--pri);border-color:rgba(0,212,255,.2)}
.auth-tab:hover:not(.active){background:var(--w08)}
.auth-error{padding:10px 14px;border-radius:8px;background:rgba(255,82,82,.1);border:1px solid rgba(255,82,82,.2);color:var(--err);font-size:12px;margin-bottom:12px}
.dash-hero{background:linear-gradient(135deg,rgba(0,212,255,.06),rgba(168,85,247,.06));border:1px solid rgba(0,212,255,.1);border-radius:16px;padding:28px;margin-bottom:20px}
.dash-welcome{font-size:22px;font-weight:800;letter-spacing:-.5px;margin-bottom:4px}
.dash-company{font-size:13px;color:var(--w40)}
.quick-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-top:16px}
.quick-card{padding:14px;border-radius:12px;background:var(--card);border:1px solid var(--bd);cursor:pointer;transition:all .15s;text-align:center}
.quick-card:hover{border-color:var(--pri);transform:translateY(-2px)}
.quick-icon{font-size:24px;margin-bottom:6px}.quick-label{font-size:12px;font-weight:600;color:var(--w70)}
.svc-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}
.svc-card{padding:20px;border-radius:14px;background:var(--card);border:1px solid var(--bd);cursor:pointer;transition:all .2s}
.svc-card:hover{border-color:var(--pri);background:var(--card2)}
.svc-icon{font-size:28px;margin-bottom:8px}.svc-name{font-size:15px;font-weight:700;margin-bottom:4px}
.svc-desc{font-size:12px;color:var(--w40);line-height:1.6}.svc-price{font-size:12px;color:var(--acc);font-weight:700;font-family:'JetBrains Mono';margin-top:8px}
.prod-card{background:var(--card);border:1px solid var(--bd);border-radius:14px;overflow:hidden;transition:all .15s;cursor:pointer}
.prod-card:hover{border-color:var(--pri)}
.prod-img{height:140px;background:var(--sf);display:flex;align-items:center;justify-content:center;font-size:40px;color:var(--w20)}
.prod-body{padding:14px}.prod-name{font-size:14px;font-weight:700;margin-bottom:4px}.prod-meta{font-size:11px;color:var(--w40)}
.plan-card{border-radius:16px;border:2px solid var(--bd);padding:24px;text-align:center;transition:all .2s}
.plan-card:hover{transform:translateY(-4px)}
.plan-card.current{border-color:var(--pri);background:rgba(0,212,255,.04)}
.plan-card.recommended{border-color:var(--acc);background:rgba(255,184,0,.04)}
.plan-name{font-size:20px;font-weight:800;margin:8px 0 4px}
.plan-price{font-size:28px;font-weight:900;letter-spacing:-1px}
.plan-period{font-size:11px;color:var(--w40)}
.plan-features{text-align:left;margin-top:14px;font-size:12px;line-height:2.2;color:var(--w70)}
.empty-state{text-align:center;padding:48px 24px;color:var(--w40)}
.empty-state .ei{font-size:48px;margin-bottom:12px;opacity:.4}
.empty-state .et{font-size:16px;font-weight:700;margin-bottom:4px;color:var(--w60)}
.empty-state .ed{font-size:13px}
@keyframes slideInR{from{transform:translateX(100px);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes spin{to{transform:rotate(360deg)}}
@media(max-width:768px){.sidebar{display:none}.sidebar.mobile-open{display:flex;position:fixed;inset:0;z-index:900;width:280px;box-shadow:var(--shadow-lg)}.sidebar.mobile-open~.mob-overlay{display:block}.mob-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:899}.grid-2,.grid-3,.grid-4{grid-template-columns:1fr}.page-content{padding:16px}.topbar{padding:0 16px}.mob-toggle{display:flex!important}}
.mob-toggle{display:none;width:36px;height:36px;border-radius:8px;background:var(--w08);border:none;color:var(--w60);font-size:16px;cursor:pointer;align-items:center;justify-content:center;transition:all .15s}
.mob-toggle:hover{background:var(--w12);color:var(--w)}
.notif-dot{width:7px;height:7px;border-radius:50%;background:var(--err);position:absolute;top:-1px;right:-1px;animation:pulse 2s infinite}
</style>
</head>
<body>
<div id="app"></div>
<script>
(function(){
"use strict";
var sb=window.supabase.createClient('https://lylktgxngrlxmsldxdqj.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx5bGt0Z3huZ3JseG1zbGR4ZHFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4MTQ2OTAsImV4cCI6MjA4NzM5MDY5MH0.8kgcDCMBT_STf43MVkeUUiq-K6r-Ytp3nUQ6d-nL2D0');
var RELAY_URL=(location.hostname==='localhost'||location.hostname==='127.0.0.1')?'http://localhost:3456':'https://uncommanded-brooke-truculent.ngrok-free.dev';

/* === UTILS === */
var U={
  fd:function(d,s){if(!d)return'\u2014';var dt=new Date(d);if(isNaN(dt))return'\u2014';if(s==='rel'){var m=Math.floor((Date.now()-dt)/6e4);if(m<1)return'\uBC29\uAE08';if(m<60)return m+'\uBD84 \uC804';var h=Math.floor(m/60);if(h<24)return h+'\uC2DC\uAC04 \uC804';var dd=Math.floor(h/24);return dd+'\uC77C \uC804';}return dt.toLocaleDateString('ko-KR',{year:'numeric',month:'short',day:'numeric'});},
  usd:function(n){if(n==null)return'\u2014';return'$'+Number(n).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});},
  krw:function(n){if(n==null)return'\u2014';n=Number(n);if(n>=1e8)return'\u20A9'+(n/1e8).toFixed(1)+'\uC5B5';if(n>=1e4)return'\u20A9'+(n/1e4).toFixed(0)+'\uB9CC';return'\u20A9'+n.toLocaleString('ko-KR');},
  tr:function(s,l){l=l||50;return s&&s.length>l?s.slice(0,l)+'\u2026':s||'';},
  sl:function(t){return{premium_analysis:'\uD504\uB9AC\uBBF8\uC5C4 \uBD84\uC11D',matching:'\uBC14\uC774\uC5B4 \uB9E4\uCE6D',document:'\uC11C\uB958 \uB300\uD589',certification:'\uC778\uC99D \uB300\uD589',logistics:'\uBB3C\uB958/\uD1B5\uAD00',email_support:'\uC774\uBA54\uC77C \uC9C0\uC6D0'}[t]||t;},
  si:function(t){return{premium_analysis:'\uD83D\uDD2C',matching:'\uD83E\uDD1D',document:'\uD83D\uDCC4',certification:'\uD83C\uDFC5',logistics:'\uD83D\uDEA2',email_support:'\u2709\uFE0F'}[t]||'\uD83D\uDCCB';},
  cl:function(c){return{US:'\uD83C\uDDFA\uD83C\uDDF8 \uBBF8\uAD6D',JP:'\uD83C\uDDEF\uD83C\uDDF5 \uC77C\uBCF8',CN:'\uD83C\uDDE8\uD83C\uDDF3 \uC911\uAD6D',EU:'\uD83C\uDDEA\uD83C\uDDFA EU',SEA:'\uD83C\uDF0F \uB3D9\uB0A8\uC544'}[c]||c||'\u2014';},
  CAT:['K-Beauty','K-Food','K-Health','K-Fashion','K-Electronics','K-Living','Other']
};

/* === UI === */
var tc=null;
var UI={
  toast:function(msg,type,dur){type=type||'info';dur=dur||3000;if(!tc){tc=document.createElement('div');tc.className='toast-container';document.body.appendChild(tc);}var icons={ok:'\u2713',err:'\u2715',warn:'\u26A0',info:'\u2139'};var el=document.createElement('div');el.className='toast toast-'+type;el.innerHTML='<span>'+((icons[type])||'\u2139')+'</span><span>'+msg+'</span>';tc.appendChild(el);setTimeout(function(){el.style.opacity='0';el.style.transform='translateX(100px)';el.style.transition='all .3s';setTimeout(function(){el.remove();},300);},dur);},
  showModal:function(id){var e=document.getElementById(id);if(e)e.classList.add('show');},
  hideModal:function(id){var e=document.getElementById(id);if(e)e.classList.remove('show');},
  modal:function(o){return'<div class="modal-overlay" id="'+o.id+'" onclick="if(event.target===this)App.closeModal(\''+o.id+'\')"><div class="modal" style="max-width:'+(o.width||'520px')+'"><div class="modal-h"><h3>'+o.title+'</h3><button class="modal-close" onclick="App.closeModal(\''+o.id+'\')">&#10005;</button></div><div class="modal-b">'+o.body+'</div>'+(o.footer?'<div class="modal-f">'+o.footer+'</div>':'')+'</div></div>';},
  badge:function(t,type){return'<span class="badge badge-'+(type||'pri')+'">'+t+'</span>';},
  sb:function(s){var m={pending:['ëŒ€ê¸°ì¤‘','acc'],processing:['ì²˜ë¦¬ì¤‘','pri'],completed:['ì™„ë£Œ','ok'],cancelled:['ì·¨ì†Œ','ghost'],failed:['ì‹¤íŒ¨','err'],draft:['ì´ˆì•ˆ','ghost'],active:['í™œì„±','ok'],paused:['ì¤‘ì§€','acc'],analyzing:['ë¶„ì„ì¤‘','pri'],review:['ê²€ìˆ˜ì¤‘','purple'],approved:['ìŠ¹ì¸','ok'],accepted:['ì ‘ìˆ˜','pri']};var r=m[s]||[s,'ghost'];return this.badge(r[0],r[1]);},
  empty:function(icon,title,desc){return'<div class="empty-state"><div class="ei">'+icon+'</div><div class="et">'+title+'</div><div class="ed">'+(desc||'')+'</div></div>';},
  stat:function(label,value,sub,color){return'<div class="stat-card"><div class="stat-label">'+label+'</div><div class="stat-value" style="color:'+(color||'var(--pri)')+'">'+value+'</div>'+(sub?'<div class="stat-sub">'+sub+'</div>':'')+'</div>';},
  inp:function(name,label,o){o=o||{};return'<div class="form-group"><label class="form-label">'+label+(o.required?' <span style="color:var(--err)">*</span>':'')+'</label><input class="form-input" name="'+name+'" type="'+(o.type||'text')+'" value="'+(o.value||'')+'" placeholder="'+(o.placeholder||'')+'" '+(o.required?'required':'')+'></div>';},
  sel:function(name,label,opts,sel){var os=opts.map(function(o){var v=typeof o==='object'?o.value:o;var t=typeof o==='object'?o.label:o;return'<option value="'+v+'" '+(v===sel?'selected':'')+'>'+t+'</option>';}).join('');return'<div class="form-group"><label class="form-label">'+label+'</label><select class="form-select" name="'+name+'">'+os+'</select></div>';},
  ta:function(name,label,o){o=o||{};return'<div class="form-group"><label class="form-label">'+label+'</label><textarea class="form-textarea" name="'+name+'" rows="'+(o.rows||3)+'" placeholder="'+(o.placeholder||'')+'">'+(o.value||'')+'</textarea></div>';},
  fd:function(sel){var el=typeof sel==='string'?document.querySelector(sel):sel;if(!el)return{};var d={};el.querySelectorAll('input,select,textarea').forEach(function(i){if(i.name){d[i.name]=i.type==='number'&&i.value?Number(i.value):i.value;}});return d;},
  pb:function(p){var m={free:['FREE','var(--w40)'],basic:['BASIC','var(--pri)'],pro:['PRO','var(--acc)'],alibaba:['ALIBABA','var(--err)']};var r=m[p]||m.free;return'<span class="badge" style="background:'+r[1]+'15;color:'+r[1]+';border:1px solid '+r[1]+'25">'+r[0]+'</span>';}
};

/* === STATE === */
var S={user:null,company:null,page:'dashboard',authMode:'login',authError:'',loading:true,analyses:[],products:[],projects:[],serviceRequests:[],buyers:[],currentAnalysis:null,analysisStep:0,analysisData:null,currentProject:null,docType:null,docItems:[],docData:null};

function set(u){for(var k in u)S[k]=u[k];render();}

/* === DATA === */
function loadUser(){
  sb.auth.getSession().then(function(res){
    var session=res.data.session;
    if(!session)return set({loading:false});
    sb.from('users').select('*').eq('id',session.user.id).single().then(function(r){
      if(r.error||!r.data||r.data.role!=='client'){sb.auth.signOut();return set({loading:false});}
      S.user=r.data;
      sb.from('companies').select('*').eq('user_id',r.data.id).maybeSingle().then(function(cr){
        S.company=cr.data||null;S.loading=false;
        Promise.allSettled([loadA(),loadP(),loadPr(),loadSR(),loadB()]).then(function(){render();});
      });
    });
  });
}
function loadA(){return sb.from('analyses').select('*').eq('user_id',S.user.id).order('created_at',{ascending:false}).limit(50).then(function(r){S.analyses=r.data||[];});}
function loadP(){return sb.from('products').select('*').eq('user_id',S.user.id).order('created_at',{ascending:false}).then(function(r){S.products=r.data||[];});}
function loadPr(){return sb.from('projects').select('*').eq('user_id',S.user.id).order('created_at',{ascending:false}).then(function(r){S.projects=r.data||[];});}
function loadSR(){return sb.from('service_requests').select('*').eq('user_id',S.user.id).order('created_at',{ascending:false}).then(function(r){S.serviceRequests=r.data||[];});}
function loadB(){return sb.from('buyers').select('*').eq('registered_by',S.user.id).order('created_at',{ascending:false}).then(function(r){S.buyers=r.data||[];});}

/* === AUTH === */
function doLogin(e){e.preventDefault();var f=e.target;S.authError='';
  sb.auth.signInWithPassword({email:f.email.value,password:f.password.value}).then(function(r){
    if(r.error)return set({authError:r.error.message==='Invalid login credentials'?'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.':r.error.message});
    loadUser();
  });
}
function doSignup(e){e.preventDefault();var f=e.target;
  if(f.password.value.length<6)return set({authError:'ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒ'});
  S.authError='';
  sb.auth.signUp({email:f.email.value,password:f.password.value,options:{data:{role:'client',company_name:f.company_name.value}}}).then(function(r){
    if(r.error)return set({authError:r.error.message.includes('already registered')?'ì´ë¯¸ ë“±ë¡ëœ ì´ë©”ì¼':r.error.message});
    UI.toast('ê°€ì… ì™„ë£Œ! ì´ë©”ì¼ í™•ì¸ í›„ ë¡œê·¸ì¸í•˜ì„¸ìš”','ok');set({authMode:'login'});
  });
}
function doLogout(){if(confirm('ë¡œê·¸ì•„ì›ƒ?')){sb.auth.signOut().then(function(){S.user=null;S.company=null;render();});}}

/* === PAGES === */
function pgAuth(){
  var isL=S.authMode==='login';
  return '<div class="auth-wrap"><div class="auth-card"><div class="auth-logo"><div class="auth-logo-icon">W</div><div><div class="auth-title">Whistle AI</div><div class="auth-sub">ìˆ˜ì¶œ ì„±ê³µì˜ ì‹œì‘</div></div></div><div class="auth-tabs"><div class="auth-tab '+(isL?'active':'')+'" onclick="App.set({authMode:\'login\',authError:\'\'})">ë¡œê·¸ì¸</div><div class="auth-tab '+(!isL?'active':'')+'" onclick="App.set({authMode:\'signup\',authError:\'\'})">íšŒì›ê°€ì…</div></div>'+(S.authError?'<div class="auth-error">'+S.authError+'</div>':'')+(isL?'<form onsubmit="App.doLogin(event)">'+UI.inp('email','ì´ë©”ì¼',{type:'email',placeholder:'email@company.com',required:true})+UI.inp('password','ë¹„ë°€ë²ˆí˜¸',{type:'password',placeholder:'ë¹„ë°€ë²ˆí˜¸',required:true})+'<button class="btn btn-pri btn-block btn-lg" type="submit" style="margin-top:8px">ë¡œê·¸ì¸</button></form>':'<form onsubmit="App.doSignup(event)">'+UI.inp('company_name','íšŒì‚¬ëª…',{placeholder:'(ì£¼)ëª¨í‹°ë¸Œì´ë…¸ë² ì´ì…˜',required:true})+UI.inp('email','ì´ë©”ì¼',{type:'email',placeholder:'email@company.com',required:true})+UI.inp('password','ë¹„ë°€ë²ˆí˜¸',{type:'password',placeholder:'6ì ì´ìƒ',required:true})+'<button class="btn btn-pri btn-block btn-lg" type="submit" style="margin-top:8px">ë¬´ë£Œ ì‹œì‘í•˜ê¸°</button></form>')+'<div style="text-align:center;margin-top:16px;font-size:11px;color:var(--w20)">ê°€ì… ì¦‰ì‹œ AI ìˆ˜ì¶œ ë¶„ì„ 1íšŒ ë¬´ë£Œ</div></div></div>';
}

function pgDash(){
  var u=S.user,ac=S.analyses.length,pc=S.products.length;
  var ap=S.projects.filter(function(p){return p.status!=='completed';}).length;
  var ps=S.serviceRequests.filter(function(s){return s.status==='pending'||s.status==='processing';}).length;
  return '<div class="dash-hero"><div class="dash-welcome">ì•ˆë…•í•˜ì„¸ìš”, '+(u.company_name||u.display_name||'ì‚¬ì¥ë‹˜')+' ğŸ‘‹</div><div class="dash-company">'+(S.company?S.company.name_ko:'íšŒì‚¬ ì •ë³´ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”')+'</div><div class="quick-grid"><div class="quick-card" onclick="App.nav(\'analysis\')"><div class="quick-icon">ğŸ”¬</div><div class="quick-label">AI ë¶„ì„</div></div><div class="quick-card" onclick="App.nav(\'products\')"><div class="quick-icon">ğŸ“¦</div><div class="quick-label">ì œí’ˆ ë“±ë¡</div></div><div class="quick-card" onclick="App.nav(\'services\')"><div class="quick-icon">ğŸ’¼</div><div class="quick-label">ì„œë¹„ìŠ¤ ì‹ ì²­</div></div><div class="quick-card" onclick="App.nav(\'docgen\')"><div class="quick-icon">ğŸ“„</div><div class="quick-label">ì„œë¥˜ ë§Œë“¤ê¸°</div></div></div></div><div class="grid-4" style="margin-bottom:20px">'+UI.stat('AI ë¶„ì„',ac,ac?'ìµœê·¼: '+U.fd(S.analyses[0]&&S.analyses[0].created_at,'rel'):'ì‹œì‘í•˜ì„¸ìš”','var(--pri)')+UI.stat('ë“±ë¡ ì œí’ˆ',pc,pc?'ë°”ì´ì–´ ë…¸ì¶œ':'ë“±ë¡í•˜ì„¸ìš”','var(--acc)')+UI.stat('í”„ë¡œì íŠ¸',ap,ap?'ì§„í–‰ ì¤‘':'ì—†ìŒ','var(--ok)')+UI.stat('ì„œë¹„ìŠ¤',ps,ps?'ì²˜ë¦¬ ëŒ€ê¸°':'ì™„ë£Œ','var(--purple)')+'</div>'+(!S.company?'<div class="card" style="border-color:rgba(255,184,0,.25);margin-bottom:16px"><div class="card-b" style="display:flex;align-items:center;gap:14px"><span style="font-size:28px">âš ï¸</span><div style="flex:1"><div style="font-weight:700">ì…€ëŸ¬ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</div><div style="font-size:12px;color:var(--w40)">PI/CI ì„œë¥˜ ìë™ ìƒì„±ì— í•„ìš”</div></div><button class="btn btn-acc btn-sm" onclick="App.nav(\'settings\')">ì„¤ì • â†’</button></div></div>':'')+'<div class="grid-2"><div class="card"><div class="card-h">ìµœê·¼ AI ë¶„ì„</div><div class="card-b">'+(S.analyses.length===0?UI.empty('ğŸ”¬','ë¶„ì„ ì—†ìŒ','ì²« ë¶„ì„ì„ ì‹œì‘í•˜ì„¸ìš”'):S.analyses.slice(0,5).map(function(a){return '<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--w08);cursor:pointer" onclick="App.viewA(\''+a.id+'\')"><span style="font-size:20px">ğŸ“Š</span><div style="flex:1"><div style="font-size:13px;font-weight:600">'+U.tr(a.product_name,30)+'</div><div style="font-size:11px;color:var(--w40)">'+U.fd(a.created_at,'rel')+'</div></div>'+UI.sb(a.status)+'</div>';}).join(''))+'</div></div><div class="card"><div class="card-h">ì„œë¹„ìŠ¤ í˜„í™©</div><div class="card-b">'+(S.serviceRequests.length===0?UI.empty('ğŸ’¼','ì„œë¹„ìŠ¤ ì—†ìŒ',''):S.serviceRequests.slice(0,5).map(function(sr){return '<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--w08)"><span style="font-size:18px">'+U.si(sr.service_type)+'</span><div style="flex:1"><div style="font-size:13px;font-weight:600">'+U.sl(sr.service_type)+'</div><div style="font-size:11px;color:var(--w40)">'+U.fd(sr.created_at,'rel')+'</div></div>'+UI.sb(sr.status)+'</div>';}).join(''))+'</div></div></div>';
}

/* â”€â”€ Analysis: page router â”€â”€ */
function pgAnalysis(){
  if(S.currentAnalysis)return pgAReport();
  if(S.analysisStep)return pgAForm();
  return pgAList();
}

/* â”€â”€ Analysis: list view â”€â”€ */
function pgAList(){
  return '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px"><div><h2 style="font-size:18px;font-weight:800">ğŸ”¬ AI ìˆ˜ì¶œ ìƒí’ˆ ë¶„ì„</h2><p style="font-size:13px;color:var(--w40);margin-top:4px">ì œí’ˆ ì •ë³´ë¥¼ ì…ë ¥í•˜ë©´ AIê°€ ìˆ˜ì¶œ ì í•©ë„ë¥¼ ì‹¬ì¸µ ë¶„ì„í•©ë‹ˆë‹¤</p></div><button class="btn btn-pri" onclick="App.startAForm()">+ ìƒˆ ë¶„ì„ ì‹œì‘</button></div>'+
  (S.analyses.length===0?'<div class="card"><div class="card-b">'+UI.empty('ğŸ”¬','ì•„ì§ ë¶„ì„ì´ ì—†ìŠµë‹ˆë‹¤','ì œí’ˆ ì •ë³´, URL, íŒŒì¼ì„ ì…ë ¥í•˜ë©´ AIê°€ ì‹¬ì¸µ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤')+'<div style="text-align:center;margin-top:16px"><button class="btn btn-pri btn-lg" onclick="App.startAForm()">ğŸ”¬ ì²« ë¶„ì„ ì‹œì‘í•˜ê¸°</button></div></div></div>'
  :'<div style="display:flex;flex-direction:column;gap:12px">'+S.analyses.map(function(a){
    var r=a.ai_result||{};var sc=r.overall_score;var col=sc>=80?'var(--ok)':sc>=60?'var(--acc)':'var(--err)';
    return '<div class="card" style="cursor:pointer" onclick="App.viewA(\''+a.id+'\')"><div class="card-b" style="display:flex;align-items:center;gap:16px">'+
      '<div style="width:56px;height:56px;border-radius:12px;background:'+(sc?col+'15':'var(--w08)')+';display:flex;align-items:center;justify-content:center;flex-shrink:0"><span style="font-size:'+(sc?'22px':'28px')+';font-weight:900;color:'+(sc?col:'var(--w20)')+'">'+( sc||'?')+'</span></div>'+
      '<div style="flex:1;min-width:0"><div style="display:flex;align-items:center;gap:8px;margin-bottom:2px"><span style="font-size:14px;font-weight:700">'+a.product_name+'</span>'+UI.badge(a.analysis_type==='premium'?'â­ í”„ë¦¬ë¯¸ì—„':'ë¬´ë£Œ',a.analysis_type==='premium'?'acc':'ghost')+UI.sb(a.status)+'</div>'+
      '<div style="font-size:12px;color:var(--w40)">'+(r.summary?U.tr(r.summary,80):'ë¶„ì„ ëŒ€ê¸° ì¤‘...')+'</div>'+
      '<div style="display:flex;gap:8px;margin-top:6px">'+(r.recommended_markets?(r.recommended_markets||[]).map(function(m){return '<span style="font-size:10px;padding:2px 6px;border-radius:4px;background:var(--w08);color:var(--w60)">'+U.cl(m)+'</span>';}).join(''):'')+'</div></div>'+
      '<div style="text-align:right;flex-shrink:0"><div style="font-size:11px;color:var(--w20)">'+U.fd(a.created_at,'rel')+'</div>'+(r.estimated_fob?'<div style="font-size:12px;color:var(--acc);font-weight:600;margin-top:2px">'+r.estimated_fob+'</div>':'')+'<button class="btn btn-danger btn-sm" onclick="event.stopPropagation();App.delA(\''+a.id+'\')" style="margin-top:6px;font-size:10px;padding:3px 8px">ì‚­ì œ</button></div></div></div>';
  }).join('')+'</div>');
}

/* â”€â”€ Analysis: multi-step input form â”€â”€ */
function startAForm(){S.analysisStep=1;S.analysisData={urls:[''],files:[],selling_points:[],target_markets:['US'],existing_certs:[],price_krw:''};render();}

function pgAForm(){
  var step=S.analysisStep;var d=S.analysisData;
  var steps=['í•„ìˆ˜ ì •ë³´','ì¶”ê°€ ì •ë³´ (ì„ íƒ)'];
  var bar='<div style="display:flex;gap:4px;margin-bottom:24px">'+steps.map(function(s,i){var n=i+1;return '<div style="flex:1"><div style="height:4px;border-radius:2px;background:'+(n<step?'var(--ok)':n===step?'var(--pri)':'var(--w08)')+';margin-bottom:6px"></div><div style="font-size:10px;color:'+(n===step?'var(--pri)':'var(--w40)')+';font-weight:'+(n===step?'700':'400')+'">'+n+'. '+s+'</div></div>';}).join('')+'</div>';
  var hdr='<div style="display:flex;align-items:center;gap:12px;margin-bottom:20px"><button class="btn btn-ghost btn-sm" onclick="App.cancelA()">â† ì·¨ì†Œ</button><h2 style="font-size:18px;font-weight:800">ìƒˆ ë¶„ì„</h2></div>';
  var body='';

  if(step===1){
    var usdShow=d.price_krw?'â‰ˆ $'+(Number(d.price_krw)/1400).toFixed(2)+' USD':'';
    body='<div class="card" style="margin-bottom:14px"><div class="card-h">ğŸ“¦ ì œí’ˆ ì •ë³´</div><div class="card-b"><form id="af1">'+
      UI.inp('product_name','ì œí’ˆëª… *',{placeholder:'ì˜ˆ: ë‹¥í„°ì§€ ë ˆë“œ ë¸”ë ˆë¯¸ì‰¬ ìˆ˜ë”©í¬ë¦¼',value:d.product_name||'',required:true})+
      '<div class="grid-2">'+
        UI.sel('category','ì¹´í…Œê³ ë¦¬',['','K-Beauty','K-Food','K-Health','K-Fashion','K-Electronics','K-Living','Other'],d.category||'')+
        UI.sel('analysis_type','ë¶„ì„ ìœ í˜•',[{value:'free',label:'ğŸ†“ ë¬´ë£Œ ê¸°ë³¸ ë¶„ì„'},{value:'premium',label:'â­ í”„ë¦¬ë¯¸ì—„ (â‚©300~500K)'}],d.analysis_type||'free')+
      '</div>'+
      '<div class="form-group"><label class="form-label">ë‹¨ê°€ (ì›í™” ì…ë ¥ â†’ ìë™ ë‹¬ëŸ¬ í™˜ì‚°)</label><div style="display:flex;gap:10px;align-items:center"><div style="flex:1;position:relative"><span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--w40);font-size:13px">â‚©</span><input class="form-input" name="price_krw" type="number" value="'+(d.price_krw||'')+'" placeholder="5,000" style="padding-left:28px" oninput="App.updateUSD(this.value)"></div><div style="font-size:14px;color:var(--pri);font-weight:700;font-family:JetBrains Mono;min-width:120px;text-align:right" id="usdCalc">'+usdShow+'</div></div><div style="font-size:10px;color:var(--w20);margin-top:4px">ê¸°ì¤€ í™˜ìœ¨: â‚©1,400/USD</div></div>'+
    '</form></div></div>'+
    '<div class="card" style="margin-bottom:14px"><div class="card-h">ğŸ”— ìƒí’ˆ URL Â· ğŸ“ íŒŒì¼</div><div class="card-b">'+
      '<div style="font-size:12px;color:var(--w40);margin-bottom:10px">ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´, ì¿ íŒ¡, ì•Œë¦¬ë°”ë°” ë“± URL ë˜ëŠ” íšŒì‚¬ì†Œê°œì„œ/ì¹´íƒˆë¡œê·¸ë¥¼ ì²¨ë¶€í•˜ë©´ AIê°€ ì •ë³´ë¥¼ ìë™ ìˆ˜ì§‘í•©ë‹ˆë‹¤</div>'+
      d.urls.map(function(u,i){return '<div style="display:flex;gap:8px;margin-bottom:8px"><input class="form-input aurl" value="'+(u||'')+'" placeholder="https://smartstore.naver.com/..." style="flex:1">'+(d.urls.length>1?'<button class="btn btn-danger btn-sm" onclick="App.rmUrl('+i+')">âœ•</button>':'')+'</div>';}).join('')+
      '<button class="btn btn-ghost btn-sm" onclick="App.addUrl()" style="margin-bottom:14px">+ URL ì¶”ê°€</button>'+
      '<div style="border:2px dashed var(--bd-l);border-radius:12px;padding:20px;text-align:center;cursor:pointer;transition:all .15s" onclick="document.getElementById(\'fileUp\').click()" onmouseover="this.style.borderColor=\'var(--pri)\'" onmouseout="this.style.borderColor=\'var(--bd-l)\'">'+
        '<div style="font-size:24px;margin-bottom:4px">ğŸ“„</div>'+
        '<div style="font-size:12px;color:var(--w40)">í´ë¦­í•˜ì—¬ íŒŒì¼ ì²¨ë¶€ (PDF, ì´ë¯¸ì§€, Excel, HWP)</div>'+
        '<input type="file" id="fileUp" multiple accept=".pdf,.jpg,.jpeg,.png,.xlsx,.xls,.hwp,.doc,.docx" style="display:none" onchange="App.addFiles(this.files)">'+
      '</div>'+
      (d.files.length?'<div style="margin-top:10px">'+d.files.map(function(f,i){var icons={pdf:'ğŸ“•',jpg:'ğŸ–¼ï¸',jpeg:'ğŸ–¼ï¸',png:'ğŸ–¼ï¸',xlsx:'ğŸ“Š',docx:'ğŸ“',hwp:'ğŸ“„'};var ext=(f.name||'').split('.').pop().toLowerCase();return '<div style="display:flex;align-items:center;gap:10px;padding:6px 10px;border-radius:8px;background:var(--w08);margin-bottom:4px"><span>'+(icons[ext]||'ğŸ“')+'</span><span style="flex:1;font-size:12px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+f.name+'</span><span style="font-size:11px;color:var(--w20)">'+(f.size/1024).toFixed(0)+'KB</span><button class="btn btn-danger btn-sm" onclick="App.rmFile('+i+')" style="padding:2px 6px">âœ•</button></div>';}).join('')+'</div>':'')+
    '</div></div>'+
    '<div style="display:flex;justify-content:space-between;margin-top:20px"><div></div><div style="display:flex;gap:8px"><button class="btn btn-ghost" onclick="App.aStep(2)">ì¶”ê°€ ì •ë³´ ì…ë ¥ â†’</button><button class="btn btn-pri btn-lg" onclick="App.submitA()">ğŸ”¬ ë°”ë¡œ ë¶„ì„ ì‹œì‘</button></div></div>';
  }else{
    var mkts=[{v:'US',l:'ğŸ‡ºğŸ‡¸ ë¯¸êµ­'},{v:'JP',l:'ğŸ‡¯ğŸ‡µ ì¼ë³¸'},{v:'CN',l:'ğŸ‡¨ğŸ‡³ ì¤‘êµ­'},{v:'EU',l:'ğŸ‡ªğŸ‡º ìœ ëŸ½'},{v:'SEA',l:'ğŸŒ ë™ë‚¨ì•„'},{v:'ME',l:'ğŸ•Œ ì¤‘ë™'},{v:'LATAM',l:'ğŸŒ ë‚¨ë¯¸'},{v:'AU',l:'ğŸ‡¦ğŸ‡º í˜¸ì£¼'}];
    var certs=['FDA','CE','CPNP','NMPA','Halal','Kosher','ISO 22716','GMP','KFDA','JAS','Ecocert','USDA Organic'];
    body='<div class="card" style="margin-bottom:14px"><div class="card-h">ğŸŒ íƒ€ê²Ÿ ì‹œì¥ <span style="font-size:11px;color:var(--w20);font-weight:400">(ì„ íƒ)</span></div><div class="card-b">'+
      '<div style="display:flex;flex-wrap:wrap;gap:8px">'+mkts.map(function(m){var sel=d.target_markets&&d.target_markets.indexOf(m.v)>=0;return '<div onclick="App.toggleMkt(\''+m.v+'\')" style="padding:8px 14px;border-radius:10px;border:1.5px solid '+(sel?'var(--pri)':'var(--bd)')+';background:'+(sel?'rgba(0,212,255,.08)':'transparent')+';cursor:pointer;font-size:13px;font-weight:'+(sel?'600':'400')+';color:'+(sel?'var(--pri)':'var(--w60)')+';transition:all .15s">'+m.l+'</div>';}).join('')+'</div></div></div>'+
    '<div class="card" style="margin-bottom:14px"><div class="card-h">ğŸ… ë³´ìœ  ì¸ì¦ <span style="font-size:11px;color:var(--w20);font-weight:400">(ì„ íƒ)</span></div><div class="card-b">'+
      '<div style="display:flex;flex-wrap:wrap;gap:6px">'+certs.map(function(c){var sel=d.existing_certs&&d.existing_certs.indexOf(c)>=0;return '<div onclick="App.toggleCert(\''+c+'\')" style="padding:5px 12px;border-radius:8px;border:1.5px solid '+(sel?'var(--ok)':'var(--bd)')+';background:'+(sel?'rgba(0,230,118,.08)':'transparent')+';cursor:pointer;font-size:12px;font-weight:'+(sel?'600':'400')+';color:'+(sel?'var(--ok)':'var(--w60)')+';transition:all .15s">'+c+'</div>';}).join('')+'</div></div></div>'+
    '<div class="card" style="margin-bottom:14px"><div class="card-h">ğŸ’¡ ì…€ë§ í¬ì¸íŠ¸ <span style="font-size:11px;color:var(--w20);font-weight:400">(ì„ íƒ)</span></div><div class="card-b">'+
      (d.selling_points.length?d.selling_points.map(function(s,i){return '<div style="display:flex;gap:8px;margin-bottom:8px"><input class="form-input asp" value="'+(s||'')+'" placeholder="ì˜ˆ: í”¼ë¶€ê³¼ ì „ë¬¸ì˜ í…ŒìŠ¤íŠ¸ ì™„ë£Œ" style="flex:1"><button class="btn btn-danger btn-sm" onclick="App.rmSP('+i+')">âœ•</button></div>';}).join(''):'')+
      '<button class="btn btn-ghost btn-sm" onclick="App.addSP()">+ ì…€ë§ í¬ì¸íŠ¸ ì¶”ê°€</button>'+
    '</div></div>'+
    '<div class="card" style="margin-bottom:14px"><div class="card-h">ğŸ“‹ ê¸°íƒ€ <span style="font-size:11px;color:var(--w20);font-weight:400">(ì„ íƒ)</span></div><div class="card-b">'+
      '<div class="grid-2">'+
        UI.inp('product_name_en','ì˜ë¬¸ëª…',{placeholder:'Dr.G Red Blemish Cream',value:d.product_name_en||''})+
        UI.inp('brand_name','ë¸Œëœë“œ',{placeholder:'Dr.G',value:d.brand_name||''})+
      '</div>'+
      UI.ta('special_requirements','ìš”ì²­ì‚¬í•­',{placeholder:'ì˜ˆ: ì•„ë§ˆì¡´ FBA ì…ì  í¬ë§',value:d.special_requirements||'',rows:2})+
    '</div></div>'+
    '<div style="display:flex;justify-content:space-between;margin-top:20px"><button class="btn btn-ghost" onclick="App.aStep(1)">â† ì´ì „</button><button class="btn btn-pri btn-lg" onclick="App.submitA()">ğŸ”¬ ë¶„ì„ ì‹œì‘</button></div>';
  }
  return hdr+bar+body;
}

function updateUSD(v){var el=document.getElementById('usdCalc');if(el)el.textContent=v?'â‰ˆ $'+(Number(v)/1400).toFixed(2)+' USD':'';S.analysisData.price_krw=v;}

function aStep(n){
  var d=S.analysisData;
  if(S.analysisStep===1){
    var f=document.querySelector('#af1');if(f){var fd=UI.fd(f);Object.assign(d,fd);}
    d.urls=Array.from(document.querySelectorAll('.aurl')).map(function(e){return e.value;});
    if(n>1&&!d.product_name){UI.toast('ì œí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”','warn');return;}
    if(d.price_krw)d.fob_price=(Number(d.price_krw)/1400).toFixed(2);
  }
  if(S.analysisStep===2){
    d.selling_points=Array.from(document.querySelectorAll('.asp')).map(function(e){return e.value;});
    var els=document.querySelectorAll('.card-b input[name],.card-b textarea[name]');els.forEach(function(el){if(el.name)d[el.name]=el.value;});
  }
  S.analysisStep=n;render();
}
function cancelA(){S.analysisStep=0;S.analysisData=null;render();}
function addUrl(){S.analysisData.urls.push('');render();}
function rmUrl(i){S.analysisData.urls.splice(i,1);render();}
function addSP(){S.analysisData.selling_points.push('');render();}
function rmSP(i){S.analysisData.selling_points.splice(i,1);render();}
function addFiles(fl){for(var i=0;i<fl.length;i++)S.analysisData.files.push(fl[i]);render();}
function rmFile(i){S.analysisData.files.splice(i,1);render();}
function toggleMkt(m){var d=S.analysisData;if(!d.target_markets)d.target_markets=[];var i=d.target_markets.indexOf(m);if(i>=0)d.target_markets.splice(i,1);else d.target_markets.push(m);render();}
function toggleCert(c){var d=S.analysisData;if(!d.existing_certs)d.existing_certs=[];var i=d.existing_certs.indexOf(c);if(i>=0)d.existing_certs.splice(i,1);else d.existing_certs.push(c);render();}

/* â”€â”€ Analysis: submit â”€â”€ */
function submitA(){
  var d=S.analysisData;
  /* collect current step data */
  if(S.analysisStep===1){
    var f=document.querySelector('#af1');if(f){var fd=UI.fd(f);Object.assign(d,fd);}
    d.urls=Array.from(document.querySelectorAll('.aurl')).map(function(e){return e.value;});
    if(d.price_krw)d.fob_price=(Number(d.price_krw)/1400).toFixed(2);
  }
  if(S.analysisStep===2){
    d.selling_points=Array.from(document.querySelectorAll('.asp')).map(function(e){return e.value;});
    var els=document.querySelectorAll('.card-b input[name],.card-b textarea[name]');els.forEach(function(el){if(el.name)d[el.name]=el.value;});
  }
  if(!d||!d.product_name){UI.toast('ì œí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”','warn');return;}
  var urls=d.urls.filter(function(u){return u;});
  var sp=d.selling_points.filter(function(s){return s;});
  sb.from('analyses').insert({user_id:S.user.id,product_name:d.product_name,product_url:urls[0]||null,analysis_type:d.analysis_type||'free',status:'analyzing',ai_result:{input_data:{product_name_en:d.product_name_en,category:d.category,fob_price:d.fob_price,moq:d.moq,description:d.description,urls:urls,files:d.files.map(function(f){return f.name;}),selling_points:sp,target_markets:d.target_markets,existing_certs:d.existing_certs,brand_name:d.brand_name,manufacturer:d.manufacturer,export_experience:d.export_experience,annual_capacity:d.annual_capacity,special_requirements:d.special_requirements}}}).select().single().then(function(r){
    if(r.error){UI.toast('ì‹¤íŒ¨: '+r.error.message,'err');return;}
    S.analyses.unshift(r.data);S.analysisStep=0;S.analysisData=null;
    set({currentAnalysis:r.data});UI.toast('AIê°€ ì‹¤ì œ ìˆ˜ì¶œ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... (30ì´ˆ~1ë¶„ ì†Œìš”)','info');
    /* AI ë¶„ì„ API í˜¸ì¶œ */
    fetch(RELAY_URL+'/api/whistle/analyze',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({product_name:d.product_name,product_name_en:d.product_name_en,category:d.category,fob_price:d.fob_price,moq:d.moq,description:d.description,urls:(d.urls||[]).filter(function(u){return u;}),files:(d.files||[]).map(function(f){return f.name||f;}),selling_points:(d.selling_points||[]).filter(function(s){return s;}),target_markets:d.target_markets,existing_certs:d.existing_certs,brand_name:d.brand_name,manufacturer:d.manufacturer,export_experience:d.export_experience,annual_capacity:d.annual_capacity,special_requirements:d.special_requirements})}).then(function(resp){return resp.json();}).then(function(data){
      if(!data.ok)throw new Error(data.error||'ë¶„ì„ ì‹¤íŒ¨');
      var res=data.result;
      res.input_data={product_name_en:d.product_name_en,category:d.category,fob_price:d.fob_price,moq:d.moq,description:d.description,urls:(d.urls||[]).filter(function(u){return u;}),files:(d.files||[]).map(function(f){return f.name||f;}),selling_points:(d.selling_points||[]).filter(function(s){return s;}),target_markets:d.target_markets,existing_certs:d.existing_certs,brand_name:d.brand_name,manufacturer:d.manufacturer};
      sb.from('analyses').update({status:'completed',ai_result:res}).eq('id',r.data.id).then(function(){
        autoCreateProduct(r.data.id,res,d.product_name);
        loadA().then(function(){var ua=S.analyses.find(function(x){return x.id===r.data.id;});set({currentAnalysis:ua||Object.assign({},r.data,{status:'completed',ai_result:res})});UI.toast('AI ë¶„ì„ ì™„ë£Œ!','ok');});
      });
    }).catch(function(err){
      console.warn('AI API ì‹¤íŒ¨, í´ë°± ëª¨ë“œ:',err);UI.toast('AI ì„œë²„ ì—°ê²° ì‹¤íŒ¨, ê¸°ë³¸ ë¶„ì„ ì‚¬ìš©','warn');
      var res=genReport(d);
      sb.from('analyses').update({status:'completed',ai_result:res}).eq('id',r.data.id).then(function(){
        autoCreateProduct(r.data.id,res,d.product_name);
        loadA().then(function(){var ua=S.analyses.find(function(x){return x.id===r.data.id;});set({currentAnalysis:ua||Object.assign({},r.data,{status:'completed',ai_result:res})});UI.toast('ë¶„ì„ ì™„ë£Œ (ê¸°ë³¸ ëª¨ë“œ)','ok');});
      });
    });
  });
}

/* â”€â”€ Auto-create product from analysis â”€â”€ */
function autoCreateProduct(analysisId,res,productName){
  var inp=res.input_data||{};
  var prod={user_id:S.user.id,analysis_id:analysisId,name_ko:productName||inp.product_name_en||'',name_en:inp.product_name_en||'',category:inp.category||null,hs_code:res.hs_code||null,fob_price:inp.fob_price||null,moq:inp.moq||null,certifications:res.existing_certs||[],status:'draft'};
  sb.from('products').insert(prod).select().single().then(function(r2){
    if(r2.error){console.warn('ìë™ ì œí’ˆë“±ë¡ ì‹¤íŒ¨:',r2.error.message);return;}
    loadP().then(function(){UI.toast('ì œí’ˆ ìë™ ë“±ë¡: '+prod.name_ko,'ok');});
  });
}

/* â”€â”€ AI ì˜ë¬¸ ì¹´íƒˆë¡œê·¸ ìƒì„± â”€â”€ */
function genCatalogEN(productId){
  var p=S.products.find(function(x){return x.id===productId;});if(!p){UI.toast('ì œí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤','err');return;}
  UI.toast('AI ì˜ë¬¸ ì¹´íƒˆë¡œê·¸ ìƒì„± ì¤‘...','info');
  fetch(RELAY_URL+'/api/whistle/catalog-en',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name_ko:p.name_ko,name_en:p.name_en,category:p.category,fob_price:p.fob_price,moq:p.moq,description_ko:p.description_ko,certifications:p.certifications,specifications:p.specifications})}).then(function(r){return r.json();}).then(function(data){
    if(!data.ok)throw new Error(data.error||'ìƒì„± ì‹¤íŒ¨');
    var res=data.result;
    sb.from('products').update({description_en:res.description_en,specifications:Object.assign(p.specifications||{},{ai_catalog:res})}).eq('id',productId).then(function(r2){
      if(r2.error){UI.toast('ì €ì¥ ì‹¤íŒ¨','err');return;}
      loadP().then(function(){UI.toast('ì˜ë¬¸ ì¹´íƒˆë¡œê·¸ ìƒì„± ì™„ë£Œ!','ok');closeModal('pm');render();});
    });
  }).catch(function(err){UI.toast('ì¹´íƒˆë¡œê·¸ ìƒì„± ì‹¤íŒ¨: '+err.message,'err');});
}

/* â”€â”€ Analysis: fallback report generator (AI ì„œë²„ ë¯¸ì—°ê²° ì‹œ ì‚¬ìš©) â”€â”€ */
function genReport(d){
  var cat=d.category||'K-Beauty';var price=d.fob_price||5;var mkts=d.target_markets||['US','JP','SEA'];
  var sc={overall:70+Math.floor(Math.random()*25),market_fit:72+Math.floor(Math.random()*23),competition:55+Math.floor(Math.random()*30),regulatory:60+Math.floor(Math.random()*30),price_comp:65+Math.floor(Math.random()*28),brand_power:50+Math.floor(Math.random()*35),logistics:68+Math.floor(Math.random()*25)};
  var catData={
    'K-Beauty':{hs:'3304.99',certs:['FDA (OTC/Cosmetic)','CPNP (EU)','NMPA (ì¤‘êµ­)'],trend:'ê¸€ë¡œë²Œ K-ë·°í‹° ì‹œì¥ $12.5B ê·œëª¨, ì—° 9.4% ì„±ì¥. ì‹œì¹´/ìŠ¤ë„¤ì¼ ì„±ë¶„ íŠ¸ë Œë“œ ì§€ì†.',channels:['ì•„ë§ˆì¡´ FBA','Qoo10 Japan','Shopee SEA','TikTok Shop']},
    'K-Food':{hs:'1902.30',certs:['FDA (ì‹í’ˆ)','Halal','JAS (ì¼ë³¸)'],trend:'K-Food ìˆ˜ì¶œ $10B ëŒíŒŒ. ë¼ë©´/ì†ŒìŠ¤ë¥˜ SNS ë°”ì´ëŸ´ íš¨ê³¼ ê·¹ëŒ€.',channels:['ì½”ìŠ¤íŠ¸ì½”','H-Mart','ì•„ë§ˆì¡´ Pantry','ì´ì˜¨ëª°']},
    'K-Health':{hs:'2106.90',certs:['FDA (Dietary Supplement)','Health Canada','TGA (í˜¸ì£¼)'],trend:'ê¸€ë¡œë²Œ ê±´ê¸°ì‹ ì‹œì¥ $180B. í™ì‚¼/í”„ë¡œë°”ì´ì˜¤í‹±ìŠ¤ í•œêµ­ ì›ë£Œ ì‹ ë¢°ë„ ìƒìŠ¹.',channels:['iHerb','ì•„ë§ˆì¡´','ë“œëŸ­ìŠ¤í† ì–´ ì²´ì¸','ê±´ê°•ì‹í’ˆ ì „ë¬¸ì ']},
    'K-Fashion':{hs:'6204.33',certs:['CE (ì„¬ìœ )','OEKO-TEX'],trend:'K-íŒ¨ì…˜ í•œë¥˜ íš¨ê³¼. ìŠ¤íŠ¸ë¦¬íŠ¸ì›¨ì–´/ë·°í‹°íŒ¨ì…˜ ìœµí•© íŠ¸ë Œë“œ.',channels:['ASOS','Farfetch','ìì‚¬ëª° D2C','íŒì—…ìŠ¤í† ì–´']},
    'K-Electronics':{hs:'8471.30',certs:['FCC','CE','KC'],trend:'ì†Œí˜• ê°€ì „ ë° IoT ë””ë°”ì´ìŠ¤ ìˆ˜ì¶œ ì„±ì¥. í˜ì‹  ë””ìì¸ í‰ê°€.',channels:['ì•„ë§ˆì¡´','ë² ìŠ¤íŠ¸ë°”ì´','ì•Œë¦¬ìµìŠ¤í”„ë ˆìŠ¤','í‚¥ìŠ¤íƒ€í„°']},
    'K-Living':{hs:'3924.90',certs:['FDA (ì‹ê¸°ë¥˜)','CE'],trend:'ë¯¸ë‹ˆë©€ ë””ìì¸ í•œêµ­ ë¦¬ë¹™ ì œí’ˆ ì¸ê¸°. ì¹œí™˜ê²½ ì†Œì¬ í”„ë¦¬ë¯¸ì—„.',channels:['ì•„ë§ˆì¡´','ì´ì¼€ì•„ ë§ˆì¼“í”Œë ˆì´ìŠ¤','Wayfair','í¬ë ˆì´íŠ¸ì•¤ë°°ëŸ´']}
  };
  var cd=catData[cat]||catData['K-Beauty'];
  var mktAnalysis=mkts.map(function(m){
    var data={US:{name:'ë¯¸êµ­',size:'$580B',grow:'+4.2%',entry:'ì¤‘ê°„',note:'FDA ë“±ë¡ í•„ìˆ˜. ì•„ë§ˆì¡´ FBA ìµœì . í•œì¸ë§ˆíŠ¸ ì±„ë„ë„ ìœ íš¨.'},JP:{name:'ì¼ë³¸',size:'$330B',grow:'+2.1%',entry:'ë†’ìŒ',note:'í’ˆì§ˆ ê¸°ì¤€ ê¹Œë‹¤ë¡œì›€. Qoo10/ë¼ì¿ í… ì±„ë„. PMDA í†µë³´ í•„ìš”.'},CN:{name:'ì¤‘êµ­',size:'$820B',grow:'+6.8%',entry:'ë§¤ìš° ë†’ìŒ',note:'NMPA ë“±ë¡ í•„ìˆ˜. ë™ë¬¼ì‹¤í—˜ ì´ìŠˆ. ë”°ì´ê³µ/ì™•í™ ë§ˆì¼€íŒ… ì¤‘ìš”.'},EU:{name:'ìœ ëŸ½',size:'$450B',grow:'+3.5%',entry:'ë†’ìŒ',note:'CPNP ë“±ë¡. ì„±ë¶„ ê·œì œ ì—„ê²©. ë…ì¼/í”„ë‘ìŠ¤ê°€ ìµœëŒ€ ì‹œì¥.'},SEA:{name:'ë™ë‚¨ì•„',size:'$120B',grow:'+8.5%',entry:'ë‚®ìŒ',note:'Shopee/Lazada ì¤‘ì‹¬. í• ë„ ì¸ì¦ ì‹œ ì‹œì¥ 2ë°°. ê°€ê²© ë¯¼ê°.'},ME:{name:'ì¤‘ë™',size:'$45B',grow:'+7.2%',entry:'ì¤‘ê°„',note:'í• ë„ ì¸ì¦ í•„ìˆ˜. ë‘ë°”ì´ í—ˆë¸Œ í™œìš©. í”„ë¦¬ë¯¸ì—„ ì„ í˜¸.'},AU:{name:'í˜¸ì£¼',size:'$28B',grow:'+3.8%',entry:'ì¤‘ê°„',note:'TGA ë“±ë¡. í´ë¦°ë·°í‹° íŠ¸ë Œë“œ. í•œì¸ ì»¤ë®¤ë‹ˆí‹° í…ŒìŠ¤íŠ¸ ì‹œì¥.'},LATAM:{name:'ë‚¨ë¯¸',size:'$65B',grow:'+5.5%',entry:'ì¤‘ê°„',note:'ë¸Œë¼ì§ˆ/ë©•ì‹œì½” ì¤‘ì‹¬. ANVISA ë“±ë¡. í•œë¥˜ ì˜í–¥ë ¥ ì„±ì¥ ì¤‘.'}};
    return data[m]||{name:m,size:'â€”',grow:'â€”',entry:'â€”',note:'â€”'};
  });
  var existCerts=(d.existing_certs||[]);var needCerts=cd.certs.filter(function(c){var base=c.split(' ')[0];return existCerts.indexOf(base)<0&&existCerts.indexOf(c)<0;});
  return {
    overall_score:sc.overall,market_fit:sc.market_fit,competition:sc.competition,regulatory:sc.regulatory,price_competitiveness:sc.price_comp,brand_power:sc.brand_power,logistics_score:sc.logistics,
    estimated_fob:price?'$'+price.toFixed(1)+'~$'+(price*1.4).toFixed(1):'$3.0~$8.0',hs_code:cd.hs,
    required_certs:needCerts,existing_certs:existCerts,
    recommended_markets:mkts,market_analysis:mktAnalysis,
    industry_trend:cd.trend,recommended_channels:cd.channels,
    summary:d.product_name+'ì˜ ìˆ˜ì¶œ ì í•©ë„ ì¢…í•© ì ìˆ˜ '+sc.overall+'ì . '+(sc.overall>=80?'ë§¤ìš° ìœ ë§í•œ ìˆ˜ì¶œ ìƒí’ˆì…ë‹ˆë‹¤. ':sc.overall>=65?'ìˆ˜ì¶œ ê°€ëŠ¥ì„±ì´ ë†’ìœ¼ë‚˜ ì¼ë¶€ ë³´ì™„ì´ í•„ìš”í•©ë‹ˆë‹¤. ':'ìˆ˜ì¶œ ì „ ì¶”ê°€ ì¤€ë¹„ê°€ í•„ìš”í•©ë‹ˆë‹¤. ')+cd.trend,
    executive_summary:(d.product_name||'ë³¸ ì œí’ˆ')+'ì€(ëŠ”) '+cat+' ì¹´í…Œê³ ë¦¬ì—ì„œ '+(sc.market_fit>=80?'ë†’ì€ ì‹œì¥ ì í•©ë„':'ë³´í†µ ìˆ˜ì¤€ì˜ ì‹œì¥ ì í•©ë„')+'ë¥¼ ë³´ì´ë©°, '+(mkts.length?mkts.slice(0,2).map(function(m){return U.cl(m);}).join(', '):'ë¯¸êµ­')+'ì„ 1ì°¨ íƒ€ê²Ÿ ì‹œì¥ìœ¼ë¡œ ì¶”ì²œí•©ë‹ˆë‹¤. '+(price?'FOB $'+price+' ê¸°ì¤€ ':'')+(sc.price_comp>=75?'ê°€ê²© ê²½ìŸë ¥ì´ ìš°ìˆ˜í•˜ë©°, ':'ê°€ê²© ì¡°ì •ì´ í•„ìš”í•  ìˆ˜ ìˆìœ¼ë©°, ')+(needCerts.length?needCerts.length+'ê°œ ì¶”ê°€ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.':'ì¸ì¦ ì¤€ë¹„ê°€ ì–‘í˜¸í•©ë‹ˆë‹¤.')+' '+(d.selling_points&&d.selling_points.filter(function(s){return s;}).length?'ì£¼ìš” ì…€ë§í¬ì¸íŠ¸('+d.selling_points.filter(function(s){return s;}).slice(0,2).join(', ')+')ë¥¼ í™œìš©í•œ ë§ˆì¼€íŒ… ì „ëµì´ ìœ íš¨í•©ë‹ˆë‹¤.':''),
    opportunities:[(sc.market_fit>=75?cat+' ê¸€ë¡œë²Œ ìˆ˜ìš” ì¦ê°€ íŠ¸ë Œë“œ':'ê¸€ë¡œë²Œ ì‹œì¥ ì§„ì¶œ ê¸°íšŒ'),(d.selling_points&&d.selling_points[0]?d.selling_points[0]+' ì°¨ë³„í™” í¬ì¸íŠ¸ í™œìš©':'ë…ìì  ì œí’ˆë ¥ í™œìš© ê°€ëŠ¥'),'K-ì½˜í…ì¸  í•œë¥˜ ì‹œë„ˆì§€ ë§ˆì¼€íŒ…',cd.channels[0]+' ì±„ë„ ì…ì  ê¸°íšŒ',(existCerts.length?'ê¸° ë³´ìœ  ì¸ì¦('+existCerts.join(',')+') í™œìš© ê°€ëŠ¥':'ì¸ì¦ ì·¨ë“ ì‹œ ì‹œì¥ í™•ëŒ€ ê°€ëŠ¥')],
    risks:[needCerts.length?needCerts[0]+' ë“± '+needCerts.length+'ê°œ ì¸ì¦ ë¯¸ë³´ìœ ':'ì¸ì¦ ìœ ì§€ ê´€ë¦¬ í•„ìš”',(sc.competition<70?'ê²½ìŸ ì œí’ˆ ëŒ€ë¹„ ì°¨ë³„í™” í•„ìš”':'ê²½ìŸ ì‹¬í™” ì¶”ì„¸ ëª¨ë‹ˆí„°ë§'),'í™˜ìœ¨ ë³€ë™ ë¦¬ìŠ¤í¬ (ì›/ë‹¬ëŸ¬)','í•´ì™¸ ìœ í†µ ì±„ë„ í™•ë³´ ë‚œì´ë„',(sc.regulatory<70?'ê·œì œ ëŒ€ì‘ ì¤€ë¹„ í•„ìš”':'ìˆ˜ì¶œêµ­ë³„ ê·œì œ ë³€í™” ëª¨ë‹ˆí„°ë§')],
    action_plan:[{phase:'1ë‹¨ê³„ (1~2ê°œì›”)',title:'ì¤€ë¹„',items:['ìˆ˜ì¶œ ì¸ì¦ ì¤€ë¹„: '+(needCerts.slice(0,2).join(', ')||'ê¸°ì¡´ ì¸ì¦ ì ê²€'),'ì˜ë¬¸ ì œí’ˆì¹´ë“œ/ì¹´íƒˆë¡œê·¸ ì œì‘','FOB ê°€ê²© í™•ì • ë° ê²¬ì ì„œ ì¤€ë¹„']},{phase:'2ë‹¨ê³„ (2~4ê°œì›”)',title:'ì¸ì¦ & ë°”ì´ì–´ ë°œêµ´',items:[(needCerts[0]||'ì¶”ê°€ ì¸ì¦')+' ë“±ë¡ ì§„í–‰','ë°”ì´ì–´ ë¦¬ìŠ¤íŠ¸ í™•ë³´ ë° ì»¨íƒ','ìƒ˜í”Œ ì¤€ë¹„ ë° ë°œì†¡']},{phase:'3ë‹¨ê³„ (4~6ê°œì›”)',title:'ìˆ˜ì¶œ ê°œì‹œ',items:['ì²« ì˜¤ë” í˜‘ìƒ ë° ê³„ì•½','PI/CI/PL ì„œë¥˜ ì‘ì„±','ë¬¼ë¥˜/í†µê´€ ì§„í–‰ ë° ì„ ì ']}],
    input_data:{product_name_en:d.product_name_en,category:cat,fob_price:d.fob_price,moq:d.moq,description:d.description,urls:(d.urls||[]).filter(function(u){return u;}),files:(d.files||[]).map(function(f){return f.name;}),selling_points:(d.selling_points||[]).filter(function(s){return s;}),target_markets:mkts,existing_certs:existCerts,brand_name:d.brand_name,manufacturer:d.manufacturer}
  };
}

/* â”€â”€ Analysis: report view â”€â”€ */
function pgAReport(){
  var a=S.currentAnalysis,r=a.ai_result||{};
  if(a.status==='analyzing')return '<div style="text-align:center;padding:60px"><div class="spinner" style="width:48px;height:48px;border-width:4px;margin:0 auto 20px"></div><div style="font-size:18px;font-weight:700">AIê°€ ì‹¬ì¸µ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</div><div style="font-size:13px;color:var(--w40);margin-top:8px">'+a.product_name+'</div><div style="font-size:12px;color:var(--w20);margin-top:16px">URL í¬ë¡¤ë§ â†’ íŒŒì¼ ë¶„ì„ â†’ ì‹œì¥ ë°ì´í„° ìˆ˜ì§‘ â†’ ë¦¬í¬íŠ¸ ìƒì„±</div><div style="display:flex;justify-content:center;gap:6px;margin-top:20px"><div style="width:8px;height:8px;border-radius:50%;background:var(--pri);animation:spin .8s linear infinite"></div><div style="width:8px;height:8px;border-radius:50%;background:var(--acc);animation:spin .8s linear infinite .2s"></div><div style="width:8px;height:8px;border-radius:50%;background:var(--ok);animation:spin .8s linear infinite .4s"></div></div></div>';
  var sc=function(s){return s>=80?'var(--ok)':s>=60?'var(--acc)':'var(--err)';};
  var bar=function(label,val,max){max=max||100;var pct=Math.min(val/max*100,100);var col=sc(val);return '<div style="margin-bottom:10px"><div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="font-size:12px;color:var(--w60)">'+label+'</span><span style="font-size:12px;font-weight:700;color:'+col+'">'+val+'/'+max+'</span></div><div style="height:6px;border-radius:3px;background:var(--w08)"><div style="height:100%;border-radius:3px;background:'+col+';width:'+pct+'%;transition:width .5s ease"></div></div></div>';};
  var hdr='<div style="display:flex;align-items:center;gap:12px;margin-bottom:20px"><button class="btn btn-ghost btn-sm" onclick="App.set({currentAnalysis:null})">â† ëª©ë¡</button><h2 style="font-size:18px;font-weight:800;flex:1">'+a.product_name+'</h2>'+UI.badge(a.analysis_type==='premium'?'â­ í”„ë¦¬ë¯¸ì—„':'ğŸ†“ ë¬´ë£Œ',a.analysis_type==='premium'?'acc':'ghost')+'<span style="font-size:12px;color:var(--w20)">'+U.fd(a.created_at)+'</span></div>';
  var scoreCard='<div style="display:flex;gap:16px;margin-bottom:16px"><div style="width:140px;height:140px;border-radius:50%;border:6px solid '+sc(r.overall_score)+';display:flex;flex-direction:column;align-items:center;justify-content:center;flex-shrink:0"><div style="font-size:36px;font-weight:900;color:'+sc(r.overall_score)+'">'+( r.overall_score||'â€”')+'</div><div style="font-size:10px;color:var(--w40)">ì¢…í•© ì ìˆ˜</div></div><div style="flex:1">'+bar('ì‹œì¥ ì í•©ë„',r.market_fit||0)+bar('ê°€ê²© ê²½ìŸë ¥',r.price_competitiveness||0)+bar('ë¸Œëœë“œ íŒŒì›Œ',r.brand_power||0)+bar('ê²½ìŸ í™˜ê²½',r.competition||0)+bar('ê·œì œ ëŒ€ì‘',r.regulatory||0)+bar('ë¬¼ë¥˜ ì í•©ì„±',r.logistics_score||0)+'</div></div>';
  var execSummary='<div class="card" style="margin-bottom:14px;border-color:rgba(0,212,255,.15)"><div class="card-b"><div style="font-size:15px;font-weight:700;margin-bottom:10px">ğŸ“‹ Executive Summary</div><p style="font-size:13px;color:var(--w70);line-height:1.9">'+(r.executive_summary||r.summary||'â€”')+'</p></div></div>';
  var mktSection='';if(r.market_analysis&&r.market_analysis.length){mktSection='<div class="card" style="margin-bottom:14px"><div class="card-h">ğŸŒ ì‹œì¥ë³„ ë¶„ì„</div><div class="card-b" style="padding:0"><table class="tbl"><thead><tr><th>ì‹œì¥</th><th>ê·œëª¨</th><th>ì„±ì¥ë¥ </th><th>ì§„ì…ì¥ë²½</th><th>ë¶„ì„</th></tr></thead><tbody>'+r.market_analysis.map(function(m){var ecol=m.entry==='ë‚®ìŒ'?'var(--ok)':m.entry==='ì¤‘ê°„'?'var(--acc)':'var(--err)';return '<tr><td style="font-weight:700">'+m.name+'</td><td style="font-family:JetBrains Mono;font-size:12px">'+m.size+'</td><td style="color:var(--ok)">'+m.grow+'</td><td><span style="color:'+ecol+'">'+m.entry+'</span></td><td style="font-size:12px;color:var(--w60)">'+m.note+'</td></tr>';}).join('')+'</tbody></table></div></div>';}
  var certSection='<div class="card" style="margin-bottom:14px"><div class="card-h">ğŸ… ì¸ì¦ í˜„í™©</div><div class="card-b">'+((r.existing_certs||[]).length?'<div style="margin-bottom:12px"><div style="font-size:12px;color:var(--w40);margin-bottom:6px">ë³´ìœ  ì¸ì¦</div><div style="display:flex;flex-wrap:wrap;gap:6px">'+(r.existing_certs||[]).map(function(c){return '<span class="badge badge-ok">âœ“ '+c+'</span>';}).join('')+'</div></div>':'')+((r.required_certs||[]).length?'<div><div style="font-size:12px;color:var(--w40);margin-bottom:6px">ì¶”ê°€ í•„ìš” ì¸ì¦</div><div style="display:flex;flex-wrap:wrap;gap:6px">'+(r.required_certs||[]).map(function(c){return '<span class="badge badge-err">âš  '+c+'</span>';}).join('')+'</div></div>':'<div style="color:var(--ok);font-size:13px">âœ“ ì¸ì¦ ì¤€ë¹„ ì–‘í˜¸</div>')+'</div></div>';
  var trendSection='<div class="card" style="margin-bottom:14px"><div class="card-h">ğŸ“ˆ ì‚°ì—… íŠ¸ë Œë“œ</div><div class="card-b"><p style="font-size:13px;color:var(--w70);line-height:1.8">'+(r.industry_trend||'â€”')+'</p>'+((r.recommended_channels||[]).length?'<div style="margin-top:12px"><div style="font-size:12px;color:var(--w40);margin-bottom:6px">ì¶”ì²œ ìœ í†µ ì±„ë„</div><div style="display:flex;flex-wrap:wrap;gap:6px">'+r.recommended_channels.map(function(c){return '<span class="badge badge-pri">'+c+'</span>';}).join('')+'</div></div>':'')+'</div></div>';
  var oppRisk='<div class="grid-2" style="margin-bottom:14px"><div class="card"><div class="card-b"><div style="font-weight:700;color:var(--ok);margin-bottom:10px">âœ… ê¸°íšŒ ìš”ì¸</div>'+(r.opportunities||[]).map(function(o,i){return '<div style="display:flex;gap:8px;padding:6px 0;border-bottom:1px solid var(--w08)"><span style="color:var(--ok);font-weight:700;font-size:12px">'+(i+1)+'</span><span style="font-size:13px;color:var(--w70)">'+o+'</span></div>';}).join('')+'</div></div><div class="card"><div class="card-b"><div style="font-weight:700;color:var(--err);margin-bottom:10px">âš ï¸ ë¦¬ìŠ¤í¬ ìš”ì¸</div>'+(r.risks||[]).map(function(o,i){return '<div style="display:flex;gap:8px;padding:6px 0;border-bottom:1px solid var(--w08)"><span style="color:var(--err);font-weight:700;font-size:12px">'+(i+1)+'</span><span style="font-size:13px;color:var(--w70)">'+o+'</span></div>';}).join('')+'</div></div></div>';
  var actionPlan='';if(r.action_plan&&r.action_plan.length){actionPlan='<div class="card" style="margin-bottom:14px"><div class="card-h">ğŸ—ºï¸ ìˆ˜ì¶œ ì‹¤í–‰ ë¡œë“œë§µ</div><div class="card-b"><div style="display:flex;gap:12px">'+r.action_plan.map(function(p,i){var cols=['var(--pri)','var(--acc)','var(--ok)'];return '<div style="flex:1;padding:14px;border-radius:12px;border:1.5px solid '+cols[i]+'25;background:'+cols[i]+'08"><div style="font-size:11px;color:'+cols[i]+';font-weight:700;margin-bottom:2px">'+p.phase+'</div><div style="font-size:14px;font-weight:700;margin-bottom:8px">'+p.title+'</div>'+p.items.map(function(item){return '<div style="font-size:12px;color:var(--w60);padding:3px 0;display:flex;gap:6px"><span style="color:'+cols[i]+'">â†’</span>'+item+'</div>';}).join('')+'</div>';}).join('')+'</div></div></div>';}
  var priceInfo='<div class="card" style="margin-bottom:14px"><div class="card-h">ğŸ’° ê°€ê²© & ë¬¼ë¥˜</div><div class="card-b"><div class="grid-3">'+UI.stat('ì˜ˆìƒ FOB',r.estimated_fob||'â€”','','')+UI.stat('HS Code',r.hs_code||'â€”','','')+UI.stat('ì¸ì¦ í•„ìš”',(r.required_certs||[]).length+'ê°œ','','')+'</div></div></div>';
  var linkedProd=S.products.filter(function(p){return p.analysis_id===a.id;});
  var prodCard='';if(linkedProd.length){prodCard='<div class="card" style="margin-bottom:14px;border-color:rgba(0,230,118,.15)"><div class="card-h"><span>ğŸ“¦ ìë™ ë“±ë¡ëœ ì œí’ˆ</span>'+UI.badge(linkedProd.length+'ê±´','ok')+'</div><div class="card-b"><div class="grid-3">'+linkedProd.map(function(p){return '<div style="padding:14px;border-radius:10px;border:1px solid var(--bd);background:var(--w08);cursor:pointer" onclick="App.editP(\''+p.id+'\')"><div style="font-size:13px;font-weight:700">'+U.tr(p.name_ko,20)+'</div><div style="font-size:11px;color:var(--w40);margin-top:4px">'+(p.category||'')+' Â· FOB '+(p.fob_price?U.usd(p.fob_price):'â€”')+'</div><div style="margin-top:6px">'+UI.sb(p.status)+'</div>'+(p.description_en?'<div style="font-size:10px;color:var(--ok);margin-top:4px">EN</div>':'<button class="btn btn-acc btn-sm" style="margin-top:6px" onclick="event.stopPropagation();App.genCatalogEN(\''+p.id+'\')">AI ì˜ë¬¸ ìƒì„±</button>')+'</div>';}).join('')+'</div></div></div>';}
  var nc=(r.required_certs||[]);var actions='<div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--bd)"><div style="font-size:14px;font-weight:700;margin-bottom:12px">âš¡ ë‹¤ìŒ ë‹¨ê³„</div><div style="display:flex;flex-wrap:wrap;gap:8px"><button class="btn btn-pri" onclick="App.createPj(\''+a.id+'\')">ğŸš€ í”„ë¡œì íŠ¸ ìƒì„±</button>'+(nc.length?'<button class="btn btn-acc" onclick="App.reqSvc(\'certification\',\''+a.id+'\')">ğŸ… ì¸ì¦ ('+nc.length+'ê±´)</button>':'')+'<button class="btn btn-ghost" onclick="App.reqSvc(\'matching\',\''+a.id+'\')">ğŸ¤ ë§¤ì¹­</button><button class="btn btn-ghost" onclick="App.reqSvc(\'premium_analysis\',\''+a.id+'\')">ğŸ”¬ í”„ë¦¬ë¯¸ì—„</button><button class="btn btn-ghost" onclick="window.print()">ğŸ–¨ï¸ ì¶œë ¥</button></div></div>';
  return hdr+scoreCard+execSummary+priceInfo+mktSection+certSection+trendSection+oppRisk+actionPlan+prodCard+actions;
}

function viewA(id){var a=S.analyses.find(function(x){return x.id===id;});if(a)set({currentAnalysis:a,page:'analysis'});}

var STAGE_DEFAULTS={
  planning:[{text:'ìˆ˜ì¶œ ëŒ€ìƒ ì œí’ˆ í™•ì •',done:false},{text:'íƒ€ê²Ÿ ì‹œì¥ ì„ ì •',done:false},{text:'FOB ê°€ê²© í™•ì •',done:false},{text:'ìˆ˜ì¶œ ì¼ì • ìˆ˜ë¦½',done:false}],
  certification:[{text:'í•„ìš” ì¸ì¦ ëª©ë¡ í™•ì¸',done:false},{text:'ì¸ì¦ ê¸°ê´€ ì„ ì •',done:false},{text:'ì„œë¥˜ ì¤€ë¹„ ë° ì œì¶œ',done:false},{text:'ì¸ì¦ ì·¨ë“ ì™„ë£Œ',done:false}],
  buyer_search:[{text:'ë°”ì´ì–´ ë¦¬ìŠ¤íŠ¸ í™•ë³´',done:false},{text:'ì½œë“œ ì´ë©”ì¼ ë°œì†¡',done:false},{text:'ìƒ˜í”Œ ìš”ì²­ ëŒ€ì‘',done:false},{text:'ë°”ì´ì–´ ë¯¸íŒ… ì§„í–‰',done:false}],
  negotiation:[{text:'ê°€ê²© í˜‘ìƒ',done:false},{text:'ê²°ì œ ì¡°ê±´ í˜‘ì˜',done:false},{text:'ê³„ì•½ì„œ ê²€í† ',done:false},{text:'PI ë°œí–‰',done:false}],
  shipping:[{text:'CI/PL ì‘ì„±',done:false},{text:'í†µê´€ ì„œë¥˜ ì¤€ë¹„',done:false},{text:'í¬ì›Œë” ì„ ì •',done:false},{text:'ì„ ì  ì™„ë£Œ',done:false},{text:'B/L ìˆ˜ë ¹',done:false}],
  completed:[{text:'ëŒ€ê¸ˆ ìˆ˜ë ¹ í™•ì¸',done:false},{text:'ì‚¬í›„ ê´€ë¦¬ ê³„íš',done:false},{text:'ì¬ì£¼ë¬¸ í˜‘ì˜',done:false}]
};

function createPj(aid){
  var a=S.analyses.find(function(x){return x.id===aid;});if(!a)return;
  var linkedProd=S.products.find(function(p){return p.analysis_id===aid;});
  var certs=(a.ai_result&&a.ai_result.required_certs||[]).map(function(c){return{name:c,status:'pending'};});
  var initProgress={planning:JSON.parse(JSON.stringify(STAGE_DEFAULTS.planning)),certification:JSON.parse(JSON.stringify(STAGE_DEFAULTS.certification)),buyer_search:JSON.parse(JSON.stringify(STAGE_DEFAULTS.buyer_search)),negotiation:JSON.parse(JSON.stringify(STAGE_DEFAULTS.negotiation)),shipping:JSON.parse(JSON.stringify(STAGE_DEFAULTS.shipping)),completed:JSON.parse(JSON.stringify(STAGE_DEFAULTS.completed)),certs:certs};
  sb.from('projects').insert({user_id:S.user.id,analysis_id:aid,product_id:linkedProd?linkedProd.id:null,name:a.product_name+' ìˆ˜ì¶œ í”„ë¡œì íŠ¸',target_countries:a.ai_result&&a.ai_result.recommended_markets||['US'],status:'planning',stage_progress:initProgress}).then(function(r){
    if(r.error){UI.toast('ì‹¤íŒ¨','err');return;}loadPr().then(function(){set({page:'projects',currentAnalysis:null});UI.toast('í”„ë¡œì íŠ¸ ìƒì„±!','ok');});
  });
}

function pgProducts(){
  return '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px"><div><h2 style="font-size:18px;font-weight:800">ğŸ“¦ ì œí’ˆ ì¹´ë“œ</h2></div><button class="btn btn-pri" onclick="App.showPF()">+ ë“±ë¡</button></div>'+(S.products.length===0?'<div class="card"><div class="card-b">'+UI.empty('ğŸ“¦','ë“±ë¡ ì œí’ˆ ì—†ìŒ','ì œí’ˆì„ ë“±ë¡í•˜ë©´ ë°”ì´ì–´ì—ê²Œ ë…¸ì¶œë©ë‹ˆë‹¤')+'<div style="text-align:center;margin-top:12px"><button class="btn btn-pri" onclick="App.showPF()">ì²« ì œí’ˆ ë“±ë¡</button></div></div></div>':'<div class="grid-3">'+S.products.map(function(p){return '<div class="prod-card"><div class="prod-img" onclick="App.editP(\''+p.id+'\')" style="position:relative">'+(p.images&&p.images[0]?'<img src="'+p.images[0]+'" style="width:100%;height:100%;object-fit:cover">':'ğŸ“¦')+'</div><div class="prod-body"><div style="display:flex;justify-content:space-between;align-items:start"><div onclick="App.editP(\''+p.id+'\')" style="cursor:pointer;flex:1"><div class="prod-name">'+U.tr(p.name_ko,25)+'</div><div class="prod-meta">'+(p.category||'ë¯¸ì„¤ì •')+' Â· FOB '+(p.fob_price?U.usd(p.fob_price):'ë¯¸ì„¤ì •')+'</div><div class="prod-meta" style="margin-top:4px">MOQ: '+(p.moq||'â€”')+'</div></div><div style="display:flex;flex-direction:column;gap:4px;align-items:flex-end">'+UI.sb(p.status)+'<button class="btn btn-danger btn-sm" onclick="App.delP(\''+p.id+'\')" style="font-size:10px;padding:2px 6px;margin-top:4px">ì‚­ì œ</button></div></div></div></div>';}).join('')+'<div class="prod-card" onclick="App.showPF()" style="display:flex;align-items:center;justify-content:center;min-height:200px;border-style:dashed"><div style="text-align:center;color:var(--w20)"><div style="font-size:32px">+</div><div style="font-size:13px">ì¶”ê°€</div></div></div></div>');
}

function showPF(p){
  p=p||{};var body='<form id="pf">'+
    '<div style="margin-bottom:14px"><label class="form-label">ëŒ€í‘œ ì´ë¯¸ì§€</label><div style="display:flex;gap:12px;align-items:start"><div style="width:100px;height:100px;border-radius:10px;border:2px dashed var(--bd-l);display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden;flex-shrink:0;background:var(--sf)" onclick="document.getElementById(\'prodImg\').click()" id="prodImgBox">'+(p.images&&p.images[0]?'<img src="'+p.images[0]+'" style="width:100%;height:100%;object-fit:cover">':'<div style="text-align:center;color:var(--w20)"><div style="font-size:24px">ğŸ“·</div><div style="font-size:10px">í´ë¦­</div></div>')+'</div><div style="flex:1"><input class="form-input" name="image_url" placeholder="ì´ë¯¸ì§€ URL ì§ì ‘ ì…ë ¥" value="'+(p.images&&p.images[0]||'')+'" oninput="App.prevImg(this.value)"><div style="font-size:10px;color:var(--w20);margin-top:4px">ì´ë¯¸ì§€ íŒŒì¼ ì„ íƒ ë˜ëŠ” URL ì…ë ¥</div><input type="file" id="prodImg" accept="image/*" style="display:none" onchange="App.prodImgFile(this.files[0])"></div></div></div>'+
    '<div class="grid-2">'+UI.inp('name_ko','ì œí’ˆëª…(í•œê¸€)*',{value:p.name_ko||'',required:true})+UI.inp('name_en','ì œí’ˆëª…(ì˜ë¬¸)',{value:p.name_en||''})+'</div>'+UI.ta('description_en','ì„¤ëª…(ì˜ë¬¸)',{value:p.description_en||''})+(p.id?'<div style="margin:-8px 0 14px"><button class="btn btn-acc btn-sm" onclick="App.genCatalogEN(\''+p.id+'\')">AI ì˜ë¬¸ ì¹´íƒˆë¡œê·¸ ìƒì„±</button></div>':'')+'<div class="grid-2">'+UI.sel('category','ì¹´í…Œê³ ë¦¬',U.CAT,p.category||'')+UI.inp('hs_code','HS Code',{value:p.hs_code||''})+'</div>'+
    '<div class="form-group"><label class="form-label">ë‹¨ê°€ (â‚© ì›í™” â†’ USD ìë™ í™˜ì‚°)</label><div style="display:flex;gap:10px;align-items:center"><div style="flex:1;position:relative"><span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--w40);font-size:13px">â‚©</span><input class="form-input" name="price_krw" type="number" value="'+(p.fob_price?Math.round(p.fob_price*1400):'')+'" placeholder="7,000" style="padding-left:28px" oninput="var u=document.querySelector(\'[name=fob_price]\');if(u)u.value=(this.value/1400).toFixed(2);var s=document.getElementById(\'pusd\');if(s)s.textContent=this.value?\'â‰ˆ $\'+(this.value/1400).toFixed(2):\'\';"></div><span style="font-size:13px;color:var(--pri);font-weight:600;font-family:JetBrains Mono;min-width:80px" id="pusd">'+(p.fob_price?'â‰ˆ $'+p.fob_price:'')+'</span><input type="hidden" name="fob_price" value="'+(p.fob_price||'')+'"></div></div>'+
    '<div class="grid-2">'+UI.inp('moq','MOQ',{type:'number',value:p.moq||''})+UI.inp('lead_time','ë¦¬ë“œíƒ€ì„',{value:p.lead_time||''})+'</div></form>';
  document.body.insertAdjacentHTML('beforeend',UI.modal({id:'pm',title:p.id?'ì œí’ˆ ìˆ˜ì •':'ì œí’ˆ ë“±ë¡',body:body,footer:'<button class="btn btn-ghost" onclick="App.closeModal(\'pm\')">ì·¨ì†Œ</button><button class="btn btn-pri" onclick="App.saveP(\''+(p.id||'')+'\')">ì €ì¥</button>',width:'640px'}));UI.showModal('pm');
}

function prevImg(url){var box=document.getElementById('prodImgBox');if(box)box.innerHTML=url?'<img src="'+url+'" style="width:100%;height:100%;object-fit:cover">':'<div style="text-align:center;color:var(--w20)"><div style="font-size:24px">ğŸ“·</div><div style="font-size:10px">í´ë¦­</div></div>';}
function prodImgFile(f){if(!f)return;var r=new FileReader();r.onload=function(e){var url=e.target.result;prevImg(url);var inp=document.querySelector('[name=image_url]');if(inp)inp.value=url;};r.readAsDataURL(f);}

function saveP(id){
  var d=UI.fd('#pf');if(!d.name_ko){UI.toast('ì œí’ˆëª… ì…ë ¥','warn');return;}
  delete d.price_krw;if(d.image_url){d.images=[d.image_url];delete d.image_url;}
  var q=id?sb.from('products').update(d).eq('id',id):sb.from('products').insert(Object.assign(d,{user_id:S.user.id,status:'draft'}));
  q.then(function(r){if(r.error){UI.toast('ì‹¤íŒ¨','err');return;}closeModal('pm');loadP().then(function(){render();UI.toast(id?'ìˆ˜ì •!':'ë“±ë¡!','ok');});});
}

function editP(id){var p=S.products.find(function(x){return x.id===id;});if(p)showPF(p);}

function delP(id){if(!confirm('ì´ ì œí’ˆì„ ì‚­ì œí• ê¹Œìš”?'))return;sb.from('products').delete().eq('id',id).then(function(r){if(r.error){UI.toast('ì‚­ì œ ì‹¤íŒ¨','err');return;}loadP().then(function(){render();UI.toast('ì‚­ì œ ì™„ë£Œ','ok');});});}

function delA(id){if(!confirm('ì´ ë¶„ì„ì„ ì‚­ì œí• ê¹Œìš”?'))return;sb.from('analyses').delete().eq('id',id).then(function(r){if(r.error){UI.toast('ì‚­ì œ ì‹¤íŒ¨','err');return;}loadA().then(function(){render();UI.toast('ì‚­ì œ ì™„ë£Œ','ok');});});}

function pgServices(){
  var svcs=[{type:'premium_analysis',name:'í”„ë¦¬ë¯¸ì—„ AI ë¶„ì„',icon:'ğŸ”¬',desc:'ì „ë¬¸ê°€ ê²€ìˆ˜ ì‹¬ì¸µ ë¦¬í¬íŠ¸',price:'â‚©300~500K'},{type:'matching',name:'ë°”ì´ì–´ ë§¤ì¹­',icon:'ğŸ¤',desc:'ê²€ì¦ëœ í•´ì™¸ ë°”ì´ì–´ ë°œêµ´',price:'â‚©1~3M+2~5%'},{type:'document',name:'ì„œë¥˜ ëŒ€í–‰',icon:'ğŸ“„',desc:'PI, CI, PL, CO ì‘ì„±',price:'â‚©200~500K'},{type:'certification',name:'ì¸ì¦ ëŒ€í–‰',icon:'ğŸ…',desc:'FDA, CE, CPNP ì·¨ë“',price:'â‚©2~10M'},{type:'logistics',name:'ë¬¼ë¥˜/í†µê´€',icon:'ğŸš¢',desc:'ìš´ì†¡, í†µê´€, ë³´í—˜ ì¼ê´„',price:'â‚©500K~2M'},{type:'email_support',name:'ì´ë©”ì¼ ì§€ì›',icon:'âœ‰ï¸',desc:'ë°”ì´ì–´ ì†Œí†µ ë²ˆì—­ëŒ€í–‰',price:'â‚©200~500K/ì›”'}];
  return '<div style="margin-bottom:20px"><h2 style="font-size:18px;font-weight:800">ğŸ’¼ ì„œë¹„ìŠ¤ ì‹ ì²­</h2><p style="font-size:13px;color:var(--w40);margin-top:4px">ë°”ìš°ì²˜ ì ìš© ê°€ëŠ¥</p></div><div class="svc-grid" style="margin-bottom:24px">'+svcs.map(function(s){return '<div class="svc-card" onclick="App.reqSvc(\''+s.type+'\')"><div class="svc-icon">'+s.icon+'</div><div class="svc-name">'+s.name+'</div><div class="svc-desc">'+s.desc+'</div><div class="svc-price">'+s.price+'</div></div>';}).join('')+'</div>'+(S.serviceRequests.length?'<div class="card"><div class="card-h"><span>ì‹ ì²­ ì´ë ¥</span>'+UI.badge(S.serviceRequests.length+'ê±´','pri')+'</div><div class="card-b" style="padding:0"><table class="tbl"><thead><tr><th>ì„œë¹„ìŠ¤</th><th>ìƒíƒœ</th><th>ê¸ˆì•¡</th><th>ë‚ ì§œ</th></tr></thead><tbody>'+S.serviceRequests.map(function(sr){return '<tr><td>'+U.si(sr.service_type)+' '+U.sl(sr.service_type)+'</td><td>'+UI.sb(sr.status)+'</td><td style="font-family:JetBrains Mono;font-size:12px">'+(sr.price?U.krw(sr.price):'ê²¬ì ëŒ€ê¸°')+'</td><td style="font-size:12px;color:var(--w40)">'+U.fd(sr.created_at)+'</td></tr>';}).join('')+'</tbody></table></div></div>':'');
}

function reqSvc(type,anlId){
  var ctx='';var aid=anlId||'';
  if(S.currentAnalysis){aid=S.currentAnalysis.id;var r=S.currentAnalysis.ai_result||{};ctx='[ë¶„ì„: '+S.currentAnalysis.product_name+']\nì ìˆ˜: '+(r.overall_score||'-')+'\n';if(type==='certification')ctx+='í•„ìš”ì¸ì¦: '+(r.required_certs||[]).join(', ')+'\n';if(type==='matching')ctx+='ì¶”ì²œì±„ë„: '+(r.recommended_channels||[]).join(', ')+'\n';}
  var pjOpts=S.projects.length?UI.sel('project_id','í”„ë¡œì íŠ¸ ì—°ê²°',[{value:'',label:'â€” ë¯¸ì—°ê²° â€”'}].concat(S.projects.map(function(p){return{value:p.id,label:p.name}}))):'';
  var body='<form id="sf"><input type="hidden" name="service_type" value="'+type+'"><input type="hidden" name="analysis_id" value="'+aid+'">'+pjOpts+UI.ta('details_text','ìš”ì²­ ìƒì„¸',{placeholder:'ìƒì„¸ ë‚´ìš©',rows:5,value:ctx})+UI.sel('priority','ê¸´ê¸‰ë„',[{value:'normal',label:'ì¼ë°˜'},{value:'high',label:'ê¸‰í•¨'},{value:'urgent',label:'ë§¤ìš°ê¸‰í•¨'}])+'</form>';
  document.body.insertAdjacentHTML('beforeend',UI.modal({id:'sm',title:U.si(type)+' '+U.sl(type)+' ì‹ ì²­',body:body,footer:'<button class="btn btn-ghost" onclick="App.closeModal(\'sm\')">ì·¨ì†Œ</button><button class="btn btn-pri" onclick="App.subSvc()">ì‹ ì²­</button>'}));UI.showModal('sm');
}
function subSvc(){
  var d=UI.fd('#sf');
  sb.from('service_requests').insert({user_id:S.user.id,service_type:d.service_type,priority:d.priority,title:U.sl(d.service_type),details:{text:d.details_text,analysis_id:d.analysis_id||null},project_id:d.project_id||null}).then(function(r){
    if(r.error){UI.toast('ì‹¤íŒ¨','err');return;}closeModal('sm');loadSR().then(function(){render();UI.toast('ì„œë¹„ìŠ¤ ì‹ ì²­ ì™„ë£Œ','ok');});
  });
}

function subSvc(){
  var d=UI.fd('#sf');
  sb.from('service_requests').insert({user_id:S.user.id,service_type:d.service_type,priority:d.priority,title:U.sl(d.service_type),details:{text:d.details_text}}).then(function(r){
    if(r.error){UI.toast('ì‹¤íŒ¨','err');return;}closeModal('sm');loadSR().then(function(){render();UI.toast('ì„œë¹„ìŠ¤ ì‹ ì²­ ì ‘ìˆ˜!','ok');});
  });
}

function pgProjects(){
  if(S.currentProject)return pgPjDetail();
  var stages=['planning','certification','buyer_search','negotiation','shipping','completed'];
  var stL={planning:'ê¸°íš',certification:'ì¸ì¦',buyer_search:'ë°”ì´ì–´',negotiation:'í˜‘ìƒ',shipping:'ì„ ì ',completed:'ì™„ë£Œ'};
  return '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px"><h2 style="font-size:18px;font-weight:800">ğŸš€ í”„ë¡œì íŠ¸</h2></div>'+(S.projects.length===0?'<div class="card"><div class="card-b">'+UI.empty('ğŸš€','í”„ë¡œì íŠ¸ ì—†ìŒ','AI ë¶„ì„ í›„ í”„ë¡œì íŠ¸ë¥¼ ìƒì„±í•˜ì„¸ìš”')+'<div style="text-align:center;margin-top:12px"><button class="btn btn-pri" onclick="App.nav(\'analysis\')">AI ë¶„ì„ ì‹œì‘</button></div></div></div>':S.projects.map(function(p){var ci=stages.indexOf(p.status);var linked=S.serviceRequests.filter(function(sr){return sr.project_id===p.id;});var a=S.analyses.find(function(x){return x.id===p.analysis_id;});return '<div class="card" style="margin-bottom:12px;cursor:pointer" onclick="App.viewPj(\''+p.id+'\')"><div class="card-h"><div style="display:flex;align-items:center;gap:8px"><span>ğŸš€</span><span style="font-weight:700">'+p.name+'</span></div><div style="display:flex;gap:8px">'+UI.sb(p.status)+'<span style="font-size:11px;color:var(--w20)">'+U.fd(p.created_at)+'</span></div></div><div class="card-b"><div style="display:flex;gap:4px;margin-bottom:10px">'+stages.map(function(s,i){return '<div style="flex:1;text-align:center"><div style="height:6px;border-radius:3px;background:'+(i<ci?'var(--ok)':i===ci?'var(--pri)':'var(--w08)')+';margin-bottom:4px"></div><div style="font-size:9px;color:'+(i<=ci?'var(--w60)':'var(--w20)')+'">'+stL[s]+'</div></div>';}).join('')+'</div><div style="display:flex;gap:12px;font-size:12px;color:var(--w40)"><span>ğŸŒ '+(p.target_countries||[]).map(function(c){return U.cl(c);}).join(', ')+'</span>'+(a&&a.ai_result?'<span>ğŸ“Š '+a.ai_result.overall_score+'ì </span>':'')+(linked.length?'<span>ğŸ’¼ '+linked.length+'ê±´</span>':'')+'</div></div></div>';}).join(''));
}

function pgPjDetail(){
  var p=S.currentProject;if(!p)return'';
  var stages=['planning','certification','buyer_search','negotiation','shipping','completed'];
  var stL={planning:'ğŸ“‹ ê¸°íš',certification:'ğŸ… ì¸ì¦',buyer_search:'ğŸ” ë°”ì´ì–´',negotiation:'ğŸ¤ í˜‘ìƒ',shipping:'ğŸš¢ ì„ ì ',completed:'âœ… ì™„ë£Œ'};
  var ci=stages.indexOf(p.status);
  var a=S.analyses.find(function(x){return x.id===p.analysis_id;});
  var linked=S.serviceRequests.filter(function(sr){return sr.project_id===p.id;});
  var notes=p.notes||[];
  var hdr='<div style="display:flex;align-items:center;gap:12px;margin-bottom:20px"><button class="btn btn-ghost btn-sm" onclick="App.set({currentProject:null})">â† ëª©ë¡</button><h2 style="font-size:18px;font-weight:800;flex:1">'+p.name+'</h2>'+UI.sb(p.status)+'</div>';
  var pipe='<div class="card" style="margin-bottom:14px"><div class="card-h">ğŸ“Š ì§„í–‰ ë‹¨ê³„</div><div class="card-b"><div style="display:flex;gap:6px">'+stages.map(function(s,i){var cur=i===ci;var done=i<ci;return '<div style="flex:1;text-align:center;padding:12px 4px;border-radius:10px;border:2px solid '+(cur?'var(--pri)':done?'var(--ok)':'var(--bd)')+';background:'+(cur?'rgba(0,212,255,.08)':done?'rgba(0,230,118,.06)':'transparent')+';cursor:pointer" onclick="App.setPjStage(\''+s+'\')"><div style="font-size:14px;margin-bottom:4px">'+(done?'âœ…':stL[s].split(' ')[0])+'</div><div style="font-size:10px;font-weight:'+(cur?'700':'400')+';color:'+(cur?'var(--pri)':done?'var(--ok)':'var(--w40)')+'">'+stL[s].split(' ')[1]+'</div></div>';}).join('')+'</div></div></div>';
  var info='<div class="grid-2" style="margin-bottom:14px"><div class="card"><div class="card-h">ğŸ“‹ ì •ë³´</div><div class="card-b"><div style="font-size:13px;line-height:2.2;display:grid;grid-template-columns:auto 1fr;gap:4px 14px"><span style="color:var(--w40)">íƒ€ê²Ÿ</span><span>'+(p.target_countries||[]).map(function(c){return U.cl(c);}).join(', ')+'</span><span style="color:var(--w40)">ìƒì„±ì¼</span><span>'+U.fd(p.created_at)+'</span><span style="color:var(--w40)">ìˆ˜ì •ì¼</span><span>'+U.fd(p.updated_at,'rel')+'</span></div></div></div>'+(a?'<div class="card"><div class="card-h">ğŸ”¬ ì—°ê²° ë¶„ì„</div><div class="card-b" style="cursor:pointer" onclick="App.viewA(\''+a.id+'\')"><div style="display:flex;align-items:center;gap:12px"><div style="width:48px;height:48px;border-radius:10px;background:rgba(0,212,255,.1);display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:900;color:var(--pri)">'+((a.ai_result&&a.ai_result.overall_score)||'?')+'</div><div><div style="font-weight:700">'+a.product_name+'</div><div style="font-size:12px;color:var(--w40)">'+U.tr((a.ai_result&&a.ai_result.summary)||'',60)+'</div></div></div></div></div>':'<div class="card"><div class="card-b" style="text-align:center;padding:20px;color:var(--w40)">ì—°ê²°ëœ ë¶„ì„ ì—†ìŒ</div></div>')+'</div>';
  var svc='<div class="card" style="margin-bottom:14px"><div class="card-h"><span>ğŸ’¼ ì—°ê²° ì„œë¹„ìŠ¤</span><button class="btn btn-pri btn-sm" onclick="App.reqSvcForPj(\''+p.id+'\')">+ ì„œë¹„ìŠ¤ ì‹ ì²­</button></div><div class="card-b">'+(linked.length?linked.map(function(sr){return '<div style="display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;background:var(--w08);margin-bottom:8px"><span>'+U.si(sr.service_type)+'</span><div style="flex:1"><div style="font-size:13px;font-weight:600">'+U.sl(sr.service_type)+'</div><div style="font-size:11px;color:var(--w40)">'+U.fd(sr.created_at,'rel')+'</div></div>'+UI.sb(sr.status)+'</div>';}).join(''):'<div style="text-align:center;padding:16px;color:var(--w40);font-size:13px">ì„œë¹„ìŠ¤ë¥¼ ì‹ ì²­í•˜ì„¸ìš”</div>')+'</div></div>';
  var noteS='<div class="card" style="margin-bottom:14px"><div class="card-h"><span>ğŸ“ ë©”ëª¨</span><button class="btn btn-ghost btn-sm" onclick="App.addPjNote()">+ ì¶”ê°€</button></div><div class="card-b">'+(notes.length?notes.map(function(n,i){return '<div style="padding:10px;border-radius:8px;background:var(--w08);margin-bottom:8px"><div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="font-size:11px;color:var(--w40)">'+U.fd(n.date,'rel')+'</span><button class="btn btn-danger btn-sm" onclick="App.rmPjNote('+i+')" style="font-size:10px;padding:2px 6px">âœ•</button></div><div style="font-size:13px;color:var(--w70);white-space:pre-wrap">'+n.text+'</div></div>';}).join(''):'<div style="text-align:center;padding:16px;color:var(--w40);font-size:13px">ë©”ëª¨ë¥¼ ë‚¨ê²¨ ì§„í–‰ì„ ê¸°ë¡í•˜ì„¸ìš”</div>')+'</div></div>';
  var stagePanel='';var curStage=stages[ci]||'planning';var sp=p.stage_progress||{};
  if(curStage==='certification'){stagePanel=pgCertTracker(p);}
  else{stagePanel=renderStageChecklist(p,curStage);}
  var acts='<div style="display:flex;gap:8px;flex-wrap:wrap"><button class="btn btn-pri" onclick="App.reqSvcForPj(\''+p.id+'\')">ğŸ’¼ ì„œë¹„ìŠ¤</button><button class="btn btn-acc" onclick="App.nav(\'docgen\')">ğŸ“„ ì„œë¥˜</button><button class="btn btn-ghost" onclick="App.nav(\'emailhub\')">âœ‰ï¸ ì´ë©”ì¼</button><button class="btn btn-danger" onclick="App.delPj(\''+p.id+'\')">ğŸ—‘ï¸ ì‚­ì œ</button></div>';
  return hdr+pipe+stagePanel+info+svc+noteS+acts;
}

function viewPj(id){var p=S.projects.find(function(x){return x.id===id;});if(p){S.currentProject=p;S.page='projects';render();}}

function setPjStage(stage){
  var p=S.currentProject;if(!p)return;
  sb.from('projects').update({status:stage,updated_at:new Date().toISOString()}).eq('id',p.id).then(function(r){
    if(r.error){UI.toast('ì‹¤íŒ¨','err');return;}p.status=stage;render();UI.toast('ë‹¨ê³„ ë³€ê²½','ok');
  });
}

function addPjNote(){
  var t=prompt('ë©”ëª¨:');if(!t)return;var p=S.currentProject;if(!p)return;
  var n=p.notes||[];n.push({text:t,date:new Date().toISOString()});
  sb.from('projects').update({notes:n}).eq('id',p.id).then(function(r){
    if(r.error){UI.toast('ì‹¤íŒ¨','err');return;}p.notes=n;render();UI.toast('ì¶”ê°€','ok');
  });
}

function rmPjNote(i){var p=S.currentProject;if(!p)return;var n=p.notes||[];n.splice(i,1);sb.from('projects').update({notes:n}).eq('id',p.id).then(function(r){if(!r.error){p.notes=n;render();}});}

function delPj(id){if(!confirm('ì‚­ì œ?'))return;sb.from('projects').delete().eq('id',id).then(function(r){if(r.error){UI.toast('ì‹¤íŒ¨','err');return;}S.currentProject=null;loadPr().then(function(){render();UI.toast('ì‚­ì œ','ok');});});}

/* â”€â”€ Stage checklist functions â”€â”€ */
function getStageItems(p,stage){
  var sp=p.stage_progress||{};
  if(sp[stage]&&sp[stage].length)return sp[stage];
  return JSON.parse(JSON.stringify(STAGE_DEFAULTS[stage]||[]));
}

function renderStageChecklist(p,stage){
  var stNames={planning:'ê¸°íš',certification:'ì¸ì¦',buyer_search:'ë°”ì´ì–´ ë°œêµ´',negotiation:'í˜‘ìƒ',shipping:'ì„ ì ',completed:'ì™„ë£Œ'};
  var items=getStageItems(p,stage);var done=items.filter(function(it){return it.done;}).length;var pct=items.length?Math.round(done/items.length*100):0;
  var bar='<div style="display:flex;align-items:center;gap:10px;margin-bottom:14px"><div style="flex:1;height:8px;border-radius:4px;background:var(--w08)"><div style="height:100%;border-radius:4px;background:'+(pct===100?'var(--ok)':'var(--pri)')+';width:'+pct+'%;transition:width .3s"></div></div><span style="font-size:12px;font-weight:700;color:'+(pct===100?'var(--ok)':'var(--pri)')+'">'+pct+'%</span></div>';
  var list=items.map(function(it,idx){return '<div style="display:flex;align-items:center;gap:10px;padding:10px;border-radius:8px;background:var(--w08);margin-bottom:6px;cursor:pointer" onclick="App.toggleStageItem(\''+p.id+'\',\''+stage+'\','+idx+')"><div style="width:22px;height:22px;border-radius:6px;border:2px solid '+(it.done?'var(--ok)':'var(--bd-l)')+';background:'+(it.done?'var(--ok)':'transparent')+';display:flex;align-items:center;justify-content:center;flex-shrink:0">'+(it.done?'<span style="color:var(--bg);font-size:12px;font-weight:900">âœ“</span>':'')+'</div><span style="font-size:13px;color:'+(it.done?'var(--w40)':'var(--w90)')+';'+(it.done?'text-decoration:line-through':'')+'">'+it.text+'</span></div>';}).join('');
  var stages=['planning','certification','buyer_search','negotiation','shipping','completed'];var ci=stages.indexOf(p.status);var nextStage=stages[ci+1]||null;
  var nextBtn=nextStage&&pct===100?'<button class="btn btn-pri" style="margin-top:10px" onclick="App.setPjStage(\''+nextStage+'\')">ë‹¤ìŒ ë‹¨ê³„ â†’</button>':'';
  return '<div class="card" style="margin-bottom:14px"><div class="card-h"><span>ğŸ“‹ '+stNames[stage]+' ì²´í¬ë¦¬ìŠ¤íŠ¸</span>'+UI.badge(done+'/'+items.length,'pri')+'</div><div class="card-b">'+bar+list+nextBtn+'</div></div>';
}

function toggleStageItem(pjId,stage,idx){
  var p=S.currentProject;if(!p||p.id!==pjId)p=S.projects.find(function(x){return x.id===pjId;});if(!p)return;
  var sp=p.stage_progress||{};if(!sp[stage])sp[stage]=JSON.parse(JSON.stringify(STAGE_DEFAULTS[stage]||[]));
  sp[stage][idx].done=!sp[stage][idx].done;
  sb.from('projects').update({stage_progress:sp,updated_at:new Date().toISOString()}).eq('id',pjId).then(function(r){
    if(r.error){UI.toast('ì €ì¥ ì‹¤íŒ¨','err');return;}p.stage_progress=sp;render();
  });
}

function pgCertTracker(p){
  var sp=p.stage_progress||{};var certs=sp.certs||[];
  var stCol={pending:'var(--w40)',in_progress:'var(--acc)',submitted:'var(--pri)',approved:'var(--ok)',rejected:'var(--err)'};
  var stLabel={pending:'ëŒ€ê¸°',in_progress:'ì§„í–‰ì¤‘',submitted:'ì œì¶œë¨',approved:'ì·¨ë“',rejected:'ë°˜ë ¤'};
  var done=certs.filter(function(c){return c.status==='approved';}).length;var pct=certs.length?Math.round(done/certs.length*100):0;
  var bar='<div style="display:flex;align-items:center;gap:10px;margin-bottom:14px"><div style="flex:1;height:8px;border-radius:4px;background:var(--w08)"><div style="height:100%;border-radius:4px;background:'+(pct===100?'var(--ok)':'var(--acc)')+';width:'+pct+'%;transition:width .3s"></div></div><span style="font-size:12px;font-weight:700;color:'+(pct===100?'var(--ok)':'var(--acc)')+'">'+done+'/'+certs.length+'</span></div>';
  var list=certs.map(function(c,idx){return '<div style="display:flex;align-items:center;gap:10px;padding:10px;border-radius:8px;background:var(--w08);margin-bottom:6px"><span style="font-size:13px;font-weight:600;flex:1">'+c.name+'</span><select class="form-select" style="width:120px;padding:6px 10px;font-size:12px" onchange="App.setCertStatus(\''+p.id+'\','+idx+',this.value)"><option value="pending"'+(c.status==='pending'?' selected':'')+'> ëŒ€ê¸°</option><option value="in_progress"'+(c.status==='in_progress'?' selected':'')+'> ì§„í–‰ì¤‘</option><option value="submitted"'+(c.status==='submitted'?' selected':'')+'> ì œì¶œë¨</option><option value="approved"'+(c.status==='approved'?' selected':'')+'> ì·¨ë“</option><option value="rejected"'+(c.status==='rejected'?' selected':'')+'> ë°˜ë ¤</option></select><span style="font-size:11px;color:'+stCol[c.status||'pending']+'">'+stLabel[c.status||'pending']+'</span></div>';}).join('');
  var addBtn='<button class="btn btn-ghost btn-sm" style="margin-top:8px" onclick="App.addCertItem(\''+p.id+'\')">+ ì¸ì¦ ì¶”ê°€</button>';
  var checklist=renderStageChecklist(p,'certification');
  return '<div class="card" style="margin-bottom:14px"><div class="card-h"><span>ğŸ… ì¸ì¦ ì¶”ì </span>'+UI.badge(done+'/'+certs.length+' ì·¨ë“','acc')+'</div><div class="card-b">'+(certs.length?bar+list:' <div style="text-align:center;padding:16px;color:var(--w40)">ë“±ë¡ëœ ì¸ì¦ ì—†ìŒ</div>')+addBtn+'</div></div>'+checklist;
}

function setCertStatus(pjId,idx,status){
  var p=S.currentProject;if(!p||p.id!==pjId)p=S.projects.find(function(x){return x.id===pjId;});if(!p)return;
  var sp=p.stage_progress||{};if(!sp.certs)sp.certs=[];
  sp.certs[idx].status=status;
  sb.from('projects').update({stage_progress:sp,updated_at:new Date().toISOString()}).eq('id',pjId).then(function(r){
    if(r.error){UI.toast('ì €ì¥ ì‹¤íŒ¨','err');return;}p.stage_progress=sp;render();
  });
}

function addCertItem(pjId){
  var name=prompt('ì¸ì¦ëª… (ì˜ˆ: FDA, CE, CPNP):');if(!name)return;
  var p=S.currentProject;if(!p||p.id!==pjId)p=S.projects.find(function(x){return x.id===pjId;});if(!p)return;
  var sp=p.stage_progress||{};if(!sp.certs)sp.certs=[];
  sp.certs.push({name:name,status:'pending'});
  sb.from('projects').update({stage_progress:sp,updated_at:new Date().toISOString()}).eq('id',pjId).then(function(r){
    if(r.error){UI.toast('ì €ì¥ ì‹¤íŒ¨','err');return;}p.stage_progress=sp;render();UI.toast('ì¸ì¦ ì¶”ê°€','ok');
  });
}

function reqSvcForPj(pjId){
  var svcs=[{value:'premium_analysis',label:'ğŸ”¬ í”„ë¦¬ë¯¸ì—„ ë¶„ì„'},{value:'matching',label:'ğŸ¤ ë°”ì´ì–´ ë§¤ì¹­'},{value:'document',label:'ğŸ“„ ì„œë¥˜ ëŒ€í–‰'},{value:'certification',label:'ğŸ… ì¸ì¦ ëŒ€í–‰'},{value:'logistics',label:'ğŸš¢ ë¬¼ë¥˜/í†µê´€'},{value:'email_support',label:'âœ‰ï¸ ì´ë©”ì¼ ì§€ì›'}];
  var body='<form id="sf"><input type="hidden" name="project_id" value="'+pjId+'">'+UI.sel('service_type','ì„œë¹„ìŠ¤',svcs)+UI.ta('details_text','ìš”ì²­ ìƒì„¸',{placeholder:'ìƒì„¸ ë‚´ìš©',rows:4})+UI.sel('priority','ê¸´ê¸‰ë„',[{value:'normal',label:'ì¼ë°˜'},{value:'high',label:'ê¸‰í•¨'},{value:'urgent',label:'ë§¤ìš°ê¸‰í•¨'}])+'</form>';
  document.body.insertAdjacentHTML('beforeend',UI.modal({id:'sm',title:'ğŸ’¼ í”„ë¡œì íŠ¸ ì„œë¹„ìŠ¤ ì‹ ì²­',body:body,footer:'<button class="btn btn-ghost" onclick="App.closeModal(\'sm\')">ì·¨ì†Œ</button><button class="btn btn-pri" onclick="App.subSvcPj()">ì‹ ì²­</button>'}));UI.showModal('sm');
}

function subSvcPj(){
  var d=UI.fd('#sf');
  sb.from('service_requests').insert({user_id:S.user.id,project_id:d.project_id||null,service_type:d.service_type,priority:d.priority,title:U.sl(d.service_type),details:{text:d.details_text}}).then(function(r){
    if(r.error){UI.toast('ì‹¤íŒ¨','err');return;}closeModal('sm');loadSR().then(function(){render();UI.toast('ì‹ ì²­ ì™„ë£Œ','ok');});
  });
}

function pgDocgen(){
  if(S.docType)return pgDocForm();
  var warn=!S.company?'<div class="card" style="border-color:rgba(255,184,0,.25);margin-bottom:16px"><div class="card-b" style="display:flex;align-items:center;gap:14px"><span style="font-size:28px">âš ï¸</span><div style="flex:1"><div style="font-weight:700">ì…€ëŸ¬ ì •ë³´ë¥¼ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”</div></div><button class="btn btn-acc btn-sm" onclick="App.nav(\'settings\')">ì„¤ì •â†’</button></div></div>':'';
  var docs=[{t:'pi',i:'ğŸ“‹',n:'Proforma Invoice',d:'ê²¬ì  ì†¡ì¥',c:'var(--pri)'},{t:'ci',i:'ğŸ“„',n:'Commercial Invoice',d:'í†µê´€ ì†¡ì¥',c:'var(--acc)'},{t:'pl',i:'ğŸ“¦',n:'Packing List',d:'í¬ì¥ ëª…ì„¸',c:'var(--ok)'}];
  return '<div style="margin-bottom:20px"><h2 style="font-size:18px;font-weight:800">ğŸ“„ ì„œë¥˜ ìë™ìƒì„±</h2><p style="font-size:13px;color:var(--w40);margin-top:4px">íšŒì‚¬ ì •ë³´ ê¸°ë°˜ ìˆ˜ì¶œ ì„œë¥˜ ìƒì„±</p></div>'+warn+'<div class="svc-grid">'+docs.map(function(d){return '<div class="svc-card" onclick="App.startDoc(\''+d.t+'\')"><div class="svc-icon">'+d.i+'</div><div class="svc-name" style="color:'+d.c+'">'+d.n+'</div><div class="svc-desc">'+d.d+'</div><div style="margin-top:12px"><button class="btn btn-ghost btn-sm" style="border-color:'+d.c+';color:'+d.c+'">ìƒì„± â†’</button></div></div>';}).join('')+'</div>';
}
function startDoc(type){S.docType=type;S.docItems=[{name:'',qty:1,unit_price:0,desc:'',unit:'PCS'}];render();}

function pgDocForm(){
  var type=S.docType;var c=S.company||{};var isPL=type==='pl';
  var tN={pi:'Proforma Invoice',ci:'Commercial Invoice',pl:'Packing List'};
  var hdr='<div style="display:flex;align-items:center;gap:12px;margin-bottom:20px"><button class="btn btn-ghost btn-sm" onclick="App.set({docType:null})">â† ë’¤ë¡œ</button><h2 style="font-size:18px;font-weight:800">'+tN[type]+'</h2></div>';
  var buyerSec='<div class="card" style="margin-bottom:14px"><div class="card-h">ğŸ‘¤ Buyer</div><div class="card-b"><form id="docB">'+(S.buyers.length?'<div class="form-group"><label class="form-label">ë“±ë¡ ë°”ì´ì–´</label><select class="form-select" name="buyer_from" onchange="App.fillBuyerDoc()"><option value="">â€” ì§ì ‘ ì…ë ¥ â€”</option>'+S.buyers.map(function(b){return '<option value="'+b.id+'">'+b.company_name+'</option>';}).join('')+'</select></div>':'')+'<div class="grid-2">'+UI.inp('buyer_company','íšŒì‚¬ëª… *',{required:true})+UI.inp('buyer_contact','ë‹´ë‹¹ì')+'</div>'+UI.inp('buyer_address','ì£¼ì†Œ',{placeholder:'Address in English'})+'</form></div></div>';
  var refSec='<div class="card" style="margin-bottom:14px"><div class="card-h">ğŸ“‹ ì„œë¥˜ ì •ë³´</div><div class="card-b"><form id="docR"><div class="grid-3">'+UI.inp('doc_no','ë²ˆí˜¸',{value:'W-'+new Date().getFullYear()+'-'+String(Math.floor(Math.random()*9000)+1000)})+UI.inp('doc_date','ë‚ ì§œ',{type:'date',value:new Date().toISOString().split('T')[0]})+UI.inp('validity','ìœ íš¨',{value:'30 days'})+'</div>'+(!isPL?'<div class="grid-3">'+UI.sel('payment','ê²°ì œ',[{value:'T/T',label:'T/T'},{value:'L/C',label:'L/C'},{value:'D/P',label:'D/P'}])+UI.sel('terms','ì¡°ê±´',[{value:'FOB',label:'FOB'},{value:'CIF',label:'CIF'},{value:'EXW',label:'EXW'},{value:'DDP',label:'DDP'}])+UI.inp('port','ì„ ì í•­',{value:'Busan, Korea'})+'</div>':'<div class="grid-2">'+UI.inp('marks','Marks',{value:'N/M'})+UI.inp('vessel','Vessel')+'</div>')+'</form></div></div>';
  var items=S.docItems||[];
  var itemSec='<div class="card" style="margin-bottom:14px"><div class="card-h"><span>ğŸ“¦ í’ˆëª©</span><button class="btn btn-ghost btn-sm" onclick="App.addDocItem()">+ ì¶”ê°€</button></div><div class="card-b">'+items.map(function(it,idx){return '<div style="padding:12px;border-radius:10px;background:var(--w08);margin-bottom:8px" id="di'+idx+'"><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-size:12px;font-weight:700;color:var(--pri)">#'+(idx+1)+'</span>'+(items.length>1?'<button class="btn btn-danger btn-sm" onclick="App.rmDocItem('+idx+')" style="font-size:10px;padding:2px 6px">âœ•</button>':'')+'</div>'+(S.products.length?'<div class="form-group"><label class="form-label">ì œí’ˆ ì„ íƒ</label><select class="form-select" onchange="App.fillDocProd('+idx+',this.value)"><option value="">ì§ì ‘ ì…ë ¥</option>'+S.products.map(function(p){return '<option value="'+p.id+'">'+p.name_ko+(p.fob_price?' ($'+p.fob_price+')':'')+'</option>';}).join('')+'</select></div>':'')+'<div class="grid-2">'+UI.inp('itn_'+idx,'í’ˆëª…')+UI.inp('itd_'+idx,'ê·œê²©')+'</div><div class="grid-'+(isPL?'4':'3')+'">'+UI.inp('itq_'+idx,'ìˆ˜ëŸ‰',{type:'number',value:'1'})+UI.inp('itu_'+idx,'ë‹¨ìœ„',{value:'PCS'})+(isPL?UI.inp('itnw_'+idx,'ìˆœì¤‘ëŸ‰kg',{type:'number'})+UI.inp('itgw_'+idx,'ì´ì¤‘ëŸ‰kg',{type:'number'}):UI.inp('itp_'+idx,'ë‹¨ê°€USD',{type:'number'}))+'</div>'+(isPL?'<div class="grid-3">'+UI.inp('itc_'+idx,'ì¹´í†¤',{type:'number',value:'1'})+UI.inp('itcbm_'+idx,'CBM',{type:'number'})+UI.inp('itdm_'+idx,'ì¹˜ìˆ˜cm',{placeholder:'40x30x20'})+'</div>':'')+'</div>';}).join('')+'</div></div>';
  return hdr+buyerSec+refSec+itemSec+'<div style="display:flex;gap:8px"><button class="btn btn-pri btn-lg" onclick="App.genDoc()">ğŸ“„ ì„œë¥˜ ìƒì„±</button><button class="btn btn-ghost" onclick="App.set({docType:null})">ì·¨ì†Œ</button></div>';
}
function addDocItem(){S.docItems.push({name:'',qty:1,unit_price:0,desc:'',unit:'PCS'});render();}
function rmDocItem(i){S.docItems.splice(i,1);render();}
function fillDocProd(idx,pid){if(!pid)return;var p=S.products.find(function(x){return x.id===pid;});if(!p)return;var el=document.getElementById('di'+idx);if(!el)return;var ni=el.querySelector('[name=itn_'+idx+']');if(ni)ni.value=p.name_en||p.name_ko||'';var di=el.querySelector('[name=itd_'+idx+']');if(di)di.value=p.description_en||'';var pi=el.querySelector('[name=itp_'+idx+']');if(pi&&p.fob_price)pi.value=p.fob_price;}
function fillBuyerDoc(){var sel=document.querySelector('[name=buyer_from]');if(!sel||!sel.value)return;var b=S.buyers.find(function(x){return x.id===sel.value;});if(!b)return;var ci=document.querySelector('[name=buyer_company]');if(ci)ci.value=b.company_name||'';var cn=document.querySelector('[name=buyer_contact]');if(cn)cn.value=b.contact_name||'';var ca=document.querySelector('[name=buyer_address]');if(ca)ca.value=b.address||'';}

function genDoc(){
  var bd=UI.fd('#docB');var rd=UI.fd('#docR');if(!bd.buyer_company){UI.toast('ë°”ì´ì–´ íšŒì‚¬ëª…','warn');return;}
  var items=[];var isPL=S.docType==='pl';
  for(var i=0;i<S.docItems.length;i++){
    var it={name:document.querySelector('[name=itn_'+i+']')?.value||'',desc:document.querySelector('[name=itd_'+i+']')?.value||'',qty:Number(document.querySelector('[name=itq_'+i+']')?.value)||1,unit:document.querySelector('[name=itu_'+i+']')?.value||'PCS',price:Number(document.querySelector('[name=itp_'+i+']')?.value)||0};
    if(isPL){it.nw=Number(document.querySelector('[name=itnw_'+i+']')?.value)||0;it.gw=Number(document.querySelector('[name=itgw_'+i+']')?.value)||0;it.ctn=Number(document.querySelector('[name=itc_'+i+']')?.value)||1;it.cbm=Number(document.querySelector('[name=itcbm_'+i+']')?.value)||0;it.dims=document.querySelector('[name=itdm_'+i+']')?.value||'';}
    items.push(it);
  }
  if(!items[0]||!items[0].name){UI.toast('í’ˆëª©ëª… ì…ë ¥','warn');return;}
  var c=S.company||{};var tN={pi:'PROFORMA INVOICE',ci:'COMMERCIAL INVOICE',pl:'PACKING LIST'};
  var tA=0,tQ=0,tNW=0,tGW=0,tCBM=0,tC=0;
  items.forEach(function(x){tA+=x.qty*x.price;tQ+=x.qty;if(isPL){tNW+=x.nw;tGW+=x.gw;tCBM+=x.cbm;tC+=x.ctn;}});
  var rows=items.map(function(x,i){var a=x.qty*x.price;return isPL?'<tr><td>'+(i+1)+'</td><td><b>'+x.name+'</b><br><small>'+x.desc+'</small></td><td style="text-align:center">'+x.qty+' '+x.unit+'</td><td style="text-align:center">'+x.ctn+'</td><td style="text-align:right">'+x.nw.toFixed(1)+'</td><td style="text-align:right">'+x.gw.toFixed(1)+'</td><td>'+x.cbm.toFixed(3)+'</td><td>'+x.dims+'</td></tr>':'<tr><td>'+(i+1)+'</td><td><b>'+x.name+'</b><br><small>'+x.desc+'</small></td><td style="text-align:center">'+x.qty+' '+x.unit+'</td><td style="text-align:right">$'+x.price.toFixed(2)+'</td><td style="text-align:right;font-weight:bold">$'+a.toFixed(2)+'</td></tr>';}).join('');
  var h='<html><head><meta charset="UTF-8"><title>'+tN[S.docType]+'</title><style>body{font-family:Arial,sans-serif;max-width:800px;margin:20px auto;color:#222;font-size:13px}table{width:100%;border-collapse:collapse;margin:16px 0}th,td{border:1px solid #bbb;padding:8px;font-size:12px}th{background:#eee}small{color:#888}.ttl{font-size:22px;font-weight:bold;text-align:center;margin:20px 0;padding:12px;background:#003366;color:white}.sig{text-align:center;width:45%;border-top:1px solid #333;padding-top:10px;margin-top:60px;font-size:12px}@media print{body{margin:0}}</style></head><body>';
  h+='<div class="ttl">'+tN[S.docType]+'</div>';
  h+='<table><tr><td style="border:none"><b style="font-size:15px">'+(c.name_en||c.name_ko||'COMPANY')+'</b><br>'+(c.address_en||'')+'<br>Tel: '+(c.phone||'')+'</td><td style="border:none;text-align:right"><b>No:</b> '+rd.doc_no+'<br><b>Date:</b> '+rd.doc_date+'</td></tr></table>';
  h+='<table><tr><td style="width:50%"><b>TO:</b> '+bd.buyer_company+'<br>'+(bd.buyer_contact?'Attn: '+bd.buyer_contact+'<br>':'')+(bd.buyer_address||'')+'</td><td>'+(isPL?'<b>Marks:</b> '+(rd.marks||'N/M')+'<br><b>Vessel:</b> '+(rd.vessel||'TBD'):'<b>Payment:</b> '+(rd.payment||'T/T')+'<br><b>Terms:</b> '+(rd.terms||'FOB')+' '+(rd.port||'Busan'))+'</td></tr></table>';
  if(isPL){h+='<table><thead><tr><th>No</th><th>Description</th><th>Qty</th><th>Ctns</th><th>N.W.</th><th>G.W.</th><th>CBM</th><th>Dims</th></tr></thead><tbody>'+rows+'<tr style="font-weight:bold;background:#f5f5f5"><td colspan="2" style="text-align:right">TOTAL</td><td>'+tQ+'</td><td>'+tC+'</td><td>'+tNW.toFixed(1)+'</td><td>'+tGW.toFixed(1)+'</td><td>'+tCBM.toFixed(3)+'</td><td></td></tr></tbody></table>';}
  else{h+='<table><thead><tr><th>No</th><th>Description</th><th>Qty</th><th>Unit Price</th><th>Amount</th></tr></thead><tbody>'+rows+'<tr style="font-weight:bold;background:#f5f5f5"><td colspan="4" style="text-align:right">TOTAL</td><td style="font-size:14px">$'+tA.toFixed(2)+'</td></tr></tbody></table>';}
  h+='<div style="display:flex;justify-content:space-between;margin-top:40px"><div class="sig">'+(c.name_en||'SELLER')+'</div><div class="sig">'+bd.buyer_company+'</div></div>';
  if(!isPL&&c.bank_name){h+='<div style="margin-top:30px;padding:12px;border:1px solid #ccc;font-size:12px;line-height:1.8"><b>BANK:</b> '+c.bank_name+' / A/C: '+(c.bank_account||'')+' / SWIFT: '+(c.swift_code||'')+'</div>';}
  h+='</body></html>';
  var w=window.open('','_blank','width=850,height=700');w.document.write(h);w.document.close();
  sb.from('documents').insert({user_id:S.user.id,doc_type:S.docType,doc_number:rd.doc_no,buyer_name:bd.buyer_company,data:{buyer:bd,ref:rd,items:items,total:tA},status:'draft'}).then(function(){UI.toast('ì„œë¥˜ ìƒì„±!','ok');});
}

function pgEmail(){
  var ts=[{t:'intro',n:'ğŸ¤ ì œí’ˆ ì†Œê°œ',d:'ì²« ì œí’ˆ ì†Œê°œ ë©”ì¼'},{t:'quote',n:'ğŸ’° ê²¬ì  íšŒì‹ ',d:'ê°€ê²©/ì¡°ê±´ íšŒì‹ '},{t:'sample',n:'ğŸ“¦ ìƒ˜í”Œ ë°œì†¡',d:'ìƒ˜í”Œ ì•ˆë‚´/ì¶”ì ë²ˆí˜¸'},{t:'followup',n:'ğŸ”„ íŒ”ë¡œì—…',d:'í›„ì† ì—°ë½'},{t:'shipping',n:'ğŸš¢ ì„ ì  í†µë³´',d:'B/L ë° ë„ì°©ì¼'},{t:'thankyou',n:'ğŸ™ ê°ì‚¬/ë¦¬ì˜¤ë”',d:'ê±°ë˜ ê°ì‚¬'}];
  return '<div style="margin-bottom:20px"><h2 style="font-size:18px;font-weight:800">âœ‰ï¸ ì´ë©”ì¼ í—ˆë¸Œ</h2><p style="font-size:13px;color:var(--w40);margin-top:4px">ìƒí™©ë³„ ì˜ë¬¸ ì´ë©”ì¼ ìë™ ìƒì„±</p></div><div class="grid-3" style="margin-bottom:20px">'+ts.map(function(t){return '<div class="svc-card" style="padding:16px" onclick="App.composeE(\''+t.t+'\')"><div style="font-size:14px;font-weight:700;margin-bottom:4px">'+t.n+'</div><div style="font-size:12px;color:var(--w40)">'+t.d+'</div></div>';}).join('')+'</div>'+(S.buyers.length?'<div class="card"><div class="card-h">ğŸ“‡ ë°”ì´ì–´ ì„ íƒ ë°œì†¡</div><div class="card-b"><div style="display:flex;flex-wrap:wrap;gap:8px">'+S.buyers.slice(0,10).map(function(b){return '<div style="padding:8px 14px;border-radius:10px;background:var(--w08);cursor:pointer;font-size:12px" onclick="App.composeE(\'intro\',\''+b.id+'\')"><b>'+b.company_name+'</b> '+U.cl(b.country)+'</div>';}).join('')+'</div></div></div>':'');
}

function emailTpl(type,bn,prod){
  var c=S.company||{};var s=c.name_en||c.name_ko||'Our Company';var p=prod||'our products';var b=bn||'Sir/Madam';var sig=(c.ceo_name_en||'[Your Name]')+'\n'+s;
  var t={
    intro:{subj:'Introduction - '+p+' from '+s,body:'Dear '+b+',\n\nI am writing to introduce '+s+', a Korean manufacturer of '+p+'.\n\nKey Highlights:\n- Premium Korean quality\n- Competitive FOB pricing\n- Certifications available\n- Flexible MOQ\n\nI would be happy to provide our catalog and pricing.\n\nBest regards,\n'+sig},
    quote:{subj:'RE: Quotation for '+p,body:'Dear '+b+',\n\nThank you for your interest.\n\nProduct: '+p+'\nFOB Price: USD $ [PRICE] / unit\nMOQ: [MOQ] units\nPayment: T/T 30% deposit, 70% before shipment\nDelivery: 2-3 weeks\nPort: Busan, Korea\n\nValid for 30 days. Sample available.\n\nBest regards,\n'+sig},
    sample:{subj:'Sample Shipment - '+p,body:'Dear '+b+',\n\nSample has been shipped.\n\nCourier: [DHL/FedEx]\nTracking: [NUMBER]\nETA: [DATE]\n\nPlease confirm upon receipt.\n\nBest regards,\n'+sig},
    followup:{subj:'Following Up - '+s,body:'Dear '+b+',\n\nI wanted to follow up regarding '+p+'.\n\nWe can:\n- Adjust pricing/terms\n- Provide additional info\n- Arrange a call\n\nLooking forward to your reply.\n\nBest regards,\n'+sig},
    shipping:{subj:'Shipment Notification',body:'Dear '+b+',\n\nYour order has been shipped.\n\nB/L: [NUMBER]\nVessel: [NAME]\nETD: [DATE] Busan\nETA: [DATE]\n\nDocuments will follow.\n\nBest regards,\n'+sig},
    thankyou:{subj:'Thank You',body:'Dear '+b+',\n\nThank you for your order.\n\nWe offer returning partners:\n- Priority scheduling\n- Volume discounts\n- New samples\n\nLooking forward to continued partnership.\n\nBest regards,\n'+sig}
  };
  return t[type]||t.intro;
}

function composeE(type,buyerId){
  var buyer=buyerId?S.buyers.find(function(b){return b.id===buyerId;}):null;
  var bName=buyer?buyer.contact_name||buyer.company_name:'';
  var bEmail=buyer?buyer.email||'':'';
  var prod=S.products.length?S.products[0].name_en||S.products[0].name_ko:'our products';
  var tpl=emailTpl(type,bName,prod);
  var body='<form id="ef">'+UI.inp('to','ë°›ëŠ” ì‚¬ëŒ',{placeholder:'buyer@company.com',value:bEmail})+(S.buyers.length?'<div class="form-group"><label class="form-label">ë°”ì´ì–´</label><select class="form-select" name="bsel" onchange="App.selEB(this.value,\''+type+'\')"><option value="">ì§ì ‘ ì…ë ¥</option>'+S.buyers.map(function(b){return '<option value="'+b.id+'" '+(b.id===buyerId?'selected':'')+'>'+b.company_name+' ('+(b.email||'-')+')</option>';}).join('')+'</select></div>':'')+'<hr style="border:none;border-top:1px solid var(--bd);margin:8px 0">'+UI.inp('subject','ì œëª©',{value:tpl.subj})+UI.ta('body','ë‚´ìš©',{rows:14,value:tpl.body})+(S.products.length>1?'<div class="form-group"><label class="form-label">ì œí’ˆ ë³€ê²½</label><select class="form-select" onchange="App.chgEP(\''+type+'\',this.value)">'+S.products.map(function(p){return '<option value="'+(p.name_en||p.name_ko)+'">'+p.name_ko+'</option>';}).join('')+'</select></div>':'')+'</form>';
  document.body.insertAdjacentHTML('beforeend',UI.modal({id:'em',title:'âœ‰ï¸ ì´ë©”ì¼ ì‘ì„±',body:body,footer:'<button class="btn btn-ghost" onclick="App.closeModal(\'em\')">ì·¨ì†Œ</button><button class="btn btn-ghost" onclick="App.cpEmail()">ğŸ“‹ ë³µì‚¬</button><button class="btn btn-pri" onclick="App.sendE()">ğŸ“§ ë©”ì¼ì•±</button>',width:'640px'}));UI.showModal('em');
}

function selEB(bid,type){if(!bid)return;var b=S.buyers.find(function(x){return x.id===bid;});if(!b)return;var to=document.querySelector('#ef [name=to]');if(to)to.value=b.email||'';var prod=S.products.length?S.products[0].name_en||S.products[0].name_ko:'our products';var tpl=emailTpl(type,b.contact_name||b.company_name,prod);var sj=document.querySelector('#ef [name=subject]');if(sj)sj.value=tpl.subj;var bd=document.querySelector('#ef [name=body]');if(bd)bd.value=tpl.body;}
function chgEP(type,prod){var bs=document.querySelector('#ef [name=bsel]');var buyer=bs&&bs.value?S.buyers.find(function(x){return x.id===bs.value;}):null;var tpl=emailTpl(type,buyer?buyer.contact_name:'',prod);var sj=document.querySelector('#ef [name=subject]');if(sj)sj.value=tpl.subj;var bd=document.querySelector('#ef [name=body]');if(bd)bd.value=tpl.body;}
function cpEmail(){var d=UI.fd('#ef');navigator.clipboard.writeText('To: '+(d.to||'')+'\nSubject: '+(d.subject||'')+'\n\n'+(d.body||'')).then(function(){UI.toast('ë³µì‚¬ë¨','ok');});}
function sendE(){var d=UI.fd('#ef');if(d.to)window.open('mailto:'+d.to+'?subject='+encodeURIComponent(d.subject||'')+'&body='+encodeURIComponent(d.body||''));closeModal('em');}

function composeE(type){
  var subj={intro:'Product Introduction',quote:'RE: Quotation',sample:'Sample Shipment',followup:'Following Up',shipping:'Shipment Notification',thankyou:'Thank You'};
  var body='<form id="ef">'+UI.inp('to','ë°›ëŠ” ì‚¬ëŒ',{placeholder:'buyer@company.com'})+UI.inp('subject','ì œëª©',{value:subj[type]||''})+UI.ta('body','ë‚´ìš©',{rows:8,placeholder:'Dear Sir/Madam,...'})+'</form>';
  document.body.insertAdjacentHTML('beforeend',UI.modal({id:'em',title:'âœ‰ï¸ ì´ë©”ì¼ ì‘ì„±',body:body,footer:'<button class="btn btn-ghost" onclick="App.closeModal(\'em\')">ì·¨ì†Œ</button><button class="btn btn-pri" onclick="App.sendE()">ğŸ“§ ë©”ì¼ì•±ìœ¼ë¡œ</button>',width:'600px'}));UI.showModal('em');
}

function sendE(){var d=UI.fd('#ef');if(d.to)window.open('mailto:'+d.to+'?subject='+encodeURIComponent(d.subject||'')+'&body='+encodeURIComponent(d.body||''));closeModal('em');}

function pgCost(){
  return '<div style="margin-bottom:20px"><h2 style="font-size:18px;font-weight:800">ğŸ§® ì›ê°€ ê³„ì‚°ê¸°</h2></div><div class="card"><div class="card-h">ì›ê°€ ê³„ì‚°</div><div class="card-b"><form id="cf" onsubmit="event.preventDefault();App.calcC()"><div class="grid-3">'+UI.inp('fob_price','FOB(USD)',{type:'number',placeholder:'4.50'})+UI.inp('quantity','ìˆ˜ëŸ‰',{type:'number',placeholder:'5000'})+UI.inp('weight_kg','ì¤‘ëŸ‰(kg)',{type:'number',placeholder:'150'})+'</div><div class="grid-2">'+UI.sel('dest','ë„ì°©ì§€',[{value:'la',label:'ğŸ‡ºğŸ‡¸ LA'},{value:'tokyo',label:'ğŸ‡¯ğŸ‡µ ë„ì¿„'},{value:'hamburg',label:'ğŸ‡ªğŸ‡º í•¨ë¶€ë¥´í¬'}])+UI.sel('ship','ìš´ì†¡',[{value:'sea',label:'ğŸš¢ í•´ìƒ'},{value:'air',label:'âœˆï¸ í•­ê³µ'}])+'</div><button class="btn btn-pri" type="submit">ê³„ì‚°</button></form><div id="cr"></div></div></div>';
}

function calcC(){
  var d=UI.fd('#cf');if(!d.fob_price||!d.quantity){UI.toast('ì…ë ¥í•˜ì„¸ìš”','warn');return;}
  var fob=d.fob_price*d.quantity;var fr=d.ship==='air'?(d.weight_kg||100)*4.5:(d.weight_kg||100)*0.08*85;var ins=fob*.003;var cif=fob+fr+ins+250;
  document.getElementById('cr').innerHTML='<div style="margin-top:16px;padding:16px;border-radius:12px;background:var(--sf);border:1px solid var(--bd)"><div style="font-weight:700;margin-bottom:12px">ğŸ“Š ê²°ê³¼</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:13px"><div style="color:var(--w40)">FOB</div><div style="text-align:right;font-weight:600">'+U.usd(fob)+'</div><div style="color:var(--w40)">ìš´ì†¡ë¹„</div><div style="text-align:right;font-weight:600">'+U.usd(fr)+'</div><div style="color:var(--w40)">ë³´í—˜ë£Œ</div><div style="text-align:right;font-weight:600">'+U.usd(ins)+'</div><div style="border-top:1px solid var(--bd);padding-top:8px;font-weight:700;color:var(--acc)">CIF ì´ì•¡</div><div style="border-top:1px solid var(--bd);padding-top:8px;text-align:right;font-weight:800;color:var(--acc);font-size:16px">'+U.usd(cif)+'</div><div style="color:var(--w40)">CIF ë‹¨ê°€</div><div style="text-align:right;font-weight:600;color:var(--pri)">'+U.usd(cif/d.quantity)+'/pc</div></div></div>';
}

function pgSub(){
  var cur=S.user&&S.user.plan||'free';
  var plans=[
    {id:'free',n:'FREE',pr:0,prd:'â‚©0',pe:'',f:['AI ê¸°ë³¸ë¶„ì„ 1íšŒ/ì›”','ì´ë©”ì¼ í…œí”Œë¦¿ 6ì¢…','ì›ê°€ ê³„ì‚°ê¸°','ìˆ˜ì¶œ í”„ë¡œì„¸ìŠ¤ ê°€ì´ë“œ'],c:'var(--w40)',desc:'ìˆ˜ì¶œ ê°€ëŠ¥ì„±ì„ ë¨¼ì € í™•ì¸í•´ë³´ì„¸ìš”'},
    {id:'basic',n:'BASIC',pr:300000,prd:'â‚©300K',pe:'/ì›”',f:['AI ë¶„ì„ 3íšŒ/ì›”','ì´ë©”ì¼ í—ˆë¸Œ (AI ìƒì„±)','ì„œë¥˜ ìë™ìƒì„± ë¬´ì œí•œ','ë°”ì´ì–´ DB 5ëª…','í”„ë¡œì íŠ¸ ê´€ë¦¬ 2ê±´'],c:'var(--pri)',desc:'ë³¸ê²©ì ì¸ ìˆ˜ì¶œ ì¤€ë¹„ë¥¼ ì‹œì‘í•˜ì„¸ìš”'},
    {id:'pro',n:'PRO',pr:800000,prd:'â‚©800K',pe:'/ì›”',f:['AI 10íšŒ (í”„ë¦¬ë¯¸ì—„ í¬í•¨)','ìƒí’ˆì¹´ë“œ ë“±ë¡ ë¬´ì œí•œ','ë°”ì´ì–´ ë§¤ì¹­ 1ê±´/ì›”','ì „ìš© ìˆ˜ì¶œ ë§¤ë‹ˆì €','ìš°ì„  ì„œë¹„ìŠ¤ ì²˜ë¦¬','í”„ë¡œì íŠ¸ ê´€ë¦¬ ë¬´ì œí•œ'],c:'var(--acc)',rec:true,desc:'ì „ë¬¸ ë§¤ë‹ˆì €ì™€ í•¨ê»˜ ìˆ˜ì¶œì„ ì‹¤í–‰í•˜ì„¸ìš”'},
    {id:'alibaba',n:'ALIBABA',pr:1000000,prd:'â‚©1M',pe:'/ì›”',f:['PRO ì „ë¶€ í¬í•¨','ì•Œë¦¬ë°”ë°”ë‹·ì»´ ëŒ€í–‰','ì›”ê°„ ì „ëµ ë¯¸íŒ…','ë°”ì´ì–´ ë§¤ì¹­ 3ê±´/ì›”','ì•Œë¦¬ë°”ë°” ê´‘ê³  ê´€ë¦¬','ì‹¤ì‹œê°„ ì¸ì½°ì´ì–´ë¦¬ ê´€ë¦¬'],c:'var(--err)',desc:'ì•Œë¦¬ë°”ë°” ì „ë¬¸ ìš´ì˜ì„ ë§¡ê¸°ì„¸ìš”'}
  ];

  /* Usage stats */
  var aUsed=S.analyses.filter(function(a){var d=new Date(a.created_at);var n=new Date();return d.getMonth()===n.getMonth()&&d.getFullYear()===n.getFullYear();}).length;
  var aMax={free:1,basic:3,pro:10,alibaba:30}[cur]||1;
  var pUsed=S.products.length;
  var pjUsed=S.projects.length;

  return '<div style="margin-bottom:20px"><h2 style="font-size:18px;font-weight:800">ğŸ’ êµ¬ë… ê´€ë¦¬</h2></div>'+

  /* Current plan summary */
  '<div class="card" style="margin-bottom:20px;border-color:rgba(0,212,255,.15)"><div class="card-b"><div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap"><div style="flex:1;min-width:200px"><div style="display:flex;align-items:center;gap:8px;margin-bottom:4px"><span style="font-size:13px;font-weight:700">í˜„ì¬ í”Œëœ</span>'+UI.pb(cur)+'</div><div style="font-size:12px;color:var(--w40)">'+plans.find(function(p){return p.id===cur;}).desc+'</div></div><div style="display:flex;gap:16px;flex-wrap:wrap"><div style="text-align:center;padding:10px 16px;border-radius:10px;background:var(--w08)"><div style="font-size:11px;color:var(--w40);margin-bottom:2px">AI ë¶„ì„</div><div style="font-size:16px;font-weight:800;color:var(--pri)">'+aUsed+'<span style="font-size:11px;color:var(--w40);font-weight:400">/'+aMax+'</span></div><div style="height:4px;border-radius:2px;background:var(--w08);margin-top:4px;width:60px"><div style="height:100%;border-radius:2px;background:var(--pri);width:'+Math.min(aUsed/aMax*100,100)+'%"></div></div></div><div style="text-align:center;padding:10px 16px;border-radius:10px;background:var(--w08)"><div style="font-size:11px;color:var(--w40);margin-bottom:2px">ì œí’ˆ</div><div style="font-size:16px;font-weight:800;color:var(--acc)">'+pUsed+'</div></div><div style="text-align:center;padding:10px 16px;border-radius:10px;background:var(--w08)"><div style="font-size:11px;color:var(--w40);margin-bottom:2px">í”„ë¡œì íŠ¸</div><div style="font-size:16px;font-weight:800;color:var(--ok)">'+pjUsed+'</div></div></div></div></div></div>'+

  /* Plan cards */
  '<div class="grid-4" style="margin-bottom:20px">'+plans.map(function(p){
    var isCur=cur===p.id;
    var isUp=plans.findIndex(function(x){return x.id===p.id;})>plans.findIndex(function(x){return x.id===cur;});
    return '<div class="plan-card '+(isCur?'current':'')+' '+(p.rec?'recommended':'')+'" style="position:relative">'+
      (p.rec&&!isCur?'<div style="position:absolute;top:-10px;left:50%;transform:translateX(-50%);padding:3px 14px;border-radius:20px;background:var(--acc-g);font-size:10px;font-weight:800;color:var(--bg);white-space:nowrap">â­ ì¶”ì²œ</div>':'')+
      (isCur?'<div style="font-size:10px;font-weight:800;color:var(--pri);margin-bottom:4px;display:flex;align-items:center;gap:4px"><span style="width:6px;height:6px;border-radius:50%;background:var(--pri)"></span> í˜„ì¬ í”Œëœ</div>':'')+
      '<div class="plan-name" style="color:'+p.c+'">'+p.n+'</div>'+
      '<div class="plan-price">'+p.prd+'<span class="plan-period">'+p.pe+'</span></div>'+
      '<div class="plan-features">'+p.f.map(function(f){return '<div>âœ“ '+f+'</div>';}).join('')+'</div>'+
      (!isCur?'<button class="btn '+(isUp?'btn-pri':'btn-ghost')+' btn-block" style="margin-top:14px;'+(isUp?'':'border-color:'+p.c+';color:'+p.c)+'" onclick="App.openCheckout(\''+p.id+'\')">'+(isUp?'ì—…ê·¸ë ˆì´ë“œ':'ë‹¤ìš´ê·¸ë ˆì´ë“œ')+'</button>':
      '<div style="margin-top:14px;text-align:center;font-size:12px;color:var(--w20)">í˜„ì¬ ì´ìš© ì¤‘</div>')+
    '</div>';
  }).join('')+'</div>'+

  /* Voucher notice */
  '<div class="card" style="border-color:rgba(255,184,0,.2)"><div class="card-b" style="display:flex;align-items:center;gap:14px;flex-wrap:wrap"><span style="font-size:28px">ğŸ›ï¸</span><div style="flex:1;min-width:200px"><div style="font-weight:700;color:var(--acc)">ì •ë¶€ ë°”ìš°ì²˜ë¡œ ê²°ì œ ê°€ëŠ¥</div><div style="font-size:12px;color:var(--w40);margin-top:2px">ìˆ˜ì¶œë°”ìš°ì²˜Â·í˜ì‹ ë°”ìš°ì²˜ ìµœëŒ€ 85% ì§€ì›. ëª¨ë“  ìœ ë£Œ í”Œëœ ì ìš© ê°€ëŠ¥.</div></div><button class="btn btn-acc btn-sm" onclick="App.reqSvc(\'certification\')">ë°”ìš°ì²˜ ìƒë‹´</button></div></div>';
}

function openCheckout(planId){
  var plans={basic:{n:'BASIC',pr:300000,c:'var(--pri)'},pro:{n:'PRO',pr:800000,c:'var(--acc)'},alibaba:{n:'ALIBABA',pr:1000000,c:'var(--err)'},free:{n:'FREE',pr:0,c:'var(--w40)'}};
  var p=plans[planId];if(!p)return;
  var cur=S.user&&S.user.plan||'free';
  var isDown=Object.keys(plans).indexOf(planId)<Object.keys(plans).indexOf(cur);

  if(planId==='free'){
    if(!confirm('FREEë¡œ ë‹¤ìš´ê·¸ë ˆì´ë“œí•˜ë©´ ìœ ë£Œ ê¸°ëŠ¥ì´ ì œí•œë©ë‹ˆë‹¤. ê³„ì†í• ê¹Œìš”?'))return;
    chgPlan('free');return;
  }

  var body='<div style="text-align:center;margin-bottom:20px"><div style="font-size:14px;color:var(--w40);margin-bottom:4px">'+(isDown?'ë‹¤ìš´ê·¸ë ˆì´ë“œ':'ì—…ê·¸ë ˆì´ë“œ')+'</div><div style="font-size:28px;font-weight:900;color:'+p.c+'">'+p.n+'</div><div style="font-size:24px;font-weight:800;margin-top:4px">â‚©'+p.pr.toLocaleString()+'<span style="font-size:12px;color:var(--w40);font-weight:400">/ì›”</span></div></div>'+
    '<div style="padding:16px;border-radius:12px;background:var(--w08);margin-bottom:16px"><div style="font-size:12px;font-weight:700;color:var(--w60);margin-bottom:8px">ê²°ì œ ìˆ˜ë‹¨</div>'+
    '<div style="display:flex;gap:8px;margin-bottom:12px"><div style="flex:1;padding:14px;border-radius:10px;border:2px solid var(--pri);background:rgba(0,212,255,.06);text-align:center;cursor:pointer;font-size:13px;font-weight:700;color:var(--pri)">ğŸ’³ ì¹´ë“œ ê²°ì œ</div><div style="flex:1;padding:14px;border-radius:10px;border:2px solid var(--bd);text-align:center;cursor:pointer;font-size:13px;color:var(--w40)">ğŸ›ï¸ ë°”ìš°ì²˜</div></div>'+
    '<div style="font-size:11px;color:var(--w20);text-align:center">ê²°ì œëŠ” Tosspaymentsë¥¼ í†µí•´ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬ë©ë‹ˆë‹¤</div></div>'+
    '<div style="padding:14px;border-radius:10px;border:1px solid var(--bd);margin-bottom:14px"><div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:6px"><span style="color:var(--w40)">'+p.n+' ì›”ê°„ êµ¬ë…</span><span style="font-weight:700">â‚©'+p.pr.toLocaleString()+'</span></div><div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:6px"><span style="color:var(--w40)">ë¶€ê°€ì„¸ (10%)</span><span style="font-weight:700">â‚©'+Math.round(p.pr*0.1).toLocaleString()+'</span></div><div style="border-top:1px solid var(--bd);padding-top:8px;margin-top:8px;display:flex;justify-content:space-between;font-size:15px;font-weight:800"><span>ì´ ê²°ì œê¸ˆì•¡</span><span style="color:'+p.c+'">â‚©'+Math.round(p.pr*1.1).toLocaleString()+'</span></div></div>';

  document.body.insertAdjacentHTML('beforeend',UI.modal({id:'ckm',title:'ğŸ’ í”Œëœ ë³€ê²½',body:body,footer:'<button class="btn btn-ghost" onclick="App.closeModal(\'ckm\')">ì·¨ì†Œ</button><button class="btn btn-pri" onclick="App.confirmCheckout(\''+planId+'\')">ê²°ì œí•˜ê¸°</button>',width:'460px'}));UI.showModal('ckm');
}

function confirmCheckout(planId){
  /* ì‹¤ì œ ê²°ì œ ì—°ë™ ì „ â€” í”Œëœ ë³€ê²½ë§Œ ì²˜ë¦¬ */
  UI.toast('ê²°ì œ ì²˜ë¦¬ ì¤‘...','info');
  setTimeout(function(){
    chgPlan(planId);
    closeModal('ckm');
  },1200);
}

function chgPlan(id){sb.from('users').update({plan:id}).eq('id',S.user.id).then(function(){S.user.plan=id;render();UI.toast(id.toUpperCase()+' í”Œëœìœ¼ë¡œ ë³€ê²½ ì™„ë£Œ!','ok');});}

function pgSettings(){
  var c=S.company||{};
  return '<div style="margin-bottom:20px"><h2 style="font-size:18px;font-weight:800">âš™ï¸ ì„¤ì •</h2></div><form id="stf" onsubmit="event.preventDefault();App.saveSt()"><div class="card" style="margin-bottom:14px"><div class="card-h">ğŸ¢ íšŒì‚¬ ì •ë³´</div><div class="card-b"><div class="grid-2">'+UI.inp('name_ko','íšŒì‚¬ëª…(í•œê¸€)',{value:c.name_ko||''})+UI.inp('name_en','íšŒì‚¬ëª…(ì˜ë¬¸)',{value:c.name_en||''})+'</div><div class="grid-2">'+UI.inp('address_ko','ì£¼ì†Œ(í•œê¸€)',{value:c.address_ko||''})+UI.inp('address_en','ì£¼ì†Œ(ì˜ë¬¸)',{value:c.address_en||''})+'</div><div class="grid-2">'+UI.inp('ceo_name_ko','ëŒ€í‘œì(í•œê¸€)',{value:c.ceo_name_ko||''})+UI.inp('ceo_name_en','ëŒ€í‘œì(ì˜ë¬¸)',{value:c.ceo_name_en||''})+'</div><div class="grid-3">'+UI.inp('phone','ì „í™”',{value:c.phone||''})+UI.inp('fax','íŒ©ìŠ¤',{value:c.fax||''})+UI.inp('biz_number','ì‚¬ì—…ìë²ˆí˜¸',{value:c.biz_number||''})+'</div></div></div><div class="card" style="margin-bottom:14px"><div class="card-h">ğŸ¦ ì€í–‰</div><div class="card-b"><div class="grid-3">'+UI.inp('bank_name','ì€í–‰(ì˜ë¬¸)',{value:c.bank_name||''})+UI.inp('bank_account','ê³„ì¢Œ',{value:c.bank_account||''})+UI.inp('swift_code','SWIFT',{value:c.swift_code||''})+'</div></div></div><button class="btn btn-pri btn-lg" type="submit">ğŸ’¾ ì €ì¥</button></form>';
}

function saveSt(){
  var d=UI.fd('#stf');
  var q=S.company&&S.company.id?sb.from('companies').update(d).eq('id',S.company.id):sb.from('companies').insert(Object.assign(d,{user_id:S.user.id}));
  q.then(function(r){
    if(r.error){UI.toast('ì‹¤íŒ¨: '+r.error.message,'err');return;}
    if(d.name_ko)sb.from('users').update({company_name:d.name_ko}).eq('id',S.user.id).then(function(){S.user.company_name=d.name_ko;});
    sb.from('companies').select('*').eq('user_id',S.user.id).maybeSingle().then(function(cr){S.company=cr.data;render();UI.toast('ì €ì¥!','ok');});
  });
}

function pgBuyers(){
  return '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px"><div><h2 style="font-size:18px;font-weight:800">ğŸ¤ ë°”ì´ì–´</h2></div><button class="btn btn-pri" onclick="App.showBF()">+ ë“±ë¡</button></div><div class="card"><div class="card-b" style="padding:0">'+(S.buyers.length===0?'<div style="padding:18px">'+UI.empty('ğŸ¤','ì—†ìŒ','ë°”ì´ì–´ë¥¼ ë“±ë¡í•˜ì„¸ìš”')+'</div>':'<table class="tbl"><thead><tr><th>íšŒì‚¬</th><th>ë‹´ë‹¹ì</th><th>êµ­ê°€</th><th>ì´ë©”ì¼</th></tr></thead><tbody>'+S.buyers.map(function(b){return '<tr><td style="font-weight:600">'+b.company_name+'</td><td>'+(b.contact_name||'\u2014')+'</td><td>'+U.cl(b.country)+'</td><td style="font-size:12px;color:var(--w40)">'+(b.email||'\u2014')+'</td></tr>';}).join('')+'</tbody></table>')+'</div></div>';
}

function showBF(){
  var body='<form id="bf">'+UI.inp('company_name','íšŒì‚¬ëª… *',{required:true})+'<div class="grid-2">'+UI.inp('contact_name','ë‹´ë‹¹ì')+UI.inp('email','ì´ë©”ì¼')+'</div><div class="grid-2">'+UI.inp('country','êµ­ê°€ì½”ë“œ',{placeholder:'US, JP...'})+UI.inp('phone','ì „í™”')+'</div>'+UI.ta('notes','ë©”ëª¨')+'</form>';
  document.body.insertAdjacentHTML('beforeend',UI.modal({id:'bm',title:'ë°”ì´ì–´ ë“±ë¡',body:body,footer:'<button class="btn btn-ghost" onclick="App.closeModal(\'bm\')">ì·¨ì†Œ</button><button class="btn btn-pri" onclick="App.saveBuyer()">ì €ì¥</button>'}));UI.showModal('bm');
}

function saveBuyer(){
  var d=UI.fd('#bf');if(!d.company_name){UI.toast('íšŒì‚¬ëª…','warn');return;}d.registered_by=S.user.id;
  sb.from('buyers').insert(d).then(function(r){if(r.error){UI.toast('ì‹¤íŒ¨','err');return;}closeModal('bm');loadB().then(function(){render();UI.toast('ë“±ë¡!','ok');});});
}

/* === NAV & RENDER === */
function nav(p){S.page=p;S.currentAnalysis=null;S.currentProject=null;S.analysisStep=0;S.analysisData=null;S.docType=null;render();var pc=document.querySelector('.page-content');if(pc)pc.scrollTop=0;}
function closeModal(id){UI.hideModal(id);setTimeout(function(){var e=document.getElementById(id);if(e)e.remove();},300);}

var PL={dashboard:'ğŸ“Š ëŒ€ì‹œë³´ë“œ',analysis:'ğŸ”¬ AI ë¶„ì„',products:'ğŸ“¦ ì œí’ˆ ì¹´ë“œ',projects:'ğŸš€ í”„ë¡œì íŠ¸',services:'ğŸ’¼ ì„œë¹„ìŠ¤',docgen:'ğŸ“„ ì„œë¥˜',emailhub:'âœ‰ï¸ ì´ë©”ì¼',costsim:'ğŸ§® ì›ê°€',subscription:'ğŸ’ êµ¬ë…',settings:'âš™ï¸ ì„¤ì •',buyers:'ğŸ¤ ë°”ì´ì–´'};

function renderPage(){
  switch(S.page){case'dashboard':return pgDash();case'analysis':return pgAnalysis();case'products':return pgProducts();case'projects':return pgProjects();case'services':return pgServices();case'docgen':return pgDocgen();case'emailhub':return pgEmail();case'costsim':return pgCost();case'subscription':return pgSub();case'settings':return pgSettings();case'buyers':return pgBuyers();default:return pgDash();}
}

function renderSidebar(){
  var menu=[{id:'dashboard',icon:'ğŸ“Š',label:'ëŒ€ì‹œë³´ë“œ'},{id:'analysis',icon:'ğŸ”¬',label:'AI ìˆ˜ì¶œ ë¶„ì„'},{id:'projects',icon:'ğŸš€',label:'í”„ë¡œì íŠ¸'},{id:'div'},{id:'products',icon:'ğŸ“¦',label:'ì œí’ˆ ì¹´ë“œ'},{id:'buyers',icon:'ğŸ¤',label:'ë°”ì´ì–´'},{id:'docgen',icon:'ğŸ“„',label:'ì„œë¥˜ ìƒì„±'},{id:'emailhub',icon:'âœ‰ï¸',label:'ì´ë©”ì¼ í—ˆë¸Œ'},{id:'div'},{id:'services',icon:'ğŸ’¼',label:'ì„œë¹„ìŠ¤ ì‹ ì²­'},{id:'costsim',icon:'ğŸ§®',label:'ì›ê°€ ê³„ì‚°'},{id:'subscription',icon:'ğŸ’',label:'êµ¬ë…'},{id:'div'},{id:'settings',icon:'âš™ï¸',label:'ì„¤ì •'}];
  return '<div class="sidebar"><div class="sidebar-header"><div class="sidebar-logo">W</div><div><div class="sidebar-title">Whistle AI</div><div class="sidebar-sub">'+UI.pb(S.user&&S.user.plan||'free')+'</div></div></div><div class="sidebar-nav">'+menu.map(function(m){if(m.id==='div')return '<div class="nav-section"></div>';return '<div class="nav-item '+(S.page===m.id?'active':'')+'" onclick="App.nav(\''+m.id+'\')"><span class="icon">'+m.icon+'</span><span>'+m.label+'</span></div>';}).join('')+'</div><div class="sidebar-footer"><div class="nav-item" onclick="App.doLogout()" style="color:var(--w40)"><span class="icon">ğŸšª</span><span>ë¡œê·¸ì•„ì›ƒ</span></div></div></div>';
}

function render(){
  var app=document.getElementById('app');
  if(S.loading){app.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100vh"><div style="text-align:center"><div class="spinner" style="width:40px;height:40px;border-width:4px;margin:0 auto 16px"></div><div style="font-size:14px;color:var(--w40)">ë¡œë”© ì¤‘...</div></div></div>';return;}
  if(!S.user){app.innerHTML=pgAuth();return;}
  var ps=S.serviceRequests.filter(function(s){return s.status==='pending'||s.status==='processing';}).length;
  app.innerHTML='<div class="app-layout">'+renderSidebar()+'<div class="mob-overlay" onclick="App.closeMob()"></div><div class="main-area"><div class="topbar"><div style="display:flex;align-items:center;gap:10px"><button class="mob-toggle" onclick="App.toggleMob()">â˜°</button><div class="topbar-title">'+(PL[S.page]||'')+'</div></div><div style="display:flex;align-items:center;gap:12px"><div style="position:relative;cursor:pointer" onclick="App.nav(\'services\')" title="ì„œë¹„ìŠ¤ í˜„í™©"><span style="font-size:16px">ğŸ””</span>'+(ps>0?'<span class="notif-dot"></span>':'')+'</div><span style="font-size:13px;color:var(--w40)">'+S.user.email+'</span><div style="width:30px;height:30px;border-radius:8px;background:var(--pri-g);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:800;color:var(--bg)">'+(S.user.company_name||S.user.email||'U').charAt(0).toUpperCase()+'</div></div></div><div class="page-content">'+renderPage()+'</div></div></div>';
}

function toggleMob(){var sb=document.querySelector('.sidebar');if(sb)sb.classList.toggle('mobile-open');}
function closeMob(){var sb=document.querySelector('.sidebar');if(sb)sb.classList.remove('mobile-open');}

window.App={set:set,nav:nav,render:render,doLogin:doLogin,doSignup:doSignup,doLogout:doLogout,startAForm:startAForm,aStep:aStep,cancelA:cancelA,submitA:submitA,addUrl:addUrl,rmUrl:rmUrl,addSP:addSP,rmSP:rmSP,addFiles:addFiles,rmFile:rmFile,toggleMkt:toggleMkt,toggleCert:toggleCert,updateUSD:updateUSD,viewA:viewA,delA:delA,createPj:createPj,showPF:showPF,saveP:saveP,editP:editP,delP:delP,prevImg:prevImg,prodImgFile:prodImgFile,reqSvc:reqSvc,subSvc:subSvc,composeE:composeE,selEB:selEB,chgEP:chgEP,cpEmail:cpEmail,sendE:sendE,calcC:calcC,openCheckout:openCheckout,confirmCheckout:confirmCheckout,chgPlan:chgPlan,saveSt:saveSt,showBF:showBF,saveBuyer:saveBuyer,closeModal:closeModal,viewPj:viewPj,setPjStage:setPjStage,addPjNote:addPjNote,rmPjNote:rmPjNote,delPj:delPj,reqSvcForPj:reqSvcForPj,subSvcPj:subSvcPj,startDoc:startDoc,addDocItem:addDocItem,rmDocItem:rmDocItem,fillDocProd:fillDocProd,fillBuyerDoc:fillBuyerDoc,genDoc:genDoc,toggleMob:toggleMob,closeMob:closeMob,autoCreateProduct:autoCreateProduct,genCatalogEN:genCatalogEN,toggleStageItem:toggleStageItem,setCertStatus:setCertStatus,addCertItem:addCertItem};
loadUser();
})();
</script>
</body>
</html>
