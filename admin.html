<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Whistle AI â€” Admin Portal</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&family=Noto+Sans+KR:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root{--bg:#060B18;--bg2:#0A1020;--card:#0D1424;--card2:#111B2E;--sf:#111B2E;--pri:#00D4FF;--pri-g:linear-gradient(135deg,#00D4FF,#0088FF);--pri-d:#0088FF;--pri-glow:0 0 30px rgba(0,212,255,.12);--acc:#FFB800;--acc-g:linear-gradient(135deg,#FFB800,#FF8C00);--ok:#00E676;--err:#FF5252;--warn:#FFA726;--purple:#A855F7;--w:#fff;--w90:rgba(255,255,255,.9);--w70:rgba(255,255,255,.7);--w60:rgba(255,255,255,.6);--w40:rgba(255,255,255,.4);--w20:rgba(255,255,255,.2);--w12:rgba(255,255,255,.1);--w08:rgba(255,255,255,.06);--bd:rgba(255,255,255,.08);--bd-l:rgba(255,255,255,.15);--r:14px;--r-s:10px;--r-xs:6px;--shadow:0 4px 24px rgba(0,0,0,.4);--shadow-lg:0 12px 48px rgba(0,0,0,.6);--admin:#FF6B6B;--admin-g:linear-gradient(135deg,#FF6B6B,#EE5A24)}
*{box-sizing:border-box;margin:0;padding:0}html{scroll-behavior:smooth}
body{background:var(--bg);font-family:'Sora','Noto Sans KR',-apple-system,sans-serif;color:var(--w);line-height:1.5;overflow:hidden;height:100vh}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:var(--bg2)}::-webkit-scrollbar-thumb{background:var(--w12);border-radius:3px}::selection{background:rgba(255,107,107,.3)}
input:focus,textarea:focus,select:focus{outline:none;border-color:var(--admin)!important;box-shadow:0 0 0 3px rgba(255,107,107,.1)}
select option{background:var(--card);color:var(--w90)}textarea{resize:vertical;min-height:60px}a{color:var(--pri);text-decoration:none}
.app-layout{display:flex;height:100vh;overflow:hidden}
.sidebar{width:260px;background:var(--bg2);border-right:1px solid var(--bd);display:flex;flex-direction:column;flex-shrink:0;overflow-y:auto}
.sidebar-header{padding:16px;border-bottom:1px solid var(--bd);display:flex;align-items:center;gap:10px}
.sidebar-logo{width:36px;height:36px;border-radius:9px;background:var(--admin-g);display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:900;color:var(--w);flex-shrink:0}
.sidebar-title{font-size:15px;font-weight:800;letter-spacing:-.5px}
.sidebar-sub{font-size:10px;color:var(--admin);font-family:'JetBrains Mono';font-weight:600}
.sidebar-nav{flex:1;padding:8px;overflow-y:auto}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:var(--r-s);font-size:13px;font-weight:500;color:var(--w60);cursor:pointer;transition:all .15s;border:1px solid transparent;margin-bottom:2px}
.nav-item:hover{background:var(--w08);color:var(--w90)}
.nav-item.active{background:rgba(255,107,107,.08);color:var(--admin);border-color:rgba(255,107,107,.15);font-weight:600}
.nav-item .icon{font-size:16px;width:20px;text-align:center}
.nav-item .badge-count{margin-left:auto;font-size:10px;background:var(--err);color:var(--w);padding:1px 6px;border-radius:10px;font-weight:700}
.nav-section{height:1px;background:var(--bd);margin:8px 12px}
.sidebar-footer{padding:12px;border-top:1px solid var(--bd)}
.main-area{flex:1;display:flex;flex-direction:column;overflow:hidden}
.topbar{height:52px;background:rgba(6,11,24,.9);backdrop-filter:blur(12px);border-bottom:1px solid var(--bd);display:flex;align-items:center;justify-content:space-between;padding:0 24px;flex-shrink:0}
.topbar-title{font-size:15px;font-weight:700;display:flex;align-items:center;gap:8px}
.topbar-title .admin-tag{font-size:9px;padding:2px 6px;border-radius:4px;background:rgba(255,107,107,.15);color:var(--admin);font-weight:700;letter-spacing:1px}
.page-content{flex:1;overflow-y:auto;padding:24px}
.card{background:var(--card);border-radius:var(--r);border:1px solid var(--bd);overflow:hidden}
.card-h{padding:14px 18px;border-bottom:1px solid var(--bd);display:flex;align-items:center;justify-content:space-between;font-weight:700;font-size:14px}
.card-b{padding:18px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:9px 18px;border-radius:var(--r-s);font-size:13px;font-weight:600;font-family:inherit;cursor:pointer;border:none;transition:all .15s;white-space:nowrap}
.btn:hover{filter:brightness(1.1);transform:translateY(-1px)}.btn:active{transform:translateY(0)}.btn:disabled{opacity:.5;cursor:not-allowed}
.btn-pri{background:var(--pri-g);color:var(--bg);box-shadow:var(--pri-glow)}.btn-acc{background:var(--acc-g);color:var(--bg)}
.btn-admin{background:var(--admin-g);color:var(--w)}
.btn-ok{background:var(--ok);color:var(--bg)}.btn-ghost{background:transparent;color:var(--w);border:1.5px solid var(--bd-l)}
.btn-ghost:hover{border-color:var(--w40)}.btn-danger{background:rgba(255,82,82,.15);color:var(--err);border:1px solid rgba(255,82,82,.2)}
.btn-sm{padding:5px 12px;font-size:12px;border-radius:var(--r-xs)}.btn-lg{padding:12px 24px;font-size:14px}.btn-block{width:100%}
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:var(--r-xs);font-size:11px;font-weight:600;font-family:'JetBrains Mono',monospace}
.badge-pri{background:rgba(0,212,255,.1);color:var(--pri);border:1px solid rgba(0,212,255,.2)}
.badge-acc{background:rgba(255,184,0,.1);color:var(--acc);border:1px solid rgba(255,184,0,.2)}
.badge-ok{background:rgba(0,230,118,.1);color:var(--ok);border:1px solid rgba(0,230,118,.2)}
.badge-err{background:rgba(255,82,82,.1);color:var(--err);border:1px solid rgba(255,82,82,.2)}
.badge-purple{background:rgba(168,85,247,.1);color:var(--purple);border:1px solid rgba(168,85,247,.2)}
.badge-ghost{background:var(--w08);color:var(--w40);border:1px solid var(--bd)}
.badge-admin{background:rgba(255,107,107,.1);color:var(--admin);border:1px solid rgba(255,107,107,.2)}
.form-group{margin-bottom:14px}
.form-label{display:block;font-size:12px;font-weight:600;color:var(--w40);margin-bottom:6px}
.form-input,.form-select,.form-textarea{width:100%;padding:11px 14px;border-radius:var(--r-s);border:1.5px solid var(--bd);background:var(--sf);color:var(--w90);font-size:14px;font-family:inherit}
.form-input::placeholder{color:var(--w20)}
.tbl{width:100%;border-collapse:collapse}
.tbl th{text-align:left;padding:10px 14px;font-size:11px;font-weight:600;color:var(--w40);text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--bd-l);background:var(--w08)}
.tbl td{padding:11px 14px;font-size:13px;border-bottom:1px solid var(--w08);color:var(--w90)}
.tbl tr:hover td{background:var(--w08)}
.tbl tr{cursor:pointer}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
.grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.grid-5{display:grid;grid-template-columns:repeat(5,1fr);gap:12px}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;visibility:hidden;transition:all .2s}
.modal-overlay.show{opacity:1;visibility:visible}
.modal{background:var(--card);border:1px solid var(--bd-l);border-radius:var(--r);width:90%;max-width:640px;max-height:85vh;overflow-y:auto;box-shadow:var(--shadow-lg)}
.modal-h{padding:16px 20px;border-bottom:1px solid var(--bd);display:flex;align-items:center;justify-content:space-between}
.modal-h h3{font-size:16px;font-weight:700}
.modal-close{width:28px;height:28px;border-radius:8px;background:var(--w08);border:none;color:var(--w40);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.modal-close:hover{background:var(--w12);color:var(--w)}
.modal-b{padding:20px}.modal-f{padding:14px 20px;border-top:1px solid var(--bd);display:flex;justify-content:flex-end;gap:8px}
.toast-container{position:fixed;top:16px;right:16px;z-index:2000;display:flex;flex-direction:column;gap:8px}
.toast{padding:12px 18px;border-radius:var(--r-s);font-size:13px;font-weight:500;display:flex;align-items:center;gap:8px;box-shadow:var(--shadow);animation:slideInR .3s ease;min-width:280px}
.toast-ok{background:#0a2a1a;border:1px solid rgba(0,230,118,.25);color:var(--ok)}
.toast-err{background:#2a0a0a;border:1px solid rgba(255,82,82,.25);color:var(--err)}
.toast-warn{background:#2a1a0a;border:1px solid rgba(255,167,38,.25);color:var(--warn)}
.toast-info{background:#0a1a2a;border:1px solid rgba(0,212,255,.25);color:var(--pri)}
.stat-card{background:var(--card);border:1px solid var(--bd);border-radius:var(--r);padding:18px}
.stat-label{font-size:11px;color:var(--w40);font-weight:500;margin-bottom:6px}
.stat-value{font-family:'Sora';font-weight:800;font-size:26px;letter-spacing:-1px}
.stat-sub{font-size:11px;color:var(--w20);margin-top:4px}
.spinner{width:24px;height:24px;border:3px solid var(--w08);border-top-color:var(--admin);border-radius:50%;animation:spin .8s linear infinite}
.auth-wrap{display:flex;align-items:center;justify-content:center;height:100vh;background:var(--bg);padding:20px}
.auth-card{width:100%;max-width:420px;background:var(--card);border:1px solid rgba(255,107,107,.2);border-radius:20px;padding:36px;box-shadow:var(--shadow-lg)}
.search-box{position:relative}
.search-box input{width:100%;padding:9px 14px 9px 36px;border-radius:var(--r-s);border:1.5px solid var(--bd);background:var(--sf);color:var(--w90);font-size:13px;font-family:inherit}
.search-box::before{content:'ğŸ”';position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:14px}
.status-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:6px}
.status-dot.active{background:var(--ok)}.status-dot.inactive{background:var(--err)}.status-dot.pending{background:var(--acc)}
.detail-row{display:grid;grid-template-columns:140px 1fr;gap:8px;padding:8px 0;border-bottom:1px solid var(--w08);font-size:13px}
.detail-label{color:var(--w40);font-weight:500}
.detail-value{color:var(--w90)}
.chart-bar{height:24px;border-radius:6px;position:relative;overflow:hidden;background:var(--w08)}
.chart-bar-fill{height:100%;border-radius:6px;transition:width .5s ease}
.tab-bar{display:flex;gap:4px;margin-bottom:16px;border-bottom:1px solid var(--bd);padding-bottom:8px}
.tab-item{padding:6px 14px;font-size:13px;font-weight:500;color:var(--w40);cursor:pointer;border-radius:var(--r-xs) var(--r-xs) 0 0;transition:all .15s}
.tab-item:hover{color:var(--w70);background:var(--w08)}
.tab-item.active{color:var(--admin);background:rgba(255,107,107,.08);font-weight:700}
.empty-state{text-align:center;padding:48px 24px;color:var(--w40)}
.empty-state .ei{font-size:48px;margin-bottom:12px;opacity:.4}
.empty-state .et{font-size:16px;font-weight:700;margin-bottom:4px;color:var(--w60)}
.empty-state .ed{font-size:13px}
@keyframes slideInR{from{transform:translateX(100px);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
@media(max-width:768px){.sidebar{display:none}.grid-2,.grid-3,.grid-4,.grid-5{grid-template-columns:1fr}.page-content{padding:16px}}
</style>
</head>
<body>
<div id="app"></div>
<script>
(function(){
"use strict";
var sb=window.supabase.createClient('https://lylktgxngrlxmsldxdqj.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx5bGt0Z3huZ3JseG1zbGR4ZHFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4MTQ2OTAsImV4cCI6MjA4NzM5MDY5MH0.8kgcDCMBT_STf43MVkeUUiq-K6r-Ytp3nUQ6d-nL2D0');

/* === UTILS === */
var U={
  fd:function(d,s){if(!d)return'\u2014';var dt=new Date(d);if(isNaN(dt))return'\u2014';if(s==='rel'){var m=Math.floor((Date.now()-dt)/6e4);if(m<1)return'\uBC29\uAE08';if(m<60)return m+'\uBD84 \uC804';var h=Math.floor(m/60);if(h<24)return h+'\uC2DC\uAC04 \uC804';var dd=Math.floor(h/24);return dd+'\uC77C \uC804';}return dt.toLocaleDateString('ko-KR',{year:'numeric',month:'short',day:'numeric'});},
  usd:function(n){if(n==null)return'\u2014';return'$'+Number(n).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});},
  krw:function(n){if(n==null)return'\u2014';n=Number(n);if(n>=1e8)return'\u20A9'+(n/1e8).toFixed(1)+'\uC5B5';if(n>=1e4)return'\u20A9'+(n/1e4).toFixed(0)+'\uB9CC';return'\u20A9'+n.toLocaleString('ko-KR');},
  tr:function(s,l){l=l||50;return s&&s.length>l?s.slice(0,l)+'\u2026':s||'';},
  sl:function(t){return{premium_analysis:'\uD504\uB9AC\uBBF8\uC5C4 \uBD84\uC11D',matching:'\uBC14\uC774\uC5B4 \uB9E4\uCE6D',document:'\uC11C\uB958 \uB300\uD589',certification:'\uC778\uC99D \uB300\uD589',logistics:'\uBB3C\uB958/\uD1B5\uAD00',email_support:'\uC774\uBA54\uC77C \uC9C0\uC6D0'}[t]||t;},
  si:function(t){return{premium_analysis:'\uD83D\uDD2C',matching:'\uD83E\uDD1D',document:'\uD83D\uDCC4',certification:'\uD83C\uDFC5',logistics:'\uD83D\uDEA2',email_support:'\u2709\uFE0F'}[t]||'\uD83D\uDCCB';},
  cl:function(c){return{US:'\uD83C\uDDFA\uD83C\uDDF8',JP:'\uD83C\uDDEF\uD83C\uDDF5',CN:'\uD83C\uDDE8\uD83C\uDDF3',EU:'\uD83C\uDDEA\uD83C\uDDFA',SEA:'\uD83C\uDF0F'}[c]||c||'';},
  pl:function(p){return{free:['FREE','var(--w40)'],basic:['BASIC','var(--pri)'],pro:['PRO','var(--acc)'],alibaba:['ALIBABA','var(--admin)']}[p]||['FREE','var(--w40)'];},
  pct:function(n,t){return t?Math.round(n/t*100):0;}
};

/* === UI === */
var tc=null;
var UI={
  toast:function(msg,type,dur){type=type||'info';dur=dur||3000;if(!tc){tc=document.createElement('div');tc.className='toast-container';document.body.appendChild(tc);}var icons={ok:'\u2713',err:'\u2715',warn:'\u26A0',info:'\u2139'};var el=document.createElement('div');el.className='toast toast-'+type;el.innerHTML='<span>'+((icons[type])||'\u2139')+'</span><span>'+msg+'</span>';tc.appendChild(el);setTimeout(function(){el.style.opacity='0';el.style.transform='translateX(100px)';el.style.transition='all .3s';setTimeout(function(){el.remove();},300);},dur);},
  showModal:function(id){var e=document.getElementById(id);if(e)e.classList.add('show');},
  hideModal:function(id){var e=document.getElementById(id);if(e)e.classList.remove('show');},
  modal:function(o){return'<div class="modal-overlay" id="'+o.id+'" onclick="if(event.target===this)Adm.closeModal(\''+o.id+'\')"><div class="modal" style="max-width:'+(o.width||'640px')+'"><div class="modal-h"><h3>'+o.title+'</h3><button class="modal-close" onclick="Adm.closeModal(\''+o.id+'\')">&#10005;</button></div><div class="modal-b">'+o.body+'</div>'+(o.footer?'<div class="modal-f">'+o.footer+'</div>':'')+'</div></div>';},
  badge:function(t,type){return'<span class="badge badge-'+(type||'pri')+'">'+t+'</span>';},
  sb:function(s){var m={pending:['ëŒ€ê¸°','acc'],processing:['ì²˜ë¦¬ì¤‘','pri'],completed:['ì™„ë£Œ','ok'],cancelled:['ì·¨ì†Œ','ghost'],failed:['ì‹¤íŒ¨','err'],draft:['ì´ˆì•ˆ','ghost'],active:['í™œì„±','ok'],paused:['ì¤‘ì§€','acc'],analyzing:['ë¶„ì„ì¤‘','pri'],review:['ê²€ìˆ˜ì¤‘','purple'],approved:['ìŠ¹ì¸','ok'],accepted:['ì ‘ìˆ˜','pri'],planning:['ê¸°íš','pri'],certification:['ì¸ì¦','acc'],buyer_search:['ë§¤ì¹­','purple'],negotiation:['í˜‘ìƒ','acc'],shipping:['ì„ ì ','pri']};var r=m[s]||[s,'ghost'];return this.badge(r[0],r[1]);},
  empty:function(icon,title,desc){return'<div class="empty-state"><div class="ei">'+icon+'</div><div class="et">'+title+'</div><div class="ed">'+(desc||'')+'</div></div>';},
  stat:function(label,value,sub,color){return'<div class="stat-card"><div class="stat-label">'+label+'</div><div class="stat-value" style="color:'+(color||'var(--admin)')+'">'+value+'</div>'+(sub?'<div class="stat-sub">'+sub+'</div>':'')+'</div>';},
  inp:function(name,label,o){o=o||{};return'<div class="form-group"><label class="form-label">'+label+(o.required?' <span style="color:var(--err)">*</span>':'')+'</label><input class="form-input" name="'+name+'" type="'+(o.type||'text')+'" value="'+(o.value||'')+'" placeholder="'+(o.placeholder||'')+'" '+(o.required?'required':'')+'></div>';},
  sel:function(name,label,opts,sel){var os=opts.map(function(o){var v=typeof o==='object'?o.value:o;var t=typeof o==='object'?o.label:o;return'<option value="'+v+'" '+(v===sel?'selected':'')+'>'+t+'</option>';}).join('');return'<div class="form-group"><label class="form-label">'+label+'</label><select class="form-select" name="'+name+'">'+os+'</select></div>';},
  ta:function(name,label,o){o=o||{};return'<div class="form-group"><label class="form-label">'+label+'</label><textarea class="form-textarea" name="'+name+'" rows="'+(o.rows||3)+'" placeholder="'+(o.placeholder||'')+'">'+(o.value||'')+'</textarea></div>';},
  fd:function(sel){var el=typeof sel==='string'?document.querySelector(sel):sel;if(!el)return{};var d={};el.querySelectorAll('input,select,textarea').forEach(function(i){if(i.name){d[i.name]=i.type==='number'&&i.value?Number(i.value):i.value;}});return d;},
  pb:function(p){var r=U.pl(p);return'<span class="badge" style="background:'+r[1]+'15;color:'+r[1]+';border:1px solid '+r[1]+'25">'+r[0]+'</span>';}
};

/* === STATE === */
var S={
  user:null,page:'dashboard',loading:true,authError:'',
  users:[],analyses:[],products:[],projects:[],serviceRequests:[],companies:[],matchings:[],documents:[],
  searchFilter:'',statusFilter:'all',dateFilter:'all',
  selectedUser:null,selectedAnalysis:null,selectedSR:null,
  tab:'all'
};

function set(u){for(var k in u)S[k]=u[k];render();}

/* === DATA LOADING === */
function loadUser(){
  sb.auth.getSession().then(function(res){
    var session=res.data.session;
    if(!session)return set({loading:false});
    sb.from('users').select('*').eq('id',session.user.id).single().then(function(r){
      if(r.error||!r.data||r.data.role!=='admin'){
        sb.auth.signOut();
        return set({loading:false,authError:'ê´€ë¦¬ì ê³„ì •ë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤'});
      }
      S.user=r.data;S.loading=false;
      loadAll();
    });
  });
}

function loadAll(){
  Promise.allSettled([
    sb.from('users').select('*').order('created_at',{ascending:false}).then(function(r){S.users=r.data||[];}),
    sb.from('analyses').select('*').order('created_at',{ascending:false}).then(function(r){S.analyses=r.data||[];}),
    sb.from('products').select('*').order('created_at',{ascending:false}).then(function(r){S.products=r.data||[];}),
    sb.from('projects').select('*').order('created_at',{ascending:false}).then(function(r){S.projects=r.data||[];}),
    sb.from('service_requests').select('*').order('created_at',{ascending:false}).then(function(r){S.serviceRequests=r.data||[];}),
    sb.from('companies').select('*').order('created_at',{ascending:false}).then(function(r){S.companies=r.data||[];}),
    sb.from('matchings').select('*').order('created_at',{ascending:false}).then(function(r){S.matchings=r.data||[];}),
    sb.from('documents').select('*').order('created_at',{ascending:false}).then(function(r){S.documents=r.data||[];})
  ]).then(function(){render();});
}

/* === AUTH === */
function doLogin(e){
  e.preventDefault();var f=e.target;S.authError='';
  sb.auth.signInWithPassword({email:f.email.value,password:f.password.value}).then(function(r){
    if(r.error)return set({authError:r.error.message==='Invalid login credentials'?'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.':r.error.message});
    loadUser();
  });
}
function doLogout(){if(confirm('ë¡œê·¸ì•„ì›ƒ?')){sb.auth.signOut().then(function(){S.user=null;render();});}}

/* === HELPER === */
function getUserName(uid){var u=S.users.find(function(x){return x.id===uid;});return u?(u.company_name||u.display_name||u.email):'ì•Œìˆ˜ì—†ìŒ';}
function getCompany(uid){return S.companies.find(function(x){return x.user_id===uid;})||null;}
function filterBySearch(arr,fields){
  var q=S.searchFilter.toLowerCase().trim();
  if(!q)return arr;
  return arr.filter(function(item){
    return fields.some(function(f){
      var v=item[f];
      return v&&String(v).toLowerCase().indexOf(q)>=0;
    });
  });
}

/* ============ PAGES ============ */

/* â”€â”€ Auth â”€â”€ */
function pgAuth(){
  return '<div class="auth-wrap"><div class="auth-card"><div style="display:flex;align-items:center;gap:10px;margin-bottom:28px"><div style="width:42px;height:42px;border-radius:10px;background:var(--admin-g);display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:900;color:var(--w)">W</div><div><div style="font-size:22px;font-weight:800;letter-spacing:-.5px">Whistle AI</div><div style="font-size:12px;color:var(--admin);font-weight:600">ADMIN PORTAL</div></div></div>'+(S.authError?'<div style="padding:10px 14px;border-radius:8px;background:rgba(255,82,82,.1);border:1px solid rgba(255,82,82,.2);color:var(--err);font-size:12px;margin-bottom:12px">'+S.authError+'</div>':'')+'<form onsubmit="Adm.doLogin(event)">'+UI.inp('email','ì´ë©”ì¼',{type:'email',placeholder:'admin@whistle-ai.com',required:true})+UI.inp('password','ë¹„ë°€ë²ˆí˜¸',{type:'password',placeholder:'ë¹„ë°€ë²ˆí˜¸',required:true})+'<button class="btn btn-admin btn-block btn-lg" type="submit" style="margin-top:12px">ê´€ë¦¬ì ë¡œê·¸ì¸</button></form><div style="text-align:center;margin-top:16px;font-size:11px;color:var(--w20)">ê´€ë¦¬ì ê³„ì •ë§Œ ì ‘ê·¼ ê°€ëŠ¥</div></div></div>';
}

/* â”€â”€ Dashboard â”€â”€ */
function pgDash(){
  var tu=S.users.length;
  var clients=S.users.filter(function(u){return u.role==='client';});
  var ta=S.analyses.length;
  var ac=S.analyses.filter(function(a){return a.status==='completed';}).length;
  var tp=S.products.length;
  var tsr=S.serviceRequests.length;
  var pendSR=S.serviceRequests.filter(function(s){return s.status==='pending';}).length;
  var procSR=S.serviceRequests.filter(function(s){return s.status==='processing';}).length;
  var tj=S.projects.length;
  var activeJ=S.projects.filter(function(p){return p.status!=='completed';}).length;

  var planDist={free:0,basic:0,pro:0,alibaba:0};
  clients.forEach(function(u){planDist[u.plan||'free']=(planDist[u.plan||'free']||0)+1;});
  var maxPlan=Math.max(planDist.free,planDist.basic,planDist.pro,planDist.alibaba,1);

  var today=new Date();
  var t7=new Date(today-7*864e5);
  var t30=new Date(today-30*864e5);
  var newUsers7=S.users.filter(function(u){return new Date(u.created_at)>=t7;}).length;
  var newUsers30=S.users.filter(function(u){return new Date(u.created_at)>=t30;}).length;
  var newA7=S.analyses.filter(function(a){return new Date(a.created_at)>=t7;}).length;

  var recentA=S.analyses.slice(0,5);
  var recentSR=S.serviceRequests.slice(0,5);

  return '<div style="margin-bottom:20px"><h2 style="font-size:22px;font-weight:800">Admin Dashboard</h2><p style="font-size:13px;color:var(--w40);margin-top:4px">'+today.toLocaleDateString('ko-KR',{year:'numeric',month:'long',day:'numeric',weekday:'long'})+'</p></div>'+

  '<div class="grid-5" style="margin-bottom:20px">'+
    UI.stat('ì „ì²´ ìœ ì €',tu,'+'+newUsers7+' (7ì¼)','var(--pri)')+
    UI.stat('AI ë¶„ì„',ta,ac+' ì™„ë£Œ / '+newA7+' (7ì¼)','var(--acc)')+
    UI.stat('ì„œë¹„ìŠ¤ ìš”ì²­',tsr,pendSR+' ëŒ€ê¸° / '+procSR+' ì²˜ë¦¬ì¤‘','var(--admin)')+
    UI.stat('í”„ë¡œì íŠ¸',tj,activeJ+' ì§„í–‰ì¤‘','var(--ok)')+
    UI.stat('ë“±ë¡ ì œí’ˆ',tp,'','var(--purple)')+
  '</div>'+

  '<div class="grid-2" style="margin-bottom:20px">'+
    '<div class="card"><div class="card-h"><span>ğŸ“Š í”Œëœ ë¶„í¬</span>'+UI.badge(clients.length+'ëª…','pri')+'</div><div class="card-b">'+
      Object.keys(planDist).map(function(k){
        var r=U.pl(k);var pct=U.pct(planDist[k],maxPlan);
        return '<div style="margin-bottom:10px"><div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="font-size:12px;color:'+r[1]+';font-weight:600">'+r[0]+'</span><span style="font-size:12px;color:var(--w60);font-family:JetBrains Mono">'+planDist[k]+'ëª…</span></div><div class="chart-bar"><div class="chart-bar-fill" style="width:'+Math.max(pct,4)+'%;background:'+r[1]+'"></div></div></div>';
      }).join('')+
    '</div></div>'+

    '<div class="card"><div class="card-h"><span>ğŸ“ˆ ì‹ ê·œ ê°€ì… ì¶”ì´</span>'+UI.badge('+'+newUsers30+' (30ì¼)','ok')+'</div><div class="card-b">'+
      (function(){
        var days=[];for(var i=6;i>=0;i--){var d=new Date(today-i*864e5);days.push(d);}
        var maxD=1;
        var counts=days.map(function(d){
          var ds=d.toISOString().split('T')[0];
          var c=S.users.filter(function(u){return u.created_at&&u.created_at.startsWith(ds);}).length;
          if(c>maxD)maxD=c;return c;
        });
        return '<div style="display:flex;align-items:end;gap:6px;height:100px">'+days.map(function(d,i){
          var h=Math.max(counts[i]/maxD*80,4);
          var dn=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][d.getDay()];
          return '<div style="flex:1;text-align:center"><div style="height:'+h+'px;background:var(--admin-g);border-radius:4px 4px 0 0;margin:0 auto;width:80%"></div><div style="font-size:9px;color:var(--w40);margin-top:4px">'+dn+'</div><div style="font-size:10px;color:var(--w60);font-weight:600">'+counts[i]+'</div></div>';
        }).join('')+'</div>';
      })()+
    '</div></div>'+
  '</div>'+

  '<div class="grid-2">'+
    '<div class="card"><div class="card-h"><span>ğŸ”¬ ìµœê·¼ ë¶„ì„</span><button class="btn btn-ghost btn-sm" onclick="Adm.nav(\'analyses\')">ì „ì²´ â†’</button></div><div class="card-b">'+(recentA.length?recentA.map(function(a){
      var r=a.ai_result||{};var sc=r.overall_score;
      return '<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--w08);cursor:pointer" onclick="Adm.viewAnalysis(\''+a.id+'\')"><div style="width:36px;height:36px;border-radius:8px;background:'+(sc?'rgba(0,212,255,.1)':'var(--w08)')+';display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:800;color:var(--pri);flex-shrink:0">'+(sc||'?')+'</div><div style="flex:1;min-width:0"><div style="font-size:13px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+a.product_name+'</div><div style="font-size:11px;color:var(--w40)">'+getUserName(a.user_id)+' Â· '+U.fd(a.created_at,'rel')+'</div></div>'+UI.sb(a.status)+'</div>';
    }).join(''):UI.empty('ğŸ”¬','ë¶„ì„ ì—†ìŒ',''))+'</div></div>'+

    '<div class="card"><div class="card-h"><span>ğŸ’¼ ëŒ€ê¸° ì„œë¹„ìŠ¤</span>'+
      (pendSR?'<span class="badge badge-err" style="animation:pulse 2s infinite">'+pendSR+' ëŒ€ê¸°</span>':'')+
    '</div><div class="card-b">'+(recentSR.length?recentSR.map(function(sr){
      return '<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--w08);cursor:pointer" onclick="Adm.viewSR(\''+sr.id+'\')"><span style="font-size:18px">'+U.si(sr.service_type)+'</span><div style="flex:1"><div style="font-size:13px;font-weight:600">'+U.sl(sr.service_type)+'</div><div style="font-size:11px;color:var(--w40)">'+getUserName(sr.user_id)+' Â· '+U.fd(sr.created_at,'rel')+'</div></div>'+UI.sb(sr.status)+'</div>';
    }).join(''):UI.empty('ğŸ’¼','ì„œë¹„ìŠ¤ ì—†ìŒ',''))+'</div></div>'+
  '</div>';
}

/* â”€â”€ Users â”€â”€ */
function pgUsers(){
  if(S.selectedUser)return pgUserDetail();
  var filtered=filterBySearch(S.users,['email','company_name','display_name']);
  if(S.tab!=='all')filtered=filtered.filter(function(u){return u.plan===S.tab||u.role===S.tab;});

  var plans=['all','free','basic','pro','alibaba'];
  return '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px"><h2 style="font-size:18px;font-weight:800">ğŸ‘¥ ìœ ì € ê´€ë¦¬</h2>'+UI.badge(S.users.length+'ëª…','pri')+'</div>'+
  '<div style="display:flex;gap:10px;margin-bottom:16px"><div class="search-box" style="flex:1"><input placeholder="ì´ë©”ì¼, íšŒì‚¬ëª… ê²€ìƒ‰..." value="'+S.searchFilter+'" oninput="Adm.setSearch(this.value)"></div></div>'+
  '<div class="tab-bar">'+plans.map(function(p){
    var label=p==='all'?'ì „ì²´':U.pl(p)[0];
    var count=p==='all'?S.users.length:S.users.filter(function(u){return u.plan===p;}).length;
    return '<div class="tab-item '+(S.tab===p?'active':'')+'" onclick="Adm.setTab(\''+p+'\')">'+label+' <span style="font-size:10px;color:var(--w20)">'+count+'</span></div>';
  }).join('')+'</div>'+
  '<div class="card"><div class="card-b" style="padding:0"><table class="tbl"><thead><tr><th>ìœ ì €</th><th>íšŒì‚¬</th><th>í”Œëœ</th><th>ìƒíƒœ</th><th>ë¶„ì„</th><th>ê°€ì…ì¼</th></tr></thead><tbody>'+
  (filtered.length?filtered.map(function(u){
    var ac=S.analyses.filter(function(a){return a.user_id===u.id;}).length;
    return '<tr onclick="Adm.viewUser(\''+u.id+'\')"><td><div style="display:flex;align-items:center;gap:10px"><div style="width:32px;height:32px;border-radius:8px;background:'+(u.role==='admin'?'var(--admin-g)':'var(--pri-g)')+';display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:800;color:'+(u.role==='admin'?'var(--w)':'var(--bg)')+';flex-shrink:0">'+(u.company_name||u.email||'U').charAt(0).toUpperCase()+'</div><div><div style="font-size:13px;font-weight:600">'+(u.display_name||u.email.split('@')[0])+'</div><div style="font-size:11px;color:var(--w40)">'+u.email+'</div></div></div></td><td style="font-size:12px">'+(u.company_name||'\u2014')+'</td><td>'+UI.pb(u.plan||'free')+'</td><td><span class="status-dot '+(u.is_active?'active':'inactive')+'"></span>'+(u.is_active?'í™œì„±':'ë¹„í™œì„±')+'</td><td style="font-family:JetBrains Mono;font-size:12px;text-align:center">'+ac+'</td><td style="font-size:12px;color:var(--w40)">'+U.fd(u.created_at)+'</td></tr>';
  }).join(''):'<tr><td colspan="6">'+UI.empty('ğŸ‘¥','ê²°ê³¼ ì—†ìŒ','')+'</td></tr>')+
  '</tbody></table></div></div>';
}

function pgUserDetail(){
  var u=S.selectedUser;if(!u)return'';
  var co=getCompany(u.id);
  var ua=S.analyses.filter(function(a){return a.user_id===u.id;});
  var up=S.products.filter(function(p){return p.user_id===u.id;});
  var uj=S.projects.filter(function(p){return p.user_id===u.id;});
  var usr=S.serviceRequests.filter(function(s){return s.user_id===u.id;});

  return '<div style="display:flex;align-items:center;gap:12px;margin-bottom:20px"><button class="btn btn-ghost btn-sm" onclick="Adm.set({selectedUser:null})">â† ëª©ë¡</button><h2 style="font-size:18px;font-weight:800;flex:1">'+(u.company_name||u.email)+'</h2>'+UI.pb(u.plan||'free')+UI.badge(u.role,'admin')+'</div>'+

  '<div class="grid-4" style="margin-bottom:16px">'+
    UI.stat('AI ë¶„ì„',ua.length,'','var(--pri)')+
    UI.stat('ë“±ë¡ ì œí’ˆ',up.length,'','var(--acc)')+
    UI.stat('í”„ë¡œì íŠ¸',uj.length,'','var(--ok)')+
    UI.stat('ì„œë¹„ìŠ¤',usr.length,'','var(--purple)')+
  '</div>'+

  '<div class="grid-2" style="margin-bottom:16px">'+
    '<div class="card"><div class="card-h">ğŸ‘¤ ê³„ì • ì •ë³´</div><div class="card-b">'+
      '<div class="detail-row"><div class="detail-label">ì´ë©”ì¼</div><div class="detail-value">'+u.email+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ì´ë¦„</div><div class="detail-value">'+(u.display_name||'\u2014')+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ì „í™”</div><div class="detail-value">'+(u.phone||'\u2014')+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ì—­í• </div><div class="detail-value">'+u.role+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">í”Œëœ</div><div class="detail-value">'+UI.pb(u.plan||'free')+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ê°€ì…ì¼</div><div class="detail-value">'+U.fd(u.created_at)+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ë§ˆì§€ë§‰ í™œë™</div><div class="detail-value">'+U.fd(u.updated_at,'rel')+'</div></div>'+
      '<div style="display:flex;gap:8px;margin-top:14px">'+
        '<button class="btn btn-ghost btn-sm" onclick="Adm.editUserPlan(\''+u.id+'\')">í”Œëœ ë³€ê²½</button>'+
        '<button class="btn btn-ghost btn-sm" onclick="Adm.editUserRole(\''+u.id+'\')">ì—­í•  ë³€ê²½</button>'+
        '<button class="btn btn-'+(u.is_active?'danger':'ok')+' btn-sm" onclick="Adm.toggleUserActive(\''+u.id+'\','+(u.is_active?'false':'true')+')">'+(u.is_active?'ë¹„í™œì„±í™”':'í™œì„±í™”')+'</button>'+
      '</div>'+
    '</div></div>'+

    '<div class="card"><div class="card-h">ğŸ¢ íšŒì‚¬ ì •ë³´</div><div class="card-b">'+(co?
      '<div class="detail-row"><div class="detail-label">í•œê¸€ëª…</div><div class="detail-value">'+(co.name_ko||'\u2014')+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ì˜ë¬¸ëª…</div><div class="detail-value">'+(co.name_en||'\u2014')+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ì£¼ì†Œ</div><div class="detail-value">'+(co.address_ko||'\u2014')+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ëŒ€í‘œ</div><div class="detail-value">'+(co.ceo_name_ko||'\u2014')+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ì „í™”</div><div class="detail-value">'+(co.phone||'\u2014')+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ì‚¬ì—…ìë²ˆí˜¸</div><div class="detail-value">'+(co.biz_number||'\u2014')+'</div></div>'
    :'<div style="text-align:center;padding:20px;color:var(--w40)">íšŒì‚¬ ì •ë³´ ë¯¸ë“±ë¡</div>')+'</div></div>'+
  '</div>'+

  '<div class="card" style="margin-bottom:16px"><div class="card-h"><span>ğŸ”¬ ë¶„ì„ ì´ë ¥</span>'+UI.badge(ua.length+'ê±´','pri')+'</div><div class="card-b" style="padding:0">'+(ua.length?'<table class="tbl"><thead><tr><th>ì œí’ˆ</th><th>ì ìˆ˜</th><th>ìœ í˜•</th><th>ìƒíƒœ</th><th>ë‚ ì§œ</th></tr></thead><tbody>'+ua.map(function(a){
    var r=a.ai_result||{};
    return '<tr onclick="Adm.viewAnalysis(\''+a.id+'\')"><td style="font-weight:600">'+U.tr(a.product_name,30)+'</td><td style="font-family:JetBrains Mono;font-weight:700;color:var(--pri)">'+(r.overall_score||'\u2014')+'</td><td>'+UI.badge(a.analysis_type==='premium'?'í”„ë¦¬ë¯¸ì—„':'ë¬´ë£Œ',a.analysis_type==='premium'?'acc':'ghost')+'</td><td>'+UI.sb(a.status)+'</td><td style="font-size:12px;color:var(--w40)">'+U.fd(a.created_at)+'</td></tr>';
  }).join('')+'</tbody></table>':'<div style="padding:18px">'+UI.empty('ğŸ”¬','ë¶„ì„ ì—†ìŒ','')+'</div>')+'</div></div>'+

  '<div class="card"><div class="card-h"><span>ğŸ’¼ ì„œë¹„ìŠ¤ ìš”ì²­</span>'+UI.badge(usr.length+'ê±´','acc')+'</div><div class="card-b" style="padding:0">'+(usr.length?'<table class="tbl"><thead><tr><th>ì„œë¹„ìŠ¤</th><th>ìƒíƒœ</th><th>ê¸´ê¸‰ë„</th><th>ë‚ ì§œ</th></tr></thead><tbody>'+usr.map(function(sr){
    return '<tr onclick="Adm.viewSR(\''+sr.id+'\')"><td>'+U.si(sr.service_type)+' '+U.sl(sr.service_type)+'</td><td>'+UI.sb(sr.status)+'</td><td>'+UI.badge(sr.priority||'normal',sr.priority==='urgent'?'err':sr.priority==='high'?'acc':'ghost')+'</td><td style="font-size:12px;color:var(--w40)">'+U.fd(sr.created_at)+'</td></tr>';
  }).join('')+'</tbody></table>':'<div style="padding:18px">'+UI.empty('ğŸ’¼','ì„œë¹„ìŠ¤ ì—†ìŒ','')+'</div>')+'</div></div>';
}

/* â”€â”€ Analyses â”€â”€ */
function pgAnalyses(){
  if(S.selectedAnalysis)return pgAnalysisDetail();
  var filtered=filterBySearch(S.analyses,['product_name']);
  if(S.tab!=='all')filtered=filtered.filter(function(a){return a.status===S.tab;});

  var tabs=['all','analyzing','completed','failed'];
  var tabL={all:'ì „ì²´',analyzing:'ë¶„ì„ì¤‘',completed:'ì™„ë£Œ',failed:'ì‹¤íŒ¨'};

  return '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px"><h2 style="font-size:18px;font-weight:800">ğŸ”¬ AI ë¶„ì„ ê´€ë¦¬</h2>'+UI.badge(S.analyses.length+'ê±´','pri')+'</div>'+
  '<div style="display:flex;gap:10px;margin-bottom:16px"><div class="search-box" style="flex:1"><input placeholder="ì œí’ˆëª… ê²€ìƒ‰..." value="'+S.searchFilter+'" oninput="Adm.setSearch(this.value)"></div></div>'+
  '<div class="tab-bar">'+tabs.map(function(t){
    var c=t==='all'?S.analyses.length:S.analyses.filter(function(a){return a.status===t;}).length;
    return '<div class="tab-item '+(S.tab===t?'active':'')+'" onclick="Adm.setTab(\''+t+'\')">'+tabL[t]+' <span style="font-size:10px;color:var(--w20)">'+c+'</span></div>';
  }).join('')+'</div>'+
  '<div class="card"><div class="card-b" style="padding:0"><table class="tbl"><thead><tr><th>ì œí’ˆëª…</th><th>ìœ ì €</th><th>ì ìˆ˜</th><th>ìœ í˜•</th><th>ìƒíƒœ</th><th>ë‚ ì§œ</th></tr></thead><tbody>'+
  (filtered.length?filtered.map(function(a){
    var r=a.ai_result||{};var sc=r.overall_score;var col=sc>=80?'var(--ok)':sc>=60?'var(--acc)':'var(--err)';
    return '<tr onclick="Adm.viewAnalysis(\''+a.id+'\')"><td style="font-weight:600">'+U.tr(a.product_name,35)+'</td><td style="font-size:12px;color:var(--w60)">'+getUserName(a.user_id)+'</td><td style="font-family:JetBrains Mono;font-weight:800;color:'+(sc?col:'var(--w20)')+'">'+( sc||'\u2014')+'</td><td>'+UI.badge(a.analysis_type==='premium'?'í”„ë¦¬ë¯¸ì—„':'ë¬´ë£Œ',a.analysis_type==='premium'?'acc':'ghost')+'</td><td>'+UI.sb(a.status)+'</td><td style="font-size:12px;color:var(--w40)">'+U.fd(a.created_at,'rel')+'</td></tr>';
  }).join(''):'<tr><td colspan="6">'+UI.empty('ğŸ”¬','ê²°ê³¼ ì—†ìŒ','')+'</td></tr>')+
  '</tbody></table></div></div>';
}

function pgAnalysisDetail(){
  var a=S.selectedAnalysis;if(!a)return'';
  var r=a.ai_result||{};var sc=r.overall_score;
  var col=sc>=80?'var(--ok)':sc>=60?'var(--acc)':'var(--err)';
  var bar=function(label,val){var pct=Math.min((val||0),100);var c=val>=80?'var(--ok)':val>=60?'var(--acc)':'var(--err)';return '<div style="margin-bottom:8px"><div style="display:flex;justify-content:space-between;margin-bottom:3px"><span style="font-size:12px;color:var(--w60)">'+label+'</span><span style="font-size:12px;font-weight:700;color:'+c+'">'+( val||0)+'</span></div><div class="chart-bar" style="height:6px"><div class="chart-bar-fill" style="width:'+pct+'%;background:'+c+'"></div></div></div>';};

  return '<div style="display:flex;align-items:center;gap:12px;margin-bottom:20px"><button class="btn btn-ghost btn-sm" onclick="Adm.set({selectedAnalysis:null})">â† ëª©ë¡</button><h2 style="font-size:18px;font-weight:800;flex:1">'+a.product_name+'</h2>'+UI.sb(a.status)+UI.badge(a.analysis_type==='premium'?'í”„ë¦¬ë¯¸ì—„':'ë¬´ë£Œ',a.analysis_type==='premium'?'acc':'ghost')+'</div>'+

  '<div class="grid-2" style="margin-bottom:16px">'+
    '<div class="card"><div class="card-h">ğŸ“Š ì ìˆ˜</div><div class="card-b">'+
      '<div style="display:flex;gap:16px;margin-bottom:16px"><div style="width:100px;height:100px;border-radius:50%;border:5px solid '+(sc?col:'var(--w08)')+';display:flex;align-items:center;justify-content:center;flex-shrink:0"><div style="font-size:30px;font-weight:900;color:'+(sc?col:'var(--w20)')+'">'+( sc||'?')+'</div></div><div style="flex:1">'+
        bar('ì‹œì¥ ì í•©ë„',r.market_fit)+bar('ê°€ê²© ê²½ìŸë ¥',r.price_competitiveness)+bar('ë¸Œëœë“œ íŒŒì›Œ',r.brand_power)+bar('ê²½ìŸ í™˜ê²½',r.competition)+bar('ê·œì œ',r.regulatory)+bar('ë¬¼ë¥˜',r.logistics_score)+
      '</div></div>'+
    '</div></div>'+

    '<div class="card"><div class="card-h">ğŸ“‹ ì •ë³´</div><div class="card-b">'+
      '<div class="detail-row"><div class="detail-label">ìœ ì €</div><div class="detail-value" style="cursor:pointer;color:var(--pri)" onclick="Adm.viewUser(\''+a.user_id+'\')">'+getUserName(a.user_id)+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">HS Code</div><div class="detail-value" style="font-family:JetBrains Mono">'+(r.hs_code||'\u2014')+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ì˜ˆìƒ FOB</div><div class="detail-value">'+(r.estimated_fob||'\u2014')+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ì¶”ì²œ ì‹œì¥</div><div class="detail-value">'+((r.recommended_markets||[]).map(function(m){return U.cl(m);}).join(' ')||'\u2014')+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">í•„ìš” ì¸ì¦</div><div class="detail-value">'+((r.required_certs||[]).map(function(c){return '<span class="badge badge-err" style="margin:1px">'+c+'</span>';}).join(' ')||'\u2014')+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ìƒì„±ì¼</div><div class="detail-value">'+U.fd(a.created_at)+'</div></div>'+
      '<div style="display:flex;gap:8px;margin-top:14px">'+
        '<button class="btn btn-ok btn-sm" onclick="Adm.updateAStatus(\''+a.id+'\',\'completed\')">ì™„ë£Œ ì²˜ë¦¬</button>'+
        '<button class="btn btn-danger btn-sm" onclick="Adm.updateAStatus(\''+a.id+'\',\'failed\')">ì‹¤íŒ¨ ì²˜ë¦¬</button>'+
        '<button class="btn btn-ghost btn-sm" onclick="Adm.deleteAnalysis(\''+a.id+'\')">ì‚­ì œ</button>'+
      '</div>'+
    '</div></div>'+
  '</div>'+

  (r.summary?'<div class="card" style="margin-bottom:16px"><div class="card-h">ğŸ“ ìš”ì•½</div><div class="card-b"><p style="font-size:13px;color:var(--w70);line-height:1.8">'+r.summary+'</p>'+(r.executive_summary?'<p style="font-size:13px;color:var(--w70);line-height:1.8;margin-top:10px;padding-top:10px;border-top:1px solid var(--w08)">'+r.executive_summary+'</p>':'')+'</div></div>':'')+

  (r.market_analysis&&r.market_analysis.length?'<div class="card" style="margin-bottom:16px"><div class="card-h">ğŸŒ ì‹œì¥ ë¶„ì„</div><div class="card-b" style="padding:0"><table class="tbl"><thead><tr><th>ì‹œì¥</th><th>ê·œëª¨</th><th>ì„±ì¥ë¥ </th><th>ì§„ì…ì¥ë²½</th></tr></thead><tbody>'+r.market_analysis.map(function(m){return '<tr><td style="font-weight:700">'+m.name+'</td><td style="font-family:JetBrains Mono">'+m.size+'</td><td style="color:var(--ok)">'+m.grow+'</td><td>'+m.entry+'</td></tr>';}).join('')+'</tbody></table></div></div>':'');
}

/* â”€â”€ Service Requests â”€â”€ */
function pgServiceReq(){
  if(S.selectedSR)return pgSRDetail();
  var filtered=filterBySearch(S.serviceRequests,['title','service_type']);
  if(S.tab!=='all')filtered=filtered.filter(function(s){return s.status===S.tab;});

  var tabs=['all','pending','processing','completed'];
  var tabL={all:'ì „ì²´',pending:'ëŒ€ê¸°',processing:'ì²˜ë¦¬ì¤‘',completed:'ì™„ë£Œ'};

  return '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px"><h2 style="font-size:18px;font-weight:800">ğŸ’¼ ì„œë¹„ìŠ¤ ìš”ì²­</h2>'+UI.badge(S.serviceRequests.length+'ê±´','acc')+'</div>'+
  '<div style="display:flex;gap:10px;margin-bottom:16px"><div class="search-box" style="flex:1"><input placeholder="ì„œë¹„ìŠ¤ ê²€ìƒ‰..." value="'+S.searchFilter+'" oninput="Adm.setSearch(this.value)"></div></div>'+
  '<div class="tab-bar">'+tabs.map(function(t){
    var c=t==='all'?S.serviceRequests.length:S.serviceRequests.filter(function(s){return s.status===t;}).length;
    return '<div class="tab-item '+(S.tab===t?'active':'')+'" onclick="Adm.setTab(\''+t+'\')">'+tabL[t]+' <span style="font-size:10px;color:var(--w20)">'+c+'</span></div>';
  }).join('')+'</div>'+
  '<div class="card"><div class="card-b" style="padding:0"><table class="tbl"><thead><tr><th>ì„œë¹„ìŠ¤</th><th>ìœ ì €</th><th>ìƒíƒœ</th><th>ê¸´ê¸‰ë„</th><th>ê¸ˆì•¡</th><th>ë‚ ì§œ</th></tr></thead><tbody>'+
  (filtered.length?filtered.map(function(sr){
    return '<tr onclick="Adm.viewSR(\''+sr.id+'\')"><td>'+U.si(sr.service_type)+' '+U.sl(sr.service_type)+'</td><td style="font-size:12px">'+getUserName(sr.user_id)+'</td><td>'+UI.sb(sr.status)+'</td><td>'+UI.badge(sr.priority||'normal',sr.priority==='urgent'?'err':sr.priority==='high'?'acc':'ghost')+'</td><td style="font-family:JetBrains Mono;font-size:12px">'+(sr.price?U.krw(sr.price):'\u2014')+'</td><td style="font-size:12px;color:var(--w40)">'+U.fd(sr.created_at,'rel')+'</td></tr>';
  }).join(''):'<tr><td colspan="6">'+UI.empty('ğŸ’¼','ê²°ê³¼ ì—†ìŒ','')+'</td></tr>')+
  '</tbody></table></div></div>';
}

function pgSRDetail(){
  var sr=S.selectedSR;if(!sr)return'';
  var details=sr.details||{};

  return '<div style="display:flex;align-items:center;gap:12px;margin-bottom:20px"><button class="btn btn-ghost btn-sm" onclick="Adm.set({selectedSR:null})">â† ëª©ë¡</button><h2 style="font-size:18px;font-weight:800;flex:1">'+U.si(sr.service_type)+' '+U.sl(sr.service_type)+'</h2>'+UI.sb(sr.status)+'</div>'+

  '<div class="grid-2" style="margin-bottom:16px">'+
    '<div class="card"><div class="card-h">ğŸ“‹ ìš”ì²­ ì •ë³´</div><div class="card-b">'+
      '<div class="detail-row"><div class="detail-label">ì„œë¹„ìŠ¤</div><div class="detail-value">'+U.sl(sr.service_type)+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ìœ ì €</div><div class="detail-value" style="cursor:pointer;color:var(--pri)" onclick="Adm.viewUser(\''+sr.user_id+'\')">'+getUserName(sr.user_id)+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ê¸´ê¸‰ë„</div><div class="detail-value">'+UI.badge(sr.priority||'normal',sr.priority==='urgent'?'err':sr.priority==='high'?'acc':'ghost')+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ê¸ˆì•¡</div><div class="detail-value">'+(sr.price?U.krw(sr.price):'ë¯¸ì •')+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ìƒì„±ì¼</div><div class="detail-value">'+U.fd(sr.created_at)+'</div></div>'+
      (details.text?'<div style="margin-top:12px;padding:12px;border-radius:8px;background:var(--w08)"><div style="font-size:11px;color:var(--w40);margin-bottom:6px">ìš”ì²­ ë‚´ìš©</div><div style="font-size:13px;color:var(--w70);white-space:pre-wrap">'+details.text+'</div></div>':'')+
    '</div></div>'+

    '<div class="card"><div class="card-h">âš¡ ì²˜ë¦¬</div><div class="card-b">'+
      '<div style="margin-bottom:16px">'+
        UI.sel('sr_status','ìƒíƒœ ë³€ê²½',[{value:'pending',label:'ëŒ€ê¸°'},{value:'processing',label:'ì²˜ë¦¬ì¤‘'},{value:'completed',label:'ì™„ë£Œ'},{value:'cancelled',label:'ì·¨ì†Œ'}],sr.status)+
      '</div>'+
      '<div style="margin-bottom:16px">'+UI.inp('sr_price','ê¸ˆì•¡ (ì›)',{type:'number',value:sr.price||'',placeholder:'300000'})+'</div>'+
      UI.ta('sr_note','ê´€ë¦¬ì ë©”ëª¨',{placeholder:'ë‚´ë¶€ ë©”ëª¨...',value:(sr.admin_note||''),rows:4})+
      '<div style="display:flex;gap:8px;margin-top:14px">'+
        '<button class="btn btn-admin" onclick="Adm.updateSR(\''+sr.id+'\')">ì €ì¥</button>'+
        '<button class="btn btn-ok btn-sm" onclick="Adm.quickSR(\''+sr.id+'\',\'completed\')">ì™„ë£Œ ì²˜ë¦¬</button>'+
        '<button class="btn btn-danger btn-sm" onclick="Adm.deleteSR(\''+sr.id+'\')">ì‚­ì œ</button>'+
      '</div>'+
    '</div></div>'+
  '</div>';
}

/* â”€â”€ Products â”€â”€ */
function pgProducts(){
  var filtered=filterBySearch(S.products,['name_ko','name_en','category']);

  return '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px"><h2 style="font-size:18px;font-weight:800">ğŸ“¦ ì œí’ˆ ê´€ë¦¬</h2>'+UI.badge(S.products.length+'ê±´','acc')+'</div>'+
  '<div style="display:flex;gap:10px;margin-bottom:16px"><div class="search-box" style="flex:1"><input placeholder="ì œí’ˆëª…, ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰..." value="'+S.searchFilter+'" oninput="Adm.setSearch(this.value)"></div></div>'+
  '<div class="card"><div class="card-b" style="padding:0"><table class="tbl"><thead><tr><th>ì œí’ˆ</th><th>ìœ ì €</th><th>ì¹´í…Œê³ ë¦¬</th><th>FOB</th><th>MOQ</th><th>ìƒíƒœ</th><th>ë‚ ì§œ</th></tr></thead><tbody>'+
  (filtered.length?filtered.map(function(p){
    return '<tr><td><div style="display:flex;align-items:center;gap:10px">'+(p.images&&p.images[0]?'<img src="'+p.images[0]+'" style="width:36px;height:36px;border-radius:6px;object-fit:cover">':'<div style="width:36px;height:36px;border-radius:6px;background:var(--w08);display:flex;align-items:center;justify-content:center;font-size:16px">ğŸ“¦</div>')+'<div><div style="font-weight:600">'+U.tr(p.name_ko,25)+'</div>'+(p.name_en?'<div style="font-size:11px;color:var(--w40)">'+U.tr(p.name_en,30)+'</div>':'')+'</div></div></td><td style="font-size:12px">'+getUserName(p.user_id)+'</td><td style="font-size:12px">'+(p.category||'\u2014')+'</td><td style="font-family:JetBrains Mono;font-size:12px">'+(p.fob_price?U.usd(p.fob_price):'\u2014')+'</td><td style="font-size:12px">'+(p.moq||'\u2014')+'</td><td>'+UI.sb(p.status||'draft')+'</td><td style="font-size:12px;color:var(--w40)">'+U.fd(p.created_at,'rel')+'</td></tr>';
  }).join(''):'<tr><td colspan="7">'+UI.empty('ğŸ“¦','ì œí’ˆ ì—†ìŒ','')+'</td></tr>')+
  '</tbody></table></div></div>';
}

/* â”€â”€ Projects â”€â”€ */
function pgProjects(){
  var filtered=filterBySearch(S.projects,['name']);
  var stages=['planning','certification','buyer_search','negotiation','shipping','completed'];
  var stL={planning:'ê¸°íš',certification:'ì¸ì¦',buyer_search:'ë§¤ì¹­',negotiation:'í˜‘ìƒ',shipping:'ì„ ì ',completed:'ì™„ë£Œ'};

  return '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px"><h2 style="font-size:18px;font-weight:800">ğŸš€ í”„ë¡œì íŠ¸ ê´€ë¦¬</h2>'+UI.badge(S.projects.length+'ê±´','ok')+'</div>'+
  '<div style="display:flex;gap:10px;margin-bottom:16px"><div class="search-box" style="flex:1"><input placeholder="í”„ë¡œì íŠ¸ëª… ê²€ìƒ‰..." value="'+S.searchFilter+'" oninput="Adm.setSearch(this.value)"></div></div>'+

  '<div class="grid-3" style="margin-bottom:16px">'+
    stages.slice(0,3).map(function(s){
      var c=S.projects.filter(function(p){return p.status===s;}).length;
      return UI.stat(stL[s],c,'','var(--pri)');
    }).join('')+
  '</div>'+
  '<div class="grid-3" style="margin-bottom:16px">'+
    stages.slice(3).map(function(s){
      var c=S.projects.filter(function(p){return p.status===s;}).length;
      return UI.stat(stL[s],c,'',s==='completed'?'var(--ok)':'var(--acc)');
    }).join('')+
  '</div>'+

  '<div class="card"><div class="card-b" style="padding:0"><table class="tbl"><thead><tr><th>í”„ë¡œì íŠ¸</th><th>ìœ ì €</th><th>ë‹¨ê³„</th><th>íƒ€ê²Ÿ</th><th>ë‚ ì§œ</th></tr></thead><tbody>'+
  (filtered.length?filtered.map(function(p){
    var ci=stages.indexOf(p.status);
    return '<tr><td style="font-weight:600">'+U.tr(p.name,35)+'</td><td style="font-size:12px">'+getUserName(p.user_id)+'</td><td><div style="display:flex;gap:2px;align-items:center">'+stages.map(function(s,i){return '<div style="width:12px;height:4px;border-radius:2px;background:'+(i<=ci?'var(--ok)':'var(--w08)')+'"></div>';}).join('')+'<span style="margin-left:6px;font-size:11px;color:var(--w60)">'+stL[p.status]+'</span></div></td><td style="font-size:12px">'+((p.target_countries||[]).map(function(c){return U.cl(c);}).join(' ')||'\u2014')+'</td><td style="font-size:12px;color:var(--w40)">'+U.fd(p.created_at,'rel')+'</td></tr>';
  }).join(''):'<tr><td colspan="5">'+UI.empty('ğŸš€','í”„ë¡œì íŠ¸ ì—†ìŒ','')+'</td></tr>')+
  '</tbody></table></div></div>';
}

/* â”€â”€ Documents â”€â”€ */
function pgDocuments(){
  var filtered=filterBySearch(S.documents,['doc_type','doc_number','buyer_name']);
  var docN={pi:'PI',ci:'CI',pl:'PL',co:'CO',catalog:'Catalog'};

  return '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px"><h2 style="font-size:18px;font-weight:800">ğŸ“„ ì„œë¥˜ ê´€ë¦¬</h2>'+UI.badge(S.documents.length+'ê±´','purple')+'</div>'+
  '<div style="display:flex;gap:10px;margin-bottom:16px"><div class="search-box" style="flex:1"><input placeholder="ì„œë¥˜ë²ˆí˜¸, ë°”ì´ì–´ ê²€ìƒ‰..." value="'+S.searchFilter+'" oninput="Adm.setSearch(this.value)"></div></div>'+
  '<div class="card"><div class="card-b" style="padding:0"><table class="tbl"><thead><tr><th>ìœ í˜•</th><th>ë²ˆí˜¸</th><th>ë°”ì´ì–´</th><th>ìœ ì €</th><th>ìƒíƒœ</th><th>ë‚ ì§œ</th></tr></thead><tbody>'+
  (filtered.length?filtered.map(function(d){
    return '<tr><td>'+UI.badge(docN[d.doc_type]||d.doc_type,'pri')+'</td><td style="font-family:JetBrains Mono;font-size:12px">'+(d.doc_number||'\u2014')+'</td><td style="font-weight:600">'+(d.buyer_name||'\u2014')+'</td><td style="font-size:12px">'+getUserName(d.user_id)+'</td><td>'+UI.sb(d.status||'draft')+'</td><td style="font-size:12px;color:var(--w40)">'+U.fd(d.created_at)+'</td></tr>';
  }).join(''):'<tr><td colspan="6">'+UI.empty('ğŸ“„','ì„œë¥˜ ì—†ìŒ','')+'</td></tr>')+
  '</tbody></table></div></div>';
}

/* â”€â”€ Settings â”€â”€ */
function pgSettings(){
  return '<div style="margin-bottom:20px"><h2 style="font-size:18px;font-weight:800">âš™ï¸ ì‹œìŠ¤í…œ ì„¤ì •</h2></div>'+
  '<div class="grid-2">'+
    '<div class="card"><div class="card-h">ğŸ”‘ API ì„¤ì •</div><div class="card-b">'+
      '<div class="detail-row"><div class="detail-label">Supabase</div><div class="detail-value" style="font-family:JetBrains Mono;font-size:11px;color:var(--ok)">ì—°ê²°ë¨</div></div>'+
      '<div class="detail-row"><div class="detail-label">AI Engine</div><div class="detail-value" style="font-family:JetBrains Mono;font-size:11px">Claude Sonnet (relay)</div></div>'+
      '<div class="detail-row"><div class="detail-label">Relay URL</div><div class="detail-value" style="font-family:JetBrains Mono;font-size:11px;word-break:break-all">localhost:3456</div></div>'+
    '</div></div>'+

    '<div class="card"><div class="card-h">ğŸ“Š DB í˜„í™©</div><div class="card-b">'+
      '<div class="detail-row"><div class="detail-label">users</div><div class="detail-value">'+S.users.length+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">analyses</div><div class="detail-value">'+S.analyses.length+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">products</div><div class="detail-value">'+S.products.length+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">projects</div><div class="detail-value">'+S.projects.length+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">service_requests</div><div class="detail-value">'+S.serviceRequests.length+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">companies</div><div class="detail-value">'+S.companies.length+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">documents</div><div class="detail-value">'+S.documents.length+'</div></div>'+
      '<div style="margin-top:14px"><button class="btn btn-admin btn-sm" onclick="Adm.refreshAll()">ğŸ”„ ì „ì²´ ìƒˆë¡œê³ ì¹¨</button></div>'+
    '</div></div>'+
  '</div>'+

  '<div class="card" style="margin-top:16px"><div class="card-h">ğŸ› ï¸ ê´€ë¦¬ ë„êµ¬</div><div class="card-b"><div style="display:flex;flex-wrap:wrap;gap:8px">'+
    '<button class="btn btn-ghost" onclick="Adm.exportCSV(\'users\')">ğŸ“¥ ìœ ì € CSV</button>'+
    '<button class="btn btn-ghost" onclick="Adm.exportCSV(\'analyses\')">ğŸ“¥ ë¶„ì„ CSV</button>'+
    '<button class="btn btn-ghost" onclick="Adm.exportCSV(\'service_requests\')">ğŸ“¥ ì„œë¹„ìŠ¤ CSV</button>'+
    '<button class="btn btn-ghost" onclick="window.open(\'whistle.html\',\'_blank\')">ğŸ”— í´ë¼ì´ì–¸íŠ¸ í¬í„¸</button>'+
  '</div></div></div>';
}

/* ============ ACTIONS ============ */
function editUserPlan(uid){
  var u=S.users.find(function(x){return x.id===uid;});if(!u)return;
  var plan=prompt('í”Œëœ ë³€ê²½ (free/basic/pro/alibaba):',u.plan||'free');
  if(!plan||!['free','basic','pro','alibaba'].includes(plan))return;
  sb.from('users').update({plan:plan,plan_started_at:new Date().toISOString()}).eq('id',uid).then(function(r){
    if(r.error){UI.toast('ì‹¤íŒ¨','err');return;}
    u.plan=plan;S.selectedUser=u;render();UI.toast('í”Œëœ ë³€ê²½: '+plan.toUpperCase(),'ok');
  });
}

function editUserRole(uid){
  var u=S.users.find(function(x){return x.id===uid;});if(!u)return;
  var role=prompt('ì—­í•  ë³€ê²½ (client/admin/buyer):',u.role||'client');
  if(!role||!['client','admin','buyer'].includes(role))return;
  sb.from('users').update({role:role}).eq('id',uid).then(function(r){
    if(r.error){UI.toast('ì‹¤íŒ¨','err');return;}
    u.role=role;S.selectedUser=u;render();UI.toast('ì—­í•  ë³€ê²½: '+role,'ok');
  });
}

function toggleUserActive(uid,active){
  var val=active==='true';
  sb.from('users').update({is_active:val}).eq('id',uid).then(function(r){
    if(r.error){UI.toast('ì‹¤íŒ¨','err');return;}
    var u=S.users.find(function(x){return x.id===uid;});
    if(u){u.is_active=val;S.selectedUser=u;}
    render();UI.toast(val?'í™œì„±í™”':'ë¹„í™œì„±í™”','ok');
  });
}

function updateAStatus(aid,status){
  sb.from('analyses').update({status:status}).eq('id',aid).then(function(r){
    if(r.error){UI.toast('ì‹¤íŒ¨','err');return;}
    var a=S.analyses.find(function(x){return x.id===aid;});
    if(a){a.status=status;S.selectedAnalysis=a;}
    render();UI.toast('ìƒíƒœ ë³€ê²½','ok');
  });
}

function deleteAnalysis(aid){
  if(!confirm('ì´ ë¶„ì„ì„ ì‚­ì œí• ê¹Œìš”?'))return;
  sb.from('analyses').delete().eq('id',aid).then(function(r){
    if(r.error){UI.toast('ì‚­ì œ ì‹¤íŒ¨','err');return;}
    S.analyses=S.analyses.filter(function(a){return a.id!==aid;});
    S.selectedAnalysis=null;render();UI.toast('ì‚­ì œ ì™„ë£Œ','ok');
  });
}

function updateSR(id){
  var status=document.querySelector('[name=sr_status]');
  var price=document.querySelector('[name=sr_price]');
  var note=document.querySelector('[name=sr_note]');
  var data={};
  if(status)data.status=status.value;
  if(price&&price.value)data.price=Number(price.value);
  if(note)data.admin_note=note.value;
  sb.from('service_requests').update(data).eq('id',id).then(function(r){
    if(r.error){UI.toast('ì‹¤íŒ¨','err');return;}
    var sr=S.serviceRequests.find(function(x){return x.id===id;});
    if(sr){Object.assign(sr,data);S.selectedSR=sr;}
    render();UI.toast('ì—…ë°ì´íŠ¸ ì™„ë£Œ','ok');
  });
}

function quickSR(id,status){
  sb.from('service_requests').update({status:status}).eq('id',id).then(function(r){
    if(r.error){UI.toast('ì‹¤íŒ¨','err');return;}
    var sr=S.serviceRequests.find(function(x){return x.id===id;});
    if(sr){sr.status=status;S.selectedSR=sr;}
    render();UI.toast('ìƒíƒœ ë³€ê²½','ok');
  });
}

function deleteSR(id){
  if(!confirm('ì´ ìš”ì²­ì„ ì‚­ì œí• ê¹Œìš”?'))return;
  sb.from('service_requests').delete().eq('id',id).then(function(r){
    if(r.error){UI.toast('ì‹¤íŒ¨','err');return;}
    S.serviceRequests=S.serviceRequests.filter(function(x){return x.id!==id;});
    S.selectedSR=null;render();UI.toast('ì‚­ì œ ì™„ë£Œ','ok');
  });
}

function exportCSV(table){
  var data=S[table==='service_requests'?'serviceRequests':table]||[];
  if(!data.length){UI.toast('ë°ì´í„° ì—†ìŒ','warn');return;}
  var keys=Object.keys(data[0]);
  var csv=keys.join(',')+'\n';
  data.forEach(function(row){
    csv+=keys.map(function(k){var v=row[k];if(v==null)return'';v=String(v).replace(/"/g,'""');return v.indexOf(',')>=0||v.indexOf('\n')>=0?'"'+v+'"':v;}).join(',')+'\n';
  });
  var blob=new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'});
  var url=URL.createObjectURL(blob);
  var a=document.createElement('a');a.href=url;a.download=table+'_'+new Date().toISOString().split('T')[0]+'.csv';a.click();
  URL.revokeObjectURL(url);UI.toast('CSV ë‹¤ìš´ë¡œë“œ','ok');
}

function refreshAll(){loadAll();UI.toast('ìƒˆë¡œê³ ì¹¨ ì¤‘...','info');}

/* ============ NAV & RENDER ============ */
function nav(p){S.page=p;S.searchFilter='';S.tab='all';S.selectedUser=null;S.selectedAnalysis=null;S.selectedSR=null;render();var pc=document.querySelector('.page-content');if(pc)pc.scrollTop=0;}
function closeModal(id){UI.hideModal(id);setTimeout(function(){var e=document.getElementById(id);if(e)e.remove();},300);}
function setSearch(v){S.searchFilter=v;render();}
function setTab(t){S.tab=t;render();}

function viewUser(uid){var u=S.users.find(function(x){return x.id===uid;});if(u){S.selectedUser=u;S.page='users';render();}}
function viewAnalysis(aid){var a=S.analyses.find(function(x){return x.id===aid;});if(a){S.selectedAnalysis=a;S.page='analyses';render();}}
function viewSR(id){var sr=S.serviceRequests.find(function(x){return x.id===id;});if(sr){S.selectedSR=sr;S.page='services';render();}}

var PL={dashboard:'ğŸ“Š ëŒ€ì‹œë³´ë“œ',users:'ğŸ‘¥ ìœ ì € ê´€ë¦¬',analyses:'ğŸ”¬ AI ë¶„ì„',services:'ğŸ’¼ ì„œë¹„ìŠ¤ ìš”ì²­',products:'ğŸ“¦ ì œí’ˆ ê´€ë¦¬',projects:'ğŸš€ í”„ë¡œì íŠ¸',documents:'ğŸ“„ ì„œë¥˜',settings:'âš™ï¸ ì„¤ì •'};

function renderPage(){
  switch(S.page){
    case'dashboard':return pgDash();
    case'users':return pgUsers();
    case'analyses':return pgAnalyses();
    case'services':return pgServiceReq();
    case'products':return pgProducts();
    case'projects':return pgProjects();
    case'documents':return pgDocuments();
    case'settings':return pgSettings();
    default:return pgDash();
  }
}

function renderSidebar(){
  var pendSR=S.serviceRequests.filter(function(s){return s.status==='pending';}).length;
  var analyzingA=S.analyses.filter(function(a){return a.status==='analyzing';}).length;

  var menu=[
    {id:'dashboard',icon:'ğŸ“Š',label:'ëŒ€ì‹œë³´ë“œ'},
    {id:'div'},
    {id:'users',icon:'ğŸ‘¥',label:'ìœ ì € ê´€ë¦¬',count:S.users.length},
    {id:'analyses',icon:'ğŸ”¬',label:'AI ë¶„ì„',count:analyzingA||null},
    {id:'services',icon:'ğŸ’¼',label:'ì„œë¹„ìŠ¤ ìš”ì²­',count:pendSR||null},
    {id:'div'},
    {id:'products',icon:'ğŸ“¦',label:'ì œí’ˆ ê´€ë¦¬'},
    {id:'projects',icon:'ğŸš€',label:'í”„ë¡œì íŠ¸'},
    {id:'documents',icon:'ğŸ“„',label:'ì„œë¥˜'},
    {id:'div'},
    {id:'settings',icon:'âš™ï¸',label:'ì„¤ì •'}
  ];
  return '<div class="sidebar"><div class="sidebar-header"><div class="sidebar-logo">W</div><div><div class="sidebar-title">Whistle AI</div><div class="sidebar-sub">ADMIN</div></div></div><div class="sidebar-nav">'+menu.map(function(m){
    if(m.id==='div')return '<div class="nav-section"></div>';
    return '<div class="nav-item '+(S.page===m.id?'active':'')+'" onclick="Adm.nav(\''+m.id+'\')"><span class="icon">'+m.icon+'</span><span>'+m.label+'</span>'+(m.count?'<span class="badge-count">'+m.count+'</span>':'')+'</div>';
  }).join('')+'</div><div class="sidebar-footer"><div style="padding:8px 12px;font-size:11px;color:var(--w40)"><div style="font-weight:600">'+(S.user?S.user.email:'')+'</div><div style="font-size:10px;margin-top:2px">Admin</div></div><div class="nav-item" onclick="Adm.doLogout()" style="color:var(--w40);margin-top:4px"><span class="icon">ğŸšª</span><span>ë¡œê·¸ì•„ì›ƒ</span></div></div></div>';
}

function render(){
  var app=document.getElementById('app');
  if(S.loading){app.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100vh"><div style="text-align:center"><div class="spinner" style="width:40px;height:40px;border-width:4px;margin:0 auto 16px"></div><div style="font-size:14px;color:var(--w40)">Admin ë¡œë”© ì¤‘...</div></div></div>';return;}
  if(!S.user){app.innerHTML=pgAuth();return;}
  app.innerHTML='<div class="app-layout">'+renderSidebar()+'<div class="main-area"><div class="topbar"><div class="topbar-title">'+(PL[S.page]||'')+'<span class="admin-tag">ADMIN</span></div><div style="display:flex;align-items:center;gap:12px"><button class="btn btn-ghost btn-sm" onclick="Adm.refreshAll()" style="font-size:11px">ğŸ”„</button><span style="font-size:13px;color:var(--w40)">'+S.user.email+'</span><div style="width:30px;height:30px;border-radius:8px;background:var(--admin-g);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:800;color:var(--w)">A</div></div></div><div class="page-content">'+renderPage()+'</div></div></div>';
}

/* === PUBLIC API === */
window.Adm={set:set,nav:nav,render:render,doLogin:doLogin,doLogout:doLogout,setSearch:setSearch,setTab:setTab,closeModal:closeModal,
  viewUser:viewUser,viewAnalysis:viewAnalysis,viewSR:viewSR,
  editUserPlan:editUserPlan,editUserRole:editUserRole,toggleUserActive:toggleUserActive,
  updateAStatus:updateAStatus,deleteAnalysis:deleteAnalysis,
  updateSR:updateSR,quickSR:quickSR,deleteSR:deleteSR,
  exportCSV:exportCSV,refreshAll:refreshAll};
loadUser();
})();
</script>
<!-- ì‹¤ì‹œê°„ ë¬¸ì˜ ì±„íŒ… ìœ„ì ¯ -->
<script>
(function(){
  var RELAY='https://uncommanded-brooke-truculent.ngrok-free.dev';
  var PAGE='admin';
  var open=false,step=0,msgs=[],info={name:'',email:'',phone:''};
  var el=document.createElement('div');el.id='wc-root';document.body.appendChild(el);
  function r(){
    var html='';
    html+='<div onclick="WC.toggle()" style="position:fixed;bottom:24px;right:24px;z-index:9999;width:56px;height:56px;border-radius:28px;background:linear-gradient(135deg,#00D4FF,#0088FF);display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 20px rgba(0,212,255,.4)">';
    html+=open?'<svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M18 6L6 18M6 6l12 12" stroke="#060B18" stroke-width="2.5" stroke-linecap="round"/></svg>':'<svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z" fill="#060B18"/></svg>';
    html+='</div>';
    if(!open){el.innerHTML=html;return;}
    html+='<div style="position:fixed;bottom:90px;right:24px;z-index:9998;width:360px;max-height:520px;background:#0D1424;border-radius:16px;border:1px solid rgba(255,255,255,.1);box-shadow:0 16px 60px rgba(0,0,0,.6);display:flex;flex-direction:column;overflow:hidden;font-family:Sora,Noto Sans KR,sans-serif">';
    html+='<div style="padding:14px 18px;background:linear-gradient(135deg,#00D4FF20,#0088FF10);border-bottom:1px solid rgba(255,255,255,.08);display:flex;align-items:center;gap:10px"><div style="width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#00D4FF,#0088FF);display:flex;align-items:center;justify-content:center"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" fill="#060B18"/></svg></div><div><div style="font-size:14px;font-weight:700;color:#fff">Whistle AI</div><div style="font-size:11px;color:rgba(255,255,255,.4)">ìˆ˜ì¶œ ì „ë¬¸ ìƒë‹´</div></div><div style="margin-left:auto;display:flex;align-items:center;gap:4px"><div style="width:6px;height:6px;border-radius:3px;background:#00E676"></div><span style="font-size:10px;color:#00E676">ì˜¨ë¼ì¸</span></div></div>';
    html+='<div id="wc-msgs" style="flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:8px;min-height:200px;max-height:320px">';
    if(msgs.length===0&&step===0){html+=bbl('bot','ì•ˆë…•í•˜ì„¸ìš”! Whistle AI ìˆ˜ì¶œ ìƒë‹´ì…ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?');html+=qb(['ë¬´ë£Œ ë¶„ì„ì´ ê¶ê¸ˆí•´ìš”','ë°”ìš°ì²˜ ë¬¸ì˜','ì•Œë¦¬ë°”ë°” ì…ì ','ê¸°íƒ€ ë¬¸ì˜']);}
    for(var i=0;i<msgs.length;i++)html+=bbl(msgs[i].from,msgs[i].text);
    if(step===1){html+=bbl('bot','ìƒë‹´ì„ ìœ„í•´ ê°„ë‹¨í•œ ì •ë³´ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.');html+='<div style="display:flex;flex-direction:column;gap:6px;width:100%"><input id="wc-name" placeholder="ì´ë¦„/íšŒì‚¬ëª…" value="'+esc(info.name)+'" style="padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,.1);background:#111B2E;color:rgba(255,255,255,.9);font-size:13px;outline:none"><input id="wc-email" placeholder="ì´ë©”ì¼ (ì„ íƒ)" value="'+esc(info.email)+'" style="padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,.1);background:#111B2E;color:rgba(255,255,255,.9);font-size:13px;outline:none"><input id="wc-phone" placeholder="ì—°ë½ì²˜ (ì„ íƒ)" value="'+esc(info.phone)+'" style="padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,.1);background:#111B2E;color:rgba(255,255,255,.9);font-size:13px;outline:none"><button onclick="WC.submitInfo()" style="padding:10px;border-radius:8px;border:none;background:linear-gradient(135deg,#00D4FF,#0088FF);color:#060B18;font-weight:700;font-size:13px;cursor:pointer">ìƒë‹´ ì‹œì‘</button></div>';}
    html+='</div>';
    if(step>=2){html+='<div style="padding:10px 14px;border-top:1px solid rgba(255,255,255,.08);display:flex;gap:8px"><input id="wc-input" onkeydown="if(event.key===\'Enter\')WC.send()" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." style="flex:1;padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,.1);background:#111B2E;color:rgba(255,255,255,.9);font-size:13px;outline:none"><button onclick="WC.send()" style="width:40px;height:40px;border-radius:10px;border:none;background:linear-gradient(135deg,#00D4FF,#0088FF);cursor:pointer;display:flex;align-items:center;justify-content:center"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M2 21l21-9L2 3v7l15 2-15 2v7z" fill="#060B18"/></svg></button></div>';}
    html+='</div>';
    el.innerHTML=html;var mc=document.getElementById('wc-msgs');if(mc)mc.scrollTop=mc.scrollHeight;
  }
  function bbl(f,t){return f==='bot'?'<div style="align-self:flex-start;max-width:85%;padding:10px 14px;border-radius:12px 12px 12px 4px;background:#111B2E;border:1px solid rgba(255,255,255,.06)"><div style="font-size:13px;color:rgba(255,255,255,.75);line-height:1.5">'+t+'</div></div>':'<div style="align-self:flex-end;max-width:85%;padding:10px 14px;border-radius:12px 12px 4px 12px;background:linear-gradient(135deg,#00D4FF20,#0088FF15);border:1px solid #00D4FF30"><div style="font-size:13px;color:rgba(255,255,255,.9);line-height:1.5">'+t+'</div></div>';}
  function qb(a){var h='<div style="display:flex;flex-wrap:wrap;gap:6px">';for(var i=0;i<a.length;i++)h+='<div onclick="WC.pick(\''+esc(a[i])+'\')" style="padding:6px 12px;border-radius:8px;border:1px solid rgba(0,212,255,.3);background:rgba(0,212,255,.06);color:#00D4FF;font-size:12px;font-weight:600;cursor:pointer">'+a[i]+'</div>';return h+'</div>';}
  function esc(s){return String(s||'').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;');}
  var ar={'ë¬´ë£Œ ë¶„ì„ì´ ê¶ê¸ˆí•´ìš”':'URLì´ë‚˜ ì´ë¯¸ì§€ë¥¼ ì˜¬ë¦¬ë©´ 13ê°œ ì„¹ì…˜ì˜ ì¢…í•© ìˆ˜ì¶œ ë¶„ì„ ë¦¬í¬íŠ¸ê°€ ìƒì„±ë©ë‹ˆë‹¤!','ë°”ìš°ì²˜ ë¬¸ì˜':'ìˆ˜ì¶œë°”ìš°ì²˜Â·ì œì¡°í˜ì‹ ë°”ìš°ì²˜ ê³µì‹ ìˆ˜í–‰ê¸°ê´€ì…ë‹ˆë‹¤. ì •ë¶€ 50~85% ë¶€ë‹´.','ì•Œë¦¬ë°”ë°” ì…ì ':'ì´íŒ(200ë§Œì›)ê³¼ ë…ë¦½(500ë§Œì›) ë‘ ëª¨ë¸. ë°”ìš°ì²˜ ìµœëŒ€ 85% ì ˆê°.','ê¸°íƒ€ ë¬¸ì˜':'ê¶ê¸ˆí•œ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. ë‹´ë‹¹ìê°€ ë‹µë³€ë“œë¦½ë‹ˆë‹¤.'};
  window.WC={
    toggle:function(){open=!open;r();},
    pick:function(t){msgs.push({from:'user',text:t});if(ar[t]){msgs.push({from:'bot',text:ar[t]});msgs.push({from:'bot',text:'ë” ìì„¸í•œ ìƒë‹´ì„ ì›í•˜ì‹œë©´ ì •ë³´ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”.'});step=1;}r();},
    submitInfo:function(){var n=document.getElementById('wc-name'),e=document.getElementById('wc-email'),p=document.getElementById('wc-phone');info.name=n?n.value:'';info.email=e?e.value:'';info.phone=p?p.value:'';if(!info.name){alert('ì´ë¦„/íšŒì‚¬ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');return;}msgs.push({from:'bot',text:info.name+'ë‹˜, ë°˜ê°‘ìŠµë‹ˆë‹¤! ê¶ê¸ˆí•œ ì ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'});step=2;r();},
    send:function(){var inp=document.getElementById('wc-input');if(!inp||!inp.value.trim())return;var msg=inp.value.trim();msgs.push({from:'user',text:msg});r();fetch(RELAY+'/api/whistle/chat-inquiry',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:info.name,email:info.email,phone:info.phone,message:msg,page:PAGE})}).then(function(r){return r.json();}).then(function(d){if(d.ok){msgs.push({from:'bot',text:d.reply||'ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.'});r();}}).catch(function(){msgs.push({from:'bot',text:'ì „ì†¡ ì‹¤íŒ¨. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'});r();});}
  };r();
})();
</script>
</body>
</html>
