<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Whistle AI â€” Admin Portal</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&family=Noto+Sans+KR:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root{--bg:#060B18;--bg2:#0A1020;--card:#0D1424;--card2:#111B2E;--sf:#111B2E;--pri:#00D4FF;--pri-g:linear-gradient(135deg,#00D4FF,#0088FF);--pri-d:#0088FF;--pri-glow:0 0 30px rgba(0,212,255,.12);--acc:#FFB800;--acc-g:linear-gradient(135deg,#FFB800,#FF8C00);--ok:#00E676;--err:#FF5252;--warn:#FFA726;--purple:#A855F7;--w:#fff;--w90:rgba(255,255,255,.9);--w70:rgba(255,255,255,.7);--w60:rgba(255,255,255,.6);--w40:rgba(255,255,255,.4);--w20:rgba(255,255,255,.2);--w12:rgba(255,255,255,.1);--w08:rgba(255,255,255,.06);--bd:rgba(255,255,255,.08);--bd-l:rgba(255,255,255,.15);--r:14px;--r-s:10px;--r-xs:6px;--shadow:0 4px 24px rgba(0,0,0,.4);--shadow-lg:0 12px 48px rgba(0,0,0,.6);--admin:#FF6B6B;--admin-g:linear-gradient(135deg,#FF6B6B,#EE5A24)}
*{box-sizing:border-box;margin:0;padding:0}html{scroll-behavior:smooth}
body{background:var(--bg);font-family:'Sora','Noto Sans KR',-apple-system,sans-serif;color:var(--w);line-height:1.5;overflow:hidden;height:100vh}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:var(--bg2)}::-webkit-scrollbar-thumb{background:var(--w12);border-radius:3px}::selection{background:rgba(255,107,107,.3)}
input:focus,textarea:focus,select:focus{outline:none;border-color:var(--admin)!important;box-shadow:0 0 0 3px rgba(255,107,107,.1)}
select option{background:var(--card);color:var(--w90)}textarea{resize:vertical;min-height:60px}a{color:var(--pri);text-decoration:none}
.app-layout{display:flex;height:100vh;overflow:hidden}
.sidebar{width:260px;background:var(--bg2);border-right:1px solid var(--bd);display:flex;flex-direction:column;flex-shrink:0;overflow-y:auto}
.sidebar-header{padding:16px;border-bottom:1px solid var(--bd);display:flex;align-items:center;gap:10px}
.sidebar-logo{width:36px;height:36px;border-radius:9px;background:var(--admin-g);display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:900;color:var(--w);flex-shrink:0}
.sidebar-title{font-size:15px;font-weight:800;letter-spacing:-.5px}
.sidebar-sub{font-size:10px;color:var(--admin);font-family:'JetBrains Mono';font-weight:600}
.sidebar-nav{flex:1;padding:8px;overflow-y:auto}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:var(--r-s);font-size:13px;font-weight:500;color:var(--w60);cursor:pointer;transition:all .15s;border:1px solid transparent;margin-bottom:2px}
.nav-item:hover{background:var(--w08);color:var(--w90)}
.nav-item.active{background:rgba(255,107,107,.08);color:var(--admin);border-color:rgba(255,107,107,.15);font-weight:600}
.nav-item .icon{font-size:16px;width:20px;text-align:center}
.nav-item .badge-count{margin-left:auto;font-size:10px;background:var(--err);color:var(--w);padding:1px 6px;border-radius:10px;font-weight:700}
.nav-section{height:1px;background:var(--bd);margin:8px 12px}
.sidebar-footer{padding:12px;border-top:1px solid var(--bd)}
.main-area{flex:1;display:flex;flex-direction:column;overflow:hidden}
.topbar{height:52px;background:rgba(6,11,24,.9);backdrop-filter:blur(12px);border-bottom:1px solid var(--bd);display:flex;align-items:center;justify-content:space-between;padding:0 24px;flex-shrink:0}
.topbar-title{font-size:15px;font-weight:700;display:flex;align-items:center;gap:8px}
.topbar-title .admin-tag{font-size:9px;padding:2px 6px;border-radius:4px;background:rgba(255,107,107,.15);color:var(--admin);font-weight:700;letter-spacing:1px}
.page-content{flex:1;overflow-y:auto;padding:24px}
.card{background:var(--card);border-radius:var(--r);border:1px solid var(--bd);overflow:hidden}
.card-h{padding:14px 18px;border-bottom:1px solid var(--bd);display:flex;align-items:center;justify-content:space-between;font-weight:700;font-size:14px}
.card-b{padding:18px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:9px 18px;border-radius:var(--r-s);font-size:13px;font-weight:600;font-family:inherit;cursor:pointer;border:none;transition:all .15s;white-space:nowrap}
.btn:hover{filter:brightness(1.1);transform:translateY(-1px)}.btn:active{transform:translateY(0)}.btn:disabled{opacity:.5;cursor:not-allowed}
.btn-pri{background:var(--pri-g);color:var(--bg);box-shadow:var(--pri-glow)}.btn-acc{background:var(--acc-g);color:var(--bg)}
.btn-admin{background:var(--admin-g);color:var(--w)}
.btn-ok{background:var(--ok);color:var(--bg)}.btn-ghost{background:transparent;color:var(--w);border:1.5px solid var(--bd-l)}
.btn-ghost:hover{border-color:var(--w40)}.btn-danger{background:rgba(255,82,82,.15);color:var(--err);border:1px solid rgba(255,82,82,.2)}
.btn-sm{padding:5px 12px;font-size:12px;border-radius:var(--r-xs)}.btn-lg{padding:12px 24px;font-size:14px}.btn-block{width:100%}
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:var(--r-xs);font-size:11px;font-weight:600;font-family:'JetBrains Mono',monospace}
.badge-pri{background:rgba(0,212,255,.1);color:var(--pri);border:1px solid rgba(0,212,255,.2)}
.badge-acc{background:rgba(255,184,0,.1);color:var(--acc);border:1px solid rgba(255,184,0,.2)}
.badge-ok{background:rgba(0,230,118,.1);color:var(--ok);border:1px solid rgba(0,230,118,.2)}
.badge-err{background:rgba(255,82,82,.1);color:var(--err);border:1px solid rgba(255,82,82,.2)}
.badge-purple{background:rgba(168,85,247,.1);color:var(--purple);border:1px solid rgba(168,85,247,.2)}
.badge-ghost{background:var(--w08);color:var(--w40);border:1px solid var(--bd)}
.badge-admin{background:rgba(255,107,107,.1);color:var(--admin);border:1px solid rgba(255,107,107,.2)}
.form-group{margin-bottom:14px}
.form-label{display:block;font-size:12px;font-weight:600;color:var(--w40);margin-bottom:6px}
.form-input,.form-select,.form-textarea{width:100%;padding:11px 14px;border-radius:var(--r-s);border:1.5px solid var(--bd);background:var(--sf);color:var(--w90);font-size:14px;font-family:inherit}
.form-input::placeholder{color:var(--w20)}
.tbl{width:100%;border-collapse:collapse}
.tbl th{text-align:left;padding:10px 14px;font-size:11px;font-weight:600;color:var(--w40);text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--bd-l);background:var(--w08)}
.tbl td{padding:11px 14px;font-size:13px;border-bottom:1px solid var(--w08);color:var(--w90)}
.tbl tr:hover td{background:var(--w08)}
.tbl tr{cursor:pointer}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
.grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.grid-5{display:grid;grid-template-columns:repeat(5,1fr);gap:12px}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;visibility:hidden;transition:all .2s}
.modal-overlay.show{opacity:1;visibility:visible}
.modal{background:var(--card);border:1px solid var(--bd-l);border-radius:var(--r);width:90%;max-width:640px;max-height:85vh;overflow-y:auto;box-shadow:var(--shadow-lg)}
.modal-h{padding:16px 20px;border-bottom:1px solid var(--bd);display:flex;align-items:center;justify-content:space-between}
.modal-h h3{font-size:16px;font-weight:700}
.modal-close{width:28px;height:28px;border-radius:8px;background:var(--w08);border:none;color:var(--w40);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.modal-close:hover{background:var(--w12);color:var(--w)}
.modal-b{padding:20px}.modal-f{padding:14px 20px;border-top:1px solid var(--bd);display:flex;justify-content:flex-end;gap:8px}
.toast-container{position:fixed;top:16px;right:16px;z-index:2000;display:flex;flex-direction:column;gap:8px}
.toast{padding:12px 18px;border-radius:var(--r-s);font-size:13px;font-weight:500;display:flex;align-items:center;gap:8px;box-shadow:var(--shadow);animation:slideInR .3s ease;min-width:280px}
.toast-ok{background:#0a2a1a;border:1px solid rgba(0,230,118,.25);color:var(--ok)}
.toast-err{background:#2a0a0a;border:1px solid rgba(255,82,82,.25);color:var(--err)}
.toast-warn{background:#2a1a0a;border:1px solid rgba(255,167,38,.25);color:var(--warn)}
.toast-info{background:#0a1a2a;border:1px solid rgba(0,212,255,.25);color:var(--pri)}
.stat-card{background:var(--card);border:1px solid var(--bd);border-radius:var(--r);padding:18px}
.stat-label{font-size:11px;color:var(--w40);font-weight:500;margin-bottom:6px}
.stat-value{font-family:'Sora';font-weight:800;font-size:26px;letter-spacing:-1px}
.stat-sub{font-size:11px;color:var(--w20);margin-top:4px}
.spinner{width:24px;height:24px;border:3px solid var(--w08);border-top-color:var(--admin);border-radius:50%;animation:spin .8s linear infinite}
.auth-wrap{display:flex;align-items:center;justify-content:center;height:100vh;background:var(--bg);padding:20px}
.auth-card{width:100%;max-width:420px;background:var(--card);border:1px solid rgba(255,107,107,.2);border-radius:20px;padding:36px;box-shadow:var(--shadow-lg)}
.search-box{position:relative}
.search-box input{width:100%;padding:9px 14px 9px 36px;border-radius:var(--r-s);border:1.5px solid var(--bd);background:var(--sf);color:var(--w90);font-size:13px;font-family:inherit}
.search-box::before{content:'ğŸ”';position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:14px}
.status-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:6px}
.status-dot.active{background:var(--ok)}.status-dot.inactive{background:var(--err)}.status-dot.pending{background:var(--acc)}
.detail-row{display:grid;grid-template-columns:140px 1fr;gap:8px;padding:8px 0;border-bottom:1px solid var(--w08);font-size:13px}
.detail-label{color:var(--w40);font-weight:500}
.detail-value{color:var(--w90)}
.chart-bar{height:24px;border-radius:6px;position:relative;overflow:hidden;background:var(--w08)}
.chart-bar-fill{height:100%;border-radius:6px;transition:width .5s ease}
.tab-bar{display:flex;gap:4px;margin-bottom:16px;border-bottom:1px solid var(--bd);padding-bottom:8px}
.tab-item{padding:6px 14px;font-size:13px;font-weight:500;color:var(--w40);cursor:pointer;border-radius:var(--r-xs) var(--r-xs) 0 0;transition:all .15s}
.tab-item:hover{color:var(--w70);background:var(--w08)}
.tab-item.active{color:var(--admin);background:rgba(255,107,107,.08);font-weight:700}
.empty-state{text-align:center;padding:48px 24px;color:var(--w40)}
.empty-state .ei{font-size:48px;margin-bottom:12px;opacity:.4}
.empty-state .et{font-size:16px;font-weight:700;margin-bottom:4px;color:var(--w60)}
.empty-state .ed{font-size:13px}
@keyframes slideInR{from{transform:translateX(100px);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
@media(max-width:768px){.sidebar{position:fixed;left:-260px;top:0;bottom:0;z-index:100;transition:left .3s}.sidebar.mobile-open{left:0}.mob-toggle{display:block!important}.mob-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:99}.sidebar.mobile-open~.mob-overlay{display:block}.grid-2,.grid-3,.grid-4,.grid-5{grid-template-columns:1fr}.page-content{padding:16px}}
.mob-toggle{display:none;background:none;border:none;color:var(--w);font-size:20px;cursor:pointer;padding:4px 8px}
</style>
</head>
<body>
<div id="app"></div>
<script>
(function(){
"use strict";
var sb=window.supabase.createClient('https://lylktgxngrlxmsldxdqj.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx5bGt0Z3huZ3JseG1zbGR4ZHFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4MTQ2OTAsImV4cCI6MjA4NzM5MDY5MH0.8kgcDCMBT_STf43MVkeUUiq-K6r-Ytp3nUQ6d-nL2D0');

var RELAY_URL=(function(){if(location.hostname==='localhost'||location.hostname==='127.0.0.1')return'http://localhost:3456';var stored=localStorage.getItem('relay_url');if(stored)return stored;try{var x=new XMLHttpRequest();x.open('GET','relay-url.txt?t='+Date.now(),false);x.send();if(x.status===200&&x.responseText.trim().startsWith('https://'))return x.responseText.trim();}catch(e){}return''})();

/* === UTILS === */
var U={
  fd:function(d,s){if(!d)return'\u2014';var dt=new Date(d);if(isNaN(dt))return'\u2014';if(s==='rel'){var m=Math.floor((Date.now()-dt)/6e4);if(m<1)return'\uBC29\uAE08';if(m<60)return m+'\uBD84 \uC804';var h=Math.floor(m/60);if(h<24)return h+'\uC2DC\uAC04 \uC804';var dd=Math.floor(h/24);return dd+'\uC77C \uC804';}return dt.toLocaleDateString('ko-KR',{year:'numeric',month:'short',day:'numeric'});},
  usd:function(n){if(n==null)return'\u2014';return'$'+Number(n).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});},
  krw:function(n){if(n==null)return'\u2014';n=Number(n);if(n>=1e8)return'\u20A9'+(n/1e8).toFixed(1)+'\uC5B5';if(n>=1e4)return'\u20A9'+(n/1e4).toFixed(0)+'\uB9CC';return'\u20A9'+n.toLocaleString('ko-KR');},
  tr:function(s,l){l=l||50;return s&&s.length>l?s.slice(0,l)+'\u2026':s||'';},
  sl:function(t){return{premium_analysis:'\uD504\uB9AC\uBBF8\uC5C4 \uBD84\uC11D',matching:'\uBC14\uC774\uC5B4 \uB9E4\uCE6D',document:'\uC11C\uB958 \uB300\uD589',certification:'\uC778\uC99D \uB300\uD589',logistics:'\uBB3C\uB958/\uD1B5\uAD00',email_support:'\uC774\uBA54\uC77C \uC9C0\uC6D0'}[t]||t;},
  si:function(t){return{premium_analysis:'\uD83D\uDD2C',matching:'\uD83E\uDD1D',document:'\uD83D\uDCC4',certification:'\uD83C\uDFC5',logistics:'\uD83D\uDEA2',email_support:'\u2709\uFE0F'}[t]||'\uD83D\uDCCB';},
  cl:function(c){return{US:'\uD83C\uDDFA\uD83C\uDDF8',JP:'\uD83C\uDDEF\uD83C\uDDF5',CN:'\uD83C\uDDE8\uD83C\uDDF3',EU:'\uD83C\uDDEA\uD83C\uDDFA',SEA:'\uD83C\uDF0F'}[c]||c||'';},
  pl:function(p){return{free:['FREE','var(--w40)'],starter:['STARTER','var(--pri)'],basic:['STARTER','var(--pri)'],pro:['PRO','var(--acc)'],alibaba:['ALIBABA','var(--admin)']}[p]||['FREE','var(--w40)'];},
  pct:function(n,t){return t?Math.round(n/t*100):0;},
  esc:function(s){if(!s)return'';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}
};

/* === UI === */
var tc=null;
var UI={
  toast:function(msg,type,dur){type=type||'info';dur=dur||3000;if(!tc){tc=document.createElement('div');tc.className='toast-container';document.body.appendChild(tc);}var icons={ok:'\u2713',err:'\u2715',warn:'\u26A0',info:'\u2139'};var el=document.createElement('div');el.className='toast toast-'+type;el.innerHTML='<span>'+((icons[type])||'\u2139')+'</span><span>'+msg+'</span>';tc.appendChild(el);setTimeout(function(){el.style.opacity='0';el.style.transform='translateX(100px)';el.style.transition='all .3s';setTimeout(function(){el.remove();},300);},dur);},
  showModal:function(id){var e=document.getElementById(id);if(e)e.classList.add('show');},
  hideModal:function(id){var e=document.getElementById(id);if(e)e.classList.remove('show');},
  modal:function(o){return'<div class="modal-overlay" id="'+o.id+'" onclick="if(event.target===this)Adm.closeModal(\''+o.id+'\')"><div class="modal" style="max-width:'+(o.width||'640px')+'"><div class="modal-h"><h3>'+o.title+'</h3><button class="modal-close" onclick="Adm.closeModal(\''+o.id+'\')">&#10005;</button></div><div class="modal-b">'+o.body+'</div>'+(o.footer?'<div class="modal-f">'+o.footer+'</div>':'')+'</div></div>';},
  badge:function(t,type){return'<span class="badge badge-'+(type||'pri')+'">'+t+'</span>';},
  sb:function(s){var m={pending:['ëŒ€ê¸°','acc'],processing:['ì²˜ë¦¬ì¤‘','pri'],completed:['ì™„ë£Œ','ok'],cancelled:['ì·¨ì†Œ','ghost'],failed:['ì‹¤íŒ¨','err'],draft:['ì´ˆì•ˆ','ghost'],active:['í™œì„±','ok'],paused:['ì¤‘ì§€','acc'],analyzing:['ë¶„ì„ì¤‘','pri'],review:['ê²€ìˆ˜ì¤‘','purple'],approved:['ìŠ¹ì¸','ok'],accepted:['ì ‘ìˆ˜','pri'],planning:['ê¸°íš','pri'],certification:['ì¸ì¦','acc'],buyer_search:['ë§¤ì¹­','purple'],negotiation:['í˜‘ìƒ','acc'],shipping:['ì„ ì ','pri']};var r=m[s]||[s,'ghost'];return this.badge(r[0],r[1]);},
  empty:function(icon,title,desc){return'<div class="empty-state"><div class="ei">'+icon+'</div><div class="et">'+title+'</div><div class="ed">'+(desc||'')+'</div></div>';},
  stat:function(label,value,sub,color){return'<div class="stat-card"><div class="stat-label">'+label+'</div><div class="stat-value" style="color:'+(color||'var(--admin)')+'">'+value+'</div>'+(sub?'<div class="stat-sub">'+sub+'</div>':'')+'</div>';},
  inp:function(name,label,o){o=o||{};return'<div class="form-group"><label class="form-label">'+label+(o.required?' <span style="color:var(--err)">*</span>':'')+'</label><input class="form-input" name="'+name+'" type="'+(o.type||'text')+'" value="'+(o.value||'')+'" placeholder="'+(o.placeholder||'')+'" '+(o.required?'required':'')+'></div>';},
  sel:function(name,label,opts,sel){var os=opts.map(function(o){var v=typeof o==='object'?o.value:o;var t=typeof o==='object'?o.label:o;return'<option value="'+v+'" '+(v===sel?'selected':'')+'>'+t+'</option>';}).join('');return'<div class="form-group"><label class="form-label">'+label+'</label><select class="form-select" name="'+name+'">'+os+'</select></div>';},
  ta:function(name,label,o){o=o||{};return'<div class="form-group"><label class="form-label">'+label+'</label><textarea class="form-textarea" name="'+name+'" rows="'+(o.rows||3)+'" placeholder="'+(o.placeholder||'')+'">'+(o.value||'')+'</textarea></div>';},
  fd:function(sel){var el=typeof sel==='string'?document.querySelector(sel):sel;if(!el)return{};var d={};el.querySelectorAll('input,select,textarea').forEach(function(i){if(i.name){d[i.name]=i.type==='number'&&i.value?Number(i.value):i.value;}});return d;},
  pb:function(p){var r=U.pl(p);return'<span class="badge" style="background:'+r[1]+'15;color:'+r[1]+';border:1px solid '+r[1]+'25">'+r[0]+'</span>';}
};

/* === STATE === */
var S={
  user:null,page:'dashboard',loading:true,authError:'',
  users:[],analyses:[],products:[],projects:[],serviceRequests:[],companies:[],matchings:[],documents:[],
  orders:[],buyers:[],messages:[],shipments:[],paymentMilestones:[],pageViews:[],buyerRequests:[],proposals:[],
  searchFilter:'',statusFilter:'all',dateFilter:'all',
  selectedUser:null,selectedAnalysis:null,selectedSR:null,
  selectedBuyer:null,selectedSeller:null,selectedMatching:null,selectedOrder:null,
  tab:'all',analyticsTab:'users',paymentTab:'revenue',
  subscriptions:[],escrowTxns:[],
  alibabaStores:[],alibabaInquiries:[],_buyerTab:'all'
};

function set(u){for(var k in u)S[k]=u[k];render();}

/* === DATA LOADING === */
function loadUser(){
  sb.auth.getSession().then(function(res){
    var session=res.data.session;
    if(!session)return set({loading:false});
    sb.from('users').select('*').eq('id',session.user.id).single().then(function(r){
      if(r.error||!r.data||r.data.role!=='admin'){
        sb.auth.signOut();
        return set({loading:false,authError:'ê´€ë¦¬ì ê³„ì •ë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤'});
      }
      S.user=r.data;S.loading=false;
      loadAll();
    });
  });
}

function loadAll(){
  Promise.allSettled([
    sb.from('users').select('*').order('created_at',{ascending:false}).limit(200).then(function(r){S.users=r.data||[];}),
    sb.from('analyses').select('*').order('created_at',{ascending:false}).limit(200).then(function(r){S.analyses=r.data||[];}),
    sb.from('products').select('*').order('created_at',{ascending:false}).limit(200).then(function(r){S.products=r.data||[];}),
    sb.from('projects').select('*').order('created_at',{ascending:false}).limit(200).then(function(r){S.projects=r.data||[];}),
    sb.from('service_requests').select('*').order('created_at',{ascending:false}).limit(200).then(function(r){S.serviceRequests=r.data||[];}),
    sb.from('companies').select('*').order('created_at',{ascending:false}).limit(200).then(function(r){S.companies=r.data||[];}),
    sb.from('matchings').select('*').order('created_at',{ascending:false}).limit(200).then(function(r){S.matchings=r.data||[];}),
    sb.from('documents').select('*').order('created_at',{ascending:false}).limit(200).then(function(r){S.documents=r.data||[];}),
    sb.from('orders').select('*').order('created_at',{ascending:false}).limit(200).then(function(r){S.orders=r.data||[];}),
    sb.from('buyers').select('*').order('created_at',{ascending:false}).limit(200).then(function(r){S.buyers=r.data||[];}),
    sb.from('messages').select('*').order('created_at',{ascending:false}).limit(200).then(function(r){S.messages=r.data||[];}),
    sb.from('shipments').select('*').order('created_at',{ascending:false}).limit(200).then(function(r){S.shipments=r.data||[];}),
    sb.from('payment_milestones').select('*').order('created_at',{ascending:false}).limit(200).then(function(r){S.paymentMilestones=r.data||[];}),
    sb.from('page_views').select('*').order('created_at',{ascending:false}).limit(200).then(function(r){S.pageViews=r.data||[];}),
    sb.from('buyer_requests').select('*').order('created_at',{ascending:false}).limit(200).then(function(r){S.buyerRequests=r.data||[];}),
    sb.from('buyer_request_proposals').select('*').order('created_at',{ascending:false}).limit(200).then(function(r){S.proposals=r.data||[];}),
    sb.from('subscriptions').select('*').order('created_at',{ascending:false}).limit(200).then(function(r){S.subscriptions=r.data||[];}),
    sb.from('escrow_transactions').select('*').order('created_at',{ascending:false}).limit(200).then(function(r){S.escrowTxns=r.data||[];}),
    sb.from('alibaba_stores').select('*').order('created_at',{ascending:false}).limit(200).then(function(r){S.alibabaStores=r.data||[];}),
    sb.from('alibaba_inquiries').select('*').order('created_at',{ascending:false}).limit(200).then(function(r){S.alibabaInquiries=r.data||[];})
  ]).then(function(){render();});
}

/* === AUTH === */
function doLogin(e){
  e.preventDefault();var f=e.target;S.authError='';
  sb.auth.signInWithPassword({email:f.email.value,password:f.password.value}).then(function(r){
    if(r.error)return set({authError:r.error.message==='Invalid login credentials'?'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.':r.error.message});
    loadUser();
  });
}
function doLogout(){if(confirm('ë¡œê·¸ì•„ì›ƒ?')){sb.auth.signOut().then(function(){S.user=null;render();});}}

/* === HELPER === */
function getUserName(uid){var u=S.users.find(function(x){return x.id===uid;});return U.esc(u?(u.company_name||u.display_name||u.email):'ì•Œìˆ˜ì—†ìŒ');}
function getCompany(uid){return S.companies.find(function(x){return x.user_id===uid;})||null;}
function getBuyerName(bid){var b=S.buyers.find(function(x){return x.id===bid;});return b?U.esc(b.company_name):'â€”';}
function getBuyerCountry(bid){var b=S.buyers.find(function(x){return x.id===bid;});return b?b.country:'';}
var FLAGS={KR:'\uD83C\uDDF0\uD83C\uDDF7',CN:'\uD83C\uDDE8\uD83C\uDDF3',JP:'\uD83C\uDDEF\uD83C\uDDF5',US:'\uD83C\uDDFA\uD83C\uDDF8',VN:'\uD83C\uDDFB\uD83C\uDDF3',AE:'\uD83C\uDDE6\uD83C\uDDEA',SG:'\uD83C\uDDF8\uD83C\uDDEC',TH:'\uD83C\uDDF9\uD83C\uDDED',RU:'\uD83C\uDDF7\uD83C\uDDFA',HK:'\uD83C\uDDED\uD83C\uDDF0',TW:'\uD83C\uDDF9\uD83C\uDDFC',DE:'\uD83C\uDDE9\uD83C\uDDEA',FR:'\uD83C\uDDEB\uD83C\uDDF7',GB:'\uD83C\uDDEC\uD83C\uDDE7',AU:'\uD83C\uDDE6\uD83C\uDDFA'};
function flag(c){return FLAGS[c]||'\uD83C\uDF0D';}
function groupBy(arr,key){var m={};arr.forEach(function(x){var k=x[key]||'unknown';if(!m[k])m[k]=[];m[k].push(x);});return m;}
function sumBy(arr,key){return arr.reduce(function(s,x){return s+(Number(x[key])||0);},0);}
function matchStatusLabel(s){return{proposed:'\uC81C\uC548',interested:'\uAD00\uC2EC',sample:'\uC0D8\uD50C',negotiation:'\uD611\uC0C1',contract:'\uACC4\uC57D',completed:'\uC644\uB8CC',rejected:'\uAC70\uC808',expired:'\uB9CC\uB8CC'}[s]||s;}
function orderStatusLabel(s){return{confirmed:'\uD655\uC815',production:'\uC0DD\uC0B0\uC911',inspection:'\uAC80\uC218',shipping:'\uC120\uC801\uC911',delivered:'\uBC30\uC1A1\uC644\uB8CC',completed:'\uC644\uB8CC',cancelled:'\uCDE8\uC18C'}[s]||s;}
function hBar(label,val,max,color){var pct=max?Math.round(val/max*100):0;return '<div style="margin-bottom:8px"><div style="display:flex;justify-content:space-between;margin-bottom:3px"><span style="font-size:12px;color:var(--w60)">'+label+'</span><span style="font-size:12px;font-weight:700;font-family:JetBrains Mono;color:'+(color||'var(--pri)')+'">'+val+'</span></div><div class="chart-bar" style="height:8px"><div class="chart-bar-fill" style="width:'+Math.max(pct,2)+'%;background:'+(color||'var(--pri)')+'"></div></div></div>';}
function filterBySearch(arr,fields){
  var q=S.searchFilter.toLowerCase().trim();
  if(!q)return arr;
  return arr.filter(function(item){
    return fields.some(function(f){
      var v=item[f];
      return v&&String(v).toLowerCase().indexOf(q)>=0;
    });
  });
}

/* === PAYMENT CONSTANTS === */
/* Buyer plans (USD) */
var PLAN_PRICE_BUYER={starter:{m:29,s:156.60,a:278.40},pro:{m:89,s:480.60,a:854.40},enterprise:{m:499,s:2694.60,a:4790.40}};
/* Manufacturer plans (KRW â†’ USD@1400) */
var PLAN_PRICE_MFR={starter:{m:71,s:383.40,a:681.60,krw_m:99000,krw_s:534600,krw_a:950400},pro:{m:214,s:1155.60,a:2054.40,krw_m:299000,krw_s:1614600,krw_a:2870400},alibaba:{m:199,s:1074.60,a:1910.40,setup_total:2000000,setup_voucher:300000}};
/* Combined lookup (ê¸°ë³¸ì€ buyer ê¸°ì¤€, starter=basic alias) */
var PLAN_PRICE={starter:{m:29,s:156.60,a:278.40},basic:{m:29,s:156.60,a:278.40},pro:{m:89,s:480.60,a:854.40},alibaba:{m:199,s:1074.60,a:1910.40},enterprise:{m:499,s:2694.60,a:4790.40}};
var CYCLE_L={monthly:'\uC6D4\uAC04',semi_annual:'6\uAC1C\uC6D4',annual:'\uC5F0\uAC04'};
var CYCLE_M={monthly:1,semi_annual:6,annual:12};
var ESC_ST={pending_deposit:['\uC785\uAE08\uB300\uAE30','ghost'],funded:['\uC608\uCE58\uC644\uB8CC','pri'],in_production:['\uC0DD\uC0B0\uC911','acc'],shipped:['\uC120\uC801\uC644\uB8CC','purple'],inspection:['\uAC80\uC218\uC911','acc'],released:['\uC815\uC0B0\uC644\uB8CC','ok'],refunded:['\uD658\uBD88','err'],disputed:['\uBD84\uC7C1','err']};
var ESC_COL={pending_deposit:'var(--w40)',funded:'var(--pri)',in_production:'var(--acc)',shipped:'var(--purple)',inspection:'var(--warn)',released:'var(--ok)',refunded:'var(--err)',disputed:'var(--err)'};
function escBadge(s){var e=ESC_ST[s];return e?UI.badge(e[0],e[1]):UI.badge(s||'\u2014','ghost');}
function calcMRR(){var mrr=0;if(S.subscriptions.length){S.subscriptions.filter(function(s){return s.status==='active';}).forEach(function(s){var a=Number(s.amount)||0;if(s.billing_cycle==='semi_annual')mrr+=a/6;else if(s.billing_cycle==='annual')mrr+=a/12;else mrr+=a;});}else{S.users.forEach(function(u){var isMfr=(u.role==='client'&&u.preferred_currency==='KRW');var k=u.plan==='basic'?'starter':u.plan;if(isMfr){var mp=PLAN_PRICE_MFR[k];if(mp)mrr+=mp.m;}else{var bp=PLAN_PRICE[k];if(bp)mrr+=bp.m;}});}return mrr;}
function calcEscrowHold(){return S.escrowTxns.filter(function(e){return['funded','in_production','shipped','inspection'].indexOf(e.escrow_status)>=0;}).reduce(function(s,e){return s+(Number(e.amount)||0);},0);}
function calcEscrowComm(){return S.escrowTxns.filter(function(e){return e.escrow_status==='released';}).reduce(function(s,e){return s+(Number(e.commission_amount)||0);},0);}
function calcFloat(){return S.escrowTxns.reduce(function(s,e){return s+(Number(e.float_revenue_estimate)||0);},0);}

/* ============ PAGES ============ */

/* â”€â”€ Auth â”€â”€ */
function pgAuth(){
  return '<div class="auth-wrap"><div class="auth-card"><div style="display:flex;align-items:center;gap:10px;margin-bottom:28px"><div style="width:42px;height:42px;border-radius:10px;background:var(--admin-g);display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:900;color:var(--w)">W</div><div><div style="font-size:22px;font-weight:800;letter-spacing:-.5px">Whistle AI</div><div style="font-size:12px;color:var(--admin);font-weight:600">ADMIN PORTAL</div></div></div>'+(S.authError?'<div style="padding:10px 14px;border-radius:8px;background:rgba(255,82,82,.1);border:1px solid rgba(255,82,82,.2);color:var(--err);font-size:12px;margin-bottom:12px">'+S.authError+'</div>':'')+'<form onsubmit="Adm.doLogin(event)">'+UI.inp('email','ì´ë©”ì¼',{type:'email',placeholder:'admin@whistle-ai.com',required:true})+UI.inp('password','ë¹„ë°€ë²ˆí˜¸',{type:'password',placeholder:'ë¹„ë°€ë²ˆí˜¸',required:true})+'<button class="btn btn-admin btn-block btn-lg" type="submit" style="margin-top:12px">ê´€ë¦¬ì ë¡œê·¸ì¸</button></form><div style="text-align:center;margin-top:16px;font-size:11px;color:var(--w20)">ê´€ë¦¬ì ê³„ì •ë§Œ ì ‘ê·¼ ê°€ëŠ¥</div></div></div>';
}

/* â”€â”€ Dashboard â”€â”€ */
function pgDash(){
  var today=new Date();var t7=new Date(today-7*864e5);var t30=new Date(today-30*864e5);
  var clients=S.users.filter(function(u){return u.role==='client';});
  var buyerUsers=S.users.filter(function(u){return u.role==='buyer';});
  var completedDeals=S.matchings.filter(function(m){return m.status==='completed';});
  var totalRevenue=sumBy(S.orders.filter(function(o){return o.payment_status==='paid'||o.status==='completed';}), 'total_amount');
  var activeDeals=S.matchings.filter(function(m){return m.status!=='completed'&&m.status!=='rejected'&&m.status!=='expired';}).length;
  var countries={}; S.buyers.forEach(function(b){if(b.country)countries[b.country]=(countries[b.country]||0)+1;});
  var countryCount=Object.keys(countries).length;
  var newUsers7=S.users.filter(function(u){return new Date(u.created_at)>=t7;}).length;
  var convRate=clients.length?Math.round(completedDeals.length/clients.length*100):0;

  // Plan distribution
  var planDist={free:0,starter:0,basic:0,pro:0,alibaba:0};
  clients.forEach(function(u){planDist[u.plan||'free']=(planDist[u.plan||'free']||0)+1;});
  planDist.starter=(planDist.starter||0)+(planDist.basic||0);planDist.basic=0;
  var maxPlan=Math.max(planDist.free,planDist.starter,planDist.pro,planDist.alibaba,1);

  // Pipeline funnel
  var pipeline={proposed:0,interested:0,sample:0,negotiation:0,contract:0,completed:0};
  S.matchings.forEach(function(m){if(pipeline[m.status]!==undefined)pipeline[m.status]++;});
  var maxPipe=Math.max.apply(null,Object.values(pipeline).concat([1]));

  // Recent activity
  var recentMsgs=S.messages.slice(0,5);

  return '<div style="margin-bottom:20px"><h2 style="font-size:22px;font-weight:800">\uAD00\uB9AC\uC790 \uB300\uC2DC\uBCF4\uB4DC</h2><p style="font-size:13px;color:var(--w40);margin-top:4px">'+today.toLocaleDateString('ko-KR',{year:'numeric',month:'long',day:'numeric',weekday:'long'})+'</p></div>'+

  '<div class="grid-5" style="margin-bottom:20px">'+
    UI.stat('\uC804\uCCB4 \uC720\uC800',S.users.length,'\uC81C\uC870\uC0AC '+clients.length+' / \uBC14\uC774\uC5B4 '+buyerUsers.length+' (+'+newUsers7+' 7\uC77C)','var(--pri)')+
    UI.stat('\uD65C\uC131 \uB51C',activeDeals,completedDeals.length+'\uAC74 \uC644\uB8CC','var(--acc)')+
    UI.stat('\uC804\uD658\uC728',convRate+'%','\uC81C\uC870\uC0AC\u2192\uC644\uB8CC\uB51C','var(--ok)')+
    UI.stat('\uB204\uC801 \uB9E4\uCD9C',U.usd(totalRevenue),S.orders.length+'\uAC74 \uC8FC\uBB38','var(--admin)')+
    UI.stat('\uAD6D\uAC00\uC218',countryCount,'\uBC14\uC774\uC5B4 '+S.buyers.length+'\uBA85','var(--purple)')+
  '</div>'+

  '<div class="grid-2" style="margin-bottom:20px">'+
    // Plan distribution
    '<div class="card"><div class="card-h"><span>\uD50C\uB79C \uBD84\uD3EC</span>'+UI.badge(clients.length+'\uBA85','pri')+'</div><div class="card-b">'+
      Object.keys(planDist).map(function(k){
        var r=U.pl(k);
        return hBar(r[0],planDist[k],maxPlan,r[1]);
      }).join('')+
    '</div></div>'+

    // Pipeline funnel
    '<div class="card"><div class="card-h"><span>\uD30C\uC774\uD504\uB77C\uC778 \uD37C\uB110</span>'+UI.badge(S.matchings.length+'\uAC74','acc')+'</div><div class="card-b">'+
      [{k:'proposed',c:'var(--w40)'},{k:'interested',c:'var(--pri)'},{k:'sample',c:'var(--acc)'},{k:'negotiation',c:'var(--warn)'},{k:'contract',c:'var(--purple)'},{k:'completed',c:'var(--ok)'}].map(function(st){
        return hBar(matchStatusLabel(st.k),pipeline[st.k],maxPipe,st.c);
      }).join('')+
    '</div></div>'+
  '</div>'+

  '<div class="grid-2" style="margin-bottom:20px">'+
    // Country distribution
    '<div class="card"><div class="card-h"><span>\uAD6D\uAC00\uBCC4 \uBC14\uC774\uC5B4</span></div><div class="card-b">'+
      (function(){var sorted=Object.entries(countries).sort(function(a,b){return b[1]-a[1];});var mx=sorted.length?sorted[0][1]:1;
        return sorted.map(function(e){return hBar(flag(e[0])+' '+e[0],e[1],mx,'var(--pri)');}).join('');
      })()+
    '</div></div>'+

    // Recent messages
    '<div class="card"><div class="card-h"><span>\uCD5C\uADFC \uBA54\uC2DC\uC9C0</span><button class="btn btn-ghost btn-sm" onclick="Adm.nav(\'chat\')">\uC804\uCCB4 \u2192</button></div><div class="card-b">'+(recentMsgs.length?recentMsgs.map(function(m){
      return '<div style="display:flex;align-items:center;gap:10px;padding:7px 0;border-bottom:1px solid var(--w08)"><div style="width:28px;height:28px;border-radius:7px;background:'+(m.direction==='inbound'?'rgba(0,212,255,.1)':'rgba(255,184,0,.1)')+';display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0">'+(m.direction==='inbound'?'\u2B05':'\u27A1')+'</div><div style="flex:1;min-width:0"><div style="font-size:12px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+U.tr(m.subject||m.body,40)+'</div><div style="font-size:10px;color:var(--w40)">'+getUserName(m.user_id)+' \u2192 '+getBuyerName(m.buyer_id)+' \xB7 '+U.fd(m.created_at,'rel')+'</div></div>'+(m.is_read?'':'<div style="width:6px;height:6px;border-radius:3px;background:var(--err)"></div>')+'</div>';
    }).join(''):UI.empty('\uD83D\uDCAC','\uBA54\uC2DC\uC9C0 \uC5C6\uC74C',''))+'</div></div>'+
  '</div>';
}

/* â”€â”€ Users â”€â”€ */
function pgUsers(){
  if(S.selectedUser)return pgUserDetail();
  var filtered=filterBySearch(S.users,['email','company_name','display_name']);
  if(S.tab!=='all')filtered=filtered.filter(function(u){return u.plan===S.tab||u.role===S.tab;});

  var plans=['all','free','starter','basic','pro','alibaba'];
  return '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px"><h2 style="font-size:18px;font-weight:800">ğŸ‘¥ ìœ ì € ê´€ë¦¬</h2>'+UI.badge(S.users.length+'ëª…','pri')+'</div>'+
  '<div style="display:flex;gap:10px;margin-bottom:16px"><div class="search-box" style="flex:1"><input placeholder="ì´ë©”ì¼, íšŒì‚¬ëª… ê²€ìƒ‰..." value="'+S.searchFilter+'" oninput="Adm.setSearch(this.value)"></div></div>'+
  '<div class="tab-bar">'+plans.map(function(p){
    var label=p==='all'?'ì „ì²´':U.pl(p)[0];
    var count=p==='all'?S.users.length:S.users.filter(function(u){return u.plan===p;}).length;
    return '<div class="tab-item '+(S.tab===p?'active':'')+'" onclick="Adm.setTab(\''+p+'\')">'+label+' <span style="font-size:10px;color:var(--w20)">'+count+'</span></div>';
  }).join('')+'</div>'+
  '<div class="card"><div class="card-b" style="padding:0"><table class="tbl"><thead><tr><th>ìœ ì €</th><th>íšŒì‚¬</th><th>í”Œëœ</th><th>ìƒíƒœ</th><th>ë¶„ì„</th><th>ê°€ì…ì¼</th></tr></thead><tbody>'+
  (filtered.length?filtered.map(function(u){
    var ac=S.analyses.filter(function(a){return a.user_id===u.id;}).length;
    return '<tr onclick="Adm.viewUser(\''+u.id+'\')"><td><div style="display:flex;align-items:center;gap:10px"><div style="width:32px;height:32px;border-radius:8px;background:'+(u.role==='admin'?'var(--admin-g)':'var(--pri-g)')+';display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:800;color:'+(u.role==='admin'?'var(--w)':'var(--bg)')+';flex-shrink:0">'+U.esc((u.company_name||u.email||'U').charAt(0).toUpperCase())+'</div><div><div style="font-size:13px;font-weight:600">'+U.esc(u.display_name||u.email.split('@')[0])+'</div><div style="font-size:11px;color:var(--w40)">'+U.esc(u.email)+'</div></div></div></td><td style="font-size:12px">'+U.esc(u.company_name||'\u2014')+'</td><td>'+UI.pb(u.plan||'free')+'</td><td><span class="status-dot '+(u.is_active?'active':'inactive')+'"></span>'+(u.is_active?'í™œì„±':'ë¹„í™œì„±')+'</td><td style="font-family:JetBrains Mono;font-size:12px;text-align:center">'+ac+'</td><td style="font-size:12px;color:var(--w40)">'+U.fd(u.created_at)+'</td></tr>';
  }).join(''):'<tr><td colspan="6">'+UI.empty('ğŸ‘¥','ê²°ê³¼ ì—†ìŒ','')+'</td></tr>')+
  '</tbody></table></div></div>';
}

function pgUserDetail(){
  var u=S.selectedUser;if(!u)return'';
  var co=getCompany(u.id);
  var ua=S.analyses.filter(function(a){return a.user_id===u.id;});
  var up=S.products.filter(function(p){return p.user_id===u.id;});
  var uj=S.projects.filter(function(p){return p.user_id===u.id;});
  var usr=S.serviceRequests.filter(function(s){return s.user_id===u.id;});

  return '<div style="display:flex;align-items:center;gap:12px;margin-bottom:20px"><button class="btn btn-ghost btn-sm" onclick="Adm.set({selectedUser:null})">â† ëª©ë¡</button><h2 style="font-size:18px;font-weight:800;flex:1">'+(u.company_name||u.email)+'</h2>'+UI.pb(u.plan||'free')+UI.badge(u.role,'admin')+'</div>'+

  '<div class="grid-4" style="margin-bottom:16px">'+
    UI.stat('AI ë¶„ì„',ua.length,'','var(--pri)')+
    UI.stat('ë“±ë¡ ì œí’ˆ',up.length,'','var(--acc)')+
    UI.stat('í”„ë¡œì íŠ¸',uj.length,'','var(--ok)')+
    UI.stat('ì„œë¹„ìŠ¤',usr.length,'','var(--purple)')+
  '</div>'+

  '<div class="grid-2" style="margin-bottom:16px">'+
    '<div class="card"><div class="card-h">ğŸ‘¤ ê³„ì • ì •ë³´</div><div class="card-b">'+
      '<div class="detail-row"><div class="detail-label">ì´ë©”ì¼</div><div class="detail-value">'+U.esc(u.email)+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ì´ë¦„</div><div class="detail-value">'+U.esc(u.display_name||'\u2014')+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ì „í™”</div><div class="detail-value">'+U.esc(u.phone||'\u2014')+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ì—­í• </div><div class="detail-value">'+U.esc(u.role)+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">í”Œëœ</div><div class="detail-value">'+UI.pb(u.plan||'free')+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ê°€ì…ì¼</div><div class="detail-value">'+U.fd(u.created_at)+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ë§ˆì§€ë§‰ í™œë™</div><div class="detail-value">'+U.fd(u.updated_at,'rel')+'</div></div>'+
      (u.stripe_customer_id?'<div class="detail-row"><div class="detail-label">Stripe</div><div class="detail-value"><a href="https://dashboard.stripe.com/customers/'+u.stripe_customer_id+'" target="_blank" style="font-size:11px;font-family:JetBrains Mono;color:var(--pri)">'+u.stripe_customer_id+'</a></div></div>':'')+
      '<div style="display:flex;gap:8px;margin-top:14px">'+
        '<button class="btn btn-ghost btn-sm" onclick="Adm.editUserPlan(\''+u.id+'\')">í”Œëœ ë³€ê²½</button>'+
        '<button class="btn btn-ghost btn-sm" onclick="Adm.editUserRole(\''+u.id+'\')">ì—­í•  ë³€ê²½</button>'+
        '<button class="btn btn-'+(u.is_active?'danger':'ok')+' btn-sm" onclick="Adm.toggleUserActive(\''+u.id+'\','+(u.is_active?'false':'true')+')">'+(u.is_active?'ë¹„í™œì„±í™”':'í™œì„±í™”')+'</button>'+
      '</div>'+
    '</div></div>'+

    '<div class="card"><div class="card-h">ğŸ¢ íšŒì‚¬ ì •ë³´</div><div class="card-b">'+(co?
      '<div class="detail-row"><div class="detail-label">í•œê¸€ëª…</div><div class="detail-value">'+U.esc(co.name_ko||'\u2014')+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ì˜ë¬¸ëª…</div><div class="detail-value">'+U.esc(co.name_en||'\u2014')+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ì£¼ì†Œ</div><div class="detail-value">'+U.esc(co.address_ko||'\u2014')+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ëŒ€í‘œ</div><div class="detail-value">'+U.esc(co.ceo_name_ko||'\u2014')+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ì „í™”</div><div class="detail-value">'+U.esc(co.phone||'\u2014')+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ì‚¬ì—…ìë²ˆí˜¸</div><div class="detail-value">'+U.esc(co.biz_number||'\u2014')+'</div></div>'
    :'<div style="text-align:center;padding:20px;color:var(--w40)">íšŒì‚¬ ì •ë³´ ë¯¸ë“±ë¡</div>')+'</div></div>'+
  '</div>'+

  '<div class="card" style="margin-bottom:16px"><div class="card-h"><span>ğŸ”¬ ë¶„ì„ ì´ë ¥</span>'+UI.badge(ua.length+'ê±´','pri')+'</div><div class="card-b" style="padding:0">'+(ua.length?'<table class="tbl"><thead><tr><th>ì œí’ˆ</th><th>ì ìˆ˜</th><th>ìœ í˜•</th><th>ìƒíƒœ</th><th>ë‚ ì§œ</th></tr></thead><tbody>'+ua.map(function(a){
    var r=a.ai_result||{};
    return '<tr onclick="Adm.viewAnalysis(\''+a.id+'\')"><td style="font-weight:600">'+U.tr(a.product_name,30)+'</td><td style="font-family:JetBrains Mono;font-weight:700;color:var(--pri)">'+(r.overall_score||'\u2014')+'</td><td>'+UI.badge(a.analysis_type==='premium'?'í”„ë¦¬ë¯¸ì—„':'ë¬´ë£Œ',a.analysis_type==='premium'?'acc':'ghost')+'</td><td>'+UI.sb(a.status)+'</td><td style="font-size:12px;color:var(--w40)">'+U.fd(a.created_at)+'</td></tr>';
  }).join('')+'</tbody></table>':'<div style="padding:18px">'+UI.empty('ğŸ”¬','ë¶„ì„ ì—†ìŒ','')+'</div>')+'</div></div>'+

  '<div class="card"><div class="card-h"><span>ğŸ’¼ ì„œë¹„ìŠ¤ ìš”ì²­</span>'+UI.badge(usr.length+'ê±´','acc')+'</div><div class="card-b" style="padding:0">'+(usr.length?'<table class="tbl"><thead><tr><th>ì„œë¹„ìŠ¤</th><th>ìƒíƒœ</th><th>ê¸´ê¸‰ë„</th><th>ë‚ ì§œ</th></tr></thead><tbody>'+usr.map(function(sr){
    return '<tr onclick="Adm.viewSR(\''+sr.id+'\')"><td>'+U.si(sr.service_type)+' '+U.sl(sr.service_type)+'</td><td>'+UI.sb(sr.status)+'</td><td>'+UI.badge(sr.priority||'normal',sr.priority==='urgent'?'err':sr.priority==='high'?'acc':'ghost')+'</td><td style="font-size:12px;color:var(--w40)">'+U.fd(sr.created_at)+'</td></tr>';
  }).join('')+'</tbody></table>':'<div style="padding:18px">'+UI.empty('ğŸ’¼','ì„œë¹„ìŠ¤ ì—†ìŒ','')+'</div>')+'</div></div>';
}

/* â”€â”€ Analyses â”€â”€ */
function pgAnalyses(){
  if(S.selectedAnalysis)return pgAnalysisDetail();
  var filtered=filterBySearch(S.analyses,['product_name']);
  if(S.tab!=='all')filtered=filtered.filter(function(a){return a.status===S.tab;});

  var tabs=['all','analyzing','completed','failed'];
  var tabL={all:'ì „ì²´',analyzing:'ë¶„ì„ì¤‘',completed:'ì™„ë£Œ',failed:'ì‹¤íŒ¨'};

  return '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px"><h2 style="font-size:18px;font-weight:800">ğŸ”¬ AI ë¶„ì„ ê´€ë¦¬</h2>'+UI.badge(S.analyses.length+'ê±´','pri')+'</div>'+
  '<div style="display:flex;gap:10px;margin-bottom:16px"><div class="search-box" style="flex:1"><input placeholder="ì œí’ˆëª… ê²€ìƒ‰..." value="'+S.searchFilter+'" oninput="Adm.setSearch(this.value)"></div></div>'+
  '<div class="tab-bar">'+tabs.map(function(t){
    var c=t==='all'?S.analyses.length:S.analyses.filter(function(a){return a.status===t;}).length;
    return '<div class="tab-item '+(S.tab===t?'active':'')+'" onclick="Adm.setTab(\''+t+'\')">'+tabL[t]+' <span style="font-size:10px;color:var(--w20)">'+c+'</span></div>';
  }).join('')+'</div>'+
  '<div class="card"><div class="card-b" style="padding:0"><table class="tbl"><thead><tr><th>ì œí’ˆëª…</th><th>ìœ ì €</th><th>ì ìˆ˜</th><th>ìœ í˜•</th><th>ìƒíƒœ</th><th>ë‚ ì§œ</th></tr></thead><tbody>'+
  (filtered.length?filtered.map(function(a){
    var r=a.ai_result||{};var sc=r.overall_score;var col=sc>=80?'var(--ok)':sc>=60?'var(--acc)':'var(--err)';
    return '<tr onclick="Adm.viewAnalysis(\''+a.id+'\')"><td style="font-weight:600">'+U.tr(a.product_name,35)+'</td><td style="font-size:12px;color:var(--w60)">'+getUserName(a.user_id)+'</td><td style="font-family:JetBrains Mono;font-weight:800;color:'+(sc?col:'var(--w20)')+'">'+( sc||'\u2014')+'</td><td>'+UI.badge(a.analysis_type==='premium'?'í”„ë¦¬ë¯¸ì—„':'ë¬´ë£Œ',a.analysis_type==='premium'?'acc':'ghost')+'</td><td>'+UI.sb(a.status)+'</td><td style="font-size:12px;color:var(--w40)">'+U.fd(a.created_at,'rel')+'</td></tr>';
  }).join(''):'<tr><td colspan="6">'+UI.empty('ğŸ”¬','ê²°ê³¼ ì—†ìŒ','')+'</td></tr>')+
  '</tbody></table></div></div>';
}

function pgAnalysisDetail(){
  var a=S.selectedAnalysis;if(!a)return'';
  var r=a.ai_result||{};var sc=r.overall_score;
  var col=sc>=80?'var(--ok)':sc>=60?'var(--acc)':'var(--err)';
  var bar=function(label,val){var pct=Math.min((val||0),100);var c=val>=80?'var(--ok)':val>=60?'var(--acc)':'var(--err)';return '<div style="margin-bottom:8px"><div style="display:flex;justify-content:space-between;margin-bottom:3px"><span style="font-size:12px;color:var(--w60)">'+label+'</span><span style="font-size:12px;font-weight:700;color:'+c+'">'+( val||0)+'</span></div><div class="chart-bar" style="height:6px"><div class="chart-bar-fill" style="width:'+pct+'%;background:'+c+'"></div></div></div>';};

  return '<div style="display:flex;align-items:center;gap:12px;margin-bottom:20px"><button class="btn btn-ghost btn-sm" onclick="Adm.set({selectedAnalysis:null})">â† ëª©ë¡</button><h2 style="font-size:18px;font-weight:800;flex:1">'+U.esc(a.product_name)+'</h2>'+UI.sb(a.status)+UI.badge(a.analysis_type==='premium'?'í”„ë¦¬ë¯¸ì—„':'ë¬´ë£Œ',a.analysis_type==='premium'?'acc':'ghost')+'</div>'+

  '<div class="grid-2" style="margin-bottom:16px">'+
    '<div class="card"><div class="card-h">ğŸ“Š ì ìˆ˜</div><div class="card-b">'+
      '<div style="display:flex;gap:16px;margin-bottom:16px"><div style="width:100px;height:100px;border-radius:50%;border:5px solid '+(sc?col:'var(--w08)')+';display:flex;align-items:center;justify-content:center;flex-shrink:0"><div style="font-size:30px;font-weight:900;color:'+(sc?col:'var(--w20)')+'">'+( sc||'?')+'</div></div><div style="flex:1">'+
        bar('ì‹œì¥ ì í•©ë„',r.market_fit)+bar('ê°€ê²© ê²½ìŸë ¥',r.price_competitiveness)+bar('ë¸Œëœë“œ íŒŒì›Œ',r.brand_power)+bar('ê²½ìŸ í™˜ê²½',r.competition)+bar('ê·œì œ',r.regulatory)+bar('ë¬¼ë¥˜',r.logistics_score)+
      '</div></div>'+
    '</div></div>'+

    '<div class="card"><div class="card-h">ğŸ“‹ ì •ë³´</div><div class="card-b">'+
      '<div class="detail-row"><div class="detail-label">ìœ ì €</div><div class="detail-value" style="cursor:pointer;color:var(--pri)" onclick="Adm.viewUser(\''+a.user_id+'\')">'+getUserName(a.user_id)+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">HS Code</div><div class="detail-value" style="font-family:JetBrains Mono">'+(r.hs_code||'\u2014')+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ì˜ˆìƒ FOB</div><div class="detail-value">'+(r.estimated_fob||'\u2014')+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ì¶”ì²œ ì‹œì¥</div><div class="detail-value">'+((r.recommended_markets||[]).map(function(m){return U.cl(m);}).join(' ')||'\u2014')+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">í•„ìš” ì¸ì¦</div><div class="detail-value">'+((r.required_certs||[]).map(function(c){return '<span class="badge badge-err" style="margin:1px">'+c+'</span>';}).join(' ')||'\u2014')+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ìƒì„±ì¼</div><div class="detail-value">'+U.fd(a.created_at)+'</div></div>'+
      '<div style="display:flex;gap:8px;margin-top:14px">'+
        '<button class="btn btn-ok btn-sm" onclick="Adm.updateAStatus(\''+a.id+'\',\'completed\')">ì™„ë£Œ ì²˜ë¦¬</button>'+
        '<button class="btn btn-danger btn-sm" onclick="Adm.updateAStatus(\''+a.id+'\',\'failed\')">ì‹¤íŒ¨ ì²˜ë¦¬</button>'+
        '<button class="btn btn-ghost btn-sm" onclick="Adm.deleteAnalysis(\''+a.id+'\')">ì‚­ì œ</button>'+
      '</div>'+
    '</div></div>'+
  '</div>'+

  (r.summary?'<div class="card" style="margin-bottom:16px"><div class="card-h">ğŸ“ ìš”ì•½</div><div class="card-b"><p style="font-size:13px;color:var(--w70);line-height:1.8">'+r.summary+'</p>'+(r.executive_summary?'<p style="font-size:13px;color:var(--w70);line-height:1.8;margin-top:10px;padding-top:10px;border-top:1px solid var(--w08)">'+r.executive_summary+'</p>':'')+'</div></div>':'')+

  (r.market_analysis&&r.market_analysis.length?'<div class="card" style="margin-bottom:16px"><div class="card-h">ğŸŒ ì‹œì¥ ë¶„ì„</div><div class="card-b" style="padding:0"><table class="tbl"><thead><tr><th>ì‹œì¥</th><th>ê·œëª¨</th><th>ì„±ì¥ë¥ </th><th>ì§„ì…ì¥ë²½</th></tr></thead><tbody>'+r.market_analysis.map(function(m){return '<tr><td style="font-weight:700">'+m.name+'</td><td style="font-family:JetBrains Mono">'+m.size+'</td><td style="color:var(--ok)">'+m.grow+'</td><td>'+m.entry+'</td></tr>';}).join('')+'</tbody></table></div></div>':'');
}

/* â”€â”€ Service Requests â”€â”€ */
function pgServiceReq(){
  if(S.selectedSR)return pgSRDetail();
  var filtered=filterBySearch(S.serviceRequests,['title','service_type']);
  if(S.tab!=='all')filtered=filtered.filter(function(s){return s.status===S.tab;});

  var tabs=['all','pending','accepted','processing','completed','cancelled'];
  var tabL={all:'ì „ì²´',pending:'ì ‘ìˆ˜',accepted:'ë°°ì •',processing:'ì²˜ë¦¬ì¤‘',completed:'ì™„ë£Œ',cancelled:'ì·¨ì†Œ'};

  /* SLA ê³„ì‚° */
  var slaHours={urgent:4,high:24,normal:72,low:168};
  function getSLA(sr){
    var h=slaHours[sr.priority||'normal']||72;
    var created=new Date(sr.created_at);var now=new Date();
    var elapsed=Math.floor((now-created)/(1000*60*60));
    var remain=h-elapsed;
    return {total:h,elapsed:elapsed,remain:remain,pct:Math.min(Math.round(elapsed/h*100),100),overdue:remain<0};
  }

  /* íŒŒì´í”„ë¼ì¸ ìš”ì•½ */
  var pipeline='<div style="display:flex;gap:6px;margin-bottom:16px">'+
    [{s:'pending',i:'ğŸ“¥',c:'var(--w40)'},{s:'accepted',i:'ğŸ‘¤',c:'var(--pri)'},{s:'processing',i:'âš™ï¸',c:'var(--acc)'},{s:'completed',i:'âœ…',c:'var(--ok)'}].map(function(st){
    var cnt=S.serviceRequests.filter(function(x){return x.status===st.s;}).length;
    return '<div style="flex:1;padding:12px;border-radius:10px;background:var(--w08);text-align:center;border-bottom:3px solid '+(cnt?st.c:'transparent')+'">'+
    '<div style="font-size:16px">'+st.i+'</div><div style="font-size:10px;color:var(--w40)">'+tabL[st.s]+'</div>'+
    '<div style="font-size:20px;font-weight:800;color:'+(cnt?st.c:'var(--w20)')+'">'+cnt+'</div></div>';
  }).join('')+'</div>';

  /* ê¸´ê¸‰ SLA ê²½ê³  */
  var urgentSRs=S.serviceRequests.filter(function(sr){return sr.status!=='completed'&&sr.status!=='cancelled'&&getSLA(sr).overdue;});
  var urgentAlert=urgentSRs.length?'<div style="padding:10px 14px;border-radius:10px;background:rgba(255,82,82,.08);border:1px solid rgba(255,82,82,.2);margin-bottom:12px;font-size:12px;color:var(--err)">âš ï¸ SLA ì´ˆê³¼ '+urgentSRs.length+'ê±´ â€” ì¦‰ì‹œ ì²˜ë¦¬ í•„ìš”</div>':'';

  return '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px"><h2 style="font-size:18px;font-weight:800">ğŸ’¼ ì„œë¹„ìŠ¤ ìš”ì²­</h2>'+UI.badge(S.serviceRequests.length+'ê±´','acc')+'</div>'+
  pipeline+urgentAlert+
  '<div style="display:flex;gap:10px;margin-bottom:16px"><div class="search-box" style="flex:1"><input placeholder="ì„œë¹„ìŠ¤ ê²€ìƒ‰..." value="'+S.searchFilter+'" oninput="Adm.setSearch(this.value)"></div></div>'+
  '<div class="tab-bar">'+tabs.map(function(t){
    var c=t==='all'?S.serviceRequests.length:S.serviceRequests.filter(function(s){return s.status===t;}).length;
    return '<div class="tab-item '+(S.tab===t?'active':'')+'" onclick="Adm.setTab(\''+t+'\')">'+tabL[t]+' <span style="font-size:10px;color:var(--w20)">'+c+'</span></div>';
  }).join('')+'</div>'+
  '<div class="card"><div class="card-b" style="padding:0"><table class="tbl"><thead><tr><th>ì„œë¹„ìŠ¤</th><th>ìœ ì €</th><th>ìƒíƒœ</th><th>ê¸´ê¸‰ë„</th><th>SLA</th><th>ë‹´ë‹¹</th><th>ê¸ˆì•¡</th></tr></thead><tbody>'+
  (filtered.length?filtered.map(function(sr){
    var sla=getSLA(sr);
    var slaCol=sla.overdue?'var(--err)':sla.remain<12?'var(--acc)':'var(--ok)';
    var isDone=sr.status==='completed'||sr.status==='cancelled';
    return '<tr onclick="Adm.viewSR(\''+sr.id+'\')" style="'+(sla.overdue&&!isDone?'background:rgba(255,82,82,.04)':'')+'"><td>'+U.si(sr.service_type)+' '+U.sl(sr.service_type)+'</td><td style="font-size:12px">'+getUserName(sr.user_id)+'</td><td>'+UI.sb(sr.status)+'</td><td>'+UI.badge(sr.priority||'normal',sr.priority==='urgent'?'err':sr.priority==='high'?'acc':'ghost')+'</td>'+
    '<td style="font-size:11px;color:'+(isDone?'var(--w20)':slaCol)+'">'+(isDone?'â€”':(sla.overdue?'ì´ˆê³¼ '+Math.abs(sla.remain)+'h':sla.remain+'h'))+'</td>'+
    '<td style="font-size:11px;color:var(--w40)">'+(sr.assigned_to?getUserName(sr.assigned_to):'ë¯¸ë°°ì •')+'</td>'+
    '<td style="font-family:JetBrains Mono;font-size:12px">'+(sr.price?U.krw(sr.price):'\u2014')+'</td></tr>';
  }).join(''):'<tr><td colspan="7">'+UI.empty('ğŸ’¼','ê²°ê³¼ ì—†ìŒ','')+'</td></tr>')+
  '</tbody></table></div></div>';
}

function pgSRDetail(){
  var sr=S.selectedSR;if(!sr)return'';
  var details=sr.details||{};

  /* SLA ê³„ì‚° */
  var slaHours={urgent:4,high:24,normal:72,low:168};
  var slaH=slaHours[sr.priority||'normal']||72;
  var elapsed=Math.floor((new Date()-new Date(sr.created_at))/(1000*60*60));
  var remain=slaH-elapsed;var slaPct=Math.min(Math.round(elapsed/slaH*100),100);
  var isDone=sr.status==='completed'||sr.status==='cancelled';
  var slaCol=isDone?'var(--ok)':remain<0?'var(--err)':remain<12?'var(--acc)':'var(--pri)';

  /* SLA ë°” */
  var slaBar='<div style="padding:12px;border-radius:10px;background:'+(remain<0&&!isDone?'rgba(255,82,82,.06)':'var(--w08)')+';margin-bottom:16px;border:1px solid '+(remain<0&&!isDone?'rgba(255,82,82,.15)':'var(--bd)')+'">'+
    '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">'+
    '<span style="font-size:11px;font-weight:700">SLA '+(isDone?'ì™„ë£Œ':remain<0?'âš ï¸ ì´ˆê³¼ '+Math.abs(remain)+'ì‹œê°„':'ì”ì—¬ '+remain+'ì‹œê°„')+'</span>'+
    '<span style="font-size:11px;color:var(--w40)">ëª©í‘œ: '+slaH+'h / ê²½ê³¼: '+elapsed+'h</span></div>'+
    '<div style="height:6px;border-radius:3px;background:var(--w08)"><div style="height:100%;border-radius:3px;background:'+slaCol+';width:'+slaPct+'%;transition:width .3s"></div></div></div>';

  /* ë‹´ë‹¹ì ì„ íƒ ì˜µì…˜ */
  var adminUsers=S.users.filter(function(u){return u.role==='admin';});
  var assignOpts=[{value:'',label:'-- ë¯¸ë°°ì • --'}].concat(adminUsers.map(function(u){return {value:u.id,label:U.esc(u.display_name||u.email)};}));

  /* ì›Œí¬í”Œë¡œìš° ë‹¨ê³„ */
  var stages=['pending','accepted','processing','review','completed'];
  var stageL={pending:'ì ‘ìˆ˜',accepted:'ë°°ì •',processing:'ì²˜ë¦¬ì¤‘',review:'ê²€í† ',completed:'ì™„ë£Œ'};
  var curIdx=stages.indexOf(sr.status);if(curIdx<0)curIdx=0;
  var stageBar='<div style="display:flex;gap:2px;margin-bottom:16px">'+stages.map(function(st,i){
    var active=i<=curIdx;
    return '<div style="flex:1;text-align:center;padding:6px;border-radius:6px;background:'+(active?'rgba(255,107,107,.1)':'var(--w08)')+';cursor:pointer" onclick="Adm.quickSR(\''+sr.id+'\',\''+st+'\')">'+
    '<div style="font-size:10px;font-weight:'+(active?'700':'400')+';color:'+(active?'var(--admin)':'var(--w20)')+'">'+stageL[st]+'</div></div>';
  }).join('')+'</div>';

  return '<div style="display:flex;align-items:center;gap:12px;margin-bottom:20px"><button class="btn btn-ghost btn-sm" onclick="Adm.set({selectedSR:null})">â† ëª©ë¡</button><h2 style="font-size:18px;font-weight:800;flex:1">'+U.si(sr.service_type)+' '+U.sl(sr.service_type)+'</h2>'+UI.sb(sr.status)+'</div>'+

  slaBar+stageBar+

  '<div class="grid-2" style="margin-bottom:16px">'+
    '<div class="card"><div class="card-h">ğŸ“‹ ìš”ì²­ ì •ë³´</div><div class="card-b">'+
      '<div class="detail-row"><div class="detail-label">ì„œë¹„ìŠ¤</div><div class="detail-value">'+U.sl(sr.service_type)+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ìœ ì €</div><div class="detail-value" style="cursor:pointer;color:var(--pri)" onclick="Adm.viewUser(\''+sr.user_id+'\')">'+getUserName(sr.user_id)+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ê¸´ê¸‰ë„</div><div class="detail-value">'+UI.badge(sr.priority||'normal',sr.priority==='urgent'?'err':sr.priority==='high'?'acc':'ghost')+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ë‹´ë‹¹ì</div><div class="detail-value">'+(sr.assigned_to?getUserName(sr.assigned_to):'<span style="color:var(--err)">ë¯¸ë°°ì •</span>')+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ê¸ˆì•¡</div><div class="detail-value">'+(sr.price?U.krw(sr.price):'ë¯¸ì •')+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ì ‘ìˆ˜</div><div class="detail-value">'+U.fd(sr.created_at)+'</div></div>'+
      (sr.started_at?'<div class="detail-row"><div class="detail-label">ì‹œì‘</div><div class="detail-value">'+U.fd(sr.started_at)+'</div></div>':'')+
      (sr.completed_at?'<div class="detail-row"><div class="detail-label">ì™„ë£Œ</div><div class="detail-value">'+U.fd(sr.completed_at)+'</div></div>':'')+
      (details.text?'<div style="margin-top:12px;padding:12px;border-radius:8px;background:var(--w08)"><div style="font-size:11px;color:var(--w40);margin-bottom:6px">ìš”ì²­ ë‚´ìš©</div><div style="font-size:13px;color:var(--w70);white-space:pre-wrap">'+U.esc(details.text)+'</div></div>':'')+
    '</div></div>'+

    '<div class="card"><div class="card-h">âš¡ ì²˜ë¦¬</div><div class="card-b">'+
      '<div class="grid-2" style="margin-bottom:12px">'+
        UI.sel('sr_status','ìƒíƒœ',[{value:'pending',label:'ì ‘ìˆ˜'},{value:'accepted',label:'ë°°ì •'},{value:'processing',label:'ì²˜ë¦¬ì¤‘'},{value:'review',label:'ê²€í† '},{value:'completed',label:'ì™„ë£Œ'},{value:'cancelled',label:'ì·¨ì†Œ'}],sr.status)+
        UI.sel('sr_assigned','ë‹´ë‹¹ì ë°°ì •',assignOpts,sr.assigned_to||'')+
      '</div>'+
      '<div class="grid-2" style="margin-bottom:12px">'+
        UI.inp('sr_price','ê¸ˆì•¡ (ì›)',{type:'number',value:sr.price||'',placeholder:'300000'})+
        UI.sel('sr_priority','ê¸´ê¸‰ë„',[{value:'low',label:'ë‚®ìŒ'},{value:'normal',label:'ì¼ë°˜'},{value:'high',label:'ë†’ìŒ'},{value:'urgent',label:'ê¸´ê¸‰'}],sr.priority||'normal')+
      '</div>'+
      UI.ta('sr_note','ê´€ë¦¬ì ë©”ëª¨',{placeholder:'ë‚´ë¶€ ë©”ëª¨...',value:(sr.admin_notes||sr.admin_note||''),rows:3})+
      '<div style="display:flex;gap:8px;margin-top:14px;flex-wrap:wrap">'+
        '<button class="btn btn-admin" onclick="Adm.updateSR(\''+sr.id+'\')">ì €ì¥</button>'+
        '<button class="btn btn-ok btn-sm" onclick="Adm.quickSR(\''+sr.id+'\',\'completed\')">ì™„ë£Œ</button>'+
        '<button class="btn btn-ghost btn-sm" onclick="Adm.notifySR(\''+sr.id+'\')">ğŸ“¢ í…”ë ˆê·¸ë¨ ì•Œë¦¼</button>'+
        '<button class="btn btn-danger btn-sm" onclick="Adm.deleteSR(\''+sr.id+'\')">ì‚­ì œ</button>'+
      '</div>'+
    '</div></div>'+
  '</div>';
}

/* â”€â”€ Products â”€â”€ */
function pgProducts(){
  var filtered=filterBySearch(S.products,['name_ko','name_en','category']);

  return '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px"><h2 style="font-size:18px;font-weight:800">ğŸ“¦ ì œí’ˆ ê´€ë¦¬</h2>'+UI.badge(S.products.length+'ê±´','acc')+'</div>'+
  '<div style="display:flex;gap:10px;margin-bottom:16px"><div class="search-box" style="flex:1"><input placeholder="ì œí’ˆëª…, ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰..." value="'+S.searchFilter+'" oninput="Adm.setSearch(this.value)"></div></div>'+
  '<div class="card"><div class="card-b" style="padding:0"><table class="tbl"><thead><tr><th>ì œí’ˆ</th><th>ìœ ì €</th><th>ì¹´í…Œê³ ë¦¬</th><th>FOB</th><th>MOQ</th><th>ìƒíƒœ</th><th>ë‚ ì§œ</th></tr></thead><tbody>'+
  (filtered.length?filtered.map(function(p){
    return '<tr><td><div style="display:flex;align-items:center;gap:10px">'+(p.images&&p.images[0]?'<img src="'+p.images[0]+'" style="width:36px;height:36px;border-radius:6px;object-fit:cover">':'<div style="width:36px;height:36px;border-radius:6px;background:var(--w08);display:flex;align-items:center;justify-content:center;font-size:16px">ğŸ“¦</div>')+'<div><div style="font-weight:600">'+U.tr(p.name_ko,25)+'</div>'+(p.name_en?'<div style="font-size:11px;color:var(--w40)">'+U.tr(p.name_en,30)+'</div>':'')+'</div></div></td><td style="font-size:12px">'+getUserName(p.user_id)+'</td><td style="font-size:12px">'+(p.category||'\u2014')+'</td><td style="font-family:JetBrains Mono;font-size:12px">'+(p.fob_price?U.usd(p.fob_price):'\u2014')+'</td><td style="font-size:12px">'+(p.moq||'\u2014')+'</td><td>'+UI.sb(p.status||'draft')+'</td><td style="font-size:12px;color:var(--w40)">'+U.fd(p.created_at,'rel')+'</td></tr>';
  }).join(''):'<tr><td colspan="7">'+UI.empty('ğŸ“¦','ì œí’ˆ ì—†ìŒ','')+'</td></tr>')+
  '</tbody></table></div></div>';
}

/* â”€â”€ Projects â”€â”€ */
function pgProjects(){
  var filtered=filterBySearch(S.projects,['name']);
  var stages=['planning','certification','buyer_search','negotiation','shipping','completed'];
  var stL={planning:'ê¸°íš',certification:'ì¸ì¦',buyer_search:'ë§¤ì¹­',negotiation:'í˜‘ìƒ',shipping:'ì„ ì ',completed:'ì™„ë£Œ'};

  return '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px"><h2 style="font-size:18px;font-weight:800">ğŸš€ í”„ë¡œì íŠ¸ ê´€ë¦¬</h2>'+UI.badge(S.projects.length+'ê±´','ok')+'</div>'+
  '<div style="display:flex;gap:10px;margin-bottom:16px"><div class="search-box" style="flex:1"><input placeholder="í”„ë¡œì íŠ¸ëª… ê²€ìƒ‰..." value="'+S.searchFilter+'" oninput="Adm.setSearch(this.value)"></div></div>'+

  '<div class="grid-3" style="margin-bottom:16px">'+
    stages.slice(0,3).map(function(s){
      var c=S.projects.filter(function(p){return p.status===s;}).length;
      return UI.stat(stL[s],c,'','var(--pri)');
    }).join('')+
  '</div>'+
  '<div class="grid-3" style="margin-bottom:16px">'+
    stages.slice(3).map(function(s){
      var c=S.projects.filter(function(p){return p.status===s;}).length;
      return UI.stat(stL[s],c,'',s==='completed'?'var(--ok)':'var(--acc)');
    }).join('')+
  '</div>'+

  '<div class="card"><div class="card-b" style="padding:0"><table class="tbl"><thead><tr><th>í”„ë¡œì íŠ¸</th><th>ìœ ì €</th><th>ë‹¨ê³„</th><th>íƒ€ê²Ÿ</th><th>ë‚ ì§œ</th></tr></thead><tbody>'+
  (filtered.length?filtered.map(function(p){
    var ci=stages.indexOf(p.status);
    return '<tr><td style="font-weight:600">'+U.tr(p.name,35)+'</td><td style="font-size:12px">'+getUserName(p.user_id)+'</td><td><div style="display:flex;gap:2px;align-items:center">'+stages.map(function(s,i){return '<div style="width:12px;height:4px;border-radius:2px;background:'+(i<=ci?'var(--ok)':'var(--w08)')+'"></div>';}).join('')+'<span style="margin-left:6px;font-size:11px;color:var(--w60)">'+stL[p.status]+'</span></div></td><td style="font-size:12px">'+((p.target_countries||[]).map(function(c){return U.cl(c);}).join(' ')||'\u2014')+'</td><td style="font-size:12px;color:var(--w40)">'+U.fd(p.created_at,'rel')+'</td></tr>';
  }).join(''):'<tr><td colspan="5">'+UI.empty('ğŸš€','í”„ë¡œì íŠ¸ ì—†ìŒ','')+'</td></tr>')+
  '</tbody></table></div></div>';
}

/* â”€â”€ Documents â”€â”€ */
function pgDocuments(){
  var filtered=filterBySearch(S.documents,['doc_type','doc_number','buyer_name']);
  var docN={pi:'PI',ci:'CI',pl:'PL',co:'CO',catalog:'Catalog'};

  return '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px"><h2 style="font-size:18px;font-weight:800">ğŸ“„ ì„œë¥˜ ê´€ë¦¬</h2>'+UI.badge(S.documents.length+'ê±´','purple')+'</div>'+
  '<div style="display:flex;gap:10px;margin-bottom:16px"><div class="search-box" style="flex:1"><input placeholder="ì„œë¥˜ë²ˆí˜¸, ë°”ì´ì–´ ê²€ìƒ‰..." value="'+S.searchFilter+'" oninput="Adm.setSearch(this.value)"></div></div>'+
  '<div class="card"><div class="card-b" style="padding:0"><table class="tbl"><thead><tr><th>ìœ í˜•</th><th>ë²ˆí˜¸</th><th>ë°”ì´ì–´</th><th>ìœ ì €</th><th>ìƒíƒœ</th><th>ë‚ ì§œ</th></tr></thead><tbody>'+
  (filtered.length?filtered.map(function(d){
    return '<tr><td>'+UI.badge(docN[d.doc_type]||d.doc_type,'pri')+'</td><td style="font-family:JetBrains Mono;font-size:12px">'+(d.doc_number||'\u2014')+'</td><td style="font-weight:600">'+(d.buyer_name||'\u2014')+'</td><td style="font-size:12px">'+getUserName(d.user_id)+'</td><td>'+UI.sb(d.status||'draft')+'</td><td style="font-size:12px;color:var(--w40)">'+U.fd(d.created_at)+'</td></tr>';
  }).join(''):'<tr><td colspan="6">'+UI.empty('ğŸ“„','ì„œë¥˜ ì—†ìŒ','')+'</td></tr>')+
  '</tbody></table></div></div>';
}

/* â”€â”€ Analytics â”€â”€ */
function pgAnalytics(){
  var tabs=['users','pages','funnel'];
  var tabL={users:'ìœ ì € ë¶„ì„',pages:'í˜ì´ì§€ë·°',funnel:'ì „í™˜ í¼ë„'};
  var tabBar='<div class="tab-bar">'+tabs.map(function(t){
    return '<div class="tab-item '+(S.analyticsTab===t?'active':'')+'" onclick="Adm.setAnalyticsTab(\''+t+'\')">'+tabL[t]+'</div>';
  }).join('')+'</div>';
  if(S.analyticsTab==='pages') return pgAnalyticsPages(tabBar);
  if(S.analyticsTab==='funnel') return pgAnalyticsFunnel(tabBar);
  return pgAnalyticsUsers(tabBar);
}
function pgAnalyticsUsers(tabBar){
  var today=new Date();
  var days=[];for(var i=29;i>=0;i--){var d=new Date(today-i*864e5);days.push(d.toISOString().slice(0,10));}
  var signupByDay={};days.forEach(function(d){signupByDay[d]=0;});
  S.users.forEach(function(u){var d=(u.created_at||'').slice(0,10);if(signupByDay[d]!==undefined)signupByDay[d]++;});
  var maxSignup=Math.max.apply(null,days.map(function(d){return signupByDay[d];}))||1;
  var roles=groupBy(S.users,'role');var roleLabels={client:'ì œì¡°ì‚¬',buyer:'ë°”ì´ì–´',admin:'ê´€ë¦¬ì'};
  var clients=S.users.filter(function(u){return u.role==='client';});var plans=groupBy(clients,'plan');
  var countries={};S.buyers.forEach(function(b){if(b.country)countries[b.country]=(countries[b.country]||0)+1;});
  return '<div style="margin-bottom:20px"><h2 style="font-size:18px;font-weight:800">ğŸ“ˆ ë¶„ì„ / í†µê³„</h2></div>'+tabBar+
  '<div class="card" style="margin-bottom:16px"><div class="card-h">ê°€ì… ì¶”ì´ (30ì¼)</div><div class="card-b">'+
    '<div style="display:flex;align-items:flex-end;gap:2px;height:100px">'+days.map(function(d){var v=signupByDay[d];var h=Math.max(Math.round(v/maxSignup*80),2);return '<div title="'+d+': '+v+'ëª…" style="flex:1;height:'+h+'px;background:var(--pri);border-radius:2px 2px 0 0;opacity:'+(v?1:0.2)+'"></div>';}).join('')+'</div>'+
    '<div style="display:flex;justify-content:space-between;margin-top:6px;font-size:10px;color:var(--w20)"><span>'+days[0]+'</span><span>'+days[days.length-1]+'</span></div>'+
  '</div></div>'+
  '<div class="grid-2" style="margin-bottom:16px">'+
    '<div class="card"><div class="card-h">ì—­í•  ë¶„í¬</div><div class="card-b">'+Object.keys(roleLabels).map(function(k){return hBar(roleLabels[k],(roles[k]||[]).length,S.users.length,'var(--pri)');}).join('')+'</div></div>'+
    '<div class="card"><div class="card-h">í”Œëœ ë¶„í¬ (ì œì¡°ì‚¬)</div><div class="card-b">'+['free','starter','pro','alibaba'].map(function(k){var cnt=0;clients.forEach(function(u){if(k==='starter'&&(u.plan==='starter'||u.plan==='basic'))cnt++;else if(u.plan===k)cnt++;});var r=U.pl(k);return hBar(r[0],cnt,clients.length||1,r[1]);}).join('')+'</div></div>'+
  '</div>'+
  '<div class="grid-2">'+
    '<div class="card"><div class="card-h">êµ­ê°€ë³„ ë°”ì´ì–´</div><div class="card-b">'+(function(){var sorted=Object.entries(countries).sort(function(a,b){return b[1]-a[1];});var mx=sorted.length?sorted[0][1]:1;return sorted.map(function(e){return hBar(flag(e[0])+' '+e[0],e[1],mx,'var(--pri)');}).join('');})()+
    '</div></div>'+
    '<div class="card"><div class="card-h">í™œë™ ìˆ˜ì¤€</div><div class="card-b">'+(function(){var t7=new Date(today-7*864e5);var t30=new Date(today-30*864e5);var a7=S.users.filter(function(u){return new Date(u.updated_at)>=t7;}).length;var a30=S.users.filter(function(u){return new Date(u.updated_at)>=t30;}).length;return hBar('7ì¼ ë‚´ í™œë™',a7,S.users.length,'var(--ok)')+hBar('30ì¼ ë‚´ í™œë™',a30,S.users.length,'var(--acc)')+hBar('ë¹„í™œì„± (30ì¼+)',S.users.length-a30,S.users.length,'var(--err)');})()+
    '</div></div>'+
  '</div>';
}
function pgAnalyticsPages(tabBar){
  var pvByPage=groupBy(S.pageViews,'page');
  var sorted=Object.entries(pvByPage).map(function(e){return{page:e[0],count:e[1].length};}).sort(function(a,b){return b.count-a.count;});
  var maxPV=sorted.length?sorted[0].count:1;
  var pvByRole=groupBy(S.pageViews,'role');var roleLabels={client:'ì œì¡°ì‚¬',buyer:'ë°”ì´ì–´',admin:'ê´€ë¦¬ì'};
  var pvByPortal=groupBy(S.pageViews,'portal');
  var today=new Date();var days=[];for(var i=29;i>=0;i--){var d=new Date(today-i*864e5);days.push(d.toISOString().slice(0,10));}
  var pvByDay={};days.forEach(function(d){pvByDay[d]=0;});
  S.pageViews.forEach(function(pv){var d=(pv.created_at||'').slice(0,10);if(pvByDay[d]!==undefined)pvByDay[d]++;});
  var maxDayPV=Math.max.apply(null,days.map(function(d){return pvByDay[d];}))||1;
  return '<div style="margin-bottom:20px"><h2 style="font-size:18px;font-weight:800">ğŸ“ˆ ë¶„ì„ / í†µê³„</h2></div>'+tabBar+
  '<div class="grid-4" style="margin-bottom:16px">'+UI.stat('ì´ í˜ì´ì§€ë·°',S.pageViews.length,'','var(--pri)')+UI.stat('ê³ ìœ  í˜ì´ì§€',sorted.length,'','var(--acc)')+UI.stat('ì œì¡°ì‚¬ ë·°',(pvByRole['client']||[]).length,'','var(--ok)')+UI.stat('ë°”ì´ì–´ ë·°',(pvByRole['buyer']||[]).length,'','var(--purple)')+'</div>'+
  '<div class="card" style="margin-bottom:16px"><div class="card-h">í˜ì´ì§€ë·° ì¶”ì´ (30ì¼)</div><div class="card-b">'+
    '<div style="display:flex;align-items:flex-end;gap:2px;height:100px">'+days.map(function(d){var v=pvByDay[d];var h=Math.max(Math.round(v/maxDayPV*80),2);return '<div title="'+d+': '+v+'" style="flex:1;height:'+h+'px;background:var(--acc);border-radius:2px 2px 0 0;opacity:'+(v?1:0.2)+'"></div>';}).join('')+'</div>'+
    '<div style="display:flex;justify-content:space-between;margin-top:6px;font-size:10px;color:var(--w20)"><span>'+days[0]+'</span><span>'+days[days.length-1]+'</span></div>'+
  '</div></div>'+
  '<div class="grid-2">'+
    '<div class="card"><div class="card-h">ì¸ê¸° í˜ì´ì§€ TOP</div><div class="card-b">'+sorted.slice(0,10).map(function(p){return hBar(p.page,p.count,maxPV,'var(--pri)');}).join('')+'</div></div>'+
    '<div class="card"><div class="card-h">í¬í„¸ë³„ / ì—­í• ë³„</div><div class="card-b"><div style="font-size:12px;font-weight:600;color:var(--w40);margin-bottom:8px">í¬í„¸</div>'+Object.entries(pvByPortal).map(function(e){return hBar(e[0]||'unknown',e[1].length,S.pageViews.length||1,'var(--acc)');}).join('')+'<div style="font-size:12px;font-weight:600;color:var(--w40);margin:12px 0 8px">ì—­í• </div>'+Object.keys(roleLabels).map(function(k){return hBar(roleLabels[k],(pvByRole[k]||[]).length,S.pageViews.length||1,'var(--pri)');}).join('')+'</div></div>'+
  '</div>';
}
function pgAnalyticsFunnel(tabBar){
  var clients=S.users.filter(function(u){return u.role==='client';});
  var wA=new Set();S.analyses.forEach(function(a){wA.add(a.user_id);});
  var wP=new Set();S.products.forEach(function(p){wP.add(p.user_id);});
  var wM=new Set();S.matchings.forEach(function(m){wM.add(m.seller_id);});
  var wO=new Set();S.orders.forEach(function(o){wO.add(o.seller_id);});
  var wC=new Set();S.matchings.filter(function(m){return m.status==='completed';}).forEach(function(m){wC.add(m.seller_id);});
  var funnel=[{label:'ê°€ì…',count:clients.length,color:'var(--w60)'},{label:'ë¶„ì„ ì™„ë£Œ',count:wA.size,color:'var(--pri)'},{label:'ì œí’ˆ ë“±ë¡',count:wP.size,color:'var(--acc)'},{label:'ë°”ì´ì–´ ë§¤ì¹­',count:wM.size,color:'var(--warn)'},{label:'ì£¼ë¬¸ ë°œìƒ',count:wO.size,color:'var(--purple)'},{label:'ê±°ë˜ ì™„ë£Œ',count:wC.size,color:'var(--ok)'}];
  var buyerUsers=S.users.filter(function(u){return u.role==='buyer';});
  var bR=new Set();S.buyerRequests.forEach(function(r){bR.add(r.buyer_id);});
  var bM=new Set();S.matchings.forEach(function(m){bM.add(m.buyer_id);});
  var bO=new Set();S.orders.forEach(function(o){bO.add(o.buyer_id);});
  var buyerFunnel=[{label:'ê°€ì…',count:buyerUsers.length,color:'var(--w60)'},{label:'ë°”ì´ì–´ ë“±ë¡',count:S.buyers.length,color:'var(--pri)'},{label:'ë¬¸ì˜ ì‘ì„±',count:bR.size,color:'var(--acc)'},{label:'ë§¤ì¹­ ì§„í–‰',count:bM.size,color:'var(--warn)'},{label:'ì£¼ë¬¸',count:bO.size,color:'var(--ok)'}];
  function funnelBar(f,base){var pct=base?Math.round(f.count/base*100):0;var w=Math.max(pct,8);return '<div style="margin-bottom:10px"><div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="font-size:12px;color:var(--w60)">'+f.label+'</span><span style="font-size:12px;font-weight:700;font-family:JetBrains Mono;color:'+f.color+'">'+f.count+' ('+pct+'%)</span></div><div style="height:28px;background:'+f.color+'15;border-radius:6px;width:'+w+'%;display:flex;align-items:center;padding:0 10px"><div style="height:100%;background:'+f.color+';border-radius:6px;width:100%;opacity:.7"></div></div></div>';}
  return '<div style="margin-bottom:20px"><h2 style="font-size:18px;font-weight:800">ğŸ“ˆ ë¶„ì„ / í†µê³„</h2></div>'+tabBar+
  '<div class="grid-2">'+
    '<div class="card"><div class="card-h">ì œì¡°ì‚¬ í¼ë„</div><div class="card-b">'+funnel.map(function(f){return funnelBar(f,clients.length);}).join('')+'</div></div>'+
    '<div class="card"><div class="card-h">ë°”ì´ì–´ í¼ë„</div><div class="card-b">'+buyerFunnel.map(function(f){return funnelBar(f,buyerUsers.length||1);}).join('')+'</div></div>'+
  '</div>';
}

/* â”€â”€ Sellers â”€â”€ */
function pgSellers(){
  if(S.selectedSeller) return pgSellerDetail();
  var clients=S.users.filter(function(u){return u.role==='client';});
  var totalRev=sumBy(S.orders.filter(function(o){return o.payment_status==='paid'||o.status==='completed';}),'total_amount');
  var paidClients=clients.filter(function(u){return u.plan&&u.plan!=='free';}).length;
  var filtered=filterBySearch(clients,['email','company_name','display_name']);
  return '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px"><h2 style="font-size:18px;font-weight:800">ğŸ­ ì œì¡°ì‚¬ ê´€ë¦¬</h2>'+UI.badge(clients.length+'ëª…','pri')+'</div>'+
  '<div class="grid-4" style="margin-bottom:16px">'+UI.stat('ì œì¡°ì‚¬',clients.length,'ìœ ë£Œ '+paidClients+'ëª…','var(--pri)')+UI.stat('ë“±ë¡ ì œí’ˆ',S.products.length,'','var(--acc)')+UI.stat('ì§„í–‰ ë”œ',S.matchings.length,'','var(--ok)')+UI.stat('ëˆ„ì  ë§¤ì¶œ',U.usd(totalRev),'','var(--admin)')+'</div>'+
  '<div style="display:flex;gap:10px;margin-bottom:16px"><div class="search-box" style="flex:1"><input placeholder="íšŒì‚¬ëª…, ì´ë©”ì¼ ê²€ìƒ‰..." value="'+S.searchFilter+'" oninput="Adm.setSearch(this.value)"></div></div>'+
  '<div class="card"><div class="card-b" style="padding:0"><table class="tbl"><thead><tr><th>íšŒì‚¬</th><th>ì œí’ˆ</th><th>ë”œ</th><th>ë§¤ì¶œ</th><th>í”Œëœ</th><th>ê°€ì…ì¼</th></tr></thead><tbody>'+
  (filtered.length?filtered.map(function(u){
    var prods=S.products.filter(function(p){return p.user_id===u.id;}).length;
    var deals=S.matchings.filter(function(m){return m.seller_id===u.id;}).length;
    var rev=sumBy(S.orders.filter(function(o){return o.seller_id===u.id&&(o.payment_status==='paid'||o.status==='completed');}),'total_amount');
    return '<tr onclick="Adm.viewSeller(\''+u.id+'\')"><td><div style="display:flex;align-items:center;gap:10px"><div style="width:32px;height:32px;border-radius:8px;background:var(--pri-g);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:800;color:var(--bg);flex-shrink:0">'+U.esc((u.company_name||u.email||'S').charAt(0).toUpperCase())+'</div><div><div style="font-size:13px;font-weight:600">'+U.esc(u.company_name||u.display_name||'')+'</div><div style="font-size:11px;color:var(--w40)">'+U.esc(u.email)+'</div></div></div></td><td style="font-family:JetBrains Mono;text-align:center">'+prods+'</td><td style="font-family:JetBrains Mono;text-align:center">'+deals+'</td><td style="font-family:JetBrains Mono;font-size:12px">'+(rev?U.usd(rev):'â€”')+'</td><td>'+UI.pb(u.plan||'free')+'</td><td style="font-size:12px;color:var(--w40)">'+U.fd(u.created_at)+'</td></tr>';
  }).join(''):'<tr><td colspan="6">'+UI.empty('ğŸ­','ì œì¡°ì‚¬ ì—†ìŒ','')+'</td></tr>')+'</tbody></table></div></div>';
}
function pgSellerDetail(){
  var u=S.selectedSeller;if(!u)return'';
  var co=getCompany(u.id);var prods=S.products.filter(function(p){return p.user_id===u.id;});
  var deals=S.matchings.filter(function(m){return m.seller_id===u.id;});
  var orders=S.orders.filter(function(o){return o.seller_id===u.id;});
  var rev=sumBy(orders.filter(function(o){return o.payment_status==='paid'||o.status==='completed';}),'total_amount');
  var msgs=S.messages.filter(function(m){return m.user_id===u.id;});
  return '<div style="display:flex;align-items:center;gap:12px;margin-bottom:20px"><button class="btn btn-ghost btn-sm" onclick="Adm.set({selectedSeller:null})">â† ëª©ë¡</button><h2 style="font-size:18px;font-weight:800;flex:1">'+U.esc(u.company_name||u.email)+'</h2>'+UI.pb(u.plan||'free')+'</div>'+
  '<div class="grid-4" style="margin-bottom:16px">'+UI.stat('ì œí’ˆ',prods.length,'','var(--pri)')+UI.stat('ë”œ',deals.length,'','var(--acc)')+UI.stat('ë§¤ì¶œ',U.usd(rev),'','var(--ok)')+UI.stat('ë©”ì‹œì§€',msgs.length,'','var(--purple)')+'</div>'+
  '<div class="grid-2" style="margin-bottom:16px">'+
    '<div class="card"><div class="card-h">ê³„ì • ì •ë³´</div><div class="card-b">'+
      '<div class="detail-row"><div class="detail-label">ì´ë©”ì¼</div><div class="detail-value">'+U.esc(u.email)+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">íšŒì‚¬ëª…</div><div class="detail-value">'+U.esc(u.company_name||'â€”')+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">í”Œëœ</div><div class="detail-value">'+UI.pb(u.plan||'free')+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ê°€ì…ì¼</div><div class="detail-value">'+U.fd(u.created_at)+'</div></div>'+
      (co?'<div class="detail-row"><div class="detail-label">ì£¼ì†Œ</div><div class="detail-value">'+U.esc(co.address_ko||'â€”')+'</div></div><div class="detail-row"><div class="detail-label">ëŒ€í‘œ</div><div class="detail-value">'+U.esc(co.ceo_name_ko||'â€”')+'</div></div>':'')+
    '</div></div>'+
    '<div class="card"><div class="card-h">ë”œ í˜„í™©</div><div class="card-b">'+(deals.length?deals.map(function(d){return '<div style="display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--w08)"><div style="font-size:12px">'+flag(getBuyerCountry(d.buyer_id))+' '+getBuyerName(d.buyer_id)+'</div>'+UI.badge(matchStatusLabel(d.status),d.status==='completed'?'ok':d.status==='rejected'?'err':'acc')+'</div>';}).join(''):UI.empty('ğŸ¤','ë”œ ì—†ìŒ',''))+'</div></div>'+
  '</div>'+
  '<div class="card"><div class="card-h"><span>ì œí’ˆ ëª©ë¡</span>'+UI.badge(prods.length+'ê±´','pri')+'</div><div class="card-b" style="padding:0">'+(prods.length?'<table class="tbl"><thead><tr><th>ì œí’ˆëª…</th><th>ì¹´í…Œê³ ë¦¬</th><th>FOB</th><th>MOQ</th></tr></thead><tbody>'+prods.map(function(p){return '<tr><td style="font-weight:600">'+U.tr(p.name_ko||p.name_en,30)+'</td><td style="font-size:12px">'+(p.category||'â€”')+'</td><td style="font-family:JetBrains Mono;font-size:12px">'+(p.fob_price?U.usd(p.fob_price):'â€”')+'</td><td style="font-size:12px">'+(p.moq||'â€”')+'</td></tr>';}).join('')+'</tbody></table>':'<div style="padding:18px">'+UI.empty('ğŸ“¦','ì œí’ˆ ì—†ìŒ','')+'</div>')+'</div></div>';
}

/* â”€â”€ Buyers â”€â”€ */
function pgBuyers(){
  if(S.selectedBuyer) return pgBuyerDetail();
  var countries={};S.buyers.forEach(function(b){if(b.country)countries[b.country]=(countries[b.country]||0)+1;});
  var filtered=filterBySearch(S.buyers,['company_name','contact_name','country']);
  var srcLabel={manual:'ì§ì ‘ë“±ë¡',platform:'í”Œë«í¼',ai_generated:'AIì¶”ì²œ',linkedin:'LinkedIn',alibaba:'ì•Œë¦¬ë°”ë°”',exhibition:'ì „ì‹œíšŒ',referral:'ì†Œê°œ',mock:'Mock',marketplace:'ë§ˆì¼“'};
  var srcColor={mock:'var(--err)',alibaba:'var(--acc)',ai_generated:'var(--pri)',marketplace:'#6366f1'};
  var mockCount=S.buyers.filter(function(b){return b.is_mock;}).length;
  var tabFilter=S._buyerTab||'all';
  if(tabFilter==='mock')filtered=filtered.filter(function(b){return b.is_mock;});
  else if(tabFilter==='real')filtered=filtered.filter(function(b){return !b.is_mock;});
  return '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px"><h2 style="font-size:18px;font-weight:800">ğŸŒ ë°”ì´ì–´ ê´€ë¦¬</h2><div style="display:flex;gap:8px;align-items:center">'+UI.badge(S.buyers.length+'ëª…','pri')+'<button class="btn btn-pri btn-sm" onclick="Adm.showBuyerForm()">+ ë°”ì´ì–´ ë“±ë¡</button></div></div>'+
  '<div class="grid-4" style="margin-bottom:16px">'+UI.stat('ë°”ì´ì–´',S.buyers.length,'','var(--pri)')+UI.stat('êµ­ê°€',Object.keys(countries).length,'','var(--acc)')+UI.stat('Mock',mockCount,'','var(--err)')+UI.stat('ë”œ',S.matchings.length,'','var(--purple)')+'</div>'+
  '<div style="display:flex;gap:6px;margin-bottom:12px">'+
  '<button class="btn btn-sm '+(tabFilter==='all'?'btn-pri':'btn-ghost')+'" onclick="Adm.set({_buyerTab:\'all\'})">ì „ì²´</button>'+
  '<button class="btn btn-sm '+(tabFilter==='real'?'btn-pri':'btn-ghost')+'" onclick="Adm.set({_buyerTab:\'real\'})">ì‹¤ì œ</button>'+
  '<button class="btn btn-sm '+(tabFilter==='mock'?'btn-err':'btn-ghost')+'" style="'+(tabFilter==='mock'?'background:var(--err)':'')+'" onclick="Adm.set({_buyerTab:\'mock\'})">Mock</button></div>'+
  '<div class="card" style="margin-bottom:16px"><div class="card-h">êµ­ê°€ë³„ ë¶„í¬</div><div class="card-b"><div style="display:flex;gap:8px;flex-wrap:wrap">'+(function(){var sorted=Object.entries(countries).sort(function(a,b){return b[1]-a[1];});return sorted.map(function(e){var pct=Math.round(e[1]/S.buyers.length*100);return '<div style="padding:8px 14px;border-radius:8px;background:var(--w08);text-align:center;min-width:80px"><div style="font-size:20px">'+flag(e[0])+'</div><div style="font-size:11px;font-weight:700;color:var(--w70)">'+e[0]+'</div><div style="font-size:16px;font-weight:800;color:var(--pri)">'+e[1]+'</div><div style="font-size:10px;color:var(--w20)">'+pct+'%</div></div>';}).join('');})()+'</div></div></div>'+
  '<div style="display:flex;gap:10px;margin-bottom:16px"><div class="search-box" style="flex:1"><input placeholder="íšŒì‚¬ëª…, êµ­ê°€ ê²€ìƒ‰..." value="'+S.searchFilter+'" oninput="Adm.setSearch(this.value)"></div></div>'+
  '<div class="card"><div class="card-b" style="padding:0"><table class="tbl"><thead><tr><th>íšŒì‚¬</th><th>êµ­ê°€</th><th>ë‹´ë‹¹ì</th><th>ì†ŒìŠ¤</th><th>ë¬¸ì˜</th><th>ë”œ</th><th>ë“±ë¡ì¼</th></tr></thead><tbody>'+
  (filtered.length?filtered.map(function(b){
    var reqs=S.buyerRequests.filter(function(r){return r.buyer_id===b.id;}).length;
    var deals=S.matchings.filter(function(m){return m.buyer_id===b.id;}).length;
    var src=b.source||'manual';var sc=srcColor[src]||'var(--w40)';
    return '<tr onclick="Adm.viewBuyer(\''+b.id+'\')"><td style="font-weight:600">'+(b.is_mock?'<span style="font-size:9px;padding:1px 5px;border-radius:3px;background:rgba(255,82,82,.15);color:var(--err);margin-right:4px">MOCK</span>':'')+U.esc(b.company_name)+'</td><td>'+flag(b.country)+' '+U.esc(b.country||'')+'</td><td style="font-size:12px">'+U.esc(b.contact_name||'â€”')+'</td><td>'+UI.badge(srcLabel[src]||src,b.is_mock?'err':'ghost')+'</td><td style="font-family:JetBrains Mono;text-align:center">'+reqs+'</td><td style="font-family:JetBrains Mono;text-align:center">'+deals+'</td><td style="font-size:12px;color:var(--w40)">'+U.fd(b.created_at)+'</td></tr>';
  }).join(''):'<tr><td colspan="7">'+UI.empty('ğŸŒ','ë°”ì´ì–´ ì—†ìŒ','')+'</td></tr>')+'</tbody></table></div></div>';
}
function pgBuyerDetail(){
  var b=S.selectedBuyer;if(!b)return'';
  var deals=S.matchings.filter(function(m){return m.buyer_id===b.id;});
  var reqs=S.buyerRequests.filter(function(r){return r.buyer_id===b.id;});
  var msgs=S.messages.filter(function(m){return m.buyer_id===b.id;});
  var rev=sumBy(S.orders.filter(function(o){return o.buyer_id===b.id&&(o.payment_status==='paid'||o.status==='completed');}),'total_amount');
  var bSrcLabel={manual:'ì§ì ‘ë“±ë¡',platform:'í”Œë«í¼',ai_generated:'AIì¶”ì²œ',linkedin:'LinkedIn',alibaba:'ì•Œë¦¬ë°”ë°”',exhibition:'ì „ì‹œíšŒ',referral:'ì†Œê°œ',mock:'Mock',marketplace:'ë§ˆì¼“'};
  return '<div style="display:flex;align-items:center;gap:12px;margin-bottom:20px"><button class="btn btn-ghost btn-sm" onclick="Adm.set({selectedBuyer:null})">â† ëª©ë¡</button><h2 style="font-size:18px;font-weight:800;flex:1">'+flag(b.country)+' '+U.esc(b.company_name)+(b.is_mock?' <span style="font-size:11px;padding:2px 8px;border-radius:4px;background:rgba(255,82,82,.15);color:var(--err)">MOCK</span>':'')+'</h2><button class="btn btn-pri btn-sm" onclick="Adm.showMatchingForm(\''+b.id+'\')">ë§¤ì¹­ ìƒì„±</button></div>'+
  '<div class="grid-4" style="margin-bottom:16px">'+UI.stat('ë”œ',deals.length,'','var(--pri)')+UI.stat('ë¬¸ì˜',reqs.length,'','var(--acc)')+UI.stat('ë©”ì‹œì§€',msgs.length,'','var(--ok)')+UI.stat('ë§¤ì¶œ',U.usd(rev),'','var(--admin)')+'</div>'+
  '<div class="grid-2" style="margin-bottom:16px">'+
    '<div class="card"><div class="card-h">ë°”ì´ì–´ ì •ë³´</div><div class="card-b">'+
      '<div class="detail-row"><div class="detail-label">íšŒì‚¬ëª…</div><div class="detail-value">'+U.esc(b.company_name)+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">êµ­ê°€</div><div class="detail-value">'+flag(b.country)+' '+U.esc(b.country||'')+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ë‹´ë‹¹ì</div><div class="detail-value">'+U.esc(b.contact_name||'â€”')+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ì´ë©”ì¼</div><div class="detail-value">'+U.esc(b.contact_email||'â€”')+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ì „í™”</div><div class="detail-value">'+U.esc(b.phone||'â€”')+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ì†ŒìŠ¤</div><div class="detail-value">'+UI.badge(bSrcLabel[b.source]||b.source||'manual',b.is_mock?'err':'ghost')+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ê´€ì‹¬ë¶„ì•¼</div><div class="detail-value">'+U.esc((b.interested_categories||[]).join(', ')||'â€”')+'</div></div>'+
    '</div></div>'+
    '<div class="card"><div class="card-h">ë”œ í˜„í™©</div><div class="card-b">'+(deals.length?deals.map(function(d){return '<div style="display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--w08)"><div style="font-size:12px">'+getUserName(d.user_id)+'</div>'+UI.badge(matchStatusLabel(d.status),d.status==='completed'?'ok':d.status==='rejected'?'err':'acc')+'</div>';}).join(''):UI.empty('ğŸ¤','ë”œ ì—†ìŒ',''))+'</div></div>'+
  '</div>'+
  /* Admin memo & tags */
  '<div class="card" style="margin-bottom:16px"><div class="card-h">ê´€ë¦¬ì ë©”ëª¨/íƒœê·¸ <span style="font-size:10px;color:var(--w20)">(ë‚´ë¶€ìš©)</span></div><div class="card-b">'+
    '<div style="margin-bottom:10px"><div style="font-size:11px;font-weight:700;color:var(--w40);margin-bottom:4px">íƒœê·¸</div><div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:6px">'+((b.admin_tags||[]).map(function(t){return '<span style="font-size:10px;padding:2px 8px;border-radius:4px;background:var(--w08);color:var(--w70)">'+U.esc(t)+' <span data-rm-buyer-tag="'+U.esc(b.id)+'" data-tag="'+U.esc(t).replace(/&#39;/g,'&apos;')+'" onclick="Adm.rmBuyerTag(this.dataset.rmBuyerTag,this.dataset.tag)" style="cursor:pointer;color:var(--err);margin-left:4px">Ã—</span></span>';}).join('')||'<span style="font-size:10px;color:var(--w20)">íƒœê·¸ ì—†ìŒ</span>')+'</div><div style="display:flex;gap:4px"><input id="buyer-tag-input" placeholder="íƒœê·¸ ì…ë ¥" style="flex:1;padding:6px 10px;border-radius:6px;background:var(--sf);border:1px solid var(--bd);color:var(--w90);font-size:11px" onkeydown="if(event.key===\'Enter\')Adm.addBuyerTag(\''+b.id+'\')"><button class="btn btn-ghost btn-sm" onclick="Adm.addBuyerTag(\''+b.id+'\')">ì¶”ê°€</button></div></div>'+
    '<div><div style="font-size:11px;font-weight:700;color:var(--w40);margin-bottom:4px">ë©”ëª¨</div><textarea id="buyer-memo" rows="3" style="width:100%;padding:8px;border-radius:6px;background:var(--sf);border:1px solid var(--bd);color:var(--w90);font-size:12px;resize:vertical">'+U.esc(b.admin_memo||'')+'</textarea><button class="btn btn-pri btn-sm" style="margin-top:6px" onclick="Adm.saveBuyerMemo(\''+b.id+'\')">ë©”ëª¨ ì €ì¥</button></div>'+
  '</div></div>';
}

/* â”€â”€ Matchings â”€â”€ */
function pgMatchings(){
  if(S.selectedMatching) return pgMatchingDetail();
  var pipeline={proposed:0,interested:0,sample:0,negotiation:0,contract:0,completed:0,rejected:0};
  S.matchings.forEach(function(m){if(pipeline[m.status]!==undefined)pipeline[m.status]++;});
  var maxPipe=Math.max.apply(null,Object.values(pipeline).concat([1]));
  var completedDeals=pipeline.completed;var totalDeals=S.matchings.length;
  var successRate=totalDeals?Math.round(completedDeals/totalDeals*100):0;
  var avgDealDays=(function(){var cd=S.matchings.filter(function(m){return m.status==='completed'&&m.created_at;});if(!cd.length)return 0;var total=cd.reduce(function(s,m){return s+Math.floor((new Date(m.updated_at||m.created_at)-new Date(m.created_at))/864e5);},0);return Math.round(total/cd.length);})();
  var tabs=['all','proposed','interested','sample','negotiation','contract','completed'];
  var filtered=S.matchings.slice();if(S.tab!=='all')filtered=filtered.filter(function(m){return m.status===S.tab;});
  return '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px"><h2 style="font-size:18px;font-weight:800">ğŸ¤ ë§¤ì¹­ / ë”œ ê´€ë¦¬</h2>'+UI.badge(totalDeals+'ê±´','pri')+'</div>'+
  '<div class="grid-4" style="margin-bottom:16px">'+UI.stat('ì „ì²´ ë”œ',totalDeals,'','var(--pri)')+UI.stat('ì™„ë£Œ',completedDeals,'','var(--ok)')+UI.stat('ì„±ê³µë¥ ',successRate+'%','','var(--acc)')+UI.stat('í‰ê·  ê¸°ê°„',avgDealDays+'ì¼','ì™„ë£Œ ë”œ ê¸°ì¤€','var(--purple)')+'</div>'+
  '<div class="card" style="margin-bottom:16px"><div class="card-h">íŒŒì´í”„ë¼ì¸</div><div class="card-b">'+[{k:'proposed',c:'var(--w40)'},{k:'interested',c:'var(--pri)'},{k:'sample',c:'var(--acc)'},{k:'negotiation',c:'var(--warn)'},{k:'contract',c:'var(--purple)'},{k:'completed',c:'var(--ok)'},{k:'rejected',c:'var(--err)'}].map(function(st){return hBar(matchStatusLabel(st.k),pipeline[st.k],maxPipe,st.c);}).join('')+'</div></div>'+
  '<div class="tab-bar">'+tabs.map(function(t){var label=t==='all'?'ì „ì²´':matchStatusLabel(t);var c=t==='all'?totalDeals:(pipeline[t]||0);return '<div class="tab-item '+(S.tab===t?'active':'')+'" onclick="Adm.setTab(\''+t+'\')">'+label+' <span style="font-size:10px;color:var(--w20)">'+c+'</span></div>';}).join('')+'</div>'+
  '<div class="card"><div class="card-b" style="padding:0"><table class="tbl"><thead><tr><th>ì œì¡°ì‚¬</th><th>ë°”ì´ì–´</th><th>ìƒíƒœ</th><th>ê¸ˆì•¡</th><th>ë‚ ì§œ</th></tr></thead><tbody>'+
  (filtered.length?filtered.map(function(m){var order=S.orders.find(function(o){return o.matching_id===m.id;});return '<tr onclick="Adm.viewMatching(\''+m.id+'\')"><td>'+getUserName(m.seller_id)+'</td><td>'+flag(getBuyerCountry(m.buyer_id))+' '+getBuyerName(m.buyer_id)+'</td><td>'+UI.badge(matchStatusLabel(m.status),m.status==='completed'?'ok':m.status==='rejected'?'err':'acc')+'</td><td style="font-family:JetBrains Mono;font-size:12px">'+(order?U.usd(order.total_amount):'â€”')+'</td><td style="font-size:12px;color:var(--w40)">'+U.fd(m.created_at)+'</td></tr>';}).join(''):'<tr><td colspan="5">'+UI.empty('ğŸ¤','ë§¤ì¹­ ì—†ìŒ','')+'</td></tr>')+'</tbody></table></div></div>';
}
function pgMatchingDetail(){
  var m=S.selectedMatching;if(!m)return'';
  var order=S.orders.find(function(o){return o.matching_id===m.id;});
  var msgs=S.messages.filter(function(msg){return msg.matching_id===m.id;});
  var docs=S.documents.filter(function(d){return d.matching_id===m.id;});
  var ship=S.shipments.find(function(s){return s.matching_id===m.id||(order&&s.order_id===order.id);});
  var pms=order?S.paymentMilestones.filter(function(p){return p.order_id===order.id;}):[];
  return '<div style="display:flex;align-items:center;gap:12px;margin-bottom:20px"><button class="btn btn-ghost btn-sm" onclick="Adm.set({selectedMatching:null})">â† ëª©ë¡</button><h2 style="font-size:18px;font-weight:800;flex:1">'+getUserName(m.seller_id)+' â†” '+getBuyerName(m.buyer_id)+'</h2>'+UI.badge(matchStatusLabel(m.status),m.status==='completed'?'ok':'acc')+'</div>'+
  '<div class="grid-4" style="margin-bottom:16px">'+UI.stat('ë©”ì‹œì§€',msgs.length,'','var(--pri)')+UI.stat('ì„œë¥˜',docs.length,'','var(--acc)')+UI.stat('ê¸ˆì•¡',order?U.usd(order.total_amount):'â€”','','var(--ok)')+UI.stat('ê²°ì œ',pms.length+'ê±´','','var(--purple)')+'</div>'+
  '<div class="grid-2" style="margin-bottom:16px">'+
    '<div class="card"><div class="card-h">ë”œ ì •ë³´</div><div class="card-b">'+
      '<div class="detail-row"><div class="detail-label">ì œì¡°ì‚¬</div><div class="detail-value" style="cursor:pointer;color:var(--pri)" onclick="Adm.viewSeller(\''+m.seller_id+'\')">'+getUserName(m.seller_id)+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ë°”ì´ì–´</div><div class="detail-value">'+flag(getBuyerCountry(m.buyer_id))+' '+getBuyerName(m.buyer_id)+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ìƒíƒœ</div><div class="detail-value">'+UI.badge(matchStatusLabel(m.status),m.status==='completed'?'ok':'acc')+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ìƒì„±ì¼</div><div class="detail-value">'+U.fd(m.created_at)+'</div></div>'+
      (m.notes?'<div class="detail-row"><div class="detail-label">ë©”ëª¨</div><div class="detail-value">'+U.esc(m.notes)+'</div></div>':'')+
      (ship?'<div class="detail-row"><div class="detail-label">ì„ ì </div><div class="detail-value">'+UI.badge(orderStatusLabel(ship.status),ship.status==='delivered'?'ok':'pri')+(ship.tracking_number?' <span style="font-family:JetBrains Mono;font-size:11px;color:var(--w40)">'+U.esc(ship.tracking_number)+'</span>':'')+'</div></div>':'')+
    '</div></div>'+
    '<div class="card"><div class="card-h">ì„œë¥˜</div><div class="card-b">'+(docs.length?docs.map(function(d){return '<div style="display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--w08)"><div style="font-size:12px">'+UI.badge(d.doc_type.toUpperCase(),'pri')+' '+(d.doc_number||'')+'</div>'+UI.sb(d.status||'draft')+'</div>';}).join(''):UI.empty('ğŸ“„','ì„œë¥˜ ì—†ìŒ',''))+'</div></div>'+
  '</div>'+
  '<div class="card" style="margin-bottom:16px"><div class="card-h"><span>ë©”ì‹œì§€ íƒ€ì„ë¼ì¸</span>'+UI.badge(msgs.length+'ê±´','pri')+'</div><div class="card-b">'+(msgs.length?msgs.slice().reverse().map(function(msg){return '<div style="display:flex;gap:10px;padding:8px 0;border-bottom:1px solid var(--w08)"><div style="width:24px;height:24px;border-radius:6px;background:'+(msg.direction==='inbound'?'rgba(0,212,255,.1)':'rgba(255,184,0,.1)')+';display:flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0">'+(msg.direction==='inbound'?'â¬…':'â¡')+'</div><div style="flex:1;min-width:0"><div style="font-size:12px;font-weight:600">'+U.tr(msg.subject||msg.body,50)+'</div><div style="font-size:10px;color:var(--w40)">'+U.fd(msg.created_at,'rel')+'</div></div></div>';}).join(''):UI.empty('ğŸ’¬','ë©”ì‹œì§€ ì—†ìŒ',''))+'</div></div>'+
  /* Admin memo & tags for matching */
  '<div class="card"><div class="card-h">ê´€ë¦¬ì ë©”ëª¨/íƒœê·¸ <span style="font-size:10px;color:var(--w20)">(ë‚´ë¶€ìš©)</span></div><div class="card-b">'+
    '<div style="margin-bottom:10px"><div style="font-size:11px;font-weight:700;color:var(--w40);margin-bottom:4px">íƒœê·¸</div><div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:6px">'+((m.admin_tags||[]).map(function(t){return '<span style="font-size:10px;padding:2px 8px;border-radius:4px;background:var(--w08);color:var(--w70)">'+U.esc(t)+' <span data-rm-matching-tag="'+U.esc(m.id)+'" data-tag="'+U.esc(t).replace(/&#39;/g,'&apos;')+'" onclick="Adm.rmMatchingTag(this.dataset.rmMatchingTag,this.dataset.tag)" style="cursor:pointer;color:var(--err);margin-left:4px">Ã—</span></span>';}).join('')||'<span style="font-size:10px;color:var(--w20)">íƒœê·¸ ì—†ìŒ</span>')+'</div><div style="display:flex;gap:4px"><input id="matching-tag-input" placeholder="íƒœê·¸ ì…ë ¥" style="flex:1;padding:6px 10px;border-radius:6px;background:var(--sf);border:1px solid var(--bd);color:var(--w90);font-size:11px" onkeydown="if(event.key===\'Enter\')Adm.addMatchingTag(\''+m.id+'\')"><button class="btn btn-ghost btn-sm" onclick="Adm.addMatchingTag(\''+m.id+'\')">ì¶”ê°€</button></div></div>'+
    '<div><div style="font-size:11px;font-weight:700;color:var(--w40);margin-bottom:4px">ë©”ëª¨</div><textarea id="matching-memo" rows="3" style="width:100%;padding:8px;border-radius:6px;background:var(--sf);border:1px solid var(--bd);color:var(--w90);font-size:12px;resize:vertical">'+U.esc(m.admin_memo||'')+'</textarea><button class="btn btn-pri btn-sm" style="margin-top:6px" onclick="Adm.saveMatchingMemo(\''+m.id+'\')">ë©”ëª¨ ì €ì¥</button></div>'+
  '</div></div>';
}

/* â”€â”€ Orders â”€â”€ */
function pgOrders(){
  if(S.selectedOrder) return pgOrderDetail();
  var paidOrders=S.orders.filter(function(o){return o.payment_status==='paid'||o.status==='completed';});
  var totalRev=sumBy(paidOrders,'total_amount');
  var pendingRev=sumBy(S.orders.filter(function(o){return o.payment_status!=='paid'&&o.status!=='completed'&&o.status!=='cancelled';}),'total_amount');
  var payDist=groupBy(S.orders,'payment_status');
  var countryRev={};S.orders.forEach(function(o){if(o.status==='cancelled')return;var c=getBuyerCountry(o.buyer_id);if(c)countryRev[c]=(countryRev[c]||0)+(Number(o.total_amount)||0);});
  var sortedCR=Object.entries(countryRev).sort(function(a,b){return b[1]-a[1];});var maxCR=sortedCR.length?sortedCR[0][1]:1;
  var subRevenue=0;S.users.forEach(function(u){var isMfr=(u.role==='client'&&u.country==='KR')||(u.preferred_currency==='KRW');if(u.plan==='basic'||u.plan==='starter')subRevenue+=isMfr?71:29;if(u.plan==='pro')subRevenue+=isMfr?214:89;if(u.plan==='alibaba')subRevenue+=199;});
  return '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px"><h2 style="font-size:18px;font-weight:800">ğŸ’° ì£¼ë¬¸ / ë§¤ì¶œ</h2>'+UI.badge(S.orders.length+'ê±´','pri')+'</div>'+
  '<div class="grid-5" style="margin-bottom:16px">'+UI.stat('ì´ ì£¼ë¬¸',S.orders.length,'','var(--pri)')+UI.stat('ì™„ë£Œ ë§¤ì¶œ',U.usd(totalRev),'','var(--ok)')+UI.stat('ë¯¸ê²°ì œ',U.usd(pendingRev),'','var(--acc)')+UI.stat('êµ¬ë… MRR','$'+subRevenue+'/mo','','var(--admin)')+UI.stat('ê²°ì œ ê±´',S.paymentMilestones.length,'','var(--purple)')+'</div>'+
  '<div class="grid-2" style="margin-bottom:16px">'+
    '<div class="card"><div class="card-h">ê²°ì œ ìƒíƒœ</div><div class="card-b">'+['pending','partial','paid'].map(function(s){var label=s==='pending'?'ë¯¸ê²°ì œ':s==='partial'?'ë¶€ë¶„ê²°ì œ':'ì™„ë£Œ';var c=s==='paid'?'var(--ok)':s==='partial'?'var(--acc)':'var(--w40)';return hBar(label,(payDist[s]||[]).length,S.orders.length||1,c);}).join('')+'</div></div>'+
    '<div class="card"><div class="card-h">êµ­ê°€ë³„ ë§¤ì¶œ</div><div class="card-b">'+sortedCR.map(function(e){var pct=Math.round(e[1]/maxCR*100);return '<div style="margin-bottom:8px"><div style="display:flex;justify-content:space-between;margin-bottom:3px"><span style="font-size:12px;color:var(--w60)">'+flag(e[0])+' '+e[0]+'</span><span style="font-size:12px;font-weight:700;font-family:JetBrains Mono;color:var(--pri)">'+U.usd(e[1])+'</span></div><div class="chart-bar" style="height:8px"><div class="chart-bar-fill" style="width:'+Math.max(pct,2)+'%;background:var(--pri)"></div></div></div>';}).join('')+'</div></div>'+
  '</div>'+
  '<div class="card"><div class="card-b" style="padding:0"><table class="tbl"><thead><tr><th>ì œì¡°ì‚¬</th><th>ë°”ì´ì–´</th><th>ê¸ˆì•¡</th><th>ê²°ì œ</th><th>ìƒíƒœ</th><th>ë‚ ì§œ</th></tr></thead><tbody>'+
  (S.orders.length?S.orders.map(function(o){return '<tr onclick="Adm.viewOrder(\''+o.id+'\')"><td>'+getUserName(o.seller_id)+'</td><td>'+flag(getBuyerCountry(o.buyer_id))+' '+getBuyerName(o.buyer_id)+'</td><td style="font-family:JetBrains Mono;font-weight:700">'+U.usd(o.total_amount)+'</td><td>'+UI.badge(o.payment_status==='paid'?'ì™„ë£Œ':o.payment_status==='partial'?'ë¶€ë¶„':'ë¯¸ê²°ì œ',o.payment_status==='paid'?'ok':o.payment_status==='partial'?'acc':'ghost')+'</td><td>'+UI.badge(orderStatusLabel(o.status),o.status==='completed'?'ok':'pri')+'</td><td style="font-size:12px;color:var(--w40)">'+U.fd(o.created_at)+'</td></tr>';}).join(''):'<tr><td colspan="6">'+UI.empty('ğŸ’°','ì£¼ë¬¸ ì—†ìŒ','')+'</td></tr>')+'</tbody></table></div></div>';
}
function pgOrderDetail(){
  var o=S.selectedOrder;if(!o)return'';
  var pms=S.paymentMilestones.filter(function(p){return p.order_id===o.id;});
  var ship=S.shipments.find(function(s){return s.order_id===o.id;});
  var paidAmt=sumBy(pms.filter(function(p){return p.status==='paid';}),'amount');
  return '<div style="display:flex;align-items:center;gap:12px;margin-bottom:20px"><button class="btn btn-ghost btn-sm" onclick="Adm.set({selectedOrder:null})">â† ëª©ë¡</button><h2 style="font-size:18px;font-weight:800;flex:1">ì£¼ë¬¸ '+U.esc(o.order_number||o.id.slice(0,8))+'</h2>'+UI.badge(orderStatusLabel(o.status),o.status==='completed'?'ok':'pri')+'</div>'+
  '<div class="grid-4" style="margin-bottom:16px">'+UI.stat('ì£¼ë¬¸ ê¸ˆì•¡',U.usd(o.total_amount),'','var(--pri)')+UI.stat('ê²°ì œ ì™„ë£Œ',U.usd(paidAmt),'','var(--ok)')+UI.stat('ì”ì•¡',U.usd((o.total_amount||0)-paidAmt),'','var(--acc)')+UI.stat('ê²°ì œ ê±´',pms.length+'ê±´','','var(--purple)')+'</div>'+
  '<div class="grid-2" style="margin-bottom:16px">'+
    '<div class="card"><div class="card-h">ì£¼ë¬¸ ì •ë³´</div><div class="card-b">'+
      '<div class="detail-row"><div class="detail-label">ì œì¡°ì‚¬</div><div class="detail-value" style="cursor:pointer;color:var(--pri)" onclick="Adm.viewSeller(\''+o.seller_id+'\')">'+getUserName(o.seller_id)+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ë°”ì´ì–´</div><div class="detail-value">'+flag(getBuyerCountry(o.buyer_id))+' '+getBuyerName(o.buyer_id)+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ì£¼ë¬¸ë²ˆí˜¸</div><div class="detail-value" style="font-family:JetBrains Mono">'+U.esc(o.order_number||'â€”')+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ê²°ì œìƒíƒœ</div><div class="detail-value">'+UI.badge(o.payment_status==='paid'?'ì™„ë£Œ':o.payment_status==='partial'?'ë¶€ë¶„ê²°ì œ':'ë¯¸ê²°ì œ',o.payment_status==='paid'?'ok':'acc')+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ìƒì„±ì¼</div><div class="detail-value">'+U.fd(o.created_at)+'</div></div>'+
    '</div></div>'+
    '<div class="card"><div class="card-h">ì„ ì  ì •ë³´</div><div class="card-b">'+(ship?
      '<div class="detail-row"><div class="detail-label">ìƒíƒœ</div><div class="detail-value">'+UI.badge(orderStatusLabel(ship.status),ship.status==='delivered'?'ok':'pri')+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ì¶”ì ë²ˆí˜¸</div><div class="detail-value" style="font-family:JetBrains Mono">'+U.esc(ship.tracking_number||'â€”')+'</div></div>'+
      '<div class="detail-row"><div class="detail-label">ì„ ì‚¬</div><div class="detail-value">'+U.esc(ship.carrier||'â€”')+'</div></div>'+
      (ship.etd?'<div class="detail-row"><div class="detail-label">ì¶œë°œì˜ˆì •</div><div class="detail-value">'+U.fd(ship.etd)+'</div></div>':'')+
      (ship.eta?'<div class="detail-row"><div class="detail-label">ë„ì°©ì˜ˆì •</div><div class="detail-value">'+U.fd(ship.eta)+'</div></div>':'')
    :UI.empty('ğŸš¢','ì„ ì  ì •ë³´ ì—†ìŒ',''))+'</div></div>'+
  '</div>'+
  '<div class="card"><div class="card-h"><span>ê²°ì œ ë§ˆì¼ìŠ¤í†¤</span>'+UI.badge(pms.length+'ê±´','pri')+'</div><div class="card-b" style="padding:0">'+(pms.length?'<table class="tbl"><thead><tr><th>ì„¤ëª…</th><th>ê¸ˆì•¡</th><th>ìƒíƒœ</th><th>ê²°ì œì¼</th></tr></thead><tbody>'+pms.map(function(p){return '<tr><td style="font-weight:600">'+U.esc(p.description||'â€”')+'</td><td style="font-family:JetBrains Mono">'+U.usd(p.amount)+'</td><td>'+UI.badge(p.status==='paid'?'ì™„ë£Œ':'ëŒ€ê¸°',p.status==='paid'?'ok':'ghost')+'</td><td style="font-size:12px;color:var(--w40)">'+(p.paid_at?U.fd(p.paid_at):'â€”')+'</td></tr>';}).join('')+'</tbody></table>':'<div style="padding:18px">'+UI.empty('ğŸ’³','ê²°ì œ ì—†ìŒ','')+'</div>')+'</div></div>';
}

/* â”€â”€ Chat Monitor â”€â”€ */
function pgChat(){
  var unread=S.messages.filter(function(m){return !m.is_read;}).length;
  var inbound=S.messages.filter(function(m){return m.direction==='inbound';}).length;
  var outbound=S.messages.filter(function(m){return m.direction==='outbound';}).length;
  var byBuyer=groupBy(S.messages,'buyer_id');
  var convos=Object.entries(byBuyer).map(function(e){var msgs=e[1].sort(function(a,b){return new Date(b.created_at)-new Date(a.created_at);});return{buyer_id:e[0],messages:msgs,lastMsg:msgs[0],unread:msgs.filter(function(m){return !m.is_read;}).length,total:msgs.length};}).sort(function(a,b){return new Date(b.lastMsg.created_at)-new Date(a.lastMsg.created_at);});
  return '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px"><h2 style="font-size:18px;font-weight:800">ğŸ’¬ ì±„íŒ… ëª¨ë‹ˆí„°</h2>'+UI.badge(S.messages.length+'ê±´','pri')+'</div>'+
  '<div class="grid-4" style="margin-bottom:16px">'+UI.stat('ì „ì²´ ë©”ì‹œì§€',S.messages.length,'','var(--pri)')+UI.stat('ë¯¸ì½ìŒ',unread,'','var(--err)')+UI.stat('ìˆ˜ì‹ ',inbound,'','var(--acc)')+UI.stat('ë°œì‹ ',outbound,'','var(--ok)')+'</div>'+
  '<div class="card"><div class="card-h"><span>ëŒ€í™” ëª©ë¡</span></div><div class="card-b">'+
  (convos.length?convos.map(function(c){
    var buyer=S.buyers.find(function(b){return b.id===c.buyer_id;});
    var seller=c.lastMsg?S.users.find(function(u){return u.id===c.lastMsg.user_id;}):null;
    var matchId=((S.matchings.find(function(m){return m.buyer_id===c.buyer_id;})||{}).id||'');
    return '<div style="display:flex;align-items:center;gap:12px;padding:12px;border-radius:10px;margin-bottom:8px;background:var(--w08);cursor:pointer" onclick="Adm.viewMatching(\''+matchId+'\')">'+
      '<div style="width:40px;height:40px;border-radius:10px;background:var(--pri-g);display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:800;color:var(--bg);flex-shrink:0">'+(buyer?flag(buyer.country):'ğŸ’¬')+'</div>'+
      '<div style="flex:1;min-width:0"><div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:13px;font-weight:700">'+(buyer?U.esc(buyer.company_name):'ì•Œìˆ˜ì—†ìŒ')+'</span><span style="font-size:10px;color:var(--w40)">'+U.fd(c.lastMsg.created_at,'rel')+'</span></div><div style="font-size:12px;color:var(--w40);margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+(seller?U.esc(seller.company_name||seller.email.split('@')[0]):'')+(c.lastMsg?' Â· '+U.tr(c.lastMsg.subject||c.lastMsg.body,35):'')+'</div></div>'+
      '<div style="display:flex;align-items:center;gap:8px"><span style="font-size:11px;color:var(--w20);font-family:JetBrains Mono">'+c.total+'</span>'+(c.unread?'<span style="min-width:18px;height:18px;border-radius:9px;background:var(--err);color:var(--w);font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;padding:0 5px">'+c.unread+'</span>':'')+'</div></div>';
  }).join(''):UI.empty('ğŸ’¬','ë©”ì‹œì§€ ì—†ìŒ',''))+'</div></div>';
}

/* â”€â”€ Health â”€â”€ */
function pgHealth(){
  setTimeout(checkRelayHealth,100);
  return '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px"><h2 style="font-size:18px;font-weight:800">ğŸ›¡ï¸ ì‹œìŠ¤í…œ ìƒíƒœ</h2></div>'+
  '<div class="grid-2" style="margin-bottom:16px">'+
    '<div class="card"><div class="card-h">ë¦´ë ˆì´ ì„œë²„</div><div class="card-b" id="health-relay"><div style="text-align:center;padding:20px"><div class="spinner" style="margin:0 auto 12px"></div><div style="font-size:12px;color:var(--w40)">ì²´í¬ ì¤‘...</div></div></div></div>'+
    '<div class="card"><div class="card-h">Supabase</div><div class="card-b"><div class="detail-row"><div class="detail-label">ìƒíƒœ</div><div class="detail-value"><span class="status-dot active"></span>ì—°ê²°ë¨</div></div><div class="detail-row"><div class="detail-label">í”„ë¡œì íŠ¸</div><div class="detail-value" style="font-family:JetBrains Mono;font-size:11px">lylktgxngrlxmsldxdqj</div></div></div></div>'+
  '</div>'+
  '<div class="card" style="margin-bottom:16px"><div class="card-h">DB ë ˆì½”ë“œ í˜„í™©</div><div class="card-b"><div class="grid-4" style="gap:8px">'+
    [['users',S.users.length],['companies',S.companies.length],['products',S.products.length],['analyses',S.analyses.length],['buyers',S.buyers.length],['matchings',S.matchings.length],['orders',S.orders.length],['messages',S.messages.length],['shipments',S.shipments.length],['payments',S.paymentMilestones.length],['documents',S.documents.length],['page_views',S.pageViews.length],['buyer_req',S.buyerRequests.length],['proposals',S.proposals.length],['service_req',S.serviceRequests.length],['projects',S.projects.length]].map(function(e){return '<div style="padding:8px;border-radius:6px;background:var(--w08);text-align:center"><div style="font-size:10px;color:var(--w40);font-family:JetBrains Mono">'+e[0]+'</div><div style="font-size:18px;font-weight:800;color:var(--pri);font-family:JetBrains Mono">'+e[1]+'</div></div>';}).join('')+
  '</div></div></div>';
}
function checkRelayHealth(){var el=document.getElementById('health-relay');if(!el)return;fetch(RELAY_URL+'/api/health',{signal:AbortSignal.timeout(5000)}).then(function(r){return r.json();}).then(function(){el.innerHTML='<div class="detail-row"><div class="detail-label">ìƒíƒœ</div><div class="detail-value"><span class="status-dot active"></span>ì˜¨ë¼ì¸</div></div><div class="detail-row"><div class="detail-label">URL</div><div class="detail-value" style="font-family:JetBrains Mono;font-size:11px;word-break:break-all">'+RELAY_URL+'</div></div>';}).catch(function(){el.innerHTML='<div class="detail-row"><div class="detail-label">ìƒíƒœ</div><div class="detail-value"><span class="status-dot inactive"></span>ì˜¤í”„ë¼ì¸</div></div><div class="detail-row"><div class="detail-label">URL</div><div class="detail-value" style="font-family:JetBrains Mono;font-size:11px;word-break:break-all">'+RELAY_URL+'</div></div>';});}

/* â”€â”€ Settings â”€â”€ */
function pgSettings(){
  return '<div style="margin-bottom:20px"><h2 style="font-size:18px;font-weight:800">âš™ï¸ ì‹œìŠ¤í…œ ì„¤ì •</h2></div>'+
  '<div class="grid-2">'+
    '<div class="card"><div class="card-h">ğŸ”‘ API ì„¤ì •</div><div class="card-b">'+
      '<div class="detail-row"><div class="detail-label">Supabase</div><div class="detail-value" style="font-family:JetBrains Mono;font-size:11px;color:var(--ok)">ì—°ê²°ë¨</div></div>'+
      '<div class="detail-row"><div class="detail-label">AI Engine</div><div class="detail-value" style="font-family:JetBrains Mono;font-size:11px">Claude Sonnet (relay)</div></div>'+
      '<div class="detail-row"><div class="detail-label">Relay URL</div><div class="detail-value" style="font-family:JetBrains Mono;font-size:11px;word-break:break-all">localhost:3456</div></div>'+
    '</div></div>'+

    '<div class="card"><div class="card-h">ğŸ“Š DB í˜„í™©</div><div class="card-b">'+
      [['users',S.users.length],['companies',S.companies.length],['analyses',S.analyses.length],['products',S.products.length],['buyers',S.buyers.length],['matchings',S.matchings.length],['orders',S.orders.length],['messages',S.messages.length],['documents',S.documents.length],['shipments',S.shipments.length],['page_views',S.pageViews.length],['service_req',S.serviceRequests.length],['projects',S.projects.length]].map(function(e){return '<div class="detail-row"><div class="detail-label">'+e[0]+'</div><div class="detail-value" style="font-family:JetBrains Mono">'+e[1]+'</div></div>';}).join('')+
      '<div style="margin-top:14px"><button class="btn btn-admin btn-sm" onclick="Adm.refreshAll()">ğŸ”„ ì „ì²´ ìƒˆë¡œê³ ì¹¨</button></div>'+
    '</div></div>'+
  '</div>'+

  '<div class="card" style="margin-top:16px"><div class="card-h">ğŸ› ï¸ ê´€ë¦¬ ë„êµ¬</div><div class="card-b"><div style="display:flex;flex-wrap:wrap;gap:8px">'+
    '<button class="btn btn-ghost" onclick="Adm.exportCSV(\'users\')">ğŸ“¥ ìœ ì € CSV</button>'+
    '<button class="btn btn-ghost" onclick="Adm.exportCSV(\'analyses\')">ğŸ“¥ ë¶„ì„ CSV</button>'+
    '<button class="btn btn-ghost" onclick="Adm.exportCSV(\'service_requests\')">ğŸ“¥ ì„œë¹„ìŠ¤ CSV</button>'+
    '<button class="btn btn-ghost" onclick="window.open(\'whistle.html\',\'_blank\')">ğŸ”— í´ë¼ì´ì–¸íŠ¸ í¬í„¸</button>'+
  '</div></div></div>';
}

/* â”€â”€ Payments / Escrow â”€â”€ */
function pgPayments(){
  var tabs=['revenue','subscriptions','escrow','policy'];
  var tabL={revenue:'\uC218\uC775 \uB300\uC2DC\uBCF4\uB4DC',subscriptions:'\uAD6C\uB3C5 \uAD00\uB9AC',escrow:'\uC5D0\uC2A4\uD06C\uB85C',policy:'\uCDE8\uC18C/\uD658\uBD88 \uC815\uCC45'};
  var tabBar='<div class="tab-bar">'+tabs.map(function(t){return '<div class="tab-item '+(S.paymentTab===t?'active':'')+'" onclick="Adm.setPaymentTab(\''+t+'\')">'+tabL[t]+'</div>';}).join('')+'</div>';
  var title='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px"><h2 style="font-size:18px;font-weight:800">\uD83D\uDCB3 \uACB0\uC81C / \uC5D0\uC2A4\uD06C\uB85C</h2></div>';
  if(S.paymentTab==='subscriptions')return title+tabBar+pgPaySubs();
  if(S.paymentTab==='escrow')return title+tabBar+pgPayEscrow();
  if(S.paymentTab==='policy')return title+tabBar+pgPayPolicy();
  return title+tabBar+pgPayRevenue();
}

function pgPayRevenue(){
  var mrr=calcMRR();var arr=mrr*12;var hold=calcEscrowHold();var comm=calcEscrowComm();var flt=calcFloat();
  var activeSubs=S.subscriptions.filter(function(s){return s.status==='active';}).length||S.users.filter(function(u){return PLAN_PRICE[u.plan];}).length;
  var activeEsc=S.escrowTxns.filter(function(e){return['funded','in_production','shipped','inspection'].indexOf(e.escrow_status)>=0;}).length;

  /* Plan revenue breakdown */
  var planRev={starter:0,pro:0,alibaba:0,enterprise:0};
  if(S.subscriptions.length){S.subscriptions.filter(function(s){return s.status==='active';}).forEach(function(s){var a=Number(s.amount)||0;var mo=s.billing_cycle==='semi_annual'?a/6:s.billing_cycle==='annual'?a/12:a;var k=(s.plan==='basic')?'starter':s.plan;planRev[k]=(planRev[k]||0)+mo;});}
  else{S.users.forEach(function(u){var p=PLAN_PRICE[u.plan];if(p){var k=(u.plan==='basic')?'starter':u.plan;planRev[k]=(planRev[k]||0)+p.m;}});}
  var maxPR=Math.max.apply(null,Object.values(planRev).concat([1]));

  /* Billing cycle dist */
  var cycleDist={monthly:0,semi_annual:0,annual:0};
  if(S.subscriptions.length){S.subscriptions.filter(function(s){return s.status==='active';}).forEach(function(s){if(cycleDist[s.billing_cycle]!==undefined)cycleDist[s.billing_cycle]++;});}
  else{S.users.forEach(function(u){if(PLAN_PRICE[u.plan])cycleDist[u.billing_cycle||'monthly']++;});}
  var maxCy=Math.max.apply(null,Object.values(cycleDist).concat([1]));

  /* Escrow pipeline */
  var escPipe={};Object.keys(ESC_ST).forEach(function(k){escPipe[k]=0;});
  S.escrowTxns.forEach(function(e){if(escPipe[e.escrow_status]!==undefined)escPipe[e.escrow_status]++;});
  var maxEP=Math.max.apply(null,Object.values(escPipe).concat([1]));

  /* Product revenue from orders */
  var prodRev={};
  S.escrowTxns.forEach(function(e){if(e.product_name){prodRev[e.product_name]=(prodRev[e.product_name]||0)+(Number(e.amount)||0);}});
  S.orders.forEach(function(o){var items=o.items||[];if(typeof items==='string')try{items=JSON.parse(items);}catch(x){items=[];}
    items.forEach(function(it){if(it.name){prodRev[it.name]=(prodRev[it.name]||0)+(Number(it.amount||it.total)||0);}});
    if(!items.length&&o.total_amount){var p=S.products.find(function(pp){return pp.user_id===o.user_id;});if(p)prodRev[p.name_ko||p.name_en||'Unknown']=(prodRev[p.name_ko||p.name_en||'Unknown']||0)+(Number(o.total_amount)||0);}
  });
  var sortedProd=Object.entries(prodRev).sort(function(a,b){return b[1]-a[1];}).slice(0,8);
  var maxProd=sortedProd.length?sortedProd[0][1]:1;

  /* Revenue streams */
  var streams=[{l:'\uAD6C\uB3C5 \uC218\uC775 (MRR)',v:mrr,c:'var(--pri)'},{l:'\uC5D0\uC2A4\uD06C\uB85C \uC218\uC218\uB8CC',v:comm,c:'var(--acc)'},{l:'\uD50C\uB85C\uD2B8 \uC218\uC775 (\uC790\uAE08\uBCF4\uC720 \uC774\uC790)',v:flt,c:'var(--ok)'}];
  var maxStr=Math.max.apply(null,streams.map(function(s){return s.v;}).concat([1]));

  return '<div class="grid-5" style="margin-bottom:20px">'+
    UI.stat('MRR (\uC6D4 \uBC18\uBCF5\uB9E4\uCD9C)',U.usd(mrr),'\uAD6C\uB3C5 '+activeSubs+'\uAC74','var(--pri)')+
    UI.stat('ARR (\uC5F0 \uBC18\uBCF5\uB9E4\uCD9C)',U.usd(arr),'','var(--ok)')+
    UI.stat('\uC5D0\uC2A4\uD06C\uB85C \uBCF4\uC720\uAE08',U.usd(hold),activeEsc+'\uAC74 \uC9C4\uD589\uC911','var(--acc)')+
    UI.stat('\uB204\uC801 \uC218\uC218\uB8CC',U.usd(comm),'\uC5D0\uC2A4\uD06C\uB85C \uC815\uC0B0','var(--admin)')+
    UI.stat('\uD50C\uB85C\uD2B8 \uC218\uC775',U.usd(flt),'\uC790\uAE08\uBCF4\uC720 \uC774\uC790','var(--purple)')+
  '</div>'+
  '<div class="grid-2" style="margin-bottom:16px">'+
    '<div class="card"><div class="card-h">\uC218\uC775 \uAD6C\uC870 (3\uCD95)</div><div class="card-b">'+
      streams.map(function(s){return hBar(s.l,U.usd(s.v),maxStr,s.c);}).join('')+
      '<div style="margin-top:14px;padding-top:14px;border-top:1px solid var(--w08);display:flex;justify-content:space-between;align-items:center"><span style="font-size:14px;font-weight:700;color:var(--w70)">\uC6D4 \uCD1D \uC218\uC775 (\uCD94\uC815)</span><span style="font-size:20px;font-weight:900;color:var(--admin)">'+U.usd(mrr+comm/Math.max(1,S.escrowTxns.length?6:1)+flt/12)+'</span></div>'+
    '</div></div>'+
    '<div class="card"><div class="card-h">\uD50C\uB79C\uBCC4 MRR</div><div class="card-b">'+
      ['starter','pro','alibaba','enterprise'].map(function(p){var r=U.pl(p);var pr=PLAN_PRICE[p];return hBar(r[0]+' ($'+(pr?pr.m:0)+'/mo)',U.usd(planRev[p]||0),maxPR,r[1]);}).join('')+
    '</div></div>'+
  '</div>'+
  '<div class="grid-2" style="margin-bottom:16px">'+
    '<div class="card"><div class="card-h">\uACB0\uC81C \uC8FC\uAE30 \uBD84\uD3EC</div><div class="card-b">'+
      ['monthly','semi_annual','annual'].map(function(c){var disc=c==='semi_annual'?'(10% \uD560\uC778)':c==='annual'?'(20% \uD560\uC778)':'';return hBar(CYCLE_L[c]+' '+disc,cycleDist[c],maxCy,'var(--pri)');}).join('')+
      '<div style="margin-top:12px;padding:10px;border-radius:8px;background:var(--w08);font-size:11px;color:var(--w40)"><b>\uAC00\uACA9 \uC815\uCC45:</b> \uC6D4\uAC04=\uC815\uAC00 / 6\uAC1C\uC6D4=10% OFF / \uC5F0\uAC04=20% OFF</div>'+
    '</div></div>'+
    '<div class="card"><div class="card-h">\uC5D0\uC2A4\uD06C\uB85C \uD30C\uC774\uD504\uB77C\uC778</div><div class="card-b">'+
      ['pending_deposit','funded','in_production','shipped','inspection','released'].map(function(k){return hBar(ESC_ST[k][0],escPipe[k]||0,maxEP,ESC_COL[k]);}).join('')+
    '</div></div>'+
  '</div>'+
  '<div class="card"><div class="card-h"><span>\uC0C1\uD488\uBCC4 \uAC70\uB798 TOP</span>'+UI.badge(sortedProd.length+'\uAC1C','pri')+'</div><div class="card-b">'+(sortedProd.length?sortedProd.map(function(e){return hBar(U.tr(e[0],25),U.usd(e[1]),maxProd,'var(--pri)');}).join(''):UI.empty('\uD83D\uDCE6','\uAC70\uB798 \uB370\uC774\uD130 \uC5C6\uC74C','\uC5D0\uC2A4\uD06C\uB85C \uAC70\uB798\uAC00 \uC2DC\uC791\uB418\uBA74 \uD45C\uC2DC\uB429\uB2C8\uB2E4'))+'</div></div>';
}

function pgPaySubs(){
  /* Active subscription list */
  var subs=S.subscriptions.length?S.subscriptions:S.users.filter(function(u){return PLAN_PRICE[u.plan];}).map(function(u){return{id:u.id,user_id:u.id,plan:u.plan,billing_cycle:u.billing_cycle||'monthly',amount:PLAN_PRICE[u.plan]?PLAN_PRICE[u.plan].m:0,currency:'USD',status:'active',started_at:u.plan_started_at||u.created_at,current_period_end:u.plan_expires_at,cancel_at_period_end:false,_fromUser:true};});
  var active=subs.filter(function(s){return s.status==='active';});
  var cancelled=subs.filter(function(s){return s.status==='cancelled';});
  var pastDue=subs.filter(function(s){return s.status==='past_due';});
  var subStatusCol={active:'ok',cancelled:'err',past_due:'acc',trialing:'pri',paused:'ghost'};
  var subStatusL={active:'\uD65C\uC131',cancelled:'\uD574\uC9C0',past_due:'\uC5F0\uCCB4',trialing:'\uCCB4\uD5D8',paused:'\uC77C\uC2DC\uC815\uC9C0'};

  /* Pricing table */
  var pricingTable='<div class="card" style="margin-bottom:16px"><div class="card-h">ìš”ê¸ˆì œ â€” ë°”ì´ì–´ (USD)</div><div class="card-b"><table class="tbl"><thead><tr><th>í”Œëœ</th><th>ì›”ê°„</th><th>6ê°œì›” (10%â†“)</th><th>ì—°ê°„ (20%â†“)</th><th>ì£¼ìš” ê¸°ëŠ¥</th></tr></thead><tbody>'+
    ['starter','pro','enterprise'].map(function(p){var pr=PLAN_PRICE_BUYER[p];if(!pr)return'';var r=U.pl(p);
      var features={starter:'ê²€ìƒ‰ 30íšŒ/ì›”, ë¦¬í¬íŠ¸ 1ê±´, ì¸ì½°ì´ë¦¬ 15ê±´',pro:'ê²€ìƒ‰ 200íšŒ/ì›”, ë¬´ì œí•œ ë¦¬í¬íŠ¸, ê³µì¥ì»¨íƒ í• ì¸, ìš°ì„ ë§¤ì¹­',enterprise:'ì „ë‹´ë§¤ë‹ˆì €, ë¬´ì œí•œ ê²€ìƒ‰, ì»¤ìŠ¤í…€ ë¦¬í¬íŠ¸, ë¬¼ë¥˜/ì„œë¥˜ í¬í•¨'};
      return '<tr><td>'+UI.pb(p)+'</td><td style="font-family:JetBrains Mono;font-weight:700">$'+pr.m+'/mo</td><td style="font-family:JetBrains Mono">$'+pr.s+'</td><td style="font-family:JetBrains Mono">$'+pr.a+'</td><td style="font-size:11px;color:var(--w60)">'+(features[p]||'')+'</td></tr>';
    }).join('')+'</tbody></table></div></div>'+
    '<div class="card" style="margin-bottom:16px"><div class="card-h">ìš”ê¸ˆì œ â€” ì œì¡°ì‚¬ (KRW)</div><div class="card-b"><table class="tbl"><thead><tr><th>í”Œëœ</th><th>ì›”ê°„</th><th>ë°”ìš°ì²˜ ì ìš©</th><th>USD í™˜ì‚°</th><th>ì£¼ìš” ê¸°ëŠ¥</th></tr></thead><tbody>'+
    ['starter','pro','alibaba'].map(function(p){var pr=PLAN_PRICE_MFR[p];if(!pr)return'';var r=U.pl(p);
      var features={starter:'AIë¶„ì„ 10íšŒ/ì›”, ì„œë¥˜ìƒì„±, ìˆ˜ì¶œì²´í¬ë¦¬ìŠ¤íŠ¸',pro:'ë¬´ì œí•œ ë¶„ì„, ì „ë‹´ë§¤ë‹ˆì €, ë°”ì´ì–´ë§¤ì¹­ 1ê±´/ì›”, ì—ìŠ¤í¬ë¡œ 2.0%',alibaba:'ì•Œë¦¬ë°”ë°” ì…ì  ì…‹ì—… (1íšŒ) + ì¹´í…Œê³ ë¦¬ë³„ ì»¤ë¯¸ì…˜ 2~5%'};
      var vPrice=p==='alibaba'?'â‚©'+Number(pr.setup_voucher).toLocaleString('ko-KR')+'<br><span style="font-size:10px">(85% ì§€ì›)</span>':'â‚©'+Number(Math.round(pr.krw_m*0.3)).toLocaleString('ko-KR')+'<br><span style="font-size:10px">(70% ì§€ì›)</span>';
      var monthly=p==='alibaba'?'â‚©'+Number(pr.setup_total).toLocaleString('ko-KR')+' <span style="font-size:10px">(1íšŒ)</span>':'â‚©'+Number(pr.krw_m).toLocaleString('ko-KR')+'/ì›”';
      return '<tr><td>'+UI.pb(p)+'</td><td style="font-family:JetBrains Mono;font-weight:700">'+monthly+'</td><td style="font-family:JetBrains Mono;color:var(--ok)">'+vPrice+'</td><td style="font-family:JetBrains Mono;color:var(--w40)">~$'+pr.m+'/mo</td><td style="font-size:11px;color:var(--w60)">'+(features[p]||'')+'</td></tr>';
    }).join('')+'</tbody></table>'+
    '<div style="margin-top:8px;padding:8px 12px;border-radius:6px;background:var(--w08);font-size:11px;color:var(--w40)">â€» ìˆ˜ì¶œë°”ìš°ì²˜ 70% / í˜ì‹ ë°”ìš°ì²˜ 85% ì •ë¶€ì§€ì› Â· ì—°ê°„ê²°ì œ 17% í• ì¸ Â· ë¶€ê°€ì„¸ ë³„ë„</div></div></div>';

  return '<div class="grid-4" style="margin-bottom:16px">'+
    UI.stat('\uD65C\uC131 \uAD6C\uB3C5',active.length,'\uC6D4 '+U.usd(calcMRR()),'var(--ok)')+
    UI.stat('\uD574\uC9C0',cancelled.length,'','var(--err)')+
    UI.stat('\uC5F0\uCCB4',pastDue.length,'','var(--acc)')+
    UI.stat('\uC804\uCCB4',subs.length,'','var(--pri)')+
  '</div>'+
  pricingTable+
  '<div class="card"><div class="card-h"><span>\uAD6C\uB3C5 \uBAA9\uB85D</span>'+UI.badge(subs.length+'\uAC74','pri')+'</div><div class="card-b" style="padding:0"><table class="tbl"><thead><tr><th>\uC720\uC800</th><th>\uD50C\uB79C</th><th>\uC8FC\uAE30</th><th>\uAE08\uC561</th><th>\uC0C1\uD0DC</th><th>\uACB0\uC81C</th><th>\uC2DC\uC791\uC77C</th><th>\uB9CC\uB8CC\uC77C</th><th>\uC790\uB3D9\uAC31\uC2E0</th></tr></thead><tbody>'+
  (subs.length?subs.map(function(s){
    var stripeLink=s.stripe_subscription_id?'<a href="https://dashboard.stripe.com/subscriptions/'+s.stripe_subscription_id+'" target="_blank" style="font-size:10px;font-family:JetBrains Mono;color:var(--pri)">'+s.stripe_subscription_id.slice(0,12)+'...</a>':s.toss_billing_key?'<span style="font-size:10px;padding:2px 6px;border-radius:4px;background:rgba(49,130,246,.1);color:#3182F6;font-weight:600">Toss</span>':s.payment_method==='toss'?'<span style="font-size:10px;color:#3182F6">Toss</span>':'<span style="font-size:10px;color:var(--w20)">'+(s._fromUser?'manual':'â€”')+'</span>';
    return '<tr><td style="font-size:12px">'+getUserName(s.user_id)+'</td><td>'+UI.pb(s.plan)+'</td><td style="font-size:12px">'+(CYCLE_L[s.billing_cycle]||s.billing_cycle)+'</td><td style="font-family:JetBrains Mono;font-weight:700">'+U.usd(s.amount)+'</td><td>'+UI.badge(subStatusL[s.status]||s.status,subStatusCol[s.status]||'ghost')+'</td><td>'+stripeLink+'</td><td style="font-size:12px;color:var(--w40)">'+U.fd(s.started_at)+'</td><td style="font-size:12px;color:var(--w40)">'+(s.current_period_end?U.fd(s.current_period_end):'\u2014')+'</td><td style="text-align:center">'+(s.cancel_at_period_end?'<span style="color:var(--err);font-size:11px">\uB2E4\uC74C\uAE30\uAC04 \uD574\uC9C0</span>':'<span style="color:var(--ok);font-size:11px">\u2713</span>')+'</td></tr>';
  }).join(''):'<tr><td colspan="9">'+UI.empty('\uD83D\uDCB3','\uAD6C\uB3C5 \uC5C6\uC74C','')+'</td></tr>')+
  '</tbody></table></div></div>';
}

function pgPayEscrow(){
  var hold=calcEscrowHold();var comm=calcEscrowComm();var flt=calcFloat();
  var active=S.escrowTxns.filter(function(e){return['funded','in_production','shipped','inspection'].indexOf(e.escrow_status)>=0;});
  var released=S.escrowTxns.filter(function(e){return e.escrow_status==='released';});
  var totalVol=S.escrowTxns.reduce(function(s,e){return s+(Number(e.amount)||0);},0);
  var avgComm=released.length?comm/released.length:0;
  var avgDays=released.length?released.reduce(function(s,e){return s+(e.float_days||0);},0)/released.length:0;

  /* Escrow flow diagram */
  var flow='<div class="card" style="margin-bottom:16px"><div class="card-h">\uC5D0\uC2A4\uD06C\uB85C \uD50C\uB85C\uC6B0</div><div class="card-b"><div style="display:flex;align-items:center;gap:4px;overflow-x:auto;padding:8px 0">'+
    [{icon:'\uD83D\uDCB0',label:'\uBC14\uC774\uC5B4 \uC785\uAE08',desc:'\uAC70\uB798\uAE08\uC561 \uC608\uCE58'},{icon:'\uD83C\uDFE6',label:'Whistle \uBCF4\uC720',desc:'\uC548\uC804\uACB0\uC81C \uC608\uCE58\uAE08'},{icon:'\uD83C\uDFED',label:'\uC0DD\uC0B0/\uC120\uC801',desc:'\uC81C\uC870\uC0AC \uC0DD\uC0B0 \uC9C4\uD589'},{icon:'\uD83D\uDD0D',label:'\uBC14\uC774\uC5B4 \uAC80\uC218',desc:'\uC218\uB839 \uD655\uC778'},{icon:'\u2705',label:'\uC81C\uC870\uC0AC \uC815\uC0B0',desc:'\uC218\uC218\uB8CC \uCC28\uAC10 \uC1A1\uAE08'}].map(function(s,i,a){
      return '<div style="flex:1;min-width:100px;text-align:center;padding:12px 8px;border-radius:10px;background:var(--w08)"><div style="font-size:22px">'+s.icon+'</div><div style="font-size:11px;font-weight:700;color:var(--w70);margin-top:4px">'+s.label+'</div><div style="font-size:9px;color:var(--w40);margin-top:2px">'+s.desc+'</div></div>'+(i<a.length-1?'<div style="font-size:16px;color:var(--w20);flex-shrink:0">\u2192</div>':'');
    }).join('')+
  '</div><div style="margin-top:12px;padding:12px;border-radius:8px;background:rgba(0,212,255,.05);border:1px solid rgba(0,212,255,.15)"><div style="font-size:12px;color:var(--pri);font-weight:700">\uD83D\uDCA1 \uC218\uC775\uBAA8\uB378</div><div style="font-size:11px;color:var(--w60);margin-top:4px">\u2022 \uAC70\uB798 \uC218\uC218\uB8CC: \uAC70\uB798\uC561\uC758 2.5% (default) \u2014 \uC815\uC0B0\uC2DC \uCC28\uAC10<br>\u2022 \uD50C\uB85C\uD2B8 \uC218\uC775: \uBCF4\uC720\uAE08 \xD7 \uBCF4\uC720\uC77C\uC218 \xD7 \uC77C\uC77C\uAE08\uB9AC (0.01%~0.02%) \u2014 \uC790\uAE08 \uBCF4\uC720 \uAE30\uAC04 \uC774\uC790 \uC218\uC775<br>\u2022 \uD658\uC728 \uB9C8\uC9C4: \uD658\uC804 \uC2DC\uC810 \uCC28\uC774\uC5D0 \uC758\uD55C \uCD94\uAC00 \uC218\uC775 (\uD5A5\uD6C4)</div></div></div></div>';

  return '<div class="grid-5" style="margin-bottom:16px">'+
    UI.stat('\uBCF4\uC720 \uC911',U.usd(hold),active.length+'\uAC74','var(--pri)')+
    UI.stat('\uCD1D \uAC70\uB798\uB7C9',U.usd(totalVol),S.escrowTxns.length+'\uAC74','var(--acc)')+
    UI.stat('\uB204\uC801 \uC218\uC218\uB8CC',U.usd(comm),released.length+'\uAC74 \uC815\uC0B0','var(--ok)')+
    UI.stat('\uD3C9\uADE0 \uBCF4\uC720\uC77C',Math.round(avgDays)+'\uC77C','','var(--purple)')+
    UI.stat('\uD50C\uB85C\uD2B8 \uC218\uC775',U.usd(flt),'\uC790\uAE08\uBCF4\uC720 \uC774\uC790','var(--admin)')+
  '</div>'+
  flow+
  '<div class="card"><div class="card-h"><span>\uC5D0\uC2A4\uD06C\uB85C \uAC70\uB798 \uBAA9\uB85D</span>'+UI.badge(S.escrowTxns.length+'\uAC74','pri')+'</div><div class="card-b" style="padding:0"><table class="tbl"><thead><tr><th>\uC81C\uC870\uC0AC</th><th>\uBC14\uC774\uC5B4</th><th>\uC0C1\uD488</th><th>\uAE08\uC561</th><th>\uC0C1\uD0DC</th><th>\uC218\uC218\uB8CC</th><th>\uBCF4\uC720\uC77C</th><th>\uC785\uAE08\uC77C</th></tr></thead><tbody>'+
  (S.escrowTxns.length?S.escrowTxns.map(function(e){
    return '<tr><td style="font-size:12px">'+getUserName(e.seller_id)+'</td><td style="font-size:12px">'+getBuyerName(e.buyer_id)+'</td><td style="font-size:12px">'+U.tr(e.product_name,20)+'</td><td style="font-family:JetBrains Mono;font-weight:700">'+U.usd(e.amount)+'</td><td>'+escBadge(e.escrow_status)+'</td><td style="font-family:JetBrains Mono;font-size:12px;color:var(--ok)">'+(e.commission_amount?U.usd(e.commission_amount):((e.commission_rate||2.5)+'%'))+'</td><td style="font-family:JetBrains Mono;font-size:12px">'+(e.float_days||'\u2014')+'</td><td style="font-size:12px;color:var(--w40)">'+(e.deposit_at?U.fd(e.deposit_at):'\u2014')+'</td></tr>';
  }).join(''):'<tr><td colspan="8">'+UI.empty('\uD83C\uDFE6','\uC5D0\uC2A4\uD06C\uB85C \uAC70\uB798 \uC5C6\uC74C','\uBC14\uC774\uC5B4-\uC81C\uC870\uC0AC \uAC70\uB798\uAC00 \uC2DC\uC791\uB418\uBA74 \uD45C\uC2DC\uB429\uB2C8\uB2E4')+'</td></tr>')+
  '</tbody></table></div></div>';
}

function pgPayPolicy(){
  return '<div class="grid-2" style="margin-bottom:16px">'+
    '<div class="card"><div class="card-h">\uD83D\uDCDC \uAD6C\uB3C5 \uCDE8\uC18C/\uD658\uBD88 \uC815\uCC45</div><div class="card-b">'+
      '<div style="margin-bottom:16px"><div style="font-size:14px;font-weight:700;color:var(--pri);margin-bottom:10px">\uC6D4\uAC04 \uAD6C\uB3C5</div>'+
        '<div style="padding:10px 14px;border-radius:8px;background:var(--w08);margin-bottom:8px"><div style="font-size:12px;font-weight:600;color:var(--w70)">\u2022 \uACB0\uC81C \uD6C4 \uD658\uBD88 \uBD88\uAC00</div><div style="font-size:11px;color:var(--w40);margin-top:2px">\uB514\uC9C0\uD138 \uC11C\uBE44\uC2A4 \uD2B9\uC131\uC0C1 \uC989\uC2DC \uC81C\uACF5\uB418\uBBC0\uB85C \uACB0\uC81C \uD6C4 \uD658\uBD88 \uBD88\uAC00</div></div>'+
        '<div style="padding:10px 14px;border-radius:8px;background:var(--w08);margin-bottom:8px"><div style="font-size:12px;font-weight:600;color:var(--w70)">\u2022 \uB2E4\uC74C \uAE30\uAC04\uBD80\uD130 \uD574\uC9C0 \uAC00\uB2A5</div><div style="font-size:11px;color:var(--w40);margin-top:2px">\uD604\uC7AC \uACB0\uC81C \uAE30\uAC04 \uB05D\uAE4C\uC9C0 \uC11C\uBE44\uC2A4 \uC774\uC6A9 \u2192 \uB2E4\uC74C \uACB0\uC81C\uC77C\uBD80\uD130 \uC790\uB3D9 \uD574\uC9C0</div></div>'+
        '<div style="padding:10px 14px;border-radius:8px;background:var(--w08)"><div style="font-size:12px;font-weight:600;color:var(--w70)">\u2022 \uBCC0\uACBD: \uC5B8\uC81C\uB4E0 \uC0C1\uC704 \uD50C\uB79C\uC73C\uB85C \uBCC0\uACBD \uAC00\uB2A5</div><div style="font-size:11px;color:var(--w40);margin-top:2px">\uD558\uC704 \uD50C\uB79C\uC740 \uD604\uC7AC \uAE30\uAC04 \uC885\uB8CC \uD6C4 \uC801\uC6A9</div></div>'+
      '</div>'+
      '<div style="margin-bottom:16px"><div style="font-size:14px;font-weight:700;color:var(--acc);margin-bottom:10px">6\uAC1C\uC6D4 / \uC5F0\uAC04 \uAD6C\uB3C5</div>'+
        '<div style="padding:10px 14px;border-radius:8px;background:var(--w08);margin-bottom:8px"><div style="font-size:12px;font-weight:600;color:var(--w70)">\u2022 \uC911\uB3C4 \uD574\uC9C0\uC2DC \uC794\uC5EC\uAE30\uAC04 \uC77C\uD560\uACC4\uC0B0 \uD658\uBD88</div><div style="font-size:11px;color:var(--w40);margin-top:2px">\uD560\uC778\uC561 \uCC28\uAC10 \uD6C4 \uC794\uC5EC \uAE08\uC561 \uD658\uBD88 (\uC6D4\uAC04 \uC815\uAC00 \uAE30\uC900 \uC7AC\uACC4\uC0B0)</div></div>'+
        '<div style="padding:10px 14px;border-radius:8px;background:var(--w08)"><div style="font-size:12px;font-weight:600;color:var(--w70)">\u2022 \uCCAD\uC57D\uCCA0\uD68C: \uACB0\uC81C\uC77C\uBD80\uD130 7\uC77C \uC774\uB0B4</div><div style="font-size:11px;color:var(--w40);margin-top:2px">\uC804\uC790\uC0C1\uAC70\uB798\uBC95 \uC81C17\uC870 \uCCAD\uC57D\uCCA0\uD68C\uAD8C (\uC11C\uBE44\uC2A4 \uC774\uC6A9 \uC804 \uC804\uC561 \uD658\uBD88)</div></div>'+
      '</div>'+
    '</div></div>'+
    '<div class="card"><div class="card-h">\uD83C\uDFE6 \uC5D0\uC2A4\uD06C\uB85C \uAC70\uB798 \uC815\uCC45</div><div class="card-b">'+
      '<div style="margin-bottom:16px"><div style="font-size:14px;font-weight:700;color:var(--ok);margin-bottom:10px">\uBC14\uC774\uC5B4 \uBCF4\uD638</div>'+
        '<div style="padding:10px 14px;border-radius:8px;background:var(--w08);margin-bottom:8px"><div style="font-size:12px;font-weight:600;color:var(--w70)">\u2022 \uBC14\uC774\uC5B4 \uAC80\uC218 \uC644\uB8CC \uC804\uAE4C\uC9C0 Whistle\uAC00 \uC790\uAE08 \uBCF4\uC720</div><div style="font-size:11px;color:var(--w40);margin-top:2px">\uC81C\uC870\uC0AC\uC5D0\uAC8C \uBC14\uB85C \uC1A1\uAE08\uB418\uC9C0 \uC54A\uC544 \uC548\uC804 \uBCF4\uC7A5</div></div>'+
        '<div style="padding:10px 14px;border-radius:8px;background:var(--w08);margin-bottom:8px"><div style="font-size:12px;font-weight:600;color:var(--w70)">\u2022 \uBD84\uC7C1 \uBC1C\uC0DD\uC2DC Whistle \uC911\uC7AC</div><div style="font-size:11px;color:var(--w40);margin-top:2px">\uC591\uCE21 \uC99D\uBE59 \uD655\uC778 \uD6C4 \uACF5\uC815\uD55C \uC815\uC0B0 \uC9C4\uD589</div></div>'+
        '<div style="padding:10px 14px;border-radius:8px;background:var(--w08)"><div style="font-size:12px;font-weight:600;color:var(--w70)">\u2022 \uC804\uC561 \uD658\uBD88: \uC81C\uC870\uC0AC \uC0DD\uC0B0 \uC2DC\uC791 \uC804</div><div style="font-size:11px;color:var(--w40);margin-top:2px">\uC0DD\uC0B0 \uC2DC\uC791 \uD6C4\uC5D0\uB294 \uC2E4\uC81C \uBC1C\uC0DD \uBE44\uC6A9 \uCC28\uAC10 \uD6C4 \uD658\uBD88</div></div>'+
      '</div>'+
      '<div><div style="font-size:14px;font-weight:700;color:var(--admin);margin-bottom:10px">ìˆ˜ìˆ˜ë£Œ êµ¬ì¡° (3ì¢… ë¶„ë¦¬)</div>'+
        '<div style="padding:10px 14px;border-radius:8px;background:var(--w08);margin-bottom:8px"><div style="font-size:12px;font-weight:700;color:var(--pri);margin-bottom:4px">â‘  ì—ìŠ¤í¬ë¡œ ìˆ˜ìˆ˜ë£Œ (ê±°ë˜ ì •ì‚°ì‹œ)</div><div style="font-size:12px;font-weight:600;color:var(--w70)">â€¢ ê¸°ë³¸: ê±°ë˜ì•¡ì˜ 2.5% â€” Pro/Alibaba í”Œëœ: 2.0%</div><div style="font-size:11px;color:var(--w40);margin-top:2px">ì •ì‚°ì‹œ ì œì¡°ì‚¬ ì†¡ê¸ˆì•¡ì—ì„œ ì°¨ê°. ë°”ì´ì–´-ì œì¡°ì‚¬ ì§ê±°ë˜ ì—ìŠ¤í¬ë¡œ ë³´í˜¸</div></div>'+
        '<div style="padding:10px 14px;border-radius:8px;background:var(--w08);margin-bottom:8px"><div style="font-size:12px;font-weight:700;color:var(--acc);margin-bottom:4px">â‘¡ ì•Œë¦¬ë°”ë°” ì´íŒ ìˆ˜ì¶œ ì»¤ë¯¸ì…˜ (FOB ê¸°ì¤€)</div><div style="font-size:12px;font-weight:600;color:var(--w70)">â€¢ ë·°í‹° 5% Â· ì‹í’ˆ 4% Â· ì „ìIT 3% Â· íŒ¨ì…˜ 5% Â· ìƒí™œ 3% Â· ì‚°ì—… 2%</div><div style="font-size:11px;color:var(--w40);margin-top:2px">ì´íŒ ëª¨ë¸ ì „ìš©. ë…ë¦½ ëª¨ë¸(ìì²´ ì•Œë¦¬ë°”ë°” ê³„ì •)ì€ ì»¤ë¯¸ì…˜ 0%</div></div>'+
        '<div style="padding:10px 14px;border-radius:8px;background:var(--w08);margin-bottom:8px"><div style="font-size:12px;font-weight:700;color:var(--ok);margin-bottom:4px">â‘¢ ë°”ì´ì–´ ì†Œì‹± ëŒ€í–‰ ìˆ˜ìˆ˜ë£Œ</div><div style="font-size:12px;font-weight:600;color:var(--w70)">â€¢ &lt;$3K: ê³ ì • $300 Â· $3K~30K: 8% Â· $30K~100K: 5% Â· $100K+: 3%</div><div style="font-size:11px;color:var(--w40);margin-top:2px">ë°”ì´ì–´ê°€ ì†Œì‹± ëŒ€í–‰ ìš”ì²­ì‹œ ì ìš©. ì§ì ‘ ê±°ë˜(ì—ìŠ¤í¬ë¡œ)ì™€ ë³„ê°œ</div></div>'+
        '<div style="padding:10px 14px;border-radius:8px;background:var(--w08)"><div style="font-size:12px;font-weight:700;color:var(--purple);margin-bottom:4px">â‘£ í”Œë¡œíŠ¸ ìˆ˜ìµ (ìê¸ˆë³´ìœ  ì´ì)</div><div style="font-size:12px;font-weight:600;color:var(--w70)">â€¢ ë³´ìœ ê¸ˆ Ã— ì¼ìˆ˜ Ã— 0.01~0.02% ì¼ì¼ê¸ˆë¦¬</div><div style="font-size:11px;color:var(--w40);margin-top:2px">ì—ìŠ¤í¬ë¡œ ì˜ˆì¹˜ê¸ˆ ë³´ìœ ê¸°ê°„ ë™ì•ˆ ë°œìƒí•˜ëŠ” ê¸ˆìœµ ìˆ˜ìµ</div></div>'+
      '</div>'+
    '</div></div>'+
  '</div>'+

  '<div class="card" style="margin-bottom:16px"><div class="card-h">\uD83D\uDCCB \uBC95\uC801 \uADFC\uAC70</div><div class="card-b">'+
    '<div class="grid-2" style="gap:12px">'+
      '<div style="padding:12px;border-radius:8px;background:var(--w08)"><div style="font-size:12px;font-weight:700;color:var(--pri);margin-bottom:6px">\uC804\uC790\uC0C1\uAC70\uB798\uBC95 \uC81C17\uC870</div><div style="font-size:11px;color:var(--w60)">\uCCAD\uC57D\uCCA0\uD68C: \uACC4\uC57D\uC11C \uBC1B\uC740 \uB0A0 / \uC7AC\uD654 \uC218\uB839\uC77C\uBD80\uD130 7\uC77C \uC774\uB0B4. \uB2E8, \uB514\uC9C0\uD138 \uCF58\uD150\uCE20/\uC11C\uBE44\uC2A4\uB294 \uC774\uC6A9 \uC2DC\uC791 \uC2DC \uC608\uC678 \uAC00\uB2A5.</div></div>'+
      '<div style="padding:12px;border-radius:8px;background:var(--w08)"><div style="font-size:12px;font-weight:700;color:var(--acc);margin-bottom:6px">\uC804\uC790\uAE08\uC735\uAC70\uB798\uBC95 \uC81C46\uC870</div><div style="font-size:11px;color:var(--w60)">\uC804\uC790\uC9C0\uAE09\uACB0\uC81C \uC5D0\uC2A4\uD06C\uB85C: \uAD6C\uB9E4\uC790\uC640 \uD310\uB9E4\uC790 \uAC04 \uC548\uC804\uACB0\uC81C \uC911\uAC1C. \uC0C1\uD488/\uC6A9\uC5ED \uC218\uB839 \uD655\uC778 \uD6C4 \uB300\uAE08 \uC9C0\uAE09.</div></div>'+
      '<div style="padding:12px;border-radius:8px;background:var(--w08)"><div style="font-size:12px;font-weight:700;color:var(--ok);margin-bottom:6px">\uC678\uAD6D\uD658\uAC70\uB798\uBC95</div><div style="font-size:11px;color:var(--w60)">\uAD6D\uC81C \uAC70\uB798 \uACB0\uC81C \uB300\uD589 \uC2DC \uD658\uC804 \uBC0F \uC1A1\uAE08 \uADDC\uC815 \uC900\uC218 \uD544\uC694. PG\uC0AC \uC5F0\uB3D9 \uD544\uC218.</div></div>'+
      '<div style="padding:12px;border-radius:8px;background:var(--w08)"><div style="font-size:12px;font-weight:700;color:var(--purple);margin-bottom:6px">\uC18C\uBE44\uC790\uBD84\uC7C1\uC870\uC815\uBC95</div><div style="font-size:11px;color:var(--w60)">B2B \uAC70\uB798\uC5D0\uB3C4 \uC900\uC6A9 \uAC00\uB2A5. \uBD84\uC7C1 \uBC1C\uC0DD\uC2DC \uC870\uC815\uC704\uC6D0\uD68C \uC911\uC7AC \uC808\uCC28 \uAC00\uC774\uB4DC \uC81C\uACF5.</div></div>'+
    '</div>'+
  '</div></div>'+

  /* Recent cancellations */
  (function(){
    var cancelled=S.subscriptions.filter(function(s){return s.status==='cancelled'||s.cancel_at_period_end;});
    if(!cancelled.length)return '';
    return '<div class="card"><div class="card-h"><span>\uD574\uC9C0/\uD574\uC9C0\uC608\uC815</span>'+UI.badge(cancelled.length+'\uAC74','err')+'</div><div class="card-b" style="padding:0"><table class="tbl"><thead><tr><th>\uC720\uC800</th><th>\uD50C\uB79C</th><th>\uC0C1\uD0DC</th><th>\uD574\uC9C0\uC77C</th></tr></thead><tbody>'+
    cancelled.map(function(s){return '<tr><td>'+getUserName(s.user_id)+'</td><td>'+UI.pb(s.plan)+'</td><td>'+UI.badge(s.cancel_at_period_end?'\uB2E4\uC74C\uAE30\uAC04 \uD574\uC9C0':'err',s.cancel_at_period_end?'acc':'err')+'</td><td style="font-size:12px;color:var(--w40)">'+(s.cancelled_at?U.fd(s.cancelled_at):'\u2014')+'</td></tr>';}).join('')+
    '</tbody></table></div></div>';
  })();
}

/* ============ ACTIONS ============ */
function editUserPlan(uid){
  var u=S.users.find(function(x){return x.id===uid;});if(!u)return;
  var plan=prompt('í”Œëœ ë³€ê²½ (free/starter/pro/alibaba):',u.plan==='basic'?'starter':(u.plan||'free'));
  if(!plan||!['free','starter','basic','pro','alibaba'].includes(plan))return;
  sb.from('users').update({plan:plan,plan_started_at:new Date().toISOString()}).eq('id',uid).then(function(r){
    if(r.error){UI.toast('ì‹¤íŒ¨','err');return;}
    u.plan=plan;S.selectedUser=u;render();UI.toast('í”Œëœ ë³€ê²½: '+plan.toUpperCase(),'ok');
  });
}

function editUserRole(uid){
  var u=S.users.find(function(x){return x.id===uid;});if(!u)return;
  var role=prompt('ì—­í•  ë³€ê²½ (client/admin/buyer):',u.role||'client');
  if(!role||!['client','admin','buyer'].includes(role))return;
  sb.from('users').update({role:role}).eq('id',uid).then(function(r){
    if(r.error){UI.toast('ì‹¤íŒ¨','err');return;}
    u.role=role;S.selectedUser=u;render();UI.toast('ì—­í•  ë³€ê²½: '+role,'ok');
  });
}

function toggleUserActive(uid,active){
  var val=active==='true';
  sb.from('users').update({is_active:val}).eq('id',uid).then(function(r){
    if(r.error){UI.toast('ì‹¤íŒ¨','err');return;}
    var u=S.users.find(function(x){return x.id===uid;});
    if(u){u.is_active=val;S.selectedUser=u;}
    render();UI.toast(val?'í™œì„±í™”':'ë¹„í™œì„±í™”','ok');
  });
}

function updateAStatus(aid,status){
  sb.from('analyses').update({status:status}).eq('id',aid).then(function(r){
    if(r.error){UI.toast('ì‹¤íŒ¨','err');return;}
    var a=S.analyses.find(function(x){return x.id===aid;});
    if(a){a.status=status;S.selectedAnalysis=a;}
    render();UI.toast('ìƒíƒœ ë³€ê²½','ok');
  });
}

function deleteAnalysis(aid){
  if(!confirm('ì´ ë¶„ì„ì„ ì‚­ì œí• ê¹Œìš”?'))return;
  sb.from('analyses').delete().eq('id',aid).then(function(r){
    if(r.error){UI.toast('ì‚­ì œ ì‹¤íŒ¨','err');return;}
    S.analyses=S.analyses.filter(function(a){return a.id!==aid;});
    S.selectedAnalysis=null;render();UI.toast('ì‚­ì œ ì™„ë£Œ','ok');
  });
}

function updateSR(id){
  var status=document.querySelector('[name=sr_status]');
  var price=document.querySelector('[name=sr_price]');
  var note=document.querySelector('[name=sr_note]');
  var assigned=document.querySelector('[name=sr_assigned]');
  var priority=document.querySelector('[name=sr_priority]');
  var data={updated_at:new Date().toISOString()};
  if(status)data.status=status.value;
  if(price&&price.value)data.price=Number(price.value);
  if(note)data.admin_notes=note.value;
  if(assigned)data.assigned_to=assigned.value||null;
  if(priority)data.priority=priority.value;
  if(data.status==='processing'&&!data.started_at)data.started_at=new Date().toISOString();
  if(data.status==='completed')data.completed_at=new Date().toISOString();
  sb.from('service_requests').update(data).eq('id',id).then(function(r){
    if(r.error){UI.toast('ì‹¤íŒ¨','err');return;}
    var sr=S.serviceRequests.find(function(x){return x.id===id;});
    if(sr){Object.assign(sr,data);S.selectedSR=sr;}
    render();UI.toast('ì—…ë°ì´íŠ¸ ì™„ë£Œ','ok');
  });
}

function quickSR(id,status){
  var upd={status:status,updated_at:new Date().toISOString()};
  if(status==='processing')upd.started_at=new Date().toISOString();
  if(status==='completed')upd.completed_at=new Date().toISOString();
  sb.from('service_requests').update(upd).eq('id',id).then(function(r){
    if(r.error){UI.toast('ì‹¤íŒ¨','err');return;}
    var sr=S.serviceRequests.find(function(x){return x.id===id;});
    if(sr){Object.assign(sr,upd);S.selectedSR=sr;}
    render();UI.toast('ìƒíƒœ: '+status,'ok');
  });
}

function notifySR(id){
  var sr=S.serviceRequests.find(function(x){return x.id===id;});if(!sr)return;
  var stL={pending:'ì ‘ìˆ˜',accepted:'ë°°ì •',processing:'ì²˜ë¦¬ì¤‘',review:'ê²€í† ',completed:'ì™„ë£Œ',cancelled:'ì·¨ì†Œ'};
  var msg='ğŸ’¼ ì„œë¹„ìŠ¤ ìš”ì²­ ì—…ë°ì´íŠ¸\n'+U.sl(sr.service_type)+'\nìƒíƒœ: '+stL[sr.status]+'\nìœ ì €: '+getUserName(sr.user_id)+'\nê¸´ê¸‰ë„: '+(sr.priority||'normal');
  fetch(RELAY_URL+'/api/telegram/send',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:msg})}).then(function(){UI.toast('í…”ë ˆê·¸ë¨ ì „ì†¡','ok');}).catch(function(){UI.toast('ì „ì†¡ ì‹¤íŒ¨','err');});
}

function deleteSR(id){
  if(!confirm('ì´ ìš”ì²­ì„ ì‚­ì œí• ê¹Œìš”?'))return;
  sb.from('service_requests').delete().eq('id',id).then(function(r){
    if(r.error){UI.toast('ì‹¤íŒ¨','err');return;}
    S.serviceRequests=S.serviceRequests.filter(function(x){return x.id!==id;});
    S.selectedSR=null;render();UI.toast('ì‚­ì œ ì™„ë£Œ','ok');
  });
}

function exportCSV(table){
  var data=S[table==='service_requests'?'serviceRequests':table]||[];
  if(!data.length){UI.toast('ë°ì´í„° ì—†ìŒ','warn');return;}
  var keys=Object.keys(data[0]);
  var csv=keys.join(',')+'\n';
  data.forEach(function(row){
    csv+=keys.map(function(k){var v=row[k];if(v==null)return'';v=String(v).replace(/"/g,'""');return v.indexOf(',')>=0||v.indexOf('\n')>=0?'"'+v+'"':v;}).join(',')+'\n';
  });
  var blob=new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'});
  var url=URL.createObjectURL(blob);
  var a=document.createElement('a');a.href=url;a.download=table+'_'+new Date().toISOString().split('T')[0]+'.csv';a.click();
  URL.revokeObjectURL(url);UI.toast('CSV ë‹¤ìš´ë¡œë“œ','ok');
}

function refreshAll(){loadAll();UI.toast('ìƒˆë¡œê³ ì¹¨ ì¤‘...','info');}

/* ============ NAV & RENDER ============ */
function nav(p){S.page=p;S.searchFilter='';S.tab='all';S.selectedUser=null;S.selectedAnalysis=null;S.selectedSR=null;S.selectedBuyer=null;S.selectedSeller=null;S.selectedMatching=null;S.selectedOrder=null;S.analyticsTab='users';S.paymentTab='revenue';render();var pc=document.querySelector('.page-content');if(pc)pc.scrollTop=0;}
function closeModal(id){UI.hideModal(id);setTimeout(function(){var e=document.getElementById(id);if(e)e.remove();},300);}
function setSearch(v){S.searchFilter=v;render();}
function setTab(t){S.tab=t;render();}

function viewUser(uid){var u=S.users.find(function(x){return x.id===uid;});if(u){S.selectedUser=u;S.page='users';render();}}
function viewAnalysis(aid){var a=S.analyses.find(function(x){return x.id===aid;});if(a){S.selectedAnalysis=a;S.page='analyses';render();}}
function viewSR(id){var sr=S.serviceRequests.find(function(x){return x.id===id;});if(sr){S.selectedSR=sr;S.page='services';render();}}
function viewSeller(uid){var u=S.users.find(function(x){return x.id===uid;});if(u){S.selectedSeller=u;S.page='sellers';render();}}
function viewBuyer(bid){var b=S.buyers.find(function(x){return x.id===bid;});if(b){S.selectedBuyer=b;S.page='buyersMgmt';render();}}
function viewMatching(mid){var m=S.matchings.find(function(x){return x.id===mid;});if(m){S.selectedMatching=m;S.page='matchings';render();}}
function viewOrder(oid){var o=S.orders.find(function(x){return x.id===oid;});if(o){S.selectedOrder=o;S.page='ordersMgmt';render();}}
function setAnalyticsTab(t){S.analyticsTab=t;render();}
function setPaymentTab(t){S.paymentTab=t;render();}

var PL={dashboard:'ğŸ“Š ëŒ€ì‹œë³´ë“œ',analytics:'ğŸ“ˆ ë¶„ì„/í†µê³„',sellers:'ğŸ­ ì œì¡°ì‚¬ ê´€ë¦¬',buyersMgmt:'ğŸŒ ë°”ì´ì–´ ê´€ë¦¬',matchings:'ğŸ¤ ë§¤ì¹­/ë”œ',ordersMgmt:'ğŸ’° ì£¼ë¬¸/ë§¤ì¶œ',payments:'ğŸ’³ ê²°ì œ/ì—ìŠ¤í¬ë¡œ',chat:'ğŸ’¬ ì±„íŒ… ëª¨ë‹ˆí„°',users:'ğŸ‘¥ ìœ ì € ê´€ë¦¬',analyses:'ğŸ”¬ AI ë¶„ì„',services:'ğŸ’¼ ì„œë¹„ìŠ¤ ìš”ì²­',products:'ğŸ“¦ ì œí’ˆ ê´€ë¦¬',projects:'ğŸš€ í”„ë¡œì íŠ¸',documents:'ğŸ“„ ì„œë¥˜',health:'ğŸ›¡ï¸ ì‹œìŠ¤í…œ ìƒíƒœ',settings:'âš™ï¸ ì„¤ì •',alibabaMgmt:'ğŸª ì•Œë¦¬ë°”ë°” ê´€ë¦¬'};

function renderPage(){
  switch(S.page){
    case'dashboard':return pgDash();
    case'analytics':return pgAnalytics();
    case'sellers':return pgSellers();
    case'buyersMgmt':return pgBuyers();
    case'matchings':return pgMatchings();
    case'ordersMgmt':return pgOrders();
    case'payments':return pgPayments();
    case'chat':return pgChat();
    case'users':return pgUsers();
    case'analyses':return pgAnalyses();
    case'services':return pgServiceReq();
    case'products':return pgProducts();
    case'projects':return pgProjects();
    case'documents':return pgDocuments();
    case'health':return pgHealth();
    case'settings':return pgSettings();
    case'alibabaMgmt':return pgAlibabaMgmt();
    default:return pgDash();
  }
}

function renderSidebar(){
  var pendSR=S.serviceRequests.filter(function(s){return s.status==='pending';}).length;
  var analyzingA=S.analyses.filter(function(a){return a.status==='analyzing';}).length;
  var unreadMsgs=S.messages.filter(function(m){return !m.is_read;}).length;
  var activeDeals=S.matchings.filter(function(m){return m.status!=='completed'&&m.status!=='rejected'&&m.status!=='expired';}).length;

  var menu=[
    {id:'dashboard',icon:'ğŸ“Š',label:'ëŒ€ì‹œë³´ë“œ'},
    {id:'analytics',icon:'ğŸ“ˆ',label:'ë¶„ì„/í†µê³„'},
    {id:'div'},
    {id:'sellers',icon:'ğŸ­',label:'ì œì¡°ì‚¬ ê´€ë¦¬',count:S.users.filter(function(u){return u.role==='client';}).length},
    {id:'buyersMgmt',icon:'ğŸŒ',label:'ë°”ì´ì–´ ê´€ë¦¬',count:S.buyers.length},
    {id:'div'},
    {id:'matchings',icon:'ğŸ¤',label:'ë§¤ì¹­/ë”œ',count:activeDeals||null},
    {id:'ordersMgmt',icon:'ğŸ’°',label:'ì£¼ë¬¸/ë§¤ì¶œ'},
    {id:'payments',icon:'ğŸ’³',label:'ê²°ì œ/ì—ìŠ¤í¬ë¡œ'},
    {id:'chat',icon:'ğŸ’¬',label:'ì±„íŒ… ëª¨ë‹ˆí„°',count:unreadMsgs||null},
    {id:'div'},
    {id:'analyses',icon:'ğŸ”¬',label:'ë¶„ì„ ì´ë ¥',count:analyzingA||null},
    {id:'services',icon:'ğŸ’¼',label:'ì„œë¹„ìŠ¤ ìš”ì²­',count:pendSR||null},
    {id:'products',icon:'ğŸ“¦',label:'ì œí’ˆ ê´€ë¦¬'},
    {id:'projects',icon:'ğŸš€',label:'í”„ë¡œì íŠ¸'},
    {id:'documents',icon:'ğŸ“„',label:'ì„œë¥˜'},
    {id:'div'},
    {id:'alibabaMgmt',icon:'ğŸª',label:'ì•Œë¦¬ë°”ë°” ê´€ë¦¬'},
    {id:'div'},
    {id:'health',icon:'ğŸ›¡ï¸',label:'ì‹œìŠ¤í…œ ìƒíƒœ'},
    {id:'settings',icon:'âš™ï¸',label:'ì„¤ì •'}
  ];
  return '<div class="sidebar"><div class="sidebar-header"><div class="sidebar-logo">W</div><div><div class="sidebar-title">Whistle AI</div><div class="sidebar-sub">ADMIN</div></div></div><div class="sidebar-nav">'+menu.map(function(m){
    if(m.id==='div')return '<div class="nav-section"></div>';
    return '<div class="nav-item '+(S.page===m.id?'active':'')+'" onclick="Adm.nav(\''+m.id+'\')"><span class="icon">'+m.icon+'</span><span>'+m.label+'</span>'+(m.count?'<span class="badge-count">'+m.count+'</span>':'')+'</div>';
  }).join('')+'</div><div class="sidebar-footer"><div style="padding:8px 12px;font-size:11px;color:var(--w40)"><div style="font-weight:600">'+(S.user?S.user.email:'')+'</div><div style="font-size:10px;margin-top:2px">Admin</div></div><div class="nav-item" onclick="Adm.doLogout()" style="color:var(--w40);margin-top:4px"><span class="icon">ğŸšª</span><span>ë¡œê·¸ì•„ì›ƒ</span></div></div></div>';
}

function render(){
  var app=document.getElementById('app');
  if(S.loading){app.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100vh"><div style="text-align:center"><div class="spinner" style="width:40px;height:40px;border-width:4px;margin:0 auto 16px"></div><div style="font-size:14px;color:var(--w40)">Admin ë¡œë”© ì¤‘...</div></div></div>';return;}
  if(!S.user){app.innerHTML=pgAuth();return;}
  app.innerHTML='<div class="app-layout">'+renderSidebar()+'<div class="mob-overlay" onclick="Adm.closeMob()"></div><div class="main-area"><div class="topbar"><div style="display:flex;align-items:center;gap:10px"><button class="mob-toggle" onclick="Adm.toggleMob()">â˜°</button><div class="topbar-title">'+(PL[S.page]||'')+'<span class="admin-tag">ADMIN</span></div></div><div style="display:flex;align-items:center;gap:12px"><button class="btn btn-ghost btn-sm" onclick="Adm.refreshAll()" style="font-size:11px">ğŸ”„</button><span style="font-size:13px;color:var(--w40)">'+S.user.email+'</span><div style="width:30px;height:30px;border-radius:8px;background:var(--admin-g);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:800;color:var(--w)">A</div></div></div><div class="page-content">'+renderPage()+'</div></div></div>';
}

/* === BUYER FORM === */
function showBuyerForm(){
  var body=
    '<div style="display:flex;flex-direction:column;gap:10px">'+
    '<div class="grid-2"><div><label style="font-size:11px;font-weight:700;color:var(--w40)">íšŒì‚¬ëª… *</label><input id="bf-company" placeholder="íšŒì‚¬ëª…" style="width:100%;padding:10px;border-radius:8px;background:var(--sf);border:1px solid var(--bd);color:var(--w90);font-size:12px"></div><div><label style="font-size:11px;font-weight:700;color:var(--w40)">ë‹´ë‹¹ì</label><input id="bf-contact" placeholder="ë‹´ë‹¹ì ì´ë¦„" style="width:100%;padding:10px;border-radius:8px;background:var(--sf);border:1px solid var(--bd);color:var(--w90);font-size:12px"></div></div>'+
    '<div class="grid-2"><div><label style="font-size:11px;font-weight:700;color:var(--w40)">ì´ë©”ì¼</label><input id="bf-email" type="email" placeholder="email@company.com" style="width:100%;padding:10px;border-radius:8px;background:var(--sf);border:1px solid var(--bd);color:var(--w90);font-size:12px"></div><div><label style="font-size:11px;font-weight:700;color:var(--w40)">ì „í™”</label><input id="bf-phone" placeholder="+1-xxx" style="width:100%;padding:10px;border-radius:8px;background:var(--sf);border:1px solid var(--bd);color:var(--w90);font-size:12px"></div></div>'+
    '<div class="grid-2"><div><label style="font-size:11px;font-weight:700;color:var(--w40)">êµ­ê°€ *</label><select id="bf-country" style="width:100%;padding:10px;border-radius:8px;background:var(--sf);border:1px solid var(--bd);color:var(--w90);font-size:12px"><option value="">ì„ íƒ</option><option value="US">US</option><option value="JP">JP</option><option value="CN">CN</option><option value="DE">DE</option><option value="GB">GB</option><option value="SG">SG</option><option value="VN">VN</option><option value="AE">AE</option><option value="TH">TH</option><option value="AU">AU</option><option value="CA">CA</option><option value="FR">FR</option><option value="IN">IN</option><option value="ID">ID</option><option value="MY">MY</option><option value="PH">PH</option><option value="SA">SA</option><option value="NL">NL</option><option value="IT">IT</option><option value="ES">ES</option></select></div><div><label style="font-size:11px;font-weight:700;color:var(--w40)">ë„ì‹œ</label><input id="bf-city" placeholder="ë„ì‹œ" style="width:100%;padding:10px;border-radius:8px;background:var(--sf);border:1px solid var(--bd);color:var(--w90);font-size:12px"></div></div>'+
    '<div><label style="font-size:11px;font-weight:700;color:var(--w40)">ì›¹ì‚¬ì´íŠ¸</label><input id="bf-web" placeholder="https://..." style="width:100%;padding:10px;border-radius:8px;background:var(--sf);border:1px solid var(--bd);color:var(--w90);font-size:12px"></div>'+
    '<div class="grid-2"><div><label style="font-size:11px;font-weight:700;color:var(--w40)">ì†ŒìŠ¤</label><select id="bf-source" style="width:100%;padding:10px;border-radius:8px;background:var(--sf);border:1px solid var(--bd);color:var(--w90);font-size:12px" onchange="document.getElementById(\'bf-mock-wrap\').style.display=this.value===\'mock\'?\'block\':\'none\'"><option value="manual">ì§ì ‘ë“±ë¡</option><option value="alibaba">ì•Œë¦¬ë°”ë°”</option><option value="exhibition">ì „ì‹œíšŒ</option><option value="referral">ì†Œê°œ</option><option value="linkedin">LinkedIn</option><option value="mock">Mock (í…ŒìŠ¤íŠ¸)</option></select></div><div><label style="font-size:11px;font-weight:700;color:var(--w40)">ì‹ ë¢°ë„ (0-100)</label><input id="bf-trust" type="number" min="0" max="100" value="50" style="width:100%;padding:10px;border-radius:8px;background:var(--sf);border:1px solid var(--bd);color:var(--w90);font-size:12px"></div></div>'+
    '<div id="bf-mock-wrap" style="display:none;padding:8px 12px;border-radius:8px;background:rgba(255,82,82,.06);border:1px solid rgba(255,82,82,.15)"><label style="font-size:11px;color:var(--err)"><input type="checkbox" id="bf-mock" checked> Mock ë°”ì´ì–´ë¡œ ë“±ë¡ (ì œì¡°ì‚¬ì—ê²Œ "í”Œë«í¼" ì†ŒìŠ¤ë¡œ í‘œì‹œë¨)</label></div>'+
    '<div><label style="font-size:11px;font-weight:700;color:var(--w40)">ê´€ë¦¬ì ë©”ëª¨</label><textarea id="bf-memo" rows="2" placeholder="ë‚´ë¶€ ë©”ëª¨..." style="width:100%;padding:10px;border-radius:8px;background:var(--sf);border:1px solid var(--bd);color:var(--w90);font-size:12px;resize:vertical"></textarea></div>'+
    '</div>';
  document.body.insertAdjacentHTML('beforeend',UI.modal({id:'buyer-form',title:'ë°”ì´ì–´ ë“±ë¡',body:body,footer:'<button class="btn btn-ghost" onclick="Adm.closeModal(\'buyer-form\')">ì·¨ì†Œ</button><button class="btn btn-pri" onclick="Adm.saveBuyerForm()">ë“±ë¡</button>',width:'520px'}));
  UI.showModal('buyer-form');
}

function saveBuyerForm(){
  var company=document.getElementById('bf-company').value.trim();
  var country=document.getElementById('bf-country').value;
  if(!company||!country){UI.toast('íšŒì‚¬ëª…ê³¼ êµ­ê°€ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.','warn');return;}
  var source=document.getElementById('bf-source').value;
  var isMock=source==='mock'&&document.getElementById('bf-mock').checked;
  var data={
    company_name:company,
    contact_name:document.getElementById('bf-contact').value.trim(),
    contact_email:document.getElementById('bf-email').value.trim(),
    phone:document.getElementById('bf-phone').value.trim(),
    country:country,
    city:document.getElementById('bf-city').value.trim(),
    website:document.getElementById('bf-web').value.trim(),
    source:source,
    is_mock:isMock,
    trust_score:parseInt(document.getElementById('bf-trust').value)||50,
    admin_memo:document.getElementById('bf-memo').value.trim()
  };
  sb.from('buyers').insert(data).select().single().then(function(r){
    if(r.error){UI.toast('ë“±ë¡ ì‹¤íŒ¨: '+r.error.message,'err');return;}
    S.buyers.unshift(r.data);
    closeModal('buyer-form');
    UI.toast('ë°”ì´ì–´ ë“±ë¡ ì™„ë£Œ','ok');
    render();
  });
}

/* === MATCHING FORM === */
function showMatchingForm(buyerId){
  var sellerOpts=S.users.filter(function(u){return u.role==='client';}).map(function(u){
    var c=S.companies.find(function(c){return c.user_id===u.id;});
    var label=c?(c.name_ko||c.name_en||u.email):u.email;
    return '<option value="'+u.id+'">'+U.esc(label)+'</option>';
  }).join('');
  var buyerOpts=S.buyers.map(function(b){
    return '<option value="'+b.id+'"'+(b.id===buyerId?' selected':'')+'>'+U.esc(b.company_name)+' ('+U.esc(b.country||'')+')</option>';
  }).join('');
  var body=
    '<div style="display:flex;flex-direction:column;gap:10px">'+
    '<div><label style="font-size:11px;font-weight:700;color:var(--w40)">ë°”ì´ì–´ *</label><select id="mf-buyer" style="width:100%;padding:10px;border-radius:8px;background:var(--sf);border:1px solid var(--bd);color:var(--w90);font-size:12px">'+buyerOpts+'</select></div>'+
    '<div><label style="font-size:11px;font-weight:700;color:var(--w40)">ì œì¡°ì‚¬ (ì…€ëŸ¬) *</label><select id="mf-seller" style="width:100%;padding:10px;border-radius:8px;background:var(--sf);border:1px solid var(--bd);color:var(--w90);font-size:12px"><option value="">ì„ íƒ</option>'+sellerOpts+'</select></div>'+
    '<div class="grid-2"><div><label style="font-size:11px;font-weight:700;color:var(--w40)">ë§¤ì¹­ ì ìˆ˜</label><input id="mf-score" type="number" min="0" max="100" value="70" style="width:100%;padding:10px;border-radius:8px;background:var(--sf);border:1px solid var(--bd);color:var(--w90);font-size:12px"></div><div><label style="font-size:11px;font-weight:700;color:var(--w40)">ìƒíƒœ</label><select id="mf-status" style="width:100%;padding:10px;border-radius:8px;background:var(--sf);border:1px solid var(--bd);color:var(--w90);font-size:12px"><option value="proposed">ì œì•ˆ</option><option value="interested">ê´€ì‹¬</option><option value="sample">ìƒ˜í”Œ</option><option value="negotiation">í˜‘ìƒ</option></select></div></div>'+
    '<div><label style="font-size:11px;font-weight:700;color:var(--w40)">ë§¤ì¹­ ì‚¬ìœ </label><input id="mf-reason" placeholder="ë§¤ì¹­ ì‚¬ìœ ..." style="width:100%;padding:10px;border-radius:8px;background:var(--sf);border:1px solid var(--bd);color:var(--w90);font-size:12px"></div>'+
    '<div><label style="font-size:11px;font-weight:700;color:var(--w40)">ê´€ë¦¬ì ë©”ëª¨</label><textarea id="mf-memo" rows="2" placeholder="ë‚´ë¶€ ë©”ëª¨..." style="width:100%;padding:10px;border-radius:8px;background:var(--sf);border:1px solid var(--bd);color:var(--w90);font-size:12px;resize:vertical"></textarea></div>'+
    '</div>';
  document.body.insertAdjacentHTML('beforeend',UI.modal({id:'matching-form',title:'ë§¤ì¹­ ìƒì„±',body:body,footer:'<button class="btn btn-ghost" onclick="Adm.closeModal(\'matching-form\')">ì·¨ì†Œ</button><button class="btn btn-pri" onclick="Adm.saveMatchingForm()">ìƒì„±</button>',width:'480px'}));
  UI.showModal('matching-form');
}

function saveMatchingForm(){
  var buyerId=document.getElementById('mf-buyer').value;
  var sellerId=document.getElementById('mf-seller').value;
  if(!buyerId||!sellerId){UI.toast('ë°”ì´ì–´ì™€ ì œì¡°ì‚¬ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.','warn');return;}
  var data={
    buyer_id:buyerId,
    user_id:sellerId,
    match_score:parseInt(document.getElementById('mf-score').value)||70,
    status:document.getElementById('mf-status').value||'proposed',
    match_reason:document.getElementById('mf-reason').value.trim(),
    admin_memo:document.getElementById('mf-memo').value.trim()
  };
  sb.from('matchings').insert(data).select().single().then(function(r){
    if(r.error){UI.toast('ë§¤ì¹­ ìƒì„± ì‹¤íŒ¨: '+r.error.message,'err');return;}
    S.matchings.unshift(r.data);
    closeModal('matching-form');
    UI.toast('ë§¤ì¹­ ìƒì„± ì™„ë£Œ','ok');
    render();
  });
}

/* === BUYER MEMO/TAG === */
function addBuyerTag(buyerId){
  var input=document.getElementById('buyer-tag-input');
  var tag=input?input.value.trim():'';
  if(!tag)return;
  var b=S.buyers.find(function(x){return x.id===buyerId;});
  if(!b)return;
  var tags=(b.admin_tags||[]).slice();
  if(tags.indexOf(tag)>=0){UI.toast('ì´ë¯¸ ìˆëŠ” íƒœê·¸','info');return;}
  tags.push(tag);
  sb.from('buyers').update({admin_tags:tags}).eq('id',buyerId).then(function(r){
    if(r.error){UI.toast('íƒœê·¸ ì¶”ê°€ ì‹¤íŒ¨','err');return;}
    b.admin_tags=tags;render();
  });
}
function rmBuyerTag(buyerId,tag){
  var b=S.buyers.find(function(x){return x.id===buyerId;});if(!b)return;
  var tags=(b.admin_tags||[]).filter(function(t){return t!==tag;});
  sb.from('buyers').update({admin_tags:tags}).eq('id',buyerId).then(function(r){
    if(r.error){UI.toast('íƒœê·¸ ì‚­ì œ ì‹¤íŒ¨','err');return;}b.admin_tags=tags;render();
  });
}
function saveBuyerMemo(buyerId){
  var el=document.getElementById('buyer-memo');
  var memo=el?el.value.trim():'';
  sb.from('buyers').update({admin_memo:memo}).eq('id',buyerId).then(function(r){
    if(r.error){UI.toast('ë©”ëª¨ ì €ì¥ ì‹¤íŒ¨','err');return;}
    var b=S.buyers.find(function(x){return x.id===buyerId;});if(b)b.admin_memo=memo;
    UI.toast('ë©”ëª¨ ì €ì¥ë¨','ok');
  });
}

/* === MATCHING MEMO/TAG === */
function saveMatchingMemo(matchingId){
  var el=document.getElementById('matching-memo');
  var memo=el?el.value.trim():'';
  sb.from('matchings').update({admin_memo:memo}).eq('id',matchingId).then(function(r){
    if(r.error){UI.toast('ë©”ëª¨ ì €ì¥ ì‹¤íŒ¨','err');return;}
    var m=S.matchings.find(function(x){return x.id===matchingId;});if(m)m.admin_memo=memo;
    UI.toast('ë©”ëª¨ ì €ì¥ë¨','ok');
  });
}
function addMatchingTag(matchingId){
  var input=document.getElementById('matching-tag-input');
  var tag=input?input.value.trim():'';if(!tag)return;
  var m=S.matchings.find(function(x){return x.id===matchingId;});if(!m)return;
  var tags=(m.admin_tags||[]).slice();
  if(tags.indexOf(tag)>=0){UI.toast('ì´ë¯¸ ìˆëŠ” íƒœê·¸','info');return;}
  tags.push(tag);
  sb.from('matchings').update({admin_tags:tags}).eq('id',matchingId).then(function(r){
    if(r.error){UI.toast('íƒœê·¸ ì¶”ê°€ ì‹¤íŒ¨','err');return;}m.admin_tags=tags;render();
  });
}
function rmMatchingTag(matchingId,tag){
  var m=S.matchings.find(function(x){return x.id===matchingId;});if(!m)return;
  var tags=(m.admin_tags||[]).filter(function(t){return t!==tag;});
  sb.from('matchings').update({admin_tags:tags}).eq('id',matchingId).then(function(r){
    if(r.error){UI.toast('íƒœê·¸ ì‚­ì œ ì‹¤íŒ¨','err');return;}m.admin_tags=tags;render();
  });
}

/* === ALIBABA MGMT === */
function pgAlibabaMgmt(){
  var stores=S.alibabaStores||[];
  var inquiries=S.alibabaInquiries||[];
  var aliProjects=S.projects.filter(function(p){return p.alibaba_customer;});
  var statusL={new:'ì‹ ê·œ',replied:'ì‘ë‹µì™„ë£Œ',qualified:'ìœ ë§',sample_sent:'ìƒ˜í”Œë°œì†¡',negotiating:'í˜‘ìƒì¤‘',converted:'ì „í™˜',lost:'ì‹¤íŒ¨',spam:'ìŠ¤íŒ¸'};
  var statusC={new:'err',replied:'acc',qualified:'ok',converted:'ok',lost:'ghost',spam:'ghost'};
  return '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px"><h2 style="font-size:18px;font-weight:800">ğŸª ì•Œë¦¬ë°”ë°” ê´€ë¦¬</h2></div>'+
  '<div class="grid-4" style="margin-bottom:16px">'+UI.stat('ìŠ¤í† ì–´',stores.length,'','var(--acc)')+UI.stat('ë¬¸ì˜',inquiries.length,'','var(--pri)')+UI.stat('ì „í™˜',inquiries.filter(function(i){return i.status==='converted';}).length,'','var(--ok)')+UI.stat('ì•Œë¦¬ë°”ë°” í”„ë¡œì íŠ¸',aliProjects.length,'','var(--purple)')+'</div>'+
  /* Stores */
  '<div class="card" style="margin-bottom:16px"><div class="card-h">ì•Œë¦¬ë°”ë°” ìŠ¤í† ì–´</div><div class="card-b" style="padding:0"><table class="tbl"><thead><tr><th>ì œì¡°ì‚¬</th><th>ìŠ¤í† ì–´</th><th>ìƒí’ˆìˆ˜</th><th>ì›”ì¡°íšŒ</th><th>ìƒíƒœ</th></tr></thead><tbody>'+
  (stores.length?stores.map(function(s){return '<tr><td style="font-size:12px">'+getUserName(s.user_id)+'</td><td style="font-weight:600">'+U.esc(s.store_name||'â€”')+'</td><td style="font-family:JetBrains Mono;text-align:center">'+(s.products_listed||0)+'</td><td style="font-family:JetBrains Mono;text-align:center">'+(s.monthly_views||0)+'</td><td>'+UI.badge(s.status==='active'?'í™œì„±':'ë¹„í™œì„±',s.status==='active'?'ok':'ghost')+'</td></tr>';}).join(''):'<tr><td colspan="5">'+UI.empty('ğŸª','ìŠ¤í† ì–´ ì—†ìŒ','')+'</td></tr>')+'</tbody></table></div></div>'+
  /* Inquiries */
  '<div class="card" style="margin-bottom:16px"><div class="card-h">ìµœê·¼ ë¬¸ì˜ <span style="font-size:10px;color:var(--w20)">(ìµœê·¼ 20ê±´)</span></div><div class="card-b" style="padding:0"><table class="tbl"><thead><tr><th>ì œì¡°ì‚¬</th><th>ë°”ì´ì–´</th><th>êµ­ê°€</th><th>ê´€ì‹¬ì œí’ˆ</th><th>ìƒíƒœ</th><th>ë‚ ì§œ</th></tr></thead><tbody>'+
  (inquiries.length?inquiries.slice(0,20).map(function(i){return '<tr><td style="font-size:12px">'+getUserName(i.user_id)+'</td><td style="font-weight:600">'+U.esc(i.buyer_company||i.buyer_name||'â€”')+'</td><td>'+U.esc(i.buyer_country||'â€”')+'</td><td style="font-size:12px">'+U.esc((i.product_interest||'').slice(0,30))+'</td><td>'+UI.badge(statusL[i.status]||i.status,statusC[i.status]||'ghost')+'</td><td style="font-size:12px;color:var(--w40)">'+U.fd(i.created_at)+'</td></tr>';}).join(''):'<tr><td colspan="6">'+UI.empty('ğŸ“©','ë¬¸ì˜ ì—†ìŒ','')+'</td></tr>')+'</tbody></table></div></div>'+
  /* Alibaba Projects Sync Matrix */
  '<div class="card"><div class="card-h">ì•Œë¦¬ë°”ë°” í”„ë¡œì íŠ¸ ë™ê¸°í™”</div><div class="card-b">'+(aliProjects.length?'<table class="tbl"><thead><tr><th>ì œì¡°ì‚¬</th><th>í”„ë¡œì íŠ¸</th><th>í˜„ì¬ ë‹¨ê³„</th><th>ë™ê¸°í™”</th></tr></thead><tbody>'+aliProjects.map(function(p){
    var sync=p.alibaba_sync||{};var curSync=sync[p.status]||{};
    var syncSt=curSync.status||'pending';
    var syncL={synced:'ë™ê¸°í™”ë¨',pending:'ëŒ€ê¸°ì¤‘',not_applicable:'í•´ë‹¹ì—†ìŒ'};
    var syncC={synced:'ok',pending:'acc',not_applicable:'ghost'};
    return '<tr><td style="font-size:12px">'+getUserName(p.user_id)+'</td><td style="font-weight:600">'+U.esc(p.name||'â€”')+'</td><td>'+UI.badge(p.status||'planning','pri')+'</td><td>'+UI.badge(syncL[syncSt]||syncSt,syncC[syncSt]||'ghost')+'<button class="btn btn-ghost btn-sm" style="margin-left:6px;font-size:10px" onclick="Adm.editAlibabaSync(\''+p.id+'\')">í¸ì§‘</button></td></tr>';
  }).join('')+'</tbody></table>':UI.empty('ğŸ“‹','ì•Œë¦¬ë°”ë°” í”„ë¡œì íŠ¸ ì—†ìŒ',''))+'</div></div>';
}

function editAlibabaSync(projectId){
  var p=S.projects.find(function(x){return x.id===projectId;});if(!p)return;
  var stages=['planning','certification','alibaba_listing','buyer_search','negotiation','production','shipping','completed'];
  var stL2={planning:'ê¸°íš',certification:'ì¸ì¦',alibaba_listing:'ì•Œë¦¬ë°”ë°” ì…ì ',buyer_search:'ë°”ì´ì–´ ë°œêµ´',negotiation:'í˜‘ìƒ',production:'ìƒì‚°',shipping:'ì„ ì ',completed:'ì™„ë£Œ'};
  var sync=p.alibaba_sync||{};
  var body='<div style="font-size:12px;color:var(--w40);margin-bottom:12px">í”„ë¡œì íŠ¸: <b style="color:var(--w90)">'+U.esc(p.name)+'</b></div>'+
    '<table class="tbl"><thead><tr><th>ë‹¨ê³„</th><th>ë™ê¸°í™” ìƒíƒœ</th><th>ë©”ëª¨</th></tr></thead><tbody>'+
    stages.map(function(s){
      var ss=sync[s]||{};
      return '<tr><td style="font-weight:600">'+stL2[s]+'</td><td><select id="sync-'+s+'" style="padding:6px;border-radius:6px;background:var(--sf);border:1px solid var(--bd);color:var(--w90);font-size:11px"><option value="pending"'+(ss.status==='pending'?' selected':'')+'>ëŒ€ê¸°ì¤‘</option><option value="synced"'+(ss.status==='synced'?' selected':'')+'>ë™ê¸°í™”ë¨</option><option value="not_applicable"'+(!ss.status||ss.status==='not_applicable'?' selected':'')+'>í•´ë‹¹ì—†ìŒ</option></select></td><td><input id="syncn-'+s+'" value="'+U.esc(ss.note||'')+'" placeholder="ë©”ëª¨" style="width:100%;padding:6px;border-radius:6px;background:var(--sf);border:1px solid var(--bd);color:var(--w90);font-size:11px"></td></tr>';
    }).join('')+'</tbody></table>';
  document.body.insertAdjacentHTML('beforeend',UI.modal({id:'sync-form',title:'ì•Œë¦¬ë°”ë°” ë™ê¸°í™” í¸ì§‘',body:body,footer:'<button class="btn btn-ghost" onclick="Adm.closeModal(\'sync-form\')">ì·¨ì†Œ</button><button class="btn btn-pri" onclick="Adm.saveAlibabaSync(\''+projectId+'\')">ì €ì¥</button>',width:'560px'}));
  UI.showModal('sync-form');
}

function saveAlibabaSync(projectId){
  var p=S.projects.find(function(x){return x.id===projectId;});if(!p)return;
  var stages=['planning','certification','alibaba_listing','buyer_search','negotiation','production','shipping','completed'];
  var sync={};
  stages.forEach(function(s){
    var statusEl=document.getElementById('sync-'+s);
    var noteEl=document.getElementById('syncn-'+s);
    sync[s]={status:statusEl?statusEl.value:'pending',note:noteEl?noteEl.value.trim():'',updated_at:new Date().toISOString()};
  });
  sb.from('projects').update({alibaba_sync:sync}).eq('id',projectId).then(function(r){
    if(r.error){UI.toast('ì €ì¥ ì‹¤íŒ¨: '+r.error.message,'err');return;}
    p.alibaba_sync=sync;
    closeModal('sync-form');
    UI.toast('ë™ê¸°í™” ìƒíƒœ ì €ì¥ë¨','ok');
    render();
  });
}

/* === PUBLIC API === */
function toggleMob(){var sb=document.querySelector('.sidebar');if(sb)sb.classList.toggle('mobile-open');}
function closeMob(){var sb=document.querySelector('.sidebar');if(sb)sb.classList.remove('mobile-open');}

window.Adm={set:set,nav:nav,render:render,doLogin:doLogin,doLogout:doLogout,setSearch:setSearch,setTab:setTab,closeModal:closeModal,
  viewUser:viewUser,viewAnalysis:viewAnalysis,viewSR:viewSR,notifySR:notifySR,
  viewSeller:viewSeller,viewBuyer:viewBuyer,viewMatching:viewMatching,viewOrder:viewOrder,
  setAnalyticsTab:setAnalyticsTab,setPaymentTab:setPaymentTab,
  editUserPlan:editUserPlan,editUserRole:editUserRole,toggleUserActive:toggleUserActive,
  updateAStatus:updateAStatus,deleteAnalysis:deleteAnalysis,
  updateSR:updateSR,quickSR:quickSR,deleteSR:deleteSR,
  exportCSV:exportCSV,refreshAll:refreshAll,toggleMob:toggleMob,closeMob:closeMob,
  showBuyerForm:showBuyerForm,saveBuyerForm:saveBuyerForm,
  showMatchingForm:showMatchingForm,saveMatchingForm:saveMatchingForm,
  addBuyerTag:addBuyerTag,rmBuyerTag:rmBuyerTag,saveBuyerMemo:saveBuyerMemo,
  saveMatchingMemo:saveMatchingMemo,addMatchingTag:addMatchingTag,rmMatchingTag:rmMatchingTag,
  editAlibabaSync:editAlibabaSync,saveAlibabaSync:saveAlibabaSync};
loadUser();
})();
</script>
<!-- ì‹¤ì‹œê°„ ë¬¸ì˜ ì±„íŒ… ìœ„ì ¯ -->
<script>
(function(){
  var RELAY=(location.hostname==='localhost'||location.hostname==='127.0.0.1')?'http://localhost:3456':(typeof RELAY_URL!=='undefined'&&RELAY_URL?RELAY_URL:'');
  if(!RELAY){try{var _x=new XMLHttpRequest();_x.open('GET','relay-url.txt?t='+Date.now(),false);_x.send();if(_x.status===200&&_x.responseText.trim().startsWith('https://'))RELAY=_x.responseText.trim();}catch(e){}}
  var PAGE='admin';
  var open=false,step=0,msgs=[],info={name:'',email:'',phone:''};
  var el=document.createElement('div');el.id='wc-root';document.body.appendChild(el);
  function r(){
    var html='';
    html+='<div onclick="WC.toggle()" style="position:fixed;bottom:24px;right:24px;z-index:9999;width:56px;height:56px;border-radius:28px;background:linear-gradient(135deg,#00D4FF,#0088FF);display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 20px rgba(0,212,255,.4)">';
    html+=open?'<svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M18 6L6 18M6 6l12 12" stroke="#060B18" stroke-width="2.5" stroke-linecap="round"/></svg>':'<svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z" fill="#060B18"/></svg>';
    html+='</div>';
    if(!open){el.innerHTML=html;return;}
    html+='<div style="position:fixed;bottom:90px;right:24px;z-index:9998;width:360px;max-height:520px;background:#0D1424;border-radius:16px;border:1px solid rgba(255,255,255,.1);box-shadow:0 16px 60px rgba(0,0,0,.6);display:flex;flex-direction:column;overflow:hidden;font-family:Sora,Noto Sans KR,sans-serif">';
    html+='<div style="padding:14px 18px;background:linear-gradient(135deg,#00D4FF20,#0088FF10);border-bottom:1px solid rgba(255,255,255,.08);display:flex;align-items:center;gap:10px"><div style="width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#00D4FF,#0088FF);display:flex;align-items:center;justify-content:center"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" fill="#060B18"/></svg></div><div><div style="font-size:14px;font-weight:700;color:#fff">Whistle AI</div><div style="font-size:11px;color:rgba(255,255,255,.4)">ìˆ˜ì¶œ ì „ë¬¸ ìƒë‹´</div></div><div style="margin-left:auto;display:flex;align-items:center;gap:4px"><div style="width:6px;height:6px;border-radius:3px;background:#00E676"></div><span style="font-size:10px;color:#00E676">ì˜¨ë¼ì¸</span></div></div>';
    html+='<div id="wc-msgs" style="flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:8px;min-height:200px;max-height:320px">';
    if(msgs.length===0&&step===0){html+=bbl('bot','ì•ˆë…•í•˜ì„¸ìš”! Whistle AI ìˆ˜ì¶œ ìƒë‹´ì…ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?');html+=qb(['ë¬´ë£Œ ë¶„ì„ì´ ê¶ê¸ˆí•´ìš”','ë°”ìš°ì²˜ ë¬¸ì˜','ì•Œë¦¬ë°”ë°” ì…ì ','ê¸°íƒ€ ë¬¸ì˜']);}
    for(var i=0;i<msgs.length;i++)html+=bbl(msgs[i].from,msgs[i].text);
    if(step===1){html+=bbl('bot','ìƒë‹´ì„ ìœ„í•´ ê°„ë‹¨í•œ ì •ë³´ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.');html+='<div style="display:flex;flex-direction:column;gap:6px;width:100%"><input id="wc-name" placeholder="ì´ë¦„/íšŒì‚¬ëª…" value="'+esc(info.name)+'" style="padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,.1);background:#111B2E;color:rgba(255,255,255,.9);font-size:13px;outline:none"><input id="wc-email" placeholder="ì´ë©”ì¼ (ì„ íƒ)" value="'+esc(info.email)+'" style="padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,.1);background:#111B2E;color:rgba(255,255,255,.9);font-size:13px;outline:none"><input id="wc-phone" placeholder="ì—°ë½ì²˜ (ì„ íƒ)" value="'+esc(info.phone)+'" style="padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,.1);background:#111B2E;color:rgba(255,255,255,.9);font-size:13px;outline:none"><button onclick="WC.submitInfo()" style="padding:10px;border-radius:8px;border:none;background:linear-gradient(135deg,#00D4FF,#0088FF);color:#060B18;font-weight:700;font-size:13px;cursor:pointer">ìƒë‹´ ì‹œì‘</button></div>';}
    html+='</div>';
    if(step>=2){html+='<div style="padding:10px 14px;border-top:1px solid rgba(255,255,255,.08);display:flex;gap:8px"><input id="wc-input" onkeydown="if(event.key===\'Enter\')WC.send()" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." style="flex:1;padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,.1);background:#111B2E;color:rgba(255,255,255,.9);font-size:13px;outline:none"><button onclick="WC.send()" style="width:40px;height:40px;border-radius:10px;border:none;background:linear-gradient(135deg,#00D4FF,#0088FF);cursor:pointer;display:flex;align-items:center;justify-content:center"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M2 21l21-9L2 3v7l15 2-15 2v7z" fill="#060B18"/></svg></button></div>';}
    html+='</div>';
    el.innerHTML=html;var mc=document.getElementById('wc-msgs');if(mc)mc.scrollTop=mc.scrollHeight;
  }
  function bbl(f,t){return f==='bot'?'<div style="align-self:flex-start;max-width:85%;padding:10px 14px;border-radius:12px 12px 12px 4px;background:#111B2E;border:1px solid rgba(255,255,255,.06)"><div style="font-size:13px;color:rgba(255,255,255,.75);line-height:1.5">'+t+'</div></div>':'<div style="align-self:flex-end;max-width:85%;padding:10px 14px;border-radius:12px 12px 4px 12px;background:linear-gradient(135deg,#00D4FF20,#0088FF15);border:1px solid #00D4FF30"><div style="font-size:13px;color:rgba(255,255,255,.9);line-height:1.5">'+t+'</div></div>';}
  function qb(a){var h='<div style="display:flex;flex-wrap:wrap;gap:6px">';for(var i=0;i<a.length;i++)h+='<div onclick="WC.pick(\''+esc(a[i])+'\')" style="padding:6px 12px;border-radius:8px;border:1px solid rgba(0,212,255,.3);background:rgba(0,212,255,.06);color:#00D4FF;font-size:12px;font-weight:600;cursor:pointer">'+a[i]+'</div>';return h+'</div>';}
  function esc(s){return String(s||'').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;');}
  var ar={'ë¬´ë£Œ ë¶„ì„ì´ ê¶ê¸ˆí•´ìš”':'URLì´ë‚˜ ì´ë¯¸ì§€ë¥¼ ì˜¬ë¦¬ë©´ 13ê°œ ì„¹ì…˜ì˜ ì¢…í•© ìˆ˜ì¶œ ë¶„ì„ ë¦¬í¬íŠ¸ê°€ ìƒì„±ë©ë‹ˆë‹¤!','ë°”ìš°ì²˜ ë¬¸ì˜':'ìˆ˜ì¶œë°”ìš°ì²˜Â·ì œì¡°í˜ì‹ ë°”ìš°ì²˜ ê³µì‹ ìˆ˜í–‰ê¸°ê´€ì…ë‹ˆë‹¤. ì •ë¶€ 50~85% ë¶€ë‹´.','ì•Œë¦¬ë°”ë°” ì…ì ':'ì´íŒ(200ë§Œì›)ê³¼ ë…ë¦½(500ë§Œì›) ë‘ ëª¨ë¸. ë°”ìš°ì²˜ ìµœëŒ€ 85% ì ˆê°.','ê¸°íƒ€ ë¬¸ì˜':'ê¶ê¸ˆí•œ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. ë‹´ë‹¹ìê°€ ë‹µë³€ë“œë¦½ë‹ˆë‹¤.'};
  window.WC={
    toggle:function(){open=!open;r();},
    pick:function(t){msgs.push({from:'user',text:t});if(ar[t]){msgs.push({from:'bot',text:ar[t]});msgs.push({from:'bot',text:'ë” ìì„¸í•œ ìƒë‹´ì„ ì›í•˜ì‹œë©´ ì •ë³´ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”.'});step=1;}r();},
    submitInfo:function(){var n=document.getElementById('wc-name'),e=document.getElementById('wc-email'),p=document.getElementById('wc-phone');info.name=n?n.value:'';info.email=e?e.value:'';info.phone=p?p.value:'';if(!info.name){alert('ì´ë¦„/íšŒì‚¬ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');return;}msgs.push({from:'bot',text:info.name+'ë‹˜, ë°˜ê°‘ìŠµë‹ˆë‹¤! ê¶ê¸ˆí•œ ì ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'});step=2;r();},
    send:function(){var inp=document.getElementById('wc-input');if(!inp||!inp.value.trim())return;var msg=inp.value.trim();msgs.push({from:'user',text:msg});r();fetch(RELAY+'/api/whistle/chat-inquiry',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:info.name,email:info.email,phone:info.phone,message:msg,page:PAGE})}).then(function(r){return r.json();}).then(function(d){if(d.ok){msgs.push({from:'bot',text:d.reply||'ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.'});r();}}).catch(function(){msgs.push({from:'bot',text:'ì „ì†¡ ì‹¤íŒ¨. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'});r();});}
  };r();
})();
</script>
</body>
</html>
