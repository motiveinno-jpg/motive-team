// /app/dealroom/docs/render/pl.js
// Renders a Packing List PDF from document.content using jsPDF + autoTable

export function renderPLToPdf(document) {
  const jsPDF = window.jspdf?.jsPDF;
  if (!jsPDF) { alert('PDF 라이브러리가 로드되지 않았습니다.'); return; }

  const c = document.content || {};
  const doc = new jsPDF('p', 'mm', 'a4');
  const pageWidth = doc.internal.pageSize.getWidth();
  const margin = 15;
  let y = margin;

  // Header
  doc.setFontSize(20);
  doc.setFont(undefined, 'bold');
  doc.text('PACKING LIST', pageWidth / 2, y, { align: 'center' });
  y += 10;

  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  const docNo = document.doc_number || 'N/A';
  const dateStr = c.generated_at ? new Date(c.generated_at).toLocaleDateString('en-US') : new Date().toLocaleDateString('en-US');
  doc.text(`PL No: ${docNo}`, margin, y);
  doc.text(`Date: ${dateStr}`, pageWidth - margin, y, { align: 'right' });
  y += 5;
  doc.setDrawColor(200);
  doc.line(margin, y, pageWidth - margin, y);
  y += 8;

  // Seller / Buyer
  doc.setFontSize(9);
  const halfWidth = (pageWidth - margin * 2) / 2;
  doc.setFont(undefined, 'bold');
  doc.text('SHIPPER', margin, y);
  doc.text('CONSIGNEE', margin + halfWidth + 5, y);
  y += 5;
  doc.setFont(undefined, 'normal');
  const seller = c.shipper || c.seller || {};
  const buyer = c.consignee || c.buyer || {};
  doc.text(seller.company || seller.name || 'N/A', margin, y);
  doc.text(buyer.company || buyer.name || 'N/A', margin + halfWidth + 5, y);
  y += 8;

  // Items table with packing-specific columns
  const items = Array.isArray(c.items) ? c.items : [];
  if (items.length > 0) {
    const tableData = items.map((item, idx) => [
      idx + 1,
      item.product_name || 'N/A',
      fmt(item.qty),
      item.unit || 'PCS',
      item.net_weight ? fmt(item.net_weight) + ' kg' : '-',
      item.gross_weight ? fmt(item.gross_weight) + ' kg' : '-',
      (item.cbm || item.volume) ? fmt(item.cbm || item.volume) + ' CBM' : '-',
    ]);

    doc.autoTable({
      startY: y,
      head: [['#', 'Description', 'Qty', 'Unit', 'Net Wt.', 'Gross Wt.', 'Volume']],
      body: tableData,
      margin: { left: margin, right: margin },
      styles: { fontSize: 9, cellPadding: 3 },
      headStyles: { fillColor: [20, 184, 166], textColor: 255, fontStyle: 'bold' },
      alternateRowStyles: { fillColor: [248, 250, 252] },
    });
    y = doc.lastAutoTable.finalY + 8;
  } else {
    doc.text('No items', margin, y); y += 8;
  }

  // Total summary
  if (items.length > 0) {
    const totalQty = items.reduce((s, it) => s + (Number(it.qty) || 0), 0);
    doc.setFont(undefined, 'bold');
    doc.text(`Total Packages: ${fmt(totalQty)}`, margin, y);
    y += 6;
  }

  // Notes
  if (c.notes || document.notes) {
    doc.setFontSize(9);
    doc.setFont(undefined, 'bold');
    doc.text('Remarks:', margin, y); y += 5;
    doc.setFont(undefined, 'normal');
    const lines = doc.splitTextToSize(c.notes || document.notes, pageWidth - margin * 2);
    doc.text(lines, margin, y);
  }

  // Footer
  y = doc.internal.pageSize.getHeight() - 15;
  doc.setTextColor(150);
  doc.setFontSize(8);
  doc.text('Generated by Whistle AI - Export Management Platform', pageWidth / 2, y, { align: 'center' });

  doc.save(`${document.doc_number || 'PL'}_${dateStr.replace(/\//g, '-')}.pdf`);
}

function fmt(n) { const v = Number(n); return Number.isFinite(v) ? v.toLocaleString() : '0'; }
