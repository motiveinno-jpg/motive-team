// /app/dealroom/docs/render/pi.js
// Renders a Proforma Invoice PDF from document.content using jsPDF + autoTable

/**
 * Generate PI PDF and trigger download.
 * @param {Object} document - The document record from Supabase
 * @returns {void}
 */
export function renderPIToPdf(document) {
  const jsPDF = window.jspdf?.jsPDF;
  if (!jsPDF) {
    alert('PDF 라이브러리가 로드되지 않았습니다.');
    return;
  }

  const c = document.content || {};
  const doc = new jsPDF('p', 'mm', 'a4');
  const pageWidth = doc.internal.pageSize.getWidth();
  const margin = 15;
  let y = margin;

  // ─── Header ───
  doc.setFontSize(20);
  doc.setFont(undefined, 'bold');
  doc.text('PROFORMA INVOICE', pageWidth / 2, y, { align: 'center' });
  y += 10;

  // Doc info line
  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  const docNo = document.doc_number || c.quote_no || 'N/A';
  const dateStr = c.generated_at ? new Date(c.generated_at).toLocaleDateString('en-US') : new Date().toLocaleDateString('en-US');
  doc.text(`PI No: ${docNo}`, margin, y);
  doc.text(`Date: ${dateStr}`, pageWidth - margin, y, { align: 'right' });
  y += 5;

  // Separator line
  doc.setDrawColor(200);
  doc.setLineWidth(0.5);
  doc.line(margin, y, pageWidth - margin, y);
  y += 8;

  // ─── Seller / Buyer Info ───
  doc.setFontSize(9);
  const halfWidth = (pageWidth - margin * 2) / 2;

  // Seller
  doc.setFont(undefined, 'bold');
  doc.text('FROM (Seller)', margin, y);
  doc.text('TO (Buyer)', margin + halfWidth + 5, y);
  y += 5;

  doc.setFont(undefined, 'normal');
  const seller = c.seller || {};
  const buyer = c.buyer || {};
  const sellerLines = [
    seller.company || seller.name || 'N/A',
    seller.address || '',
    seller.email || '',
  ].filter(Boolean);

  const buyerLines = [
    buyer.company || buyer.name || 'N/A',
    buyer.address || '',
    buyer.email || '',
  ].filter(Boolean);

  const maxLines = Math.max(sellerLines.length, buyerLines.length);
  for (let i = 0; i < maxLines; i++) {
    if (sellerLines[i]) doc.text(sellerLines[i], margin, y);
    if (buyerLines[i]) doc.text(buyerLines[i], margin + halfWidth + 5, y);
    y += 4.5;
  }
  y += 4;

  // ─── Trade Terms ───
  doc.setFont(undefined, 'bold');
  doc.setFontSize(9);
  const terms = [];
  if (c.currency) terms.push(`Currency: ${c.currency}`);
  if (c.incoterms) terms.push(`Incoterms: ${c.incoterms}`);
  if (c.valid_until) {
    const vu = new Date(c.valid_until).toLocaleDateString('en-US');
    terms.push(`Valid Until: ${vu}`);
  }
  if (terms.length) {
    doc.text(terms.join('  |  '), margin, y);
    y += 7;
  }

  // ─── Items Table ───
  const items = Array.isArray(c.items) ? c.items : [];
  if (items.length > 0) {
    const tableData = items.map((item, idx) => [
      idx + 1,
      item.product_name || 'N/A',
      formatNumber(item.qty),
      formatCurrency(item.unit_price, c.currency),
      formatCurrency(item.amount || (item.qty * item.unit_price), c.currency),
    ]);

    const total = items.reduce((sum, it) => sum + (it.amount || it.qty * it.unit_price || 0), 0);

    doc.autoTable({
      startY: y,
      head: [['#', 'Product', 'Qty', 'Unit Price', 'Amount']],
      body: tableData,
      foot: [['', '', '', 'TOTAL', formatCurrency(total, c.currency)]],
      margin: { left: margin, right: margin },
      styles: { fontSize: 9, cellPadding: 3 },
      headStyles: { fillColor: [37, 99, 235], textColor: 255, fontStyle: 'bold' },
      footStyles: { fillColor: [241, 245, 249], textColor: [15, 23, 42], fontStyle: 'bold' },
      alternateRowStyles: { fillColor: [248, 250, 252] },
    });

    y = doc.lastAutoTable.finalY + 8;
  } else {
    doc.setFont(undefined, 'normal');
    doc.setFontSize(10);
    doc.text('No items', margin, y);
    y += 8;
  }

  // ─── Notes ───
  const notes = c.notes || document.notes;
  if (notes) {
    doc.setFontSize(9);
    doc.setFont(undefined, 'bold');
    doc.text('Notes:', margin, y);
    y += 5;
    doc.setFont(undefined, 'normal');
    const splitNotes = doc.splitTextToSize(notes, pageWidth - margin * 2);
    doc.text(splitNotes, margin, y);
    y += splitNotes.length * 4.5 + 4;
  }

  // ─── Footer ───
  y += 10;
  doc.setDrawColor(200);
  doc.line(margin, y, pageWidth - margin, y);
  y += 6;
  doc.setFontSize(8);
  doc.setTextColor(150);
  doc.text('Generated by Whistle AI - Export Management Platform', pageWidth / 2, y, { align: 'center' });
  y += 4;
  doc.text('www.whistle-ai.com', pageWidth / 2, y, { align: 'center' });

  // Save
  const fileName = `${document.doc_number || 'PI'}_${dateStr.replace(/\//g, '-')}.pdf`;
  doc.save(fileName);
}

function formatNumber(n) {
  const v = Number(n);
  return Number.isFinite(v) ? v.toLocaleString() : '0';
}

function formatCurrency(n, currency = 'USD') {
  const v = Number(n);
  if (!Number.isFinite(v)) return '-';
  const sym = { USD: '$', KRW: '₩', JPY: '¥', EUR: '€' }[currency] || currency + ' ';
  return sym + v.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}
