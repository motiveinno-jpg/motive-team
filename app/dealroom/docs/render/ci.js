// /app/dealroom/docs/render/ci.js
// Renders a Commercial Invoice PDF from document.content using jsPDF + autoTable

export function renderCIToPdf(document) {
  const jsPDF = window.jspdf?.jsPDF;
  if (!jsPDF) { alert('PDF 라이브러리가 로드되지 않았습니다.'); return; }

  const c = document.content || {};
  const doc = new jsPDF('p', 'mm', 'a4');
  const pageWidth = doc.internal.pageSize.getWidth();
  const margin = 15;
  let y = margin;

  // Header
  doc.setFontSize(20);
  doc.setFont(undefined, 'bold');
  doc.text('COMMERCIAL INVOICE', pageWidth / 2, y, { align: 'center' });
  y += 10;

  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  const docNo = document.doc_number || 'N/A';
  const dateStr = c.generated_at ? new Date(c.generated_at).toLocaleDateString('en-US') : new Date().toLocaleDateString('en-US');
  doc.text(`Invoice No: ${docNo}`, margin, y);
  doc.text(`Date: ${dateStr}`, pageWidth - margin, y, { align: 'right' });
  y += 5;
  doc.setDrawColor(200);
  doc.line(margin, y, pageWidth - margin, y);
  y += 8;

  // Seller / Buyer
  doc.setFontSize(9);
  const halfWidth = (pageWidth - margin * 2) / 2;
  doc.setFont(undefined, 'bold');
  doc.text('EXPORTER (Seller)', margin, y);
  doc.text('IMPORTER (Buyer)', margin + halfWidth + 5, y);
  y += 5;
  doc.setFont(undefined, 'normal');
  const seller = c.seller || {};
  const buyer = c.buyer || {};
  [seller.company || seller.name || 'N/A', seller.address || ''].filter(Boolean).forEach(line => {
    doc.text(line, margin, y); y += 4.5;
  });
  y -= (seller.address ? 9 : 4.5);
  [buyer.company || buyer.name || 'N/A', buyer.address || ''].filter(Boolean).forEach(line => {
    doc.text(line, margin + halfWidth + 5, y); y += 4.5;
  });
  y += 4;

  // Trade terms
  doc.setFont(undefined, 'bold');
  const terms = [];
  if (c.currency) terms.push(`Currency: ${c.currency}`);
  if (c.incoterms) terms.push(`Incoterms: ${c.incoterms}`);
  if (terms.length) { doc.text(terms.join('  |  '), margin, y); y += 7; }

  // Items
  const items = Array.isArray(c.items) ? c.items : [];
  if (items.length > 0) {
    const tableData = items.map((item, idx) => [
      idx + 1,
      item.product_name || 'N/A',
      fmt(item.qty),
      cur(item.unit_price, c.currency),
      cur(item.amount || (item.qty * item.unit_price), c.currency),
    ]);
    const total = items.reduce((s, it) => s + (it.amount || it.qty * it.unit_price || 0), 0);
    doc.autoTable({
      startY: y,
      head: [['#', 'Description of Goods', 'Qty', 'Unit Price', 'Amount']],
      body: tableData,
      foot: [['', '', '', 'TOTAL', cur(total, c.currency)]],
      margin: { left: margin, right: margin },
      styles: { fontSize: 9, cellPadding: 3 },
      headStyles: { fillColor: [30, 64, 175], textColor: 255, fontStyle: 'bold' },
      footStyles: { fillColor: [241, 245, 249], textColor: [15, 23, 42], fontStyle: 'bold' },
    });
    y = doc.lastAutoTable.finalY + 8;
  }

  // Notes
  if (c.notes || document.notes) {
    doc.setFontSize(9);
    doc.setFont(undefined, 'bold');
    doc.text('Remarks:', margin, y); y += 5;
    doc.setFont(undefined, 'normal');
    const lines = doc.splitTextToSize(c.notes || document.notes, pageWidth - margin * 2);
    doc.text(lines, margin, y); y += lines.length * 4.5 + 4;
  }

  // Signature area
  y += 15;
  doc.setDrawColor(200);
  doc.line(margin, y, margin + 60, y);
  y += 5;
  doc.setFontSize(8);
  doc.text('Authorized Signature', margin, y);

  // Footer
  y = doc.internal.pageSize.getHeight() - 15;
  doc.setTextColor(150);
  doc.setFontSize(8);
  doc.text('Generated by Whistle AI - Export Management Platform', pageWidth / 2, y, { align: 'center' });

  doc.save(`${document.doc_number || 'CI'}_${dateStr.replace(/\//g, '-')}.pdf`);
}

function fmt(n) { const v = Number(n); return Number.isFinite(v) ? v.toLocaleString() : '0'; }
function cur(n, c = 'USD') {
  const v = Number(n); if (!Number.isFinite(v)) return '-';
  const s = { USD: '$', KRW: '₩', JPY: '¥', EUR: '€' }[c] || c + ' ';
  return s + v.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}
