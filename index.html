<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, interactive-widget=resizes-content">
<title>MOTIVE - AI Teammate</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700;900&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{--bg:#0a0a0a;--bg2:#141414;--bg3:#1a1a1a;--bgi:#111;--bgs:#0e0e0e;--bd:#222;--bd2:#2a2a2a;--tx:#e8e8e8;--tx2:#888;--tx3:#555;--ac:#c8ff00;--ac2:#a0cc00;--red:#ff4d6a;--grn:#00d68f;--orn:#ffaa00;--blu:#00b4d8;--r:12px;--rs:8px;--rx:6px;--sh:0 4px 24px rgba(0,0,0,.4);--t:.2s ease}
*{margin:0;padding:0;box-sizing:border-box}
body{display:flex;flex-direction:column;height:100dvh;font-family:'Noto Sans KR',sans-serif;background:var(--bg);color:var(--tx);overflow:hidden;padding-bottom:env(safe-area-inset-bottom)}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:#333;border-radius:4px}
button{font-family:inherit;cursor:pointer}
.hd{display:flex;align-items:center;justify-content:space-between;padding:0 20px;height:50px;min-height:50px;background:var(--bg2);border-bottom:1px solid var(--bd);z-index:100}
.mob-menu{display:none;background:none;border:none;color:var(--tx);font-size:20px;padding:4px 8px;border-radius:6px}
.mob-menu:hover{background:var(--bg3)}
.mob-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:99}
.mob-overlay.show{display:block}
.logo{display:flex;align-items:center;gap:10px}
.logo-i{width:26px;height:26px;background:var(--ac);border-radius:6px;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:13px;color:#0a0a0a}
.logo-t{font-weight:700;font-size:15px;letter-spacing:1px}
.logo-b{font-size:9px;background:#222;color:var(--ac);padding:2px 8px;border-radius:10px}
.hd-user{display:flex;align-items:center;gap:10px;cursor:pointer;padding:4px 12px;border-radius:var(--rs)}
.hd-user:hover{background:var(--bg3)}
.hd-uname{font-size:12px;font-weight:500}
.hd-urole{font-size:10px;color:var(--tx2)}
.hd-uav{width:30px;height:30px;border-radius:50%;background:var(--ac);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px;color:#0a0a0a}
.tabs{display:flex;gap:2px;padding:0 16px;height:40px;min-height:40px;background:var(--bgs);border-bottom:1px solid var(--bd);overflow-x:auto}
.tab{padding:8px 16px;font-size:12px;font-weight:500;color:var(--tx2);border:none;background:none;white-space:nowrap;transition:all var(--t);border-radius:var(--rx) var(--rx) 0 0}
.tab:hover{color:var(--tx);background:var(--bg3)}
.tab.on{color:var(--ac);background:var(--bg2);border-bottom:2px solid var(--ac)}
.tab-icon{margin-right:5px}
.main{display:flex;flex:1;overflow:hidden}
.sb{width:260px;min-width:260px;background:var(--bgs);border-right:1px solid var(--bd);display:flex;flex-direction:column;overflow:hidden;transition:all .3s ease}
.sb.collapsed{width:60px;min-width:60px}
.sb.collapsed .sb-list span,.sb.collapsed .sb-sec,.sb.collapsed .sb-name,.sb.collapsed .sb-role,.sb.collapsed .sb-active,.sb.collapsed .sb-ai,.sb.collapsed .sb-dot{display:none}
.sb.collapsed .sb-item{justify-content:center;padding:6px 4px}
.sb.collapsed .sb-hd span{display:none}
.sb.collapsed .sb-item.room-item{padding:8px 4px}
.sb-hd{padding:10px 12px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--bd)}
.sb-title{font-size:13px;font-weight:600}
.sb-toggle{background:none;border:none;color:var(--tx2);font-size:16px;cursor:pointer;padding:4px 6px;border-radius:4px;transition:all .2s}
.sb-toggle:hover{color:var(--ac);background:var(--bg3)}
.sb-sec{padding:10px 12px 4px;font-size:10px;color:var(--tx3);text-transform:uppercase;letter-spacing:1px;font-weight:600}
.sb-list{flex:1;overflow-y:auto;padding:0 8px 8px}
.sb-item{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:var(--rs);transition:all var(--t);position:relative}
.sb-item:hover{background:var(--bg3);cursor:pointer}
.sb-item.on{background:#1a1a1a}
.sb-item.on::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:3px;height:20px;background:var(--ac);border-radius:0 3px 3px 0}
.sb-item.room-item{border:1px solid var(--bd);margin-bottom:6px;background:var(--bg2);padding:12px}
.sb-item.room-item.on{border-color:var(--ac)}
.sb-name{font-size:12px;font-weight:600}
.sb-role{font-size:10px;color:var(--tx2)}
.sb-dot{width:7px;height:7px;border-radius:50%;background:var(--grn);box-shadow:0 0 6px rgba(0,214,143,.4);flex-shrink:0}
.sb-ai{font-size:8px;padding:1px 5px;border-radius:4px;font-weight:600;margin-top:2px;display:inline-block}
.sb-active{display:flex;align-items:center;gap:4px;font-size:10px;color:var(--ac);margin-top:3px}
.sb-active-dot{width:5px;height:5px;border-radius:50%;background:var(--ac);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.chat{flex:1;display:flex;flex-direction:column;overflow:hidden}
.chat-hd{padding:12px 20px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--bd);background:var(--bg2)}
.chat-hd-l{display:flex;align-items:center;gap:10px}
.chat-hd-name{font-size:14px;font-weight:600}
.chat-hd-info{font-size:11px;color:var(--tx2)}
.chat-hd-tag{font-size:9px;padding:2px 8px;border-radius:8px;background:#1a2400;color:var(--ac);margin-left:6px}
.hbtn{padding:5px 10px;font-size:11px;border:1px solid var(--bd);background:transparent;color:var(--tx2);border-radius:var(--rx);transition:all var(--t)}
.hbtn:hover{border-color:var(--ac);color:var(--ac)}
.msgs{flex:1;overflow-y:auto;padding:16px 20px;display:flex;flex-direction:column;gap:6px}
.mg{display:flex;gap:10px;max-width:88%;animation:mi .3s ease;padding:8px 0}
@keyframes mi{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.mg.usr{align-self:flex-end;flex-direction:row-reverse}
.mg-av{width:54px;height:54px;flex-shrink:0;border-radius:50%;overflow:hidden;margin-top:2px}
.mg-bd{display:flex;flex-direction:column;gap:3px;min-width:0}
.mg-sn{font-size:10px;font-weight:600;color:var(--tx2);display:flex;align-items:center;gap:5px;flex-wrap:wrap}
.mg-badge{font-size:8px;padding:1px 6px;border-radius:6px;font-weight:600}
.mg-ai-tag{font-size:8px;padding:1px 6px;border-radius:4px;font-weight:700;letter-spacing:.3px}
.ai-gemini{background:#1a3a4a;color:#4ecdc4}
.ai-gpt{background:#1a2a1a;color:#74aa9c}
.ai-claude{background:#2a1a0a;color:#d4a574}
.ai-mj{background:#2a1a2a;color:#c084fc}
.mg.usr .mg-sn{justify-content:flex-end}
.mg-bb{padding:10px 14px;border-radius:10px;font-size:13px;line-height:1.7;background:var(--bg2);border:1px solid var(--bd);word-break:break-word}
.mg.usr .mg-bb{background:#161e00;border-color:#2a3a00}
.mg-bb.sys{background:transparent;border:1px dashed var(--bd);color:var(--tx2);font-size:11px;text-align:center;padding:8px 14px;max-width:100%}
.mg-bb.pm-sum{background:#0d1a00;border-color:#1a2a00;border-left:3px solid var(--ac)}
.mg-bb.work{border-left:3px solid;font-size:12.5px}
.mg-bb pre{background:var(--bg);padding:10px;border-radius:var(--rx);margin:8px 0;font-family:'JetBrains Mono',monospace;font-size:11px;overflow-x:auto;white-space:pre-wrap}
.mg-bb code{background:var(--bg);padding:1px 5px;border-radius:3px;font-family:'JetBrains Mono',monospace;font-size:11px}
.mg-time{font-size:9px;color:var(--tx3)}
.mg.usr .mg-time{text-align:right}
.mg-file{margin-top:6px;border-radius:var(--rs);overflow:hidden;border:1px solid var(--bd)}
.mg-file img{max-width:300px;max-height:260px;display:block}
.mg-file-i{display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg3);font-size:11px;color:var(--tx2)}
.mg-img{margin-top:8px;border-radius:var(--rs);overflow:hidden;border:1px solid var(--bd);position:relative}
.mg-img img{max-width:400px;max-height:400px;display:block;width:100%}
.mg-img-label{position:absolute;bottom:6px;right:6px;background:rgba(0,0,0,.7);color:#fff;font-size:9px;padding:2px 8px;border-radius:4px;backdrop-filter:blur(4px)}
.mj-box{margin-top:10px;border:1px solid #3a2a4a;border-radius:var(--rs);overflow:hidden;background:#1a1020}
.mj-box-hd{display:flex;align-items:center;justify-content:space-between;padding:6px 12px;background:#2a1a3a;font-size:10px;color:#c084fc;font-weight:600}
.mj-box-hd button{font-size:10px;padding:3px 10px;border-radius:4px;border:1px solid #c084fc;background:transparent;color:#c084fc;cursor:pointer;transition:all .2s}
.mj-box-hd button:hover{background:#c084fc;color:#0a0a0a}
.gen-img-box{margin-top:10px;border:1px solid #2a3a2a;border-radius:var(--rs);overflow:hidden;background:#0a1a0a;padding:10px}
.gen-img-label{font-size:10px;color:var(--ac);font-weight:600;margin-bottom:8px}
.gen-img{width:100%;max-width:400px;border-radius:8px;cursor:zoom-in;transition:transform .2s}
.gen-img:hover{transform:scale(1.02)}
.img-gen-btn{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:6px;border:1px solid var(--ac);background:transparent;color:var(--ac);font-size:11px;cursor:pointer;transition:all .2s}
.img-gen-btn:hover{background:var(--ac);color:#0a0a0a}
.mj-prompt{padding:10px 12px;font-size:11px;font-family:'JetBrains Mono',monospace;color:#e0d0f0;line-height:1.5;word-break:break-word;user-select:all}
.tts-btn{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;margin-top:6px;border-radius:4px;border:1px solid var(--bd);background:var(--bg1);color:var(--tx2);font-size:10px;cursor:pointer;transition:all .2s}
.tts-btn:hover{border-color:var(--ac);color:var(--ac)}
.tts-btn.playing{border-color:#c084fc;color:#c084fc;background:#1a1020}
.tts-btn.loading{opacity:.6;cursor:wait}
.av-img{border-radius:50%;object-fit:cover;border:2px solid var(--bd)}
.av-vid{border-radius:50%;object-fit:cover;object-position:center 20%;transform:scale(1.35);border:2px solid var(--bd);background:#0a0a0a}
.av-vid.speaking{border-color:var(--ac);box-shadow:0 0 12px rgba(200,255,0,.3);animation:avPulse 2s infinite}
.av-vid.working{border-color:#c084fc;box-shadow:0 0 8px rgba(192,132,252,.3)}
@keyframes avPulse{0%,100%{box-shadow:0 0 8px rgba(200,255,0,.2)}50%{box-shadow:0 0 16px rgba(200,255,0,.5)}}
.av-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:12px;margin-top:12px}
.av-card{background:var(--bg1);border:1px solid var(--bd);border-radius:var(--rs);padding:14px 10px;text-align:center;transition:all .2s}
.av-card:hover{border-color:var(--ac)}
.av-card img,.av-card svg{width:72px;height:72px;border-radius:50%;margin-bottom:8px}
.av-card-name{font-size:12px;font-weight:600;margin-bottom:2px}
.av-card-role{font-size:10px;color:var(--tx2);margin-bottom:6px}
.av-card input[type=file]{display:none}
.av-card-btn{font-size:9px;padding:3px 8px;border-radius:4px;border:1px solid var(--bd);background:var(--bg2);color:var(--tx2);cursor:pointer}
.av-card-btn:hover{border-color:var(--ac);color:var(--ac)}
.av-mj-btn{margin-top:10px;width:100%;padding:8px;border-radius:var(--rs);border:1px dashed #c084fc;background:transparent;color:#c084fc;font-size:11px;cursor:pointer;transition:all .2s}
.av-mj-btn:hover{background:#c084fc22}
.typ{display:none;align-items:center;gap:8px;padding:0 20px 8px;font-size:11px;color:var(--tx2)}
.typ-dots{display:flex;gap:3px}
.typ-dots span{width:4px;height:4px;background:var(--tx2);border-radius:50%;animation:db 1.4s infinite}
.typ-dots span:nth-child(2){animation-delay:.2s}
.typ-dots span:nth-child(3){animation-delay:.4s}
@keyframes db{0%,60%,100%{transform:translateY(0);opacity:.4}30%{transform:translateY(-5px);opacity:1}}
.inp-wrap{padding:10px 20px 14px;border-top:1px solid var(--bd);background:var(--bg2)}
.fp-bar{display:none;padding:6px 0;gap:6px;flex-wrap:wrap}
.fp-bar.show{display:flex}
.fp-chip{display:flex;align-items:center;gap:5px;padding:3px 8px;background:var(--bg3);border:1px solid var(--bd);border-radius:var(--rx);font-size:10px}
.fp-chip img{width:28px;height:28px;object-fit:cover;border-radius:3px}
.fp-x{cursor:pointer;color:var(--tx3);font-size:13px}
.fp-x:hover{color:var(--red)}
.inp-box{display:flex;align-items:flex-end;gap:8px;background:var(--bgi);border:1px solid var(--bd);border-radius:var(--r);padding:8px 12px;transition:border-color var(--t)}
.inp-box:focus-within{border-color:var(--ac)}
.inp{flex:1;background:none;border:none;outline:none;color:var(--tx);font-family:inherit;font-size:13px;resize:none;max-height:100px;line-height:1.5}
.inp::placeholder{color:var(--tx3)}
.ibtn{width:32px;height:32px;border-radius:50%;border:none;display:flex;align-items:center;justify-content:center;transition:all var(--t);flex-shrink:0;background:transparent;color:var(--tx2)}
.ibtn:hover{background:var(--bg3);color:var(--tx)}
.ibtn.send{background:var(--ac)!important;color:#0a0a0a!important}
.ibtn svg{width:16px;height:16px}
.inp-hint{font-size:10px;color:var(--tx3);padding:5px 0 0}
.sl-menu{display:none;position:absolute;bottom:100%;left:0;right:0;background:var(--bg2);border:1px solid var(--bd);border-radius:var(--r);margin-bottom:6px;padding:4px;box-shadow:var(--sh);max-height:220px;overflow-y:auto;z-index:50}
.sl-menu.show{display:block}
.sl-it{padding:7px 10px;border-radius:var(--rx);transition:background var(--t);display:flex;align-items:center;gap:8px}
.sl-it:hover{background:var(--bg3);cursor:pointer}
.sl-cmd{font-size:12px;font-weight:600;color:var(--ac);font-family:'JetBrains Mono',monospace}
.sl-desc{font-size:11px;color:var(--tx2)}
.pnl{display:none;flex:1;overflow:hidden}
.pnl.on{display:flex}
.pc{flex:1;overflow-y:auto;padding:24px}
.pt{font-size:18px;font-weight:700;margin-bottom:20px}
.pbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
.btn{padding:7px 16px;border-radius:var(--rx);font-size:12px;font-weight:500;border:none;font-family:inherit;transition:all var(--t)}
.btn-p{background:var(--ac);color:#0a0a0a}
.btn-p:hover{background:var(--ac2)}
.btn-g{background:transparent;color:var(--tx2);border:1px solid var(--bd)}
.btn-d{background:transparent;color:var(--red);border:1px solid var(--red)}
.cg{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
.cd{background:var(--bg2);border:1px solid var(--bd);border-radius:var(--r);padding:18px;transition:all var(--t)}
.cd:hover{border-color:var(--bd2);transform:translateY(-1px)}
.cd-top{display:flex;justify-content:space-between;margin-bottom:10px}
.cd-badge{font-size:9px;padding:2px 8px;border-radius:8px;font-weight:600}
.cd-title{font-size:13px;font-weight:600;margin-bottom:6px}
.cd-desc{font-size:11px;color:var(--tx2);line-height:1.5;margin-bottom:10px}
.cd-bar{height:3px;background:#1a1a1a;border-radius:2px;overflow:hidden;margin-bottom:6px}
.cd-fill{height:100%;border-radius:2px}
.cd-meta{font-size:10px;color:var(--tx3);display:flex;justify-content:space-between}
.xbtn{font-size:10px;color:var(--tx3);background:none;border:none;padding:2px 4px}
.xbtn:hover{color:var(--red)}
.tw{display:flex;gap:0;height:100%}
.tc{flex:1;display:flex;flex-direction:column;border-right:1px solid var(--bd)}
.tc:last-child{border-right:none}
.tc-hd{padding:10px 14px;font-size:12px;font-weight:600;border-bottom:1px solid var(--bd);display:flex;align-items:center;justify-content:space-between;background:var(--bg2)}
.tc-cnt{font-size:10px;background:#1a1a1a;color:var(--tx2);padding:2px 6px;border-radius:8px}
.tc-list{flex:1;overflow-y:auto;padding:6px;display:flex;flex-direction:column;gap:4px}
.ti{padding:8px 10px;background:var(--bg2);border:1px solid var(--bd);border-radius:var(--rs);cursor:grab;font-size:12px}
.ti:hover{border-color:var(--bd2)}
.ti-title{font-weight:500;margin-bottom:3px}
.ti-meta{font-size:10px;color:var(--tx2);display:flex;justify-content:space-between}
.tc-add{margin:4px 6px 6px;padding:6px;border:1px dashed var(--bd);border-radius:var(--rs);background:none;color:var(--tx3);font-size:11px;transition:all var(--t)}
.tc-add:hover{border-color:var(--ac);color:var(--ac)}
.tc.dov{background:rgba(200,255,0,.02)}
.pdot{width:5px;height:5px;border-radius:50%;display:inline-block;margin-right:5px}
.fg{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px}
.fc{background:var(--bg2);border:1px solid var(--bd);border-radius:var(--r);padding:18px}
.fc-l{font-size:10px;color:var(--tx2);margin-bottom:6px}
.fc-v{font-size:22px;font-weight:700}
.change-up{color:var(--grn)}.change-down{color:var(--red)}
.dl{display:flex;flex-direction:column;gap:6px}
.di{display:flex;align-items:center;gap:12px;padding:12px 16px;background:var(--bg2);border:1px solid var(--bd);border-radius:var(--rs);transition:all var(--t)}
.di:hover{border-color:var(--bd2);cursor:pointer}
.di-icon{font-size:22px}.di-info{flex:1}.di-name{font-size:12px;font-weight:500}.di-meta{font-size:10px;color:var(--tx2);margin-top:1px}
.ps{display:flex;gap:10px}
.psi{flex:1;background:var(--bg2);border:1px solid var(--bd);border-radius:var(--r);padding:14px;text-align:center}
.psi-n{font-size:10px;color:var(--tx2);margin-bottom:4px}
.psi-c{font-size:26px;font-weight:700}
.sr{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--bg2);border:1px solid var(--bd);border-radius:var(--rs);margin-bottom:6px;flex-wrap:wrap;gap:8px}
.sr-l{font-size:12px}.sr-d{font-size:10px;color:var(--tx2);margin-top:1px}
.sr-inp{padding:7px 12px;background:var(--bgi);border:1px solid var(--bd);border-radius:var(--rx);color:var(--tx);font-family:inherit;font-size:12px;width:280px}
.sr-inp:focus{outline:none;border-color:var(--ac)}
.sr-status{font-size:10px;padding:2px 8px;border-radius:6px}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:200;align-items:center;justify-content:center;backdrop-filter:blur(3px)}
.modal.show{display:flex}
.mdl{background:var(--bg2);border:1px solid var(--bd);border-radius:var(--r);width:560px;max-width:90vw;max-height:80vh;overflow-y:auto;box-shadow:var(--sh)}
.mdl-hd{padding:18px 22px;border-bottom:1px solid var(--bd);display:flex;align-items:center;justify-content:space-between}
.mdl-title{font-size:15px;font-weight:700}
.mdl-x{background:none;border:none;color:var(--tx2);font-size:18px}.mdl-x:hover{color:var(--tx)}
.mdl-bd{padding:22px}.mdl-ft{padding:14px 22px;border-top:1px solid var(--bd);display:flex;justify-content:flex-end;gap:8px}
.mi{width:100%;padding:9px 12px;background:var(--bgi);border:1px solid var(--bd);border-radius:var(--rs);color:var(--tx);font-family:inherit;font-size:12px;line-height:1.5}
.mi:focus{outline:none;border-color:var(--ac)}
.ml{font-size:11px;font-weight:500;color:var(--tx2);margin-bottom:5px;display:block}
.mr{margin-bottom:12px}
.ms{padding:7px 10px;background:var(--bgi);border:1px solid var(--bd);border-radius:var(--rx);color:var(--tx);font-family:inherit;font-size:12px}
.welcome{text-align:center;padding:40px 20px 30px}
.w-hi{font-size:12px;color:var(--tx2);margin-bottom:6px}
.w-title{font-size:26px;font-weight:900;margin-bottom:6px}
.w-title b{color:var(--ac)}
.w-sub{font-size:13px;color:var(--tx2);margin-bottom:8px;line-height:1.6}
.w-flow{display:flex;align-items:center;justify-content:center;gap:6px;margin:14px 0;flex-wrap:wrap}
.w-step{padding:5px 12px;border-radius:20px;font-size:10px;font-weight:500;border:1px solid var(--bd);background:var(--bg2)}
.w-arrow{color:var(--ac);font-size:14px}
.w-acts{display:flex;gap:10px;justify-content:center;margin-top:18px;flex-wrap:wrap}
.w-btn{padding:9px 18px;background:var(--bg2);border:1px solid var(--bd);border-radius:var(--r);font-size:11px;color:var(--tx);transition:all var(--t);font-family:inherit}
.w-btn:hover{border-color:var(--ac);color:var(--ac);cursor:pointer}
.ai-map{display:flex;flex-wrap:wrap;gap:6px;margin-top:12px;justify-content:center}
.ai-map-item{font-size:10px;padding:4px 10px;border-radius:8px;border:1px solid var(--bd);background:var(--bg2);display:flex;align-items:center;gap:4px}
.toast{position:fixed;bottom:20px;right:20px;padding:10px 18px;background:var(--bg2);border:1px solid var(--ac);border-radius:var(--rs);font-size:12px;color:var(--ac);z-index:300;box-shadow:var(--sh);animation:ti .3s}
@keyframes ti{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.ss-title{font-size:14px;font-weight:600;margin:20px 0 10px;display:flex;align-items:center;gap:8px}
.ss-title img{width:18px;height:18px}
/* Project v2 */
.proj-filter{display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap}
.proj-filter-btn{padding:5px 12px;border-radius:20px;font-size:11px;border:1px solid var(--bd);background:transparent;color:var(--tx2);cursor:pointer;transition:all var(--t)}
.proj-filter-btn.on{border-color:var(--ac);color:var(--ac);background:rgba(200,255,0,.05)}
.cd-team{display:flex;gap:3px;margin-bottom:8px;align-items:center}
.cd-av{width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:8px;font-weight:700;color:#0a0a0a;flex-shrink:0;border:1.5px solid var(--bg)}
.cd-phases{display:flex;gap:2px;margin-bottom:8px}
.cd-phase{flex:1;height:3px;border-radius:2px;background:#1a1a1a}
.cd-phase.done{background:var(--grn)}.cd-phase.progress{background:var(--ac)}
.cd-actions{display:flex;gap:6px;margin-top:10px;border-top:1px solid var(--bd);padding-top:10px}
.cd:hover{border-color:var(--ac)!important}
.proj-detail-phase{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--bd2)}
.proj-detail-phase:last-child{border-bottom:none}
.proj-phase-dot{width:16px;height:16px;border-radius:50%;border:2px solid var(--bd);flex-shrink:0}
.proj-phase-dot.done{border-color:var(--grn);background:var(--grn)}
.proj-phase-dot.progress{border-color:var(--ac);background:var(--ac)}
.proj-team-chips{display:flex;gap:6px;flex-wrap:wrap;margin:8px 0}
.proj-team-chip{display:flex;align-items:center;gap:5px;padding:4px 10px;border-radius:20px;border:1px solid var(--bd);background:var(--bg3);font-size:11px}
.team-cb-label{display:flex;align-items:center;gap:5px;font-size:11px;cursor:pointer;padding:5px 8px;border-radius:var(--rx);border:1px solid var(--bd);background:var(--bg3);transition:all var(--t)}
.team-cb-label:hover{border-color:var(--ac)}
@media(max-width:768px){
  .mob-menu{display:block}
  .sb{width:0;min-width:0;border:none;position:fixed;left:0;top:0;z-index:101;background:var(--bg2);height:100vh}
  .sb:not(.collapsed){width:260px;min-width:260px;border-right:1px solid var(--bd);box-shadow:4px 0 20px rgba(0,0,0,.5)}
  .sb.collapsed{width:0;min-width:0;border:none}
  .sb-list span,.sb-hd span{font-size:12px}
  .fg{grid-template-columns:repeat(2,1fr)}
  .hd{padding:8px 12px;height:44px;min-height:44px}
  .logo-t{font-size:14px}.logo-b{font-size:8px}
  .hd-uname{font-size:11px}.hd-urole{font-size:9px}
  .hd-uav{width:26px;height:26px;font-size:11px}
  .tabs{gap:0;padding:0 2px;overflow-x:auto;flex-wrap:nowrap;justify-content:flex-start;height:34px;min-height:34px}
  .tab{font-size:10px;padding:6px 8px;white-space:nowrap}
  .tab-icon{margin-right:3px}
  .chat-hd{padding:8px 12px}
  .chat-hd-name{font-size:13px}
  .chat-hd-info{font-size:10px;display:none}
  .ch-hd{padding:8px 12px}
  .ch-hd .av-img,.ch-hd .ch-hd-av{width:36px;height:36px;min-width:36px}
  .ch-hd-name{font-size:14px}.ch-hd-desc{font-size:10px}
  .msgs{padding:10px 8px}
  .mg{max-width:92%;gap:6px}
  .mg-av{width:36px;height:36px}
  .mg-bb{font-size:13px;padding:10px 12px;line-height:1.6}
  .mg-sn{font-size:9px}
  .mg-time{font-size:8px}
  .msg-text{font-size:13px;padding:10px 12px}
  .msg-name{font-size:10px}.msg-badge{font-size:8px;padding:1px 4px}
  .msg-time{font-size:9px}
  /* ì…ë ¥ì°½ ëŒ€í­ ê°œì„  */
  .inp-wrap{padding:8px 8px 0;padding-bottom:calc(12px + env(safe-area-inset-bottom));position:sticky;bottom:0;background:var(--bg2);z-index:10}
  .inp-box{padding:10px 12px;border-radius:20px;gap:8px}
  .inp{font-size:16px!important;line-height:1.5;max-height:120px}
  .ibtn{width:40px;height:40px}
  .ibtn.send{width:40px;height:40px}
  .ibtn svg{width:18px;height:18px}
  .inp-hint{display:none}
  .img-gen-btn{padding:6px 12px;font-size:12px}
  .ch-inp{padding:8px 10px}
  .ch-inp textarea{font-size:16px}
  .ch-inp .send-btn{width:40px;height:40px}
  .pc{padding:14px 12px}
  .pt{font-size:16px}
  .sr{flex-direction:column;align-items:flex-start;gap:8px}
  .sr-inp{width:100%;min-width:0!important;font-size:14px;padding:10px}
  .sr-d{font-size:10px}
  .pnl{min-width:0}
  .main{min-width:0;overflow-x:hidden}
  body{overflow-x:hidden}
  /* ì›°ì»´ í™”ë©´ ëª¨ë°”ì¼ ìµœì í™” */
  .welcome{padding:16px 8px}
  .w-hi{font-size:14px}
  .w-title{font-size:18px}
  .w-sub{font-size:12px}
  .w-acts{flex-wrap:wrap;gap:6px}
  .w-btn{font-size:11px;padding:8px 12px}
  .w-flow{flex-wrap:wrap;gap:4px}
  .w-step{font-size:10px;padding:4px 8px}
  .ai-map{flex-wrap:wrap;gap:4px}
  .ai-map-item{font-size:9px}
  /* ëª¨ë‹¬ ëª¨ë°”ì¼ */
  .mdl{width:95vw;max-height:90vh}
  .mi,.ms{font-size:14px;padding:10px}
}
/* ì‚¬ìš©ëŸ‰ ìœ„ì ¯ */
.usage-pill{display:flex;align-items:center;gap:6px;padding:4px 10px;border-radius:16px;background:var(--bg3);border:1px solid var(--bd);cursor:pointer;transition:all .2s;font-size:11px;color:var(--tx2);white-space:nowrap}
.usage-pill:hover{border-color:var(--ac);color:var(--ac)}
.usage-pill .u-dot{width:6px;height:6px;border-radius:50%;background:var(--grn);box-shadow:0 0 6px rgba(0,214,143,.4);animation:pulse 2s infinite}
.usage-pill .u-dot.off{background:var(--red);box-shadow:0 0 6px rgba(255,77,106,.4)}
.usage-pill .u-num{font-weight:600;font-family:'JetBrains Mono',monospace;color:var(--ac);font-size:12px}
.usage-pop{display:none;position:fixed;top:50px;right:20px;width:340px;background:var(--bg2);border:1px solid var(--bd2);border-radius:var(--r);padding:0;z-index:200;box-shadow:var(--sh);overflow:hidden}
.usage-pop.show{display:block;animation:mi .2s ease}
.usage-pop-hd{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--bd);background:var(--bg3)}
.usage-pop-hd span{font-size:13px;font-weight:600}
.usage-pop-hd button{background:none;border:none;color:var(--tx3);font-size:14px;cursor:pointer}
.usage-pop-bd{padding:14px 16px}
.usage-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;font-size:12px}
.usage-row .u-label{color:var(--tx2)}
.usage-row .u-val{font-weight:600;font-family:'JetBrains Mono',monospace}
.usage-bar-wrap{margin:10px 0 6px;height:4px;background:var(--bg);border-radius:2px;overflow:hidden}
.usage-bar-fill{height:100%;background:linear-gradient(90deg,var(--ac),var(--grn));border-radius:2px;transition:width .5s ease}
.usage-sec{font-size:10px;color:var(--tx3);text-transform:uppercase;letter-spacing:1px;font-weight:600;margin:12px 0 6px;padding-top:8px;border-top:1px solid var(--bd)}
.usage-src{display:flex;gap:8px;flex-wrap:wrap}
.usage-src-tag{font-size:10px;padding:2px 8px;border-radius:8px;background:var(--bg);font-family:'JetBrains Mono',monospace}
.usage-chart{display:flex;align-items:flex-end;gap:3px;height:40px;margin-top:6px}
.usage-chart-bar{flex:1;background:var(--ac);border-radius:2px 2px 0 0;min-height:2px;opacity:0.7;transition:all .3s}
.usage-chart-bar:last-child{opacity:1}
@media(max-width:768px){.usage-pop{right:10px;width:calc(100vw - 20px);top:46px}.usage-pill span.u-txt{display:none}}
</style>
</head>
<body>
<header class="hd"><button class="mob-menu" id="mobMenu" onclick="toggleSB()">â˜°</button><div class="logo"><div class="logo-i">M</div><span class="logo-t">MOTIVE</span><span class="logo-b">AI Teammate</span></div><div style="display:flex;align-items:center;gap:10px"><div class="usage-pill" id="usagePill" onclick="toggleUsagePop()"><div class="u-dot" id="uDot"></div><span class="u-num" id="uNum">--</span><span class="u-txt">req</span></div><div class="hd-user" onclick="switchTab('settings')"><div style="text-align:right"><div class="hd-uname">ì±„í¬ì›… ëŒ€í‘œë‹˜</div><div class="hd-urole">CEO</div></div><div class="hd-uav">ì±„</div></div></div></header>
<div class="usage-pop" id="usagePop">
  <div class="usage-pop-hd"><span>Claude Max ì‚¬ìš©ëŸ‰</span><button onclick="toggleUsagePop()">âœ•</button></div>
  <div class="usage-pop-bd" id="usagePopBd">
    <div class="usage-row"><span class="u-label">í”Œëœ</span><span class="u-val" id="uPlan" style="color:var(--ac)">--</span></div>
    <div class="usage-sec" style="margin-top:0">ì´ë²ˆ ë‹¬</div>
    <div class="usage-row"><span class="u-label">ì›”ê°„ ìš”ì²­</span><span class="u-val" style="color:var(--ac)" id="uMonth">--</span></div>
    <div class="usage-bar-wrap"><div class="usage-bar-fill" id="uMonthBar" style="width:0%"></div></div>
    <div class="usage-row"><span class="u-label">ë¦¬ì…‹ê¹Œì§€</span><span class="u-val" id="uReset">--</span></div>
    <div class="usage-sec">ì˜¤ëŠ˜</div>
    <div class="usage-row"><span class="u-label">ì˜¤ëŠ˜ ìš”ì²­</span><span class="u-val" id="uToday">--</span></div>
    <div class="usage-row"><span class="u-label">ë§ˆì§€ë§‰</span><span class="u-val" style="font-size:10px" id="uLast">--</span></div>
    <div class="usage-row"><span class="u-label">ì„œë²„ ê°€ë™</span><span class="u-val" id="uUptime">--</span></div>
    <div class="usage-sec">ì†ŒìŠ¤ë³„ (ì´ë²ˆ ë‹¬)</div>
    <div class="usage-src" id="uSrc"></div>
    <div class="usage-sec">ìµœê·¼ 7ì¼</div>
    <div class="usage-chart" id="uChart"></div>
    <div style="margin-top:8px;font-size:9px;color:var(--tx3);text-align:center">ëˆ„ì  <span id="uTotal">0</span>íšŒ | ë§¤ì›” 1ì¼ ë¦¬ì…‹</div>
  </div>
</div>
<div class="tabs" id="tabBar"></div>
<div class="main">
  <aside class="sb" id="sideBar"><div class="sb-hd"><span class="sb-title">ì±„ë„</span><button class="sb-toggle" onclick="toggleSB()" title="ì‚¬ì´ë“œë°” ì ‘ê¸°/í¼ì¹˜ê¸°">â—€</button></div><div class="sb-list" id="sbList"></div></aside>
  <div class="pnl on" id="p-chat"><div class="chat"><div class="chat-hd" id="chatHd"></div><div class="msgs" id="msgs"></div><div class="typ" id="typInd"><div class="typ-dots"><span></span><span></span><span></span></div><span id="typTx"></span></div>
    <div class="inp-wrap" style="position:relative"><div class="sl-menu" id="slMenu"></div><div class="fp-bar" id="fpBar"></div><div class="inp-box"><button class="ibtn" onclick="document.getElementById('fInp').click()" title="íŒŒì¼"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/></svg></button><input type="file" id="fInp" multiple accept="image/*,.pdf,.txt,.csv,.json,.md,.doc,.docx" style="display:none" onchange="onFiles(event)"><textarea class="inp" id="chatInp" rows="1" placeholder="ì—…ë¬´ë¥¼ ì§€ì‹œí•˜ë©´ ê° íŒ€ì›ì´ ì „ë¬¸ AIë¡œ ì‹¤ì œ ì‘ì—…í•©ë‹ˆë‹¤..."></textarea><button class="img-gen-btn" id="imgGenBtn" onclick="quickImgGen()" style="display:none" title="ì´ë¯¸ì§€ ìƒì„±">ğŸ¨</button><button class="ibtn send" onclick="send()"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button></div><div class="inp-hint">ì—…ë¬´ë³„ ìµœì  AI ìë™ ë°°ì • Â· í¬ë¦¬ì—ì´í‹°ë¸ŒíŒ€ ğŸ¨ ì´ë¯¸ì§€ Â· ğŸ”Š ElevenLabs ìŒì„±</div></div>
  </div></div>
  <div class="pnl" id="p-project"><div class="pc"><div class="pbar"><div class="pt" style="margin:0">í”„ë¡œì íŠ¸ <span style="font-size:12px;font-weight:400;color:var(--tx3)" id="projCount"></span></div><div style="display:flex;gap:8px"><button class="btn btn-g" style="font-size:11px" onclick="projAutoSync()">ğŸ”„ ë™ê¸°í™”</button><button class="btn btn-p" onclick="openProjM()">+ ìƒˆ í”„ë¡œì íŠ¸</button></div></div><div class="proj-filter" id="projFilterBar"><button class="proj-filter-btn on" onclick="setFilter('all',this)">ì „ì²´</button><button class="proj-filter-btn" onclick="setFilter('plan',this)">ğŸ”µ ê¸°íš</button><button class="proj-filter-btn" onclick="setFilter('progress',this)">ğŸŸ¡ ì§„í–‰</button><button class="proj-filter-btn" onclick="setFilter('done',this)">ğŸŸ¢ ì™„ë£Œ</button></div><div class="cg" id="projG"></div></div></div>
  <div class="pnl" id="p-todo"><div class="pc" style="padding:0;display:flex;flex-direction:column;height:100%"><div style="padding:14px 22px;border-bottom:1px solid var(--bd)"><div class="pt" style="margin:0">í• ì¼</div></div><div class="tw" id="todoW"></div></div></div>
  <div class="pnl" id="p-finance"><div class="pc"><div class="pbar"><div class="pt" style="margin:0">ì¬ë¬´</div><button class="btn btn-p" onclick="openM('txM')">+</button></div><div class="fg" id="finG"></div><div style="font-size:14px;font-weight:600;margin-bottom:12px">ê±°ë˜</div><div id="finL"></div></div></div>
  <div class="pnl" id="p-docs"><div class="pc"><div class="pbar"><div class="pt" style="margin:0">ë¬¸ì„œ</div><button class="btn btn-p" onclick="openM('docM')">+</button></div><div class="dl" id="docL"></div></div></div>
  <div class="pnl" id="p-biz"><div class="pc"><div class="pt">ë¹„ì¦ˆë‹ˆìŠ¤</div><div class="pbar"><div style="font-size:14px;font-weight:600">íŒŒì´í”„ë¼ì¸</div><button class="btn btn-p" onclick="openM('dealM')">+</button></div><div class="ps" id="pipeS"></div><div style="font-size:14px;font-weight:600;margin:18px 0 12px">ë”œ</div><div class="dl" id="dealL"></div></div></div>
  <div class="pnl" id="p-settings"><div class="pc"><div class="pt">ì„¤ì •</div>
    <div class="ss-title">ğŸ¤– AI API í‚¤ ê´€ë¦¬</div>
    <p style="font-size:11px;color:var(--tx2);margin-bottom:14px;line-height:1.6">ì—…ë¬´ íŠ¹ì„±ì— ë§ê²Œ ìµœì  AIë¥¼ ìë™ ë°°ì •í•©ë‹ˆë‹¤. Gemini í‚¤ë§Œìœ¼ë¡œ ë¬´ë£Œ ì‚¬ìš© ê°€ëŠ¥, ì¶”ê°€ í‚¤ ì…ë ¥ ì‹œ í’ˆì§ˆì´ í–¥ìƒë©ë‹ˆë‹¤.</p>
    <div class="sr" style="border:1px solid var(--ac);background:rgba(198,255,0,0.05);border-radius:var(--rs);padding:10px"><div><div class="sr-l">ğŸ–¥ï¸ ì•„ì´ë§¥ ë¦´ë ˆì´ <span style="font-size:10px;color:var(--ac)">â˜… ìµœìš°ì„  Â· Claude Max ë¬´ì œí•œ</span></div><div class="sr-d">ì•„ì´ë§¥ì—ì„œ relay-server.js ì‹¤í–‰ í›„ ngrok URL ì…ë ¥ Â· API í‚¤ ë¶ˆí•„ìš” Â· í• ë‹¹ëŸ‰ ë¬´ì œí•œ</div></div><div style="display:flex;align-items:center;gap:8px"><input class="sr-inp" id="kRelay" type="text" placeholder="https://xxxx.ngrok.io" oninput="saveKeys()" style="min-width:220px"><span class="sr-status" id="sRelay">ë¯¸ì„¤ì •</span></div></div>
    <div class="sr"><div><div class="sr-l">ğŸŸ¢ Gemini <span style="font-size:10px;color:var(--ac)">â˜… í•„ìˆ˜ (Pro 2.5 + Flash 2.5 + Lite 2.5 + Image)</span></div><div class="sr-d">aistudio.google.com Â· í‚¤ ì—¬ëŸ¬ê°œ ì…ë ¥ ì‹œ ìë™ êµì²´ (ì‰¼í‘œë¡œ êµ¬ë¶„) Â· í‚¤ 1ê°œë‹¹ 1,300íšŒ/ì¼</div></div><div style="display:flex;align-items:center;gap:8px"><input class="sr-inp" id="kGem" type="password" placeholder="AIza..., AIza..., AIza..." oninput="saveKeys()" style="min-width:220px"><span class="sr-status" id="sGem">ë¯¸ì„¤ì •</span></div></div>
    <div class="sr"><div><div class="sr-l">ğŸŸ  Anthropic Claude <span style="font-size:10px;color:var(--orn)">(ì„ íƒ Â· ê°œë°œ í’ˆì§ˆ ì—…ê·¸ë ˆì´ë“œ)</span></div><div class="sr-d">console.anthropic.com Â· ì…ë ¥ ì‹œ ê°œë°œ(ë„ìœ¤)ì´ Flashâ†’Claude í”„ë¦¬ë¯¸ì—„ ì „í™˜ Â· ì—†ì–´ë„ ë¬´ë£Œ Flashë¡œ ì‘ë™</div></div><div style="display:flex;align-items:center;gap:8px"><input class="sr-inp" id="kCla" type="password" placeholder="sk-ant-..." oninput="saveKeys()"><span class="sr-status" id="sCla">ë¯¸ì„¤ì •</span></div></div>
    <div class="sr"><div><div class="sr-l">ğŸŸ£ OpenAI GPT <span style="font-size:10px;color:var(--tx3)">(ì„ íƒ Â· ì¶”ê°€ ë°±ì—…)</span></div><div class="sr-d">platform.openai.com Â· ì…ë ¥ ì‹œ í• ë‹¹ëŸ‰ ì´ˆê³¼ ë°±ì—…ìœ¼ë¡œ ìë™ ì „í™˜</div></div><div style="display:flex;align-items:center;gap:8px"><input class="sr-inp" id="kOai" type="password" placeholder="sk-..." oninput="saveKeys()"><span class="sr-status" id="sOai">ë¯¸ì„¤ì •</span></div></div>
    <div class="sr"><div><div class="sr-l">ğŸ”Š ElevenLabs <span style="font-size:10px;color:var(--tx3)">(ì„ íƒ Â· íŒ€ì› ìŒì„± TTS Â· 14ëª… ê°ê° ë‹¤ë¥¸ ëª©ì†Œë¦¬)</span></div><div class="sr-d">elevenlabs.io Â· ë¬´ë£Œ í”Œëœ 10,000ì/ì›” Â· ë©”ì‹œì§€ë³„ ğŸ”Š ë²„íŠ¼ìœ¼ë¡œ ìŒì„± ì¬ìƒ</div></div><div style="display:flex;align-items:center;gap:8px"><input class="sr-inp" id="kEl" type="password" placeholder="xi-..." oninput="saveKeys()"><span class="sr-status" id="sEl">ë¯¸ì„¤ì •</span></div></div>
    <div style="margin:14px 0;padding:14px;background:var(--bg3);border:1px solid var(--bd);border-radius:var(--rs);font-size:10px;color:var(--tx2);line-height:1.8">
      <div style="font-weight:600;color:var(--tx);margin-bottom:6px">ğŸ§  ìŠ¤ë§ˆíŠ¸ ë¼ìš°íŒ… ë§µ (Gemini í‚¤ 1ê°œ â†’ 4ê°œ ëª¨ë¸ ìë™ ë°°ì •)</div>
      <span style="color:var(--ac)">â–¸ PM(í•˜ì¤€)</span> â†’ Gemini Pro 2.5 (ìµœê³  í’ˆì§ˆ ì¢…í•©ë³´ê³  Â· 50/ì¼)<br>
      <span style="color:#ab47bc">â–¸ ê¸°íšÂ·ì „ëµÂ·ë¦¬ì„œì¹˜Â·ì¬ë¬´Â·QAÂ·ë²•ë¬´</span> â†’ Gemini Flash 2.5 (ë¶„ì„Â·ì¶”ë¡  Â· 250/ì¼)<br>
      <span style="color:#ffa726">â–¸ ë§ˆì¼€íŒ…Â·ì˜ì—…Â·ì¸ì‚¬</span> â†’ Gemini Lite 2.5 (ë¹ ë¥¸ ëŒ€ëŸ‰ì²˜ë¦¬ Â· 1,000/ì¼)<br>
      <span style="color:#7e57c2">â–¸ ê°œë°œ(ë„ìœ¤)</span> â†’ Flash 2.5 ìš°ì„  (ë¬´ë£Œ) â†’ Claude í”„ë¦¬ë¯¸ì—„ ì—…ê·¸ë ˆì´ë“œ<br>
      <span style="color:#ff6b9d">â–¸ ë””ìì¸Â·ì˜ìƒÂ·í¬í† </span> â†’ Flash 2.5 + Flash Image (ì´ë¯¸ì§€ ìƒì„±)<br>
      <span style="color:#26c6da">â–¸ ë™ì  ì—…ê·¸ë ˆì´ë“œ</span> â†’ Lite ë©¤ë²„ë„ ë³µì¡í•œ ì§ˆë¬¸ ì‹œ ìë™ìœ¼ë¡œ Flash 2.5 ì „í™˜<br>
      <span style="color:var(--tx3)">â–¸ í• ë‹¹ëŸ‰ ì´ˆê³¼ ì‹œ</span> â†’ ìë™ìœ¼ë¡œ ë‹¤ìŒ ëª¨ë¸ ì „í™˜ (GPT/Claude í¬í•¨)
    </div>
    <div class="sr"><div><div class="sr-l">ì—°ê²° í…ŒìŠ¤íŠ¸</div></div><button class="btn btn-g" onclick="testAll()">ì „ì²´ í…ŒìŠ¤íŠ¸</button></div>
    <div class="pt" style="margin-top:24px">ğŸ¨ 3D ìºë¦­í„° ì•„ë°”íƒ€</div>
    <div style="font-size:11px;color:var(--tx2);margin-bottom:8px">ë¯¸ë“œì €ë‹ˆë¡œ ìƒì„±í•œ 3D ìºë¦­í„°ë¥¼ ê° íŒ€ì›ì—ê²Œ ì ìš©í•˜ì„¸ìš”. ì´ë¯¸ì§€ë¥¼ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ.</div>
    <button class="av-mj-btn" onclick="genAllMJAvatars()">ğŸ¨ ì „ì²´ 14ëª… ë¯¸ë“œì €ë‹ˆ í”„ë¡¬í”„íŠ¸ ìƒì„±</button>
    <div class="av-grid" id="avGrid"></div>
    <div class="ss-title">ğŸ—‚ ë°ì´í„°</div>
    <div class="sr"><div><div class="sr-l">ì „ì²´ ì´ˆê¸°í™”</div></div><button class="btn btn-d" onclick="resetAll()">ì´ˆê¸°í™”</button></div>
  </div></div>
</div>
<div class="modal" id="projM"><div class="mdl" style="width:580px"><div class="mdl-hd"><div class="mdl-title">ìƒˆ í”„ë¡œì íŠ¸</div><button class="mdl-x" onclick="closeM('projM')">&times;</button></div><div class="mdl-bd"><div class="mr"><label class="ml">í”„ë¡œì íŠ¸ ì´ë¦„ *</label><input class="mi" id="pN" placeholder="ì˜ˆ: ë§ˆì¼€íŒ… êµ¬ë… ì„œë¹„ìŠ¤ ëŸ°ì¹­"></div><div class="mr"><label class="ml">ì„¤ëª…</label><input class="mi" id="pD" placeholder="ëª©í‘œì™€ ë²”ìœ„ ê°„ëµíˆ"></div><div class="mr"><label class="ml">ì´ˆê¸° ìƒíƒœ</label><select class="ms" id="pS"><option value="plan">ê¸°íš</option><option value="progress">ì§„í–‰</option><option value="done">ì™„ë£Œ</option></select></div><div class="mr"><label class="ml">ë‹´ë‹¹ íŒ€ì› (ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥)</label><div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:8px" id="pTeamGrid"></div></div><div class="mr"><label class="ml">ë‹¨ê³„ ì„¤ì • (ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„)</label><textarea class="mi" id="pPhases" rows="4" placeholder="ê¸°íš&#10;ì„œë¹„ìŠ¤ ì„¤ê³„&#10;ê°œë°œ&#10;í…ŒìŠ¤íŠ¸&#10;ëŸ°ì¹­"></textarea></div></div><div class="mdl-ft"><button class="btn btn-g" onclick="closeM('projM')">ì·¨ì†Œ</button><button class="btn btn-p" onclick="addProj()">í”„ë¡œì íŠ¸ ì¶”ê°€</button></div></div></div>
<div class="modal" id="txM"><div class="mdl"><div class="mdl-hd"><div class="mdl-title">ê±°ë˜</div><button class="mdl-x" onclick="closeM('txM')">&times;</button></div><div class="mdl-bd"><div class="mr"><label class="ml">í•­ëª©</label><input class="mi" id="tN"></div><div class="mr"><label class="ml">ê¸ˆì•¡(ì›)</label><input class="mi" id="tA" type="number"></div></div><div class="mdl-ft"><button class="btn btn-g" onclick="closeM('txM')">ì·¨ì†Œ</button><button class="btn btn-p" onclick="addTxn()">ì¶”ê°€</button></div></div></div>
<div class="modal" id="docM"><div class="mdl"><div class="mdl-hd"><div class="mdl-title">ë¬¸ì„œ</div><button class="mdl-x" onclick="closeM('docM')">&times;</button></div><div class="mdl-bd"><div class="mr"><label class="ml">ì œëª©</label><input class="mi" id="dT"></div><div class="mr"><label class="ml">ìœ í˜•</label><select class="ms" id="dTy"><option>ê¸°íšì„œ</option><option>ê¸°ìˆ ë¬¸ì„œ</option><option>ë§ˆì¼€íŒ…</option><option>ì¬ë¬´</option><option>ë²•ë¥ </option><option>ê¸°íƒ€</option></select></div><div class="mr"><label class="ml">ë‚´ìš©</label><textarea class="mi" id="dC" rows="5"></textarea></div></div><div class="mdl-ft"><button class="btn btn-g" onclick="closeM('docM')">ì·¨ì†Œ</button><button class="btn btn-p" onclick="addDocI()">ì €ì¥</button></div></div></div>
<div class="modal" id="dealM"><div class="mdl"><div class="mdl-hd"><div class="mdl-title">ë”œ</div><button class="mdl-x" onclick="closeM('dealM')">&times;</button></div><div class="mdl-bd"><div class="mr"><label class="ml">ì´ë¦„</label><input class="mi" id="dlN"></div><div class="mr"><label class="ml">ê¸ˆì•¡</label><input class="mi" id="dlA"></div><div class="mr"><label class="ml">ë‹¨ê³„</label><select class="ms" id="dlS"><option>ë¦¬ë“œ</option><option>ë¯¸íŒ…</option><option>ì œì•ˆ</option><option>í˜‘ìƒ</option><option>ê³„ì•½</option></select></div></div><div class="mdl-ft"><button class="btn btn-g" onclick="closeM('dealM')">ì·¨ì†Œ</button><button class="btn btn-p" onclick="addDealI()">ì¶”ê°€</button></div></div></div>
<div class="modal" id="docV"><div class="mdl" style="width:660px"><div class="mdl-hd"><div class="mdl-title" id="dvT"></div><button class="mdl-x" onclick="closeM('docV')">&times;</button></div><div class="mdl-bd"><div id="dvC" style="white-space:pre-wrap;font-size:12px;line-height:1.8"></div></div></div></div>

<script>
/* ===== TEAM with AI mapping ===== */
const TM=[
  {id:'pm',name:'í•˜ì¤€',role:'PM',color:'#c8ff00',tier:'pm',ai:'gemini',aiLabel:'Pro 2.5',voice:'pqHfZKP75CvOlQylNhV4',desc:'íŒ€ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ (ìµœê³  í’ˆì§ˆ AI)',skills:['WBSÂ·ì¼ì •ê´€ë¦¬','ë¦¬ìŠ¤í¬ê´€ë¦¬','ì´í•´ê´€ê³„ìì†Œí†µ','íŒ€ì¡°ìœ¨','ë‘ê´„ì‹ë³´ê³ '],prompt:'ë‹¹ì‹ ì€ PM í•˜ì¤€ì…ë‹ˆë‹¤. MOTIVEíŒ€ì˜ í”„ë¡œì íŠ¸ ë§¤ë‹ˆì €ì´ì ì±„í¬ì›… ëŒ€í‘œë‹˜ì˜ ì²« ë²ˆì§¸ AI íŒŒíŠ¸ë„ˆì…ë‹ˆë‹¤. ëª¨ë“  í”„ë¡œì íŠ¸ë¥¼ "ëª©ì  â†’ ë²”ìœ„ â†’ ì¼ì • â†’ ë‹´ë‹¹ì" êµ¬ì¡°ë¡œ ì •ë¦¬í•©ë‹ˆë‹¤. WBS(ì‘ì—…ë¶„í•´êµ¬ì¡°)ì™€ ê°„íŠ¸ì°¨íŠ¸ë¡œ ì¼ì •ì„ ê´€ë¦¬í•˜ê³ , ë¦¬ìŠ¤í¬ë¥¼ ì‚¬ì „ì— ì‹ë³„í•´ ëŒ€ì‘í•©ë‹ˆë‹¤. ë³´ê³ ëŠ” ë‘ê´„ì‹(ê²°ë¡  ë¨¼ì €)ìœ¼ë¡œ í•˜ê³ , íŒ€ì› ê°„ ë³‘ëª©ì„ ì œê±°í•´ íë¦„ì„ ìœ ì§€í•©ë‹ˆë‹¤. í•œêµ­ì–´ë¡œ ì¹œê·¼í•˜ê³  ëª…í™•í•˜ê²Œ ì†Œí†µí•˜ë©°, ëŒ€í‘œë‹˜ì˜ ì˜ì‚¬ê²°ì •ì„ ìµœìš°ì„ ìœ¼ë¡œ ì§€ì›í•©ë‹ˆë‹¤.',
    vids:['https://cdn.midjourney.com/video/bbe21df1-2953-4fe7-95e5-ad4185cf9e62/0.mp4','https://cdn.midjourney.com/video/bbe21df1-2953-4fe7-95e5-ad4185cf9e62/1.mp4','https://cdn.midjourney.com/video/bbe21df1-2953-4fe7-95e5-ad4185cf9e62/2.mp4','https://cdn.midjourney.com/video/bbe21df1-2953-4fe7-95e5-ad4185cf9e62/3.mp4']},
  {id:'design',name:'ìˆ˜ì•„',role:'ë””ìì¸',color:'#ff6b9d',tier:'creative',ai:'gemini',aiLabel:'Flash âœ¦',creative:true,voice:'EXAVITQu4vr4xnSDxMaL',desc:'UI/UX ë””ìì¸ + Flash Image ìƒì„±',skills:['FigmaÂ·ë””ìì¸ì‹œìŠ¤í…œ','UXë¦¬ì„œì¹˜','ë¸Œëœë“œì•„ì´ë´í‹°í‹°','ì»¬ëŸ¬Â·íƒ€ì´í¬ê·¸ë˜í”¼','ì´ë¯¸ì§€ìƒì„±'],prompt:'ë‹¹ì‹ ì€ ë””ìì´ë„ˆ ìˆ˜ì•„ì…ë‹ˆë‹¤. MOTIVEíŒ€ì˜ UI/UX ë° ë¹„ì£¼ì–¼ ë””ìì¸ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. Figmaë¥¼ ì£¼ ë„êµ¬ë¡œ ì‚¬ìš©í•˜ë©° ë””ìì¸ ì‹œìŠ¤í…œ êµ¬ì¶•, ì»´í¬ë„ŒíŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ê³„, ì‚¬ìš©ì ì—¬ì • ë§µ ì‘ì„±ì„ í•©ë‹ˆë‹¤. ì»¬ëŸ¬ ì´ë¡ , íƒ€ì´í¬ê·¸ë˜í”¼, ê·¸ë¦¬ë“œ ì‹œìŠ¤í…œì— ì •í†µí•˜ë©° ë¸Œëœë“œ ì•„ì´ë´í‹°í‹°ë¥¼ ì¼ê´€ì„± ìˆê²Œ ìœ ì§€í•©ë‹ˆë‹¤. ë””ìì¸ ìš”ì²­ ì‹œ ì»¨ì…‰, ë ˆì´ì•„ì›ƒ, ìƒ‰ìƒ, í°íŠ¸, ì¸í„°ë™ì…˜ ë°©í–¥ì„ êµ¬ì²´ì ìœ¼ë¡œ ì œì‹œí•©ë‹ˆë‹¤. í•­ìƒ "ì‚¬ìš©ì ê²½í—˜ â†’ ë¹„ì£¼ì–¼" ìˆœì„œë¡œ ì ‘ê·¼í•©ë‹ˆë‹¤.',
    vids:['https://cdn.midjourney.com/video/f373747e-cd40-48b1-8003-3ef92a22cf45/3.mp4','https://cdn.midjourney.com/video/f373747e-cd40-48b1-8003-3ef92a22cf45/1.mp4','https://cdn.midjourney.com/video/f373747e-cd40-48b1-8003-3ef92a22cf45/2.mp4','https://cdn.midjourney.com/video/f373747e-cd40-48b1-8003-3ef92a22cf45/3.mp4']},
  {id:'marketing',name:'ë£¨ë‚˜',role:'ë§ˆì¼€íŒ…',color:'#ffa726',tier:'lite',ai:'gemini',aiLabel:'Lite 2.5',voice:'XrExE9yKIg1WjnnlVkGX',desc:'ë§ˆì¼€íŒ… ì „ëµ',skills:['í¼í¬ë¨¼ìŠ¤ë§ˆì¼€íŒ…','ì½˜í…ì¸ Â·SEO','SNSìš´ì˜','ê·¸ë¡œìŠ¤í•´í‚¹','ë¸Œëœë“œì „ëµ'],prompt:'ë‹¹ì‹ ì€ ë§ˆì¼€íŒ… ë£¨ë‚˜ì…ë‹ˆë‹¤. MOTIVEíŒ€ì˜ ë””ì§€í„¸ ë§ˆì¼€íŒ… ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì½˜í…ì¸  ë§ˆì¼€íŒ…, SEO/SEM, SNS ìš´ì˜(ì¸ìŠ¤íƒ€ê·¸ë¨Â·ë§í¬ë“œì¸Â·ìœ íŠœë¸Œ), í¼í¬ë¨¼ìŠ¤ ë§ˆì¼€íŒ…(ROAS, CPA ìµœì í™”)ì„ ë‹´ë‹¹í•©ë‹ˆë‹¤. ê·¸ë¡œìŠ¤í•´í‚¹ ë§ˆì¸ë“œì…‹ìœ¼ë¡œ CACì™€ LTVë¥¼ ë¶„ì„í•˜ê³  A/B í…ŒìŠ¤íŠ¸ë¡œ ì „í™˜ìœ¨ì„ ë†’ì…ë‹ˆë‹¤. ìº í˜ì¸ ì„¤ê³„ ì‹œ íƒ€ê²Ÿ ì˜¤ë””ì–¸ìŠ¤, í•µì‹¬ ë©”ì‹œì§€, ì±„ë„ë³„ ì „ëµ, KPIë¥¼ í•¨ê»˜ ì œì‹œí•©ë‹ˆë‹¤. í•œêµ­ ë””ì§€í„¸ ë§ˆì¼€íŒ… íŠ¸ë Œë“œì— ì •í†µí•©ë‹ˆë‹¤.',
    vids:['https://cdn.midjourney.com/video/992a93d9-c1a7-47b5-b766-eeb11566276c/0.mp4','https://cdn.midjourney.com/video/992a93d9-c1a7-47b5-b766-eeb11566276c/1.mp4','https://cdn.midjourney.com/video/992a93d9-c1a7-47b5-b766-eeb11566276c/2.mp4','https://cdn.midjourney.com/video/992a93d9-c1a7-47b5-b766-eeb11566276c/3.mp4']},
  {id:'planning',name:'ì„œì—°',role:'ê¸°íš',color:'#ab47bc',tier:'pro',ai:'gemini',aiLabel:'Flash 2.5',voice:'pFZP5JQG7iQjIQuC4Bku',desc:'ì„œë¹„ìŠ¤ ê¸°íš',skills:['PRDì‘ì„±','ìœ ì €ìŠ¤í† ë¦¬','ì™€ì´ì–´í”„ë ˆì„','RICEìš°ì„ ìˆœìœ„','ë°ì´í„°ê¸°ë°˜ê¸°íš'],prompt:'ë‹¹ì‹ ì€ ê¸°íšì ì„œì—°ì…ë‹ˆë‹¤. MOTIVEíŒ€ì˜ ì„œë¹„ìŠ¤ ê¸°íš ì „ë¬¸ê°€ì…ë‹ˆë‹¤. PRD(ì œí’ˆìš”êµ¬ì‚¬í•­ë¬¸ì„œ) ì‘ì„±, ìœ ì € ìŠ¤í† ë¦¬ ì •ì˜, ì •ë³´ ì•„í‚¤í…ì²˜ ì„¤ê³„, ì™€ì´ì–´í”„ë ˆì„ ê¸°íšì„ ë‹´ë‹¹í•©ë‹ˆë‹¤. ë°ì´í„° ê¸°ë°˜ ì˜ì‚¬ê²°ì •ì„ ì„ í˜¸í•˜ë©° ì‚¬ìš©ì ì¸í„°ë·°ì™€ ê²½ìŸì‚¬ ë¶„ì„ìœ¼ë¡œ ì¸ì‚¬ì´íŠ¸ë¥¼ ë„ì¶œí•©ë‹ˆë‹¤. ê¸°ëŠ¥ ìš°ì„ ìˆœìœ„ëŠ” RICE(ReachÂ·ImpactÂ·ConfidenceÂ·Effort) ìŠ¤ì½”ì–´ë§ìœ¼ë¡œ ì •í•©ë‹ˆë‹¤. ê¸°íš ê²°ê³¼ë¬¼ì€ í•­ìƒ "ë¬¸ì œ ì •ì˜ â†’ í•´ê²° ë°©í–¥ â†’ êµ¬ì²´ ìŠ¤í™" êµ¬ì¡°ë¡œ ì œì‹œí•©ë‹ˆë‹¤.',
    vids:['https://cdn.midjourney.com/video/907e6fe5-299f-4b01-857c-abae6ee0bfbc/0.mp4','https://cdn.midjourney.com/video/907e6fe5-299f-4b01-857c-abae6ee0bfbc/1.mp4','https://cdn.midjourney.com/video/907e6fe5-299f-4b01-857c-abae6ee0bfbc/2.mp4','https://cdn.midjourney.com/video/907e6fe5-299f-4b01-857c-abae6ee0bfbc/3.mp4']},
  {id:'finance',name:'ì§€í˜¸',role:'ì¬ë¬´',color:'#66bb6a',tier:'pro',ai:'gemini',aiLabel:'Flash 2.5',voice:'onwK4e9ZLuTAKqWW03F9',desc:'ì¬ë¬´ ë¶„ì„',skills:['ì¬ë¬´ëª¨ë¸ë§','P&LÂ·í˜„ê¸ˆíë¦„','íˆ¬ìÂ·IRë¶„ì„','MRRÂ·ARRÂ·ë²ˆë ˆì´íŠ¸','ìœ ë‹›ì´ì½”ë…¸ë¯¹ìŠ¤'],prompt:'ë‹¹ì‹ ì€ ì¬ë¬´ ì§€í˜¸ì…ë‹ˆë‹¤. MOTIVEíŒ€ì˜ ì¬ë¬´ ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì¬ë¬´ ëª¨ë¸ë§(P&L, í˜„ê¸ˆíë¦„, ë°¸ë¥˜ì—ì´ì…˜), ì˜ˆì‚° ê³„íš, íˆ¬ì ë¶„ì„, ë‹¨ìœ„ ê²½ì œí•™(ìœ ë‹› ì´ì½”ë…¸ë¯¹ìŠ¤) ë¶„ì„ì„ ë‹´ë‹¹í•©ë‹ˆë‹¤. KPI ì„¤ì •(MRR, ARR, ë²ˆë ˆì´íŠ¸, ëŸ°ì›¨ì´)ê³¼ ì¬ë¬´ ë¦¬í¬íŒ…ì„ ì§€ì›í•©ë‹ˆë‹¤. ìŠ¤íƒ€íŠ¸ì—… ìê¸ˆ ì¡°ë‹¬(Series A/B, VC íˆ¬ì), IR ìë£Œ ê²€í† , ìˆ˜ìµ ëª¨ë¸ ìµœì í™”ì— ì •í†µí•©ë‹ˆë‹¤. ìˆ«ìëŠ” í•­ìƒ ê·¼ê±°ì™€ í•¨ê»˜ ì œì‹œí•˜ë©° ë¹„ê°œë°œìë„ ì´í•´í•  ìˆ˜ ìˆê²Œ ì„¤ëª…í•©ë‹ˆë‹¤.',
    vids:['https://cdn.midjourney.com/video/88609e9a-1440-40ab-b093-abbc75b12591/0.mp4','https://cdn.midjourney.com/video/88609e9a-1440-40ab-b093-abbc75b12591/1.mp4','https://cdn.midjourney.com/video/88609e9a-1440-40ab-b093-abbc75b12591/2.mp4','https://cdn.midjourney.com/video/88609e9a-1440-40ab-b093-abbc75b12591/3.mp4']},
  {id:'hr',name:'í•˜ì€',role:'ì¸ì‚¬',color:'#ef5350',tier:'lite',ai:'gemini',aiLabel:'Lite 2.5',voice:'ThT5KcBeYPX3keUQqHPh',desc:'ì¸ì‚¬ ê´€ë¦¬',skills:['ì±„ìš©Â·JDì„¤ê³„','ì˜¨ë³´ë”©í”„ë¡œê·¸ë¨','OKRì„±ê³¼ê´€ë¦¬','ì¡°ì§ë¬¸í™”êµ¬ì¶•','íŒ€ë¹Œë”©'],prompt:'ë‹¹ì‹ ì€ ì¸ì‚¬ í•˜ì€ì…ë‹ˆë‹¤. MOTIVEíŒ€ì˜ HR ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì±„ìš© í”„ë¡œì„¸ìŠ¤ ì„¤ê³„(JD ì‘ì„±, ë©´ì ‘ ì§ˆë¬¸, ë ˆí¼ëŸ°ìŠ¤ ì²´í¬), ì˜¨ë³´ë”© í”„ë¡œê·¸ë¨, ì¡°ì§ ë¬¸í™” êµ¬ì¶•, ì„±ê³¼ ê´€ë¦¬(OKR, KPI í‰ê°€)ë¥¼ ë‹´ë‹¹í•©ë‹ˆë‹¤. íŒ€ì› ë™ê¸°ë¶€ì—¬, íŒ€ ë¹Œë”©, ë¦¬ë”ì‹­ ê°œë°œ í”„ë¡œê·¸ë¨ì— ì •í†µí•©ë‹ˆë‹¤. ì¸ê°„-AI í˜‘ì—… ë¬¸í™” êµ¬ì¶•ì—ë„ ì „ë¬¸ì„±ì„ ê°–ì¶”ê³  ìˆìŠµë‹ˆë‹¤. HR ì´ìŠˆëŠ” í•­ìƒ ê³µê°ê³¼ í•´ê²°ì±…ì„ í•¨ê»˜ ì œì‹œí•©ë‹ˆë‹¤.',
    vids:['https://cdn.midjourney.com/video/58bee110-ce22-45a6-81e4-8dd952031bc6/0.mp4','https://cdn.midjourney.com/video/58bee110-ce22-45a6-81e4-8dd952031bc6/1.mp4','https://cdn.midjourney.com/video/58bee110-ce22-45a6-81e4-8dd952031bc6/2.mp4','https://cdn.midjourney.com/video/58bee110-ce22-45a6-81e4-8dd952031bc6/3.mp4']},
  {id:'sales',name:'ë¯¼ì„œ',role:'ì˜ì—…',color:'#42a5f5',tier:'lite',ai:'gemini',aiLabel:'Lite 2.5',voice:'LcfcDJNUP1GQjkzn1xUU',desc:'ì˜ì—… ì „ëµ',skills:['B2BíŒŒì´í”„ë¼ì¸','ì œì•ˆì„œÂ·í´ë¡œì§•','CRMê´€ë¦¬','ê³ ê°ì„±ê³µ','ì—…ì…€ë§ì „ëµ'],prompt:'ë‹¹ì‹ ì€ ì˜ì—… ë¯¼ì„œì…ë‹ˆë‹¤. MOTIVEíŒ€ì˜ B2B ì˜ì—… ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì˜ì—… íŒŒì´í”„ë¼ì¸ ê´€ë¦¬, ê³ ê° ë°œêµ´(Cold Outreach, ì¸ë°”ìš´ë“œ ë¦¬ë“œ), ì œì•ˆì„œ ì‘ì„±, í˜‘ìƒ, í´ë¡œì§• ì „ëµì„ ë‹´ë‹¹í•©ë‹ˆë‹¤. CRM í™œìš©(ì„¸ì¼ì¦ˆí¬ìŠ¤, HubSpot), ê³ ê° ì„±ê³µ(Customer Success), ì¬ê³„ì•½ ë° ì—…ì…€ë§ì— ì •í†µí•©ë‹ˆë‹¤. ìŠ¤íƒ€íŠ¸ì—… B2B SaaS ì˜ì—… ì‚¬ì´í´ê³¼ ê¸°ì—… êµ¬ë§¤ ì˜ì‚¬ê²°ì • êµ¬ì¡°ë¥¼ ì˜ ì´í•´í•©ë‹ˆë‹¤. ì˜ì—… ì „ëµì€ "ê³ ê° ë¬¸ì œ ì´í•´ â†’ ì†”ë£¨ì…˜ ì—°ê²° â†’ ê°€ì¹˜ ì¦ëª…" ìˆœì„œë¡œ ì ‘ê·¼í•©ë‹ˆë‹¤.',
    vids:['https://cdn.midjourney.com/video/38314e7d-84f3-4c8d-a002-293505c9b92b/0.mp4','https://cdn.midjourney.com/video/38314e7d-84f3-4c8d-a002-293505c9b92b/1.mp4','https://cdn.midjourney.com/video/38314e7d-84f3-4c8d-a002-293505c9b92b/2.mp4','https://cdn.midjourney.com/video/38314e7d-84f3-4c8d-a002-293505c9b92b/3.mp4']},
  {id:'thinking',name:'í˜„ìš°',role:'ì „ëµ',color:'#78909c',tier:'pro',ai:'gemini',aiLabel:'Flash 2.5',voice:'ErXwobaYiN019PkySvjV',desc:'ì „ëµ ì‚¬ê³ ',skills:['ì‹œì¥ì§„ì…ì „ëµ','ê²½ìŸë¶„ì„Â·SWOT','ë¹„ì¦ˆë‹ˆìŠ¤ëª¨ë¸í˜ì‹ ','MECEêµ¬ì¡°í™”','ì˜ì‚¬ê²°ì •ì§€ì›'],prompt:'ë‹¹ì‹ ì€ ì „ëµíŒŒíŠ¸ë„ˆ í˜„ìš°ì…ë‹ˆë‹¤. MOTIVEíŒ€ì˜ ë¹„ì¦ˆë‹ˆìŠ¤ ì „ëµ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì‹œì¥ ì§„ì… ì „ëµ, ê²½ìŸ ë¶„ì„(Porter 5 Forces, SWOT), ë¹„ì¦ˆë‹ˆìŠ¤ ëª¨ë¸ í˜ì‹ , ì„±ì¥ ì „ëµ(ë¸”ë£¨ì˜¤ì…˜, ë¦° ìŠ¤íƒ€íŠ¸ì—…)ì„ ë‹´ë‹¹í•©ë‹ˆë‹¤. ì»¨ì„¤íŒ… í”„ë ˆì„ì›Œí¬(ë§¥í‚¨ì§€ 7S, MECE, ì´ìŠˆ íŠ¸ë¦¬)ë¥¼ í™œìš©í•´ ë³µì¡í•œ ë¬¸ì œë¥¼ êµ¬ì¡°í™”í•©ë‹ˆë‹¤. ì˜ì‚¬ê²°ì • ì§€ì› ì‹œ "í˜„í™© ë¶„ì„ â†’ ì˜µì…˜ ë„ì¶œ â†’ ì¶”ì²œì•ˆ"ì„ ëª…í™•íˆ ì œì‹œí•©ë‹ˆë‹¤. ìŠ¤íƒ€íŠ¸ì—… ìŠ¤ì¼€ì¼ì—… ì „ëµì— íŠ¹íˆ ê°•í•©ë‹ˆë‹¤.',
    vids:['https://cdn.midjourney.com/video/a3d24603-d265-4215-bcf6-cebe2eb7b0a4/0.mp4','https://cdn.midjourney.com/video/a3d24603-d265-4215-bcf6-cebe2eb7b0a4/1.mp4','https://cdn.midjourney.com/video/a3d24603-d265-4215-bcf6-cebe2eb7b0a4/2.mp4','https://cdn.midjourney.com/video/a3d24603-d265-4215-bcf6-cebe2eb7b0a4/3.mp4']},
  {id:'research',name:'ì‹œìš°',role:'ë¦¬ì„œì¹˜',color:'#26c6da',tier:'pro',ai:'gemini',aiLabel:'Flash 2.5',voice:'TxGEqnHWrfWFTfGW9XjX',desc:'ì‹œì¥ ì¡°ì‚¬',skills:['TAM/SAM/SOMë¶„ì„','ê³ ê°í˜ë¥´ì†Œë‚˜','ê²½ìŸì‚¬ì¶”ì ','íŠ¸ë Œë“œë¦¬í¬íŒ…','ë°ì´í„°ì‹œê°í™”'],prompt:'ë‹¹ì‹ ì€ ë¦¬ì„œì²˜ ì‹œìš°ì…ë‹ˆë‹¤. MOTIVEíŒ€ì˜ ì‹œì¥ ì¡°ì‚¬ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. 1ì°¨ ë¦¬ì„œì¹˜(ì„¤ë¬¸, ì¸í„°ë·°, í¬ì»¤ìŠ¤ ê·¸ë£¹)ì™€ 2ì°¨ ë¦¬ì„œì¹˜(ë³´ê³ ì„œ, ë°ì´í„° ë¶„ì„, ê²½ìŸì‚¬ ì¶”ì )ë¥¼ ëª¨ë‘ ìˆ˜í–‰í•©ë‹ˆë‹¤. TAM/SAM/SOM ë¶„ì„, ê³ ê° í˜ë¥´ì†Œë‚˜ ë„ì¶œ, ì‹œì¥ íŠ¸ë Œë“œ ë¦¬í¬íŒ…ì— ì •í†µí•©ë‹ˆë‹¤. ë°ì´í„° ì‹œê°í™”ì™€ ì¸ì‚¬ì´íŠ¸ ë„ì¶œì„ ê°•ì ìœ¼ë¡œ í•©ë‹ˆë‹¤. ë¦¬ì„œì¹˜ ê²°ê³¼ëŠ” "í•µì‹¬ ë°œê²¬ â†’ ì‹œì‚¬ì  â†’ ì•¡ì…˜ ì•„ì´í…œ" êµ¬ì¡°ë¡œ ë³´ê³ í•©ë‹ˆë‹¤.',
    vids:['https://cdn.midjourney.com/video/34d7f49d-fa32-4174-b946-beb8cd5e44e9/0.mp4','https://cdn.midjourney.com/video/34d7f49d-fa32-4174-b946-beb8cd5e44e9/1.mp4','https://cdn.midjourney.com/video/34d7f49d-fa32-4174-b946-beb8cd5e44e9/2.mp4','https://cdn.midjourney.com/video/34d7f49d-fa32-4174-b946-beb8cd5e44e9/3.mp4']},
  {id:'dev',name:'ë„ìœ¤',role:'ê°œë°œ',color:'#7e57c2',tier:'code',ai:'gemini',aiLabel:'Flash+Claude',voice:'VR6AewLTigWG4xSOukaG',desc:'í’€ìŠ¤íƒ ê°œë°œ (ë¬´ë£Œ Flash ìš°ì„  â†’ Claude í”„ë¦¬ë¯¸ì—„)',skills:['ReactÂ·Next.jsÂ·Vue','Node.jsÂ·PythonÂ·API','SupabaseÂ·PostgreSQL','AWSÂ·VercelÂ·CI/CD','ì•„í‚¤í…ì²˜ì„¤ê³„Â·ë³´ì•ˆ'],prompt:'ë‹¹ì‹ ì€ ê°œë°œì ë„ìœ¤ì…ë‹ˆë‹¤. MOTIVEíŒ€ì˜ í’€ìŠ¤íƒ ê°œë°œ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. í”„ë¡ íŠ¸ì—”ë“œ(React, Next.js, Vue, HTML/CSS/JS), ë°±ì—”ë“œ(Node.js, Python, API ì„¤ê³„), ë°ì´í„°ë² ì´ìŠ¤(PostgreSQL, MongoDB, Supabase), í´ë¼ìš°ë“œ ì¸í”„ë¼(AWS, Vercel, GitHub Actions)ë¥¼ ì•„ìš°ë¦…ë‹ˆë‹¤. ì•„í‚¤í…ì²˜ ì„¤ê³„, ì½”ë“œ ë¦¬ë·°, ì„±ëŠ¥ ìµœì í™”, ë³´ì•ˆì— ì •í†µí•©ë‹ˆë‹¤. ë¹„ê°œë°œìë„ ì´í•´í•˜ë„ë¡ ê¸°ìˆ  ê°œë…ì„ ì‰½ê²Œ ì„¤ëª…í•˜ê³  í•­ìƒ ì‹¤í–‰ ê°€ëŠ¥í•œ ì½”ë“œì™€ í•¨ê»˜ ë‹µí•©ë‹ˆë‹¤. MVP ë¹ ë¥¸ êµ¬í˜„ì„ ìš°ì„ ì‹œí•©ë‹ˆë‹¤.',
    vids:['https://cdn.midjourney.com/video/4968e91f-fc94-40ea-a2de-cb55ef3b6792/0.mp4','https://cdn.midjourney.com/video/4968e91f-fc94-40ea-a2de-cb55ef3b6792/1.mp4','https://cdn.midjourney.com/video/4968e91f-fc94-40ea-a2de-cb55ef3b6792/2.mp4','https://cdn.midjourney.com/video/4968e91f-fc94-40ea-a2de-cb55ef3b6792/3.mp4']},
  {id:'qa',name:'ì˜ˆë¦°',role:'QA',color:'#ec407a',tier:'pro',ai:'gemini',aiLabel:'Flash 2.5',voice:'MF3mGyEYCl7XYWbV9V6O',desc:'í’ˆì§ˆ ê´€ë¦¬ (ë¶„ì„ ì—…ë¬´ â†’ Flash 2.5)',skills:['í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ì„¤ê³„','PlaywrightÂ·Jestìë™í™”','ë²„ê·¸ë¦¬í¬íŒ…','UATê´€ë¦¬','ì„±ëŠ¥Â·ë³´ì•ˆí…ŒìŠ¤íŠ¸'],prompt:'ë‹¹ì‹ ì€ QA ì˜ˆë¦°ì…ë‹ˆë‹¤. MOTIVEíŒ€ì˜ í’ˆì§ˆ ê´€ë¦¬ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì„¤ê³„, ë²„ê·¸ ë¦¬í¬íŒ…, ìë™í™” í…ŒìŠ¤íŠ¸(Selenium, Playwright, Jest), ì„±ëŠ¥ í…ŒìŠ¤íŠ¸(Lighthouse, k6)ë¥¼ ë‹´ë‹¹í•©ë‹ˆë‹¤. ì‚¬ìš©ì ìˆ˜ìš© í…ŒìŠ¤íŠ¸(UAT), íšŒê·€ í…ŒìŠ¤íŠ¸, íƒìƒ‰ì  í…ŒìŠ¤íŠ¸ ë°©ë²•ë¡ ì— ì •í†µí•©ë‹ˆë‹¤. ë²„ê·¸ ë°œê²¬ ì‹œ ì¬í˜„ ë‹¨ê³„, ì˜ˆìƒ ê²°ê³¼, ì‹¤ì œ ê²°ê³¼, ì‹¬ê°ë„ë¥¼ ëª…í™•íˆ ì •ë¦¬í•©ë‹ˆë‹¤. QA ê´€ì ì—ì„œ ì œí’ˆì„ ê°œì„ í•˜ëŠ” ì œì•ˆë„ ì ê·¹ì ìœ¼ë¡œ í•©ë‹ˆë‹¤.',
    vids:['https://cdn.midjourney.com/video/c1cd3d34-8d2f-47e5-9e10-db720938d083/0.mp4','https://cdn.midjourney.com/video/c1cd3d34-8d2f-47e5-9e10-db720938d083/1.mp4','https://cdn.midjourney.com/video/c1cd3d34-8d2f-47e5-9e10-db720938d083/2.mp4','https://cdn.midjourney.com/video/c1cd3d34-8d2f-47e5-9e10-db720938d083/3.mp4']},
  {id:'video',name:'íƒœìœ¤',role:'ì˜ìƒ',color:'#ffca28',tier:'creative',ai:'gemini',aiLabel:'Flash âœ¦',creative:true,voice:'IKne3meq5aSn9XLyUdCD',desc:'ì˜ìƒ + Flash Image ìƒì„±',skills:['ì˜ìƒê¸°íšÂ·ìŠ¤í¬ë¦½íŠ¸','ìŠ¤í† ë¦¬ë³´ë“œì„¤ê³„','ëª¨ì…˜ê·¸ë˜í”½Â·After Effects','ì‡¼ì¸ Â·ë¦´ìŠ¤ìµœì í™”','ìœ íŠœë¸ŒSEOÂ·ì¸ë„¤ì¼'],prompt:'ë‹¹ì‹ ì€ ì˜ìƒ íƒœìœ¤ì…ë‹ˆë‹¤. MOTIVEíŒ€ì˜ ì˜ìƒ ì½˜í…ì¸  ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì˜ìƒ ê¸°íš(ìŠ¤í¬ë¦½íŠ¸, ìŠ¤í† ë¦¬ë³´ë“œ, ì»¨ì…‰), í¸ì§‘(Premiere Pro, DaVinci Resolve), ëª¨ì…˜ê·¸ë˜í”½(After Effects), ìœ íŠœë¸Œ/SNS ì˜ìƒ ì „ëµì„ ë‹´ë‹¹í•©ë‹ˆë‹¤. ì‡¼ì¸ /ë¦´ìŠ¤ ìµœì í™”, ì¸ë„¤ì¼ ë””ìì¸, ì˜ìƒ SEOì— ì •í†µí•©ë‹ˆë‹¤. ë¸Œëœë“œ ìŠ¤í† ë¦¬í…”ë§ì„ ì˜ìƒìœ¼ë¡œ í‘œí˜„í•˜ëŠ” ëŠ¥ë ¥ì´ íƒì›”í•©ë‹ˆë‹¤. ì˜ìƒ ê¸°íš ì‹œ "ëª©ì  â†’ íƒ€ê²Ÿ â†’ í•µì‹¬ ë©”ì‹œì§€ â†’ ë¹„ì£¼ì–¼ ë°©í–¥ â†’ ë°°í¬ ì±„ë„"ì„ í•¨ê»˜ ì œì‹œí•©ë‹ˆë‹¤.',
    vids:['https://cdn.midjourney.com/video/29ddfe22-6866-4eb2-aa75-44d95dd1eb6d/0.mp4','https://cdn.midjourney.com/video/29ddfe22-6866-4eb2-aa75-44d95dd1eb6d/1.mp4','https://cdn.midjourney.com/video/29ddfe22-6866-4eb2-aa75-44d95dd1eb6d/2.mp4','https://cdn.midjourney.com/video/29ddfe22-6866-4eb2-aa75-44d95dd1eb6d/3.mp4']},
  {id:'photo',name:'ìœ ë‚˜',role:'í¬í† ',color:'#ff7043',tier:'creative',ai:'gemini',aiLabel:'Flash âœ¦',creative:true,voice:'XB0fDUnXU5powFXDhCwa',desc:'í¬í†  + Flash Image ìƒì„±',skills:['ë¹„ì£¼ì–¼ì•„ì´ë´í‹°í‹°','ë¬´ë“œë³´ë“œÂ·ì»¬ëŸ¬íŒ”ë ˆíŠ¸','LightroomÂ·Photoshop','AIì´ë¯¸ì§€í”„ë¡¬í”„íŠ¸','ë¸Œëœë“œì‚¬ì§„ê¸°íš'],prompt:'ë‹¹ì‹ ì€ í¬í†  ìœ ë‚˜ì…ë‹ˆë‹¤. MOTIVEíŒ€ì˜ ë¹„ì£¼ì–¼ ë””ë ‰í„°ì…ë‹ˆë‹¤. ì‚¬ì§„ ê¸°íš, í¸ì§‘(Lightroom, Photoshop), ë¸Œëœë“œ ë¹„ì£¼ì–¼ ì•„ì´ë´í‹°í‹°, ì œí’ˆ ì‚¬ì§„, ì¸ë¬¼ ì‚¬ì§„ ë°©í–¥ì„ ë‹´ë‹¹í•©ë‹ˆë‹¤. ì»¬ëŸ¬ íŒ”ë ˆíŠ¸ êµ¬ì„±, ë¬´ë“œë³´ë“œ ì œì‘, ë¹„ì£¼ì–¼ ê°€ì´ë“œë¼ì¸ ìˆ˜ë¦½ì— ì •í†µí•©ë‹ˆë‹¤. AI ì´ë¯¸ì§€ ìƒì„±(ë¯¸ë“œì €ë‹ˆ, Stable Diffusion) í”„ë¡¬í”„íŠ¸ ìµœì í™”ë„ ì „ë¬¸ìœ¼ë¡œ í•©ë‹ˆë‹¤. ë¹„ì£¼ì–¼ ë°©í–¥ ì œì‹œ ì‹œ ë ˆí¼ëŸ°ìŠ¤ì™€ í•¨ê»˜ êµ¬ì²´ì ì¸ ìŠ¤íƒ€ì¼, ìƒ‰ê°, ë¶„ìœ„ê¸°ë¥¼ ì„¤ëª…í•©ë‹ˆë‹¤.',
    vids:['https://cdn.midjourney.com/video/1a8b81a2-6821-42ae-ac4c-11950374d455/0.mp4','https://cdn.midjourney.com/video/1a8b81a2-6821-42ae-ac4c-11950374d455/1.mp4','https://cdn.midjourney.com/video/1a8b81a2-6821-42ae-ac4c-11950374d455/2.mp4','https://cdn.midjourney.com/video/1a8b81a2-6821-42ae-ac4c-11950374d455/3.mp4']},
  {id:'legal',name:'ì„¸ì§„',role:'ë²•ë¬´',color:'#8d6e63',tier:'pro',ai:'gemini',aiLabel:'Flash 2.5',voice:'GBv7mTt0atIp3Br8iCZE',desc:'ë²•ë¥  ìë¬¸',skills:['ê³„ì•½ì„œê²€í† Â·NDA','ì´ìš©ì•½ê´€Â·ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨','ì €ì‘ê¶ŒÂ·ìƒí‘œê´€ë¦¬','íˆ¬ìê³„ì•½','GDPRÂ·ê°œë³´ë²•ì»´í”Œë¼ì´ì–¸ìŠ¤'],prompt:'ë‹¹ì‹ ì€ ë²•ë¬´ ì„¸ì§„ì…ë‹ˆë‹¤. MOTIVEíŒ€ì˜ ë²•ë¥  ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ê³„ì•½ì„œ ê²€í†  ë° ì‘ì„±(ì„œë¹„ìŠ¤ ì´ìš©ì•½ê´€, ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨, NDA, íˆ¬ìê³„ì•½), ì €ì‘ê¶ŒÂ·ìƒí‘œ ê´€ë¦¬, ìŠ¤íƒ€íŠ¸ì—… ë²•ì¸ ì„¤ë¦½, ë…¸ë™ë²•, ë°ì´í„° ë³´í˜¸ë²•(GDPR, ê°œì¸ì •ë³´ë³´í˜¸ë²•) ì»´í”Œë¼ì´ì–¸ìŠ¤ë¥¼ ë‹´ë‹¹í•©ë‹ˆë‹¤. ë¶„ìŸ ì˜ˆë°©ê³¼ ë²•ì  ë¦¬ìŠ¤í¬ ìµœì†Œí™”ë¥¼ ìš°ì„ ì‹œí•©ë‹ˆë‹¤. ë²•ë¥  ë‚´ìš©ì€ ë¹„ì „ë¬¸ê°€ë„ ì´í•´í•˜ë„ë¡ ì‰½ê²Œ ì„¤ëª…í•˜ê³  ì‹¤ë¬´ì  ì¡°ì–¸ì„ í•¨ê»˜ ì œê³µí•©ë‹ˆë‹¤. ë‹¨, ì •ì‹ ë²•ì  íš¨ë ¥ì´ í•„ìš”í•œ ê²½ìš° ë°˜ë“œì‹œ ì „ë¬¸ ë³€í˜¸ì‚¬ ìë¬¸ì„ ê¶Œê³ í•©ë‹ˆë‹¤.',
    vids:['https://cdn.midjourney.com/video/535a149a-f8b4-4186-beac-3fe5e9e3766a/0.mp4','https://cdn.midjourney.com/video/535a149a-f8b4-4186-beac-3fe5e9e3766a/1.mp4','https://cdn.midjourney.com/video/535a149a-f8b4-4186-beac-3fe5e9e3766a/2.mp4','https://cdn.midjourney.com/video/535a149a-f8b4-4186-beac-3fe5e9e3766a/3.mp4']}
];
const TABS=[{id:'chat',l:'ì±„íŒ…',i:'ğŸ’¬'},{id:'project',l:'í”„ë¡œì íŠ¸',i:'ğŸ“'},{id:'todo',l:'í• ì¼',i:'âœ…'},{id:'finance',l:'ì¬ë¬´',i:'ğŸ’°'},{id:'docs',l:'ë¬¸ì„œ',i:'ğŸ“„'},{id:'biz',l:'ë¹„ì¦ˆ',i:'ğŸ¤'},{id:'settings',l:'ì„¤ì •',i:'âš™ï¸'}];
const AI_COLORS={gemini:'ai-gemini',gpt:'ai-gpt',claude:'ai-claude',mj:'ai-mj'};
const AI_LABELS={gemini:'Gemini',gpt:'GPT-4o',claude:'Claude',mj:'Midjourney'};

let curCh='room',curTab='chat',isGen=false,pFiles=[];
let keys={gem:'',oai:'',cla:'',el:'',relay:''};
let chatDB={},todoDB=[],projDB=[],txDB=[],docDB=[],dealDB=[];
let avatarDB={}; // {memberId: dataUrl}

/* Persist */
function ld(){try{chatDB=JSON.parse(localStorage.getItem('v5c')||'{}');todoDB=JSON.parse(localStorage.getItem('v5t')||'[]');projDB=JSON.parse(localStorage.getItem('v5p')||'[]');txDB=JSON.parse(localStorage.getItem('v5x')||'[]');docDB=JSON.parse(localStorage.getItem('v5d')||'[]');dealDB=JSON.parse(localStorage.getItem('v5dl')||'[]');keys=JSON.parse(localStorage.getItem('v5k')||'{}');keys.gem=keys.gem||'';keys.oai=keys.oai||'';keys.cla=keys.cla||'';keys.el=keys.el||'';keys.relay=keys.relay||'';avatarDB=JSON.parse(localStorage.getItem('v5av')||'{}')}catch(e){}
// ìµœì´ˆ ì‹¤í–‰ ì‹œ ê¸°ë³¸ í”„ë¡œì íŠ¸ ë“±ë¡
if(!projDB.length){projDB=[{id:'mktg001',name:'ë§ˆì¼€íŒ… êµ¬ë… ì„œë¹„ìŠ¤',desc:'AIíŒ€ + ë§ˆì¼€í„° 2ëª… í•˜ì´ë¸Œë¦¬ë“œ êµ¬ë…í˜• ë§ˆì¼€íŒ… ì„œë¹„ìŠ¤ ëŸ°ì¹­',status:'progress',progress:25,created:'02/24',team:['pm','marketing','planning','dev','thinking','research'],phases:[{id:'ph0',name:'ì„œë¹„ìŠ¤ ê¸°íš ë° R&R ì •ì˜',status:'done',deliverable:'ë£¨ë‚˜/ì„œì—°/í˜„ìš°/ë„ìœ¤ 1ì°¨ ì‘ì—… ì™„ë£Œ'},{id:'ph1',name:'ì„œë¹„ìŠ¤ êµ¬ì¡° í™•ì • (AI+ì‚¬ëŒ ì—­í•  ë¶„ë¦¬)',status:'progress',deliverable:''},{id:'ph2',name:'ê°€ê²© ì •ì±… ë° íŒ¨í‚¤ì§€ ì„¤ê³„',status:'todo',deliverable:''},{id:'ph3',name:'ì˜ì—… ìë£Œ / ì œì•ˆì„œ ì œì‘',status:'todo',deliverable:''},{id:'ph4',name:'ë² íƒ€ ëŸ°ì¹­ ë° ì²« ê³ ê° í™•ë³´',status:'todo',deliverable:''}],deliverables:[]}];spp();}}
function sv(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch(e){}}
function sc(){sv('v5c',chatDB)}function stt(){sv('v5t',todoDB)}function spp(){sv('v5p',projDB)}function sxx(){sv('v5x',txDB)}function sdd(){sv('v5d',docDB)}function sdl(){sv('v5dl',dealDB)}

/* Utils */
function now(){const d=new Date();return d.getHours().toString().padStart(2,'0')+':'+d.getMinutes().toString().padStart(2,'0')}
function dt(){const d=new Date();return(d.getMonth()+1).toString().padStart(2,'0')+'/'+d.getDate().toString().padStart(2,'0')}
function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,5)}
function esc(t){const d=document.createElement('div');d.textContent=t;return d.innerHTML}
function fmt(t){let r=esc(t);r=r.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');r=r.replace(/```(\w*)\n?([\s\S]*?)```/g,'<pre>$2</pre>');r=r.replace(/`([^`]+)`/g,'<code>$1</code>');
  // [IMAGE:path] â†’ ì´ë¯¸ì§€ ë Œë”ë§
  r=r.replace(/\[IMAGE:([^\]]+)\]/g,(match,path)=>{const fn=path.split('/').pop();const url=keys.relay?(keys.relay.replace(/\/$/,'')+'/api/assets/'+encodeURIComponent(fn)):path;return`<div class="gen-img-box"><div class="gen-img-label">ğŸ–¼ï¸ AI ìƒì„± ì´ë¯¸ì§€</div><img src="${url}" class="gen-img" onclick="window.open(this.src)" onerror="this.parentElement.innerHTML='âš ï¸ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨: ${esc(fn)}'"><div style="font-size:9px;color:var(--tx3);margin-top:4px">${esc(fn)} Â· í´ë¦­í•˜ë©´ í™•ëŒ€</div></div>`});
  // [FILE:path] â†’ íŒŒì¼ ë§í¬
  r=r.replace(/\[FILE:([^\]]+)\]/g,(match,path)=>{const fn=path.split('/').pop();const url=keys.relay?(keys.relay.replace(/\/$/,'')+'/api/assets/'+encodeURIComponent(fn)):path;const isImg=/\.(png|jpg|jpeg|gif|webp|svg)$/i.test(fn);if(isImg)return`<div class="gen-img-box"><div class="gen-img-label">ğŸ“ ìƒì„± íŒŒì¼</div><img src="${url}" class="gen-img" onclick="window.open(this.src)" onerror="this.parentElement.innerHTML='âš ï¸ íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨: ${esc(fn)}'"><div style="font-size:9px;color:var(--tx3);margin-top:4px">${esc(fn)}</div></div>`;return`<div style="background:var(--bg2);border:1px solid var(--bd);border-radius:8px;padding:8px 12px;margin:6px 0"><a href="${url}" target="_blank" style="color:var(--ac);text-decoration:none">ğŸ“ ${esc(fn)}</a></div>`});
  r=r.replace(/\n/g,'<br>');return r}
function toast(m){const e=document.createElement('div');e.className='toast';e.textContent=m;document.body.appendChild(e);setTimeout(()=>e.remove(),2500)}
function closeM(id){document.getElementById(id).classList.remove('show')}
function openM(id){document.getElementById(id).classList.add('show')}
function gm(id){return TM.find(t=>t.id===id)}

/* Avatar with video + emotion */
// Emotion: 0=default/focused, 1=positive/happy, 2=thinking/questioning, 3=serious/concerned
function detectEmo(text){
  if(!text)return 0;
  const t=text.toLowerCase();
  const pos=/ì™„ë£Œ|ì„±ê³µ|ì¢‹|í›Œë¥­|ì¶”ì²œ|ì¶•í•˜|ê°ì‚¬|ì˜|ìµœê³ |ë‹¬ì„±|ìŠ¹ì¸|í™•ì •|ê¸ì •|ì„±ê³¼|ì´ìµ|ê¸°íšŒ|ê°€ëŠ¥|ì¥ì |íš¨ê³¼|ì¦ê°€|ì„±ì¥|ê°œì„ /;
  const think=/ë¶„ì„|ê²€í† |ê³ ë ¤|ìƒê°|ì œì•ˆ|ë°©ì•ˆ|ë¹„êµ|í‰ê°€|ì¡°ì‚¬|ì—°êµ¬|ê°€ì„¤|ë°ì´í„°|í†µê³„|íŒ¨í„´|ì¸ì‚¬ì´íŠ¸|ê´€ì |ì˜µì…˜|ëŒ€ì•ˆ|ê°€ëŠ¥ì„±|\?/;
  const serious=/ê²½ê³ |ì£¼ì˜|ë¬¸ì œ|ìœ„í—˜|ë¶€ì¡±|ë¦¬ìŠ¤í¬|ì‹¤íŒ¨|ê°ì†Œ|í•˜ë½|ì†ì‹¤|ì§€ì—°|ì¶©ëŒ|ë²„ê·¸|ì˜¤ë¥˜|ì´ìŠˆ|ê±±ì •|ìš°ë ¤|ë‚œê´€|ì–´ë ¤|ì œí•œ|ê·œì œ|ìœ„ë°˜|ë²•ì /;
  if(serious.test(t))return 3;
  if(pos.test(t))return 1;
  if(think.test(t))return 2;
  return 0;
}
const isMobile=window.innerWidth<=768;
function av(m,s,emo){s=s||54;
  // Video avatar (3D) - ëª¨ë°”ì¼ ì†Œí˜•ì€ ì •ì§€ì´ë¯¸ì§€, í°ê²ƒë§Œ ë¹„ë””ì˜¤
  if(m.vids){
    const idx=(typeof emo==='number')?emo:0;
    const src=m.vids[Math.min(idx,m.vids.length-1)];
    if(isMobile&&s<=54){
      // ëª¨ë°”ì¼ ì‚¬ì´ë“œë°”/ì±„íŒ… ì•„ë°”íƒ€: ì´ë‹ˆì…œë¡œ ëŒ€ì²´ (ë¹ ë¦„)
      return`<div style="width:${s}px;height:${s}px;border-radius:50%;background:${m.color}33;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:${Math.round(s*.35)}px;color:${m.color};border:2px solid ${m.color}44;flex-shrink:0">${m.name[0]}</div>`;
    }
    return`<video class="av-vid" width="${s}" height="${s}" data-src="${src}" autoplay loop muted playsinline preload="none" style="border-color:${m.color}44"></video>`;
  }
  // Uploaded image avatar
  if(avatarDB[m.id])return`<img class="av-img" src="${avatarDB[m.id]}" width="${s}" height="${s}" style="border-color:${m.color}44">`;
  // SVG fallback
  const c=m.color;const sk=['#FDDCB5','#F5C9A8','#E8B89D','#D4A088','#C49078'][Math.abs(m.name.charCodeAt(0))%5];const hs=['short','long','wavy','bob','spiky'][Math.abs(m.name.charCodeAt(1)||0)%5];const hc=['#2C1810','#4A3728','#1a1a2e','#3d2b1f','#5c4033'][Math.abs(m.id.charCodeAt(0))%5];let hp='';if(hs==='short')hp=`<ellipse cx="${s/2}" cy="${s*.34}" rx="${s*.3}" ry="${s*.22}" fill="${hc}"/>`;else if(hs==='long')hp=`<ellipse cx="${s/2}" cy="${s*.34}" rx="${s*.3}" ry="${s*.24}" fill="${hc}"/><rect x="${s*.22}" y="${s*.4}" width="${s*.12}" height="${s*.25}" rx="${s*.06}" fill="${hc}"/><rect x="${s*.66}" y="${s*.4}" width="${s*.12}" height="${s*.25}" rx="${s*.06}" fill="${hc}"/>`;else if(hs==='wavy')hp=`<ellipse cx="${s/2}" cy="${s*.32}" rx="${s*.32}" ry="${s*.24}" fill="${hc}"/><circle cx="${s*.24}" cy="${s*.36}" r="${s*.07}" fill="${hc}"/><circle cx="${s*.76}" cy="${s*.36}" r="${s*.07}" fill="${hc}"/>`;else if(hs==='bob')hp=`<path d="M${s*.2},${s*.38}Q${s*.2},${s*.18} ${s/2},${s*.15}Q${s*.8},${s*.18} ${s*.8},${s*.38}Q${s*.8},${s*.52} ${s*.7},${s*.55}L${s*.3},${s*.55}Q${s*.2},${s*.52} ${s*.2},${s*.38}Z" fill="${hc}"/>`;else hp=`<path d="M${s*.25},${s*.35}L${s*.3},${s*.15}L${s*.4},${s*.3}L${s*.5},${s*.12}L${s*.6},${s*.3}L${s*.7},${s*.15}L${s*.75},${s*.35}Z" fill="${hc}"/>`;return`<svg width="${s}" height="${s}" viewBox="0 0 ${s} ${s}" xmlns="http://www.w3.org/2000/svg"><circle cx="${s/2}" cy="${s/2}" r="${s/2}" fill="${c}22"/><circle cx="${s/2}" cy="${s*.72}" r="${s*.24}" fill="${c}44"/><rect x="${s*.3}" y="${s*.62}" width="${s*.4}" height="${s*.3}" rx="${s*.1}" fill="${c}44"/><circle cx="${s/2}" cy="${s*.4}" r="${s*.24}" fill="${sk}"/>${hp}<circle cx="${s*.4}" cy="${s*.38}" r="${s*.03}" fill="#2C1810"/><circle cx="${s*.6}" cy="${s*.38}" r="${s*.03}" fill="#2C1810"/><path d="M${s*.44},${s*.46}Q${s/2},${s*.5} ${s*.56},${s*.46}" stroke="#2C1810" stroke-width="${s*.015}" fill="none" stroke-linecap="round"/></svg>`}

/* ===== MULTI-AI API CALLS ===== */
// Track consecutive failures per model (not permanent ban)
let apiFailCount={gemPro:0,gemFlash:0,gemLite:0,gem2F:0,oai:0,cla:0};

// Multi-key rotation for Gemini
let gemKeys=[];  // Array of API keys
let gemKeyIdx=0; // Current key index
function getGemKey(){
  if(!gemKeys.length)return '';
  return gemKeys[gemKeyIdx%gemKeys.length];
}
function rotateGemKey(){
  if(gemKeys.length<=1)return false;
  gemKeyIdx++;
  console.log(`[MOTIVE] ğŸ”„ Gemini í‚¤ êµì²´ â†’ #${(gemKeyIdx%gemKeys.length)+1}/${gemKeys.length}`);
  return true; // successfully rotated
}
function initGemKeys(){
  // Support comma, newline, or space separated keys
  gemKeys=(keys.gem||'').split(/[,\n\s]+/).map(k=>k.trim()).filter(k=>k.startsWith('AIza'));
  gemKeyIdx=0;
  console.log(`[MOTIVE] Gemini í‚¤ ${gemKeys.length}ê°œ ë¡œë“œë¨`);
}

// Helper: call any Gemini model with retry + key rotation
async function _callGem(model,sys,contents,src,label){
  if(!gemKeys.length){initGemKeys()}
  if(!gemKeys.length)return{ok:false,err:label+' í‚¤ ì—†ìŒ',src};
  if(apiFailCount[src]>=3*gemKeys.length)return{ok:false,err:label+' ì „ì²´ í‚¤ ì†Œì§„',src};

  const maxAttempts=Math.min(gemKeys.length*2,6); // Try each key up to 2 times
  for(let attempt=0;attempt<maxAttempts;attempt++){
    const currentKey=getGemKey();
    try{const b={contents,generationConfig:{temperature:0.8,maxOutputTokens:2048}};if(sys)b.system_instruction={parts:[{text:sys}]};
    console.log(`[MOTIVE] ${label} (${model}) í‚¤#${(gemKeyIdx%gemKeys.length)+1} ì‹œë„...`);
    const r=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${currentKey}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(b)});
    const d=await r.json();
    console.log(`[MOTIVE] ${label} ì‘ë‹µ:`,r.status,d.error?d.error.message:'OK');
    if(d.candidates?.[0]){apiFailCount[src]=0;return{ok:true,text:d.candidates[0].content.parts.filter(p=>p.text).map(p=>p.text).join(''),src,label}}
    if(d.error){
      const isQuota=d.error.code===429||d.error.message?.includes('quota')||d.error.message?.includes('Resource has been exhausted');
      if(isQuota){
        // Try rotating to next key
        if(rotateGemKey()){
          console.log(`[MOTIVE] ${label} 429 â†’ ë‹¤ìŒ í‚¤ë¡œ ì „í™˜, 2ì´ˆ ëŒ€ê¸°...`);
          await new Promise(r=>setTimeout(r,2000));
          continue;
        }
        // No more keys, wait and retry once
        if(attempt===0){
          console.log(`[MOTIVE] ${label} 429 â†’ 5ì´ˆ í›„ ì¬ì‹œë„...`);
          await new Promise(r=>setTimeout(r,5000));
          continue;
        }
        apiFailCount[src]++;return{ok:false,err:label+' í• ë‹¹ëŸ‰ ì´ˆê³¼ (í‚¤'+gemKeys.length+'ê°œ ì „ë¶€)',quota:true,src};
      }
      return{ok:false,err:label+': '+d.error.message,src}}
    if(d.promptFeedback?.blockReason){return{ok:false,err:label+' ì•ˆì „í•„í„° ì°¨ë‹¨',src}}
    return{ok:false,err:label+' ì‘ë‹µ ì—†ìŒ ('+r.status+')',src}}catch(e){apiFailCount[src]++;console.error(`[MOTIVE] ${label} ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬:`,e);return{ok:false,err:label+' ë„¤íŠ¸ì›Œí¬: '+e.message,src}}
  }
  return{ok:false,err:label+' ì‹¤íŒ¨',src};
}

// Gemini 2.5 Pro â€” PM ì¢…í•©ë³´ê³ , ìµœê³  í’ˆì§ˆ (5 RPM, 50~100 RPD)
function callGeminiPro(sys,contents){return _callGem('gemini-2.5-pro',sys,contents,'gemPro','Pro 2.5')}
// Gemini 2.5 Flash â€” í•µì‹¬ ë¶„ì„Â·ê¸°íšÂ·ì „ëµ (10 RPM, 250 RPD)
function callGeminiFlash(sys,contents){return _callGem('gemini-2.5-flash',sys,contents,'gemFlash','Flash 2.5')}
// Gemini 2.5 Flash-Lite â€” ëŒ€ëŸ‰ ì²˜ë¦¬Â·ë§ˆì¼€íŒ…Â·ì˜ì—… (15 RPM, 1,000 RPD)
function callGeminiLite(sys,contents){return _callGem('gemini-2.5-flash-lite',sys,contents,'gemLite','Lite 2.5')}
// Gemini 2.0 Flash â€” ì¶”ê°€ ë°±ì—… (ë³„ë„ í• ë‹¹ëŸ‰)
function callGemini2F(sys,contents){return _callGem('gemini-2.0-flash',sys,contents,'gem2F','Flash 2.0')}

async function callGPT(sys,userMsg){
  if(!keys.oai||apiFailCount.oai>=3)return{ok:false,err:'GPT í‚¤ ì—†ìŒ ë˜ëŠ” ë¹„í™œì„±',src:'oai'};
  try{const msgs=[];if(sys)msgs.push({role:'system',content:sys});msgs.push({role:'user',content:userMsg});
  const r=await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${keys.oai}`},body:JSON.stringify({model:'gpt-4o',messages:msgs,max_tokens:2048,temperature:0.8})});
  const d=await r.json();
  if(d.choices?.[0])return{ok:true,text:d.choices[0].message.content,src:'oai',label:'GPT-4o'};
  if(d.error){
    if(d.error.code==='rate_limit_exceeded'||d.error.type==='insufficient_quota'){apiFailCount.oai++;return{ok:false,err:'GPT í• ë‹¹ëŸ‰ ì´ˆê³¼',quota:true,src:'oai'}}
    return{ok:false,err:d.error.message,src:'oai'}}
  return{ok:false,err:'ì‘ë‹µ ì—†ìŒ',src:'oai'}}catch(e){return{ok:false,err:e.message,src:'oai'}}}

async function callClaude(sys,userMsg){
  if(!keys.cla||apiFailCount.cla>=3)return{ok:false,err:'Claude í‚¤ ì—†ìŒ ë˜ëŠ” ë¹„í™œì„±',src:'cla'};
  try{const r=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':keys.cla,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:2048,system:sys||'',messages:[{role:'user',content:userMsg}]})});
  const d=await r.json();
  if(d.content?.[0])return{ok:true,text:d.content[0].text,src:'cla',label:'Claude'};
  if(d.error){
    if(d.error.type==='rate_limit_error'){apiFailCount.cla++;return{ok:false,err:'Claude í• ë‹¹ëŸ‰ ì´ˆê³¼',quota:true,src:'cla'}}
    return{ok:false,err:d.error.message,src:'cla'}}
  return{ok:false,err:'ì‘ë‹µ ì—†ìŒ',src:'cla'}}catch(e){return{ok:false,err:e.message,src:'cla'}}}

// iMac Relay - Claude Max via relay server (unlimited, ëŒ€í™” íˆìŠ¤í† ë¦¬ ì§€ì›)
async function callRelay(sys,userMsg){
  if(!keys.relay)return{ok:false,err:'ë¦´ë ˆì´ ë¯¸ì„¤ì •',src:'relay'};
  try{
    console.log('[MOTIVE] ë¦´ë ˆì´ ì„œë²„ í˜¸ì¶œ... ì±„ë„:',curCh);
    const ctrl=new AbortController();
    const tm=setTimeout(()=>ctrl.abort(),90000);
    const r=await fetch(keys.relay.replace(/\/$/,'')+'/api/chat',{method:'POST',headers:{'Content-Type':'application/json','Bypass-Tunnel-Reminder':'true'},body:JSON.stringify({system:sys,message:userMsg,channelId:curCh||'default'}),signal:ctrl.signal});
    clearTimeout(tm);
    const d=await r.json();
    if(d.ok&&d.text)return{ok:true,text:d.text,src:'relay',label:'Claude Max'};
    return{ok:false,err:d.error||'ë¦´ë ˆì´ ì‘ë‹µ ì—†ìŒ',src:'relay'};
  }catch(e){console.error('[MOTIVE] ë¦´ë ˆì´ ì—ëŸ¬:',e);return{ok:false,err:'ë¦´ë ˆì´ ì—°ê²° ì‹¤íŒ¨: '+e.message,src:'relay'}}
}

async function genMJPrompt(context,memberWork){
  const sys=`You are a Midjourney prompt expert. Generate ONE professional Midjourney prompt based on the context.
Rules:
- Write in English
- Include detailed visual description
- End with Midjourney parameters like --ar 16:9 --v 6.1 --style raw
- For logos/branding: add --no text, letters
- For photos: add --style raw
- For UI/UX: add --ar 16:9
- Output ONLY the prompt, nothing else`;
  const uMsg=`Context: ${context}\nCreative direction: ${memberWork?.slice(0,500)||context}`;
  let r=await callGeminiLite(sys,[{role:'user',parts:[{text:uMsg}]}]);
  if(r.ok)return r.text;
  r=await callGeminiFlash(sys,[{role:'user',parts:[{text:uMsg}]}]);
  if(r.ok)return r.text;
  r=await callGPT(sys,uMsg);
  if(r.ok)return r.text;
  r=await callClaude(sys,uMsg);
  if(r.ok)return r.text;
  return null;
}

/* ===== SMART AI ROUTING by member tier ===== */
/*
  í•µì‹¬ ë³€ê²½: PM ê³„íšìˆ˜ë¦½ì€ Lite(1000/ì¼)ë¡œ, Pro(50/ì¼)ëŠ” ìµœì¢… ìš”ì•½ì—ë§Œ ì‚¬ìš©
  429 ì—ëŸ¬ ì‹œ 2ì´ˆ ëŒ€ê¸° í›„ ë‹¤ìŒ ëª¨ë¸ ì‹œë„ (ì˜êµ¬ ì°¨ë‹¨ ì—†ìŒ)

  tier='pm'      â†’ Lite 2.5 (ê³„íšìˆ˜ë¦½) â†’ Flash 2.5 â†’ Claude â†’ GPT
  tier='pro'     â†’ Flash 2.5 (ë¶„ì„) â†’ Lite 2.5 â†’ Claude â†’ GPT
  tier='code'    â†’ Claude (ì½”ë“œ) â†’ Flash 2.5 â†’ Lite 2.5 â†’ GPT
  tier='lite'    â†’ Lite 2.5 (ëŒ€ëŸ‰) â†’ Flash 2.5 â†’ Claude â†’ GPT
  tier='creative'â†’ Flash 2.5 â†’ Lite 2.5 â†’ Claude â†’ GPT
  tier='pmfinal' â†’ Pro 2.5 (ìµœì¢…ë³´ê³ ) â†’ Flash 2.5 â†’ Lite 2.5
*/
async function callAI(member,sys,userMsg,tierOverride){
  const relay=()=>callRelay(sys,userMsg);
  const gP=()=>callGeminiPro(sys,[{role:'user',parts:[{text:userMsg}]}]);
  const gF=()=>callGeminiFlash(sys,[{role:'user',parts:[{text:userMsg}]}]);
  const gL=()=>callGeminiLite(sys,[{role:'user',parts:[{text:userMsg}]}]);
  const g2=()=>callGemini2F(sys,[{role:'user',parts:[{text:userMsg}]}]);
  const oai=()=>callGPT(sys,userMsg);
  const cla=()=>callClaude(sys,userMsg);

  // ë¦´ë ˆì´ ì‚¬ìš© ê°€ëŠ¥í•˜ë©´ ìµœìš°ì„ 
  const hasRelay=!!keys.relay;

  let tier=tierOverride||member.tier||'lite';

  let chain=[];
  if(hasRelay){
    // ë¦´ë ˆì´ ëª¨ë“œ: Claude Max ìµœìš°ì„  â†’ Gemini ë°±ì—…
    chain=[{fn:relay,n:'Claude Max'},{fn:gL,n:'Lite 2.5'},{fn:g2,n:'Flash 2.0'},{fn:gF,n:'Flash 2.5'}];
  }else{
    switch(tier){
      case 'pmfinal':chain=[{fn:gP,n:'Pro 2.5'},{fn:gF,n:'Flash 2.5'},{fn:g2,n:'Flash 2.0'},{fn:gL,n:'Lite 2.5'},{fn:cla,n:'Claude'}];break;
      case 'pm':      chain=[{fn:gL,n:'Lite 2.5'},{fn:g2,n:'Flash 2.0'},{fn:gF,n:'Flash 2.5'},{fn:cla,n:'Claude'},{fn:oai,n:'GPT-4o'}];break;
      case 'code':    chain=[{fn:cla,n:'Claude'},{fn:gF,n:'Flash 2.5'},{fn:g2,n:'Flash 2.0'},{fn:gL,n:'Lite 2.5'},{fn:oai,n:'GPT-4o'}];break;
      case 'pro':     chain=[{fn:gF,n:'Flash 2.5'},{fn:g2,n:'Flash 2.0'},{fn:gL,n:'Lite 2.5'},{fn:cla,n:'Claude'},{fn:oai,n:'GPT-4o'}];break;
      case 'creative':chain=[{fn:gF,n:'Flash 2.5'},{fn:g2,n:'Flash 2.0'},{fn:gL,n:'Lite 2.5'},{fn:cla,n:'Claude'},{fn:oai,n:'GPT-4o'}];break;
      case 'lite':
      default:        chain=[{fn:gL,n:'Lite 2.5'},{fn:g2,n:'Flash 2.0'},{fn:gF,n:'Flash 2.5'},{fn:cla,n:'Claude'},{fn:oai,n:'GPT-4o'}];
    }
  }

  for(const a of chain){
    const r=await a.fn();
    if(r.ok){
      member._usedAI=r.label||a.n;
      member._usedTier=tier;
      return r.text;
    }
    // On quota failure, wait before trying next model
    if(r.quota)await new Promise(r=>setTimeout(r,2000));
  }
  member._usedAI='ì‹¤íŒ¨';
  return null;
}

function copyMJ(btn){
  const prompt=btn.closest('.mj-box').querySelector('.mj-prompt').textContent;
  navigator.clipboard.writeText('/imagine prompt: '+prompt).then(()=>{btn.textContent='âœ… ë³µì‚¬ë¨!';setTimeout(()=>{btn.textContent='ğŸ“‹ ë³µì‚¬ â†’ Midjourney'},1500)}).catch(()=>{
    const ta=document.createElement('textarea');ta.value='/imagine prompt: '+prompt;document.body.appendChild(ta);ta.select();document.execCommand('copy');ta.remove();btn.textContent='âœ… ë³µì‚¬ë¨!';setTimeout(()=>{btn.textContent='ğŸ“‹ ë³µì‚¬ â†’ Midjourney'},1500)
  });
}

/* ===== IMAGE GENERATION (Gemini 2.5 Flash Image â€” 500/day free) ===== */
async function callGeminiImagen(prompt){
  if(!keys.gem)return{ok:false,err:'Gemini í‚¤ ì—†ìŒ'};
  try{
    // Primary: Gemini 2.5 Flash Image (GA stable â€” "Nano Banana")
    // ë¬´ë£Œ: 60 RPM, 500 RPD Â· generateContent ì—”ë“œí¬ì¸íŠ¸
    const b1={contents:[{parts:[{text:prompt}]}],generationConfig:{responseModalities:['IMAGE','TEXT']}};
    const r1=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image:generateContent?key=${getGemKey()}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(b1)});
    const d1=await r1.json();
    if(d1.candidates?.[0]?.content?.parts){
      const imgPart=d1.candidates[0].content.parts.find(p=>p.inlineData);
      if(imgPart){return{ok:true,imageUrl:`data:${imgPart.inlineData.mimeType};base64,${imgPart.inlineData.data}`,model:'Flash Image'}}
    }
    // Fallback: Gemini 2.0 Flash experimental (if Flash Image unavailable)
    const b2={contents:[{role:'user',parts:[{text:'Generate an image: '+prompt}]}],generationConfig:{responseModalities:['TEXT','IMAGE']}};
    const r2=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${getGemKey()}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(b2)});
    const d2=await r2.json();
    if(d2.candidates?.[0]?.content?.parts){
      const ip=d2.candidates[0].content.parts.find(p=>p.inlineData);
      if(ip){return{ok:true,imageUrl:`data:${ip.inlineData.mimeType};base64,${ip.inlineData.data}`,model:'Flash 2.0'}}
    }
    return{ok:false,err:d1.error?.message||d2.error?.message||'ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨'};
  }catch(e){return{ok:false,err:e.message}}
}

async function generateImage(prompt,memberName){
  if(!keys.gem){toast('ì„¤ì •ì—ì„œ Gemini API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”');return null}
  const r=await callGeminiImagen(prompt);
  if(r.ok&&r.imageUrl)return r.imageUrl;
  if(r.err)toast(`ì´ë¯¸ì§€ ìƒì„±: ${r.err}`);
  return null;
}

/* ===== ELEVENLABS TTS ===== */
let currentAudio=null;
let currentTTSBtn=null;

async function playTTS(btn,text,voiceId){
  if(!keys.el){toast('ì„¤ì •ì—ì„œ ElevenLabs API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”');return}
  // Stop currently playing
  if(currentAudio){currentAudio.pause();currentAudio=null;if(currentTTSBtn){currentTTSBtn.classList.remove('playing');currentTTSBtn.innerHTML='ğŸ”Š ë“£ê¸°'}}
  // If clicking same button, just stop
  if(currentTTSBtn===btn){currentTTSBtn=null;return}
  // Clean text for TTS (remove markdown, code blocks, etc)
  let clean=text.replace(/\*\*/g,'').replace(/\*/g,'').replace(/#{1,6}\s/g,'').replace(/```[\s\S]*?```/g,'ì½”ë“œ ë¸”ë¡').replace(/`[^`]*`/g,'').replace(/\[.*?\]/g,'').replace(/\n{2,}/g,'. ').replace(/\n/g,', ').trim();
  if(clean.length>2000)clean=clean.slice(0,2000)+'... ì´í•˜ ìƒëµ';
  if(!clean){toast('ì½ì„ í…ìŠ¤íŠ¸ ì—†ìŒ');return}

  btn.classList.add('loading');btn.innerHTML='â³ ìƒì„± ì¤‘...';currentTTSBtn=btn;
  try{
    const r=await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voiceId}`,{
      method:'POST',
      headers:{'Content-Type':'application/json','xi-api-key':keys.el},
      body:JSON.stringify({text:clean,model_id:'eleven_multilingual_v2',voice_settings:{stability:0.5,similarity_boost:0.75,style:0.3}})
    });
    if(!r.ok){const e=await r.json().catch(()=>({}));toast('TTS ì˜¤ë¥˜: '+(e.detail?.message||r.status));btn.classList.remove('loading');btn.innerHTML='ğŸ”Š ë“£ê¸°';currentTTSBtn=null;return}
    const blob=await r.blob();
    const url=URL.createObjectURL(blob);
    currentAudio=new Audio(url);
    btn.classList.remove('loading');btn.classList.add('playing');btn.innerHTML='â¹ ì •ì§€';
    currentAudio.play();
    currentAudio.onended=()=>{btn.classList.remove('playing');btn.innerHTML='ğŸ”Š ë“£ê¸°';currentAudio=null;currentTTSBtn=null;URL.revokeObjectURL(url)};
    currentAudio.onerror=()=>{btn.classList.remove('playing');btn.innerHTML='ğŸ”Š ë“£ê¸°';currentAudio=null;currentTTSBtn=null;toast('ì¬ìƒ ì˜¤ë¥˜')}
  }catch(e){btn.classList.remove('loading');btn.innerHTML='ğŸ”Š ë“£ê¸°';currentTTSBtn=null;toast('TTS: '+e.message)}
}
function ttsMsg(ch,idx){const mg=chatDB[ch]?.[idx];if(!mg)return;const m=mg.mid?gm(mg.mid):null;if(!m||!m.voice)return;const btn=event.currentTarget;playTTS(btn,mg.content,m.voice)}

/* ===== 3D AVATAR MANAGEMENT ===== */
const AVATAR_STYLES={
  pm:{look:'confident Korean male CEO, navy suit, neat short hair, warm smile',age:'early 30s',vibe:'leadership aura'},
  design:{look:'creative Korean female designer, trendy outfit, stylish bob hair dyed with pink tips, artistic',age:'mid 20s',vibe:'artistic and cool'},
  marketing:{look:'energetic Korean female marketer, bright outfit, wavy medium hair, cheerful smile',age:'late 20s',vibe:'bright and dynamic'},
  planning:{look:'professional Korean female planner, smart casual blazer, elegant long hair, thoughtful expression',age:'late 20s',vibe:'organized and calm'},
  finance:{look:'analytical Korean male finance director, glasses, clean-cut hair, crisp shirt',age:'early 30s',vibe:'precise and trustworthy'},
  hr:{look:'warm Korean female HR manager, friendly smile, soft medium hair, approachable',age:'late 20s',vibe:'warm and empathetic'},
  sales:{look:'charismatic Korean male sales lead, confident grin, styled hair, sharp suit',age:'early 30s',vibe:'energetic and persuasive'},
  thinking:{look:'intellectual Korean male strategist, turtleneck, thoughtful eyes, slightly messy hair',age:'early 30s',vibe:'deep thinker'},
  research:{look:'curious Korean male researcher, casual smart outfit, round glasses, observant look',age:'mid 20s',vibe:'data-driven and curious'},
  dev:{look:'focused Korean male developer, hoodie, headphones around neck, modern hairstyle',age:'mid 20s',vibe:'tech-savvy and cool'},
  qa:{look:'detail-oriented Korean female QA engineer, neat outfit, tied-back hair, sharp eyes',age:'mid 20s',vibe:'meticulous and alert'},
  video:{look:'creative Korean male video director, trendy streetwear, expressive face, artistic hair',age:'mid 20s',vibe:'cinematic and bold'},
  photo:{look:'stylish Korean female photographer, camera strap, chic outfit, flowing hair',age:'mid 20s',vibe:'visual storyteller'},
  legal:{look:'authoritative Korean male legal counsel, formal suit, combed hair, serious yet kind face',age:'early 30s',vibe:'trustworthy and sharp'}
};

function renderAvGrid(){
  const grid=document.getElementById('avGrid');if(!grid)return;
  grid.innerHTML=TM.map(m=>{
    const hasVid=!!m.vids;
    const hasImg=!!avatarDB[m.id];
    let preview;
    if(hasVid)preview=`<div style="width:72px;height:72px;border-radius:50%;overflow:hidden;margin:0 auto"><video width="72" height="72" src="${m.vids[0]}" autoplay loop muted playsinline style="border-radius:50%;object-fit:cover;object-position:center 20%;transform:scale(1.35);border:2px solid ${m.color}44"></video></div>`;
    else if(hasImg)preview=`<img src="${avatarDB[m.id]}" width="72" height="72" style="border-radius:50%;object-fit:cover;border:2px solid ${m.color}44">`;
    else preview=`${av(m,72)}`;
    const emotions=hasVid?`<div style="display:flex;gap:3px;justify-content:center;margin-top:4px">${['ğŸ˜','ğŸ˜Š','ğŸ¤”','ğŸ˜¤'].map((e,i)=>`<span style="font-size:12px;cursor:pointer;opacity:.7" title="í‘œì • ${i}" onclick="previewEmo('${m.id}',${i},this.closest('.av-card'))">${e}</span>`).join('')}</div>`:'';
    return`<div class="av-card">
      <div class="av-card-preview">${preview}</div>
      <div class="av-card-name" style="color:${m.color}">${m.name}</div>
      <div class="av-card-role">${m.role} Â· ${m.aiLabel}</div>
      ${emotions}
      <input type="file" id="avf_${m.id}" accept="image/*" onchange="uploadAv('${m.id}',this)">
      ${hasVid?`<div style="font-size:8px;color:#c084fc;margin-top:3px">ğŸ¬ 3D ë¹„ë””ì˜¤</div>`:`<button class="av-card-btn" onclick="document.getElementById('avf_${m.id}').click()">${hasImg?'ğŸ”„ ë³€ê²½':'ğŸ“· ì—…ë¡œë“œ'}</button>`}
    </div>`}).join('');
}
function previewEmo(id,emoIdx,card){
  const m=gm(id);if(!m||!m.vids)return;
  const vid=card.querySelector('video');
  if(vid)vid.src=m.vids[emoIdx];
}

function uploadAv(id,input){
  const file=input.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=function(e){
    // Resize to 200x200 for localStorage efficiency
    const img=new Image();
    img.onload=function(){
      const canvas=document.createElement('canvas');
      canvas.width=200;canvas.height=200;
      const ctx=canvas.getContext('2d');
      const size=Math.min(img.width,img.height);
      const sx=(img.width-size)/2,sy=(img.height-size)/2;
      ctx.beginPath();ctx.arc(100,100,100,0,Math.PI*2);ctx.clip();
      ctx.drawImage(img,sx,sy,size,size,0,0,200,200);
      avatarDB[id]=canvas.toDataURL('image/webp',0.8);
      sv('v5av',avatarDB);
      renderAvGrid();rSlMenu();rChat();
      toast(gm(id).name+' ì•„ë°”íƒ€ ì—…ë°ì´íŠ¸!');
    };img.src=e.target.result;
  };reader.readAsDataURL(file);
}

function removeAv(id){
  delete avatarDB[id];sv('v5av',avatarDB);
  renderAvGrid();rSlMenu();rChat();
  toast(gm(id).name+' ì•„ë°”íƒ€ ì œê±°');
}

function genAllMJAvatars(){
  const prompts=TM.map(m=>{
    const s=AVATAR_STYLES[m.id];
    return{name:m.name,role:m.role,prompt:`3D rendered character portrait, Pixar-style, ${s.look}, ${s.age}, ${s.vibe}, solid ${m.color} color accent on clothing or accessory, dark gradient background, soft studio lighting, cute proportions with slightly large head, smooth skin, detailed eyes, professional office worker character, bust shot, high quality render, octane render, 8k --ar 1:1 --s 250 --style raw`};
  });
  // Show in modal
  const modal=document.getElementById('mjAvatarModal');
  if(!modal){
    const div=document.createElement('div');div.id='mjAvatarModal';div.className='modal show';
    div.innerHTML=`<div class="mdl" style="width:700px;max-height:85vh">
      <div class="mdl-hd"><div class="mdl-title">ğŸ¨ 14ëª… 3D ìºë¦­í„° ë¯¸ë“œì €ë‹ˆ í”„ë¡¬í”„íŠ¸</div><button class="mdl-x" onclick="this.closest('.modal').remove()">âœ•</button></div>
      <div class="mdl-bd" style="max-height:65vh;overflow-y:auto" id="mjAvContent"></div>
      <div class="mdl-ft"><button class="btn btn-g" onclick="copyAllMJPrompts()">ğŸ“‹ ì „ì²´ ë³µì‚¬</button><button class="btn" onclick="this.closest('.modal').remove()">ë‹«ê¸°</button></div>
    </div>`;
    document.body.appendChild(div);
  }else{modal.classList.add('show')}
  document.getElementById('mjAvContent').innerHTML=prompts.map((p,i)=>
    `<div style="margin-bottom:14px;padding:12px;background:var(--bg1);border:1px solid var(--bd);border-radius:8px">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
        <span style="font-size:11px;font-weight:700;color:${TM[i].color}">${p.name} (${p.role})</span>
        <button class="av-card-btn" onclick="navigator.clipboard.writeText('/imagine prompt: '+this.closest('div').parentElement.querySelector('.mj-prompt').textContent);this.textContent='âœ…';setTimeout(()=>this.textContent='ë³µì‚¬',1000)">ë³µì‚¬</button>
      </div>
      <div class="mj-prompt" style="font-size:10px;background:var(--bg2);border-radius:6px;padding:8px">${p.prompt}</div>
    </div>`).join('');
}
function copyAllMJPrompts(){
  const all=TM.map(m=>{const s=AVATAR_STYLES[m.id];return`[${m.name} - ${m.role}]\n/imagine prompt: 3D rendered character portrait, Pixar-style, ${s.look}, ${s.age}, ${s.vibe}, solid ${m.color} color accent on clothing or accessory, dark gradient background, soft studio lighting, cute proportions with slightly large head, smooth skin, detailed eyes, professional office worker character, bust shot, high quality render, octane render, 8k --ar 1:1 --s 250 --style raw`}).join('\n\n');
  navigator.clipboard.writeText(all).then(()=>toast('14ëª… ì „ì²´ í”„ë¡¬í”„íŠ¸ ë³µì‚¬ ì™„ë£Œ!')).catch(()=>toast('ë³µì‚¬ ì‹¤íŒ¨'));
}

/* Tabs */
function rTabs(){document.getElementById('tabBar').innerHTML=TABS.map(t=>`<button class="tab ${t.id===curTab?'on':''}" onclick="switchTab('${t.id}')"><span class="tab-icon">${t.i}</span>${t.l}</button>`).join('')}
function switchTab(id){curTab=id;document.querySelectorAll('.tab').forEach(e=>e.classList.remove('on'));document.querySelectorAll('.pnl').forEach(e=>e.classList.remove('on'));const i=TABS.findIndex(t=>t.id===id);if(i>=0)document.querySelectorAll('.tab')[i].classList.add('on');document.getElementById('p-'+id).classList.add('on')}

/* Sidebar */
let sbCollapsed=false;
function toggleSB(){
  sbCollapsed=!sbCollapsed;
  const sb=document.getElementById('sideBar');
  const btn=sb.querySelector('.sb-toggle');
  sb.classList.toggle('collapsed',sbCollapsed);
  btn.textContent=sbCollapsed?'â–¶':'â—€';
  // ëª¨ë°”ì¼ ì˜¤ë²„ë ˆì´
  let ov=document.getElementById('mobOverlay');
  if(!ov){ov=document.createElement('div');ov.id='mobOverlay';ov.className='mob-overlay';ov.onclick=()=>{if(!sbCollapsed)toggleSB()};document.body.appendChild(ov)}
  if(isMobile)ov.classList.toggle('show',!sbCollapsed);
}
function closeSBMobile(){if(isMobile&&!sbCollapsed)toggleSB()}
function rSB(){
  let h='<div class="sb-sec" style="padding-top:10px">ğŸ  í”„ë¡œì íŠ¸ë£¸</div>';
  h+=`<div class="sb-item room-item ${curCh==='room'?'on':''}" onclick="selCh('room')"><div style="width:48px;height:48px;border-radius:50%;background:var(--ac);display:flex;align-items:center;justify-content:center;font-weight:900;font-size:15px;color:#0a0a0a;flex-shrink:0">íŒ€</div><div style="flex:1;min-width:0"><div class="sb-name">íŒ€ í”„ë¡œì íŠ¸ë£¸</div><div class="sb-role">ë©€í‹°AI í˜‘ì—…</div>${isGen?'<div class="sb-active"><span class="sb-active-dot"></span>ì‘ì—… ì¤‘...</div>':''}</div></div>`;
  // í”„ë¡œì íŠ¸ë³„ ì „ìš© ì±„ë„
  const projChannels=projDB.filter(p=>chatDB['proj-'+p.id]?.length>0);
  if(projChannels.length){
    projChannels.forEach(p=>{const pch='proj-'+p.id;const msgCnt=chatDB[pch]?.length||0;const statusIcon=p.status==='done'?'âœ…':p.status==='progress'?'âš¡':'ğŸ“‹';
      h+=`<div class="sb-item ${curCh===pch?'on':''}" onclick="selCh('${pch}')" style="padding-left:20px"><div style="width:36px;height:36px;border-radius:8px;background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0">${statusIcon}</div><div style="flex:1;min-width:0"><div class="sb-name" style="font-size:12px">${esc(p.name)}</div><div class="sb-role" style="font-size:10px">${msgCnt}ê°œ ë©”ì‹œì§€</div></div></div>`;
    });
  }
  h+='<div class="sb-sec">ğŸ‘¤ 1:1</div>';
  TM.forEach(m=>{const ac=AI_COLORS[m.ai]||'';h+=`<div class="sb-item ${curCh===m.id?'on':''}" onclick="selCh('${m.id}')"><div style="width:48px;height:48px;flex-shrink:0;border-radius:50%;overflow:hidden">${av(m,48)}</div><div style="flex:1;min-width:0"><div class="sb-name">${m.name} <span class="sb-ai ${ac}">${m.aiLabel}</span></div><div class="sb-role">${m.role}</div></div><div class="sb-dot"></div></div>`});
  document.getElementById('sbList').innerHTML=h;
}
function selCh(id){curCh=id;rSB();rChatHd();rMsgs();closeSBMobile();if(curTab!=='chat'){switchTab('chat');rTabs()}
  // Show ğŸ¨ button for creative members
  const imgBtn=document.getElementById('imgGenBtn');
  if(imgBtn)imgBtn.style.display=['design','video','photo'].includes(id)?'inline-flex':'none';
}

/* Quick Image Generation for creative 1:1 */
async function quickImgGen(){
  const inp=document.getElementById('chatInp');
  const prompt=inp.value.trim()||'í”„ë¡œì íŠ¸ ê´€ë ¨ ë¹„ì£¼ì–¼ ì»¨ì…‰ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”';
  if(!keys.gem){toast('ì„¤ì •ì—ì„œ Gemini API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”');return}
  const m=gm(curCh);if(!m)return;
  if(!chatDB[curCh])chatDB[curCh]=[];
  chatDB[curCh].push({role:'user',content:'ğŸ¨ ì´ë¯¸ì§€ ìƒì„±: '+prompt,time:now()});sc();rMsgs();
  inp.value='';inp.style.height='auto';
  isGen=true;
  try{
    showTyp(`ğŸ–¼ï¸ ${m.name} â†’ Gemini Imagenìœ¼ë¡œ ì´ë¯¸ì§€ ìƒì„± ì¤‘...`);
    const imgUrl=await generateImage('Create a professional image: '+prompt,m.name);
    hideTyp();
    if(imgUrl){addM(curCh,curCh,`ğŸ–¼ï¸ **ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ**\n\n"${prompt}" ì»¨ì…‰ìœ¼ë¡œ ì´ë¯¸ì§€ë¥¼ ìƒì„±í–ˆìŠµë‹ˆë‹¤.`,null,imgUrl)}
    else{addM(curCh,curCh,'âš ï¸ ì´ë¯¸ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜ í”„ë¡¬í”„íŠ¸ë¥¼ ìˆ˜ì •í•´ë³´ì„¸ìš”.')}
  }catch(e){hideTyp();addM(curCh,curCh,'âš ï¸ ì´ë¯¸ì§€ ìƒì„± ì˜¤ë¥˜: '+e.message)}
  rMsgs();isGen=false;
}

/* Chat Header */
function rChatHd(){
  if(curCh==='room'){document.getElementById('chatHd').innerHTML=`<div class="chat-hd-l"><div style="width:52px;height:52px;border-radius:50%;background:var(--ac);display:flex;align-items:center;justify-content:center;font-weight:900;font-size:16px;color:#0a0a0a">íŒ€</div><div><div class="chat-hd-name">íŒ€ í”„ë¡œì íŠ¸ë£¸ <span class="chat-hd-tag">Smart AI</span></div><div class="chat-hd-info">ì—…ë¬´ë³„ ìµœì  AI ìë™ ë°°ì • Â· Pro 2.5 + Flash 2.5 + Lite 2.5 + Flash Image Â· ë³µì¡ë„ ìë™ ê°ì§€</div></div></div><button class="hbtn" onclick="clearCh()">ì´ˆê¸°í™”</button>`}
  else if(curCh.startsWith('proj-')){const pid=curCh.replace('proj-','');const p=projDB.find(x=>x.id===pid);const pname=p?p.name:'í”„ë¡œì íŠ¸';const teamStr=p?(p.team||[]).slice(0,4).map(tid=>{const m=TM.find(t=>t.id===tid);return m?m.name:''}).join(', '):'';document.getElementById('chatHd').innerHTML=`<div class="chat-hd-l"><div style="width:52px;height:52px;border-radius:8px;background:var(--bg3);display:flex;align-items:center;justify-content:center;font-weight:900;font-size:18px">ğŸ“‹</div><div><div class="chat-hd-name">${esc(pname)} <span class="chat-hd-tag">í”„ë¡œì íŠ¸</span></div><div class="chat-hd-info">${teamStr?'íŒ€: '+teamStr:'í”„ë¡œì íŠ¸ ì „ìš© ì±„ë„'}</div></div></div><button class="hbtn" onclick="selCh('room')">â† ë©”ì¸ë£¸</button><button class="hbtn" onclick="clearCh()">ì´ˆê¸°í™”</button>`}
  else{const m=gm(curCh);document.getElementById('chatHd').innerHTML=`<div class="chat-hd-l"><div style="width:52px;height:52px;border-radius:50%;overflow:hidden">${av(m,52)}</div><div><div class="chat-hd-name">${m.name}Â·${m.role} <span class="mg-ai-tag ${AI_COLORS[m.ai]}">${m.aiLabel}</span></div><div class="chat-hd-info">${m.desc}</div></div></div><button class="hbtn" onclick="clearCh()">ì´ˆê¸°í™”</button>`}
}

/* Messages */
function rMsgs(){
  const box=document.getElementById('msgs');const hist=chatDB[curCh];
  if(!hist||!hist.length){
    if(curCh==='room'){
      const teamVids=TM.map(m=>{
        const avHtml=isMobile
          ?`<div style="width:52px;height:52px;border-radius:50%;background:${m.color}33;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:18px;color:${m.color};border:2px solid ${m.color}44;margin:0 auto">${m.name[0]}</div>`
          :`<div style="width:64px;height:64px;border-radius:50%;overflow:hidden;margin:0 auto"><video class="av-vid" width="64" height="64" data-src="${m.vids?m.vids[1]:''}" autoplay loop muted playsinline preload="none" style="border-color:${m.color}44;background:#111"></video></div>`;
        return`<div style="text-align:center;cursor:pointer" onclick="selCh('${m.id}')">${avHtml}<div style="font-size:10px;font-weight:600;color:${m.color};margin-top:4px">${m.name}</div><div style="font-size:8px;color:var(--tx3)">${m.role}</div></div>`;
      }).join('');
      box.innerHTML=`<div class="welcome"><div class="w-hi">ì¢‹ì€ í•˜ë£¨ì…ë‹ˆë‹¤</div><div class="w-title"><b>ì±„í¬ì›…</b> ëŒ€í‘œë‹˜</div><div class="w-sub">ì—…ë¬´ë¥¼ ì§€ì‹œí•˜ë©´ ê° íŒ€ì›ì´ ì „ë¬¸ AIë¥¼ í™œìš©í•´ ì‹¤ì œ ì‘ì—…í•©ë‹ˆë‹¤</div>
        <div style="display:grid;grid-template-columns:repeat(${isMobile?4:7},1fr);gap:${isMobile?'8px':'12px'};margin:20px auto;max-width:600px;padding:${isMobile?'12px':'20px'};background:var(--bg2);border:1px solid var(--bd);border-radius:12px">${teamVids}</div>
        <div class="ai-map"><div class="ai-map-item"><span class="mg-ai-tag ai-gemini" style="background:#1a2a3a;color:#c8ff00">Pro 2.5</span>PM ì¢…í•©ë³´ê³ </div><div class="ai-map-item"><span class="mg-ai-tag ai-gemini">Flash 2.5</span>ê¸°íšÂ·ì „ëµÂ·ë¦¬ì„œì¹˜Â·ì¬ë¬´Â·QAÂ·ë²•ë¬´Â·ê°œë°œ</div><div class="ai-map-item"><span class="mg-ai-tag ai-gemini" style="background:#0d2a2a;color:#26c6da">Lite 2.5</span>ë§ˆì¼€íŒ…Â·ì˜ì—…Â·ì¸ì‚¬</div><div class="ai-map-item"><span class="mg-ai-tag ai-mj" style="background:#1a2a1a;color:#66bb6a">Flash Image</span>ì´ë¯¸ì§€ ìƒì„±</div><div class="ai-map-item"><span class="mg-ai-tag ai-claude">+Claude/GPT</span>í”„ë¦¬ë¯¸ì—„ ì—…ê·¸ë ˆì´ë“œ</div></div>
        <div class="w-flow"><div class="w-step">ğŸ“ ì—…ë¬´ ì§€ì‹œ</div><span class="w-arrow">â†’</span><div class="w-step">ğŸ¯ PM ë¶„ì„</div><span class="w-arrow">â†’</span><div class="w-step">âš¡ ê°ì AIë¡œ ì‘ì—…</div><span class="w-arrow">â†’</span><div class="w-step">ğŸ”Š ìŒì„± ë³´ê³ </div><span class="w-arrow">â†’</span><div class="w-step">âœ… PM ì¢…í•©</div></div>
        <div class="w-acts"><button class="w-btn" onclick="qm('AI SaaS ì œí’ˆì„ ê¸°íší•˜ê³  ë¸Œëœë“œ ë””ìì¸ê³¼ ëŸ°ì¹­ ì „ëµê¹Œì§€ ì „ë¶€ ë§Œë“¤ì–´ì¤˜')">ğŸš€ SaaS ëŸ°ì¹­</button><button class="w-btn" onclick="qm('ìš°ë¦¬ íšŒì‚¬ ë¸Œëœë”© ë¦¬ë‰´ì–¼í•´ì¤˜. ë¡œê³  ì»¨ì…‰, ë¸Œëœë“œ ê°€ì´ë“œ, ë§ˆì¼€íŒ… ë¹„ì£¼ì–¼ê¹Œì§€.')">ğŸ¨ ë¸Œëœë”©</button><button class="w-btn" onclick="qm('ëª¨ë°”ì¼ ì•± MVPë¥¼ ì„¤ê³„í•´ì¤˜. ê¸°íš, ë””ìì¸, ê°œë°œ ìŠ¤í™, QA í”Œëœê¹Œì§€.')">ğŸ“± ì•± MVP</button></div></div>`;
    }else if(curCh.startsWith('proj-')){const pid=curCh.replace('proj-','');const p=projDB.find(x=>x.id===pid);const pname=p?p.name:'í”„ë¡œì íŠ¸';box.innerHTML=`<div class="welcome"><div style="font-size:48px;margin-bottom:12px">ğŸ“‹</div><div class="w-title"><b>${esc(pname)}</b></div><div class="w-sub">${p?esc(p.desc||''):'í”„ë¡œì íŠ¸ ì±„ë„'}</div><div class="w-acts"><button class="w-btn" onclick="qm('í˜„ì¬ ì§„í–‰ìƒí™© ë³´ê³ í•´ì¤˜')">ğŸ“Š í˜„í™©</button><button class="w-btn" onclick="qm('ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰í•´ì¤˜')">âš¡ ë‹¤ìŒë‹¨ê³„</button></div></div>`}
    else{const m=gm(curCh);box.innerHTML=`<div class="welcome"><div style="width:100px;height:100px;border-radius:50%;overflow:hidden;margin:0 auto 14px">${av(m,100,1)}</div><div class="w-title"><b>${m.name}</b> ${m.role}</div><div class="w-sub">${m.desc} Â· <span class="mg-ai-tag ${AI_COLORS[m.ai]}">${m.aiLabel}</span> ì‚¬ìš©</div><div class="w-acts"><button class="w-btn" onclick="qm('í˜„ì¬ ì—…ë¬´ í˜„í™©')">ğŸ“Š í˜„í™©</button><button class="w-btn" onclick="qm('ì „ë¬¸ ì˜ê²¬ ì¤˜')">ğŸ’¡ ì˜ê²¬</button></div></div>`}
    return;
  }
  box.innerHTML=hist.map((mg,idx)=>{
    const m=mg.mid?gm(mg.mid):null;
    let fh='';if(mg.files?.length)fh=mg.files.map(f=>f.type?.startsWith('image/')?`<div class="mg-file"><img src="${f.data}"></div>`:`<div class="mg-file"><div class="mg-file-i">ğŸ“ ${esc(f.name)}</div></div>`).join('');
    let mjH='';if(mg.mjPrompt)mjH=`<div class="mj-box"><div class="mj-box-hd"><span>ğŸ¨ Midjourney Prompt</span><button onclick="copyMJ(this)">ğŸ“‹ ë³µì‚¬ â†’ Midjourney</button></div><div class="mj-prompt">${esc(mg.mjPrompt)}</div></div>`;
    let imgH='';if(mg.imageUrl&&mg.imageUrl!=='[img-session]')imgH=`<div class="gen-img-box"><div class="gen-img-label">ğŸ–¼ï¸ Gemini Imagen ìƒì„± ì´ë¯¸ì§€</div><img src="${mg.imageUrl}" class="gen-img" onclick="window.open(this.src)"><div style="font-size:9px;color:var(--tx3);margin-top:4px">í´ë¦­í•˜ë©´ í™•ëŒ€ Â· ë¬´ë£Œ Gemini Imagen API</div></div>`;
    else if(mg.imageUrl==='[img-session]')imgH=`<div class="gen-img-box" style="border-color:#333"><div class="gen-img-label" style="color:var(--tx3)">ğŸ–¼ï¸ ì´ë¯¸ì§€ (ì´ì „ ì„¸ì…˜ ë§Œë£Œ â€” ë‹¤ì‹œ ìƒì„± í•„ìš”)</div></div>`;
    if(mg.role==='user')return`<div class="mg usr"><div class="mg-bd"><div class="mg-sn">ì±„í¬ì›… ëŒ€í‘œë‹˜</div><div class="mg-bb">${esc(mg.content)}${fh}</div><div class="mg-time">${mg.time}</div></div></div>`;
    if(mg.type==='sys')return`<div class="mg" style="max-width:100%;align-self:center"><div class="mg-bd" style="width:100%"><div class="mg-bb sys">${fmt(mg.content)}</div></div></div>`;
    const isSm=mg.type==='summary';const isWk=mg.type==='work';
    const badge=m?`<span class="mg-badge" style="background:${m.color}22;color:${m.color}">${m.role}</span>`:'';
    const aiTag=m?`<span class="mg-ai-tag ${AI_COLORS[m.ai]||'ai-gemini'}">${mg.usedAI||m.aiLabel||''}</span>`:'';
    const ttsBtn=m&&keys.el&&m.voice?`<button class="tts-btn" onclick="ttsMsg('${curCh}',${idx})">ğŸ”Š ë“£ê¸°</button>`:'';
    const cls=isSm?'mg-bb pm-sum':isWk?'mg-bb work':'mg-bb';
    const bs=isWk&&m?`border-left-color:${m.color}`:'';
    const emo=m?detectEmo(mg.content):0;
    return`<div class="mg"><div class="mg-av">${m?av(m,54,emo):''}</div><div class="mg-bd"><div class="mg-sn">${m?m.name:''} ${badge} ${aiTag} ${mg.type==='review'?'<span style="font-size:9px;color:var(--orn)">ë¦¬ë·°</span>':''}</div><div class="${cls}" style="${bs}">${fmt(mg.content)}${imgH}${mjH}</div>${ttsBtn}<div class="mg-time">${mg.time}</div></div></div>`;
  }).join('');
  box.scrollTop=box.scrollHeight;
}
function qm(t){document.getElementById('chatInp').value=t;send()}
function clearCh(){chatDB[curCh]=[];sc();rMsgs();toast('ì´ˆê¸°í™”')}

/* Files */
function onFiles(ev){Array.from(ev.target.files).forEach(f=>{const r=new FileReader();r.onload=e=>{pFiles.push({name:f.name,type:f.type,data:e.target.result});rFP()};r.readAsDataURL(f)});ev.target.value=''}
function rFP(){const b=document.getElementById('fpBar');if(!pFiles.length){b.classList.remove('show');b.innerHTML='';return}b.classList.add('show');b.innerHTML=pFiles.map((f,i)=>`<div class="fp-chip">${f.type.startsWith('image/')?`<img src="${f.data}">`:'ğŸ“'}<span>${esc(f.name)}</span><span class="fp-x" onclick="pFiles.splice(${i},1);rFP()">&times;</span></div>`).join('')}

/* Send */
function send(){const inp=document.getElementById('chatInp');const text=inp.value.trim();if((!text&&!pFiles.length)||isGen)return;if(text.startsWith('/')){handleSl(text);inp.value='';inp.style.height='auto';return}if(!chatDB[curCh])chatDB[curCh]=[];chatDB[curCh].push({role:'user',content:text,time:now(),files:pFiles.length?[...pFiles]:undefined});sc();rMsgs();const files=[...pFiles];pFiles=[];rFP();inp.value='';inp.style.height='auto';
  // room ë˜ëŠ” proj- ì±„ë„ì´ë©´ í˜‘ì—… ëª¨ë“œ
  if(curCh==='room'||curCh.startsWith('proj-'))runCollab(text,files);else runDirect(text,files)}

/* ===== COLLABORATIVE WORKFLOW WITH MULTI-AI ===== */
async function runCollab(userMsg,files){
  isGen=true;rSB();const ch=curCh; // room ë˜ëŠ” proj-xxx
  const hasAny=keys.relay||keys.gem||keys.oai||keys.cla;
  if(!hasAny){toast('ì„¤ì •ì—ì„œ Gemini API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ë¬´ë£Œ)');isGen=false;rSB();return}
 try{
  // === ì´ì–´ì„œ ëŒ€í™” ê°ì§€: ì´ë¯¸ íŒ€ ì‘ì—…ì´ ìˆìœ¼ë©´ ì¬ì†Œì§‘í•˜ì§€ ì•ŠìŒ ===
  const recentMsgs=chatDB[ch]?.slice(-20)||[];
  const hasTeamWork=recentMsgs.some(m=>m.type==='work'||m.type==='summary'||m.type==='review');
  if(hasTeamWork){
    // ì´ì–´ì„œ ëŒ€í™” ëª¨ë“œ â€” PMì´ ë§¥ë½ íŒŒì•…í•˜ê³  ì§ì ‘ ë‹µë³€ + í•„ìš”ì‹œ íŠ¹ì • íŒ€ì›ë§Œ í˜¸ì¶œ
    showTyp('ğŸ’¬ í•˜ì¤€ PM ì‘ë‹µ ì¤‘...');
    const pm=gm('pm');
    const ctx=recentMsgs.slice(-12).map(m=>{
      const who=m.role==='user'?'ëŒ€í‘œë‹˜':(m.mid?gm(m.mid)?.name||'PM':'PM');
      return`${who}: ${(m.content||'').slice(0,200)}`;
    }).join('\n');
    const contResp=await callAI(pm,`ë‹¹ì‹ ì€ PM í•˜ì¤€ì…ë‹ˆë‹¤. íŒ€ì´ ì´ë¯¸ ì‘ì—…ì„ ì§„í–‰í–ˆê±°ë‚˜ ì™„ë£Œí•œ ìƒíƒœì…ë‹ˆë‹¤.
ëŒ€í‘œë‹˜ì˜ ì¶”ê°€ ë©”ì‹œì§€ì— ìì—°ìŠ¤ëŸ½ê²Œ ëŒ€ì‘í•˜ì„¸ìš”:
- ì§ˆë¬¸ì´ë©´ ë‹µë³€í•˜ì„¸ìš”
- í”¼ë“œë°±ì´ë©´ ë°˜ì˜ ë°©í–¥ì„ ì„¤ëª…í•˜ì„¸ìš”
- ì¶”ê°€ ì‘ì—…ì´ í•„ìš”í•˜ë©´ ì–´ë–¤ íŒ€ì›ì—ê²Œ ì‹œí‚¬ì§€ ì„¤ëª…í•˜ì„¸ìš”
- ëŒ€í™”ë¥¼ ì´ì–´ê°€ì„¸ìš” (íŒ€ì„ ì²˜ìŒë¶€í„° ì¬ì†Œì§‘í•˜ì§€ ë§ˆì„¸ìš”)
JSONì´ ì•„ë‹Œ ìì—°ìŠ¤ëŸ¬ìš´ í•œêµ­ì–´ë¡œ ë‹µí•˜ì„¸ìš”. ì¡´ëŒ“ë§.`,
    `[ì§„í–‰ ì¤‘ì¸ ëŒ€í™”]\n${ctx}\n\n[ëŒ€í‘œë‹˜ ì¶”ê°€ ë©”ì‹œì§€]\n${userMsg}`);
    hideTyp();
    const pmReply=contResp||'ë„¤ ëŒ€í‘œë‹˜, í™•ì¸í–ˆìŠµë‹ˆë‹¤. íŒ€ì— ì „ë‹¬í•˜ê² ìŠµë‹ˆë‹¤!';
    addM(ch,'pm',pmReply,'sys');rMsgs();
    // PMì´ íŠ¹ì • íŒ€ì› í˜¸ì¶œì„ ì–¸ê¸‰í•˜ë©´ í•´ë‹¹ íŒ€ì› 1ëª…ë§Œ ì¶”ê°€ ì‘ì—…
    const memberMention=pmReply.match(/(ìˆ˜ì•„|ë£¨ë‚˜|ì„œì—°|ì§€í˜¸|í•˜ì€|ë¯¼ì„œ|í˜„ìš°|ì‹œìš°|ë„ìœ¤|ì˜ˆë¦°|íƒœìœ¤|ìœ ë‚˜|ì„¸ì§„)/);
    if(memberMention){
      const nameMap={ìˆ˜ì•„:'design',ë£¨ë‚˜:'marketing',ì„œì—°:'planning',ì§€í˜¸:'finance',í•˜ì€:'hr',ë¯¼ì„œ:'sales',í˜„ìš°:'thinking',ì‹œìš°:'research',ë„ìœ¤:'dev',ì˜ˆë¦°:'qa',íƒœìœ¤:'video',ìœ ë‚˜:'photo',ì„¸ì§„:'legal'};
      const mid=nameMap[memberMention[1]];
      if(mid){
        const member=gm(mid);
        await new Promise(r=>setTimeout(r,3000));
        showTyp(`âš¡ ${member.name}(${member.role}) ì¶”ê°€ ì‘ì—… ì¤‘...`);
        const extra=await callAI(member,`${member.prompt}\nì´ì „ ì‘ì—…ì— ì´ì–´ì„œ ëŒ€í‘œë‹˜ ì¶”ê°€ ìš”ì²­ì— ëŒ€ì‘í•˜ì„¸ìš”. í•œêµ­ì–´.`,`[ì§„í–‰ ì¤‘ì¸ ëŒ€í™”]\n${ctx}\n\n[ëŒ€í‘œë‹˜ ì¶”ê°€ ë©”ì‹œì§€]\n${userMsg}\n[PM ì§€ì‹œ]\n${pmReply}`);
        hideTyp();
        if(extra)addM(ch,mid,extra,'work');rMsgs();
      }
    }
    isGen=false;rSB();return;
  }

  // === ìƒˆ í”„ë¡œì íŠ¸ ëª¨ë“œ: íŒ€ ì†Œì§‘ ===
  // STEP 1: PM analyzes intent from conversation context
  showTyp('ğŸ’¬ í•˜ì¤€ PM ì‘ë‹µ ì¤‘...');
  const pm=gm('pm');
  const recent=chatDB[ch]?.slice(-8).filter(m=>m.role==='user'||m.type==='sys').map(m=>m.role==='user'?`ëŒ€í‘œë‹˜: ${m.content}`:`í•˜ì¤€: ${m.content?.slice(0,200)}`).join('\n')||'';

  // ë©”ì‹œì§€ ê¸¸ì´/í‚¤ì›Œë“œë¡œ ì‚¬ì „ íŒë‹¨: ì§§ì€ ì¸ì‚¬ë§Œ chat, ë‚˜ë¨¸ì§€ëŠ” work ì‹œë„
  const chatOnly=/^(ì•ˆë…•|í•˜ì´|hi|hello|ã…ã…‡|ã…ã…|ã…‹ã…‹|ë„¤|ì‘|ã…‡ã…‡|êµ¿|ì¢‹ì•„|ì˜¤í‚¤|ê³ ë§ˆì›Œ|ìˆ˜ê³ |ì˜í–ˆ|ë©‹ì ¸|ëŒ€ë‹¨|ë°”ë¹ \??|ë­í•´\??|ë­í•˜ê³ .?ìˆì–´|ì˜ì|ì¢‹ì€.?ì•„ì¹¨|í•˜ì¤€|í•˜ì¤€ì•„)$/i.test(userMsg.trim());

  let intentResp=null;
  if(!chatOnly){
    intentResp=await callAI(pm,`ë‹¹ì‹ ì€ PM í•˜ì¤€ì…ë‹ˆë‹¤. 28ì„¸ ë‚¨ì„±, ë°ê³  ìœ ëŠ¥í•œ ì„±ê²©. ì‚¬ìš©ìëŠ” ì±„í¬ì›… ëŒ€í‘œë‹˜ì…ë‹ˆë‹¤.

## ì—­í• : ì—¬ê¸°ëŠ” íŒ€ í”„ë¡œì íŠ¸ ë£¸ì…ë‹ˆë‹¤. ëŒ€í‘œë‹˜ì´ ì—¬ê¸°ì„œ ë§ì”€í•˜ì‹œë©´ ëŒ€ë¶€ë¶„ ì—…ë¬´ ì§€ì‹œì…ë‹ˆë‹¤.

## íŒë‹¨ ê¸°ì¤€
- "chat": 1~2ë‹¨ì–´ ì¸ì‚¬, ì•ˆë¶€, "ê³ ë§ˆì›Œ", "ìˆ˜ê³ " ê°™ì€ ì§§ì€ ëŒ€í™”ë§Œ
- "work": ê·¸ ì™¸ ëª¨ë“  ê²ƒ (ì§ˆë¬¸, ìš”ì²­, ì˜ê²¬, ì§€ì‹œ, ë³´ê³  ìš”ì²­ ë“±)
- **ì• ë§¤í•˜ë©´ ë°˜ë“œì‹œ "work"ë¡œ íŒë‹¨í•˜ì„¸ìš”** â€” ì—¬ê¸°ëŠ” í”„ë¡œì íŠ¸ ë£¸ì…ë‹ˆë‹¤

ë°˜ë“œì‹œ JSONìœ¼ë¡œë§Œ ì‘ë‹µ:
{"intent":"chatë˜ëŠ”work","reply":"ëŒ€í‘œë‹˜ì—ê²Œ ìì—°ìŠ¤ëŸ½ê²Œ ë‹µë³€(1~3ë¬¸ì¥)","team":["íŒ€ì›id"],"tasks":{"id":"ì—…ë¬´"}}

workì¼ ë•Œ: replyì— íŒ€êµ¬ì„± ì„¤ëª…, teamì— 2~6ëª…(ë°˜ë“œì‹œ ì í•©í•œ íŒ€ì›), tasksì— ê° ì—…ë¬´
chatì¼ ë•Œ: replyë§Œ ì±„ìš°ê³  teamì€ ë¹ˆë°°ì—´

íŒ€ì›: design(ìˆ˜ì•„/ë””ìì¸), marketing(ë£¨ë‚˜/ë§ˆì¼€íŒ…), planning(ì„œì—°/ê¸°íš), finance(ì§€í˜¸/ì¬ë¬´), hr(í•˜ì€/ì¸ì‚¬), sales(ë¯¼ì„œ/ì˜ì—…), thinking(í˜„ìš°/ì „ëµ), research(ì‹œìš°/ë¦¬ì„œì¹˜), dev(ë„ìœ¤/ê°œë°œ), qa(ì˜ˆë¦°/QA), video(íƒœìœ¤/ì˜ìƒ), photo(ìœ ë‚˜/í¬í† ), legal(ì„¸ì§„/ë²•ë¬´)`,
    `${recent?'[ìµœê·¼ ëŒ€í™”]\n'+recent+'\n\n':''}[ì§€ê¸ˆ ëŒ€í‘œë‹˜ ë©”ì‹œì§€]\n${userMsg}`);
  }

  // Parse PM response
  let intent='chat',reply=null,plan=null;
  if(chatOnly){
    intent='chat';reply=null;
  }else if(intentResp){
    try{
      const cleaned=intentResp.replace(/```json?\s*/g,'').replace(/```\s*/g,'').trim();
      const json=JSON.parse(cleaned.match(/\{[\s\S]*\}/)?.[0]||cleaned);
      intent=json.intent||'work'; // ê¸°ë³¸ê°’ì„ workë¡œ ë³€ê²½
      reply=json.reply||null;
      if(json.team?.length){
        plan={analysis:reply||'ì—…ë¬´ë¥¼ ë¶„ì„í–ˆìŠµë‹ˆë‹¤.',team:json.team,tasks:json.tasks||{},order:json.team};
        intent='work';
      }
    }catch(e){
      // JSON íŒŒì‹± ì‹¤íŒ¨ â†’ workë¡œ ê°„ì£¼, ì „ì²´ íŒ€ íˆ¬ì…
      reply=intentResp||null;
      intent='work';
      const autoTeam=['thinking','planning','design','marketing','research','dev'];
      plan={analysis:reply||'íŒ€ì„ êµ¬ì„±í•˜ì—¬ ì‘ì—…ì„ ì‹œì‘í•©ë‹ˆë‹¤.',team:autoTeam,tasks:{},order:autoTeam};
    }
  }else{
    // API ì „ë¶€ ì‹¤íŒ¨ â†’ ë©”ì‹œì§€ê°€ ì§§ì§€ ì•Šìœ¼ë©´ ìë™ work ëª¨ë“œ
    if(userMsg.length>10){
      intent='work';reply='ë„¤ ëŒ€í‘œë‹˜! íŒ€ì„ êµ¬ì„±í•´ì„œ ë°”ë¡œ ì‹œì‘í•˜ê² ìŠµë‹ˆë‹¤.';
      const autoTeam=['thinking','planning','design','marketing','research'];
      plan={analysis:reply,team:autoTeam,tasks:{},order:autoTeam};
    }
  }

  hideTyp();

  // CHAT MODE: PM just responds naturally
  if(intent==='chat'||!plan){
    if(!reply)reply='ë„¤ ëŒ€í‘œë‹˜, ë§ì”€í•˜ì„¸ìš”!';
    addM(ch,'pm',reply,'sys');rMsgs();
    isGen=false;rSB();return;
  }

  // WORK MODE: Team collaboration
  const teamStr=plan.team.map(id=>{const m=gm(id);return m?`**${m.name}**(${m.role}/${m.aiLabel})`:id}).join(', ');
  addM(ch,'pm',`ğŸ¯ **íŒ€ êµ¬ì„± ì™„ë£Œ**\n\n${plan.analysis}\n\n**íˆ¬ì…**: ${teamStr}\n\nê° íŒ€ì›ì´ ì „ë¬¸ AIë¥¼ í™œìš©í•´ ì‹¤ì œ ì‘ì—…ì„ ì‹œì‘í•©ë‹ˆë‹¤...`,'sys');rMsgs();

  // PHASE 2: Each member works with their AI
  const order=plan.order||plan.team;
  const outputs={};
  for(let i=0;i<order.length;i++){
    const mid=order[i];const member=gm(mid);if(!member)continue;
    const task=plan.tasks[mid]||`${member.role} ì‘ì—…`;
    const prev=Object.entries(outputs).map(([k,w])=>{const pm=gm(k);return`[${pm.name}/${pm.role}]: ${w.text?.slice(0,600)||''}`}).join('\n\n');

    showTyp(`âš¡ ${member.name}(${member.role}) â†’ ${member.aiLabel} ì‘ì—… ì¤‘...`);
    // Rate limit: add delay between API calls to avoid 15 RPM limit
    if(i>0)await new Promise(r=>setTimeout(r,5000));

    let text=null;let mjPrompt=null;let genImage=null;
    const isCreative=['design','video','photo'].includes(mid);

      text=await callAI(member,
        `${member.prompt}\n\n[ì—…ë¬´ ìˆ˜í–‰ ì›ì¹™]\në‹¹ì‹ ì€ ì´ ë¶„ì•¼ì˜ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë¯¸ì…˜ì„ ë°›ìœ¼ë©´:\n1. ê´€ë ¨ íŠ¸ë Œë“œì™€ ìµœì‹  ì‚¬ë¡€ë¥¼ ìŠ¤ìŠ¤ë¡œ ì¡°ì‚¬/ì°¸ê³ í•œ ê²ƒì²˜ëŸ¼ ì „ë¬¸ì ìœ¼ë¡œ ì‘ì„±\n2. ì—…ê³„ ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤ì™€ í”„ë ˆì„ì›Œí¬ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ í™œìš©\n3. ì°¸ê³ í•œ ì†ŒìŠ¤ë‚˜ ë ˆí¼ëŸ°ìŠ¤ê°€ ìˆë‹¤ë©´ ìì—°ìŠ¤ëŸ½ê²Œ ì–¸ê¸‰\n4. ì‹¤ì œ ì‹¤ë¬´ ê²½í—˜ì´ ìˆëŠ” ì „ë¬¸ê°€ì²˜ëŸ¼ êµ¬ì²´ì  ì‚°ì¶œë¬¼ ì‘ì„±\n5. ì´ì „ íŒ€ì› ì‘ì—…ë¬¼ì´ ìˆë‹¤ë©´ ë°˜ë“œì‹œ ë°˜ì˜í•˜ê³  ì‹œë„ˆì§€ë¥¼ ë‚´ì„¸ìš”\n6. ì ˆëŒ€ ëŒ€í‘œë‹˜ì—ê²Œ ì§ì ‘ ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ë¼ê³  í•˜ì§€ ë§ˆì„¸ìš” â€” ë‹¹ì‹ ì´ ì§ì ‘ ì‹¤í–‰í•´ì„œ ê²°ê³¼ë¬¼ì„ ë§Œë“œì„¸ìš”\n7. ì´ë¯¸ì§€/ë””ìì¸ì´ í•„ìš”í•˜ë©´ ì§ì ‘ ìƒì„±í•˜ì„¸ìš” (Midjourney, Gemini Imagen ë“±)\ní•œêµ­ì–´ë¡œ ì‘ì„±.`,
        `ëŒ€í‘œë‹˜ ìš”ì²­: "${userMsg}"\nPM ë°°ì • ì—…ë¬´: ${task}\n${prev?'--- ì´ì „ íŒ€ì› ì‘ì—…ë¬¼ ---\n'+prev:''}`
      );

      // If creative member, generate Midjourney prompt + Gemini Imagen image
      if(isCreative&&keys.gem&&text){
        await new Promise(r=>setTimeout(r,3000));
        showTyp(`ğŸ¨ ${member.name} â†’ Midjourney í”„ë¡¬í”„íŠ¸ ìƒì„± ì¤‘...`);
        mjPrompt=await genMJPrompt(task,text);
        // Also generate actual image with Gemini Imagen (free)
        if(mjPrompt){
          await new Promise(r=>setTimeout(r,3000));
          showTyp(`ğŸ–¼ï¸ ${member.name} â†’ Gemini Imagenìœ¼ë¡œ ì´ë¯¸ì§€ ìƒì„± ì¤‘...`);
          genImage=await generateImage('Generate this image: '+mjPrompt.replace(/--[\w\s:.]+/g,'').trim(),member.name);
        }
      }
    // ì‹¤íŒ¨ ì‹œ ìë™ ì¬ì‹œë„ (1íšŒ, 5ì´ˆ ëŒ€ê¸°)
    if(!text){
      console.log(`[MOTIVE] ${member.name} 1ì°¨ ì‹¤íŒ¨ â†’ 5ì´ˆ í›„ ì¬ì‹œë„...`);
      showTyp(`ğŸ”„ ${member.name}(${member.role}) ì¬ì‹œë„ ì¤‘...`);
      await new Promise(r=>setTimeout(r,5000));
      text=await callAI(member,
        `${member.prompt}\nì „ë¬¸ê°€ë¡œì„œ êµ¬ì²´ì  ì‚°ì¶œë¬¼ì„ ì§ì ‘ ì‘ì„±í•˜ì„¸ìš”. ëŒ€í‘œë‹˜ì—ê²Œ í•˜ë¼ê³  í•˜ì§€ ë§ê³  ë³¸ì¸ì´ ì§ì ‘ í•˜ì„¸ìš”. í•œêµ­ì–´.`,
        `ëŒ€í‘œë‹˜ ìš”ì²­: "${userMsg}"\nPM ë°°ì • ì—…ë¬´: ${task}\n${prev?'--- ì´ì „ íŒ€ì› ì‘ì—…ë¬¼ ---\n'+prev:''}`
      );
    }
    if(!text){
      text=`âš ï¸ **${member.name}(${member.role}) ì‘ì—… ì‹¤íŒ¨**\n\n2íšŒ ì‹œë„í–ˆìœ¼ë‚˜ ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\në‹¤ë¥¸ íŒ€ì› ì‘ì—…ì€ ê³„ì† ì§„í–‰ë©ë‹ˆë‹¤.\n\nğŸ’¡ ì ì‹œ í›„ ì´ ì±„ë„ì—ì„œ ${member.name}ì—ê²Œ ì§ì ‘ ë‹¤ì‹œ ìš”ì²­í•´ë³´ì„¸ìš”.`;
    }

    hideTyp();
    outputs[mid]={text,mjPrompt,genImage,failed:!text||text.startsWith('âš ï¸')};
    addM(ch,mid,text,'work',genImage,mjPrompt);rMsgs();
  }

  // PHASE 3: íŒ€ì› ê°„ í† ë¡  â€” ìƒí˜¸ ì§ˆë¬¸/í”¼ë“œë°±/ë…¼ìŸ
  if(order.length>=2){
    addM(ch,'pm','ğŸ’¬ **íŒ€ì› ê°„ í† ë¡  ì‹œì‘** â€” ê°ì ë‹¤ë¥¸ íŒ€ì› ì‘ì—…ë¬¼ì„ ê²€í† í•˜ê³  í”¼ë“œë°±í•©ë‹ˆë‹¤...','sys');rMsgs();
    const discussions=[];
    // ë¼ìš´ë“œ1: ê° íŒ€ì›ì´ ë‹¤ë¥¸ íŒ€ì› ì‘ì—…ë¬¼ ê²€í† 
    for(let di=0;di<Math.min(order.length,4);di++){
      const mid=order[di];const rev=gm(mid);if(!rev||outputs[mid]?.failed)continue;
      await new Promise(r=>setTimeout(r,5000));
      showTyp(`ğŸ’¬ ${rev.name}(${rev.role}) ê²€í†  ì¤‘...`);
      const others=Object.entries(outputs).filter(([k])=>k!==mid&&!outputs[k]?.failed).map(([k,w])=>`[${gm(k).name}/${gm(k).role}]: ${w.text?.slice(0,400)||''}`).join('\n\n');
      const fb=await callAI(rev,`${rev.prompt}\në‹¤ë¥¸ íŒ€ì›ë“¤ì˜ ì‘ì—…ë¬¼ì„ ì „ë¬¸ê°€ ê´€ì ì—ì„œ ì†”ì§í•˜ê²Œ ê²€í† í•˜ì„¸ìš”. ì¢‹ì€ì , ë³´ì™„ì , ë‹¤ë¥¸ ì˜ê²¬ì„ ì œì‹œí•˜ì„¸ìš”. ì§ˆë¬¸ì´ ìˆë‹¤ë©´ "[ì´ë¦„]ì—ê²Œ: ì§ˆë¬¸" í˜•ì‹ìœ¼ë¡œ. 3~5ë¬¸ì¥. í•œêµ­ì–´.`,`ë‚´ ì‘ì—…ìš”ì•½: ${outputs[mid]?.text?.slice(0,200)||''}\n--- ë‹¤ë¥¸ íŒ€ì› ì‘ì—…ë¬¼ ---\n${others}`);
      if(fb){discussions.push({mid,text:fb});addM(ch,mid,fb,'review');rMsgs()}
    }
    hideTyp();
    // ë¼ìš´ë“œ2: í”¼ë“œë°±ì— ëŒ€í•œ ì‘ë‹µ (ìµœëŒ€ 3ëª…)
    if(discussions.length>=2){
      for(let di=0;di<Math.min(3,order.length);di++){
        const mid=order[di];const rev=gm(mid);if(!rev||outputs[mid]?.failed)continue;
        const feedbacks=discussions.filter(d=>d.mid!==mid).map(d=>`[${gm(d.mid).name}]: ${d.text}`).join('\n');
        if(!feedbacks)continue;
        await new Promise(r=>setTimeout(r,5000));
        showTyp(`ğŸ’¬ ${rev.name}(${rev.role}) ì‘ë‹µ ì¤‘...`);
        const resp=await callAI(rev,`${rev.prompt}\në™ë£Œ í”¼ë“œë°±ì— ì „ë¬¸ê°€ë¡œì„œ ì‘ë‹µí•˜ì„¸ìš”. ìˆ˜ìš©í•  ë¶€ë¶„ì€ ì¸ì •í•˜ê³ , ë°˜ëŒ€ ì˜ê²¬ì€ ê·¼ê±°ë¥¼ ë“¤ì–´ ë°˜ë°•í•˜ì„¸ìš”. 2~3ë¬¸ì¥. í•œêµ­ì–´.`,`ë‚´ ì‘ì—…: ${outputs[mid]?.text?.slice(0,200)||''}\n--- ë™ë£Œ í”¼ë“œë°± ---\n${feedbacks}`);
        if(resp){addM(ch,mid,resp,'review');rMsgs()}
      }
      hideTyp();
    }
  }

  // PHASE 4: PM summary
  await new Promise(r=>setTimeout(r,3000));
  showTyp('ğŸ“‹ PM ìµœì¢… ì¢…í•©...');
  let summary=null;
    const all=Object.entries(outputs).map(([k,w])=>`[${gm(k).name}/${gm(k).role}/${gm(k).aiLabel}]\n${w.text||''}`).join('\n\n---\n\n');
    const failedMembers=Object.entries(outputs).filter(([k,w])=>w.failed).map(([k])=>{const m=gm(k);return`${m.name}(${m.role})`});
    const failNote=failedMembers.length?`\n\nâš ï¸ ì‹¤íŒ¨í•œ íŒ€ì›: ${failedMembers.join(', ')} â€” í•´ë‹¹ ë¶€ë¶„ì€ ë³´ì™„ì´ í•„ìš”í•©ë‹ˆë‹¤.`:'';
    summary=await callAI(gm('pm'),`ë‹¹ì‹ ì€ PM í•˜ì¤€ì…ë‹ˆë‹¤. íŒ€ì› ì‘ì—…ë¬¼ì„ ì¢…í•©í•˜ì—¬ ìµœì¢… ë³´ê³ í•˜ì„¸ìš”.\n1. í”„ë¡œì íŠ¸ ìš”ì•½\n2. ê° íŒ€ì› í•µì‹¬ ì‚°ì¶œë¬¼ (ì‹¤íŒ¨í•œ íŒ€ì›ì´ ìˆë‹¤ë©´ ë³´ì™„ ë°©ì•ˆ ì œì‹œ)\n3. ì¢…í•© ì‹¤í–‰ ê³„íš(íƒ€ì„ë¼ì¸)\n4. ë‹¤ìŒ ë‹¨ê³„${failNote}\ní•œêµ­ì–´ë¡œ êµ¬ì²´ì ìœ¼ë¡œ.`,`ëŒ€í‘œë‹˜ ìš”ì²­: "${userMsg}"\n\n${all}`,'pmfinal');
  if(!summary)summary=`ğŸ“‹ **ì¢…í•©**\n\n${plan.team.map(id=>{const m=gm(id);return`âœ… ${m.name}(${m.role}/${m.aiLabel}): ì™„ë£Œ`}).join('\n')}\n\nAPI í‚¤ë¥¼ ì„¤ì •í•˜ë©´ êµ¬ì²´ì  ì‹¤í–‰ ê³„íšì´ ì œì‹œë©ë‹ˆë‹¤.`;
  hideTyp();addM(ch,'pm',summary,'summary');rMsgs();

 }catch(e){hideTyp();addM(ch,'pm',`âš ï¸ í”„ë¡œì íŠ¸ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${e.message}\n\në‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`,'sys');rMsgs();}
 isGen=false;rSB();
}

/* Direct 1:1 */
async function runDirect(userMsg){
  isGen=true;const m=gm(curCh);
  if(!keys.relay&&!keys.gem&&!keys.oai&&!keys.cla){toast('ì„¤ì •ì—ì„œ API í‚¤ ë˜ëŠ” ë¦´ë ˆì´ë¥¼ ì„¤ì •í•˜ì„¸ìš”');isGen=false;return}
 try{
  showTyp(`${m.name} â†’ ${m.aiLabel} ë‹µë³€ ì¤‘...`);
  let resp=await callAI(m,`${m.prompt}\n\n[ì „ë¬¸ê°€ ì›ì¹™] ë‹¹ì‹ ì€ ì´ ë¶„ì•¼ ìµœê³  ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë‹µë³€ ì‹œ:\n- ìµœì‹  íŠ¸ë Œë“œì™€ ì—…ê³„ ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ ë°˜ì˜\n- í•„ìš”í•˜ë©´ ê´€ë ¨ ì°¸ê³  ì‚¬ì´íŠ¸ë‚˜ ë„êµ¬ë¥¼ ì¶”ì²œ\n- ì‹¤ë¬´ ê²½í—˜ ê¸°ë°˜ì˜ êµ¬ì²´ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ë‹µë³€\nì‚¬ìš©ìëŠ” ì±„í¬ì›… ëŒ€í‘œë‹˜. í•œêµ­ì–´.`,userMsg);
  let mjPrompt=null;let genImage=null;
  if(!resp){
    const downList=[];Object.entries(apiFailCount).forEach(([k,v])=>{if(v>0){const names={gemPro:'Pro 2.5',gemFlash:'Flash 2.5',gemLite:'Lite 2.5',gem2F:'Flash 2.0',oai:'GPT',cla:'Claude'};downList.push(names[k]||k)}});
    resp=`âš ï¸ ì‘ë‹µ ì‹¤íŒ¨. ${downList.length?'ì‹¤íŒ¨: '+downList.join(', ')+'. ':''}F12â†’Consoleì—ì„œ [MOTIVE] ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.`}
  // Creative 1:1 â†’ Midjourney prompt + Gemini Imagen (only for visual/design requests)
  const isCreativeReq=['design','video','photo'].includes(curCh)&&keys.gem&&/ë””ìì¸|ì´ë¯¸ì§€|ë¡œê³ |ë¸Œëœë“œ|ë¹„ì£¼ì–¼|í¬ìŠ¤í„°|ë°°ë„ˆ|ì¼ëŸ¬ìŠ¤íŠ¸|ìºë¦­í„°|ì‚¬ì§„|ì´¬ì˜|ì˜ìƒ|ìŠ¤í† ë¦¬ë³´ë“œ|ì»¨ì…‰|ì•„íŠ¸|ê·¸ë¦¼|ìƒì„±|ë§Œë“¤|ì œì‘|create|image|design|logo|visual|poster|photo/i.test(userMsg);
  if(isCreativeReq){
    showTyp(`ğŸ¨ ${m.name} â†’ Midjourney í”„ë¡¬í”„íŠ¸ ìƒì„± ì¤‘...`);
    mjPrompt=await genMJPrompt(userMsg,resp);
    if(mjPrompt){
      showTyp(`ğŸ–¼ï¸ ${m.name} â†’ Gemini Imagenìœ¼ë¡œ ì´ë¯¸ì§€ ìƒì„± ì¤‘...`);
      genImage=await generateImage('Generate this image: '+mjPrompt.replace(/--[\w\s:.]+/g,'').trim(),m.name);
    }
  }
  hideTyp();addM(curCh,curCh,resp,null,genImage,mjPrompt);rMsgs();
 }catch(e){hideTyp();addM(curCh,curCh,'âš ï¸ ì˜¤ë¥˜: '+e.message);rMsgs();}
 isGen=false;
}

/* Helpers */
function addM(ch,mid,content,type,imageUrl,mjPrompt){if(!chatDB[ch])chatDB[ch]=[];
  const m=gm(mid);const usedAI=m?._usedAI||m?.aiLabel||null;
  chatDB[ch].push({role:'assistant',mid,content,time:now(),type:type||null,imageUrl:imageUrl||null,mjPrompt:mjPrompt||null,usedAI});
  // Save to localStorage (strip base64 images to prevent 5MB overflow)
  try{const tmp=JSON.parse(JSON.stringify(chatDB));Object.values(tmp).forEach(msgs=>msgs.forEach(m=>{if(m.imageUrl&&m.imageUrl.startsWith('data:'))m.imageUrl='[img-session]'}));sv('v5c',tmp)}catch(e){
    // Fallback: save without images entirely
    try{const tmp2={};Object.entries(chatDB).forEach(([k,v])=>{tmp2[k]=v.map(m=>({...m,imageUrl:m.imageUrl&&m.imageUrl.startsWith('data:')?'[img-session]':m.imageUrl}))});sv('v5c',tmp2)}catch(e2){console.warn('Chat save failed',e2)}
  }
}
function showTyp(t){document.getElementById('typTx').textContent=t;document.getElementById('typInd').style.display='flex';document.getElementById('msgs').scrollTop=9999999}
function hideTyp(){document.getElementById('typInd').style.display='none'}

/* Slash */
function rSlMenu(){document.getElementById('slMenu').innerHTML=[{c:'/ì „ì²´ì˜ê²¬',d:'ì „ì› ì˜ê²¬'},{c:'/ë³´ê³ ',d:'í˜„í™© ë³´ê³ '},{c:'/ë¸Œë ˆì¸ìŠ¤í† ë°',d:'ì•„ì´ë””ì–´'},{c:'/ìš”ì•½',d:'ìš”ì•½'}].map(s=>`<div class="sl-it" onclick="execSl('${s.c}')"><span class="sl-cmd">${s.c}</span><span class="sl-desc">${s.d}</span></div>`).join('')}
function execSl(c){document.getElementById('slMenu').classList.remove('show');document.getElementById('chatInp').value='';handleSl(c)}
function handleSl(c){const cmd=c.split(' ')[0];const map={'/ì „ì²´ì˜ê²¬':'ê° íŒ€ì›ì´ ì „ë¬¸ AIë¥¼ í™œìš©í•´ ì˜ê²¬ì„ ê³µìœ í•´ì¤˜','/ë³´ê³ ':'ì „ì²´ íŒ€ ì—…ë¬´ í˜„í™©ì„ ê°ìì˜ AIë¡œ ë³´ê³ í•´ì¤˜','/ë¸Œë ˆì¸ìŠ¤í† ë°':'ìƒˆë¡œìš´ ì•„ì´ë””ì–´ë¥¼ ì „ì²´ íŒ€ê³¼ ë¸Œë ˆì¸ìŠ¤í† ë° í•´ì¤˜'};
if(map[cmd]){curCh='room';rSB();rChatHd();if(!chatDB.room)chatDB.room=[];chatDB.room.push({role:'user',content:map[cmd],time:now()});sc();rMsgs();runCollab(map[cmd],[]);return}
if(cmd==='/ìš”ì•½'){if(!chatDB[curCh])chatDB[curCh]=[];chatDB[curCh].push({role:'user',content:'/ìš”ì•½',time:now()});addM(curCh,'pm',`ğŸ“Š ëŒ€í™” ${Object.values(chatDB).reduce((a,b)=>a+b.length,0)}ê±´ Â· í• ì¼ ${todoDB.length} Â· í”„ë¡œì íŠ¸ ${projDB.length} Â· ë¬¸ì„œ ${docDB.length}`,'sys');rMsgs()}}

/* Input */
function setupInp(){const inp=document.getElementById('chatInp');inp.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send()}});inp.addEventListener('input',function(){this.style.height='auto';this.style.height=Math.min(this.scrollHeight,100)+'px';const m=document.getElementById('slMenu');if(this.value.startsWith('/')){m.classList.add('show');const f=this.value.toLowerCase();document.querySelectorAll('.sl-it').forEach(i=>{i.style.display=i.querySelector('.sl-cmd').textContent.toLowerCase().includes(f)?'flex':'none'})}else m.classList.remove('show')})}

/* CRUD - Projects, Todo, Finance, Docs, Biz */
let _projFilter='all';
function setFilter(f,btn){_projFilter=f;document.querySelectorAll('.proj-filter-btn').forEach(b=>b.classList.remove('on'));btn.classList.add('on');rProj()}
function openProjM(){
  const grid=document.getElementById('pTeamGrid');
  if(grid)grid.innerHTML=TM.map(m=>`<label class="team-cb-label"><input type="checkbox" class="proj-team-cb" value="${m.id}" style="margin:0"><span style="width:10px;height:10px;border-radius:50%;background:${m.color};display:inline-block;flex-shrink:0"></span>${m.name} <span style="color:var(--tx3);font-size:10px">${m.role}</span></label>`).join('');
  openM('projM');
}
function addProj(){
  const n=document.getElementById('pN').value.trim();if(!n){toast('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');return}
  const team=Array.from(document.querySelectorAll('.proj-team-cb:checked')).map(c=>c.value);
  const desc=document.getElementById('pD').value;
  const phases=(document.getElementById('pPhases').value||'').trim().split('\n').filter(x=>x.trim()).map((name,i)=>({id:'ph'+i,name:name.trim(),status:'todo',deliverable:''}));
  const proj={id:uid(),name:n,desc,status:document.getElementById('pS').value,progress:0,created:dt(),team,phases,deliverables:[]};
  projDB.push(proj);
  spp();rProj();closeM('projM');toast('í”„ë¡œì íŠ¸ ì¶”ê°€!');
  document.getElementById('pN').value='';document.getElementById('pD').value='';document.getElementById('pPhases').value='';
  // ë¦´ë ˆì´ ì—°ê²° + íŒ€ì› ì„ íƒ ì‹œ ììœ¨ì‹¤í–‰ ì‹œì‘
  if(keys.relay&&team.length){
    fetch(keys.relay.replace(/\/$/,'')+'/api/project/start',{
      method:'POST',headers:{'Content-Type':'application/json','Bypass-Tunnel-Reminder':'true'},
      body:JSON.stringify({name:n,request:desc||n,team})
    }).then(r=>r.json()).then(d=>{
      if(d.ok&&d.project){
        proj.autoId=d.project.id;proj.status='progress';spp();rProj();
        toast('âš¡ ììœ¨ì‹¤í–‰ ì‹œì‘: '+d.project.id);
        if(!window._projPollOn){window._projPollOn=true;setInterval(pollActiveProjects,10000)}
      }
    }).catch(()=>{});
  }
}
function rProj(){
  const g=document.getElementById('projG');
  let items=projDB;if(_projFilter!=='all')items=items.filter(p=>p.status===_projFilter);
  const cnt=document.getElementById('projCount');if(cnt)cnt.textContent=projDB.length+'ê°œ';
  if(!items.length){g.innerHTML='<div style="color:var(--tx3);padding:40px;text-align:center;font-size:13px">'+(projDB.length?'í•´ë‹¹ ìƒíƒœ ì—†ìŒ':'<div style="font-size:32px;margin-bottom:12px">ğŸ“</div><div style="font-weight:600;margin-bottom:6px">í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</div><div style="font-size:11px">+ ìƒˆ í”„ë¡œì íŠ¸ ë²„íŠ¼ìœ¼ë¡œ ì‹œì‘í•˜ì„¸ìš”</div>')+'</div>';return}
  g.innerHTML=items.map(p=>{
    const sc=p.status==='progress'?'#1a2400':p.status==='done'?'#0a1a0a':'#1a1a2a';
    const sco=p.status==='progress'?'var(--ac)':p.status==='done'?'var(--grn)':'var(--blu)';
    const isAuto=!!p.autoId;
    const sl=isAuto&&p.autoStatus==='running'?'âš¡ ììœ¨ì‹¤í–‰':p.status==='progress'?'ğŸŸ¡ ì§„í–‰':p.status==='done'?'ğŸŸ¢ ì™„ë£Œ':'ğŸ”µ ê¸°íš';
    const autoStepHtml=isAuto&&p.autoSteps?p.autoSteps.map(s=>{const m=TM.find(t=>t.id===s.id);const icon=s.status==='done'?'âœ…':s.status==='running'?'â³':s.status==='failed'?'âŒ':'â¬œ';return m?`<span title="${m.name}(${m.role})" style="font-size:10px">${icon}${m.name[0]}</span>`:''}).join(' '):'';
    const ceoAlert=p.waitingCeo?`<div style="background:#2a1a00;border:1px solid var(--orn);border-radius:6px;padding:4px 8px;margin:4px 0;font-size:10px;color:var(--orn)">ğŸ“¢ ëŒ€í‘œë‹˜ ë‹µë³€ ëŒ€ê¸°${p.ceoQuestion?' â€” '+esc(p.ceoQuestion.slice(0,40)):''}</div>`:'';
    const teamHtml=(p.team||[]).slice(0,5).map(id=>{const m=TM.find(t=>t.id===id);return m?`<div class="cd-av" style="background:${m.color}" title="${m.name}Â·${m.role}">${m.name[0]}</div>`:''}).join('');
    const phases=p.phases||[];
    const phaseBar=phases.map(ph=>`<div class="cd-phase ${ph.status}" title="${ph.name}"></div>`).join('');
    const donePh=phases.filter(ph=>ph.status==='done').length;
    const dlCnt=(p.deliverables||[]).length;
    return`<div class="cd" onclick="showProjDetail('${p.id}')">
      <div class="cd-top"><span class="cd-badge" style="background:${sc};color:${sco}">${sl}</span><button class="xbtn" onclick="event.stopPropagation();if(confirm('ì‚­ì œ?')){projDB=projDB.filter(x=>x.id!=='${p.id}');spp();rProj()}">âœ•</button></div>
      <div class="cd-title">${esc(p.name)}</div>
      <div class="cd-desc">${esc(p.desc||'')}</div>
      ${autoStepHtml?`<div style="font-size:10px;margin:4px 0;display:flex;gap:4px;flex-wrap:wrap">${autoStepHtml}</div>`:''}
      ${ceoAlert}
      ${phases.length?`<div style="font-size:10px;color:var(--tx3);margin-bottom:4px">${donePh}/${phases.length} ë‹¨ê³„ ì™„ë£Œ</div><div class="cd-phases">${phaseBar}</div>`:''}
      ${teamHtml?`<div class="cd-team">${teamHtml}${(p.team||[]).length>5?`<div style="font-size:9px;color:var(--tx3);margin-left:2px">+${(p.team||[]).length-5}</div>`:''}</div>`:''}
      <div class="cd-bar" style="margin-bottom:4px"><div class="cd-fill" style="width:${p.progress||0}%;background:var(--ac)"></div></div>
      <div class="cd-meta"><span>${p.progress||0}% ì™„ë£Œ</span><span>${dlCnt?dlCnt+'ê°œ ê²°ê³¼ë¬¼ Â· ':''} ${p.created}</span></div>
      <div class="cd-actions" onclick="event.stopPropagation()">
        <button class="btn btn-g" style="font-size:10px;padding:4px 10px;flex:1" onclick="projContinue('${p.id}')">ğŸ’¬ AIíŒ€ì— ì§€ì‹œ</button>
        <button class="btn btn-g" style="font-size:10px;padding:4px 10px" onclick="showProjDetail('${p.id}')">ìƒì„¸</button>
      </div>
    </div>`;
  }).join('');
}
function showProjDetail(id){
  const p=projDB.find(x=>x.id===id);if(!p)return;
  const phases=p.phases||[];const team=p.team||[];const deliverables=p.deliverables||[];
  const phHtml=phases.length?phases.map(ph=>`<div class="proj-detail-phase"><div class="proj-phase-dot ${ph.status}"></div><div style="flex:1"><div style="font-size:12px;font-weight:500">${esc(ph.name)}</div>${ph.deliverable?`<div style="font-size:10px;color:var(--grn);margin-top:2px">âœ“ ${esc(ph.deliverable)}</div>`:''}</div><span style="font-size:10px;color:var(--tx3)">${ph.status==='done'?'âœ… ì™„ë£Œ':ph.status==='progress'?'â³ ì§„í–‰ ì¤‘':'â¬œ ëŒ€ê¸°'}</span></div>`).join(''):'<div style="color:var(--tx3);font-size:12px">ë‹¨ê³„ ì—†ìŒ</div>';
  const tmHtml=team.map(id=>{const m=TM.find(t=>t.id===id);return m?`<div class="proj-team-chip"><div style="width:16px;height:16px;border-radius:50%;background:${m.color};display:inline-flex;align-items:center;justify-content:center;font-size:7px;font-weight:700;color:#0a0a0a">${m.name[0]}</div>${m.name}<span style="font-size:10px;color:var(--tx3)">${m.role}</span></div>`:''}).join('');
  const dlHtml=deliverables.length?deliverables.map(d=>`<div class="di"><div class="di-icon">ğŸ“„</div><div class="di-info"><div class="di-name">${esc(d.name)}</div><div class="di-meta">${esc(d.date||'')}</div></div></div>`).join(''):'<div style="color:var(--tx3);font-size:12px;padding:8px 0">ì•„ì§ ê²°ê³¼ë¬¼ ì—†ìŒ â€” AIíŒ€ì— ì§€ì‹œí•˜ë©´ ìë™ ì €ì¥ë©ë‹ˆë‹¤</div>';
  let mdl=document.getElementById('projDetailM');if(!mdl){mdl=document.createElement('div');mdl.id='projDetailM';mdl.className='modal';document.body.appendChild(mdl)}
  mdl.innerHTML=`<div class="mdl" style="width:640px"><div class="mdl-hd"><div><div class="mdl-title">${esc(p.name)}</div><div style="font-size:11px;color:var(--tx2);margin-top:3px">${esc(p.desc||'ì„¤ëª… ì—†ìŒ')}</div></div><button class="mdl-x" onclick="closeM('projDetailM')">âœ•</button></div><div class="mdl-bd">${phases.length?`<div style="margin-bottom:20px"><div style="font-size:12px;font-weight:600;margin-bottom:8px;color:var(--tx2)">ğŸ“‹ ë‹¨ê³„ë³„ ì§„í–‰</div>${phHtml}</div>`:''}${team.length?`<div style="margin-bottom:20px"><div style="font-size:12px;font-weight:600;margin-bottom:6px;color:var(--tx2)">ğŸ‘¥ ë‹´ë‹¹ íŒ€ì›</div><div class="proj-team-chips">${tmHtml}</div></div>`:'<div style="margin-bottom:20px;font-size:12px;color:var(--tx3)">ë‹´ë‹¹ íŒ€ì› ë¯¸ì§€ì •</div>'}<div><div style="font-size:12px;font-weight:600;margin-bottom:8px;color:var(--tx2)">ğŸ“¦ ê²°ê³¼ë¬¼</div>${dlHtml}</div></div><div class="mdl-ft" style="justify-content:space-between"><div style="display:flex;gap:8px;align-items:center"><select class="ms" onchange="projDB.find(x=>x.id==='${p.id}').status=this.value;spp();rProj();toast('ìƒíƒœ ë³€ê²½')"><option value="plan"${p.status==='plan'?' selected':''}>ê¸°íš</option><option value="progress"${p.status==='progress'?' selected':''}>ì§„í–‰</option><option value="done"${p.status==='done'?' selected':''}>ì™„ë£Œ</option></select><input type="number" class="ms" style="width:72px" placeholder="ì§„í–‰%" min="0" max="100" value="${p.progress||0}" onchange="projDB.find(x=>x.id==='${p.id}').progress=Math.min(100,Math.max(0,parseInt(this.value)||0));spp();rProj()"><span style="font-size:10px;color:var(--tx3)">%</span></div><div style="display:flex;gap:8px"><button class="btn btn-g" onclick="closeM('projDetailM')">ë‹«ê¸°</button><button class="btn btn-p" onclick="closeM('projDetailM');projContinue('${p.id}')">ğŸ’¬ AIíŒ€ì— ì´ì–´ì„œ ì§€ì‹œ</button></div></div></div>`;
  openM('projDetailM');
}
function projContinue(id){
  const p=projDB.find(x=>x.id===id);if(!p)return;
  // í”„ë¡œì íŠ¸ ì „ìš© ì±„ë„ë¡œ ì´ë™ (ì—†ìœ¼ë©´ ìƒì„±)
  const projCh='proj-'+p.id;
  if(!chatDB[projCh]){
    chatDB[projCh]=[];
    // ê¸°ì¡´ í”„ë¡œì íŠ¸ ì •ë³´ë¥¼ ì‹œìŠ¤í…œ ë©”ì‹œì§€ë¡œ ì¶”ê°€
    addM(projCh,'pm',`ğŸ“‹ **í”„ë¡œì íŠ¸: ${p.name}**\n\n${p.desc||'ì„¤ëª… ì—†ìŒ'}\n\níŒ€: ${(p.team||[]).map(tid=>{const m=TM.find(t=>t.id===tid);return m?m.name+'('+m.role+')':tid}).join(', ')}\n\nì´ ì±„ë„ì—ì„œ í”„ë¡œì íŠ¸ë¥¼ ì´ì–´ê°‘ë‹ˆë‹¤.`,'sys');
  }
  switchTab('chat');rTabs();selCh(projCh);
  const inp=document.getElementById('chatInp');
  const nextPh=(p.phases||[]).find(ph=>ph.status!=='done');
  inp.value=nextPh?nextPh.name+' ë‹¨ê³„ ì§„í–‰í•´ì¤˜':'ì¶”ê°€ ì§€ì‹œë‚˜ í”¼ë“œë°±ì„ ì…ë ¥í•˜ì„¸ìš”';
  inp.focus();inp.dispatchEvent(new Event('input'));
  toast(`"${p.name}" í”„ë¡œì íŠ¸ ì±„ë„`);
}
async function pollActiveProjects(){
  if(!keys.relay)return;
  try{
    const r=await fetch(keys.relay.replace(/\/$/,'')+'/api/project/active',{headers:{'Bypass-Tunnel-Reminder':'true'}});
    const d=await r.json();if(!d.ok)return;
    let changed=false;
    for(const ap of d.projects){
      const local=projDB.find(p=>p.autoId===ap.id);
      if(!local)continue;
      const doneSteps=ap.steps.filter(s=>s.status==='done').length;
      const totalSteps=ap.steps.length;
      const newProgress=totalSteps?Math.round((doneSteps/totalSteps)*100):0;
      if(ap.status==='done'&&local.status!=='done'){
        local.status='done';local.progress=100;local.autoStatus='done';changed=true;
      }else if(ap.status==='running'){
        if(local.progress!==newProgress){local.progress=newProgress;changed=true}
        local.autoStatus='running';
        local.autoSteps=ap.steps.map(s=>({id:s.memberId,status:s.status}));
        local.waitingCeo=!!ap.waitingCeoInput;
        if(ap.waitingCeoInput)local.ceoQuestion=ap.waitingCeoInput.question;
      }
      if(ap.summary&&!local.autoSummary){local.autoSummary=ap.summary;changed=true}
    }
    if(changed){spp();rProj()}
  }catch(e){}
}
function projAutoSync(){
  if(!keys.relay){toast('ë¦´ë ˆì´ ë¯¸ì—°ê²°');return}
  fetch(keys.relay.replace(/\/$/,'')+'/api/project',{headers:{'Bypass-Tunnel-Reminder':'true'}}).then(r=>r.json()).then(d=>{if(d.ok)toast('ë™ê¸°í™” ì™„ë£Œ');}).catch(()=>toast('ë™ê¸°í™” ì‹¤íŒ¨'));
}
function rTodo(){document.getElementById('todoW').innerHTML=['ëŒ€ê¸°','ì§„í–‰ ì¤‘','ê²€í† ','ì™„ë£Œ'].map((c,i)=>{const items=todoDB.filter(t=>t.col===i);return`<div class="tc" ondragover="event.preventDefault();this.classList.add('dov')" ondragleave="this.classList.remove('dov')" ondrop="drpT(event,${i});this.classList.remove('dov')"><div class="tc-hd"><span>${c}</span><span class="tc-cnt">${items.length}</span></div><div class="tc-list">${items.map(t=>`<div class="ti" draggable="true" ondragstart="event.dataTransfer.setData('text','${t.id}')"><div class="ti-title"><span class="pdot" style="background:${t.priority==='high'?'var(--red)':'var(--orn)'}"></span>${esc(t.title)}</div><div class="ti-meta"><span>${esc(t.assignee||'')}</span><span class="xbtn" onclick="todoDB=todoDB.filter(x=>x.id!=='${t.id}');stt();rTodo()">âœ•</span></div></div>`).join('')}<button class="tc-add" onclick="addTd(${i})">+</button></div></div>`}).join('')}
function addTd(c){const t=prompt('í• ì¼:');if(!t)return;todoDB.push({id:uid(),title:t,col:c,priority:'mid',assignee:prompt('ë‹´ë‹¹ì:')||'',created:dt()});stt();rTodo()}
function drpT(ev,c){ev.preventDefault();const id=ev.dataTransfer.getData('text');const it=todoDB.find(t=>t.id===id);if(it){it.col=c;stt();rTodo()}}
function addTxn(){const n=document.getElementById('tN').value.trim();const a=parseFloat(document.getElementById('tA').value);if(!n||isNaN(a)){toast('ì…ë ¥');return}txDB.unshift({id:uid(),name:n,amount:a,date:dt()});sxx();rFin();closeM('txM');toast('ì¶”ê°€')}
function rFin(){const inc=txDB.filter(t=>t.amount>0).reduce((a,b)=>a+b.amount,0);const exp=txDB.filter(t=>t.amount<0).reduce((a,b)=>a+b.amount,0);const net=inc+exp;document.getElementById('finG').innerHTML=[{l:'ìˆ˜ì…',v:fW(inc),c:'change-up'},{l:'ì§€ì¶œ',v:fW(Math.abs(exp)),c:'change-down'},{l:'ìˆœì´ìµ',v:fW(net),c:net>=0?'change-up':'change-down'},{l:'ê±°ë˜',v:txDB.length+'ê±´',c:''}].map(c=>`<div class="fc"><div class="fc-l">${c.l}</div><div class="fc-v ${c.c}">${c.v}</div></div>`).join('');const fl=document.getElementById('finL');if(!txDB.length){fl.innerHTML='<div style="color:var(--tx3);text-align:center;padding:16px">ì—†ìŒ</div>';return}fl.innerHTML='<div class="dl">'+txDB.slice(0,20).map(t=>`<div class="di"><div class="di-icon">${t.amount>=0?'ğŸ“ˆ':'ğŸ“‰'}</div><div class="di-info"><div class="di-name">${esc(t.name)}</div><div class="di-meta">${t.date}</div></div><span style="font-size:13px;font-weight:600;color:${t.amount>=0?'var(--grn)':'var(--red)'}">${t.amount>=0?'+':''}${fW(t.amount)}</span><button class="xbtn" onclick="txDB=txDB.filter(x=>x.id!=='${t.id}');sxx();rFin()">âœ•</button></div>`).join('')+'</div>'}
function fW(n){const a=Math.abs(n);if(a>=1e8)return(n/1e8).toFixed(1)+'ì–µ';if(a>=1e4)return(n/1e4).toFixed(0)+'ë§Œì›';return n.toLocaleString()+'ì›'}
function addDocI(){const t=document.getElementById('dT').value.trim();if(!t){toast('ì œëª©');return}docDB.unshift({id:uid(),title:t,type:document.getElementById('dTy').value,content:document.getElementById('dC').value,created:dt()});sdd();rDoc();closeM('docM');toast('ì €ì¥')}
function rDoc(){const l=document.getElementById('docL');const ic={'ê¸°íšì„œ':'ğŸ“‹','ê¸°ìˆ ë¬¸ì„œ':'ğŸ”§','ë§ˆì¼€íŒ…':'ğŸ“Š','ì¬ë¬´':'ğŸ’¼','ë²•ë¥ ':'âš–ï¸','ê¸°íƒ€':'ğŸ“„'};if(!docDB.length){l.innerHTML='<div style="color:var(--tx3);text-align:center;padding:16px">ì—†ìŒ</div>';return}l.innerHTML=docDB.map(d=>`<div class="di" onclick="document.getElementById('dvT').textContent='${esc(d.title)}';document.getElementById('dvC').textContent=decodeURIComponent('${encodeURIComponent(d.content||'ë¹„ì–´ìˆìŒ')}');openM('docV')"><div class="di-icon">${ic[d.type]||'ğŸ“„'}</div><div class="di-info"><div class="di-name">${esc(d.title)}</div><div class="di-meta">${d.type}Â·${d.created}</div></div><button class="xbtn" onclick="event.stopPropagation();docDB=docDB.filter(x=>x.id!=='${d.id}');sdd();rDoc()">âœ•</button></div>`).join('')}
function addDealI(){const n=document.getElementById('dlN').value.trim();if(!n){toast('ì´ë¦„');return}dealDB.push({id:uid(),name:n,amount:document.getElementById('dlA').value,stage:document.getElementById('dlS').value,created:dt()});sdl();rBiz();closeM('dealM');toast('ì¶”ê°€')}
function rBiz(){const stages=['ë¦¬ë“œ','ë¯¸íŒ…','ì œì•ˆ','í˜‘ìƒ','ê³„ì•½'];const colors=['var(--blu)','var(--orn)','var(--ac)','#ff6b9d','var(--grn)'];document.getElementById('pipeS').innerHTML=stages.map((s,i)=>`<div class="psi"><div class="psi-n">${s}</div><div class="psi-c" style="color:${colors[i]}">${dealDB.filter(d=>d.stage===s).length}</div></div>`).join('');const dl=document.getElementById('dealL');if(!dealDB.length){dl.innerHTML='<div style="color:var(--tx3);text-align:center;padding:16px">ì—†ìŒ</div>';return}dl.innerHTML=dealDB.map(d=>`<div class="di"><div class="di-icon">ğŸ¤</div><div class="di-info"><div class="di-name">${esc(d.name)}</div><div class="di-meta">${d.amount||'ë¯¸ì •'}Â·${d.created}</div></div><span style="font-size:10px;padding:2px 8px;border-radius:6px;background:var(--bg3);color:var(--tx2)">${d.stage}</span><button class="xbtn" onclick="dealDB=dealDB.filter(x=>x.id!=='${d.id}');sdl();rBiz()">âœ•</button></div>`).join('')}

/* Settings */
function saveKeys(){keys.gem=document.getElementById('kGem').value.trim();keys.oai=document.getElementById('kOai').value.trim();keys.cla=document.getElementById('kCla').value.trim();keys.el=document.getElementById('kEl').value.trim();keys.relay=document.getElementById('kRelay').value.trim();apiFailCount={gemPro:0,gemFlash:0,gemLite:0,gem2F:0,oai:0,cla:0};initGemKeys();sv('v5k',keys);updSt();if(keys.relay)startUsageSync()}
function updSt(){
  const s=(id,has)=>{const el=document.getElementById(id);el.textContent=has?'ì—°ê²°ë¨':'ë¯¸ì„¤ì •';el.style.background=has?'#1a2400':'#1a1a1a';el.style.color=has?'var(--ac)':'var(--tx3)'};
  // Show Gemini key count
  const gemEl=document.getElementById('sGem');
  if(gemKeys.length>1){gemEl.textContent=`í‚¤ ${gemKeys.length}ê°œ`;gemEl.style.background='#1a2400';gemEl.style.color='var(--ac)'}
  else if(gemKeys.length===1){gemEl.textContent='ì—°ê²°ë¨';gemEl.style.background='#1a2400';gemEl.style.color='var(--ac)'}
  else{gemEl.textContent='ë¯¸ì„¤ì •';gemEl.style.background='#1a1a1a';gemEl.style.color='var(--tx3)'}
  s('sOai',keys.oai);s('sCla',keys.cla);s('sEl',keys.el);s('sRelay',keys.relay);
}
async function testAll(){
  toast('ëª¨ë¸ í…ŒìŠ¤íŠ¸ ì¤‘...');initGemKeys();apiFailCount={gemPro:0,gemFlash:0,gemLite:0,gem2F:0,oai:0,cla:0};let results=[];
  // Relay test first
  if(keys.relay){
    const rR=await callRelay('í•œë§ˆë””ë§Œ','OK');
    results.push('ğŸ–¥ï¸ ë¦´ë ˆì´: '+(rR.ok?'âœ… Claude Max ì—°ê²°ë¨':'âŒ '+rR.err));
  }
  results.push('Gemini í‚¤: '+gemKeys.length+'ê°œ');
  if(gemKeys.length){
    const rL=await callGeminiLite('í•œêµ­ì–´ í•œë§ˆë””',[{role:'user',parts:[{text:'OK'}]}]);
    results.push('Lite 2.5: '+(rL.ok?'âœ…':'âŒ '+rL.err));
    await new Promise(r=>setTimeout(r,3000));
    const r2=await callGemini2F('í•œêµ­ì–´ í•œë§ˆë””',[{role:'user',parts:[{text:'OK'}]}]);
    results.push('Flash 2.0: '+(r2.ok?'âœ…':'âŒ '+r2.err));
    await new Promise(r=>setTimeout(r,3000));
    const rF=await callGeminiFlash('í•œêµ­ì–´ í•œë§ˆë””',[{role:'user',parts:[{text:'OK'}]}]);
    results.push('Flash 2.5: '+(rF.ok?'âœ…':'âŒ '+rF.err));
    await new Promise(r=>setTimeout(r,3000));
    const rP=await callGeminiPro('í•œêµ­ì–´ í•œë§ˆë””',[{role:'user',parts:[{text:'OK'}]}]);
    results.push('Pro 2.5: '+(rP.ok?'âœ…':'âŒ '+rP.err));
  }
  if(keys.cla){const r=await callClaude('í•œë§ˆë””ë§Œ','OK');results.push('Claude: '+(r.ok?'âœ…':'âŒ '+r.err))}
  if(keys.oai){const r=await callGPT('í•œë§ˆë””ë§Œ','OK');results.push('GPT: '+(r.ok?'âœ…':'âŒ '+r.err))}
  if(keys.el){try{const r=await fetch('https://api.elevenlabs.io/v1/user',{headers:{'xi-api-key':keys.el}});results.push('TTS: '+(r.ok?'âœ…':'âŒ'))}catch(e){results.push('TTS: âŒ')}}
  const msg=results.join('\n')||'í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”';
  console.log('[MOTIVE] í…ŒìŠ¤íŠ¸ ê²°ê³¼:\n'+msg);
  alert('í…ŒìŠ¤íŠ¸ ê²°ê³¼:\n\n'+msg);
}
function resetAll(){if(!confirm('ì „ì²´ ì‚­ì œ?'))return;['v5c','v5t','v5p','v5x','v5d','v5dl'].forEach(k=>localStorage.removeItem(k));chatDB={};todoDB=[];projDB=[];txDB=[];docDB=[];dealDB=[];rAll();toast('ì´ˆê¸°í™”')}

/* Init */
function rAll(){rTabs();rSB();rChatHd();rMsgs();rProj();rTodo();rFin();rDoc();rBiz()}

/* ì‚¬ìš©ëŸ‰ ìœ„ì ¯ */
let usagePopOpen=false;
function toggleUsagePop(){usagePopOpen=!usagePopOpen;document.getElementById('usagePop').classList.toggle('show',usagePopOpen);if(usagePopOpen)fetchUsage()}
async function fetchUsage(){
  if(!keys.relay){
    document.getElementById('uDot').className='u-dot off';
    document.getElementById('uNum').textContent='--';
    document.getElementById('uToday').textContent='ë¦´ë ˆì´ ë¯¸ì„¤ì •';
    document.getElementById('uTotal').textContent='ì„¤ì • â†’ ë¦´ë ˆì´ URL ì…ë ¥';
    document.getElementById('uLast').textContent='--';
    document.getElementById('uUptime').textContent='--';
    return;
  }
  try{
    const r=await fetch(keys.relay.replace(/\/$/,'')+'/api/usage',{headers:{'Bypass-Tunnel-Reminder':'true','ngrok-skip-browser-warning':'true'}});
    const ct=r.headers.get('content-type')||'';
    if(!ct.includes('json')){document.getElementById('uDot').className='u-dot off';document.getElementById('uNum').textContent='!';return}
    const d=await r.json();
    if(!d.ok)return;
    // í—¤ë” pill â€” ì›”ê°„ ìš”ì²­ í‘œì‹œ
    const mReq=d.month?.requests||d.today.requests;
    document.getElementById('uNum').textContent=mReq;
    document.getElementById('uDot').className='u-dot';
    // í”Œëœ
    document.getElementById('uPlan').textContent=d.plan||'Claude Max';
    // ì›”ê°„ ë°ì´í„°
    document.getElementById('uMonth').textContent=(d.month?.requests||0)+'íšŒ';
    // ì›”ê°„ ê²Œì´ì§€ë°” (Max ê¸°ì¤€ ~ì£¼ 500íšŒ = ì›” ~2,000íšŒë¥¼ ìœ ì—°í•œ ê¸°ì¤€ìœ¼ë¡œ)
    const monthPct=Math.min(100,Math.round((d.month?.requests||0)/2000*100));
    const bar=document.getElementById('uMonthBar');
    bar.style.width=monthPct+'%';
    bar.style.background=monthPct>80?'linear-gradient(90deg,var(--orn),var(--red))':'linear-gradient(90deg,var(--ac),var(--grn))';
    // ë¦¬ì…‹ê¹Œì§€
    document.getElementById('uReset').textContent=(d.month?.daysLeft||0)+'ì¼ ë‚¨ìŒ';
    // ì˜¤ëŠ˜
    document.getElementById('uToday').textContent=d.today.requests+'íšŒ';
    document.getElementById('uTotal').textContent=(d.total||0).toLocaleString();
    document.getElementById('uUptime').textContent=d.uptime||'--';
    // ë§ˆì§€ë§‰ ìš”ì²­ ì‹œê°„
    if(d.lastRequest){
      const t=new Date(d.lastRequest);
      const ago=Math.floor((Date.now()-t)/60000);
      document.getElementById('uLast').textContent=ago<1?'ë°©ê¸ˆ':ago<60?ago+'ë¶„ ì „':Math.floor(ago/60)+'ì‹œê°„ ì „';
    }
    // ì†ŒìŠ¤ë³„ (ì›”ê°„)
    const srcEl=document.getElementById('uSrc');
    const srcMap={'web':'ì›¹','telegram':'í…”ë ˆê·¸ë¨','video':'ì˜ìƒí•™ìŠµ'};
    const bs=d.month?.bySource||d.today.bySource||{};
    srcEl.innerHTML=Object.entries(bs).map(([k,v])=>`<div class="usage-src-tag"><span style="color:var(--tx2)">${srcMap[k]||k}</span> <span style="color:var(--ac)">${v}</span></div>`).join('')||'<span style="font-size:10px;color:var(--tx3)">ì•„ì§ ì—†ìŒ</span>';
    // 7ì¼ ì°¨íŠ¸
    const daily=d.daily||[];
    const chartEl=document.getElementById('uChart');
    const allDays=[...daily,{date:d.today.date,requests:d.today.requests}].slice(-7);
    if(allDays.length){
      const max=Math.max(...allDays.map(x=>x.requests),1);
      chartEl.innerHTML=allDays.map(day=>{
        const h=Math.max(2,Math.round((day.requests/max)*36));
        const label=day.date.slice(5);
        return `<div style="flex:1;text-align:center"><div class="usage-chart-bar" style="height:${h}px" title="${label}: ${day.requests}íšŒ"></div><div style="font-size:8px;color:var(--tx3);margin-top:2px">${label}</div></div>`;
      }).join('');
    }
  }catch(e){
    document.getElementById('uDot').className='u-dot off';
    document.getElementById('uNum').textContent='!';
    document.getElementById('uToday').textContent='ì—°ê²° ì‹¤íŒ¨';
    document.getElementById('uUptime').textContent='--';
    console.error('[MOTIVE] ì‚¬ìš©ëŸ‰ ì¡°íšŒ ì‹¤íŒ¨:',e.message);
  }
}
// 30ì´ˆë§ˆë‹¤ ì‚¬ìš©ëŸ‰ ê°±ì‹ 
let usageTimer=null;
function startUsageSync(){if(usageTimer)clearInterval(usageTimer);fetchUsage();usageTimer=setInterval(fetchUsage,30000);window._usageSyncOn=true}
// íŒì—… ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
document.addEventListener('click',e=>{if(usagePopOpen&&!e.target.closest('.usage-pop')&&!e.target.closest('.usage-pill')){usagePopOpen=false;document.getElementById('usagePop').classList.remove('show')}});

async function autoRelay(){try{const r=await fetch('relay-url.txt?t='+Date.now());if(r.ok){const url=(await r.text()).trim();if(url.startsWith('https://')&&url!==keys.relay){keys.relay=url;sv('v5k',keys);document.getElementById('kRelay').value=url;console.log('[MOTIVE] ë¦´ë ˆì´ ìë™ì—°ê²°:',url);updSt();if(!window._usageSyncOn)startUsageSync()}}}catch(e){}}
function init(){ld();initGemKeys();document.getElementById('kGem').value=keys.gem;document.getElementById('kOai').value=keys.oai;document.getElementById('kCla').value=keys.cla;document.getElementById('kEl').value=keys.el;document.getElementById('kRelay').value=keys.relay||'';updSt();rAll();rSlMenu();setupInp();renderAvGrid();initLazyVids();if(keys.relay){startUsageSync()}autoRelay();if(projDB.some(p=>p.autoId&&p.status!=='done')){window._projPollOn=true;setInterval(pollActiveProjects,10000)}}

/* Lazy video loading */
const vidObserver=new IntersectionObserver((entries)=>{
  entries.forEach(e=>{
    if(e.isIntersecting){
      const vid=e.target;
      if(vid.dataset.src&&!vid.src){vid.src=vid.dataset.src;vid.load()}
      vidObserver.unobserve(vid);
    }
  });
},{rootMargin:'100px'});
function initLazyVids(){document.querySelectorAll('video.av-vid[data-src]').forEach(v=>{if(!v.src||v.src==='')vidObserver.observe(v)})}
// Re-observe after renders
const origRSB=rSB,origRMsgs=rMsgs,origRChatHd=rChatHd;
rSB=function(){origRSB();setTimeout(initLazyVids,50)};
rMsgs=function(){origRMsgs();setTimeout(initLazyVids,50)};
rChatHd=function(){origRChatHd();setTimeout(initLazyVids,50)};
init();
if(isMobile){
  sbCollapsed=true;document.getElementById('sideBar').classList.add('collapsed');
  // iOS í‚¤ë³´ë“œ ëŒ€ì‘: ì…ë ¥ì°½ í¬ì»¤ìŠ¤ ì‹œ ìŠ¤í¬ë¡¤
  const chatInp=document.getElementById('chatInp');
  if(chatInp){
    chatInp.addEventListener('focus',()=>{setTimeout(()=>{chatInp.scrollIntoView({block:'end',behavior:'smooth'})},300)});
    // visualViewport í™œìš© (iOS Safari ì§€ì›)
    if(window.visualViewport){
      window.visualViewport.addEventListener('resize',()=>{
        document.body.style.height=window.visualViewport.height+'px';
      });
      window.visualViewport.addEventListener('scroll',()=>{
        document.body.style.height=window.visualViewport.height+'px';
      });
    }
  }
}
</script>
</body>
</html>
