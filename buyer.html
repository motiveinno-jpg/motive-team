<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Whistle AI â€” Buyer Portal</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root{--bg:#060B18;--bg2:#0A1020;--card:#0D1424;--card2:#111B2E;--sf:#111B2E;--pri:#00D4FF;--pri-g:linear-gradient(135deg,#00D4FF,#0088FF);--pri-d:#0088FF;--pri-glow:0 0 30px rgba(0,212,255,.12);--acc:#FFB800;--acc-g:linear-gradient(135deg,#FFB800,#FF8C00);--ok:#00E676;--err:#FF5252;--warn:#FFA726;--purple:#A855F7;--w:#fff;--w90:rgba(255,255,255,.9);--w70:rgba(255,255,255,.7);--w60:rgba(255,255,255,.6);--w40:rgba(255,255,255,.4);--w20:rgba(255,255,255,.2);--w12:rgba(255,255,255,.1);--w08:rgba(255,255,255,.06);--bd:rgba(255,255,255,.08);--bd-l:rgba(255,255,255,.15);--r:14px;--r-s:10px;--r-xs:6px;--shadow:0 4px 24px rgba(0,0,0,.4);--shadow-lg:0 12px 48px rgba(0,0,0,.6)}
*{box-sizing:border-box;margin:0;padding:0}html{scroll-behavior:smooth}
body{background:var(--bg);font-family:'Sora',-apple-system,sans-serif;color:var(--w);line-height:1.5;overflow:hidden;height:100vh}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:var(--bg2)}::-webkit-scrollbar-thumb{background:var(--w12);border-radius:3px}::selection{background:rgba(0,212,255,.3)}
input:focus,textarea:focus,select:focus{outline:none;border-color:var(--pri)!important;box-shadow:0 0 0 3px rgba(0,212,255,.1)}
select option{background:var(--card);color:var(--w90)}textarea{resize:vertical;min-height:60px}a{color:var(--pri);text-decoration:none}
.app-layout{display:flex;height:100vh;overflow:hidden}
.sidebar{width:240px;background:var(--bg2);border-right:1px solid var(--bd);display:flex;flex-direction:column;flex-shrink:0;overflow-y:auto}
.sidebar-header{padding:16px;border-bottom:1px solid var(--bd);display:flex;align-items:center;gap:10px}
.sidebar-logo{width:32px;height:32px;border-radius:9px;background:var(--pri-g);display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:900;color:var(--bg);flex-shrink:0}
.sidebar-title{font-size:15px;font-weight:800;letter-spacing:-.5px}
.sidebar-sub{font-size:10px;color:var(--w40);font-family:'JetBrains Mono'}
.sidebar-nav{flex:1;padding:8px;overflow-y:auto}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:var(--r-s);font-size:13px;font-weight:500;color:var(--w60);cursor:pointer;transition:all .15s;border:1px solid transparent;margin-bottom:2px}
.nav-item:hover{background:var(--w08);color:var(--w90)}
.nav-item.active{background:rgba(0,212,255,.08);color:var(--pri);border-color:rgba(0,212,255,.15);font-weight:600}
.nav-item .icon{font-size:16px;width:20px;text-align:center}
.nav-item .badge-count{margin-left:auto;font-size:10px;background:var(--err);color:var(--w);padding:1px 6px;border-radius:10px;font-weight:700}
.nav-section{height:1px;background:var(--bd);margin:8px 12px}
.sidebar-footer{padding:12px;border-top:1px solid var(--bd)}
.main-area{flex:1;display:flex;flex-direction:column;overflow:hidden}
.topbar{height:52px;background:rgba(6,11,24,.9);backdrop-filter:blur(12px);border-bottom:1px solid var(--bd);display:flex;align-items:center;justify-content:space-between;padding:0 24px;flex-shrink:0}
.topbar-title{font-size:15px;font-weight:700}
.page-content{flex:1;overflow-y:auto;padding:24px}
.card{background:var(--card);border-radius:var(--r);border:1px solid var(--bd);overflow:hidden;margin-bottom:16px}
.card-h{padding:14px 18px;border-bottom:1px solid var(--bd);display:flex;align-items:center;justify-content:space-between;font-weight:700;font-size:14px}
.card-b{padding:18px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:9px 18px;border-radius:var(--r-s);font-size:13px;font-weight:600;font-family:inherit;cursor:pointer;border:none;transition:all .15s;white-space:nowrap}
.btn:hover{filter:brightness(1.1);transform:translateY(-1px)}.btn:active{transform:translateY(0)}.btn:disabled{opacity:.5;cursor:not-allowed}
.btn-pri{background:var(--pri-g);color:var(--bg);box-shadow:var(--pri-glow)}.btn-acc{background:var(--acc-g);color:var(--bg)}
.btn-ok{background:var(--ok);color:var(--bg)}.btn-ghost{background:transparent;color:var(--w);border:1.5px solid var(--bd-l)}
.btn-ghost:hover{border-color:var(--w40)}.btn-danger{background:rgba(255,82,82,.15);color:var(--err);border:1px solid rgba(255,82,82,.2)}
.btn-sm{padding:5px 12px;font-size:12px;border-radius:var(--r-xs)}.btn-lg{padding:12px 24px;font-size:14px}.btn-block{width:100%}
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:var(--r-xs);font-size:11px;font-weight:600;font-family:'JetBrains Mono',monospace}
.badge-pri{background:rgba(0,212,255,.1);color:var(--pri);border:1px solid rgba(0,212,255,.2)}
.badge-acc{background:rgba(255,184,0,.1);color:var(--acc);border:1px solid rgba(255,184,0,.2)}
.badge-ok{background:rgba(0,230,118,.1);color:var(--ok);border:1px solid rgba(0,230,118,.2)}
.badge-err{background:rgba(255,82,82,.1);color:var(--err);border:1px solid rgba(255,82,82,.2)}
.badge-purple{background:rgba(168,85,247,.1);color:var(--purple);border:1px solid rgba(168,85,247,.2)}
.badge-ghost{background:var(--w08);color:var(--w40);border:1px solid var(--bd)}
.form-group{margin-bottom:14px}
.form-label{display:block;font-size:12px;font-weight:600;color:var(--w40);margin-bottom:6px}
.form-input,.form-select,.form-textarea{width:100%;padding:11px 14px;border-radius:var(--r-s);border:1.5px solid var(--bd);background:var(--sf);color:var(--w90);font-size:14px;font-family:inherit}
.form-input::placeholder,.form-textarea::placeholder{color:var(--w20)}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
.grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
@media(max-width:900px){.grid-3,.grid-4{grid-template-columns:1fr 1fr}}
@media(max-width:600px){.grid-2,.grid-3,.grid-4{grid-template-columns:1fr}.sidebar{display:none}.mob-menu{display:flex!important}}
.stat-card{padding:18px;border-radius:var(--r);background:var(--card);border:1px solid var(--bd);text-align:center}
.stat-val{font-size:28px;font-weight:800;margin-bottom:4px}
.stat-label{font-size:11px;color:var(--w40);text-transform:uppercase;letter-spacing:.5px}
.toast{position:fixed;bottom:20px;right:20px;padding:12px 20px;border-radius:var(--r-s);font-size:13px;font-weight:600;z-index:9999;animation:slideUp .3s}
.toast-ok{background:var(--ok);color:#000}.toast-err{background:var(--err);color:#fff}.toast-warn{background:var(--acc);color:#000}
@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
.auth-wrap{display:flex;align-items:center;justify-content:center;height:100vh;background:var(--bg)}
.auth-card{width:420px;max-width:90vw;background:var(--card);border:1px solid var(--bd);border-radius:var(--r);padding:36px;box-shadow:var(--shadow-lg)}
.auth-logo{display:flex;align-items:center;gap:12px;margin-bottom:24px;justify-content:center}
.auth-logo-icon{width:48px;height:48px;border-radius:14px;background:var(--pri-g);display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:900;color:var(--bg)}
.auth-title{font-size:22px;font-weight:900;letter-spacing:-.5px}
.auth-sub{font-size:11px;color:var(--acc);font-weight:600}
.auth-tabs{display:flex;gap:0;margin-bottom:20px;border-radius:var(--r-s);overflow:hidden;border:1px solid var(--bd)}
.auth-tab{flex:1;text-align:center;padding:10px;font-size:13px;font-weight:600;color:var(--w40);cursor:pointer;background:transparent;transition:all .15s}
.auth-tab.active{background:rgba(0,212,255,.1);color:var(--pri)}
.auth-error{background:rgba(255,82,82,.1);color:var(--err);padding:10px 14px;border-radius:var(--r-xs);font-size:12px;margin-bottom:14px}
.product-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
.product-card{padding:16px;border-radius:var(--r);background:var(--sf);border:1px solid var(--bd);transition:all .2s}
.product-card:hover{border-color:var(--pri);transform:translateY(-2px);box-shadow:var(--shadow)}
.product-img{width:100%;height:160px;object-fit:cover;border-radius:var(--r-xs);margin-bottom:10px;background:var(--w08)}
.product-img-placeholder{width:100%;height:160px;border-radius:var(--r-xs);background:var(--w08);display:flex;align-items:center;justify-content:center;font-size:36px;margin-bottom:10px}
.source-tab{display:flex;gap:0;border-radius:var(--r-s);overflow:hidden;border:1px solid var(--bd);margin-bottom:16px}
.source-tab-item{flex:1;text-align:center;padding:10px 16px;font-size:13px;font-weight:600;color:var(--w40);cursor:pointer;transition:all .15s;border-right:1px solid var(--bd)}
.source-tab-item:last-child{border-right:none}
.source-tab-item.active{background:rgba(0,212,255,.08);color:var(--pri)}
.source-tab-item:hover:not(.active){background:var(--w08);color:var(--w90)}
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);z-index:1000;display:flex;align-items:center;justify-content:center}
.modal{width:560px;max-width:92vw;max-height:85vh;overflow-y:auto;background:var(--card);border:1px solid var(--bd);border-radius:var(--r);box-shadow:var(--shadow-lg)}
.modal-h{padding:16px 20px;border-bottom:1px solid var(--bd);display:flex;align-items:center;justify-content:space-between;font-weight:700;font-size:15px}
.modal-close{width:30px;height:30px;border-radius:8px;background:var(--w08);border:none;color:var(--w60);cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center}
.modal-close:hover{background:var(--err);color:var(--w)}
.modal-b{padding:20px}
.inquiry-type-card{padding:16px;border-radius:var(--r-s);border:2px solid var(--bd);cursor:pointer;transition:all .15s;margin-bottom:10px}
.inquiry-type-card:hover{border-color:var(--w40)}
.inquiry-type-card.selected{border-color:var(--pri);background:rgba(0,212,255,.05)}
.mob-menu{display:none;position:fixed;top:12px;left:12px;z-index:500;width:36px;height:36px;border-radius:10px;background:var(--card);border:1px solid var(--bd);align-items:center;justify-content:center;cursor:pointer;font-size:18px}
.origin-badge{display:inline-flex;align-items:center;gap:3px;padding:2px 8px;border-radius:var(--r-xs);font-size:10px;font-weight:700}
.origin-verified{background:rgba(0,230,118,.12);color:var(--ok)}
.origin-likely{background:rgba(255,184,0,.12);color:var(--acc)}
.origin-unknown{background:var(--w08);color:var(--w40)}
.filter-row{display:flex;gap:10px;align-items:center;margin-bottom:16px;flex-wrap:wrap}
.search-box{flex:1;min-width:200px;display:flex;gap:8px}
.search-box input{flex:1}
.inquiry-list-item{padding:14px 18px;border-bottom:1px solid var(--w08);display:flex;align-items:center;gap:14px;cursor:pointer;transition:background .15s}
.inquiry-list-item:hover{background:var(--w08)}
.inquiry-list-item:last-child{border-bottom:none}
</style>
</head>
<body>
<div id="root"></div>
<script>
(function(){
'use strict';
var SB_URL='https://lylktgxngrlxmsldxdqj.supabase.co';
var SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx5bGt0Z3huZ3JseG1zbGR4ZHFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4MTQ2OTAsImV4cCI6MjA4NzM5MDY5MH0.8kgcDCMBT_STf43MVkeUUiq-K6r-Ytp3nUQ6d-nL2D0';
var RELAY='http://localhost:3456';
var sb=window.supabase.createClient(SB_URL,SB_KEY);

/* === STATE === */
var S={
  loading:true,page:'dashboard',user:null,authMode:'login',authError:'',
  // search
  searchQuery:'',searchSource:'all',searchResults:[],naverResults:[],whistleResults:[],searching:false,
  // data
  inquiries:[],savedProducts:[],
  // modal
  modal:null,modalData:null,
  // inquiry form
  inquiryType:'import'
};

function set(obj){for(var k in obj)S[k]=obj[k];render();}

/* === TOAST === */
function toast(msg,type){
  var t=document.createElement('div');t.className='toast toast-'+(type||'ok');t.textContent=msg;
  document.body.appendChild(t);setTimeout(function(){t.remove();},3000);
}

/* === RENDER === */
function render(){
  var root=document.getElementById('root');
  if(S.loading){root.innerHTML='<div class="auth-wrap"><div style="text-align:center"><div style="font-size:36px;margin-bottom:12px">W</div><div style="color:var(--w40)">Loading...</div></div></div>';return;}
  if(!S.user){root.innerHTML=pgAuth();return;}
  root.innerHTML='<div class="app-layout">'+renderSidebar()+'<div class="main-area">'+renderTopbar()+'<div class="page-content" id="pageContent">'+renderPage()+'</div></div></div>'+(S.modal?renderModal():'');
}

function renderPage(){
  switch(S.page){
    case'search':return pgSearch();
    case'inquiries':return pgInquiries();
    case'saved':return pgSaved();
    case'profile':return pgProfile();
    default:return pgDash();
  }
}

/* === SIDEBAR === */
function renderSidebar(){
  var items=[
    {id:'dashboard',icon:'&#x1F4CA;',label:'Dashboard'},
    {id:'search',icon:'&#x1F50D;',label:'Product Search'},
    {id:'inquiries',icon:'&#x1F4CB;',label:'My Inquiries',count:S.inquiries.filter(function(i){return i.status==='pending'||i.status==='in_progress';}).length},
    {id:'saved',icon:'&#x1F4BE;',label:'Saved Products',count:S.savedProducts.length},
    {id:'profile',icon:'&#x1F464;',label:'Profile'}
  ];
  var h='<div class="sidebar"><div class="sidebar-header"><div class="sidebar-logo">W</div><div><div class="sidebar-title">Whistle AI</div><div class="sidebar-sub">BUYER PORTAL</div></div></div><div class="sidebar-nav">';
  items.forEach(function(it){
    h+='<div class="nav-item'+(S.page===it.id?' active':'')+'" onclick="B.nav(\''+it.id+'\')"><span class="icon">'+it.icon+'</span><span>'+it.label+'</span>'+(it.count?'<span class="badge-count">'+it.count+'</span>':'')+'</div>';
  });
  h+='<div class="nav-section"></div>';
  h+='<div class="nav-item" onclick="B.doLogout()"><span class="icon">&#x1F6AA;</span><span>Logout</span></div>';
  h+='</div><div class="sidebar-footer"><div style="font-size:11px;color:var(--w20)">'+esc(S.user.company_name||S.user.email)+'</div></div></div>';
  return h;
}

function renderTopbar(){
  var titles={dashboard:'Dashboard',search:'Product Search',inquiries:'My Inquiries',saved:'Saved Products',profile:'Profile & Settings'};
  return '<div class="topbar"><div class="topbar-title">'+(titles[S.page]||'Dashboard')+'</div><div style="display:flex;align-items:center;gap:10px"><span style="font-size:12px;color:var(--w40)">'+esc(S.user.display_name||S.user.email)+'</span></div></div>';
}

/* === AUTH PAGE === */
function pgAuth(){
  var isL=S.authMode==='login';
  var h='<div class="auth-wrap"><div class="auth-card"><div class="auth-logo"><div class="auth-logo-icon">W</div><div><div class="auth-title">Whistle AI</div><div class="auth-sub">BUYER PORTAL</div></div></div>';
  h+='<div class="auth-tabs"><div class="auth-tab'+(isL?' active':'')+'" onclick="B.set({authMode:\'login\',authError:\'\'})">Sign In</div><div class="auth-tab'+(!isL?' active':'')+'" onclick="B.set({authMode:\'signup\',authError:\'\'})">Sign Up</div></div>';
  if(S.authError)h+='<div class="auth-error">'+esc(S.authError)+'</div>';
  if(S.authMode==='reset'){
    h+='<form onsubmit="event.preventDefault();B.doReset(this)"><div class="form-group"><label class="form-label">Email</label><input class="form-input" name="email" type="email" placeholder="your@email.com" required></div><button class="btn btn-pri btn-block btn-lg" type="submit">Send Reset Link</button><div style="text-align:center;margin-top:12px"><a href="#" onclick="event.preventDefault();B.set({authMode:\'login\',authError:\'\'})">Back to Sign In</a></div></form>';
  } else if(isL){
    h+='<form onsubmit="event.preventDefault();B.doLogin(this)"><div class="form-group"><label class="form-label">Email</label><input class="form-input" name="email" type="email" placeholder="your@email.com" required></div><div class="form-group"><label class="form-label">Password</label><input class="form-input" name="password" type="password" placeholder="Password" required></div><button class="btn btn-pri btn-block btn-lg" type="submit" style="margin-top:4px">Sign In</button><div style="text-align:center;margin-top:12px;font-size:12px"><a href="#" onclick="event.preventDefault();B.set({authMode:\'reset\',authError:\'\'})">Forgot password?</a></div></form>';
  } else {
    h+='<form onsubmit="event.preventDefault();B.doSignup(this)"><div class="grid-2"><div class="form-group"><label class="form-label">Company Name *</label><input class="form-input" name="company_name" placeholder="Your Company Inc." required></div><div class="form-group"><label class="form-label">Contact Name *</label><input class="form-input" name="display_name" placeholder="Full name" required></div></div><div class="form-group"><label class="form-label">Email *</label><input class="form-input" name="email" type="email" placeholder="your@email.com" required></div><div class="form-group"><label class="form-label">Password *</label><input class="form-input" name="password" type="password" placeholder="Min 6 characters" required></div><div class="grid-2"><div class="form-group"><label class="form-label">Country</label><select class="form-select" name="country"><option value="">Select</option><option value="CN">China</option><option value="US">United States</option><option value="JP">Japan</option><option value="HK">Hong Kong</option><option value="VN">Vietnam</option><option value="RU">Russia</option><option value="TW">Taiwan</option><option value="TH">Thailand</option><option value="AE">UAE</option><option value="SG">Singapore</option></select></div><div class="form-group"><label class="form-label">Interest</label><select class="form-select" name="interest"><option value="">Select</option><option value="skincare">K-Beauty / Skincare</option><option value="cosmetics">Color Cosmetics</option><option value="haircare">Hair Care</option><option value="supplement">Health Supplements</option><option value="food">Food & Beverage</option><option value="general">General Products</option></select></div></div><button class="btn btn-pri btn-block btn-lg" type="submit" style="margin-top:4px">Create Account</button></form>';
  }
  h+='<div style="text-align:center;margin-top:20px;font-size:11px;color:var(--w20)">Source premium Korean products with AI</div></div></div>';
  return h;
}

/* === AUTH ACTIONS === */
function doLogin(f){
  set({authError:''});
  sb.auth.signInWithPassword({email:f.email.value,password:f.password.value}).then(function(r){
    if(r.error)return set({authError:r.error.message==='Invalid login credentials'?'Invalid email or password':r.error.message});
    loadUser();
  });
}
function doSignup(f){
  if(f.password.value.length<6)return set({authError:'Password must be at least 6 characters'});
  set({authError:''});
  sb.auth.signUp({email:f.email.value,password:f.password.value,options:{data:{role:'buyer',company_name:f.company_name.value,display_name:f.display_name.value}}}).then(function(r){
    if(r.error)return set({authError:r.error.message.includes('already registered')?'Email already registered':r.error.message});
    // Also upsert into users table
    var uid=r.data&&r.data.user?r.data.user.id:null;
    if(uid){
      sb.from('users').upsert({id:uid,email:f.email.value,role:'buyer',company_name:f.company_name.value,display_name:f.display_name.value,country:f.country.value},{onConflict:'id'}).then(function(){});
    }
    toast('Account created! Please check your email to verify, then sign in.','ok');
    set({authMode:'login'});
  });
}
function doReset(f){
  sb.auth.resetPasswordForEmail(f.email.value).then(function(r){
    if(r.error)return set({authError:r.error.message});
    toast('Reset link sent to your email','ok');
    set({authMode:'login'});
  });
}
function doLogout(){
  if(confirm('Sign out?')){sb.auth.signOut().then(function(){S.user=null;render();});}
}

/* === LOAD USER === */
function loadUser(){
  set({loading:true});
  sb.auth.getSession().then(function(r){
    var session=r.data.session;
    if(!session)return set({loading:false,user:null});
    sb.from('users').select('*').eq('id',session.user.id).single().then(function(r){
      if(r.error||!r.data){
        // User exists in auth but not users table - create entry
        var meta=session.user.user_metadata||{};
        sb.from('users').upsert({id:session.user.id,email:session.user.email,role:'buyer',company_name:meta.company_name||'',display_name:meta.display_name||''},{onConflict:'id'}).then(function(ur){
          S.user=ur.data&&ur.data[0]?ur.data[0]:{id:session.user.id,email:session.user.email,role:'buyer'};
          S.loading=false;
          loadAllData();
        });
        return;
      }
      if(r.data.role!=='buyer'&&r.data.role!=='admin'){sb.auth.signOut();return set({loading:false,user:null,authError:'This portal is for buyers only. Please use the appropriate portal.'});}
      S.user=r.data;S.loading=false;
      loadAllData();
    });
  });
}

function loadAllData(){
  loadInquiries();
  loadSavedProducts();
  render();
}

function loadInquiries(){
  if(!S.user)return;
  sb.from('contact_requests').select('*').eq('buyer_id',S.user.id).order('created_at',{ascending:false}).then(function(r){
    S.inquiries=r.data||[];render();
  });
}

function loadSavedProducts(){
  if(!S.user)return;
  sb.from('buyer_saved_products').select('*').eq('user_id',S.user.id).order('created_at',{ascending:false}).then(function(r){
    S.savedProducts=r.data||[];render();
  });
}

/* === DASHBOARD === */
function pgDash(){
  var u=S.user;
  var pending=S.inquiries.filter(function(i){return i.status==='pending';}).length;
  var inProg=S.inquiries.filter(function(i){return i.status==='in_progress';}).length;
  var h='<div style="margin-bottom:24px"><h2 style="font-size:22px;font-weight:800;margin-bottom:4px">Welcome, '+esc(u.display_name||u.company_name||'Buyer')+'</h2><p style="font-size:13px;color:var(--w40)">Source premium Korean products with Whistle AI</p></div>';

  // Stats
  h+='<div class="grid-4" style="margin-bottom:24px">';
  h+='<div class="stat-card"><div class="stat-val" style="color:var(--pri)">'+S.inquiries.length+'</div><div class="stat-label">Total Inquiries</div></div>';
  h+='<div class="stat-card"><div class="stat-val" style="color:var(--acc)">'+(pending+inProg)+'</div><div class="stat-label">In Progress</div></div>';
  h+='<div class="stat-card"><div class="stat-val" style="color:var(--ok)">'+S.savedProducts.length+'</div><div class="stat-label">Saved Products</div></div>';
  h+='<div class="stat-card"><div class="stat-val" style="color:var(--purple)">'+esc(u.country||'--')+'</div><div class="stat-label">Market</div></div>';
  h+='</div>';

  // Quick actions
  h+='<div class="card"><div class="card-h">Quick Actions</div><div class="card-b"><div class="grid-3">';
  h+='<div style="text-align:center;padding:20px;border-radius:var(--r-s);background:var(--w08);cursor:pointer" onclick="B.nav(\'search\')"><div style="font-size:28px;margin-bottom:8px">&#x1F50D;</div><div style="font-weight:700;font-size:13px">Search Products</div><div style="font-size:11px;color:var(--w40);margin-top:4px">Browse Korean products & manufacturers</div></div>';
  h+='<div style="text-align:center;padding:20px;border-radius:var(--r-s);background:var(--w08);cursor:pointer" onclick="B.openCustomSourcing()"><div style="font-size:28px;margin-bottom:8px">&#x1F4E6;</div><div style="font-weight:700;font-size:13px">Custom Sourcing</div><div style="font-size:11px;color:var(--w40);margin-top:4px">Tell us what you need</div></div>';
  h+='<div style="text-align:center;padding:20px;border-radius:var(--r-s);background:var(--w08);cursor:pointer" onclick="B.nav(\'inquiries\')"><div style="font-size:28px;margin-bottom:8px">&#x1F4CB;</div><div style="font-weight:700;font-size:13px">My Inquiries</div><div style="font-size:11px;color:var(--w40);margin-top:4px">Track your requests</div></div>';
  h+='</div></div></div>';

  // Recent inquiries
  if(S.inquiries.length){
    h+='<div class="card"><div class="card-h">Recent Inquiries</div><div>';
    S.inquiries.slice(0,5).forEach(function(inq){
      var st=inq.status||'pending';
      var stCls=st==='completed'?'badge-ok':st==='in_progress'?'badge-acc':'badge-ghost';
      h+='<div class="inquiry-list-item" onclick="B.showInquiryDetail(\''+inq.id+'\')">';
      h+='<div style="flex:1"><div style="font-weight:600;font-size:13px">'+esc(inq.product_query||inq.inquiry_type||'Inquiry')+'</div><div style="font-size:11px;color:var(--w40)">'+formatDate(inq.created_at)+'</div></div>';
      h+='<span class="badge '+stCls+'">'+st.replace('_',' ')+'</span>';
      h+='</div>';
    });
    h+='</div></div>';
  }

  return h;
}

/* === PRODUCT SEARCH === */
function pgSearch(){
  var h='';

  // Search bar
  h+='<div class="filter-row"><div class="search-box"><input class="form-input" id="searchInput" placeholder="Search Korean products... (e.g., snail cream, sheet mask, red ginseng)" value="'+esc(S.searchQuery)+'" onkeydown="if(event.key===\'Enter\')B.doSearch()"></div><button class="btn btn-pri" onclick="B.doSearch()">Search</button></div>';

  // Source tabs
  h+='<div class="source-tab">';
  h+='<div class="source-tab-item'+(S.searchSource==='all'?' active':'')+'" onclick="B.setSource(\'all\')">All Results</div>';
  h+='<div class="source-tab-item'+(S.searchSource==='whistle'?' active':'')+'" onclick="B.setSource(\'whistle\')">&#x1F3C5; Whistle Verified</div>';
  h+='<div class="source-tab-item'+(S.searchSource==='naver'?' active':'')+'" onclick="B.setSource(\'naver\')">&#x1F1F0;&#x1F1F7; Korea Market</div>';
  h+='</div>';

  if(S.searching){
    h+='<div style="text-align:center;padding:40px;color:var(--w40)"><div style="font-size:28px;margin-bottom:8px">&#x1F50D;</div>Searching...</div>';
    return h;
  }

  // No search yet
  if(!S.searchQuery&&!S.whistleResults.length&&!S.naverResults.length){
    h+='<div style="text-align:center;padding:60px 20px"><div style="font-size:48px;margin-bottom:16px">&#x1F50D;</div><h3 style="font-size:18px;font-weight:700;margin-bottom:8px">Search Korean Products</h3><p style="font-size:13px;color:var(--w40);max-width:400px;margin:0 auto 20px">Search from verified Whistle products and the entire Korean e-commerce market powered by Naver Shopping API.</p>';
    h+='<div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap">';
    ['Snail Cream','Sheet Mask','Red Ginseng','Sunscreen SPF50','Vitamin C Serum','Rice Water','Green Tea'].forEach(function(kw){
      h+='<button class="btn btn-ghost btn-sm" onclick="B.quickSearch(\''+kw+'\')">'+kw+'</button>';
    });
    h+='</div></div>';

    // Show Whistle products by default
    h+='<div style="margin-top:24px"><div style="font-weight:700;font-size:14px;margin-bottom:12px">&#x1F3C5; Featured Whistle Verified Products</div>';
    h+=renderWhistleProducts(S.whistleResults.length?S.whistleResults:[]);
    h+='</div>';
    if(!S.whistleResults.length)loadWhistleProducts('');
    return h;
  }

  // Results
  var products=[];
  if(S.searchSource==='all'){products=mergeResults();}
  else if(S.searchSource==='whistle'){products=S.whistleResults.map(function(p){return{source:'whistle',data:p};});}
  else{products=S.naverResults.map(function(p){return{source:'naver',data:p};});}

  if(!products.length){
    h+='<div style="text-align:center;padding:40px;color:var(--w40)"><div style="font-size:28px;margin-bottom:8px">&#x1F4ED;</div>No products found for "'+esc(S.searchQuery)+'"</div>';
    return h;
  }

  h+='<div style="font-size:12px;color:var(--w40);margin-bottom:12px">'+products.length+' products found for "'+esc(S.searchQuery)+'"</div>';
  h+='<div class="product-grid">';
  products.forEach(function(item){
    h+=renderProductCard(item.source,item.data);
  });
  h+='</div>';
  return h;
}

function mergeResults(){
  var all=[];
  S.whistleResults.forEach(function(p){all.push({source:'whistle',data:p});});
  S.naverResults.forEach(function(p){all.push({source:'naver',data:p});});
  return all;
}

function renderWhistleProducts(products){
  if(!products.length)return '<div style="text-align:center;padding:30px;color:var(--w40);font-size:13px">Loading products...</div>';
  var h='<div class="product-grid">';
  products.forEach(function(p){h+=renderProductCard('whistle',p);});
  h+='</div>';
  return h;
}

function renderProductCard(source,p){
  var h='<div class="product-card">';
  // Image
  if(source==='whistle'){
    var img=p.images&&p.images[0];
    h+=img?'<img class="product-img" src="'+esc(img)+'" onerror="this.style.display=\'none\'">':'<div class="product-img-placeholder">&#x1F4E6;</div>';
  } else {
    h+=p.image?'<img class="product-img" src="'+esc(p.image)+'" onerror="this.style.display=\'none\'">':'<div class="product-img-placeholder">&#x1F6CD;</div>';
  }
  // Source badge
  if(source==='whistle'){
    h+='<div style="margin-bottom:8px"><span class="badge badge-pri">&#x1F3C5; Whistle Verified</span></div>';
  } else {
    h+='<div style="margin-bottom:8px;display:flex;gap:6px;flex-wrap:wrap"><span class="badge badge-acc">&#x1F1F0;&#x1F1F7; Korea Market</span>';
    if(p.origin==='verified')h+='<span class="origin-badge origin-verified">&#x2705; Made in Korea</span>';
    else if(p.origin==='likely_korean')h+='<span class="origin-badge origin-likely">&#x26A0;&#xFE0F; Korean Brand</span>';
    else h+='<span class="origin-badge origin-unknown">&#x2753; Unverified</span>';
    h+='</div>';
  }
  // Name
  if(source==='whistle'){
    h+='<div style="font-weight:700;font-size:14px;margin-bottom:4px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden">'+esc(p.name_en||p.name_ko||'Product')+'</div>';
    h+='<div style="font-size:11px;color:var(--w40);margin-bottom:8px">'+esc(p.category||'')+(p.hs_code?' | HS '+esc(p.hs_code):'')+'</div>';
  } else {
    h+='<div style="font-weight:700;font-size:14px;margin-bottom:4px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden">'+esc(p.title||'Product')+'</div>';
    h+='<div style="font-size:11px;color:var(--w40);margin-bottom:8px">'+esc(p.category1||'')+(p.category2?' > '+esc(p.category2):'')+(p.mallName?' | '+esc(p.mallName):'')+'</div>';
  }
  // Price
  if(source==='whistle'){
    h+='<div style="margin-bottom:8px">'+(p.fob_price?'<span style="font-weight:800;color:var(--acc)">$'+p.fob_price+'</span><span style="font-size:10px;color:var(--w40)"> FOB/unit</span>':'<span style="font-size:12px;color:var(--w40)">Price on request</span>');
    if(p.moq)h+=' <span style="font-size:10px;color:var(--w40);margin-left:8px">MOQ: '+p.moq+'</span>';
    h+='</div>';
  } else {
    var priceKRW=parseInt(p.lprice)||0;
    h+='<div style="margin-bottom:8px"><span style="font-weight:800;color:var(--acc)">'+priceKRW.toLocaleString()+'</span><span style="font-size:10px;color:var(--w40)"> KRW (retail)</span>';
    if(p.hprice&&parseInt(p.hprice)>priceKRW)h+='<span style="font-size:10px;color:var(--w20);margin-left:4px">~'+parseInt(p.hprice).toLocaleString()+'</span>';
    h+='</div>';
  }
  // Certifications (whistle only)
  if(source==='whistle'&&p.certifications&&p.certifications.length){
    h+='<div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:8px">';
    p.certifications.slice(0,3).forEach(function(c){h+='<span class="badge badge-ok">'+esc(c.name||c)+'</span>';});
    h+='</div>';
  }
  // Maker/Brand (naver)
  if(source==='naver'&&(p.maker||p.brand)){
    h+='<div style="font-size:11px;color:var(--w40);margin-bottom:8px">'+(p.maker?'Maker: '+esc(p.maker):'')+(p.brand?(p.maker?' | ':'')+'Brand: '+esc(p.brand):'')+'</div>';
  }
  // Action buttons
  h+='<div style="display:flex;gap:6px">';
  if(source==='whistle'){
    h+='<button class="btn btn-pri btn-sm" style="flex:1" onclick="event.stopPropagation();B.openInquiry(\'whistle\',\''+p.id+'\')">Inquire</button>';
    h+='<button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();B.saveProduct(\'whistle\',\''+p.id+'\')">&#x1F4BE;</button>';
  } else {
    h+='<button class="btn btn-acc btn-sm" style="flex:1" onclick="event.stopPropagation();B.openInquiry(\'naver\',\''+esc(p.productId||'')+'\')">Factory Contact</button>';
    h+='<button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();B.saveProduct(\'naver\',\''+esc(p.productId||'')+'\')">&#x1F4BE;</button>';
  }
  h+='</div></div>';
  return h;
}

/* === SEARCH === */
function doSearch(){
  var q=document.getElementById('searchInput');
  if(!q)return;
  var query=q.value.trim();
  if(!query)return;
  S.searchQuery=query;S.searching=true;render();
  // Search both sources in parallel
  var done=0,total=2;
  function checkDone(){done++;if(done>=total){S.searching=false;render();}}
  loadWhistleProducts(query,checkDone);
  loadNaverProducts(query,checkDone);
}

function quickSearch(kw){
  S.searchQuery=kw;
  render();
  setTimeout(function(){
    var inp=document.getElementById('searchInput');
    if(inp)inp.value=kw;
    doSearch();
  },50);
}

function setSource(src){set({searchSource:src});}

function loadWhistleProducts(query,cb){
  var q=sb.from('products').select('*').eq('is_public',true).eq('status','active');
  if(query)q=q.or('name_en.ilike.%'+query+'%,name_ko.ilike.%'+query+'%,category.ilike.%'+query+'%,description_en.ilike.%'+query+'%');
  q.order('created_at',{ascending:false}).limit(40).then(function(r){
    S.whistleResults=r.data||[];
    if(cb)cb();else render();
  });
}

function loadNaverProducts(query,cb){
  fetch(RELAY+'/api/naver/search?q='+encodeURIComponent(query)+'&display=40').then(function(r){return r.json();}).then(function(data){
    if(data.ok&&data.items){S.naverResults=data.items;}
    else{S.naverResults=[];}
    if(cb)cb();else render();
  }).catch(function(){S.naverResults=[];if(cb)cb();else render();});
}

/* === INQUIRY SYSTEM === */
function openInquiry(source,id){
  var product=null;
  if(source==='whistle'){
    product=S.whistleResults.find(function(p){return p.id===id;})||S.savedProducts.find(function(sp){return sp.product_id===id;});
  } else {
    product=S.naverResults.find(function(p){return(p.productId||'')==id;});
    if(!product){
      var sp=S.savedProducts.find(function(sp){return sp.naver_product_data&&(sp.naver_product_data.productId||'')==id;});
      if(sp)product=sp.naver_product_data;
    }
  }
  S.modal='inquiry';S.modalData={source:source,product:product,id:id};S.inquiryType='import';render();
}

function openCustomSourcing(){
  S.modal='inquiry';S.modalData={source:'custom',product:null,id:null};S.inquiryType='custom_sourcing';render();
}

function renderModal(){
  if(S.modal==='inquiry')return renderInquiryModal();
  if(S.modal==='inquiryDetail')return renderInquiryDetailModal();
  return '';
}

function renderInquiryModal(){
  var d=S.modalData||{};
  var p=d.product;
  var h='<div class="modal-overlay" onclick="B.closeModal()"><div class="modal" onclick="event.stopPropagation()">';
  h+='<div class="modal-h"><span>Submit Inquiry</span><button class="modal-close" onclick="B.closeModal()">&#x2715;</button></div>';
  h+='<div class="modal-b">';

  // Product preview
  if(p){
    h+='<div style="display:flex;gap:12px;padding:12px;border-radius:var(--r-s);background:var(--w08);margin-bottom:16px">';
    var img=d.source==='whistle'?(p.images&&p.images[0]):p.image;
    h+=img?'<img src="'+esc(img)+'" style="width:60px;height:60px;object-fit:cover;border-radius:8px">':'<div style="width:60px;height:60px;border-radius:8px;background:var(--w08);display:flex;align-items:center;justify-content:center">&#x1F4E6;</div>';
    h+='<div style="flex:1"><div style="font-weight:700;font-size:13px">'+esc(d.source==='whistle'?(p.name_en||p.name_ko):(p.title||'Product'))+'</div>';
    if(d.source==='whistle'){h+='<div style="font-size:11px;color:var(--w40)"><span class="badge badge-pri" style="font-size:9px">Whistle Verified</span></div>';}
    else{h+='<div style="font-size:11px;color:var(--w40)"><span class="badge badge-acc" style="font-size:9px">Korea Market</span></div>';}
    h+='</div></div>';
  }

  // Inquiry type selection
  h+='<div style="font-weight:600;font-size:13px;margin-bottom:10px">How can we help?</div>';

  var types=[
    {id:'import',icon:'&#x1F6A2;',title:'Import This Product',desc:'Import the product as-is to your country'},
    {id:'factory_contact',icon:'&#x1F3ED;',title:'Connect with Factory',desc:'OEM/ODM partnership or direct factory contact ($200~700)'},
    {id:'custom_sourcing',icon:'&#x1F50D;',title:'Custom Sourcing',desc:'Find products matching your specific requirements'}
  ];
  types.forEach(function(t){
    h+='<div class="inquiry-type-card'+(S.inquiryType===t.id?' selected':'')+'" onclick="B.set({inquiryType:\''+t.id+'\'})">';
    h+='<div style="display:flex;align-items:center;gap:10px"><span style="font-size:20px">'+t.icon+'</span><div><div style="font-weight:700;font-size:13px">'+t.title+'</div><div style="font-size:11px;color:var(--w40)">'+t.desc+'</div></div></div></div>';
  });

  // Form
  h+='<form onsubmit="event.preventDefault();B.submitInquiry(this)" style="margin-top:16px">';
  h+='<input type="hidden" name="inquiry_type" value="'+S.inquiryType+'">';

  if(S.inquiryType==='import'){
    h+='<div class="grid-2"><div class="form-group"><label class="form-label">Quantity (units) *</label><input class="form-input" name="quantity" type="number" placeholder="e.g., 1000" required></div><div class="form-group"><label class="form-label">Destination Country</label><input class="form-input" name="destination" value="'+esc(S.user.country||'')+'" placeholder="e.g., US"></div></div>';
    h+='<div class="form-group"><label class="form-label">Target Price (USD/unit)</label><input class="form-input" name="target_price" placeholder="e.g., $3-5"></div>';
  } else if(S.inquiryType==='factory_contact'){
    h+='<div class="form-group"><label class="form-label">Purpose</label><select class="form-select" name="purpose"><option value="OEM">OEM (My brand, their product)</option><option value="ODM">ODM (Custom formulation)</option><option value="Direct">Direct purchase from factory</option></select></div>';
    h+='<div class="grid-2"><div class="form-group"><label class="form-label">Quantity</label><input class="form-input" name="quantity" type="number" placeholder="e.g., 5000"></div><div class="form-group"><label class="form-label">Destination</label><input class="form-input" name="destination" value="'+esc(S.user.country||'')+'" placeholder="e.g., US"></div></div>';
    h+='<div class="form-group"><label class="form-label">Specifications</label><textarea class="form-textarea" name="specs" placeholder="Packaging, labeling, ingredients requirements..."></textarea></div>';
  } else {
    h+='<div class="form-group"><label class="form-label">What are you looking for? *</label><textarea class="form-textarea" name="requirements" required placeholder="Describe the type of product, target market, any specific requirements..."></textarea></div>';
    h+='<div class="grid-2"><div class="form-group"><label class="form-label">Budget Range</label><input class="form-input" name="budget" placeholder="e.g., $5,000-10,000"></div><div class="form-group"><label class="form-label">Timeline</label><select class="form-select" name="timeline"><option value="1month">Within 1 month</option><option value="3months">Within 3 months</option><option value="6months">Within 6 months</option><option value="flexible">Flexible</option></select></div></div>';
    h+='<div class="form-group"><label class="form-label">Destination Country</label><input class="form-input" name="destination" value="'+esc(S.user.country||'')+'" placeholder="e.g., US"></div>';
  }

  h+='<div class="form-group"><label class="form-label">Additional Message</label><textarea class="form-textarea" name="message" placeholder="Any additional details or questions..."></textarea></div>';
  h+='<button class="btn btn-pri btn-block btn-lg" type="submit">Submit Inquiry</button>';
  h+='</form></div></div></div>';
  return h;
}

function submitInquiry(f){
  var d=S.modalData||{};
  var p=d.product;
  var fd=new FormData(f);
  var data={};fd.forEach(function(v,k){data[k]=v;});

  var req={
    buyer_id:S.user.id,
    inquiry_type:data.inquiry_type||'import',
    destination_country:data.destination||S.user.country||'',
    target_moq:parseInt(data.quantity)||null,
    target_price:data.target_price||data.budget||null,
    status:'pending'
  };

  // Build message
  var msg='';
  if(data.purpose)msg+='Purpose: '+data.purpose+'\n';
  if(data.specs)msg+='Specs: '+data.specs+'\n';
  if(data.requirements)msg+='Requirements: '+data.requirements+'\n';
  if(data.timeline)msg+='Timeline: '+data.timeline+'\n';
  if(data.message)msg+=(msg?'\n':'')+data.message;
  req.message=msg;

  // Product info
  if(d.source==='whistle'&&p){
    req.product_id=p.id;
    req.product_query=(p.name_en||p.name_ko||'')+(p.category?' ('+p.category+')':'');
  } else if(d.source==='naver'&&p){
    req.naver_product_data=p;
    req.product_query=p.title||'Naver product';
  } else {
    req.product_query=data.requirements||'Custom sourcing request';
  }

  sb.from('contact_requests').insert(req).then(function(r){
    if(r.error){toast('Failed to submit: '+r.error.message,'err');return;}
    // Also notify via relay server
    fetch(RELAY+'/api/naver/contact-request',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
      buyer_name:S.user.display_name,buyer_email:S.user.email,buyer_company:S.user.company_name,
      inquiry_type:data.inquiry_type,product_name:req.product_query,message:msg,
      destination_country:req.destination_country,target_moq:req.target_moq,target_price:req.target_price
    })}).catch(function(){});
    toast('Inquiry submitted successfully!','ok');
    S.modal=null;S.modalData=null;
    loadInquiries();
  });
}

function closeModal(){S.modal=null;S.modalData=null;render();}

/* === SAVE PRODUCT === */
function saveProduct(source,id){
  if(!S.user){toast('Please sign in','err');return;}
  var rec={user_id:S.user.id,source:source};
  if(source==='whistle'){
    rec.product_id=id;
  } else {
    var p=S.naverResults.find(function(x){return(x.productId||'')==id;});
    rec.naver_product_data=p||{productId:id};
  }
  sb.from('buyer_saved_products').insert(rec).then(function(r){
    if(r.error){
      if(r.error.message&&r.error.message.includes('duplicate'))toast('Already saved','warn');
      else toast('Failed to save','err');
      return;
    }
    toast('Product saved!','ok');
    loadSavedProducts();
  });
}

function unsaveProduct(saveId){
  sb.from('buyer_saved_products').delete().eq('id',saveId).then(function(r){
    if(r.error){toast('Failed to remove','err');return;}
    toast('Removed from saved','ok');
    loadSavedProducts();
  });
}

/* === MY INQUIRIES === */
function pgInquiries(){
  var h='';
  var statuses=['all','pending','in_progress','completed'];
  h+='<div style="display:flex;gap:8px;margin-bottom:16px">';
  statuses.forEach(function(st){
    var cnt=st==='all'?S.inquiries.length:S.inquiries.filter(function(i){return i.status===st;}).length;
    var active=(!S._inqFilter&&st==='all')||(S._inqFilter===st);
    h+='<button class="btn btn-sm '+(active?'btn-pri':'btn-ghost')+'" onclick="B._inqFilter=\''+st+'\';B.render()">'+st.replace('_',' ')+' ('+cnt+')</button>';
  });
  h+='</div>';

  var list=S.inquiries;
  if(S._inqFilter&&S._inqFilter!=='all')list=list.filter(function(i){return i.status===S._inqFilter;});

  if(!list.length){
    h+='<div style="text-align:center;padding:40px;color:var(--w40)"><div style="font-size:28px;margin-bottom:8px">&#x1F4CB;</div>No inquiries'+(S._inqFilter&&S._inqFilter!=='all'?' with status "'+S._inqFilter+'"':'')+'<br><button class="btn btn-pri" style="margin-top:12px" onclick="B.nav(\'search\')">Search Products</button></div>';
    return h;
  }

  h+='<div class="card"><div>';
  list.forEach(function(inq){
    var st=inq.status||'pending';
    var stCls=st==='completed'?'badge-ok':st==='in_progress'?'badge-acc':st==='cancelled'?'badge-err':'badge-ghost';
    var typeLbl=inq.inquiry_type==='factory_contact'?'&#x1F3ED; Factory Contact':inq.inquiry_type==='custom_sourcing'?'&#x1F50D; Custom Sourcing':'&#x1F6A2; Import';
    h+='<div class="inquiry-list-item" onclick="B.showInquiryDetail(\''+inq.id+'\')">';
    h+='<div style="flex:1"><div style="font-weight:600;font-size:13px">'+esc(inq.product_query||'Inquiry')+'</div>';
    h+='<div style="font-size:11px;color:var(--w40);margin-top:2px">'+typeLbl+' &middot; '+formatDate(inq.created_at)+'</div></div>';
    h+='<span class="badge '+stCls+'">'+st.replace('_',' ')+'</span>';
    h+='</div>';
  });
  h+='</div></div>';
  return h;
}

function showInquiryDetail(id){
  var inq=S.inquiries.find(function(i){return i.id===id;});
  if(!inq)return;
  S.modal='inquiryDetail';S.modalData=inq;render();
}

function renderInquiryDetailModal(){
  var inq=S.modalData;
  if(!inq)return '';
  var st=inq.status||'pending';
  var stCls=st==='completed'?'badge-ok':st==='in_progress'?'badge-acc':st==='cancelled'?'badge-err':'badge-ghost';
  var typeLbl=inq.inquiry_type==='factory_contact'?'Factory Contact':inq.inquiry_type==='custom_sourcing'?'Custom Sourcing':'Import';

  var h='<div class="modal-overlay" onclick="B.closeModal()"><div class="modal" onclick="event.stopPropagation()">';
  h+='<div class="modal-h"><span>Inquiry Details</span><button class="modal-close" onclick="B.closeModal()">&#x2715;</button></div>';
  h+='<div class="modal-b">';

  h+='<div style="display:flex;align-items:center;gap:10px;margin-bottom:16px"><span class="badge '+stCls+'" style="font-size:12px">'+st.replace('_',' ')+'</span><span class="badge badge-purple">'+typeLbl+'</span></div>';
  h+='<div class="form-group"><div class="form-label">Product</div><div style="font-size:14px;font-weight:600">'+esc(inq.product_query||'N/A')+'</div></div>';
  if(inq.destination_country)h+='<div class="form-group"><div class="form-label">Destination</div><div>'+esc(inq.destination_country)+'</div></div>';
  if(inq.target_moq)h+='<div class="form-group"><div class="form-label">Target MOQ</div><div>'+inq.target_moq+' units</div></div>';
  if(inq.target_price)h+='<div class="form-group"><div class="form-label">Target Price</div><div>'+esc(inq.target_price)+'</div></div>';
  if(inq.message)h+='<div class="form-group"><div class="form-label">Message</div><div style="white-space:pre-wrap;font-size:13px;color:var(--w70)">'+esc(inq.message)+'</div></div>';
  h+='<div class="form-group"><div class="form-label">Submitted</div><div style="font-size:13px;color:var(--w40)">'+formatDate(inq.created_at)+'</div></div>';

  // Naver product data
  if(inq.naver_product_data){
    var np=inq.naver_product_data;
    h+='<div style="margin-top:12px;padding:12px;border-radius:var(--r-s);background:var(--w08)"><div style="font-size:11px;color:var(--acc);font-weight:600;margin-bottom:8px">Korea Market Product</div>';
    if(np.image)h+='<img src="'+esc(np.image)+'" style="width:80px;height:80px;object-fit:cover;border-radius:8px;margin-bottom:8px">';
    h+='<div style="font-size:13px;font-weight:600">'+esc(np.title||'')+'</div>';
    if(np.maker)h+='<div style="font-size:11px;color:var(--w40)">Maker: '+esc(np.maker)+'</div>';
    if(np.brand)h+='<div style="font-size:11px;color:var(--w40)">Brand: '+esc(np.brand)+'</div>';
    if(np.lprice)h+='<div style="font-size:11px;color:var(--w40)">Price: '+parseInt(np.lprice).toLocaleString()+' KRW</div>';
    h+='</div>';
  }

  h+='<div style="margin-top:16px;padding:14px;border-radius:var(--r-s);background:rgba(0,212,255,.05);border:1px solid rgba(0,212,255,.1)"><div style="font-size:12px;color:var(--pri);font-weight:600">What happens next?</div><div style="font-size:12px;color:var(--w60);margin-top:4px">';
  if(st==='pending')h+='Our team is reviewing your inquiry. We\'ll contact you within 24 hours.';
  else if(st==='in_progress')h+='We are actively working on your request. You\'ll receive updates via email.';
  else if(st==='completed')h+='This inquiry has been completed. Thank you for using Whistle AI!';
  else h+='This inquiry has been cancelled.';
  h+='</div></div>';

  h+='</div></div></div>';
  return h;
}

/* === SAVED PRODUCTS === */
function pgSaved(){
  if(!S.savedProducts.length){
    return '<div style="text-align:center;padding:60px 20px;color:var(--w40)"><div style="font-size:36px;margin-bottom:12px">&#x1F4BE;</div><h3 style="font-weight:700;margin-bottom:8px">No Saved Products</h3><p style="font-size:13px">Save products while browsing to compare them later.</p><button class="btn btn-pri" style="margin-top:12px" onclick="B.nav(\'search\')">Browse Products</button></div>';
  }

  var h='<div style="font-size:12px;color:var(--w40);margin-bottom:12px">'+S.savedProducts.length+' saved product(s)</div>';
  h+='<div class="product-grid">';
  S.savedProducts.forEach(function(sp){
    h+='<div class="product-card">';
    if(sp.source==='naver'&&sp.naver_product_data){
      var np=sp.naver_product_data;
      h+=np.image?'<img class="product-img" src="'+esc(np.image)+'" onerror="this.style.display=\'none\'">':'<div class="product-img-placeholder">&#x1F6CD;</div>';
      h+='<div style="margin-bottom:6px"><span class="badge badge-acc">&#x1F1F0;&#x1F1F7; Korea Market</span></div>';
      h+='<div style="font-weight:700;font-size:14px;margin-bottom:4px">'+esc(np.title||'Product')+'</div>';
      if(np.lprice)h+='<div style="margin-bottom:8px"><span style="font-weight:800;color:var(--acc)">'+parseInt(np.lprice).toLocaleString()+'</span><span style="font-size:10px;color:var(--w40)"> KRW</span></div>';
      h+='<div style="display:flex;gap:6px"><button class="btn btn-acc btn-sm" style="flex:1" onclick="B.openInquiry(\'naver\',\''+(np.productId||'')+'\')">Inquire</button><button class="btn btn-danger btn-sm" onclick="B.unsaveProduct(\''+sp.id+'\')">&#x1F5D1;</button></div>';
    } else {
      // Whistle product - would need to load from products table
      h+='<div class="product-img-placeholder">&#x1F4E6;</div>';
      h+='<div style="margin-bottom:6px"><span class="badge badge-pri">&#x1F3C5; Whistle Verified</span></div>';
      h+='<div style="font-weight:700;font-size:13px;margin-bottom:8px">Product ID: '+esc(sp.product_id||'')+'</div>';
      h+='<div style="display:flex;gap:6px"><button class="btn btn-pri btn-sm" style="flex:1" onclick="B.openInquiry(\'whistle\',\''+esc(sp.product_id||'')+'\')">Inquire</button><button class="btn btn-danger btn-sm" onclick="B.unsaveProduct(\''+sp.id+'\')">&#x1F5D1;</button></div>';
    }
    h+='</div>';
  });
  h+='</div>';
  return h;
}

/* === PROFILE === */
function pgProfile(){
  var u=S.user;
  var h='<div style="max-width:600px">';
  h+='<div class="card"><div class="card-h">Profile Information</div><div class="card-b">';
  h+='<form onsubmit="event.preventDefault();B.saveProfile(this)">';
  h+='<div class="grid-2"><div class="form-group"><label class="form-label">Company Name</label><input class="form-input" name="company_name" value="'+esc(u.company_name||'')+'"></div>';
  h+='<div class="form-group"><label class="form-label">Contact Name</label><input class="form-input" name="display_name" value="'+esc(u.display_name||'')+'"></div></div>';
  h+='<div class="form-group"><label class="form-label">Email</label><input class="form-input" value="'+esc(u.email||'')+'" disabled style="opacity:.5"></div>';
  h+='<div class="grid-2"><div class="form-group"><label class="form-label">Country</label><select class="form-select" name="country"><option value="">Select</option>';
  var countryNames={CN:'China',US:'United States',JP:'Japan',HK:'Hong Kong',VN:'Vietnam',RU:'Russia',TW:'Taiwan',TH:'Thailand',AE:'UAE',SG:'Singapore'};
  ['CN','US','JP','HK','VN','RU','TW','TH','AE','SG'].forEach(function(c){
    h+='<option value="'+c+'"'+(u.country===c?' selected':'')+'>'+(countryNames[c]||c)+'</option>';
  });
  h+='</select></div><div class="form-group"><label class="form-label">Phone</label><input class="form-input" name="phone" value="'+esc(u.phone||'')+'"></div></div>';
  h+='<button class="btn btn-pri" type="submit">Save Profile</button>';
  h+='</form></div></div>';

  // Change password
  h+='<div class="card"><div class="card-h">Change Password</div><div class="card-b">';
  h+='<form onsubmit="event.preventDefault();B.changePassword(this)">';
  h+='<div class="form-group"><label class="form-label">New Password</label><input class="form-input" name="password" type="password" placeholder="Min 6 characters" required></div>';
  h+='<div class="form-group"><label class="form-label">Confirm Password</label><input class="form-input" name="confirm" type="password" placeholder="Repeat password" required></div>';
  h+='<button class="btn btn-ghost" type="submit">Update Password</button>';
  h+='</form></div></div>';

  // Account info
  h+='<div class="card"><div class="card-h">Account</div><div class="card-b">';
  h+='<div style="font-size:12px;color:var(--w40)">Account ID: '+esc(u.id)+'</div>';
  h+='<div style="font-size:12px;color:var(--w40)">Role: '+esc(u.role||'buyer')+'</div>';
  h+='</div></div>';

  h+='</div>';
  return h;
}

function saveProfile(f){
  var fd=new FormData(f);
  var data={};fd.forEach(function(v,k){data[k]=v;});
  sb.from('users').update({company_name:data.company_name,display_name:data.display_name,country:data.country,phone:data.phone}).eq('id',S.user.id).then(function(r){
    if(r.error){toast('Failed to save: '+r.error.message,'err');return;}
    S.user.company_name=data.company_name;
    S.user.display_name=data.display_name;
    S.user.country=data.country;
    S.user.phone=data.phone;
    toast('Profile saved!','ok');
    render();
  });
}

function changePassword(f){
  if(f.password.value!==f.confirm.value){toast('Passwords do not match','err');return;}
  if(f.password.value.length<6){toast('Min 6 characters','err');return;}
  sb.auth.updateUser({password:f.password.value}).then(function(r){
    if(r.error){toast('Failed: '+r.error.message,'err');return;}
    toast('Password updated!','ok');
    f.reset();
  });
}

/* === HELPERS === */
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function formatDate(d){if(!d)return'';var dt=new Date(d);return dt.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});}
function nav(page){S.page=page;S._inqFilter=null;render();window.scrollTo(0,0);}

/* === INIT === */
sb.auth.onAuthStateChange(function(event,session){
  if(event==='SIGNED_IN'||event==='TOKEN_REFRESHED'){loadUser();}
  else if(event==='SIGNED_OUT'){S.user=null;S.loading=false;render();}
});
loadUser();

/* === PUBLIC API === */
window.B={
  set:set,render:render,nav:nav,
  doLogin:doLogin,doSignup:doSignup,doReset:doReset,doLogout:doLogout,
  doSearch:doSearch,quickSearch:quickSearch,setSource:setSource,
  openInquiry:openInquiry,openCustomSourcing:openCustomSourcing,submitInquiry:submitInquiry,closeModal:closeModal,
  saveProduct:saveProduct,unsaveProduct:unsaveProduct,
  showInquiryDetail:showInquiryDetail,
  saveProfile:saveProfile,changePassword:changePassword,
  _inqFilter:null
};

})();
</script>
</body>
</html>
