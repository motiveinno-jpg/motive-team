<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Whistle AI — Buyer Portal</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://js.stripe.com/v3/"></script>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root{--bg:#060B18;--bg2:#0A1020;--card:#0D1424;--card2:#111B2E;--sf:#111B2E;--pri:#00D4FF;--pri-g:linear-gradient(135deg,#00D4FF,#0088FF);--pri-d:#0088FF;--pri-glow:0 0 30px rgba(0,212,255,.12);--acc:#FFB800;--acc-g:linear-gradient(135deg,#FFB800,#FF8C00);--ok:#00E676;--err:#FF5252;--warn:#FFA726;--purple:#A855F7;--w:#fff;--w90:rgba(255,255,255,.9);--w70:rgba(255,255,255,.7);--w60:rgba(255,255,255,.6);--w40:rgba(255,255,255,.55);--w20:rgba(255,255,255,.35);--w12:rgba(255,255,255,.1);--w08:rgba(255,255,255,.06);--bd:rgba(255,255,255,.08);--bd-l:rgba(255,255,255,.15);--r:14px;--r-s:10px;--r-xs:6px;--shadow:0 4px 24px rgba(0,0,0,.4);--shadow-lg:0 12px 48px rgba(0,0,0,.6)}
*{box-sizing:border-box;margin:0;padding:0}html{scroll-behavior:smooth}
body{background:var(--bg);font-family:'Sora',-apple-system,sans-serif;color:var(--w);line-height:1.5;overflow:hidden;height:100vh}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:var(--bg2)}::-webkit-scrollbar-thumb{background:var(--w12);border-radius:3px}::selection{background:rgba(0,212,255,.3)}
input:focus,textarea:focus,select:focus{outline:none;border-color:var(--pri)!important;box-shadow:0 0 0 3px rgba(0,212,255,.1)}
select option{background:var(--card);color:var(--w90)}textarea{resize:vertical;min-height:60px}a{color:var(--pri);text-decoration:none}
.app-layout{display:flex;height:100vh;overflow:hidden}
.sidebar{width:240px;background:var(--bg2);border-right:1px solid var(--bd);display:flex;flex-direction:column;flex-shrink:0;overflow-y:auto}
.sidebar-header{padding:16px;border-bottom:1px solid var(--bd);display:flex;align-items:center;gap:10px}
.sidebar-logo{width:32px;height:32px;border-radius:9px;background:var(--pri-g);display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:900;color:var(--bg);flex-shrink:0}
.sidebar-title{font-size:15px;font-weight:800;letter-spacing:-.5px}
.sidebar-sub{font-size:10px;color:var(--w40);font-family:'JetBrains Mono'}
.sidebar-nav{flex:1;padding:8px;overflow-y:auto}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:var(--r-s);font-size:13px;font-weight:500;color:var(--w60);cursor:pointer;transition:all .15s;border:1px solid transparent;margin-bottom:2px}
.nav-item:hover{background:var(--w08);color:var(--w90)}
.nav-item.active{background:rgba(0,212,255,.08);color:var(--pri);border-color:rgba(0,212,255,.15);font-weight:600}
.nav-item .icon{font-size:16px;width:20px;text-align:center}
.nav-item .badge-count{margin-left:auto;font-size:10px;background:var(--err);color:var(--w);padding:1px 6px;border-radius:10px;font-weight:700}
.nav-section{height:1px;background:var(--bd);margin:8px 12px}
.sidebar-footer{padding:12px;border-top:1px solid var(--bd)}
.main-area{flex:1;display:flex;flex-direction:column;overflow:hidden}
.topbar{height:52px;background:rgba(6,11,24,.9);backdrop-filter:blur(12px);border-bottom:1px solid var(--bd);display:flex;align-items:center;justify-content:space-between;padding:0 24px;flex-shrink:0}
.topbar-title{font-size:15px;font-weight:700}
.page-content{flex:1;overflow-y:auto;padding:24px}
.card{background:var(--card);border-radius:var(--r);border:1px solid var(--bd);overflow:hidden;margin-bottom:16px}
.card-h{padding:14px 18px;border-bottom:1px solid var(--bd);display:flex;align-items:center;justify-content:space-between;font-weight:700;font-size:14px}
.card-b{padding:18px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:9px 18px;border-radius:var(--r-s);font-size:13px;font-weight:600;font-family:inherit;cursor:pointer;border:none;transition:all .15s;white-space:nowrap}
.btn:hover{filter:brightness(1.1);transform:translateY(-1px)}.btn:active{transform:translateY(0)}.btn:disabled{opacity:.5;cursor:not-allowed}
.btn-pri{background:var(--pri-g);color:var(--bg);box-shadow:var(--pri-glow)}.btn-acc{background:var(--acc-g);color:var(--bg)}
.btn-ok{background:var(--ok);color:var(--bg)}.btn-ghost{background:transparent;color:var(--w);border:1.5px solid var(--bd-l)}
.btn-ghost:hover{border-color:var(--w40)}.btn-danger{background:rgba(255,82,82,.15);color:var(--err);border:1px solid rgba(255,82,82,.2)}
.btn-sm{padding:5px 12px;font-size:12px;border-radius:var(--r-xs)}.btn-lg{padding:12px 24px;font-size:14px}.btn-block{width:100%}
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:var(--r-xs);font-size:11px;font-weight:600;font-family:'JetBrains Mono',monospace}
.badge-pri{background:rgba(0,212,255,.1);color:var(--pri);border:1px solid rgba(0,212,255,.2)}
.badge-acc{background:rgba(255,184,0,.1);color:var(--acc);border:1px solid rgba(255,184,0,.2)}
.badge-ok{background:rgba(0,230,118,.1);color:var(--ok);border:1px solid rgba(0,230,118,.2)}
.badge-err{background:rgba(255,82,82,.1);color:var(--err);border:1px solid rgba(255,82,82,.2)}
.badge-purple{background:rgba(168,85,247,.1);color:var(--purple);border:1px solid rgba(168,85,247,.2)}
.badge-ghost{background:var(--w08);color:var(--w40);border:1px solid var(--bd)}
.form-group{margin-bottom:14px}
.form-label{display:block;font-size:12px;font-weight:600;color:var(--w40);margin-bottom:6px}
.form-input,.form-select,.form-textarea{width:100%;padding:11px 14px;border-radius:var(--r-s);border:1.5px solid var(--bd);background:var(--sf);color:var(--w90);font-size:14px;font-family:inherit}
.form-input::placeholder,.form-textarea::placeholder{color:var(--w20)}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
.grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
@media(max-width:900px){.grid-3,.grid-4{grid-template-columns:1fr 1fr}}
@media(max-width:600px){.grid-2,.grid-3,.grid-4{grid-template-columns:1fr}.sidebar{display:none}.mob-menu{display:flex!important}}
.stat-card{padding:18px;border-radius:var(--r);background:var(--card);border:1px solid var(--bd);text-align:center}
.stat-val{font-size:28px;font-weight:800;margin-bottom:4px}
.stat-label{font-size:11px;color:var(--w40);text-transform:uppercase;letter-spacing:.5px}
.toast{position:fixed;bottom:20px;right:20px;padding:12px 20px;border-radius:var(--r-s);font-size:13px;font-weight:600;z-index:9999;animation:slideUp .3s}
.toast-ok{background:var(--ok);color:#000}.toast-err{background:var(--err);color:#fff}.toast-warn{background:var(--acc);color:#000}
@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
.auth-wrap{display:flex;align-items:center;justify-content:center;height:100vh;background:var(--bg)}
.auth-card{width:420px;max-width:90vw;background:var(--card);border:1px solid var(--bd);border-radius:var(--r);padding:36px;box-shadow:var(--shadow-lg)}
.auth-logo{display:flex;align-items:center;gap:12px;margin-bottom:24px;justify-content:center}
.auth-logo-icon{width:48px;height:48px;border-radius:14px;background:var(--pri-g);display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:900;color:var(--bg)}
.auth-title{font-size:22px;font-weight:900;letter-spacing:-.5px}
.auth-sub{font-size:11px;color:var(--acc);font-weight:600}
.auth-tabs{display:flex;gap:0;margin-bottom:20px;border-radius:var(--r-s);overflow:hidden;border:1px solid var(--bd)}
.auth-tab{flex:1;text-align:center;padding:10px;font-size:13px;font-weight:600;color:var(--w40);cursor:pointer;background:transparent;transition:all .15s}
.auth-tab.active{background:rgba(0,212,255,.1);color:var(--pri)}
.auth-error{background:rgba(255,82,82,.1);color:var(--err);padding:10px 14px;border-radius:var(--r-xs);font-size:12px;margin-bottom:14px}
.product-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
.product-card{padding:16px;border-radius:var(--r);background:var(--sf);border:1px solid var(--bd);transition:all .2s}
.product-card:hover{border-color:var(--pri);transform:translateY(-2px);box-shadow:var(--shadow)}
.product-img{width:100%;height:160px;object-fit:cover;border-radius:var(--r-xs);margin-bottom:10px;background:var(--w08)}
.product-img-placeholder{width:100%;height:160px;border-radius:var(--r-xs);background:var(--w08);display:flex;align-items:center;justify-content:center;font-size:36px;margin-bottom:10px}
.source-tab{display:flex;gap:0;border-radius:var(--r-s);overflow:hidden;border:1px solid var(--bd);margin-bottom:16px}
.source-tab-item{flex:1;text-align:center;padding:10px 16px;font-size:13px;font-weight:600;color:var(--w40);cursor:pointer;transition:all .15s;border-right:1px solid var(--bd)}
.source-tab-item:last-child{border-right:none}
.source-tab-item.active{background:rgba(0,212,255,.08);color:var(--pri)}
.source-tab-item:hover:not(.active){background:var(--w08);color:var(--w90)}
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);z-index:1000;display:flex;align-items:center;justify-content:center}
.modal{width:560px;max-width:92vw;max-height:85vh;overflow-y:auto;background:var(--card);border:1px solid var(--bd);border-radius:var(--r);box-shadow:var(--shadow-lg)}
.modal-h{padding:16px 20px;border-bottom:1px solid var(--bd);display:flex;align-items:center;justify-content:space-between;font-weight:700;font-size:15px}
.modal-close{width:30px;height:30px;border-radius:8px;background:var(--w08);border:none;color:var(--w60);cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center}
.modal-close:hover{background:var(--err);color:var(--w)}
.modal-b{padding:20px}
.inquiry-type-card{padding:16px;border-radius:var(--r-s);border:2px solid var(--bd);cursor:pointer;transition:all .15s;margin-bottom:10px}
.inquiry-type-card:hover{border-color:var(--w40)}
.inquiry-type-card.selected{border-color:var(--pri);background:rgba(0,212,255,.05)}
.mob-menu{display:none;position:fixed;top:12px;left:12px;z-index:500;width:36px;height:36px;border-radius:10px;background:var(--card);border:1px solid var(--bd);align-items:center;justify-content:center;cursor:pointer;font-size:18px}
.origin-badge{display:inline-flex;align-items:center;gap:3px;padding:2px 8px;border-radius:var(--r-xs);font-size:10px;font-weight:700}
.origin-verified{background:rgba(0,230,118,.12);color:var(--ok)}
.origin-likely{background:rgba(255,184,0,.12);color:var(--acc)}
.origin-unknown{background:var(--w08);color:var(--w40)}
.filter-row{display:flex;gap:10px;align-items:center;margin-bottom:16px;flex-wrap:wrap}
.search-box{flex:1;min-width:200px;display:flex;gap:8px}
.search-box input{flex:1}
.inquiry-list-item{padding:14px 18px;border-bottom:1px solid var(--w08);display:flex;align-items:center;gap:14px;cursor:pointer;transition:background .15s}
.inquiry-list-item:hover{background:var(--w08)}
.inquiry-list-item:last-child{border-bottom:none}
/* Chat */
.chat-layout{display:flex;height:calc(100vh - 100px);gap:0}
.chat-list{width:280px;border-right:1px solid var(--bd);overflow-y:auto;flex-shrink:0}
.chat-list-item{padding:12px 14px;border-bottom:1px solid var(--w08);cursor:pointer;transition:background .15s}
.chat-list-item:hover{background:var(--w08)}.chat-list-item.active{background:rgba(0,212,255,.08);border-left:3px solid var(--pri)}
.chat-panel{flex:1;display:flex;flex-direction:column;min-width:0}
.chat-msgs{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:8px}
.chat-bubble{max-width:70%;padding:10px 14px;border-radius:var(--r-s);font-size:13px;line-height:1.5;word-break:break-word}
.chat-bubble.mine{align-self:flex-end;background:var(--pri-g);color:var(--bg);border-bottom-right-radius:4px}
.chat-bubble.theirs{align-self:flex-start;background:var(--sf);border:1px solid var(--bd);border-bottom-left-radius:4px}
.chat-input-row{padding:12px;border-top:1px solid var(--bd);display:flex;gap:8px}
.chat-input-row input{flex:1}
/* Orders pipeline */
.order-pipeline{display:flex;gap:4px;margin-bottom:20px;overflow-x:auto;padding-bottom:8px}
.order-stage{padding:8px 16px;border-radius:20px;font-size:11px;font-weight:700;white-space:nowrap;cursor:pointer;border:1px solid var(--bd);background:var(--sf);color:var(--w40);transition:all .15s}
.order-stage.active{background:rgba(0,212,255,.1);color:var(--pri);border-color:rgba(0,212,255,.3)}
.order-stage .cnt{margin-left:4px;opacity:.6}
/* Shipment timeline */
.ship-timeline{position:relative;padding-left:28px}
.ship-step{position:relative;padding-bottom:24px;padding-left:20px}
.ship-step:before{content:'';position:absolute;left:-28px;top:0;width:2px;height:100%;background:var(--bd)}
.ship-step:last-child:before{height:16px}
.ship-step .dot{position:absolute;left:-34px;top:2px;width:14px;height:14px;border-radius:50%;border:2px solid var(--bd);background:var(--bg)}
.ship-step.done .dot{background:var(--ok);border-color:var(--ok)}
.ship-step.current .dot{background:var(--pri);border-color:var(--pri);box-shadow:0 0 8px rgba(0,212,255,.4)}
/* Notification dropdown */
.notif-bell{position:relative;cursor:pointer;font-size:18px;padding:4px}
.notif-dot{position:absolute;top:0;right:0;width:8px;height:8px;border-radius:50%;background:var(--err)}
.notif-dropdown{position:absolute;top:40px;right:0;width:360px;max-height:400px;overflow-y:auto;background:var(--card);border:1px solid var(--bd);border-radius:var(--r);box-shadow:var(--shadow-lg);z-index:100}
.notif-item{padding:12px 14px;border-bottom:1px solid var(--w08);cursor:pointer;transition:background .15s;font-size:12px}
.notif-item:hover{background:var(--w08)}
.notif-item.unread{border-left:3px solid var(--pri)}
@media(max-width:768px){.chat-list{width:100%}.chat-panel{display:none}.chat-layout.chat-open .chat-list{display:none}.chat-layout.chat-open .chat-panel{display:flex}}
/* Deal Pipeline */
.deal-stages{display:flex;align-items:center;gap:0;overflow-x:auto;padding:16px 0;margin-bottom:20px}
.deal-stage{display:flex;align-items:center;gap:6px;padding:8px 14px;font-size:11px;font-weight:600;color:var(--w20);white-space:nowrap;position:relative;cursor:default;transition:all .2s}
.deal-stage .s-icon{font-size:16px;opacity:.4}.deal-stage .s-line{width:20px;height:2px;background:var(--bd);flex-shrink:0}
.deal-stage.done{color:var(--ok)}.deal-stage.done .s-icon{opacity:1}.deal-stage.done .s-line{background:var(--ok)}
.deal-stage.current{color:var(--pri);font-weight:800}.deal-stage.current .s-icon{opacity:1}
.deal-stage.current:after{content:'';position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:6px;height:6px;border-radius:50%;background:var(--pri);box-shadow:0 0 8px var(--pri)}
/* Deal Room */
.deal-room{display:flex;height:calc(100vh - 100px);gap:0;overflow:hidden}
.deal-content{flex:1;overflow-y:auto;padding:20px;min-width:0}
.deal-chat{width:360px;border-left:1px solid var(--bd);display:flex;flex-direction:column;flex-shrink:0}
.deal-chat .chat-msgs{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:6px}
.deal-chat .chat-input-row{padding:10px;border-top:1px solid var(--bd);display:flex;gap:6px}
.deal-chat .chat-input-row input{flex:1;font-size:12px;padding:8px 10px}
.deal-chat-header{padding:12px 14px;border-bottom:1px solid var(--bd);display:flex;align-items:center;justify-content:space-between}
/* Deal Card */
.deal-card{padding:16px;border-radius:var(--r);background:var(--sf);border:1px solid var(--bd);cursor:pointer;transition:all .2s;margin-bottom:10px}
.deal-card:hover{border-color:var(--pri);transform:translateY(-1px);box-shadow:var(--shadow)}
.deal-card .mini-stages{display:flex;gap:3px;margin-top:10px}
.deal-card .mini-dot{width:8px;height:8px;border-radius:50%;background:var(--w08);border:1.5px solid var(--bd)}
.deal-card .mini-dot.done{background:var(--ok);border-color:var(--ok)}
.deal-card .mini-dot.current{background:var(--pri);border-color:var(--pri);box-shadow:0 0 6px rgba(0,212,255,.5)}
/* Stage action cards */
.stage-card{padding:14px;border-radius:var(--r-s);background:var(--w08);border:1px solid var(--bd);margin-bottom:10px}
.stage-card-title{font-weight:700;font-size:13px;margin-bottom:6px;display:flex;align-items:center;gap:6px}
@media(max-width:900px){.deal-chat{width:100%;position:fixed;bottom:0;left:0;right:0;height:50vh;z-index:50;background:var(--card);border-top:1px solid var(--bd);border-left:none}}
.float-chat-btn{position:fixed;bottom:24px;right:24px;width:56px;height:56px;border-radius:28px;background:linear-gradient(135deg,#00D4FF,#0088FF);display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 20px rgba(0,212,255,.4);z-index:9999;transition:transform .2s;font-size:24px}
.float-chat-btn:hover{transform:scale(1.1)}
.float-chat-panel{position:fixed;bottom:92px;right:24px;width:340px;max-height:480px;background:#0D1424;border:1px solid rgba(255,255,255,.1);border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,.5);z-index:9999;display:none;flex-direction:column;overflow:hidden}
.float-chat-panel.open{display:flex}
.float-chat-hdr{padding:16px;background:linear-gradient(135deg,#00D4FF20,#0088FF20);border-bottom:1px solid rgba(255,255,255,.08);display:flex;justify-content:space-between;align-items:center}
.float-chat-body{flex:1;padding:16px;overflow-y:auto;max-height:320px}
.float-chat-input{padding:12px;border-top:1px solid rgba(255,255,255,.08);display:flex;gap:8px}
.float-chat-input input{flex:1;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:8px 12px;color:#fff;font-size:13px;outline:none}
.float-chat-input button{background:linear-gradient(135deg,#00D4FF,#0088FF);border:none;border-radius:8px;padding:8px 16px;color:#fff;font-size:13px;cursor:pointer}
.float-chat-msg{margin-bottom:12px;max-width:85%}
.float-chat-msg.bot{margin-right:auto}
.float-chat-msg.user{margin-left:auto}
.float-chat-msg .bubble{padding:10px 14px;border-radius:12px;font-size:13px;line-height:1.5}
.float-chat-msg.bot .bubble{background:rgba(255,255,255,.06);color:rgba(255,255,255,.8)}
.float-chat-msg.user .bubble{background:linear-gradient(135deg,#00D4FF20,#0088FF20);color:#fff}
</style>
</head>
<body>
<div id="root"></div>
<script>
(function(){
'use strict';
var SB_URL='https://lylktgxngrlxmsldxdqj.supabase.co';
var SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx5bGt0Z3huZ3JseG1zbGR4ZHFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4MTQ2OTAsImV4cCI6MjA4NzM5MDY5MH0.8kgcDCMBT_STf43MVkeUUiq-K6r-Ytp3nUQ6d-nL2D0';
var RELAY=(!location.hostname||location.hostname==='localhost'||location.hostname==='127.0.0.1'||location.protocol==='file:')?'http://localhost:3456':'';
var RELAY_URL=RELAY;
var _relayReady=(function(){if(RELAY_URL)return Promise.resolve();return fetch('relay-url.txt?t='+Date.now()).then(function(r){return r.ok?r.text():null}).then(function(t){if(t){t=t.trim();if(t.startsWith('https://')){RELAY_URL=t;RELAY=t;}}}).catch(function(){})})();
function fetchRetry(url,opts,retries){retries=retries||3;var delay=1000;return _relayReady.then(function(){return _fetchRetryB(url,opts,retries,delay);});}
function _fetchRetryB(url,opts,retries,delay){return fetch(url.startsWith('/')?RELAY_URL+url:url,Object.assign({headers:{'Content-Type':'application/json','ngrok-skip-browser-warning':'1'}},opts||{})).then(function(r){if(!r.ok&&retries>1)throw new Error('HTTP '+r.status);return r;}).catch(function(err){if(retries<=1)throw err;return new Promise(function(resolve){setTimeout(function(){resolve(_fetchRetryB(url,opts,retries-1,delay*2));},delay);});});}
var sb=window.supabase.createClient(SB_URL,SB_KEY);
/* Stripe config (buyer = USD) */
var STRIPE_CFG={
  pk:'pk_test_REPLACE_WITH_YOUR_STRIPE_PUBLISHABLE_KEY',
  fn:SB_URL+'/functions/v1',
  prices:{starter:{m:'price_buyer_starter_m',s:'price_buyer_starter_s',a:'price_buyer_starter_a'},pro:{m:'price_buyer_pro_m',s:'price_buyer_pro_s',a:'price_buyer_pro_a'},enterprise:{m:'price_buyer_enterprise_m'}}
};
var _stripe=null;
function _getStripe(){if(!_stripe&&STRIPE_CFG.pk.indexOf('REPLACE')===-1){_stripe=Stripe(STRIPE_CFG.pk);}return _stripe;}

/* === STATE === */
var S={
  loading:true,page:'dashboard',user:null,authMode:'login',authError:'',
  // search
  searchQuery:'',searchSource:'all',searchResults:[],naverResults:[],whistleResults:[],searching:false,
  // data
  inquiries:[],savedProducts:[],
  // marketplace
  myRequests:[],requestProposals:{},_viewRequest:null,_reqFilter:'all',
  // modal
  modal:null,modalData:null,
  // inquiry form
  inquiryType:'import',
  // buyer-seller bridge
  buyerLinks:[],sellerInfo:{},
  // chat
  conversations:[],currentChat:null,chatMessages:[],chatUnread:0,
  // orders
  orders:[],orderFilter:'all',orderMilestones:[],
  // shipments
  shipments:[],
  // documents
  sharedDocs:[],
  // notifications
  notifications:[],notifUnread:0,notifOpen:false,
  // deals / pipeline
  deals:[],matchings:[],samples:[],dealFilter:'all',
  currentDeal:null,dealMessages:[],dealChatOpen:true
};

function set(obj){for(var k in obj)S[k]=obj[k];render();}

/* === TOAST === */
function toast(msg,type){
  var t=document.createElement('div');t.className='toast toast-'+(type||'ok');t.textContent=msg;
  document.body.appendChild(t);setTimeout(function(){t.remove();},3000);
}

/* === RENDER === */
var _renderTimer=null;
function render(){
  if(_renderTimer)return;
  _renderTimer=setTimeout(function(){_renderTimer=null;_doRender();},16);
}
function _doRender(){
  var root=document.getElementById('root');
  // Save focus state
  var ae=document.activeElement;
  var focusId=ae&&ae.id?ae.id:null;
  var focusVal=ae&&(ae.tagName==='INPUT'||ae.tagName==='TEXTAREA')?ae.value:null;
  var focusSel=ae&&ae.selectionStart!==undefined?{s:ae.selectionStart,e:ae.selectionEnd}:null;

  if(S.loading){root.innerHTML='<div class="auth-wrap"><div style="text-align:center"><div style="font-size:36px;margin-bottom:12px">W</div><div style="color:var(--w40)">Loading...</div></div></div>';return;}
  if(!S.user){root.innerHTML=pgAuth();return;}
  var isDealRoom=S.page==='deals'&&S.currentDeal;
  root.innerHTML='<div class="app-layout">'+renderSidebar()+'<div class="main-area">'+renderTopbar()+'<div class="page-content" id="pageContent" style="'+(isDealRoom?'padding:12px;overflow:hidden':'')+'">'+renderPage()+'</div></div></div>'+(S.modal?renderModal():'');

  // Restore focus
  if(focusId){
    var el=document.getElementById(focusId);
    if(el){
      el.focus();
      if(focusVal!==null)el.value=focusVal;
      if(focusSel&&el.setSelectionRange)try{el.setSelectionRange(focusSel.s,focusSel.e);}catch(e){}
    }
  }
}

function renderPage(){
  switch(S.page){
    case'marketplace':return pgMarketplace();
    case'search':return pgSearch();
    case'inquiries':return pgInquiries();
    case'saved':return pgSaved();
    case'profile':return pgProfile();
    case'deals':return S.currentDeal?pgDealRoom():pgDeals();
    case'messages':return pgMessages();
    case'orders':return pgOrders();
    case'shipments':return pgShipments();
    case'documents':return pgDocs();
    case'partnership':return pgPartnership();
    default:return pgDash();
  }
}

function pgPartnership(){
  var h='<div style="max-width:720px;margin:0 auto">';
  h+='<div class="card"><div class="card-h">&#x1F91D; Partnership Inquiry</div><div class="card-b">';
  h+='<div style="margin-bottom:20px;color:var(--w70);font-size:14px;line-height:1.7">We are looking for partners to grow together with Whistle AI. We offer reseller, service, technology, and institutional partnership programs.</div>';
  h+='<div class="grid-2" style="margin-bottom:20px">';
  h+='<div style="padding:16px;border-radius:var(--r-s);border:1px solid var(--bd);background:var(--w08)"><div style="font-size:20px;margin-bottom:8px">&#x1F3E2;</div><div style="font-weight:700;font-size:14px;margin-bottom:4px">Reseller Partner</div><div style="font-size:12px;color:var(--w40)">Distribute Whistle AI solutions to your customers and share revenue.</div></div>';
  h+='<div style="padding:16px;border-radius:var(--r-s);border:1px solid var(--bd);background:var(--w08)"><div style="font-size:20px;margin-bottom:8px">&#x1F527;</div><div style="font-weight:700;font-size:14px;margin-bottom:4px">Service Partner</div><div style="font-size:12px;color:var(--w40)">Provide logistics, customs, and certification services together.</div></div>';
  h+='<div style="padding:16px;border-radius:var(--r-s);border:1px solid var(--bd);background:var(--w08)"><div style="font-size:20px;margin-bottom:8px">&#x1F4BB;</div><div style="font-weight:700;font-size:14px;margin-bottom:4px">Technology Partner</div><div style="font-size:12px;color:var(--w40)">API integration and data partnerships for synergy.</div></div>';
  h+='<div style="padding:16px;border-radius:var(--r-s);border:1px solid var(--bd);background:var(--w08)"><div style="font-size:20px;margin-bottom:8px">&#x1F3DB;</div><div style="font-weight:700;font-size:14px;margin-bottom:4px">Institutional Partner</div><div style="font-size:12px;color:var(--w40)">Collaborate on SME export support programs.</div></div>';
  h+='</div>';
  h+='<div class="form-group"><label class="form-label">Company Name</label><input class="form-input" id="pt-company" placeholder="Your company name"></div>';
  h+='<div class="form-group"><label class="form-label">Contact Name</label><input class="form-input" id="pt-name" placeholder="Full name"></div>';
  h+='<div class="grid-2"><div class="form-group"><label class="form-label">Email</label><input class="form-input" id="pt-email" placeholder="email@company.com"></div>';
  h+='<div class="form-group"><label class="form-label">Phone</label><input class="form-input" id="pt-phone" placeholder="+1-000-000-0000"></div></div>';
  h+='<div class="form-group"><label class="form-label">Partnership Type</label><select class="form-select" id="pt-type"><option value="">Select</option><option value="reseller">Reseller</option><option value="service">Service</option><option value="tech">Technology</option><option value="institutional">Institutional</option><option value="other">Other</option></select></div>';
  h+='<div class="form-group"><label class="form-label">Message</label><textarea class="form-textarea" id="pt-message" rows="4" placeholder="Tell us about your partnership interest..."></textarea></div>';
  h+='<button class="btn btn-pri btn-lg" style="width:100%" onclick="B.submitPartnership()">Submit Partnership Inquiry</button>';
  h+='</div></div></div>';
  return h;
}

/* === SIDEBAR === */
function renderSidebar(){
  var activeDeals=S.deals.filter(function(d){return d.stage!=='completed'&&d.stage!=='inquiry';}).length;
  var items=[
    {id:'dashboard',icon:'&#x1F4CA;',label:'Dashboard'},
    {id:'search',icon:'&#x1F50D;',label:'Product Search'},
    {id:'deals',icon:'&#x1F680;',label:'Sourcing Pipeline',count:activeDeals},
    {id:'inquiries',icon:'&#x1F4CB;',label:'Inquiries',count:S.inquiries.filter(function(i){return i.status==='pending';}).length},
    {id:'marketplace',icon:'&#x1F3EA;',label:'Marketplace',count:S.myRequests.filter(function(r){return r.status==='open';}).length},
    {id:'messages',icon:'&#x1F4AC;',label:'Messages',count:S.chatUnread},
    {id:'orders',icon:'&#x1F4E6;',label:'Orders',count:S.orders.filter(function(o){return o.status!=='completed'&&o.status!=='cancelled';}).length},
    {id:'shipments',icon:'&#x1F6A2;',label:'Shipments'},
    {id:'documents',icon:'&#x1F4C4;',label:'Documents'},
    {id:'saved',icon:'&#x1F4BE;',label:'Saved Products',count:S.savedProducts.length},
    {id:'profile',icon:'&#x1F464;',label:'Profile'},
    {id:'partnership',icon:'&#x1F91D;',label:'Partnership'}
  ];
  var h='<div class="sidebar"><div class="sidebar-header"><div class="sidebar-logo">W</div><div><div class="sidebar-title">Whistle AI</div><div class="sidebar-sub">BUYER PORTAL</div></div></div><div class="sidebar-nav">';
  items.forEach(function(it){
    h+='<div class="nav-item'+(S.page===it.id?' active':'')+'" onclick="B.nav(\''+it.id+'\')"><span class="icon">'+it.icon+'</span><span>'+it.label+'</span>'+(it.count?'<span class="badge-count">'+it.count+'</span>':'')+'</div>';
  });
  h+='<div class="nav-section"></div>';
  h+='<div class="nav-item" onclick="B.doLogout()"><span class="icon">&#x1F6AA;</span><span>Logout</span></div>';
  h+='</div><div class="sidebar-footer"><div style="font-size:11px;color:var(--w20)">'+esc(S.user.company_name||S.user.email)+'</div></div></div>';
  return h;
}

function renderTopbar(){
  var titles={dashboard:'Dashboard',search:'Product Search',deals:'Sourcing Pipeline',inquiries:'My Inquiries',marketplace:'Request Board',saved:'Saved Products',profile:'Profile & Settings',messages:'Messages',orders:'Orders',shipments:'Shipments',documents:'Documents'};
  var h='<div class="topbar"><div class="topbar-title">'+(titles[S.page]||'Dashboard')+'</div><div style="display:flex;align-items:center;gap:14px">';
  // Notification bell
  h+='<div class="notif-bell" onclick="event.stopPropagation();B.toggleNotif()">&#x1F514;';
  if(S.notifUnread)h+='<div class="notif-dot"></div>';
  h+='</div>';
  if(S.notifOpen)h+=renderNotifDropdown();
  h+='<span style="font-size:12px;color:var(--w40)">'+esc(S.user.display_name||S.user.email)+'</span></div></div>';
  return h;
}
function renderNotifDropdown(){
  var h='<div class="notif-dropdown" onclick="event.stopPropagation()">';
  h+='<div style="padding:12px 14px;border-bottom:1px solid var(--bd);display:flex;justify-content:space-between;align-items:center"><span style="font-weight:700;font-size:13px">Notifications</span>';
  if(S.notifUnread)h+='<span style="font-size:11px;color:var(--pri);cursor:pointer" onclick="B.markAllNotifRead()">Mark all read</span>';
  h+='</div>';
  if(!S.notifications.length){h+='<div style="padding:30px;text-align:center;color:var(--w40);font-size:12px">No notifications</div>';}
  else{S.notifications.slice(0,20).forEach(function(n){
    h+='<div class="notif-item'+(n.is_read?'':' unread')+'" onclick="B.clickNotif(\''+n.id+'\',\''+esc(n.link_page||'dashboard')+'\')">';
    h+='<div style="font-weight:600">'+esc(n.title)+'</div>';
    if(n.body)h+='<div style="color:var(--w40);margin-top:2px">'+esc(n.body).substring(0,80)+'</div>';
    h+='<div style="color:var(--w20);margin-top:4px;font-size:10px">'+timeAgo(n.created_at)+'</div></div>';
  });}
  h+='</div>';return h;
}

/* === AUTH PAGE === */
function pgAuth(){
  var isL=S.authMode==='login';
  var h='<div class="auth-wrap"><div class="auth-card"><div class="auth-logo"><div class="auth-logo-icon">W</div><div><div class="auth-title">Whistle AI</div><div class="auth-sub">BUYER PORTAL</div></div></div>';
  h+='<div class="auth-tabs"><div class="auth-tab'+(isL?' active':'')+'" onclick="B.set({authMode:\'login\',authError:\'\'})">Sign In</div><div class="auth-tab'+(!isL?' active':'')+'" onclick="B.set({authMode:\'signup\',authError:\'\'})">Sign Up</div></div>';
  if(S.authError)h+='<div class="auth-error">'+esc(S.authError)+'</div>';
  if(S.authMode==='reset'){
    h+='<form onsubmit="event.preventDefault();B.doReset(this)"><div class="form-group"><label class="form-label">Email</label><input class="form-input" name="email" type="email" placeholder="your@email.com" required></div><button class="btn btn-pri btn-block btn-lg" type="submit">Send Reset Link</button><div style="text-align:center;margin-top:12px"><a href="#" onclick="event.preventDefault();B.set({authMode:\'login\',authError:\'\'})">Back to Sign In</a></div></form>';
  } else if(isL){
    h+='<form onsubmit="event.preventDefault();B.doLogin(this)"><div class="form-group"><label class="form-label">Email</label><input class="form-input" name="email" type="email" placeholder="your@email.com" required></div><div class="form-group"><label class="form-label">Password</label><input class="form-input" name="password" type="password" placeholder="Password" required></div><button class="btn btn-pri btn-block btn-lg" type="submit" style="margin-top:4px"'+(S._loggingIn?' disabled':'')+'>'+(S._loggingIn?'Signing in...':'Sign In')+'</button><div style="text-align:center;margin-top:12px;font-size:12px"><a href="#" onclick="event.preventDefault();B.set({authMode:\'reset\',authError:\'\'})">Forgot password?</a></div></form>';
  } else {
    h+='<form onsubmit="event.preventDefault();B.doSignup(this)"><div class="grid-2"><div class="form-group"><label class="form-label">Company Name *</label><input class="form-input" name="company_name" placeholder="Your Company Inc." required></div><div class="form-group"><label class="form-label">Contact Name *</label><input class="form-input" name="display_name" placeholder="Full name" required></div></div><div class="form-group"><label class="form-label">Email *</label><input class="form-input" name="email" type="email" placeholder="your@email.com" required></div><div class="form-group"><label class="form-label">Password *</label><input class="form-input" name="password" type="password" placeholder="Min 6 characters" required></div><div class="grid-2"><div class="form-group"><label class="form-label">Country</label><select class="form-select" name="country"><option value="">Select</option><option value="AU">Australia</option><option value="BR">Brazil</option><option value="CA">Canada</option><option value="CL">Chile</option><option value="CN">China</option><option value="CO">Colombia</option><option value="DK">Denmark</option><option value="EG">Egypt</option><option value="FI">Finland</option><option value="FR">France</option><option value="DE">Germany</option><option value="HK">Hong Kong</option><option value="IN">India</option><option value="ID">Indonesia</option><option value="IT">Italy</option><option value="JP">Japan</option><option value="KE">Kenya</option><option value="KW">Kuwait</option><option value="MY">Malaysia</option><option value="MX">Mexico</option><option value="NL">Netherlands</option><option value="NZ">New Zealand</option><option value="NG">Nigeria</option><option value="NO">Norway</option><option value="PE">Peru</option><option value="PH">Philippines</option><option value="PL">Poland</option><option value="QA">Qatar</option><option value="RU">Russia</option><option value="SA">Saudi Arabia</option><option value="SG">Singapore</option><option value="ZA">South Africa</option><option value="KR">South Korea</option><option value="ES">Spain</option><option value="SE">Sweden</option><option value="TW">Taiwan</option><option value="TH">Thailand</option><option value="TR">Turkey</option><option value="AE">UAE</option><option value="GB">United Kingdom</option><option value="US">United States</option><option value="VN">Vietnam</option></select></div><div class="form-group"><label class="form-label">Interest</label><select class="form-select" name="interest"><option value="">Select</option><option value="skincare">K-Beauty / Skincare</option><option value="cosmetics">Color Cosmetics</option><option value="haircare">Hair Care</option><option value="supplement">Health Supplements</option><option value="food">Food & Beverage</option><option value="general">General Products</option></select></div></div><label style="display:flex;align-items:flex-start;gap:8px;margin:12px 0 4px;cursor:pointer;font-size:11px;color:var(--w40)"><input type="checkbox" name="agree_terms" style="margin-top:2px;accent-color:var(--pri)" required><span>I agree to the <span style="color:var(--pri);text-decoration:underline">Terms of Service</span> and <span style="color:var(--pri);text-decoration:underline">Privacy Policy</span></span></label><button class="btn btn-pri btn-block btn-lg" type="submit" style="margin-top:4px">Create Account</button></form>';
  }
  h+='<div style="text-align:center;margin-top:20px;font-size:11px;color:var(--w20)">Source premium Korean products with AI</div></div></div>';
  return h;
}

/* === AUTH ACTIONS === */
function doLogin(f){
  set({authError:'',_loggingIn:true});
  sb.auth.signInWithPassword({email:f.email.value,password:f.password.value}).then(function(r){
    if(r.error){set({_loggingIn:false,authError:r.error.message==='Invalid login credentials'?'Invalid email or password':r.error.message});return;}
    set({_loggingIn:false});
    loadUser();
  }).catch(function(){set({_loggingIn:false,authError:'Login failed. Please try again.'});});
}
function doSignup(f){
  if(f.password.value.length<6)return set({authError:'Password must be at least 6 characters'});
  set({authError:''});
  sb.auth.signUp({email:f.email.value,password:f.password.value,options:{data:{role:'buyer',company_name:f.company_name.value,display_name:f.display_name.value}}}).then(function(r){
    if(r.error)return set({authError:r.error.message.includes('already registered')?'Email already registered':r.error.message});
    // Also upsert into users table
    var uid=r.data&&r.data.user?r.data.user.id:null;
    if(uid){
      sb.from('users').upsert({id:uid,email:f.email.value,role:'buyer',company_name:f.company_name.value,display_name:f.display_name.value,country:f.country.value},{onConflict:'id'}).then(function(){});
    }
    toast('Account created! Please check your email to verify, then sign in.','ok');
    set({authMode:'login'});
  });
}
function doReset(f){
  sb.auth.resetPasswordForEmail(f.email.value).then(function(r){
    if(r.error)return set({authError:r.error.message});
    toast('Reset link sent to your email','ok');
    set({authMode:'login'});
  });
}
function doLogout(){
  if(confirm('Sign out?')){sb.auth.signOut().then(function(){S.user=null;render();});}
}

/* === LOAD USER === */
function loadUser(){
  set({loading:true});
  sb.auth.getSession().then(function(r){
    var session=r.data.session;
    if(!session)return set({loading:false,user:null});
    sb.from('users').select('*').eq('id',session.user.id).single().then(function(r){
      if(r.error||!r.data){
        // User exists in auth but not users table - create entry
        var meta=session.user.user_metadata||{};
        if(meta.role && meta.role !== 'buyer' && meta.role !== 'admin'){
          sb.auth.signOut();
          return set({loading:false, user:null, authError:'This portal is for buyers only. Please use the seller portal at whistle.html'});
        }
        sb.from('users').insert({id:session.user.id,email:session.user.email,role:'buyer',company_name:meta.company_name||'',display_name:meta.display_name||''}).then(function(ur){
          S.user=ur.data&&ur.data[0]?ur.data[0]:{id:session.user.id,email:session.user.email,role:'buyer'};
          S.loading=false;
          loadAllData();
        });
        return;
      }
      if(r.data.role!=='buyer'&&r.data.role!=='admin'){sb.auth.signOut();return set({loading:false,user:null,authError:'This portal is for buyers only. Please use the appropriate portal.'});}
      S.user=r.data;S.loading=false;
      loadAllData();
    });
  });
}

function loadAllData(){
  loadBuyerLinks();
  loadInquiries();
  loadSavedProducts();
  loadMyRequests();
  loadNotifications();
  loadMatchings();
  importLandingSavedProducts();
  render();
}

/* 랜딩페이지에서 저장한 관심 제품 → buyer_saved_products 자동 등록 */
function importLandingSavedProducts(){
  if(!S.user)return;
  try{
    var saved=JSON.parse(localStorage.getItem('whistle_saved_products')||'[]');
    if(!saved.length)return;
    saved.forEach(function(p){
      sb.from('buyer_saved_products').insert({
        user_id:S.user.id,
        source:'naver',
        naver_product_data:{title:p.title,lprice:p.lprice,image:p.image,link:p.link,maker:p.maker,brand:p.brand,mallName:p.mallName,category:p.category,origin:p.origin},
        note:'Landing page inquiry'
      }).then(function(r){
        if(r.error&&r.error.message&&r.error.message.includes('duplicate'))return;
        if(!r.error)console.log('[import] 랜딩 관심제품 저장:', p.title);
      });
    });
    localStorage.removeItem('whistle_saved_products');
  }catch(e){console.log('[import] 에러:', e.message);}
}

/* === BUYER-SELLER BRIDGE === */
function loadBuyerLinks(){
  if(!S.user)return;
  sb.from('buyers').select('*').or('buyer_user_id.eq.'+S.user.id+',email.ilike.'+S.user.email).then(function(r){
    S.buyerLinks=r.data||[];
    // Auto-link buyer_user_id if not set
    S.buyerLinks.forEach(function(b){
      if(!b.buyer_user_id){sb.from('buyers').update({buyer_user_id:S.user.id}).eq('id',b.id).then(function(){});}
    });
    if(S.buyerLinks.length){
      loadConversations();
      loadOrders();
      loadShipments();
      loadSharedDocs();
      loadSellerInfo();
      loadMatchings();
      loadSamples();
    }
    render();
  });
}

function getBuyerIds(){return S.buyerLinks.map(function(b){return b.id;});}

function loadSellerInfo(){
  var sellerIds=[];
  S.buyerLinks.forEach(function(b){if(b.registered_by&&sellerIds.indexOf(b.registered_by)<0)sellerIds.push(b.registered_by);});
  if(!sellerIds.length)return;
  sb.from('companies').select('user_id,name_en,name_ko,logo_url').in('user_id',sellerIds).then(function(r){
    (r.data||[]).forEach(function(c){S.sellerInfo[c.user_id]=c;});
    sb.from('users').select('id,email,display_name,company_name').in('id',sellerIds).then(function(r2){
      (r2.data||[]).forEach(function(u){if(!S.sellerInfo[u.id])S.sellerInfo[u.id]={user_id:u.id,name_en:u.company_name||u.display_name,name_ko:u.company_name};});
      render();
    });
  });
}

function getSellerName(uid){var s=S.sellerInfo[uid];return s?(s.name_en||s.name_ko||'Seller'):'Seller';}

function loadInquiries(){
  if(!S.user)return;
  sb.from('contact_requests').select('*').eq('buyer_id',S.user.id).order('created_at',{ascending:false}).then(function(r){
    S.inquiries=r.data||[];render();
  });
}

function loadSavedProducts(){
  if(!S.user)return;
  sb.from('buyer_saved_products').select('*').eq('user_id',S.user.id).order('created_at',{ascending:false}).then(function(r){
    S.savedProducts=r.data||[];render();
  });
}

/* === DASHBOARD === */
function pgDash(){
  var u=S.user;
  var pending=S.inquiries.filter(function(i){return i.status==='pending';}).length;
  var inProg=S.inquiries.filter(function(i){return i.status==='in_progress';}).length;
  var activeDeals=S.deals.filter(function(d){return d.stage!=='completed'&&d.stage!=='inquiry';}).length;
  var h='<div style="margin-bottom:24px"><h2 style="font-size:22px;font-weight:800;margin-bottom:4px">Welcome, '+esc(u.display_name||u.company_name||'Buyer')+'</h2><p style="font-size:13px;color:var(--w40)">Source premium Korean products with Whistle AI</p></div>';

  // At the start of pgDash(), after the welcome message, check if user is new
  var isNew = !S.inquiries.length && !S.deals.length && !S.savedProducts.length;
  if(isNew) {
    h += '<div class="card" style="border:1px solid var(--pri);margin-bottom:20px">';
    h += '<div class="card-b" style="text-align:center;padding:32px">';
    h += '<div style="font-size:36px;margin-bottom:12px">&#x1F44B;</div>';
    h += '<h3 style="font-size:18px;font-weight:800;margin-bottom:8px">Welcome to Whistle AI!</h3>';
    h += '<p style="color:var(--w40);font-size:13px;margin-bottom:24px;max-width:480px;margin-left:auto;margin-right:auto">Source premium Korean products with AI-powered search and direct manufacturer connections. Here\'s how to get started:</p>';
    h += '<div class="grid-3" style="gap:16px;text-align:left;max-width:600px;margin:0 auto 24px">';
    h += '<div style="padding:16px;background:var(--w08);border-radius:var(--r-s);border:1px solid var(--bd)">';
    h += '<div style="font-size:20px;margin-bottom:6px">1&#xFE0F;&#x20E3;</div>';
    h += '<div style="font-weight:700;font-size:13px;margin-bottom:4px">Search Products</div>';
    h += '<div style="font-size:12px;color:var(--w40)">Search Korean products by keyword. We index Naver Shopping and verified Whistle sellers.</div></div>';
    h += '<div style="padding:16px;background:var(--w08);border-radius:var(--r-s);border:1px solid var(--bd)">';
    h += '<div style="font-size:20px;margin-bottom:6px">2&#xFE0F;&#x20E3;</div>';
    h += '<div style="font-weight:700;font-size:13px;margin-bottom:4px">Post a Request</div>';
    h += '<div style="font-size:12px;color:var(--w40)">Tell us what you need on the Request Board and receive proposals from verified manufacturers.</div></div>';
    h += '<div style="padding:16px;background:var(--w08);border-radius:var(--r-s);border:1px solid var(--bd)">';
    h += '<div style="font-size:20px;margin-bottom:6px">3&#xFE0F;&#x20E3;</div>';
    h += '<div style="font-weight:700;font-size:13px;margin-bottom:4px">Connect & Deal</div>';
    h += '<div style="font-size:12px;color:var(--w40)">Chat directly with sellers, negotiate terms, and manage your sourcing pipeline.</div></div>';
    h += '</div>';
    h += '<button class="btn btn-pri btn-lg" onclick="B.set({page:\'search\'})">Start Searching</button>';
    h += '</div></div>';
  }

  // Stats
  var activeOrders=S.orders.filter(function(o){return o.status!=='completed'&&o.status!=='cancelled';}).length;
  h+='<div class="grid-4" style="margin-bottom:24px">';
  h+='<div class="stat-card"><div class="stat-val" style="color:var(--pri)">'+S.inquiries.length+'</div><div class="stat-label">Total Inquiries</div></div>';
  h+='<div class="stat-card"><div class="stat-val" style="color:var(--acc)">'+activeOrders+'</div><div class="stat-label">Active Orders</div></div>';
  h+='<div class="stat-card"><div class="stat-val" style="color:var(--ok)">'+S.chatUnread+'</div><div class="stat-label">Unread Messages</div></div>';
  h+='<div class="stat-card"><div class="stat-val" style="color:var(--purple)">'+S.shipments.length+'</div><div class="stat-label">Shipments</div></div>';
  h+='</div>';

  // Quick actions
  h+='<div class="card"><div class="card-h">Quick Actions</div><div class="card-b"><div class="grid-4">';
  h+='<div style="text-align:center;padding:16px;border-radius:var(--r-s);background:rgba(0,212,255,.05);border:1px solid rgba(0,212,255,.15);cursor:pointer" onclick="B.nav(\'deals\')"><div style="font-size:24px;margin-bottom:6px">&#x1F680;</div><div style="font-weight:700;font-size:12px;color:var(--pri)">Sourcing Pipeline</div>'+(activeDeals?'<div style="font-size:10px;color:var(--acc);margin-top:2px">'+activeDeals+' active</div>':'')+'</div>';
  h+='<div style="text-align:center;padding:16px;border-radius:var(--r-s);background:var(--w08);cursor:pointer" onclick="B.nav(\'search\')"><div style="font-size:24px;margin-bottom:6px">&#x1F50D;</div><div style="font-weight:700;font-size:12px">Search Products</div></div>';
  h+='<div style="text-align:center;padding:16px;border-radius:var(--r-s);background:var(--w08);cursor:pointer" onclick="B.nav(\'messages\')"><div style="font-size:24px;margin-bottom:6px">&#x1F4AC;</div><div style="font-weight:700;font-size:12px">Messages</div>'+(S.chatUnread?'<div style="font-size:10px;color:var(--err);margin-top:2px">'+S.chatUnread+' unread</div>':'')+'</div>';
  h+='<div style="text-align:center;padding:16px;border-radius:var(--r-s);background:var(--w08);cursor:pointer" onclick="B.nav(\'orders\')"><div style="font-size:24px;margin-bottom:6px">&#x1F4E6;</div><div style="font-weight:700;font-size:12px">Orders</div></div>';
  h+='</div></div></div>';

  // Recent inquiries
  if(S.inquiries.length){
    h+='<div class="card"><div class="card-h">Recent Inquiries</div><div>';
    S.inquiries.slice(0,5).forEach(function(inq){
      var st=inq.status||'pending';
      var stCls=st==='completed'?'badge-ok':st==='in_progress'?'badge-acc':'badge-ghost';
      h+='<div class="inquiry-list-item" onclick="B.showInquiryDetail(\''+inq.id+'\')">';
      h+='<div style="flex:1"><div style="font-weight:600;font-size:13px">'+esc(inq.product_query||inq.inquiry_type||'Inquiry')+'</div><div style="font-size:11px;color:var(--w40)">'+formatDate(inq.created_at)+'</div></div>';
      h+='<span class="badge '+stCls+'">'+st.replace('_',' ')+'</span>';
      h+='</div>';
    });
    h+='</div></div>';
  }

  return h;
}

/* === PRODUCT SEARCH === */
function pgSearch(){
  var h='';

  // Search bar
  h+='<div class="filter-row"><div class="search-box"><input class="form-input" id="searchInput" placeholder="Search Korean products... (e.g., snail cream, sheet mask, red ginseng)" value="'+esc(S.searchQuery)+'" onkeydown="if(event.key===\'Enter\')B.doSearch()"></div><button class="btn btn-pri" onclick="B.doSearch()">Search</button></div>';

  // Source tabs
  h+='<div class="source-tab">';
  h+='<div class="source-tab-item'+(S.searchSource==='all'?' active':'')+'" onclick="B.setSource(\'all\')">All Results</div>';
  h+='<div class="source-tab-item'+(S.searchSource==='whistle'?' active':'')+'" onclick="B.setSource(\'whistle\')">&#x1F3C5; Whistle Verified</div>';
  h+='<div class="source-tab-item'+(S.searchSource==='naver'?' active':'')+'" onclick="B.setSource(\'naver\')">&#x1F1F0;&#x1F1F7; Korea Market</div>';
  h+='</div>';

  if(S.searching){
    h+='<div style="text-align:center;padding:40px;color:var(--w40)"><div style="font-size:28px;margin-bottom:8px">&#x1F50D;</div>Searching...</div>';
    return h;
  }

  // No search yet
  if(!S.searchQuery&&!S.whistleResults.length&&!S.naverResults.length){
    h+='<div style="text-align:center;padding:60px 20px"><div style="font-size:48px;margin-bottom:16px">&#x1F50D;</div><h3 style="font-size:18px;font-weight:700;margin-bottom:8px">Search Korean Products</h3><p style="font-size:13px;color:var(--w40);max-width:400px;margin:0 auto 20px">Search from verified Whistle products and the entire Korean e-commerce market powered by Naver Shopping API.</p>';
    h+='<div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap">';
    ['Snail Cream','Sheet Mask','Red Ginseng','Sunscreen SPF50','Vitamin C Serum','Rice Water','Green Tea'].forEach(function(kw){
      h+='<button class="btn btn-ghost btn-sm" onclick="B.quickSearch(\''+kw+'\')">'+kw+'</button>';
    });
    h+='</div></div>';

    // Show Whistle products by default
    h+='<div style="margin-top:24px"><div style="font-weight:700;font-size:14px;margin-bottom:12px">&#x1F3C5; Featured Whistle Verified Products</div>';
    h+=renderWhistleProducts(S.whistleResults.length?S.whistleResults:[]);
    h+='</div>';
    if(!S.whistleResults.length)loadWhistleProducts('');
    return h;
  }

  // Results
  var products=[];
  if(S.searchSource==='all'){products=mergeResults();}
  else if(S.searchSource==='whistle'){products=S.whistleResults.map(function(p){return{source:'whistle',data:p};});}
  else{products=S.naverResults.map(function(p){return{source:'naver',data:p};});}

  if(!products.length){
    h+='<div style="text-align:center;padding:40px;color:var(--w40)"><div style="font-size:28px;margin-bottom:8px">&#x1F4ED;</div>No products found for "'+esc(S.searchQuery)+'"</div>';
    return h;
  }

  h+='<div style="font-size:12px;color:var(--w40);margin-bottom:12px">'+products.length+' products found for "'+esc(S.searchQuery)+'"</div>';
  h+='<div class="product-grid">';
  products.forEach(function(item){
    h+=renderProductCard(item.source,item.data);
  });
  h+='</div>';
  return h;
}

function mergeResults(){
  var all=[];
  S.whistleResults.forEach(function(p){all.push({source:'whistle',data:p});});
  S.naverResults.forEach(function(p){all.push({source:'naver',data:p});});
  return all;
}

function renderWhistleProducts(products){
  if(!products.length)return '<div style="text-align:center;padding:30px;color:var(--w40);font-size:13px">Loading products...</div>';
  var h='<div class="product-grid">';
  products.forEach(function(p){h+=renderProductCard('whistle',p);});
  h+='</div>';
  return h;
}

function renderProductCard(source,p){
  var h='<div class="product-card">';
  // Image
  if(source==='whistle'){
    var img=p.images&&p.images[0];
    h+=img?'<img class="product-img" src="'+esc(img)+'" onerror="this.style.display=\'none\'">':'<div class="product-img-placeholder">&#x1F4E6;</div>';
  } else {
    h+=p.image?'<img class="product-img" src="'+esc(p.image)+'" onerror="this.style.display=\'none\'">':'<div class="product-img-placeholder">&#x1F6CD;</div>';
  }
  // Source badge
  if(source==='whistle'){
    h+='<div style="margin-bottom:8px"><span class="badge badge-pri">&#x1F3C5; Whistle Verified</span></div>';
  } else {
    h+='<div style="margin-bottom:8px;display:flex;gap:6px;flex-wrap:wrap"><span class="badge badge-acc">&#x1F1F0;&#x1F1F7; Korea Market</span>';
    if(p.origin==='verified')h+='<span class="origin-badge origin-verified">&#x2705; Made in Korea</span>';
    else if(p.origin==='likely_korean')h+='<span class="origin-badge origin-likely">&#x26A0;&#xFE0F; Korean Brand</span>';
    else h+='<span class="origin-badge origin-unknown">&#x2753; Unverified</span>';
    h+='</div>';
  }
  // Name
  if(source==='whistle'){
    h+='<div style="font-weight:700;font-size:14px;margin-bottom:4px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden">'+esc(p.name_en||p.name_ko||'Product')+'</div>';
    h+='<div style="font-size:11px;color:var(--w40);margin-bottom:8px">'+esc(p.category||'')+(p.hs_code?' | HS '+esc(p.hs_code):'')+'</div>';
  } else {
    h+='<div style="font-weight:700;font-size:14px;margin-bottom:4px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden">'+esc(stripHtml(p.title)||'Product')+'</div>';
    h+='<div style="font-size:11px;color:var(--w40);margin-bottom:8px">'+esc(p.category1||'')+(p.category2?' > '+esc(p.category2):'')+(p.mallName?' | '+esc(p.mallName):'')+'</div>';
  }
  // Price
  if(source==='whistle'){
    h+='<div style="margin-bottom:8px">'+(p.fob_price?'<span style="font-weight:800;color:var(--acc)">$'+p.fob_price+'</span><span style="font-size:10px;color:var(--w40)"> FOB/unit</span>':'<span style="font-size:12px;color:var(--w40)">Price on request</span>');
    if(p.moq)h+=' <span style="font-size:10px;color:var(--w40);margin-left:8px">MOQ: '+p.moq+'</span>';
    h+='</div>';
  } else {
    var priceKRW=parseInt(p.lprice)||0;
    h+='<div style="margin-bottom:8px"><span style="font-weight:800;color:var(--acc)">'+priceKRW.toLocaleString()+'</span><span style="font-size:10px;color:var(--w40)"> KRW (retail)</span>';
    if(p.hprice&&parseInt(p.hprice)>priceKRW)h+='<span style="font-size:10px;color:var(--w20);margin-left:4px">~'+parseInt(p.hprice).toLocaleString()+'</span>';
    h+='</div>';
  }
  // Certifications (whistle only)
  if(source==='whistle'&&p.certifications&&p.certifications.length){
    h+='<div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:8px">';
    p.certifications.slice(0,3).forEach(function(c){h+='<span class="badge badge-ok">'+esc(c.name||c)+'</span>';});
    h+='</div>';
  }
  // Maker/Brand (naver)
  if(source==='naver'&&(p.maker||p.brand)){
    h+='<div style="font-size:11px;color:var(--w40);margin-bottom:8px">'+(p.maker?'Maker: '+esc(p.maker):'')+(p.brand?(p.maker?' | ':'')+'Brand: '+esc(p.brand):'')+'</div>';
  }
  // Action buttons
  h+='<div style="display:flex;gap:6px">';
  if(source==='whistle'){
    h+='<button class="btn btn-pri btn-sm" style="flex:1" onclick="event.stopPropagation();B.openInquiry(\'whistle\',\''+p.id+'\')">Inquire</button>';
    h+='<button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();B.saveProduct(\'whistle\',\''+p.id+'\')">&#x1F4BE;</button>';
  } else {
    h+='<button class="btn btn-acc btn-sm" style="flex:1" onclick="event.stopPropagation();B.openInquiry(\'naver\',\''+esc(p.productId||'')+'\')">Factory Contact</button>';
    h+='<button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();B.saveProduct(\'naver\',\''+esc(p.productId||'')+'\')">&#x1F4BE;</button>';
  }
  h+='</div></div>';
  return h;
}

/* === SEARCH === */
function doSearch(){
  var q=document.getElementById('searchInput');
  if(!q)return;
  var query=q.value.trim();
  if(!query)return;
  S.searchQuery=query;S.searching=true;render();
  // Search both sources in parallel
  var done=0,total=2;
  function checkDone(){done++;if(done>=total){S.searching=false;render();}}
  loadWhistleProducts(query,checkDone);
  loadNaverProducts(query,checkDone);
}

function quickSearch(kw){
  S.searchQuery=kw;
  render();
  setTimeout(function(){
    var inp=document.getElementById('searchInput');
    if(inp)inp.value=kw;
    doSearch();
  },50);
}

function setSource(src){set({searchSource:src});}

function loadWhistleProducts(query,cb){
  var q=sb.from('products').select('*').eq('is_public',true).eq('status','active');
  if(query){var sq=query.replace(/[%_(),.*\\]/g,'');if(sq)q=q.or('name_en.ilike.%'+sq+'%,name_ko.ilike.%'+sq+'%,category.ilike.%'+sq+'%,description_en.ilike.%'+sq+'%');}
  q.order('created_at',{ascending:false}).limit(40).then(function(r){
    S.whistleResults=r.data||[];
    if(cb)cb();else render();
  });
}

function loadNaverProducts(query,cb){
  fetch(RELAY+'/api/naver/search?q='+encodeURIComponent(query)+'&display=40',{headers:{'ngrok-skip-browser-warning':'1'}}).then(function(r){return r.json();}).then(function(data){
    if(data.ok&&data.items){S.naverResults=data.items;}
    else{S.naverResults=[];}
    if(cb)cb();else render();
  }).catch(function(){S.naverResults=[];if(cb)cb();else render();});
}

/* === INQUIRY SYSTEM === */
function openInquiry(source,id){
  var product=null;
  if(source==='whistle'){
    product=S.whistleResults.find(function(p){return p.id===id;})||S.savedProducts.find(function(sp){return sp.product_id===id;});
  } else {
    product=S.naverResults.find(function(p){return(p.productId||'')==id;});
    if(!product){
      var sp=S.savedProducts.find(function(sp){return sp.naver_product_data&&(sp.naver_product_data.productId||'')==id;});
      if(sp)product=sp.naver_product_data;
    }
  }
  S.modal='inquiry';S.modalData={source:source,product:product,id:id};S.inquiryType='import';render();
}

function openCustomSourcing(){
  S.modal='inquiry';S.modalData={source:'custom',product:null,id:null};S.inquiryType='custom_sourcing';render();
}

function renderModal(){
  if(S.modal==='inquiry')return renderInquiryModal();
  if(S.modal==='marketplace_request')return renderMarketplaceModal();
  if(S.modal==='inquiryDetail')return renderInquiryDetailModal();
  if(S.modal==='orderDetail')return renderOrderDetailModal();
  if(S.modal==='docDetail')return renderDocDetailModal();
  return '';
}

function renderInquiryModal(){
  var d=S.modalData||{};
  var p=d.product;
  var h='<div class="modal-overlay" onclick="B.closeModal()"><div class="modal" onclick="event.stopPropagation()">';
  h+='<div class="modal-h"><span>Submit Inquiry</span><button class="modal-close" onclick="B.closeModal()">&#x2715;</button></div>';
  h+='<div class="modal-b">';

  // Product preview
  if(p){
    h+='<div style="display:flex;gap:12px;padding:12px;border-radius:var(--r-s);background:var(--w08);margin-bottom:16px">';
    var img=d.source==='whistle'?(p.images&&p.images[0]):p.image;
    h+=img?'<img src="'+esc(img)+'" style="width:60px;height:60px;object-fit:cover;border-radius:8px">':'<div style="width:60px;height:60px;border-radius:8px;background:var(--w08);display:flex;align-items:center;justify-content:center">&#x1F4E6;</div>';
    h+='<div style="flex:1"><div style="font-weight:700;font-size:13px">'+esc(d.source==='whistle'?(p.name_en||p.name_ko):stripHtml(p.title)||'Product')+'</div>';
    if(d.source==='whistle'){h+='<div style="font-size:11px;color:var(--w40)"><span class="badge badge-pri" style="font-size:9px">Whistle Verified</span></div>';}
    else{h+='<div style="font-size:11px;color:var(--w40)"><span class="badge badge-acc" style="font-size:9px">Korea Market</span></div>';}
    h+='</div></div>';
  }

  // Inquiry type selection
  h+='<div style="font-weight:600;font-size:13px;margin-bottom:10px">How can we help?</div>';

  var types=[
    {id:'import',icon:'&#x1F6A2;',title:'Import This Product',desc:'Import the product as-is to your country'},
    {id:'factory_contact',icon:'&#x1F3ED;',title:'Connect with Factory',desc:'OEM/ODM partnership or direct factory contact ($200~700)'},
    {id:'custom_sourcing',icon:'&#x1F50D;',title:'Custom Sourcing',desc:'Find products matching your specific requirements'}
  ];
  types.forEach(function(t){
    h+='<div class="inquiry-type-card'+(S.inquiryType===t.id?' selected':'')+'" onclick="B.set({inquiryType:\''+t.id+'\'})">';
    h+='<div style="display:flex;align-items:center;gap:10px"><span style="font-size:20px">'+t.icon+'</span><div><div style="font-weight:700;font-size:13px">'+t.title+'</div><div style="font-size:11px;color:var(--w40)">'+t.desc+'</div></div></div></div>';
  });

  // Form
  h+='<form onsubmit="event.preventDefault();B.submitInquiry(this)" style="margin-top:16px">';
  h+='<input type="hidden" name="inquiry_type" value="'+S.inquiryType+'">';

  if(S.inquiryType==='import'){
    h+='<div class="grid-2"><div class="form-group"><label class="form-label">Quantity (units) *</label><input class="form-input" name="quantity" type="number" placeholder="e.g., 1000" required></div><div class="form-group"><label class="form-label">Destination Country</label><input class="form-input" name="destination" value="'+esc(S.user.country||'')+'" placeholder="e.g., US"></div></div>';
    h+='<div class="form-group"><label class="form-label">Target Price (USD/unit)</label><input class="form-input" name="target_price" placeholder="e.g., $3-5"></div>';
  } else if(S.inquiryType==='factory_contact'){
    h+='<div class="form-group"><label class="form-label">Purpose</label><select class="form-select" name="purpose"><option value="OEM">OEM (My brand, their product)</option><option value="ODM">ODM (Custom formulation)</option><option value="Direct">Direct purchase from factory</option></select></div>';
    h+='<div class="grid-2"><div class="form-group"><label class="form-label">Quantity</label><input class="form-input" name="quantity" type="number" placeholder="e.g., 5000"></div><div class="form-group"><label class="form-label">Destination</label><input class="form-input" name="destination" value="'+esc(S.user.country||'')+'" placeholder="e.g., US"></div></div>';
    h+='<div class="form-group"><label class="form-label">Specifications</label><textarea class="form-textarea" name="specs" placeholder="Packaging, labeling, ingredients requirements..."></textarea></div>';
  } else {
    h+='<div class="form-group"><label class="form-label">What are you looking for? *</label><textarea class="form-textarea" name="requirements" required placeholder="Describe the type of product, target market, any specific requirements..."></textarea></div>';
    h+='<div class="grid-2"><div class="form-group"><label class="form-label">Budget Range</label><input class="form-input" name="budget" placeholder="e.g., $5,000-10,000"></div><div class="form-group"><label class="form-label">Timeline</label><select class="form-select" name="timeline"><option value="1month">Within 1 month</option><option value="3months">Within 3 months</option><option value="6months">Within 6 months</option><option value="flexible">Flexible</option></select></div></div>';
    h+='<div class="form-group"><label class="form-label">Destination Country</label><input class="form-input" name="destination" value="'+esc(S.user.country||'')+'" placeholder="e.g., US"></div>';
  }

  h+='<div class="form-group"><label class="form-label">Additional Message</label><textarea class="form-textarea" name="message" placeholder="Any additional details or questions..."></textarea></div>';
  h+='<button class="btn btn-pri btn-block btn-lg" type="submit">Submit Inquiry</button>';
  h+='</form></div></div></div>';
  return h;
}

function submitInquiry(f){
  if(S._submitting)return;S._submitting=true;
  var d=S.modalData||{};
  var p=d.product;
  var fd=new FormData(f);
  var data={};fd.forEach(function(v,k){data[k]=v;});

  var req={
    buyer_id:S.user.id,
    inquiry_type:data.inquiry_type||'import',
    destination_country:data.destination||S.user.country||'',
    target_moq:parseInt(data.quantity)||null,
    target_price:data.target_price||data.budget||null,
    status:'pending'
  };

  // Build message
  var msg='';
  if(data.purpose)msg+='Purpose: '+data.purpose+'\n';
  if(data.specs)msg+='Specs: '+data.specs+'\n';
  if(data.requirements)msg+='Requirements: '+data.requirements+'\n';
  if(data.timeline)msg+='Timeline: '+data.timeline+'\n';
  if(data.message)msg+=(msg?'\n':'')+data.message;
  req.message=msg;

  // Product info
  if(d.source==='whistle'&&p){
    req.product_id=p.id;
    req.product_query=(p.name_en||p.name_ko||'')+(p.category?' ('+p.category+')':'');
  } else if(d.source==='naver'&&p){
    req.naver_product_data=p;
    req.product_query=p.title||'Naver product';
  } else {
    req.product_query=data.requirements||'Custom sourcing request';
  }

  sb.from('contact_requests').insert(req).then(function(r){
    S._submitting=false;
    if(r.error){toast('Failed to submit: '+r.error.message,'err');return;}
    // Also notify via relay server
    fetch(RELAY+'/api/naver/contact-request',{method:'POST',headers:{'Content-Type':'application/json','ngrok-skip-browser-warning':'1'},body:JSON.stringify({
      buyer_name:S.user.display_name,buyer_email:S.user.email,buyer_company:S.user.company_name,
      inquiry_type:data.inquiry_type,product_name:req.product_query,message:msg,
      destination_country:req.destination_country,target_moq:req.target_moq,target_price:req.target_price
    })}).catch(function(){});
    toast('Inquiry submitted successfully!','ok');
    S.modal=null;S.modalData=null;
    loadInquiries();
  }).catch(function(){S._submitting=false;});
}

function closeModal(elId){if(elId){var el=document.getElementById(elId);if(el)el.remove();}S.modal=null;S.modalData=null;render();}

/* === SAVE PRODUCT === */
function saveProduct(source,id){
  if(!S.user){toast('Please sign in','err');return;}
  var rec={user_id:S.user.id,source:source};
  if(source==='whistle'){
    rec.product_id=id;
  } else {
    var p=S.naverResults.find(function(x){return(x.productId||'')==id;});
    rec.naver_product_data=p||{productId:id};
  }
  sb.from('buyer_saved_products').insert(rec).then(function(r){
    if(r.error){
      if(r.error.message&&r.error.message.includes('duplicate'))toast('Already saved','warn');
      else toast('Failed to save','err');
      return;
    }
    toast('Product saved!','ok');
    loadSavedProducts();
  });
}

function unsaveProduct(saveId){
  sb.from('buyer_saved_products').delete().eq('id',saveId).then(function(r){
    if(r.error){toast('Failed to remove','err');return;}
    toast('Removed from saved','ok');
    loadSavedProducts();
  });
}

/* === MY INQUIRIES === */
function pgInquiries(){
  var h='';
  var statuses=['all','pending','in_progress','completed'];
  h+='<div style="display:flex;gap:8px;margin-bottom:16px">';
  statuses.forEach(function(st){
    var cnt=st==='all'?S.inquiries.length:S.inquiries.filter(function(i){return i.status===st;}).length;
    var active=(!S._inqFilter&&st==='all')||(S._inqFilter===st);
    h+='<button class="btn btn-sm '+(active?'btn-pri':'btn-ghost')+'" onclick="B._inqFilter=\''+st+'\';B.render()">'+st.replace('_',' ')+' ('+cnt+')</button>';
  });
  h+='</div>';

  var list=S.inquiries;
  if(S._inqFilter&&S._inqFilter!=='all')list=list.filter(function(i){return i.status===S._inqFilter;});

  if(!list.length){
    h+='<div style="text-align:center;padding:40px;color:var(--w40)"><div style="font-size:28px;margin-bottom:8px">&#x1F4CB;</div>No inquiries'+(S._inqFilter&&S._inqFilter!=='all'?' with status "'+S._inqFilter+'"':'')+'<br><button class="btn btn-pri" style="margin-top:12px" onclick="B.nav(\'search\')">Search Products</button></div>';
    return h;
  }

  h+='<div class="card"><div>';
  list.forEach(function(inq){
    var st=inq.status||'pending';
    var stCls=st==='completed'?'badge-ok':st==='in_progress'?'badge-acc':st==='cancelled'?'badge-err':'badge-ghost';
    var typeLbl=inq.inquiry_type==='factory_contact'?'&#x1F3ED; Factory Contact':inq.inquiry_type==='custom_sourcing'?'&#x1F50D; Custom Sourcing':'&#x1F6A2; Import';
    h+='<div class="inquiry-list-item" onclick="B.showInquiryDetail(\''+inq.id+'\')">';
    h+='<div style="flex:1"><div style="font-weight:600;font-size:13px">'+esc(inq.product_query||'Inquiry')+'</div>';
    h+='<div style="font-size:11px;color:var(--w40);margin-top:2px">'+typeLbl+' &middot; '+formatDate(inq.created_at)+'</div></div>';
    h+='<span class="badge '+stCls+'">'+st.replace('_',' ')+'</span>';
    h+='</div>';
  });
  h+='</div></div>';
  return h;
}

function showInquiryDetail(id){
  var inq=S.inquiries.find(function(i){return i.id===id;});
  if(!inq)return;
  S.modal='inquiryDetail';S.modalData=inq;render();
}

function renderInquiryDetailModal(){
  var inq=S.modalData;
  if(!inq)return '';
  var st=inq.status||'pending';
  var stCls=st==='completed'?'badge-ok':st==='in_progress'?'badge-acc':st==='cancelled'?'badge-err':'badge-ghost';
  var typeLbl=inq.inquiry_type==='factory_contact'?'Factory Contact':inq.inquiry_type==='custom_sourcing'?'Custom Sourcing':'Import';

  var h='<div class="modal-overlay" onclick="B.closeModal()"><div class="modal" onclick="event.stopPropagation()">';
  h+='<div class="modal-h"><span>Inquiry Details</span><button class="modal-close" onclick="B.closeModal()">&#x2715;</button></div>';
  h+='<div class="modal-b">';

  h+='<div style="display:flex;align-items:center;gap:10px;margin-bottom:16px"><span class="badge '+stCls+'" style="font-size:12px">'+st.replace('_',' ')+'</span><span class="badge badge-purple">'+typeLbl+'</span></div>';
  h+='<div class="form-group"><div class="form-label">Product</div><div style="font-size:14px;font-weight:600">'+esc(inq.product_query||'N/A')+'</div></div>';
  if(inq.destination_country)h+='<div class="form-group"><div class="form-label">Destination</div><div>'+esc(inq.destination_country)+'</div></div>';
  if(inq.target_moq)h+='<div class="form-group"><div class="form-label">Target MOQ</div><div>'+inq.target_moq+' units</div></div>';
  if(inq.target_price)h+='<div class="form-group"><div class="form-label">Target Price</div><div>'+esc(inq.target_price)+'</div></div>';
  if(inq.message)h+='<div class="form-group"><div class="form-label">Message</div><div style="white-space:pre-wrap;font-size:13px;color:var(--w70)">'+esc(inq.message)+'</div></div>';
  h+='<div class="form-group"><div class="form-label">Submitted</div><div style="font-size:13px;color:var(--w40)">'+formatDate(inq.created_at)+'</div></div>';

  // Naver product data
  if(inq.naver_product_data){
    var np=inq.naver_product_data;
    h+='<div style="margin-top:12px;padding:12px;border-radius:var(--r-s);background:var(--w08)"><div style="font-size:11px;color:var(--acc);font-weight:600;margin-bottom:8px">Korea Market Product</div>';
    if(np.image)h+='<img src="'+esc(np.image)+'" style="width:80px;height:80px;object-fit:cover;border-radius:8px;margin-bottom:8px">';
    h+='<div style="font-size:13px;font-weight:600">'+esc(stripHtml(np.title)||'')+'</div>';
    if(np.maker)h+='<div style="font-size:11px;color:var(--w40)">Maker: '+esc(np.maker)+'</div>';
    if(np.brand)h+='<div style="font-size:11px;color:var(--w40)">Brand: '+esc(np.brand)+'</div>';
    if(np.lprice)h+='<div style="font-size:11px;color:var(--w40)">Price: '+parseInt(np.lprice).toLocaleString()+' KRW</div>';
    h+='</div>';
  }

  h+='<div style="margin-top:16px;padding:14px;border-radius:var(--r-s);background:rgba(0,212,255,.05);border:1px solid rgba(0,212,255,.1)"><div style="font-size:12px;color:var(--pri);font-weight:600">What happens next?</div><div style="font-size:12px;color:var(--w60);margin-top:4px">';
  if(st==='pending')h+='Our team is reviewing your inquiry. We\'ll contact you within 24 hours.';
  else if(st==='in_progress')h+='We are actively working on your request. You\'ll receive updates via email.';
  else if(st==='completed')h+='This inquiry has been completed. Thank you for using Whistle AI!';
  else h+='This inquiry has been cancelled.';
  h+='</div></div>';

  h+='</div></div></div>';
  return h;
}

/* === MARKETPLACE (바이어 요청 장터) === */
function loadMyRequests(){
  if(!S.user)return;
  sb.from('buyer_requests').select('*').eq('buyer_user_id',S.user.id)
    .order('created_at',{ascending:false}).then(function(r){
    S.myRequests=r.data||[];render();
  });
}
function loadRequestProposals(reqId){
  sb.from('buyer_request_proposals').select('*').eq('request_id',reqId)
    .order('created_at',{ascending:true}).then(function(r){
    S.requestProposals[reqId]=r.data||[];render();
  });
}

function pgMarketplace(){
  if(S._viewRequest)return pgMarketRequestDetail();
  var h='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">';
  h+='<div><h2 style="font-size:18px;font-weight:800">&#x1F3EA; Request Board</h2>';
  h+='<p style="font-size:12px;color:var(--w40);margin-top:2px">Post sourcing requests and receive proposals from Korean manufacturers</p></div>';
  h+='<button class="btn btn-pri" onclick="B.showRequestForm()">+ New Request</button></div>';
  // filter tabs
  var filters=['all','open','closed','completed'];
  h+='<div style="display:flex;gap:8px;margin-bottom:16px">';
  filters.forEach(function(f){
    var cnt=f==='all'?S.myRequests.length:S.myRequests.filter(function(r){return r.status===f;}).length;
    var active=(S._reqFilter===f);
    h+='<button class="btn btn-sm '+(active?'btn-pri':'btn-ghost')+'" onclick="B.set({_reqFilter:\''+f+'\'})">'+f.charAt(0).toUpperCase()+f.slice(1)+' ('+cnt+')</button>';
  });
  h+='</div>';
  var list=S.myRequests;
  if(S._reqFilter&&S._reqFilter!=='all')list=list.filter(function(r){return r.status===S._reqFilter;});
  if(!list.length){
    h+='<div style="text-align:center;padding:60px;color:var(--w40)"><div style="font-size:36px;margin-bottom:12px">&#x1F3EA;</div>';
    h+='<h3 style="font-weight:700;margin-bottom:8px">No requests yet</h3><p style="font-size:13px">Post your first sourcing request to receive proposals from manufacturers.</p>';
    h+='<button class="btn btn-pri" style="margin-top:12px" onclick="B.showRequestForm()">Post Request</button></div>';
    return h;
  }
  list.forEach(function(r){
    var stColor={open:'var(--ok)',closed:'var(--w40)',expired:'var(--err)',completed:'var(--pri)',cancelled:'var(--err)'};
    h+='<div class="card" style="margin-bottom:12px;cursor:pointer" onclick="B.viewRequest(\''+r.id+'\')">';
    h+='<div class="card-b"><div style="display:flex;justify-content:space-between;align-items:start">';
    h+='<div><div style="font-size:15px;font-weight:700;margin-bottom:4px">'+esc(r.title)+'</div>';
    h+='<div style="font-size:12px;color:var(--w40)">'+esc(r.category||'')+' · '+(r.target_quantity||'')+(r.target_market?' · '+esc(r.target_market):'')+'</div></div>';
    h+='<span class="badge" style="background:'+(stColor[r.status]||'var(--w40)')+'15;color:'+(stColor[r.status]||'var(--w40)')+'">'+r.status+'</span></div>';
    h+='<div style="display:flex;gap:16px;margin-top:10px;font-size:12px;color:var(--w60)">';
    h+='<span>&#x1F4E8; '+r.proposal_count+' proposals</span>';
    h+='<span>'+timeAgo(r.created_at)+'</span>';
    if(r.is_urgent)h+='<span style="color:var(--err);font-weight:700">URGENT</span>';
    h+='</div></div></div>';
  });
  return h;
}

function pgMarketRequestDetail(){
  var req=S.myRequests.find(function(r){return r.id===S._viewRequest;});
  if(!req)return '<div>Not found</div>';
  var proposals=S.requestProposals[req.id]||[];
  var h='<div style="margin-bottom:16px"><button class="btn btn-ghost btn-sm" onclick="B.backToRequests()">&larr; Back to Requests</button></div>';
  // request info card
  h+='<div class="card" style="margin-bottom:20px"><div class="card-b">';
  h+='<div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px"><div style="font-size:18px;font-weight:800">'+esc(req.title)+'</div>';
  var stColor={open:'var(--ok)',closed:'var(--w40)',completed:'var(--pri)'};
  h+='<span class="badge" style="background:'+(stColor[req.status]||'var(--w40)')+'15;color:'+(stColor[req.status]||'var(--w40)')+'">'+req.status+'</span></div>';
  h+='<div style="font-size:13px;color:var(--w60);line-height:1.6;margin-bottom:16px">'+esc(req.description)+'</div>';
  h+='<div style="display:flex;gap:12px;flex-wrap:wrap;font-size:12px;color:var(--w40)">';
  if(req.category)h+='<span>&#x1F3F7; '+esc(req.category)+'</span>';
  if(req.target_quantity)h+='<span>&#x1F4E6; '+esc(req.target_quantity)+'</span>';
  if(req.target_price_range)h+='<span>&#x1F4B0; '+esc(req.target_price_range)+'</span>';
  if(req.target_market)h+='<span>&#x1F30D; '+esc(req.target_market)+'</span>';
  if(req.product_type)h+='<span>&#x1F3ED; '+esc(req.product_type)+'</span>';
  h+='</div>';
  if(req.status==='open')h+='<div style="margin-top:12px"><button class="btn btn-ghost btn-sm" style="color:var(--err)" onclick="B.closeRequest(\''+req.id+'\')">Close Request</button></div>';
  h+='</div></div>';
  // proposals
  h+='<div style="font-size:14px;font-weight:700;margin-bottom:12px">&#x1F4E8; Proposals ('+proposals.length+')</div>';
  if(!proposals.length){
    h+='<div style="text-align:center;padding:40px;color:var(--w40)"><p>No proposals yet. Manufacturers will see your request and submit proposals.</p></div>';
    return h;
  }
  proposals.forEach(function(p){
    var pColor={pending:'var(--acc)',accepted:'var(--ok)',rejected:'var(--err)',viewed:'var(--pri)',withdrawn:'var(--w40)'};
    var pLabel={pending:'Pending',accepted:'Accepted',rejected:'Rejected',viewed:'Viewed',withdrawn:'Withdrawn'};
    h+='<div class="card" style="margin-bottom:10px"><div class="card-b">';
    h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">';
    h+='<div style="font-size:14px;font-weight:700">&#x1F3ED; '+esc(p.seller_company)+'</div>';
    h+='<span class="badge" style="background:'+(pColor[p.status]||'var(--w40)')+'15;color:'+(pColor[p.status]||'var(--w40)')+'">'+(pLabel[p.status]||p.status)+'</span></div>';
    h+='<div style="font-size:13px;color:var(--w60);line-height:1.6;margin-bottom:10px">'+esc(p.message)+'</div>';
    h+='<div style="display:flex;gap:12px;font-size:12px;color:var(--w40);margin-bottom:10px">';
    if(p.proposed_price)h+='<span>&#x1F4B0; '+esc(p.proposed_price)+'</span>';
    if(p.proposed_moq)h+='<span>&#x1F4E6; MOQ '+esc(p.proposed_moq)+'</span>';
    if(p.lead_time)h+='<span>&#x23F0; '+esc(p.lead_time)+'</span>';
    h+='<span>'+timeAgo(p.created_at)+'</span></div>';
    if(req.status==='open'&&p.status==='pending'){
      h+='<div style="display:flex;gap:8px">';
      h+='<button class="btn btn-pri btn-sm" onclick="event.stopPropagation();B.acceptProposal(\''+p.id+'\',\''+req.id+'\')">Accept</button>';
      h+='<button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();B.rejectProposal(\''+p.id+'\',\''+req.id+'\')">Reject</button>';
      h+='</div>';
    }
    h+='</div></div>';
  });
  return h;
}

function showRequestForm(){
  S.modal='marketplace_request';S.modalData={};render();
}

function renderMarketplaceModal(){
  if(S.modal!=='marketplace_request')return '';
  var h='<div class="modal-overlay" onclick="B.closeModal()">';
  h+='<div class="modal-content" onclick="event.stopPropagation()" style="max-width:520px">';
  h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px"><div style="font-size:18px;font-weight:800">&#x1F3EA; New Sourcing Request</div>';
  h+='<div class="modal-close" onclick="B.closeModal()">&#x2715;</div></div>';
  h+='<form id="mkt-form" onsubmit="event.preventDefault();B.submitRequest()">';
  h+='<div class="form-group"><label>Title *</label><input name="title" placeholder="e.g. Snail Cream OEM 5000 units" class="input" required></div>';
  h+='<div class="form-row"><div class="form-group"><label>Category</label><select name="category" class="input"><option value="">Select</option>';
  ['K-Beauty','K-Food','K-Health','K-Fashion','K-Electronics','K-Living'].forEach(function(c){h+='<option value="'+c+'">'+c+'</option>';});
  h+='</select></div>';
  h+='<div class="form-group"><label>Product Type</label><select name="product_type" class="input"><option value="">Select</option>';
  ['OEM','ODM','Finished Product','Raw Material'].forEach(function(t){h+='<option value="'+t+'">'+t+'</option>';});
  h+='</select></div></div>';
  h+='<div class="form-group"><label>Description *</label><textarea name="description" placeholder="Describe what you are looking for in detail..." class="input" rows="4" required></textarea></div>';
  h+='<div class="form-row"><div class="form-group"><label>Target Quantity</label><input name="target_quantity" placeholder="e.g. 5000 units" class="input"></div>';
  h+='<div class="form-group"><label>Price Range</label><input name="target_price_range" placeholder="e.g. $3-5 FOB" class="input"></div></div>';
  h+='<div class="form-row"><div class="form-group"><label>Target Market</label><select name="target_market" class="input"><option value="">Select</option>';
  [['US','USA'],['JP','Japan'],['EU','Europe'],['CN','China'],['SEA','Southeast Asia'],['ME','Middle East'],['SA','South America']].forEach(function(c){h+='<option value="'+c[0]+'">'+c[1]+'</option>';});
  h+='</select></div>';
  h+='<div class="form-group"><label>Deadline</label><input type="date" name="deadline" class="input"></div></div>';
  h+='<div class="form-group"><label style="display:flex;align-items:center;gap:8px"><input type="checkbox" name="is_urgent"> Mark as Urgent</label></div>';
  h+='<button type="submit" class="btn btn-pri" style="width:100%;padding:14px;font-size:15px;margin-top:8px">Post Request</button>';
  h+='</form></div></div>';
  return h;
}

function submitRequest(){
  var form=document.getElementById('mkt-form');
  if(!form)return;
  var fd=new FormData(form);
  var title=fd.get('title');var desc=fd.get('description');
  if(!title||!desc){toast('Title and description are required','warn');return;}
  var req={
    buyer_user_id:S.user.id,
    buyer_company:S.user.company_name||S.user.display_name||S.user.email,
    buyer_country:S.user.country||'',
    buyer_display_name:S.user.display_name||'',
    title:title,
    category:fd.get('category')||null,
    description:desc,
    target_quantity:fd.get('target_quantity')||null,
    target_price_range:fd.get('target_price_range')||null,
    target_market:fd.get('target_market')||null,
    product_type:fd.get('product_type')||null,
    deadline:fd.get('deadline')||null,
    is_urgent:!!form.querySelector('[name=is_urgent]').checked,
    status:'open'
  };
  sb.from('buyer_requests').insert(req).then(function(r){
    if(r.error){toast('Failed: '+r.error.message,'err');return;}
    toast('Request posted!','ok');
    S.modal=null;
    loadMyRequests();
    fetch(RELAY+'/api/whistle/marketplace-notify',{method:'POST',headers:{'Content-Type':'application/json','ngrok-skip-browser-warning':'1'},
      body:JSON.stringify({type:'new_request',title:title,category:fd.get('category'),buyer:S.user.company_name,country:S.user.country})
    }).catch(function(){});
  });
}

function viewRequest(id){
  S._viewRequest=id;
  loadRequestProposals(id);
  render();
}
function backToRequests(){S._viewRequest=null;render();}

function acceptProposal(propId,reqId){
  if(!confirm('Accept this proposal?\n\nThis will create a sourcing deal and open communication with the manufacturer.'))return;
  var request=S.myRequests.find(function(r){return r.id===reqId;});
  var proposals=S.requestProposals[reqId]||[];
  var prop=proposals.find(function(p){return p.id===propId;});
  if(!prop||!request)return;
  // 1. Create buyer record
  sb.from('buyers').insert({
    registered_by:prop.seller_user_id,source:'marketplace',
    company_name:request.buyer_company,contact_name:request.buyer_display_name,
    email:S.user.email,country:request.buyer_country,
    buyer_user_id:S.user.id,
    categories:request.category?[request.category]:[],
    notes:'[Marketplace] '+request.title
  }).select().single().then(function(br){
    if(br.error){toast('Error: '+br.error.message,'err');return;}
    var newBuyer=br.data;
    // 2. Create matching
    sb.from('matchings').insert({
      user_id:prop.seller_user_id,buyer_id:newBuyer.id,
      product_id:prop.product_id||null,status:'interested',
      match_reason:'[Marketplace] '+request.title,match_score:80
    }).select().single().then(function(mr){
      if(mr.error){toast('Matching error: '+mr.error.message,'err');return;}
      // 3. Update proposal
      sb.from('buyer_request_proposals').update({status:'accepted',matching_id:mr.data.id,buyer_id:newBuyer.id,updated_at:new Date().toISOString()}).eq('id',propId).then(function(){});
      // 4. Reject others
      sb.from('buyer_request_proposals').update({status:'rejected',updated_at:new Date().toISOString()}).eq('request_id',reqId).neq('id',propId).then(function(){});
      // 5. Close request
      sb.from('buyer_requests').update({status:'completed',accepted_proposal_id:propId,updated_at:new Date().toISOString()}).eq('id',reqId).then(function(){});
      // 6. Notify seller
      fetch(RELAY+'/api/whistle/notify',{method:'POST',headers:{'Content-Type':'application/json','ngrok-skip-browser-warning':'1'},
        body:JSON.stringify({userId:prop.seller_user_id,type:'marketplace',title:'Proposal accepted: '+request.title,body:request.buyer_company+' accepted your proposal. Start the deal!',linkPage:'buyers',telegram:true})
      }).catch(function(){});
      toast('Proposal accepted! Deal pipeline started.','ok');
      loadMyRequests();loadBuyerLinks();loadMatchings();
    });
  });
}

function rejectProposal(propId,reqId){
  if(!confirm('Reject this proposal?\n\nThe seller will be notified. You can still accept other proposals.'))return;
  sb.from('buyer_request_proposals').update({status:'rejected',updated_at:new Date().toISOString()}).eq('id',propId).then(function(r){
    if(r.error){toast('Error','err');return;}
    toast('Proposal rejected','ok');
    loadRequestProposals(reqId);
  });
}

function closeRequest(reqId){
  if(!confirm('Close this request? No more proposals will be received.'))return;
  sb.from('buyer_requests').update({status:'closed',updated_at:new Date().toISOString()}).eq('id',reqId).then(function(r){
    if(r.error){toast('Error','err');return;}
    toast('Request closed','ok');
    S._viewRequest=null;loadMyRequests();
  });
}

/* === SAVED PRODUCTS === */
function pgSaved(){
  if(!S.savedProducts.length){
    return '<div style="text-align:center;padding:60px 20px;color:var(--w40)"><div style="font-size:36px;margin-bottom:12px">&#x1F4BE;</div><h3 style="font-weight:700;margin-bottom:8px">No Saved Products</h3><p style="font-size:13px">Save products while browsing to compare them later.</p><button class="btn btn-pri" style="margin-top:12px" onclick="B.nav(\'search\')">Browse Products</button></div>';
  }

  var h='<div style="font-size:12px;color:var(--w40);margin-bottom:12px">'+S.savedProducts.length+' saved product(s)</div>';
  h+='<div class="product-grid">';
  S.savedProducts.forEach(function(sp){
    h+='<div class="product-card">';
    if(sp.source==='naver'&&sp.naver_product_data){
      var np=sp.naver_product_data;
      h+=np.image?'<img class="product-img" src="'+esc(np.image)+'" onerror="this.style.display=\'none\'">':'<div class="product-img-placeholder">&#x1F6CD;</div>';
      h+='<div style="margin-bottom:6px"><span class="badge badge-acc">&#x1F1F0;&#x1F1F7; Korea Market</span></div>';
      h+='<div style="font-weight:700;font-size:14px;margin-bottom:4px">'+esc(stripHtml(np.title)||'Product')+'</div>';
      if(np.lprice)h+='<div style="margin-bottom:8px"><span style="font-weight:800;color:var(--acc)">'+parseInt(np.lprice).toLocaleString()+'</span><span style="font-size:10px;color:var(--w40)"> KRW</span></div>';
      h+='<div style="display:flex;gap:6px"><button class="btn btn-acc btn-sm" style="flex:1" onclick="B.openInquiry(\'naver\',\''+(np.productId||'')+'\')">Inquire</button><button class="btn btn-danger btn-sm" onclick="B.unsaveProduct(\''+sp.id+'\')">&#x1F5D1;</button></div>';
    } else {
      // Whistle product - would need to load from products table
      h+='<div class="product-img-placeholder">&#x1F4E6;</div>';
      h+='<div style="margin-bottom:6px"><span class="badge badge-pri">&#x1F3C5; Whistle Verified</span></div>';
      h+='<div style="font-weight:700;font-size:13px;margin-bottom:8px">Product ID: '+esc(sp.product_id||'')+'</div>';
      h+='<div style="display:flex;gap:6px"><button class="btn btn-pri btn-sm" style="flex:1" onclick="B.openInquiry(\'whistle\',\''+esc(sp.product_id||'')+'\')">Inquire</button><button class="btn btn-danger btn-sm" onclick="B.unsaveProduct(\''+sp.id+'\')">&#x1F5D1;</button></div>';
    }
    h+='</div>';
  });
  h+='</div>';
  return h;
}

/* === PROFILE === */
function pgProfile(){
  var u=S.user;
  var h='<div style="max-width:600px">';
  h+='<div class="card"><div class="card-h">Profile Information</div><div class="card-b">';
  h+='<form onsubmit="event.preventDefault();B.saveProfile(this)">';
  h+='<div class="grid-2"><div class="form-group"><label class="form-label">Company Name</label><input class="form-input" name="company_name" value="'+esc(u.company_name||'')+'"></div>';
  h+='<div class="form-group"><label class="form-label">Contact Name</label><input class="form-input" name="display_name" value="'+esc(u.display_name||'')+'"></div></div>';
  h+='<div class="form-group"><label class="form-label">Email</label><input class="form-input" value="'+esc(u.email||'')+'" disabled style="opacity:.5"></div>';
  h+='<div class="grid-2"><div class="form-group"><label class="form-label">Country</label><select class="form-select" name="country"><option value="">Select</option>';
  var countryNames={
    CN:'China', US:'United States', JP:'Japan', HK:'Hong Kong', VN:'Vietnam',
    RU:'Russia', TW:'Taiwan', TH:'Thailand', AE:'UAE', SG:'Singapore',
    DE:'Germany', FR:'France', GB:'United Kingdom', SE:'Sweden', NL:'Netherlands',
    IT:'Italy', ES:'Spain', NO:'Norway', DK:'Denmark', FI:'Finland', PL:'Poland',
    CA:'Canada', AU:'Australia', NZ:'New Zealand', BR:'Brazil', MX:'Mexico',
    IN:'India', ID:'Indonesia', MY:'Malaysia', PH:'Philippines', TR:'Turkey',
    SA:'Saudi Arabia', KW:'Kuwait', QA:'Qatar', EG:'Egypt', ZA:'South Africa',
    NG:'Nigeria', KE:'Kenya', CO:'Colombia', CL:'Chile', PE:'Peru',
    KR:'South Korea'
  };
  var countryCodes=Object.keys(countryNames);
  countryCodes.sort(function(a,b){return countryNames[a].localeCompare(countryNames[b]);});
  countryCodes.forEach(function(c){
    h+='<option value="'+c+'"'+(u.country===c?' selected':'')+'>'+(countryNames[c]||c)+'</option>';
  });
  h+='</select></div><div class="form-group"><label class="form-label">Phone</label><input class="form-input" name="phone" value="'+esc(u.phone||'')+'"></div></div>';
  h+='<button class="btn btn-pri" type="submit">Save Profile</button>';
  h+='</form></div></div>';

  // Change password
  h+='<div class="card"><div class="card-h">Change Password</div><div class="card-b">';
  h+='<form onsubmit="event.preventDefault();B.changePassword(this)">';
  h+='<div class="form-group"><label class="form-label">New Password</label><input class="form-input" name="password" type="password" placeholder="Min 6 characters" required></div>';
  h+='<div class="form-group"><label class="form-label">Confirm Password</label><input class="form-input" name="confirm" type="password" placeholder="Repeat password" required></div>';
  h+='<button class="btn btn-ghost" type="submit">Update Password</button>';
  h+='</form></div></div>';

  // My Plan & Pricing
  var planNames={free:'Free',starter:'Starter',basic:'Starter',pro:'Pro',enterprise:'Enterprise'};
  var planColors={free:'var(--w40)',starter:'var(--pri)',basic:'var(--pri)',pro:'var(--acc)',enterprise:'var(--purple)'};
  var curPlan=u.plan||'free';
  h+='<div class="card"><div class="card-h">My Plan</div><div class="card-b">';
  h+='<div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">';
  h+='<div style="padding:6px 16px;border-radius:20px;background:'+(planColors[curPlan]||'var(--w40)')+';color:var(--w);font-weight:800;font-size:14px">'+(planNames[curPlan]||'Free')+'</div>';
  h+='<div style="flex:1;font-size:12px;color:var(--w40)">'+(curPlan==='free'?'Upgrade to unlock more features':'Active subscription')+'</div>';
  if(curPlan!=='free')h+='<button class="btn btn-ghost btn-sm" onclick="B.openBillingPortal()" style="font-size:11px">Manage Billing</button>';
  h+='</div>';
  /* Plan comparison cards */
  var bPlans=[
    {id:'free',n:'Free',pr:'$0',desc:'1 search, 1 inquiry',c:'var(--w40)'},
    {id:'starter',n:'Starter',pr:'$29/mo',yp:'$23.20/mo (annual)',desc:'30 searches, 15 inquiries/mo',c:'var(--pri)'},
    {id:'pro',n:'Pro',pr:'$89/mo',yp:'$71.20/mo (annual)',desc:'200 searches, 50 inquiries/mo',c:'var(--acc)'},
    {id:'enterprise',n:'Enterprise',pr:'Custom',desc:'Unlimited everything',c:'var(--purple)'}
  ];
  h+='<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px;margin-bottom:14px">';
  bPlans.forEach(function(p){
    var isCur=(curPlan===p.id||(curPlan==='basic'&&p.id==='starter'));
    var isUp=bPlans.findIndex(function(x){return x.id===p.id;})>bPlans.findIndex(function(x){return x.id===curPlan||(curPlan==='basic'&&x.id==='starter');});
    h+='<div style="padding:12px;border-radius:10px;border:1px solid '+(isCur?p.c:'var(--bd)')+';background:'+(isCur?p.c+'10':'var(--w04)')+';text-align:center">';
    h+='<div style="font-size:11px;font-weight:800;color:'+p.c+';margin-bottom:4px">'+p.n+'</div>';
    h+='<div style="font-size:16px;font-weight:800;margin-bottom:2px">'+p.pr+'</div>';
    if(p.yp)h+='<div style="font-size:10px;color:var(--ok)">'+p.yp+'</div>';
    h+='<div style="font-size:10px;color:var(--w40);margin-top:4px">'+p.desc+'</div>';
    if(!isCur&&isUp&&p.id!=='enterprise')h+='<button class="btn btn-pri btn-sm btn-block" style="margin-top:8px;font-size:10px" onclick="B.openBuyerCheckout(\''+p.id+'\')">Upgrade</button>';
    else if(isCur)h+='<div style="margin-top:8px;font-size:10px;color:var(--w20)">Current</div>';
    else if(p.id==='enterprise')h+='<a href="mailto:contact@motiveinno.com" class="btn btn-ghost btn-sm btn-block" style="margin-top:8px;font-size:10px">Contact Us</a>';
    h+='</div>';
  });
  h+='</div>';
  h+='<div style="font-size:11px;color:var(--w30);margin-bottom:8px">Add-ons: Search pack (10) $9 · Trend report $19 · Factory contact $200~$700</div>';
  h+='<div style="font-size:11px;color:var(--w30)">Sourcing commission: &lt;$3K = $300 fixed · $3K~30K = 8% · $30K~100K = 5% · $100K+ = 3%</div>';
  h+='</div></div>';

  // Account info
  h+='<div class="card"><div class="card-h">Account</div><div class="card-b">';
  h+='<div style="font-size:12px;color:var(--w40)">Account ID: '+esc(u.id)+'</div>';
  h+='<div style="font-size:12px;color:var(--w40)">Role: '+esc(u.role||'buyer')+'</div>';
  h+='</div></div>';

  h+='</div>';
  return h;
}

function saveProfile(f){
  var fd=new FormData(f);
  var data={};fd.forEach(function(v,k){data[k]=v;});
  sb.from('users').update({company_name:data.company_name,display_name:data.display_name,country:data.country,phone:data.phone}).eq('id',S.user.id).then(function(r){
    if(r.error){toast('Failed to save: '+r.error.message,'err');return;}
    S.user.company_name=data.company_name;
    S.user.display_name=data.display_name;
    S.user.country=data.country;
    S.user.phone=data.phone;
    toast('Profile saved!','ok');
    render();
  });
}

function changePassword(f){
  if(f.password.value!==f.confirm.value){toast('Passwords do not match','err');return;}
  if(f.password.value.length<6){toast('Min 6 characters','err');return;}
  sb.auth.updateUser({password:f.password.value}).then(function(r){
    if(r.error){toast('Failed: '+r.error.message,'err');return;}
    toast('Password updated!','ok');
    f.reset();
  });
}

/* === DEAL PIPELINE === */
var DEAL_STAGES=[
  {id:'inquiry',label:'Inquiry',icon:'&#x1F4CB;'},
  {id:'matched',label:'Matched',icon:'&#x1F91D;'},
  {id:'quotation',label:'Quote',icon:'&#x1F4B0;'},
  {id:'sample',label:'Sample',icon:'&#x1F4E6;'},
  {id:'negotiation',label:'Negotiate',icon:'&#x1F4DD;'},
  {id:'order',label:'Order',icon:'&#x2705;'},
  {id:'production',label:'Production',icon:'&#x1F3ED;'},
  {id:'shipping',label:'Shipping',icon:'&#x1F6A2;'},
  {id:'completed',label:'Done',icon:'&#x1F389;'}
];

function loadMatchings(){
  var bids=getBuyerIds();if(!bids.length)return;
  sb.from('matchings').select('*').in('buyer_id',bids).order('created_at',{ascending:false}).then(function(r){
    S.matchings=r.data||[];buildDeals();
  });
}
function loadSamples(){
  var bids=getBuyerIds();if(!bids.length)return;
  sb.from('samples').select('*').in('buyer_id',bids).order('created_at',{ascending:false}).then(function(r){
    S.samples=r.data||[];buildDeals();
  });
}

function computeStage(deal){
  if(deal.shipment){
    if(deal.shipment.status==='delivered'||deal.shipment.status==='customs_clearance')return 'completed';
    return 'shipping';
  }
  if(deal.order){
    if(deal.order.status==='production'||deal.order.status==='inspection')return 'production';
    return 'order';
  }
  if(deal.matching){
    var ms=deal.matching.status;
    if(ms==='negotiation'||ms==='contract')return 'negotiation';
    if(ms==='sample')return 'sample';
    if(ms==='completed')return 'completed';
    if(deal.documents.length)return 'quotation';
    return 'matched';
  }
  return 'inquiry';
}

function buildDeals(){
  var deals=[];
  // Matchings → primary deals
  S.matchings.forEach(function(m){
    var d={id:m.id,type:'matching',matching:m,sellerId:m.user_id,buyerLinkId:m.buyer_id,
      inquiry:null,order:null,shipment:null,documents:[],dealSamples:[],
      title:m.match_reason||'Deal',created_at:m.created_at};
    d.order=S.orders.find(function(o){return o.buyer_id===m.buyer_id&&o.user_id===m.user_id;});
    if(d.order)d.shipment=S.shipments.find(function(s){return s.order_id===d.order.id;});
    d.documents=S.sharedDocs.filter(function(doc){return doc.buyer_id===m.buyer_id&&doc.user_id===m.user_id;});
    d.dealSamples=S.samples.filter(function(s){return s.buyer_id===m.buyer_id&&s.user_id===m.user_id;});
    d.stage=computeStage(d);
    deals.push(d);
  });
  // Unmatched inquiries
  S.inquiries.forEach(function(inq){
    var hasMatch=deals.some(function(d){return d.matching&&d.inquiry&&d.inquiry.id===inq.id;});
    if(!hasMatch){
      deals.push({id:'inq_'+inq.id,type:'inquiry',matching:null,sellerId:null,buyerLinkId:null,
        inquiry:inq,order:null,shipment:null,documents:[],dealSamples:[],
        title:inq.product_query||inq.inquiry_type||'Inquiry',stage:'inquiry',created_at:inq.created_at});
    }
  });
  S.deals=deals.sort(function(a,b){return new Date(b.created_at)-new Date(a.created_at);});
  render();
}

function pgDeals(){
  var h='';
  // Filter tabs
  var filters=['all','inquiry','matched','quotation','sample','negotiation','order','production','shipping','completed'];
  h+='<div class="order-pipeline">';
  filters.forEach(function(f){
    var cnt=f==='all'?S.deals.length:S.deals.filter(function(d){return d.stage===f;}).length;
    if(f!=='all'&&!cnt)return;
    h+='<div class="order-stage'+(S.dealFilter===f?' active':'')+'" onclick="B.set({dealFilter:\''+f+'\'})">'+f.replace('_',' ')+' <span class="cnt">'+cnt+'</span></div>';
  });
  h+='</div>';

  var list=S.deals;
  if(S.dealFilter&&S.dealFilter!=='all')list=list.filter(function(d){return d.stage===S.dealFilter;});

  if(!list.length){
    h+='<div style="text-align:center;padding:60px;color:var(--w40)"><div style="font-size:48px;margin-bottom:16px">&#x1F680;</div>';
    h+='<h3 style="font-weight:700;margin-bottom:8px">No deals yet</h3>';
    h+='<p style="font-size:13px;max-width:400px;margin:0 auto 16px">Search for products and submit an inquiry to start your sourcing pipeline.</p>';
    h+='<button class="btn btn-pri" onclick="B.nav(\'search\')">Search Products</button></div>';
    return h;
  }

  list.forEach(function(deal){
    var stageIdx=DEAL_STAGES.findIndex(function(s){return s.id===deal.stage;});
    h+='<div class="deal-card" onclick="B.openDeal(\''+deal.id+'\')">';
    h+='<div style="display:flex;justify-content:space-between;align-items:flex-start">';
    h+='<div><div style="font-weight:700;font-size:14px">'+esc(deal.title)+'</div>';
    h+='<div style="font-size:11px;color:var(--w40);margin-top:2px">';
    if(deal.sellerId)h+=esc(getSellerName(deal.sellerId))+' &middot; ';
    h+=formatDate(deal.created_at)+'</div></div>';
    // Stage badge
    var stg=DEAL_STAGES[stageIdx]||DEAL_STAGES[0];
    var stgColor=deal.stage==='completed'?'badge-ok':deal.stage==='inquiry'?'badge-ghost':deal.stage==='shipping'?'badge-purple':'badge-pri';
    h+='<span class="badge '+stgColor+'">'+stg.icon+' '+stg.label+'</span></div>';
    // Mini progress dots
    h+='<div class="mini-stages">';
    DEAL_STAGES.forEach(function(s,i){
      var cls=i<stageIdx?'done':i===stageIdx?'current':'';
      h+='<div class="mini-dot '+cls+'" title="'+s.label+'"></div>';
    });
    h+='</div>';
    // Extra info
    if(deal.order){h+='<div style="font-size:11px;color:var(--acc);margin-top:8px">Order: '+esc(deal.order.order_number)+' &middot; $'+Number(deal.order.total_amount||0).toLocaleString()+'</div>';}
    if(deal.documents.length){h+='<div style="font-size:11px;color:var(--w40);margin-top:4px">&#x1F4C4; '+deal.documents.length+' document(s)</div>';}
    h+='</div>';
  });
  return h;
}

/* === DEAL ROOM === */
function openDeal(dealId){
  var deal=S.deals.find(function(d){return d.id===dealId;});
  if(!deal)return;
  S.currentDeal=deal;S.dealMessages=[];S.dealChatOpen=true;
  render();
  // Load chat if matched
  if(deal.sellerId&&deal.buyerLinkId){
    sb.from('messages').select('*').eq('buyer_id',deal.buyerLinkId).eq('user_id',deal.sellerId).order('created_at',{ascending:true}).limit(100).then(function(r){
      S.dealMessages=r.data||[];render();
      setTimeout(function(){var el=document.getElementById('dealChatMsgs');if(el)el.scrollTop=el.scrollHeight;},100);
      // Mark unread
      var unread=(r.data||[]).filter(function(m){return m.sender_type!=='buyer'&&!m.read_at;});
      if(unread.length){sb.from('messages').update({read_at:new Date().toISOString(),is_read:true}).in('id',unread.map(function(m){return m.id;})).then(function(){loadConversations();});}
    });
    initDealChatRealtime(deal.buyerLinkId,deal.sellerId);
  }
  // Load milestones if order exists
  if(deal.order){
    sb.from('payment_milestones').select('*').eq('order_id',deal.order.id).order('created_at',{ascending:true}).then(function(r){
      S.orderMilestones=r.data||[];render();
    });
  }
}

function closeDeal(){
  S.currentDeal=null;S.dealMessages=[];
  if(S._dealChatCh){sb.removeChannel(S._dealChatCh);S._dealChatCh=null;}
  render();
}

function initDealChatRealtime(buyerLinkId,sellerId){
  if(S._dealChatCh){sb.removeChannel(S._dealChatCh);S._dealChatCh=null;}
  S._dealChatCh=sb.channel('deal-chat-'+buyerLinkId+'-'+sellerId).on('postgres_changes',{event:'INSERT',schema:'public',table:'messages',filter:'buyer_id=eq.'+buyerLinkId},function(payload){
    var m=payload.new;
    if(m.user_id===sellerId&&!S.dealMessages.find(function(x){return x.id===m.id;})){
      S.dealMessages.push(m);render();
      setTimeout(function(){var el=document.getElementById('dealChatMsgs');if(el)el.scrollTop=el.scrollHeight;},50);
      if(m.sender_type!=='buyer'){sb.from('messages').update({read_at:new Date().toISOString(),is_read:true}).eq('id',m.id).then(function(){});}
    }
  }).subscribe();
}

function sendDealMessage(){
  var inp=document.getElementById('dealChatInput');if(!inp||!inp.value.trim()||!S.currentDeal)return;
  var deal=S.currentDeal;if(!deal.sellerId||!deal.buyerLinkId){toast('Not matched yet','warn');return;}
  var body=inp.value.trim();inp.value='';
  var msg={user_id:deal.sellerId,buyer_id:deal.buyerLinkId,body:body,sender_type:'buyer',message_type:'text',channel:'platform',direction:'inbound'};
  S.dealMessages.push(Object.assign({id:'tmp_'+Date.now(),created_at:new Date().toISOString()},msg));
  render();
  setTimeout(function(){var el=document.getElementById('dealChatMsgs');if(el)el.scrollTop=el.scrollHeight;},50);
  sb.from('messages').insert(msg).select().single().then(function(r){
    if(r.error){toast('Failed to send','err');return;}
    S.dealMessages=S.dealMessages.filter(function(m){return!String(m.id).startsWith('tmp_');});
    S.dealMessages.push(r.data);render();
  });
}

function pgDealRoom(){
  var deal=S.currentDeal;if(!deal)return pgDeals();
  var stageIdx=DEAL_STAGES.findIndex(function(s){return s.id===deal.stage;});
  var h='';

  // Header
  h+='<div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">';
  h+='<button class="btn btn-ghost btn-sm" onclick="B.closeDeal()">&#x2190; Back</button>';
  h+='<div style="flex:1"><div style="font-weight:800;font-size:16px">'+esc(deal.title)+'</div>';
  if(deal.sellerId)h+='<div style="font-size:12px;color:var(--w40)">with '+esc(getSellerName(deal.sellerId))+'</div>';
  h+='</div>';
  var stg=DEAL_STAGES[stageIdx]||DEAL_STAGES[0];
  var stgColor=deal.stage==='completed'?'badge-ok':deal.stage==='inquiry'?'badge-ghost':'badge-pri';
  h+='<span class="badge '+stgColor+'" style="font-size:13px;padding:6px 14px">'+stg.icon+' '+stg.label+'</span></div>';

  // Stage progress bar
  h+='<div class="deal-stages">';
  DEAL_STAGES.forEach(function(s,i){
    var cls=i<stageIdx?'done':i===stageIdx?'current':'';
    h+='<div class="deal-stage '+cls+'"><span class="s-icon">'+s.icon+'</span><span>'+s.label+'</span></div>';
    if(i<DEAL_STAGES.length-1)h+='<div class="deal-stage"><span class="s-line"></span></div>';
  });
  h+='</div>';

  // Deal room: content + chat
  h+='<div class="deal-room">';

  // LEFT: Stage content
  h+='<div class="deal-content">';
  h+=renderStageContent(deal,stageIdx);
  h+='</div>';

  // RIGHT: Integrated chat
  if(deal.sellerId&&deal.buyerLinkId){
    h+='<div class="deal-chat">';
    h+='<div class="deal-chat-header"><div><div style="font-weight:700;font-size:13px">&#x1F4AC; Chat with '+esc(getSellerName(deal.sellerId))+'</div>';
    h+='<div style="font-size:10px;color:var(--w40)">Messages & documents are shared here</div></div></div>';
    h+='<div class="chat-msgs" id="dealChatMsgs">';
    if(!S.dealMessages.length){
      h+='<div style="text-align:center;color:var(--w20);font-size:12px;padding:20px">Start a conversation with your seller</div>';
    }
    var lastDate='';
    S.dealMessages.forEach(function(m){
      var d=new Date(m.created_at).toLocaleDateString();
      if(d!==lastDate){h+='<div style="text-align:center;font-size:9px;color:var(--w20);padding:6px 0">'+d+'</div>';lastDate=d;}
      var isMine=m.sender_type==='buyer';
      h+=renderChatBubble(m,isMine);
    });
    h+='</div>';
    h+='<div class="chat-input-row"><input class="form-input" id="dealChatInput" placeholder="Type a message..." style="font-size:12px;padding:8px 10px" onkeydown="if(event.key===\'Enter\')B.sendDealMessage()"><button class="btn btn-pri btn-sm" onclick="B.sendDealMessage()">Send</button></div>';
    h+='</div>';
  } else {
    h+='<div class="deal-chat" style="align-items:center;justify-content:center;text-align:center;color:var(--w40);padding:20px">';
    h+='<div><div style="font-size:36px;margin-bottom:8px">&#x1F91D;</div>';
    h+='<div style="font-size:13px;font-weight:600">Chat activates after matching</div>';
    h+='<div style="font-size:11px;margin-top:4px">Our team is reviewing your inquiry. Once matched with a seller, you can chat directly here.</div></div></div>';
  }
  h+='</div>';
  return h;
}

function renderStageContent(deal,stageIdx){
  var h='';
  var stage=deal.stage;

  // Current stage info
  h+='<div class="stage-card" style="border-color:rgba(0,212,255,.2);background:rgba(0,212,255,.03)">';
  h+='<div class="stage-card-title" style="color:var(--pri)">'+DEAL_STAGES[stageIdx].icon+' Current: '+DEAL_STAGES[stageIdx].label+'</div>';
  switch(stage){
    case'inquiry':
      h+='<div style="font-size:12px;color:var(--w60)">Your inquiry has been submitted. Our team is reviewing it and will match you with the best seller.</div>';
      if(deal.inquiry){h+='<div style="margin-top:8px;font-size:12px"><strong>Product:</strong> '+esc(deal.inquiry.product_query||'')+'<br><strong>Type:</strong> '+esc(deal.inquiry.inquiry_type||'')+'<br><strong>Status:</strong> <span class="badge badge-ghost">'+esc(deal.inquiry.status||'pending')+'</span></div>';}
      break;
    case'matched':
      h+='<div style="font-size:12px;color:var(--w60)">You\'ve been matched with <strong>'+esc(getSellerName(deal.sellerId))+'</strong>! Use the chat to introduce yourself and discuss your requirements.</div>';
      h+='<div style="margin-top:8px"><button class="btn btn-pri btn-sm" onclick="document.getElementById(\'dealChatInput\').focus()">Start Chatting &#x2192;</button></div>';
      break;
    case'quotation':
      h+='<div style="font-size:12px;color:var(--w60)">The seller has shared documents. Review the quotation and discuss any adjustments via chat.</div>';
      break;
    case'sample':
      h+='<div style="font-size:12px;color:var(--w60)">Sample stage in progress. Track your sample status below.</div>';
      break;
    case'negotiation':
      h+='<div style="font-size:12px;color:var(--w60)">You\'re in negotiation with the seller. Discuss pricing, terms, and contract details via chat.</div>';
      break;
    case'order':
      h+='<div style="font-size:12px;color:var(--w60)">Your order has been confirmed! Track payment milestones below.</div>';
      break;
    case'production':
      h+='<div style="font-size:12px;color:var(--w60)">Your order is being manufactured. The seller will update you on progress via chat.</div>';
      break;
    case'shipping':
      h+='<div style="font-size:12px;color:var(--w60)">Your shipment is on its way! Track the delivery status below.</div>';
      break;
    case'completed':
      h+='<div style="font-size:12px;color:var(--ok)">This deal is complete. Thank you for using Whistle AI!</div>';
      break;
  }
  h+='</div>';

  // Documents section
  if(deal.documents.length){
    h+='<div class="stage-card"><div class="stage-card-title">&#x1F4C4; Documents ('+deal.documents.length+')</div>';
    deal.documents.forEach(function(doc){
      var typeNames={pi:'Proforma Invoice',ci:'Commercial Invoice',pl:'Packing List',co:'Certificate of Origin',sc:'Sales Contract'};
      h+='<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--w08)">';
      h+='<span class="badge badge-acc" style="font-size:10px">'+esc(doc.doc_type||'').toUpperCase()+'</span>';
      h+='<div style="flex:1;font-size:12px"><div style="font-weight:600">'+esc(doc.doc_number||typeNames[doc.doc_type]||'Document')+'</div><div style="color:var(--w40)">'+formatDate(doc.created_at)+'</div></div>';
      if(doc.pdf_url)h+='<a href="'+esc(doc.pdf_url)+'" target="_blank" class="btn btn-ghost btn-sm" style="font-size:10px">&#x1F4E5; PDF</a>';
      h+='</div>';
    });
    h+='</div>';
  }

  // Samples section
  if(deal.dealSamples.length){
    h+='<div class="stage-card"><div class="stage-card-title">&#x1F4E6; Samples ('+deal.dealSamples.length+')</div>';
    deal.dealSamples.forEach(function(s){
      var stCls=s.status==='delivered'?'badge-ok':s.status==='shipped'?'badge-pri':'badge-ghost';
      h+='<div style="display:flex;align-items:center;gap:10px;padding:8px 0">';
      h+='<span class="badge '+stCls+'">'+esc(s.status)+'</span>';
      h+='<div style="flex:1;font-size:12px">Qty: '+esc(s.quantity||1);
      if(s.tracking_number)h+=' &middot; Track: '+esc(s.tracking_number);
      h+='</div>';
      if(s.feedback_rating)h+='<span style="color:var(--acc)">'+('&#x2B50;'.repeat(s.feedback_rating))+'</span>';
      h+='</div>';
    });
    h+='</div>';
  }

  // Order section
  if(deal.order){
    var o=deal.order;
    h+='<div class="stage-card"><div class="stage-card-title">&#x2705; Order — '+esc(o.order_number||'')+'</div>';
    h+='<div class="grid-2" style="gap:8px;font-size:12px">';
    h+='<div><span style="color:var(--w40)">Amount:</span> <strong style="color:var(--acc)">$'+Number(o.total_amount||0).toLocaleString()+'</strong></div>';
    h+='<div><span style="color:var(--w40)">Status:</span> <span class="badge badge-acc">'+esc(o.status)+'</span></div>';
    h+='<div><span style="color:var(--w40)">Terms:</span> '+esc(o.payment_terms||'-')+'</div>';
    h+='<div><span style="color:var(--w40)">Payment:</span> <span class="badge '+(o.payment_status==='paid'?'badge-ok':'badge-ghost')+'">'+esc(o.payment_status||'unpaid')+'</span></div>';
    h+='</div>';
    // Milestones
    if(S.orderMilestones.length){
      h+='<div style="margin-top:10px">';
      S.orderMilestones.forEach(function(ms){
        var paid=ms.status==='paid';
        h+='<div style="display:flex;align-items:center;gap:8px;padding:6px 0;font-size:11px">';
        h+='<span>'+(paid?'&#x2705;':'&#x23F3;')+'</span>';
        h+='<span style="flex:1;text-transform:capitalize;'+(paid?'color:var(--ok)':'')+'">'+esc(ms.name).replace(/_/g,' ')+' ('+esc(ms.percentage)+'%)</span>';
        h+='<span style="font-weight:700">$'+Number(ms.amount||0).toLocaleString()+'</span>';
        h+='<span class="badge '+(paid?'badge-ok':'badge-ghost')+'" style="font-size:9px">'+(paid?'Paid':'Pending')+'</span></div>';
      });
      h+='</div>';
    }
    h+='</div>';
  }

  // Shipment section
  if(deal.shipment){
    var sh=deal.shipment;
    var shipStages=['booked','loaded','departed','in_transit','arrived','customs_clearance','delivered'];
    var shipIdx=shipStages.indexOf(sh.status);
    h+='<div class="stage-card"><div class="stage-card-title">&#x1F6A2; Shipment — '+esc(sh.type||'ocean').toUpperCase()+'</div>';
    h+='<div style="font-size:12px;margin-bottom:10px">'+esc(sh.port_of_loading||'Busan')+' &#x2192; '+esc(sh.port_of_discharge||'TBD');
    if(sh.eta)h+=' &middot; ETA: '+sh.eta;
    if(sh.bl_number)h+=' &middot; B/L: '+esc(sh.bl_number);
    h+='</div>';
    h+='<div class="ship-timeline">';
    shipStages.forEach(function(st,i){
      var cls=i<shipIdx?'done':i===shipIdx?'current':'';
      h+='<div class="ship-step '+cls+'"><div class="dot"></div>';
      h+='<div style="font-size:11px;font-weight:'+(i===shipIdx?'700':'400')+'">'+st.replace(/_/g,' ')+'</div></div>';
    });
    h+='</div></div>';
  }

  // If no extra content, show helpful tips
  if(!deal.documents.length&&!deal.dealSamples.length&&!deal.order&&!deal.shipment&&deal.stage!=='inquiry'){
    h+='<div style="padding:20px;text-align:center;color:var(--w40);font-size:12px">';
    h+='<div style="font-size:24px;margin-bottom:8px">&#x1F4A1;</div>';
    h+='Use the chat to discuss requirements, request quotes, and exchange documents with your seller.';
    h+='</div>';
  }

  return h;
}

/* === MESSAGES / CHAT === */
function loadConversations(){
  var bids=getBuyerIds();if(!bids.length)return;
  sb.from('messages').select('*').in('buyer_id',bids).order('created_at',{ascending:false}).limit(200).then(function(r){
    var msgs=r.data||[];
    var convMap={};
    msgs.forEach(function(m){
      var key=m.buyer_id+'_'+m.user_id;
      if(!convMap[key]){convMap[key]={buyerLinkId:m.buyer_id,sellerId:m.user_id,lastMsg:m,unread:0,msgs:[]};}
      convMap[key].msgs.push(m);
      if(!m.is_read&&m.sender_type!=='buyer'&&!m.read_at)convMap[key].unread++;
    });
    S.conversations=Object.values(convMap).sort(function(a,b){return new Date(b.lastMsg.created_at)-new Date(a.lastMsg.created_at);});
    S.chatUnread=S.conversations.reduce(function(s,c){return s+c.unread;},0);
    render();
  });
}

function pgMessages(){
  var h='<div class="chat-layout'+(S.currentChat?' chat-open':'')+'">';
  // Conversation list
  h+='<div class="chat-list">';
  h+='<div style="padding:12px 14px;border-bottom:1px solid var(--bd);font-weight:700;font-size:13px">Conversations</div>';
  if(!S.buyerLinks.length){
    h+='<div style="padding:30px 14px;text-align:center;color:var(--w40);font-size:12px">Submit an inquiry to start messaging with sellers.</div>';
  } else if(!S.conversations.length){
    h+='<div style="padding:30px 14px;text-align:center;color:var(--w40);font-size:12px">No messages yet. Sellers will contact you after reviewing your inquiries.</div>';
  } else {
    S.conversations.forEach(function(c){
      var active=S.currentChat&&S.currentChat.buyerLinkId===c.buyerLinkId&&S.currentChat.sellerId===c.sellerId;
      h+='<div class="chat-list-item'+(active?' active':'')+'" onclick="B.openChat(\''+c.buyerLinkId+'\',\''+c.sellerId+'\')">';
      h+='<div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:600;font-size:13px">'+esc(getSellerName(c.sellerId))+'</div>';
      if(c.unread)h+='<span class="badge badge-err" style="font-size:9px">'+c.unread+'</span>';
      h+='</div>';
      h+='<div style="font-size:11px;color:var(--w40);margin-top:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc((c.lastMsg.body||'').substring(0,50))+'</div>';
      h+='<div style="font-size:10px;color:var(--w20);margin-top:2px">'+timeAgo(c.lastMsg.created_at)+'</div>';
      h+='</div>';
    });
  }
  h+='</div>';
  // Chat panel
  h+='<div class="chat-panel">';
  if(!S.currentChat){
    h+='<div style="flex:1;display:flex;align-items:center;justify-content:center;color:var(--w40);font-size:13px"><div style="text-align:center"><div style="font-size:36px;margin-bottom:12px">&#x1F4AC;</div>Select a conversation</div></div>';
  } else {
    h+='<div style="padding:12px 16px;border-bottom:1px solid var(--bd);display:flex;align-items:center;gap:10px">';
    h+='<button class="btn btn-ghost btn-sm" onclick="B.closeChat()" style="display:none" id="chatBackBtn">&#x2190;</button>';
    h+='<div style="font-weight:700;font-size:14px">'+esc(getSellerName(S.currentChat.sellerId))+'</div></div>';
    h+='<div class="chat-msgs" id="chatMsgs">';
    var lastDate='';
    S.chatMessages.forEach(function(m){
      var d=new Date(m.created_at).toLocaleDateString();
      if(d!==lastDate){h+='<div style="text-align:center;font-size:10px;color:var(--w20);padding:8px 0">'+d+'</div>';lastDate=d;}
      var isMine=m.sender_type==='buyer';
      h+=renderChatBubble(m,isMine);
    });
    h+='</div>';
    h+='<div class="chat-input-row"><input class="form-input" id="chatInput" placeholder="Type a message..." onkeydown="if(event.key===\'Enter\')B.sendChat()"><button class="btn btn-pri" onclick="B.sendChat()">Send</button></div>';
  }
  h+='</div></div>';
  return h;
}

function openChat(buyerLinkId,sellerId){
  S.currentChat={buyerLinkId:buyerLinkId,sellerId:sellerId};
  S.chatMessages=[];render();
  sb.from('messages').select('*').eq('buyer_id',buyerLinkId).eq('user_id',sellerId).order('created_at',{ascending:true}).limit(100).then(function(r){
    S.chatMessages=r.data||[];render();
    setTimeout(scrollChatBottom,100);
    // Mark unread as read
    var unread=(r.data||[]).filter(function(m){return m.sender_type!=='buyer'&&!m.read_at;});
    if(unread.length){
      sb.from('messages').update({read_at:new Date().toISOString(),is_read:true}).in('id',unread.map(function(m){return m.id;})).then(function(){loadConversations();});
    }
  });
  initChatRealtime(buyerLinkId);
}

function closeChat(){S.currentChat=null;if(S._chatChannel){sb.removeChannel(S._chatChannel);S._chatChannel=null;}render();}

function sendChat(){
  var inp=document.getElementById('chatInput');if(!inp||!inp.value.trim())return;
  var body=inp.value.trim();inp.value='';
  var msg={user_id:S.currentChat.sellerId,buyer_id:S.currentChat.buyerLinkId,body:body,sender_type:'buyer',message_type:'text',channel:'platform',direction:'inbound'};
  S.chatMessages.push(Object.assign({id:'temp_'+Date.now(),created_at:new Date().toISOString()},msg));
  render();scrollChatBottom();
  sb.from('messages').insert(msg).select().single().then(function(r){
    if(r.error){toast('Failed to send','err');return;}
    S.chatMessages=S.chatMessages.filter(function(m){return!m.id.toString().startsWith('temp_');});
    S.chatMessages.push(r.data);render();scrollChatBottom();
  });
}

function initChatRealtime(buyerLinkId){
  if(S._chatChannel){sb.removeChannel(S._chatChannel);S._chatChannel=null;}
  S._chatChannel=sb.channel('buyer-chat-'+buyerLinkId).on('postgres_changes',{event:'INSERT',schema:'public',table:'messages',filter:'buyer_id=eq.'+buyerLinkId},function(payload){
    var m=payload.new;
    if(S.currentChat&&S.currentChat.buyerLinkId===buyerLinkId){
      if(!S.chatMessages.find(function(x){return x.id===m.id;})){S.chatMessages.push(m);render();scrollChatBottom();}
      if(m.sender_type!=='buyer'){sb.from('messages').update({read_at:new Date().toISOString(),is_read:true}).eq('id',m.id).then(function(){});}
    } else {S.chatUnread++;render();}
  }).subscribe();
}

function scrollChatBottom(){var el=document.getElementById('chatMsgs');if(el)el.scrollTop=el.scrollHeight;}

/* === ORDERS === */
function loadOrders(){
  var bids=getBuyerIds();if(!bids.length)return;
  sb.from('orders').select('*').in('buyer_id',bids).order('created_at',{ascending:false}).then(function(r){
    S.orders=r.data||[];render();
  });
}

function pgOrders(){
  var h='';
  if(!S.buyerLinks.length){return '<div style="text-align:center;padding:60px;color:var(--w40)"><div style="font-size:36px;margin-bottom:12px">&#x1F4E6;</div><p>Submit an inquiry to receive orders from sellers.</p></div>';}
  // Pipeline filter
  var stages=['all','confirmed','production','inspection','shipping','delivered','completed'];
  h+='<div class="order-pipeline">';
  stages.forEach(function(st){
    var cnt=st==='all'?S.orders.length:S.orders.filter(function(o){return o.status===st;}).length;
    h+='<div class="order-stage'+(S.orderFilter===st?' active':'')+'" onclick="B.set({orderFilter:\''+st+'\'})">'+st.replace('_',' ')+' <span class="cnt">'+cnt+'</span></div>';
  });
  h+='</div>';
  var list=S.orders;
  if(S.orderFilter&&S.orderFilter!=='all')list=list.filter(function(o){return o.status===S.orderFilter;});
  if(!list.length){return h+'<div style="text-align:center;padding:40px;color:var(--w40)">No orders'+(S.orderFilter!=='all'?' with status "'+S.orderFilter+'"':'')+'</div>';}
  list.forEach(function(o){
    var stCls=o.status==='completed'?'badge-ok':o.status==='shipping'?'badge-pri':o.status==='cancelled'?'badge-err':'badge-acc';
    var payCls=o.payment_status==='paid'?'badge-ok':o.payment_status==='partial'||o.payment_status==='deposit_received'?'badge-acc':'badge-ghost';
    h+='<div class="card" style="cursor:pointer" onclick="B.showOrderDetail(\''+o.id+'\')">';
    h+='<div class="card-b"><div style="display:flex;justify-content:space-between;align-items:flex-start">';
    h+='<div><div style="font-weight:700;font-size:15px">'+esc(o.order_number||'Order')+'</div>';
    h+='<div style="font-size:12px;color:var(--w40);margin-top:2px">'+esc(getSellerName(o.user_id))+' &middot; '+formatDate(o.created_at)+'</div></div>';
    h+='<div style="text-align:right"><span class="badge '+stCls+'">'+o.status+'</span>';
    h+='<div style="margin-top:6px"><span class="badge '+payCls+'">'+(o.payment_status||'unpaid')+'</span></div></div></div>';
    // Order details row
    h+='<div style="display:flex;gap:20px;margin-top:14px;font-size:12px;color:var(--w60)">';
    h+='<div><span style="color:var(--w40)">Amount:</span> <strong style="color:var(--acc)">$'+Number(o.total_amount||0).toLocaleString()+'</strong> '+esc(o.currency||'USD')+'</div>';
    h+='<div><span style="color:var(--w40)">Terms:</span> '+esc(o.payment_terms||'-')+'</div>';
    h+='<div><span style="color:var(--w40)">Incoterms:</span> '+esc(o.incoterms||'FOB')+'</div>';
    if(o.estimated_ship_date)h+='<div><span style="color:var(--w40)">Ship by:</span> '+o.estimated_ship_date+'</div>';
    h+='</div></div></div>';
  });
  return h;
}

function showOrderDetail(orderId){
  var o=S.orders.find(function(x){return x.id===orderId;});if(!o)return;
  S.modal='orderDetail';S.modalData=o;
  // Load milestones
  sb.from('payment_milestones').select('*').eq('order_id',orderId).order('created_at',{ascending:true}).then(function(r){
    S.orderMilestones=r.data||[];render();
  });
  render();
}

function renderOrderDetailModal(){
  var o=S.modalData;if(!o)return '';
  var stCls=o.status==='completed'?'badge-ok':o.status==='cancelled'?'badge-err':'badge-acc';
  var h='<div class="modal-overlay" onclick="B.closeModal()"><div class="modal" style="width:640px" onclick="event.stopPropagation()">';
  h+='<div class="modal-h"><span>'+esc(o.order_number||'Order Details')+'</span><button class="modal-close" onclick="B.closeModal()">&#x2715;</button></div>';
  h+='<div class="modal-b">';
  h+='<div style="display:flex;gap:8px;margin-bottom:16px"><span class="badge '+stCls+'" style="font-size:12px">'+o.status+'</span>';
  h+='<span class="badge badge-purple">'+esc(o.incoterms||'FOB')+'</span></div>';
  // Info grid
  h+='<div class="grid-2" style="margin-bottom:16px">';
  h+='<div class="form-group"><div class="form-label">Seller</div><div style="font-weight:600">'+esc(getSellerName(o.user_id))+'</div></div>';
  h+='<div class="form-group"><div class="form-label">Total Amount</div><div style="font-weight:800;color:var(--acc);font-size:18px">$'+Number(o.total_amount||0).toLocaleString()+'</div></div>';
  h+='<div class="form-group"><div class="form-label">Payment Terms</div><div>'+esc(o.payment_terms||'-')+'</div></div>';
  h+='<div class="form-group"><div class="form-label">Payment Status</div><div><span class="badge '+(o.payment_status==='paid'?'badge-ok':'badge-acc')+'">'+(o.payment_status||'unpaid')+'</span></div></div>';
  h+='</div>';
  // Items
  if(o.items&&o.items.length){
    h+='<div style="font-weight:700;font-size:13px;margin-bottom:8px">Order Items</div>';
    h+='<div style="border:1px solid var(--bd);border-radius:var(--r-s);overflow:hidden;margin-bottom:16px">';
    o.items.forEach(function(item,i){
      h+='<div style="padding:10px 14px;border-bottom:1px solid var(--w08);font-size:12px;display:flex;justify-content:space-between">';
      h+='<div>'+esc(item.name||item.product_name||'Item '+(i+1))+'</div>';
      h+='<div style="color:var(--w40)">'+esc(item.qty||item.quantity||'')+' x $'+esc(item.unit_price||item.price||'')+'</div></div>';
    });
    h+='</div>';
  }
  // Payment milestones
  if(S.orderMilestones.length){
    h+='<div style="font-weight:700;font-size:13px;margin-bottom:8px">Payment Milestones</div>';
    S.orderMilestones.forEach(function(ms){
      var paid=ms.status==='paid';
      h+='<div style="display:flex;align-items:center;gap:10px;padding:10px 14px;border:1px solid var(--bd);border-radius:var(--r-xs);margin-bottom:6px">';
      h+='<div style="font-size:16px">'+(paid?'&#x2705;':'&#x23F3;')+'</div>';
      h+='<div style="flex:1"><div style="font-weight:600;font-size:13px;text-transform:capitalize">'+esc(ms.name).replace('_',' ')+'</div>';
      h+='<div style="font-size:11px;color:var(--w40)">'+esc(ms.percentage||'')+'% &middot; $'+Number(ms.amount||0).toLocaleString()+'</div></div>';
      h+='<span class="badge '+(paid?'badge-ok':'badge-ghost')+'">'+(paid?'Paid':'Pending')+'</span>';
      h+='</div>';
    });
  }
  // Notes
  if(o.notes&&o.notes.length){
    h+='<div style="font-weight:700;font-size:13px;margin:16px 0 8px">Notes</div>';
    o.notes.forEach(function(n){
      h+='<div style="padding:8px 12px;background:var(--w08);border-radius:var(--r-xs);margin-bottom:4px;font-size:12px"><span style="color:var(--w40)">'+formatDate(n.date)+':</span> '+esc(n.text)+'</div>';
    });
  }
  h+='</div></div></div>';return h;
}

/* === SHIPMENTS === */
function loadShipments(){
  var bids=getBuyerIds();if(!bids.length)return;
  var orderIds=S.orders.map(function(o){return o.id;});
  if(!orderIds.length){
    // Try loading via orders query
    sb.from('orders').select('id').in('buyer_id',bids).then(function(r){
      var ids=(r.data||[]).map(function(o){return o.id;});
      if(ids.length){sb.from('shipments').select('*').in('order_id',ids).order('created_at',{ascending:false}).then(function(r2){S.shipments=r2.data||[];render();});}
    });
    return;
  }
  sb.from('shipments').select('*').in('order_id',orderIds).order('created_at',{ascending:false}).then(function(r){
    S.shipments=r.data||[];render();
  });
}

function pgShipments(){
  if(!S.shipments.length){
    return '<div style="text-align:center;padding:60px;color:var(--w40)"><div style="font-size:36px;margin-bottom:12px">&#x1F6A2;</div><h3 style="font-weight:700;margin-bottom:8px">No Shipments</h3><p style="font-size:13px">Shipments will appear here once your orders are shipped.</p></div>';
  }
  var h='';
  S.shipments.forEach(function(sh){
    var order=S.orders.find(function(o){return o.id===sh.order_id;});
    var stages=['booked','loaded','departed','in_transit','arrived','customs_clearance','delivered'];
    var currentIdx=stages.indexOf(sh.status);
    h+='<div class="card"><div class="card-h"><span>'+esc(order?order.order_number:'Shipment')+' &middot; '+esc(sh.type||'ocean').toUpperCase()+'</span>';
    h+='<span class="badge '+(sh.status==='delivered'?'badge-ok':sh.status==='exception'?'badge-err':'badge-pri')+'">'+esc(sh.status||'booked')+'</span></div>';
    h+='<div class="card-b">';
    // Route info
    h+='<div style="display:flex;gap:20px;margin-bottom:16px;font-size:12px;color:var(--w60)">';
    h+='<div>&#x1F6A2; '+esc(sh.port_of_loading||'Busan, KR')+' &#x2192; '+esc(sh.port_of_discharge||'TBD')+'</div>';
    if(sh.bl_number)h+='<div>B/L: '+esc(sh.bl_number)+'</div>';
    if(sh.vessel_name)h+='<div>Vessel: '+esc(sh.vessel_name)+'</div>';
    if(sh.eta)h+='<div>ETA: '+sh.eta+'</div>';
    h+='</div>';
    // Timeline
    h+='<div class="ship-timeline">';
    stages.forEach(function(st,i){
      var cls=i<currentIdx?'done':i===currentIdx?'current':'';
      h+='<div class="ship-step '+cls+'"><div class="dot"></div>';
      h+='<div style="font-size:12px;font-weight:'+(i===currentIdx?'700':'400')+';color:'+(i<=currentIdx?'var(--w90)':'var(--w20)')+'">'+st.replace(/_/g,' ')+'</div>';
      // Show dates from tracking_history
      if(sh.tracking_history&&sh.tracking_history.length){
        var entry=sh.tracking_history.find(function(e){return e.stage===st;});
        if(entry)h+='<div style="font-size:10px;color:var(--w40)">'+formatDate(entry.timestamp)+(entry.details?' &middot; '+esc(entry.details):'')+'</div>';
      }
      h+='</div>';
    });
    h+='</div>';
    if(sh.tracking_url)h+='<div style="margin-top:12px"><a href="'+esc(sh.tracking_url)+'" target="_blank" class="btn btn-ghost btn-sm">&#x1F517; Track Online</a></div>';
    h+='</div></div>';
  });
  return h;
}

/* === DOCUMENTS === */
function loadSharedDocs(){
  var bids=getBuyerIds();if(!bids.length)return;
  sb.from('documents').select('*').in('buyer_id',bids).order('created_at',{ascending:false}).limit(50).then(function(r){
    S.sharedDocs=r.data||[];render();
  });
}

function pgDocs(){
  if(!S.sharedDocs.length){
    return '<div style="text-align:center;padding:60px;color:var(--w40)"><div style="font-size:36px;margin-bottom:12px">&#x1F4C4;</div><h3 style="font-weight:700;margin-bottom:8px">No Documents</h3><p style="font-size:13px">Documents shared by sellers (PI, CI, PL, CO) will appear here.</p></div>';
  }
  var typeNames={pi:'Proforma Invoice',ci:'Commercial Invoice',pl:'Packing List',co:'Certificate of Origin',sc:'Sales Contract',bl:'Bill of Lading',catalog:'Catalog',contract:'Contract',other:'Other'};
  var typeColors={pi:'badge-acc',ci:'badge-pri',pl:'badge-purple',co:'badge-ok',sc:'badge-ghost',bl:'badge-err'};
  var h='<div style="font-size:12px;color:var(--w40);margin-bottom:12px">'+S.sharedDocs.length+' document(s)</div>';
  S.sharedDocs.forEach(function(doc){
    h+='<div class="card" style="cursor:pointer" onclick="B.showDocDetail(\''+doc.id+'\')">';
    h+='<div class="card-b" style="display:flex;align-items:center;gap:14px">';
    h+='<div style="font-size:28px;width:40px;text-align:center">'+(doc.doc_type==='pi'?'&#x1F4B0;':doc.doc_type==='co'?'&#x1F3F7;':'&#x1F4C4;')+'</div>';
    h+='<div style="flex:1"><div style="font-weight:700;font-size:14px">'+esc(doc.doc_number||(doc.doc_type||'doc').toUpperCase())+'</div>';
    h+='<div style="font-size:11px;color:var(--w40)"><span class="badge '+(typeColors[doc.doc_type]||'badge-ghost')+'">'+esc(typeNames[doc.doc_type]||doc.doc_type)+'</span>';
    h+=' &middot; '+esc(getSellerName(doc.user_id))+' &middot; '+formatDate(doc.created_at)+'</div></div>';
    h+='<span class="badge '+(doc.status==='sent'||doc.status==='approved'?'badge-ok':'badge-ghost')+'">'+esc(doc.status||'draft')+'</span>';
    h+='</div></div>';
  });
  return h;
}

function showDocDetail(docId){
  var doc=S.sharedDocs.find(function(d){return d.id===docId;});if(!doc)return;
  S.modal='docDetail';S.modalData=doc;render();
}

function renderDocDetailModal(){
  var doc=S.modalData;if(!doc)return '';
  var typeNames={pi:'Proforma Invoice',ci:'Commercial Invoice',pl:'Packing List',co:'Certificate of Origin',sc:'Sales Contract',bl:'Bill of Lading'};
  var h='<div class="modal-overlay" onclick="B.closeModal()"><div class="modal" style="width:640px" onclick="event.stopPropagation()">';
  h+='<div class="modal-h"><span>'+esc(typeNames[doc.doc_type]||doc.doc_type)+' — '+esc(doc.doc_number||'')+'</span><button class="modal-close" onclick="B.closeModal()">&#x2715;</button></div>';
  h+='<div class="modal-b">';
  h+='<div class="grid-2" style="margin-bottom:16px">';
  h+='<div class="form-group"><div class="form-label">From</div><div style="font-weight:600">'+esc(getSellerName(doc.user_id))+'</div></div>';
  h+='<div class="form-group"><div class="form-label">Status</div><span class="badge '+(doc.status==='sent'?'badge-ok':'badge-ghost')+'">'+esc(doc.status)+'</span></div>';
  h+='<div class="form-group"><div class="form-label">Date</div><div>'+formatDate(doc.created_at)+'</div></div>';
  h+='</div>';
  // Content
  if(doc.content){
    var c=doc.content;
    if(c.buyer)h+='<div style="padding:12px;background:var(--w08);border-radius:var(--r-xs);margin-bottom:12px;font-size:12px"><div style="font-weight:600;margin-bottom:4px">Buyer Info</div>'+esc(c.buyer.buyer_company||'')+' / '+esc(c.buyer.buyer_contact||'')+'</div>';
    if(c.items&&c.items.length){
      h+='<div style="font-weight:700;font-size:13px;margin-bottom:8px">Items</div>';
      h+='<table style="width:100%;font-size:12px;border-collapse:collapse;margin-bottom:12px">';
      h+='<tr style="background:var(--w08)"><th style="padding:8px;text-align:left;border:1px solid var(--bd)">Item</th><th style="padding:8px;text-align:right;border:1px solid var(--bd)">Qty</th><th style="padding:8px;text-align:right;border:1px solid var(--bd)">Price</th><th style="padding:8px;text-align:right;border:1px solid var(--bd)">Total</th></tr>';
      c.items.forEach(function(item){
        h+='<tr><td style="padding:8px;border:1px solid var(--bd)">'+esc(item.description||item.name||'')+'</td>';
        h+='<td style="padding:8px;text-align:right;border:1px solid var(--bd)">'+esc(item.qty||item.quantity||'')+'</td>';
        h+='<td style="padding:8px;text-align:right;border:1px solid var(--bd)">$'+esc(item.unit_price||item.price||'')+'</td>';
        h+='<td style="padding:8px;text-align:right;border:1px solid var(--bd)">$'+esc(item.amount||item.total||'')+'</td></tr>';
      });
      if(c.total)h+='<tr style="font-weight:700"><td colspan="3" style="padding:8px;text-align:right;border:1px solid var(--bd)">Total</td><td style="padding:8px;text-align:right;border:1px solid var(--bd)">$'+Number(c.total).toLocaleString()+'</td></tr>';
      h+='</table>';
    }
  }
  if(doc.pdf_url)h+='<a href="'+esc(doc.pdf_url)+'" target="_blank" class="btn btn-pri btn-block">&#x1F4E5; Download PDF</a>';
  h+='</div></div></div>';return h;
}

/* === NOTIFICATIONS === */
function loadNotifications(){
  if(!S.user)return;
  sb.from('notifications').select('*').eq('user_id',S.user.id).order('created_at',{ascending:false}).limit(30).then(function(r){
    S.notifications=r.data||[];
    S.notifUnread=S.notifications.filter(function(n){return!n.is_read;}).length;
    render();
  });
}

function toggleNotif(){S.notifOpen=!S.notifOpen;render();}

function clickNotif(id,page){
  sb.from('notifications').update({is_read:true}).eq('id',id).then(function(){loadNotifications();});
  S.notifOpen=false;
  if(page)nav(page);
}

function markAllNotifRead(){
  var ids=S.notifications.filter(function(n){return!n.is_read;}).map(function(n){return n.id;});
  if(!ids.length)return;
  sb.from('notifications').update({is_read:true}).in('id',ids).then(function(){loadNotifications();});
}

/* === TRANSLATION === */
var _translations={};
function translateMsg(msgId,targetLang){
  var key=msgId+'_'+(targetLang||'en');
  if(_translations[key]&&_translations[key]!=='loading'){
    delete _translations[key];render();return;
  }
  // Find message text from current messages
  var text='';
  var allMsgs=S.dealMessages.concat(S.chatMessages);
  for(var i=0;i<allMsgs.length;i++){if(String(allMsgs[i].id)===String(msgId)){text=allMsgs[i].body||'';break;}}
  if(!text)return;
  _translations[key]='loading';render();
  fetch(RELAY+'/api/translate',{method:'POST',headers:{'Content-Type':'application/json','ngrok-skip-browser-warning':'1'},body:JSON.stringify({text:text,targetLang:targetLang||'en'})}).then(function(r){return r.json();}).then(function(d){
    if(d.ok){_translations[key]=d.translated;}
    else{_translations[key]='[Translation failed]';}
    render();
    setTimeout(function(){var el=document.getElementById('dealChatMsgs')||document.getElementById('chatMsgs');if(el)el.scrollTop=el.scrollHeight;},50);
  }).catch(function(){_translations[key]='[Translation failed]';render();});
}
function getTranslation(msgId,targetLang){
  return _translations[msgId+'_'+(targetLang||'en')]||null;
}
function renderChatBubble(m,isMine){
  var tgt=isMine?'ko':'en';
  var tr=getTranslation(m.id,tgt);
  var h='<div class="chat-bubble '+(isMine?'mine':'theirs')+'" style="font-size:12px">';
  if(m.message_type==='file'&&m.file_url){h+='&#x1F4CE; <a href="'+esc(m.file_url)+'" target="_blank" style="color:inherit;text-decoration:underline">'+esc(m.body||'File')+'</a>';}
  else if(m.message_type==='doc'){h+='&#x1F4C4; '+esc(m.body||'Document shared');}
  else{
    if(tr&&tr!=='loading'){
      h+='<div style="font-size:12px">'+esc(tr)+'</div>';
      h+='<div style="font-size:9px;color:'+(isMine?'rgba(0,0,0,.4)':'var(--w20)')+';margin-top:3px;font-style:italic">Translated</div>';
      h+='<div style="font-size:10px;margin-top:2px;opacity:.6;border-top:1px solid '+(isMine?'rgba(0,0,0,.1)':'var(--w08)')+';padding-top:2px">'+esc(m.body||'')+'</div>';
    } else {
      h+=esc(m.body||'');
    }
  }
  h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-top:3px">';
  h+='<span style="font-size:8px;opacity:.5">'+new Date(m.created_at).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})+'</span>';
  if(m.body&&!String(m.id).startsWith('tmp_')&&!String(m.id).startsWith('temp_')){
    if(tr==='loading'){
      h+='<span style="font-size:9px;opacity:.5">translating...</span>';
    } else {
      h+='<span style="font-size:9px;cursor:pointer;opacity:.6;'+(tr?'color:'+(isMine?'rgba(0,0,0,.7)':'var(--pri)'):'')
        +'" onclick="event.stopPropagation();B.translateMsg(\''+m.id+'\',\''+(isMine?'ko':'en')+'\')">'
        +(tr?'Original':'Translate')+'</span>';
    }
  }
  h+='</div></div>';
  return h;
}

/* === HELPERS === */
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function stripHtml(s){return s?s.replace(/<[^>]*>/g,''):''}
function formatDate(d){if(!d)return'';var dt=new Date(d);return dt.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});}
function timeAgo(d){if(!d)return'';var s=Math.floor((Date.now()-new Date(d))/1000);if(s<60)return'now';if(s<3600)return Math.floor(s/60)+'m';if(s<86400)return Math.floor(s/3600)+'h';if(s<604800)return Math.floor(s/86400)+'d';return formatDate(d);}
function nav(page){S.page=page;S._inqFilter=null;S.notifOpen=false;if(page!=='deals')S.currentDeal=null;render();window.scrollTo(0,0);
try{if(!window._pvSid)window._pvSid=Math.random().toString(36).slice(2);sb.from('page_views').insert({user_id:S.user?S.user.id:null,page:page,role:S.user?S.user.role:'buyer',session_id:window._pvSid,portal:'buyer'}).then(function(){});}catch(e){}}

/* === INIT === */
sb.auth.onAuthStateChange(function(event,session){
  if(event==='SIGNED_IN'||event==='TOKEN_REFRESHED'){loadUser();}
  else if(event==='SIGNED_OUT'){S.user=null;S.loading=false;render();}
});
loadUser();

/* === STRIPE CHECKOUT (Buyer) === */
function openBuyerCheckout(planId){
  var prices={starter:{m:'$29',s:'$156.60',a:'$278.40',dm:'$29/mo',ds:'$26.10/mo (10% off)',da:'$23.20/mo (20% off)'},pro:{m:'$89',s:'$480.60',a:'$854.40',dm:'$89/mo',ds:'$80.10/mo',da:'$71.20/mo'}};
  var pr=prices[planId]||prices.starter;
  var body='<div style="text-align:center;margin-bottom:16px"><div style="font-size:24px;font-weight:900;color:var(--pri)">'+(planId==='pro'?'Pro':'Starter')+'</div></div>'+
  '<div style="font-size:11px;font-weight:700;color:var(--w60);margin-bottom:8px">Billing Cycle</div>'+
  '<div style="display:flex;flex-direction:column;gap:6px;margin-bottom:16px">'+
  '<label style="display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;border:1px solid var(--pri);background:rgba(0,212,255,.06);cursor:pointer"><input type="radio" name="b_cycle" value="m" checked style="accent-color:var(--pri)"><div style="flex:1"><span style="font-size:12px;font-weight:600;color:var(--w90)">Monthly</span><span style="font-size:11px;color:var(--w40);margin-left:8px">'+pr.dm+'</span></div><span style="font-size:13px;font-weight:800;color:var(--w90)">'+pr.m+'</span></label>'+
  '<label style="display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;border:1px solid var(--bd);cursor:pointer"><input type="radio" name="b_cycle" value="s" style="accent-color:var(--pri)"><div style="flex:1"><span style="font-size:12px;font-weight:600;color:var(--w90)">6 Months</span><span style="font-size:11px;color:var(--ok);margin-left:8px">'+pr.ds+'</span></div><span style="font-size:13px;font-weight:800;color:var(--w90)">'+pr.s+'</span></label>'+
  '<label style="display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;border:1px solid var(--bd);cursor:pointer"><input type="radio" name="b_cycle" value="a" style="accent-color:var(--pri)"><div style="flex:1"><span style="font-size:12px;font-weight:600;color:var(--w90)">Annual</span><span style="font-size:11px;color:var(--ok);margin-left:8px">'+pr.da+'</span></div><span style="font-size:13px;font-weight:800;color:var(--w90)">'+pr.a+'</span></label></div>'+
  '<div style="font-size:11px;color:var(--w40)">Secure payment via Stripe. Cancel anytime.</div>';
  document.body.insertAdjacentHTML('beforeend','<div class="modal-overlay" id="bck" onclick="if(event.target===this)B.closeModal(\'bck\')"><div class="modal" style="max-width:420px"><div class="modal-h"><h3>Upgrade Plan</h3><button class="modal-close" onclick="B.closeModal(\'bck\')">&#10005;</button></div><div class="modal-b">'+body+'</div><div class="modal-f"><button class="btn btn-ghost" onclick="B.closeModal(\'bck\')">Cancel</button><button class="btn btn-pri" id="bck-btn" onclick="B.initBuyerStripe(\''+planId+'\')">Pay with Card</button></div></div></div>');
  var m=document.getElementById('bck');if(m)m.style.display='flex';
}

function initBuyerStripe(planId){
  var stripe=_getStripe();
  if(!stripe){toast('Stripe is not configured yet. Contact support.','warn');return;}
  var cycleEl=document.querySelector('input[name=b_cycle]:checked');
  var cycle=cycleEl?cycleEl.value:'m';
  var priceId=STRIPE_CFG.prices[planId]&&STRIPE_CFG.prices[planId][cycle];
  if(!priceId||priceId.indexOf('price_buyer')===0){toast('Payment setup in progress. Contact support@motiveinno.com','info');return;}
  var btn=document.getElementById('bck-btn');
  if(btn){btn.disabled=true;btn.textContent='Connecting...';}
  sb.auth.getSession().then(function(r){
    if(!r.data||!r.data.session){toast('Please log in first','warn');if(btn){btn.disabled=false;btn.textContent='Pay with Card';}return;}
    fetch(STRIPE_CFG.fn+'/create-checkout-session',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+r.data.session.access_token,'apikey':SB_KEY},
      body:JSON.stringify({price_id:priceId,success_url:location.origin+location.pathname+'#profile',cancel_url:location.origin+location.pathname+'#profile'})
    }).then(function(r){return r.json();}).then(function(data){
      if(data.error){toast(data.error,'err');if(btn){btn.disabled=false;btn.textContent='Pay with Card';}return;}
      closeModal('bck');
      document.body.insertAdjacentHTML('beforeend','<div class="modal-overlay" id="stripe-ck" onclick="if(event.target===this)B.closeStripeModal()"><div class="modal" style="max-width:520px"><div class="modal-h"><h3>Payment</h3><button class="modal-close" onclick="B.closeStripeModal()">&#10005;</button></div><div class="modal-b"><div id="stripe-mount" style="min-height:300px"></div></div></div></div>');
      var sm=document.getElementById('stripe-ck');if(sm)sm.style.display='flex';
      stripe.initEmbeddedCheckout({clientSecret:data.clientSecret}).then(function(checkout){window._bStripe=checkout;checkout.mount('#stripe-mount');});
    }).catch(function(err){toast('Connection error: '+err.message,'err');if(btn){btn.disabled=false;btn.textContent='Pay with Card';}});
  });
}

function closeStripeModal(){
  if(window._bStripe){window._bStripe.destroy();window._bStripe=null;}
  closeModal('stripe-ck');
}

function openBillingPortal(){
  sb.auth.getSession().then(function(r){
    if(!r.data||!r.data.session){toast('Please log in first','warn');return;}
    fetch(STRIPE_CFG.fn+'/create-billing-portal',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+r.data.session.access_token,'apikey':SB_KEY},
      body:JSON.stringify({return_url:location.href})
    }).then(function(r){return r.json();}).then(function(data){
      if(data.url)window.open(data.url,'_blank');
      else toast(data.error||'Cannot open billing portal','warn');
    });
  });
}

function submitPartnership(){
  var company=document.getElementById('pt-company');var name=document.getElementById('pt-name');var email=document.getElementById('pt-email');var phone=document.getElementById('pt-phone');var type=document.getElementById('pt-type');var message=document.getElementById('pt-message');
  if(!company||!company.value.trim()){toast('Please enter your company name.','warn');return;}
  if(!name||!name.value.trim()){toast('Please enter your name.','warn');return;}
  if(!email||!email.value.trim()){toast('Please enter your email.','warn');return;}
  var data={company:company.value.trim(),name:name.value.trim(),email:email.value.trim(),phone:phone?phone.value.trim():'',type:type?type.value:'',message:message?message.value.trim():'',page:'buyer-partnership',user_id:S.user?S.user.id:''};
  fetch(RELAY_URL+'/api/whistle/chat-inquiry',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)}).then(function(r){return r.json();}).then(function(d){toast('Partnership inquiry submitted! We will get back to you soon.','ok');if(company)company.value='';if(name)name.value='';if(email)email.value='';if(phone)phone.value='';if(type)type.value='';if(message)message.value='';}).catch(function(){toast('Failed to send. Please try again later.','err');});
}

/* === PUBLIC API === */
window.B={
  set:set,render:render,nav:nav,
  doLogin:doLogin,doSignup:doSignup,doReset:doReset,doLogout:doLogout,submitPartnership:submitPartnership,
  doSearch:doSearch,quickSearch:quickSearch,setSource:setSource,
  openInquiry:openInquiry,openCustomSourcing:openCustomSourcing,submitInquiry:submitInquiry,closeModal:closeModal,
  saveProduct:saveProduct,unsaveProduct:unsaveProduct,
  showInquiryDetail:showInquiryDetail,
  saveProfile:saveProfile,changePassword:changePassword,
  openBuyerCheckout:openBuyerCheckout,initBuyerStripe:initBuyerStripe,closeStripeModal:closeStripeModal,openBillingPortal:openBillingPortal,
  // Deals
  openDeal:openDeal,closeDeal:closeDeal,sendDealMessage:sendDealMessage,
  // Chat
  openChat:openChat,closeChat:closeChat,sendChat:sendChat,
  // Orders
  showOrderDetail:showOrderDetail,
  // Documents
  showDocDetail:showDocDetail,
  // Notifications
  toggleNotif:toggleNotif,clickNotif:clickNotif,markAllNotifRead:markAllNotifRead,
  // Translation
  translateMsg:translateMsg,
  // Marketplace
  showRequestForm:showRequestForm,submitRequest:submitRequest,
  viewRequest:viewRequest,backToRequests:backToRequests,
  acceptProposal:acceptProposal,rejectProposal:rejectProposal,
  closeRequest:closeRequest,
  _inqFilter:null
};

// Close notification dropdown on outside click
document.addEventListener('click',function(){if(S.notifOpen){S.notifOpen=false;render();}});

})();
</script>
<!-- Floating Chat Widget -->
<script>
(function(){
  var RELAY=(location.hostname==='localhost'||location.hostname==='127.0.0.1')?'http://localhost:3456':(typeof RELAY_URL!=='undefined'&&RELAY_URL?RELAY_URL:'');
  var PAGE='buyer';
  var open=false,step=0,msgs=[],info={name:'',email:'',phone:''};
  var el=document.createElement('div');el.id='wc-root';document.body.appendChild(el);
  function r(){
    var html='';
    html+='<div onclick="WC.toggle()" style="position:fixed;bottom:24px;right:24px;z-index:9999;width:56px;height:56px;border-radius:28px;background:linear-gradient(135deg,#00D4FF,#0088FF);display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 20px rgba(0,212,255,.4);transition:transform .2s">';
    html+=open?'<svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M18 6L6 18M6 6l12 12" stroke="#060B18" stroke-width="2.5" stroke-linecap="round"/></svg>':'<svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z" fill="#060B18"/></svg>';
    html+='</div>';
    if(!open){el.innerHTML=html;return;}
    html+='<div style="position:fixed;bottom:90px;right:24px;z-index:9998;width:360px;max-height:520px;background:#0D1424;border-radius:16px;border:1px solid rgba(255,255,255,.1);box-shadow:0 16px 60px rgba(0,0,0,.6);display:flex;flex-direction:column;overflow:hidden;font-family:Sora,sans-serif">';
    html+='<div style="padding:14px 18px;background:linear-gradient(135deg,#00D4FF20,#0088FF10);border-bottom:1px solid rgba(255,255,255,.08);display:flex;align-items:center;gap:10px">';
    html+='<div style="width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#00D4FF,#0088FF);display:flex;align-items:center;justify-content:center"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" fill="#060B18"/></svg></div>';
    html+='<div><div style="font-size:14px;font-weight:700;color:#fff">Whistle AI Support</div><div style="font-size:11px;color:rgba(255,255,255,.4)">Ask anything about sourcing</div></div>';
    html+='<div style="margin-left:auto;display:flex;align-items:center;gap:4px"><div style="width:6px;height:6px;border-radius:3px;background:#00E676"></div><span style="font-size:10px;color:#00E676">Online</span></div></div>';
    html+='<div id="wc-msgs" style="flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:8px;min-height:200px;max-height:320px">';
    if(msgs.length===0&&step===0){html+=bbl('bot','Hi! Welcome to Whistle AI. How can we help?');html+=qb(['Product Search Help','Sourcing Inquiry','Partnership','Other']);}
    for(var i=0;i<msgs.length;i++)html+=bbl(msgs[i].from,msgs[i].text);
    if(step===1){html+=bbl('bot','Please share some info so we can assist you better.');html+='<div style="display:flex;flex-direction:column;gap:6px;width:100%"><input id="wc-name" placeholder="Name / Company" value="'+esc(info.name)+'" style="padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,.1);background:#111B2E;color:rgba(255,255,255,.9);font-size:13px;outline:none"><input id="wc-email" placeholder="Email (optional)" value="'+esc(info.email)+'" style="padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,.1);background:#111B2E;color:rgba(255,255,255,.9);font-size:13px;outline:none"><input id="wc-phone" placeholder="Phone (optional)" value="'+esc(info.phone)+'" style="padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,.1);background:#111B2E;color:rgba(255,255,255,.9);font-size:13px;outline:none"><button onclick="WC.submitInfo()" style="padding:10px;border-radius:8px;border:none;background:linear-gradient(135deg,#00D4FF,#0088FF);color:#060B18;font-weight:700;font-size:13px;cursor:pointer">Start Chat</button></div>';}
    html+='</div>';
    if(step>=2){html+='<div style="padding:10px 14px;border-top:1px solid rgba(255,255,255,.08);display:flex;gap:8px"><input id="wc-input" onkeydown="if(event.key===\'Enter\')WC.send()" placeholder="Type your message..." style="flex:1;padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,.1);background:#111B2E;color:rgba(255,255,255,.9);font-size:13px;outline:none"><button onclick="WC.send()" style="width:40px;height:40px;border-radius:10px;border:none;background:linear-gradient(135deg,#00D4FF,#0088FF);cursor:pointer;display:flex;align-items:center;justify-content:center"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M2 21l21-9L2 3v7l15 2-15 2v7z" fill="#060B18"/></svg></button></div>';}
    html+='</div>';
    el.innerHTML=html;var mc=document.getElementById('wc-msgs');if(mc)mc.scrollTop=mc.scrollHeight;
  }
  function bbl(f,t){return f==='bot'?'<div style="align-self:flex-start;max-width:85%;padding:10px 14px;border-radius:12px 12px 12px 4px;background:#111B2E;border:1px solid rgba(255,255,255,.06)"><div style="font-size:13px;color:rgba(255,255,255,.75);line-height:1.5">'+t+'</div></div>':'<div style="align-self:flex-end;max-width:85%;padding:10px 14px;border-radius:12px 12px 4px 12px;background:linear-gradient(135deg,#00D4FF20,#0088FF15);border:1px solid #00D4FF30"><div style="font-size:13px;color:rgba(255,255,255,.9);line-height:1.5">'+t+'</div></div>';}
  function qb(a){var h='<div style="display:flex;flex-wrap:wrap;gap:6px">';for(var i=0;i<a.length;i++)h+='<div onclick="WC.pick(\''+esc(a[i])+'\')" style="padding:6px 12px;border-radius:8px;border:1px solid rgba(0,212,255,.3);background:rgba(0,212,255,.06);color:#00D4FF;font-size:12px;font-weight:600;cursor:pointer">'+a[i]+'</div>';return h+'</div>';}
  function esc(s){return String(s||'').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;');}
  var ar={'Product Search Help':'You can search for Korean products using the search bar on the Product Search page. Enter keywords, product names, or categories to find suppliers.','Sourcing Inquiry':'For custom sourcing requests, use the Marketplace page to post your requirements. Korean manufacturers will review and send proposals.','Partnership':'We offer reseller, service, technology, and institutional partnerships. Navigate to the Partnership page from the sidebar or contact us at contact@whistleai.co.kr.','Other':'Please type your question below and our team will get back to you shortly.'};
  window.WC={
    toggle:function(){open=!open;r();},
    pick:function(t){msgs.push({from:'user',text:t});if(ar[t]){msgs.push({from:'bot',text:ar[t]});msgs.push({from:'bot',text:'For further assistance, please share your details below.'});step=1;}r();},
    submitInfo:function(){var n=document.getElementById('wc-name'),e=document.getElementById('wc-email'),p=document.getElementById('wc-phone');info.name=n?n.value:'';info.email=e?e.value:'';info.phone=p?p.value:'';if(!info.name){alert('Please enter your name or company.');return;}msgs.push({from:'bot',text:'Hi '+info.name+'! Feel free to type your question.'});step=2;r();},
    send:function(){var inp=document.getElementById('wc-input');if(!inp||!inp.value.trim())return;var msg=inp.value.trim();msgs.push({from:'user',text:msg});r();fetch(RELAY+'/api/whistle/chat-inquiry',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:info.name,email:info.email,phone:info.phone,message:msg,page:PAGE})}).then(function(res){return res.json();}).then(function(d){if(d.ok){msgs.push({from:'bot',text:d.reply||'Your message has been received.'});r();}}).catch(function(){msgs.push({from:'bot',text:'Failed to send. Please try again later.'});r();});}
  };r();
})();
</script>
</body>
</html>
